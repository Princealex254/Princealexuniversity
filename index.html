<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('myschoolgate.png') no-repeat center center fixed;
      background-size: cover;
    }
    .gpa-circle-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 20px auto;
    }
    .gpa-circle-svg {
      transform: rotate(-90deg);
    }
    .gpa-circle-bg {
      stroke: #e0e0e0;
      stroke-width: 10;
      fill: none;
    }
    .gpa-circle-progress {
      stroke: #006400; /* University green */
      stroke-width: 10;
      fill: none;
      transition: stroke-dasharray 0.5s ease-in-out;
    }
    .gpa-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      font-weight: bold;
      color: #006400;
    }
    .fees-balance-text.red {
        color: #dc2626; /* Tailwind red-600 */
    }
    .fees-balance-text.green {
        color: #16a34a; /* Tailwind green-600 */
    }
    /* Hide scrollbar for announcements panel, but allow scrolling */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    /* Rotate chevron */
    .rotate-180 {
        transform: rotate(180deg);
    }

    /* New CSS for spacing and cards */
    .container {
        padding: 10px; /* Reduced padding for smaller screens */
    }
    /* Adjust main padding and gap on larger screens */
    @media (min-width: 1024px) { /* Equivalent to Tailwind's lg breakpoint */
        .main {
            padding: 20px;
            gap: 20px;
        }
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* Reduce sidebar width */
    #sidebar {
      width: 220px; /* Adjusted from 256px */
    }
    /* Adjust main content margin to account for new sidebar width */
    @media (min-width: 1024px) {
        #dashboardContent {
            margin-left: 220px; /* Adjusted from 256px */
        }
    }

    /* Timetable Specific CSS */
    .timetable-grid {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 1px;
      background-color: #e2e8f0;
      border: 1px solid #cbd5e1;
    }

    .timetable-header, .timetable-cell {
      background-color: white;
      padding: 8px;
      text-align: center;
      border: 1px solid #cbd5e1;
    }

    .timetable-header {
      font-weight: bold;
      background-color: #f1f5f9;
    }

    .timetable-cell {
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 0.875rem;
    }

    /* Responsive Timetable on Mobile */
    @media (max-width: 1023px) {
      .timetable-grid {
        display: block; /* Stack on mobile */
      }
      .timetable-day-card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 16px;
        padding: 16px;
      }
      .timetable-day-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #1e40af;
        margin-bottom: 12px;
      }
      .timetable-class-item {
        border-top: 1px solid #e2e8f0;
        padding-top: 12px;
        margin-top: 12px;
      }
      .timetable-class-item:first-child {
        border-top: none;
        padding-top: 0;
        margin-top: 0;
      }
    }
  </style>
</head>
<body class="h-screen flex items-center justify-center">
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
    <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-300">
      <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
      <p id="modalMessage" class="mb-6 text-gray-700"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
        <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
      </div>
    </div>
  </div>

  <div id="authContainer" class="p-4 w-full h-full flex justify-center items-center">
    <div id="login-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5 active">
      <form id="login-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Login</h2>
        <div class="mb-6 text-left">
          <label for="email-login" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-login" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-login" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-login" placeholder="Enter your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="login-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Login</button>
        <div class="mt-6 text-sm flex justify-center space-x-4">
          <a href="#" onclick="showForm('signup')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Don't have an account? Sign Up</a>
          <a href="#" onclick="showForm('forgot-password')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Forgot Password?</a>
        </div>
      </form>
    </div>

    <div id="signup-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="signup-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Sign Up</h2>
        <div class="mb-6 text-left">
          <label for="full-name-signup" class="block text-gray-700 text-sm font-medium mb-2">Full Name</label>
          <input type="text" id="full-name-signup" placeholder="Enter your full name" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
        </div>
        <div class="mb-6 text-left">
          <label for="email-signup" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-signup" placeholder="Enter your email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-signup" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-signup" placeholder="Create a password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="confirm-password-signup" class="block text-gray-700 text-sm font-medium mb-2">Confirm Password</label>
          <input type="password" id="confirm-password-signup" placeholder="Confirm your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="confirm-password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="signup-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Sign Up</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Already have an account? Login</a>
        </div>
      </form>
    </div>

    <div id="forgot-password-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="forgot-password-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Forgot Password</h2>
        <div class="mb-6 text-left">
          <label for="email-forgot" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-forgot" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-forgot-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="recover-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Recover Password</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Back to Login</a>
        </div>
      </form>
    </div>
  </div>

  <div id="dashboardContainer" class="hidden h-screen flex flex-col bg-gray-100 w-full">
    <header class="bg-white text-green-800 p-4 flex justify-between items-center shadow-md sticky top-0 z-10 lg:px-8">
      <img src="myschoollogo.png" alt="University Logo" class="h-12 w-auto">
      <button id="menuToggle" class="lg:hidden text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
        <i class="fas fa-bars"></i>
      </button>
      <div class="hidden lg:flex items-center space-x-4">
        <span class="text-lg font-semibold text-green-700">Welcome, <span id="userName" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
       <div class="lg:hidden flex items-center space-x-4">
        <span class="text-md font-semibold text-green-700">Welcome, <span id="userNameMobile" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <div class="flex flex-grow">
      <nav id="sidebar" class="w-64 bg-green-900 text-white p-6 flex flex-col space-y-2 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20 fixed inset-y-0 left-0 lg:relative lg:flex-shrink-0 lg:h-auto overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Quick Menu</h3>
        <a onclick="showDashboardSection('home')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i> Home</a>
        <a onclick="showDashboardSection('profile')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user mr-3"></i> Personal Profile</a>

        <a onclick="toggleSubmenu('academics-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-book mr-3"></i> Academics <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="academics-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('courseReg')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-alt mr-3"></i> Course Registration</a>
          <a onclick="showDashboardSection('courses')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-list-alt mr-3"></i> Available Courses</a>
          <a onclick="showDashboardSection('timetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-calendar-alt mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-list mr-3"></i> Grades & Transcripts</a>
          <a onclick="showDashboardSection('graduation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-graduation-cap mr-3"></i> Graduation Request</a>
          <a onclick="showDashboardSection('clearance')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-check-circle mr-3"></i> Clearance Request</a>
        </div>

        <a onclick="toggleSubmenu('finance-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-money-bill-wave mr-3"></i> Finance <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="finance-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('fees')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-credit-card mr-3"></i> Fees Statement</a>
          <a onclick="showDashboardSection('receipts')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-receipt mr-3"></i> Receipts</a>
          <a onclick="showDashboardSection('examCard')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-id-card mr-3"></i> Exam Card</a>
        </div>

        <a onclick="toggleSubmenu('exam-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-laptop-code mr-3"></i> Examination <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="exam-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('examTimetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clock mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-invoice mr-3"></i> Transcripts</a>
        </div>
        <a onclick="showDashboardSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-hotel mr-3"></i> Accommodation</a>
        <a onclick="showDashboardSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i> Announcements</a>
        <a onclick="showDashboardSection('settings')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-cog mr-3"></i> Settings</a>
      </nav>

      <main id="dashboardContent" class="flex-grow p-6 overflow-y-auto lg:ml-64 w-full">
        </main>
    </div>

    <footer class="bg-white text-gray-600 text-center p-4 text-sm shadow-inner mt-auto">
      2025 ¬© Prince Alex Design University. All rights reserved.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, arrayUnion, arrayRemove, addDoc, getDocs, deleteDoc, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Firebase Config: Replace with your actual Firebase project details
    const hardcodedFirebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A", // This is a placeholder. Ensure your actual Firebase API Key is used.
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId;
    const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    if (firebaseConfigFromCanvas) {
        app = initializeApp(firebaseConfigFromCanvas);
    } else {
        // Fallback for local development if __firebase_config is not defined
        app = initializeApp(hardcodedFirebaseConfig);
    }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let currentUserData = null;

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const authContainer = document.getElementById('authContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const sidebar = document.getElementById('sidebar');

    // --- Custom Modal Functions (replaces alert/confirm) ---
    function showCustomModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        if (modalTitle) modalTitle.innerText = title;
        if (modalMessage) modalMessage.innerText = message;

        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(true);
            };
        }
        if (modalCancelBtn) {
            modalCancelBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(false);
            };
            modalCancelBtn.classList.toggle('hidden', !isConfirm); // Toggle visibility based on isConfirm
        }
        if (modal) modal.classList.remove('hidden'); // Show modal
      });
    }

    window.alert = (message) => showCustomModal('Alert', message); // Override alert
    window.confirm = (message) => showCustomModal('Confirm', message, true); // Override confirm
    // --- End Custom Modal Functions ---

    // Function to set button loading state
    function setButtonLoading(button, isLoading) {
      if (button) {
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<i class="fas fa-spinner animate-spin mr-2"></i>Loading...' : button.dataset.originalHtml;
      }
    }

    // Function to store original button HTML for loading state
    function storeOriginalButtonHtml() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.dataset.originalHtml = button.innerHTML;
      });
    }

    // Inline form validation utility
    function validateInput(inputElement, validationFn, errorMessageElement) {
        if (validationFn(inputElement.value)) {
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-300', 'focus:ring-green-500');
            errorMessageElement.classList.add('hidden');
            return true;
        } else {
            inputElement.classList.remove('border-gray-300', 'focus:ring-green-500');
            inputElement.classList.add('border-red-500');
            errorMessageElement.innerText = `‚ùå ${errorMessageElement.dataset.errorMessage || 'Invalid input.'}`;
            errorMessageElement.classList.remove('hidden');
            return false;
        }
    }

    // Email validation regex (basic)
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    // Password validation regex (at least 6 characters)
    const isValidPassword = (password) => password.length >= 6;


    // Function to show specific authentication form and hide others
    window.showForm = function(formId) {
      const forms = document.querySelectorAll('.form-wrapper');
      forms.forEach(form => {
        form.classList.remove('active');
        form.classList.add('opacity-0', 'invisible', 'translate-y-5');
      });
      const activeForm = document.getElementById(`${formId}-form-wrapper`);
      if (activeForm) {
        activeForm.classList.remove('opacity-0', 'invisible', 'translate-y-5');
        activeForm.classList.add('active');
        // Autofocus the first input in the new form
        const firstInput = activeForm.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      }
    };

    // This function runs once the DOM is fully loaded and before onAuthStateChanged fires its initial state.
    async function initializeAppUI() {
        storeOriginalButtonHtml(); // Store original button HTML for loading states
        loadingText.innerText = "Initializing session...";
        loadingOverlay.classList.remove('hidden');

        // Attach inline validation listeners
        attachFormValidationListeners();

        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                await signInAnonymously(auth);
                console.log("Signed in anonymously due to custom token failure.");
            }
        } else {
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                await showCustomModal("Error", "Failed to initialize anonymous session. Please refresh.");
            }
        }
    }

    window.onload = initializeAppUI;

    // --- Authentication Forms Event Listeners ---
    document.getElementById('login-form').addEventListener('submit', loginUser);
    document.getElementById('signup-form').addEventListener('submit', signupUser);
    document.getElementById('forgot-password-form').addEventListener('submit', recoverPassword);

    function attachFormValidationListeners() {
        // Login form
        const emailLogin = document.getElementById('email-login');
        const emailLoginError = document.getElementById('email-login-error');
        if (emailLogin) {
            emailLoginError.dataset.errorMessage = "Please enter a valid email address.";
            emailLogin.addEventListener('input', () => validateInput(emailLogin, isValidEmail, emailLoginError));
        }
        const passwordLogin = document.getElementById('password-login');
        const passwordLoginError = document.getElementById('password-login-error');
        if (passwordLogin) {
            passwordLoginError.dataset.errorMessage = "Password must be at least 6 characters.";
            passwordLogin.addEventListener('input', () => validateInput(passwordLogin, isValidPassword, passwordLoginError));
        }

        // Signup form
        const emailSignup = document.getElementById('email-signup');
        const emailSignupError = document.getElementById('email-signup-error');
        if (emailSignup) {
            emailSignupError.dataset.errorMessage = "Please enter a valid email address.";
            emailSignup.addEventListener('input', () => validateInput(emailSignup, isValidEmail, emailSignupError));
        }
        const passwordSignup = document.getElementById('password-signup');
        const passwordSignupError = document.getElementById('password-signup-error');
        if (passwordSignup) {
            passwordSignupError.dataset.errorMessage = "Password must be at least 6 characters long.";
            passwordSignup.addEventListener('input', () => validateInput(passwordSignup, isValidPassword, passwordSignupError));
        }
        const confirmPasswordSignup = document.getElementById('confirm-password-signup');
        const confirmPasswordSignupError = document.getElementById('confirm-password-signup-error');
        if (confirmPasswordSignup) {
            confirmPasswordSignupError.dataset.errorMessage = "Passwords do not match.";
            confirmPasswordSignup.addEventListener('input', () => {
                const match = passwordSignup.value === confirmPasswordSignup.value;
                validateInput(confirmPasswordSignup, () => match, confirmPasswordSignupError);
            });
        }

        // Forgot password form
        const emailForgot = document.getElementById('email-forgot');
        const emailForgotError = document.getElementById('email-forgot-error');
        if (emailForgot) {
            emailForgotError.dataset.errorMessage = "Please enter a valid email address.";
            emailForgot.addEventListener('input', () => validateInput(emailForgot, isValidEmail, emailForgotError));
        }
    }


    // --- Authentication Flow ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("User authenticated (from onAuthStateChanged):", user.email, user.uid);

        // Fetch or create user data from Firestore
        const profileDocRef = doc(db, `students`, currentUserId);
        const profileDocSnap = await getDoc(profileDocRef);

        if (profileDocSnap.exists()) {
          currentUserData = profileDocSnap.data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
        } else {
          await setDoc(profileDocRef, {
            email: user.email,
            name: user.email.split("@")[0],
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
          });
          currentUserData = (await getDoc(profileDocRef)).data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          console.log("Created basic user profile during dashboard load fallback.");
        }

        authContainer.classList.add('hidden');
        dashboardContainer.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');

        if (currentUserData.regNo === 'N/A' || currentUserData.programme === 'N/A' || currentUserData.dob === 'N/A' || currentUserData.gender === 'N/A') {
            await showCustomModal("Welcome", "Please complete your profile information.");
            showDashboardSection('profile');
        } else {
            showDashboardSection('home');
        }

      } else {
        authContainer.classList.remove('hidden');
        dashboardContainer.classList.add('hidden');
        loadingOverlay.classList.add('hidden');
        showForm('login');
      }
    });

    // Function to log in user
    async function loginUser(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('login-btn');
      const emailInput = document.getElementById("email-login");
      const passwordInput = document.getElementById("password-login");
      const emailError = document.getElementById('email-login-error');
      const passwordError = document.getElementById('password-login-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);

      if (!isEmailValid || !isPasswordValid) {
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(loginBtn, true);

      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        await showCustomModal("Login Success", "‚úÖ Login successful! Redirecting...");
      } catch (error) {
        let errorMessage = "‚ùå Login failed.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = "‚ùå Invalid email or password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "‚ùå Please enter a valid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "‚ùå Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "‚ùå Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Login Failed", errorMessage);
        console.error("Login error:", error);
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }

    // Function to sign up new user
    async function signupUser(event) {
      event.preventDefault();
      const signupBtn = document.getElementById('signup-btn');
      const fullNameInput = document.getElementById("full-name-signup");
      const emailInput = document.getElementById("email-signup");
      const passwordInput = document.getElementById("password-signup");
      const confirmPasswordInput = document.getElementById("confirm-password-signup");

      const emailError = document.getElementById('email-signup-error');
      const passwordError = document.getElementById('password-signup-error');
      const confirmPasswordError = document.getElementById('confirm-password-signup-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);
      const passwordsMatch = (passwordInput.value === confirmPasswordInput.value);
      const isConfirmPasswordValid = validateInput(confirmPasswordInput, () => passwordsMatch, confirmPasswordError);

      if (!isEmailValid || !isPasswordValid || !isConfirmPasswordValid || !passwordsMatch) {
          if (!passwordsMatch) {
              confirmPasswordError.innerText = "‚ùå Passwords do not match!";
              confirmPasswordError.classList.remove('hidden');
              confirmPasswordInput.classList.add('border-red-500');
          }
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(signupBtn, true);

      const fullName = fullNameInput.value.trim();
      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const userDocRef = doc(db, `students`, user.uid);
        await setDoc(userDocRef, {
            email: user.email,
            name: fullName,
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
        });
        console.log("User signed up and profile created:", user.email);

        await showCustomModal("Signup Success", "‚úÖ Signup successful! Please log in with your new account.");

        showForm('login');

      } catch (error) {
        let errorMessage = "‚ùå Signup failed.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "‚ùå Email already in use. Try logging in or recovering password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "‚ùå Invalid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "‚ùå Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "‚ùå Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Signup Failed", errorMessage);
        console.error("Signup error:", error);
      } finally {
        setButtonLoading(signupBtn, false);
      }
    }

    // Function to recover password
    async function recoverPassword(event) {
      event.preventDefault();
      const recoverBtn = document.getElementById('recover-btn');
      const emailInput = document.getElementById("email-forgot");
      const emailError = document.getElementById('email-forgot-error');
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      if (!isEmailValid) {
          await showCustomModal("Validation Error", "Please enter a valid email address.");
          return;
      }
      setButtonLoading(recoverBtn, true);
      const email = emailInput.value.trim().toLowerCase();
      try {
        await sendPasswordResetEmail(auth, email);
        await showCustomModal("Password Recovery", "‚úÖ Password reset email sent! Check your inbox.");
      } catch (error) {
        let errorMessage = "‚ùå Failed to send password reset email.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "‚ùå No account found with that email.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "‚ùå Please enter a valid email address.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Password Recovery Failed", errorMessage);
        console.error("Password recovery error:", error);
      } finally {
        setButtonLoading(recoverBtn, false);
      }
    }

    // --- Dashboard Specific Functions ---
    // Logout function
    window.confirmLogout = async function() {
      const response = await confirm("Are you sure you want to log out?");
      if (response) {
        try {
          loadingText.innerText = "Logging out...";
          loadingOverlay.classList.remove('hidden');
          await signOut(auth);
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error logging out. Please try again.");
          loadingOverlay.classList.add('hidden');
        }
      }
    };

    window.toggleSubmenu = function(id) {
      const submenu = document.getElementById(id);
      if (submenu) submenu.classList.toggle('hidden');
      const chevron = submenu.previousElementSibling.querySelector('.fa-chevron-down');
      if (chevron) {
        chevron.classList.toggle('rotate-180');
      }
    };

    document.getElementById('menuToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.toggle('-translate-x-full');
    });

    function generateBreadcrumb(currentSectionTitle) {
      return `
        <div class="text-sm text-gray-600 mb-6">
          <a onclick="showDashboardSection('home')" class="text-green-700 hover:underline cursor-pointer">Home</a>
          <span class="mx-2">/</span>
          <span class="font-semibold text-green-800">${currentSectionTitle}</span>
        </div>
      `;
    }

    function showLoading(text) {
      loadingText.innerText = text;
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // --- GPA Calculation Utility ---
    function calculateGPA(grades) {
      let totalPoints = 0;
      let totalUnits = 0;
      const gradeMap = {
        'A': 4.0,
        'B+': 3.5,
        'B': 3.0,
        'C+': 2.5,
        'C': 2.0,
        'D+': 1.5,
        'D': 1.0,
        'F': 0.0
      };
      grades.forEach(g => {
        const courseUnit = g.courseUnit || 3;
        const gradePoint = gradeMap[g.grade.toUpperCase().trim()] || 0;
        totalPoints += gradePoint * courseUnit;
        totalUnits += courseUnit;
      });
      return totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : "0.00";
    }

    // --- Section-Specific Loaders ---
    // 1. Home Dashboard
    async function loadHome() {
      const content = document.getElementById("dashboardContent");
      const announcementsRef = collection(db, `announcements`);
      const gradesRef = collection(db, `grades`);
      const feesRef = collection(db, `fees`);
      const registrationsRef = doc(db, `registrations`, currentUserId);

      // --- Initial Render with placeholders ---
      const initialStudentName = currentUserData?.name || "Student";
      const initialStudentProgramme = currentUserData?.programme && currentUserData.programme !== 'N/A' ? currentUserData.programme : "Programme Not Set";
      const initialStudentRegNo = currentUserData?.regNo && currentUserData.regNo !== 'N/A' ? currentUserData.regNo : "Registration Number Not Set";
      const initialProfilePhotoURL = currentUserData?.profilePhotoURL || 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';
      const homeContentHtml = `
        <div class="bg-green-100 p-6 rounded-xl shadow-lg flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6 mb-8">
          <img id="dashboardProfilePhoto" src="${initialProfilePhotoURL}" alt="Profile Photo" class="w-20 h-20 rounded-full border-4 border-white shadow-md">
          <div class="text-center md:text-left">
            <h2 class="text-2xl font-bold text-green-800">Welcome back, <span id="dashboardStudentName">${initialStudentName}</span>!</h2>
            <p class="text-gray-600"><span id="dashboardStudentProgramme">${initialStudentProgramme}</span> | <span id="dashboardStudentRegNo">${initialStudentRegNo}</span></p>
            <p class="text-gray-600 mt-2">Ready to embark on a productive day? Your academic journey awaits! üöÄ</p>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
            <h3 class="text-lg font-bold text-green-800 mb-2">My GPA</h3>
            <div class="gpa-circle-container">
              <svg viewBox="0 0 120 120" class="gpa-circle-svg w-full h-full">
                <circle cx="60" cy="60" r="50" class="gpa-circle-bg"></circle>
                <circle id="gpaCircleProgress" cx="60" cy="60" r="50" class="gpa-circle-progress" style="stroke-dasharray: 0, 314.159; stroke: #888888;"></circle>
              </svg>
              <div id="gpaText" class="gpa-text">0.00</div>
            </div>
            <p id="latestGradeInfo" class="text-center text-gray-700">Loading grades... <a onclick="showDashboardSection('grades')" class="text-blue-500 hover:underline">View All Grades</a></p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
            <h3 class="text-lg font-bold text-green-800 mb-2">Fees Balance</h3>
            <p id="feesBalanceAmount" class="text-4xl font-extrabold text-gray-500 mt-4">GHS 0.00</p>
            <p id="feesBalanceStatus" class="text-gray-700 mt-4">Outstanding balance: <span class="font-semibold text-gray-500">Loading...</span></p>
            <div class="mt-4">
              <button onclick="showDashboardSection('fees')" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">View Statement</button>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
            <h3 class="text-lg font-bold text-green-800 mb-2">Upcoming Deadlines</h3>
            <div class="space-y-4 mt-4">
              <p id="upcomingDeadlineText" class="text-gray-700"><strong>Loading deadlines...</strong></p>
              <div class="flex flex-col space-y-2">
                <p class="text-gray-700">Academic Calendar: ${new Date().getFullYear()}/${new Date().getFullYear() + 1}</p>
                <a href="#" onclick="showDashboardSection('timetable')" class="text-blue-500 hover:underline">View Exam Timetable</a>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-8">
          <h3 class="text-xl font-bold text-green-800 mb-4">Latest Announcements</h3>
          <div id="announcementsList" class="space-y-4 no-scrollbar max-h-96 overflow-y-auto">
            <p class="text-gray-500">Loading announcements...</p>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Dashboard Home") + homeContentHtml;

      // --- Data Fetching and Updating UI ---
      // Fetch Grades for GPA
      const gradesQuery = query(collection(db, `students/${currentUserId}/grades`));
      onSnapshot(gradesQuery, (querySnapshot) => {
        const grades = querySnapshot.docs.map(doc => doc.data());
        const gpa = calculateGPA(grades);
        const gpaText = document.getElementById('gpaText');
        const latestGradeInfo = document.getElementById('latestGradeInfo');
        const gpaCircleProgress = document.getElementById('gpaCircleProgress');
        const circumference = 2 * Math.PI * 50;
        const progress = (gpa / 4.0) * circumference;
        if (gpaCircleProgress) {
          gpaCircleProgress.style.strokeDasharray = `${progress}, ${circumference}`;
          gpaCircleProgress.style.stroke = gpa >= 3.0 ? '#16a34a' : gpa >= 2.0 ? '#fbbf24' : '#dc2626';
        }
        if (gpaText) gpaText.innerText = gpa;
        if (latestGradeInfo) {
          const latestGrade = grades[0] ? `${grades[0].courseCode} (${grades[0].grade})` : "No grades yet.";
          latestGradeInfo.innerHTML = `Latest grade: <strong>${latestGrade}</strong>. <a onclick="showDashboardSection('grades')" class="text-blue-500 hover:underline">View All Grades</a>`;
        }
      });

      // Fetch Fees Balance
      const feesQuery = query(collection(db, `students/${currentUserId}/feesStatement`), orderBy("date", "desc"));
      onSnapshot(feesQuery, (querySnapshot) => {
        const transactions = querySnapshot.docs.map(doc => doc.data());
        let balance = 0;
        transactions.forEach(t => {
          balance += t.debit || 0;
          balance -= t.credit || 0;
        });

        const feesBalanceAmount = document.getElementById('feesBalanceAmount');
        const feesBalanceStatus = document.getElementById('feesBalanceStatus');
        if (feesBalanceAmount) feesBalanceAmount.innerText = `GHS ${balance.toFixed(2)}`;
        if (feesBalanceStatus) {
          const statusSpan = feesBalanceStatus.querySelector('span');
          if (statusSpan) {
            if (balance > 0) {
              statusSpan.innerText = "Outstanding";
              statusSpan.classList.add('fees-balance-text', 'red');
              statusSpan.classList.remove('green', 'text-gray-500');
            } else {
              statusSpan.innerText = "Cleared";
              statusSpan.classList.add('fees-balance-text', 'green');
              statusSpan.classList.remove('red', 'text-gray-500');
            }
          }
        }
      });

      // Fetch Announcements
      const announcementsQuery = query(announcementsRef, orderBy("date", "desc"), limit(5));
      onSnapshot(announcementsQuery, (querySnapshot) => {
        const announcementsList = document.getElementById('announcementsList');
        announcementsList.innerHTML = '';
        if (querySnapshot.empty) {
          announcementsList.innerHTML = `<p class="text-gray-500">No recent announcements.</p>`;
        } else {
          querySnapshot.forEach(doc => {
            const announcement = doc.data();
            const date = announcement.date ? new Date(announcement.date.toDate()).toLocaleDateString() : 'N/A';
            const itemHtml = `
              <div class="border-b pb-3">
                <p class="text-sm text-gray-500">${date}</p>
                <h4 class="font-semibold text-md text-green-800">${announcement.title}</h4>
                <p class="text-sm text-gray-700">${announcement.content}</p>
              </div>
            `;
            announcementsList.innerHTML += itemHtml;
          });
        }
      });
    }

    // 2. Course Registration
    async function loadCourseReg() {
      const content = document.getElementById("dashboardContent");
      const courseRegHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Course Registration</h2>
          <form id="course-reg-form">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              <div>
                <label for="reg-department" class="block text-gray-700 font-medium mb-2">Department</label>
                <select id="reg-department" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                  <option value="">Select Department</option>
                </select>
              </div>
              <div>
                <label for="reg-year" class="block text-gray-700 font-medium mb-2">Year of Study</label>
                <select id="reg-year" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                  <option value="">Select Year</option>
                  <option value="1">Year 1</option>
                  <option value="2">Year 2</option>
                  <option value="3">Year 3</option>
                  <option value="4">Year 4</option>
                </select>
              </div>
              <div>
                <label for="reg-semester" class="block text-gray-700 font-medium mb-2">Semester</label>
                <select id="reg-semester" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                  <option value="">Select Semester</option>
                  <option value="1">Semester 1</option>
                  <option value="2">Semester 2</option>
                </select>
              </div>
              <div>
                <label for="reg-course" class="block text-gray-700 font-medium mb-2">Course</label>
                <select id="reg-course" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                  <option value="">Select Course</option>
                </select>
              </div>
            </div>
            <button type="submit" id="registerCourseBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
              Register Course
            </button>
          </form>
          <div id="courseRegStatus" class="mt-6 text-md font-semibold text-center hidden"></div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Course Registration") + courseRegHtml;

      const deptSelect = document.getElementById('reg-department');
      const yearSelect = document.getElementById('reg-year');
      const semesterSelect = document.getElementById('reg-semester');
      const courseSelect = document.getElementById('reg-course');
      const regForm = document.getElementById('course-reg-form');
      const regStatus = document.getElementById('courseRegStatus');

      let allCourses = [];

      // Fetch all courses and populate initial dropdowns
      showLoading("Fetching courses...");
      try {
        const coursesQuery = query(collection(db, 'courses'));
        const querySnapshot = await getDocs(coursesQuery);
        allCourses = querySnapshot.docs.map(doc => doc.data());

        const departments = [...new Set(allCourses.map(c => c.department))];
        departments.sort();
        departments.forEach(d => {
          const option = document.createElement('option');
          option.value = d;
          option.textContent = d;
          deptSelect.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching courses:", error);
        alert("Failed to load courses. Please try again.");
      } finally {
        hideLoading();
      }

      // Filter courses based on selections
      const filterCourses = () => {
        const selectedDept = deptSelect.value;
        const selectedYear = yearSelect.value;
        const selectedSem = semesterSelect.value;

        courseSelect.innerHTML = '<option value="">Select Course</option>';
        const filteredCourses = allCourses.filter(c =>
          (selectedDept === "" || c.department === selectedDept) &&
          (selectedYear === "" || c.yearOfStudy === parseInt(selectedYear)) &&
          (selectedSem === "" || c.semester === parseInt(selectedSem))
        );

        if (filteredCourses.length > 0) {
          filteredCourses.sort((a, b) => a.courseCode.localeCompare(b.courseCode));
          filteredCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.courseCode;
            option.textContent = `${course.courseCode} - ${course.courseName}`;
            courseSelect.appendChild(option);
          });
        }
      };

      deptSelect.addEventListener('change', filterCourses);
      yearSelect.addEventListener('change', filterCourses);
      semesterSelect.addEventListener('change', filterCourses);

      regForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const registerBtn = document.getElementById('registerCourseBtn');
        setButtonLoading(registerBtn, true);
        regStatus.classList.add('hidden');

        const courseCode = courseSelect.value;
        if (!courseCode) {
          alert("Please select a course to register.");
          setButtonLoading(registerBtn, false);
          return;
        }

        const selectedCourse = allCourses.find(c => c.courseCode === courseCode);
        const student = currentUserData;

        // Validation based on student's profile
        if (student.department !== selectedCourse.department || student.yearOfStudy !== selectedCourse.yearOfStudy || student.semester !== selectedCourse.semester) {
          regStatus.innerText = "‚ùå Registration failed: This course does not match your academic profile.";
          regStatus.classList.remove('hidden');
          setButtonLoading(registerBtn, false);
          return;
        }

        try {
          const studentRegistrationsRef = collection(db, `students/${currentUserId}/registrations`);
          const existingRegQuery = query(studentRegistrationsRef, where("courseCode", "==", courseCode));
          const existingRegSnapshot = await getDocs(existingRegQuery);

          if (!existingRegSnapshot.empty) {
            regStatus.innerText = "‚ö†Ô∏è You are already registered for this course.";
            regStatus.classList.remove('hidden');
          } else {
            await addDoc(studentRegistrationsRef, {
              courseCode: selectedCourse.courseCode,
              courseName: selectedCourse.courseName,
              department: selectedCourse.department,
              yearOfStudy: selectedCourse.yearOfStudy,
              semester: selectedCourse.semester,
              registeredAt: new Date(),
              status: "Registered"
            });
            regStatus.innerText = "‚úÖ Registration successful!";
            regStatus.classList.remove('hidden');
            await showCustomModal("Success", "Course registered successfully!");
          }
        } catch (error) {
          console.error("Error registering course:", error);
          regStatus.innerText = "‚ùå An error occurred during registration. Please try again.";
          regStatus.classList.remove('hidden');
        } finally {
          setButtonLoading(registerBtn, false);
        }
      });
    }

    // 3. Academic Timetable
    async function loadTimetable() {
      const content = document.getElementById("dashboardContent");
      const timetableHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Academic Timetable</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <div>
              <label for="tt-department" class="block text-gray-700 font-medium mb-2">Department</label>
              <select id="tt-department" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                <option value="">Select Department</option>
              </select>
            </div>
            <div>
              <label for="tt-year" class="block text-gray-700 font-medium mb-2">Year of Study</label>
              <select id="tt-year" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                <option value="">Select Year</option>
                <option value="1">Year 1</option>
                <option value="2">Year 2</option>
                <option value="3">Year 3</option>
                <option value="4">Year 4</option>
              </select>
            </div>
            <div>
              <label for="tt-semester" class="block text-gray-700 font-medium mb-2">Semester</label>
              <select id="tt-semester" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                <option value="">Select Semester</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
              </select>
            </div>
          </div>
          <div id="timetableDisplay" class="overflow-x-auto">
            <p class="text-center text-gray-500 mt-8">Please select a Department, Year, and Semester to view the timetable.</p>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Academic Timetable") + timetableHtml;

      const deptSelect = document.getElementById('tt-department');
      const yearSelect = document.getElementById('tt-year');
      const semesterSelect = document.getElementById('tt-semester');
      const timetableDisplay = document.getElementById('timetableDisplay');

      let allTimetables = [];
      let allDepartments = [];

      // Fetch all timetable data and departments on load
      showLoading("Loading timetable data...");
      try {
          const timetableDocs = await getDocs(collection(db, 'timetables'));
          allTimetables = timetableDocs.docs.map(doc => doc.data());
          allDepartments = [...new Set(allTimetables.map(t => t.department))].sort();

          allDepartments.forEach(d => {
              const option = document.createElement('option');
              option.value = d;
              option.textContent = d;
              deptSelect.appendChild(option);
          });

      } catch (error) {
          console.error("Error fetching timetable data:", error);
          alert("Failed to load timetable data. Please try again.");
      } finally {
          hideLoading();
      }

      const renderTimetable = () => {
        const selectedDept = deptSelect.value;
        const selectedYear = parseInt(yearSelect.value);
        const selectedSem = parseInt(semesterSelect.value);

        if (!selectedDept || !selectedYear || !selectedSem) {
          timetableDisplay.innerHTML = `<p class="text-center text-gray-500 mt-8">Please select a Department, Year, and Semester to view the timetable.</p>`;
          return;
        }

        const filteredTimetables = allTimetables.filter(t =>
          t.department === selectedDept && t.yearOfStudy === selectedYear && t.semester === selectedSem
        );

        if (filteredTimetables.length === 0) {
          timetableDisplay.innerHTML = `<p class="text-center text-red-500 font-semibold mt-8">No timetable found for the selected criteria. Please check back later.</p>`;
          return;
        }

        // Aggregate classes by day and time
        const classesByDay = {
          'Monday': [], 'Tuesday': [], 'Wednesday': [], 'Thursday': [], 'Friday': []
        };
        const allTimes = new Set();
        filteredTimetables.forEach(t => {
          t.days.forEach(day => {
            if (classesByDay[day]) {
              classesByDay[day].push(t);
              allTimes.add(t.startTime);
              allTimes.add(t.endTime);
            }
          });
        });
        const sortedTimes = [...allTimes].sort();

        // Mobile View (Stacked Cards)
        const mobileTimetableHtml = `
          <div class="lg:hidden">
            ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => `
              <div class="timetable-day-card">
                <h3 class="timetable-day-title">${day}</h3>
                ${classesByDay[day].length > 0 ? classesByDay[day].map(cls => `
                  <div class="timetable-class-item">
                    <p class="font-bold text-gray-800">${cls.startTime} - ${cls.endTime}</p>
                    <p>${cls.courseCode} - ${cls.courseName}</p>
                    <p class="text-sm text-gray-600">Lecturer: ${cls.lecturer}</p>
                    <p class="text-sm text-gray-600">Venue: ${cls.venue}</p>
                  </div>
                `).join('') : '<p class="text-gray-500">No classes</p>'}
              </div>
            `).join('')}
          </div>
        `;

        // Desktop View (Grid)
        const desktopTimetableHtml = `
          <div class="hidden lg:block timetable-grid">
            <div class="timetable-header">Time</div>
            <div class="timetable-header">Monday</div>
            <div class="timetable-header">Tuesday</div>
            <div class="timetable-header">Wednesday</div>
            <div class="timetable-header">Thursday</div>
            <div class="timetable-header">Friday</div>
            ${sortedTimes.map(time => `
              <div class="timetable-header">${time}</div>
              ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => {
                const classAtTime = classesByDay[day].find(c => c.startTime === time);
                if (classAtTime) {
                  return `
                    <div class="timetable-cell">
                      <p class="font-bold">${classAtTime.courseCode}</p>
                      <p>${classAtTime.courseName}</p>
                      <p class="text-sm text-gray-600">${classAtTime.lecturer}</p>
                      <p class="text-sm text-gray-600">${classAtTime.venue}</p>
                    </div>
                  `;
                } else {
                  return `<div class="timetable-cell"></div>`;
                }
              }).join('')}
            `).join('')}
          </div>
        `;

        timetableDisplay.innerHTML = mobileTimetableHtml + desktopTimetableHtml;
      };

      deptSelect.addEventListener('change', renderTimetable);
      yearSelect.addEventListener('change', renderTimetable);
      semesterSelect.addEventListener('change', renderTimetable);
    }

    // 4. Grades & Transcripts
    async function loadGrades() {
      const content = document.getElementById("dashboardContent");
      const gradesHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Grades & Transcripts</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <label for="grades-year" class="block text-gray-700 font-medium mb-2">Year of Study</label>
              <select id="grades-year" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                <option value="all">All Years</option>
              </select>
            </div>
            <div>
              <label for="grades-semester" class="block text-gray-700 font-medium mb-2">Semester</label>
              <select id="grades-semester" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                <option value="all">All Semesters</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
              </select>
            </div>
          </div>
          <div class="overflow-x-auto mb-6">
            <table class="min-w-full bg-white border-collapse rounded-lg overflow-hidden">
              <thead class="bg-gray-200 text-gray-700">
                <tr>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-300">Course Code</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-300">Course Name</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-300">Grade</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-300">Semester</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-300">Year</th>
                </tr>
              </thead>
              <tbody id="gradesTableBody">
                <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading grades...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="bg-gray-100 p-4 rounded-md flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-green-800">Cumulative GPA/CGPA: <span id="cgpaValue" class="text-xl font-extrabold text-green-700">0.00</span></h3>
            <h3 class="text-lg font-bold text-green-800">Current GPA: <span id="gpaValue" class="text-xl font-extrabold text-green-700">0.00</span></h3>
          </div>
          <div class="flex justify-start space-x-4">
            <button onclick="generateTranscript()" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">
              <i class="fas fa-file-pdf mr-2"></i>Generate Transcript (PDF)
            </button>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Grades & Transcripts") + gradesHtml;

      const gradesTableBody = document.getElementById('gradesTableBody');
      const gradesYearSelect = document.getElementById('grades-year');
      const gradesSemesterSelect = document.getElementById('grades-semester');
      const gpaValue = document.getElementById('gpaValue');
      const cgpaValue = document.getElementById('cgpaValue');

      let allGrades = [];

      const renderGrades = () => {
        const selectedYear = gradesYearSelect.value;
        const selectedSemester = gradesSemesterSelect.value;

        let filteredGrades = allGrades;
        if (selectedYear !== 'all') {
          filteredGrades = filteredGrades.filter(g => g.yearOfStudy === parseInt(selectedYear));
        }
        if (selectedSemester !== 'all') {
          filteredGrades = filteredGrades.filter(g => g.semester === parseInt(selectedSemester));
        }

        gradesTableBody.innerHTML = '';
        if (filteredGrades.length === 0) {
          gradesTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No grades found for the selected filter.</td></tr>`;
          gpaValue.innerText = "0.00";
        } else {
          filteredGrades.forEach(grade => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="py-3 px-4 border-b border-gray-300">${grade.courseCode}</td>
              <td class="py-3 px-4 border-b border-gray-300">${grade.courseName}</td>
              <td class="py-3 px-4 border-b border-gray-300 font-bold">${grade.grade}</td>
              <td class="py-3 px-4 border-b border-gray-300">${grade.semester}</td>
              <td class="py-3 px-4 border-b border-gray-300">${grade.yearOfStudy}</td>
            `;
            gradesTableBody.appendChild(row);
          });
          gpaValue.innerText = calculateGPA(filteredGrades);
        }
      };

      const fetchGrades = onSnapshot(collection(db, `students/${currentUserId}/grades`), (querySnapshot) => {
        allGrades = querySnapshot.docs.map(doc => doc.data());
        allGrades.sort((a, b) => {
          if (a.yearOfStudy !== b.yearOfStudy) return a.yearOfStudy - b.yearOfStudy;
          return a.semester - b.semester;
        });

        // Populate year filter
        const years = [...new Set(allGrades.map(g => g.yearOfStudy))].sort();
        gradesYearSelect.innerHTML = '<option value="all">All Years</option>';
        years.forEach(y => {
          const option = document.createElement('option');
          option.value = y;
          option.textContent = `Year ${y}`;
          gradesYearSelect.appendChild(option);
        });

        cgpaValue.innerText = calculateGPA(allGrades);
        renderGrades();
      });

      gradesYearSelect.addEventListener('change', renderGrades);
      gradesSemesterSelect.addEventListener('change', renderGrades);
    }

    // PDF Generation Logic (Transcript)
    window.generateTranscript = async function() {
        const studentInfo = currentUserData;
        if (!studentInfo || studentInfo.regNo === 'N/A') {
            await showCustomModal("Error", "Student information is incomplete. Please update your profile first.");
            return;
        }

        showLoading("Generating transcript...");
        try {
            const gradesSnapshot = await getDocs(query(collection(db, `students/${currentUserId}/grades`), orderBy("yearOfStudy"), orderBy("semester")));
            const allGrades = gradesSnapshot.docs.map(doc => doc.data());
            const cgpa = calculateGPA(allGrades);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.setTextColor(0, 51, 0); // Dark Green
            doc.text("OFFICIAL ACADEMIC TRANSCRIPT", 105, 20, null, null, "center");
            doc.setFontSize(10);
            doc.setTextColor(51, 51, 51); // Dark Gray
            doc.text("Prince Alex Design University", 105, 27, null, null, "center");
            doc.text("P.O Box 1234, University Road, Cityville", 105, 32, null, null, "center");
            doc.text("www.princealex.edu", 105, 37, null, null, "center");
            doc.addImage('myschoollogo.png', 'PNG', 10, 15, 30, 30); // Logo

            // Student Info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "bold");
            doc.text("Student Information:", 15, 50);
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${studentInfo.name}`, 15, 57);
            doc.text(`Student ID: ${studentInfo.regNo}`, 15, 62);
            doc.text(`Program: ${studentInfo.programme}`, 15, 67);
            doc.text(`Date of Issue: ${new Date().toLocaleDateString()}`, 15, 72);

            // Grades Table
            const tableHeaders = ["Course Code", "Course Name", "Grade", "Semester", "Year of Study"];
            const tableData = allGrades.map(g => [
                g.courseCode,
                g.courseName,
                g.grade,
                g.semester,
                g.yearOfStudy
            ]);

            doc.autoTable({
                startY: 80,
                head: [tableHeaders],
                body: tableData,
                styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [0, 100, 0], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 75, left: 15, right: 15, bottom: 20 },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(8);
                    doc.text("Prince Alex Design University | Official Transcript", data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            // Summary
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Academic Summary:", 15, finalY);
            doc.setFont("helvetica", "normal");
            doc.text(`Cumulative GPA (CGPA): ${cgpa}`, 15, finalY + 7);
            doc.text("Remarks: Good Standing", 15, finalY + 14);

            doc.save(`Transcript-${studentInfo.regNo}.pdf`);
        } catch (error) {
            console.error("Error generating PDF:", error);
            await showCustomModal("Error", "Failed to generate transcript. Please try again.");
        } finally {
            hideLoading();
        }
    };

    // 5. Graduation Request
    async function loadGraduation() {
      const content = document.getElementById("dashboardContent");
      const graduationHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Graduation Request</h2>
          <form id="graduation-form">
            <div class="space-y-4 mb-6">
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Student Name:</p>
                <p id="grad-name" class="font-semibold">${currentUserData.name || 'N/A'}</p>
              </div>
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Student ID:</p>
                <p id="grad-regno" class="font-semibold">${currentUserData.regNo || 'N/A'}</p>
              </div>
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Program:</p>
                <p id="grad-program" class="font-semibold">${currentUserData.programme || 'N/A'}</p>
              </div>
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Year of Study:</p>
                <p id="grad-year" class="font-semibold">${currentUserData.yearOfStudy || 'N/A'}</p>
              </div>
            </div>
            <div class="mb-4">
              <label for="grad-session" class="block text-gray-700 font-medium mb-2">Graduation Session</label>
              <select id="grad-session" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                <option value="">Select Session</option>
                <option value="July 2025">July 2025</option>
                <option value="December 2025">December 2025</option>
                <option value="July 2026">July 2026</option>
              </select>
            </div>
            <div class="mb-4">
              <div class="flex items-center">
                <input type="checkbox" id="grad-confirm" class="form-checkbox h-5 w-5 text-green-600 rounded" required>
                <label for="grad-confirm" class="ml-2 text-gray-700">I confirm that all academic and financial requirements have been met.</label>
              </div>
            </div>
            <div class="mb-6">
              <label for="grad-notes" class="block text-gray-700 font-medium mb-2">Special Notes (Optional)</label>
              <textarea id="grad-notes" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200"></textarea>
            </div>
            <button type="submit" id="grad-submit-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
              Submit Request
            </button>
          </form>
          <div id="gradStatus" class="mt-6 p-4 rounded-md text-center hidden"></div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Graduation Request") + graduationHtml;

      const gradForm = document.getElementById('graduation-form');
      const gradStatusDiv = document.getElementById('gradStatus');

      // Check for existing request and show status
      const checkStatus = onSnapshot(doc(db, `students/${currentUserId}`), (docSnap) => {
        const student = docSnap.data();
        if (student && student.graduationRequest) {
          gradStatusDiv.classList.remove('hidden');
          const request = student.graduationRequest;
          gradForm.classList.add('hidden');
          let statusColor = 'bg-blue-100 text-blue-800';
          if (request.status === 'Approved') { statusColor = 'bg-green-100 text-green-800'; }
          if (request.status === 'Declined') { statusColor = 'bg-red-100 text-red-800'; }
          gradStatusDiv.innerHTML = `
            <div class="${statusColor} p-4 rounded-md">
              <p class="font-bold text-lg">Your Graduation Request Status:</p>
              <p>Status: <span class="font-extrabold">${request.status}</span></p>
              <p>Session: ${request.session}</p>
              <p>Submitted On: ${request.submittedAt ? new Date(request.submittedAt.toDate()).toLocaleDateString() : 'N/A'}</p>
            </div>
          `;
        } else {
          gradForm.classList.remove('hidden');
          gradStatusDiv.classList.add('hidden');
        }
      });

      gradForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('grad-submit-btn');
        setButtonLoading(submitBtn, true);

        const session = document.getElementById('grad-session').value;
        const notes = document.getElementById('grad-notes').value;

        try {
          // Save request in the main graduationRequests collection and also under the student's profile
          const requestDocRef = doc(db, 'graduationRequests', currentUserId);
          const studentDocRef = doc(db, 'students', currentUserId);

          const requestData = {
            studentId: currentUserId,
            name: currentUserData.name,
            programme: currentUserData.programme,
            session,
            notes,
            status: "Pending",
            submittedAt: new Date()
          };

          await setDoc(requestDocRef, requestData);
          await updateDoc(studentDocRef, {
            graduationRequest: requestData
          });

          await showCustomModal("Request Submitted", "‚úÖ Your graduation request has been submitted successfully!");
        } catch (error) {
          console.error("Error submitting graduation request:", error);
          await showCustomModal("Submission Failed", "‚ùå Failed to submit your request. Please try again.");
        } finally {
          setButtonLoading(submitBtn, false);
        }
      });
    }

    // 6. Clearance Request
    async function loadClearance() {
      const content = document.getElementById("dashboardContent");
      const clearanceHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Clearance Request</h2>
          <form id="clearance-form">
            <div class="space-y-4 mb-6">
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Student Name:</p>
                <p id="clearance-name" class="font-semibold">${currentUserData.name || 'N/A'}</p>
              </div>
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Student ID:</p>
                <p id="clearance-regno" class="font-semibold">${currentUserData.regNo || 'N/A'}</p>
              </div>
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Program:</p>
                <p id="clearance-program" class="font-semibold">${currentUserData.programme || 'N/A'}</p>
              </div>
              <div class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-500">Year of Study:</p>
                <p id="clearance-year" class="font-semibold">${currentUserData.yearOfStudy || 'N/A'}</p>
              </div>
            </div>
            <div class="mb-4">
              <label for="clearance-type" class="block text-gray-700 font-medium mb-2">Clearance Type</label>
              <select id="clearance-type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                <option value="">Select Type</option>
                <option value="Final Graduation Clearance">Final Graduation Clearance</option>
                <option value="Library Clearance">Library Clearance</option>
                <option value="Hostel Clearance">Hostel Clearance</option>
              </select>
            </div>
            <div class="mb-4">
              <div class="flex items-center">
                <input type="checkbox" id="clearance-confirm" class="form-checkbox h-5 w-5 text-green-600 rounded" required>
                <label for="clearance-confirm" class="ml-2 text-gray-700">I confirm all items have been returned and dues cleared.</label>
              </div>
            </div>
            <div class="mb-6">
              <label for="clearance-notes" class="block text-gray-700 font-medium mb-2">Additional Comments (Optional)</label>
              <textarea id="clearance-notes" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200"></textarea>
            </div>
            <button type="submit" id="clearance-submit-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
              Submit Request
            </button>
          </form>
          <div id="clearanceStatus" class="mt-6 p-4 rounded-md text-center hidden"></div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Clearance Request") + clearanceHtml;

      const clearanceForm = document.getElementById('clearance-form');
      const clearanceStatusDiv = document.getElementById('clearanceStatus');

      // Check for existing requests and display status
      const checkStatus = onSnapshot(query(collection(db, `clearanceRequests`), where("studentId", "==", currentUserId)), (querySnapshot) => {
        if (!querySnapshot.empty) {
          clearanceStatusDiv.classList.remove('hidden');
          clearanceForm.classList.add('hidden');
          const request = querySnapshot.docs[0].data();
          let statusColor = 'bg-blue-100 text-blue-800';
          if (request.status === 'Approved') { statusColor = 'bg-green-100 text-green-800'; }
          if (request.status === 'Rejected') { statusColor = 'bg-red-100 text-red-800'; }
          clearanceStatusDiv.innerHTML = `
            <div class="${statusColor} p-4 rounded-md">
              <p class="font-bold text-lg">Your Clearance Request Status:</p>
              <p>Type: ${request.type}</p>
              <p>Status: <span class="font-extrabold">${request.status}</span></p>
              <p>Submitted On: ${request.submittedAt ? new Date(request.submittedAt.toDate()).toLocaleDateString() : 'N/A'}</p>
            </div>
          `;
        } else {
          clearanceForm.classList.remove('hidden');
          clearanceStatusDiv.classList.add('hidden');
        }
      });

      clearanceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('clearance-submit-btn');
        setButtonLoading(submitBtn, true);

        const type = document.getElementById('clearance-type').value;
        const notes = document.getElementById('clearance-notes').value;

        try {
          await addDoc(collection(db, `clearanceRequests`), {
            studentId: currentUserId,
            name: currentUserData.name,
            programme: currentUserData.programme,
            type,
            notes,
            status: "Pending",
            submittedAt: new Date()
          });

          await showCustomModal("Request Submitted", "‚úÖ Your clearance request has been submitted successfully!");
        } catch (error) {
          console.error("Error submitting clearance request:", error);
          await showCustomModal("Submission Failed", "‚ùå Failed to submit your request. Please try again.");
        } finally {
          setButtonLoading(submitBtn, false);
        }
      });
    }

    // 7. Fees Statement
    async function loadFees() {
      const content = document.getElementById("dashboardContent");
      const feesHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Fees Statement</h2>
          <div class="bg-gray-100 p-4 rounded-md flex justify-between items-center mb-6">
            <div>
              <p class="text-sm text-gray-500">Student Name:</p>
              <p id="fees-name" class="font-semibold">${currentUserData.name || 'N/A'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Student ID:</p>
              <p id="fees-regno" class="font-semibold">${currentUserData.regNo || 'N/A'}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Program:</p>
              <p id="fees-program" class="font-semibold">${currentUserData.programme || 'N/A'}</p>
            </div>
          </div>
          <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div class="mb-4 md:mb-0">
              <label for="fees-semester" class="block text-gray-700 font-medium mb-2">Filter by Semester</label>
              <select id="fees-semester" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                <option value="all">All Semesters</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
              </select>
            </div>
            <div class="flex space-x-2">
              <button onclick="exportFees('pdf')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                <i class="fas fa-file-pdf mr-2"></i>Export to PDF
              </button>
              <button onclick="exportFees('excel')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                <i class="fas fa-file-excel mr-2"></i>Export to Excel
              </button>
            </div>
          </div>
          <div id="feesTableContainer" class="overflow-x-auto mb-6">
            <table id="feesTable" class="min-w-full bg-white border-collapse rounded-lg overflow-hidden hidden md:table">
              <thead class="bg-gray-200 text-gray-700">
                <tr>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-300">Date</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-300">Description</th>
                  <th class="py-3 px-4 text-right font-bold border-b border-gray-300">Debit (GHS)</th>
                  <th class="py-3 px-4 text-right font-bold border-b border-gray-300">Credit (GHS)</th>
                  <th class="py-3 px-4 text-right font-bold border-b border-gray-300">Balance (GHS)</th>
                </tr>
              </thead>
              <tbody id="feesTableBody"></tbody>
            </table>
            <div id="feesMobileCards" class="md:hidden space-y-4"></div>
            <p id="fees-no-data" class="text-center text-gray-500 mt-4 hidden">No fees statement data found.</p>
          </div>
          <div class="bg-gray-100 p-4 rounded-md flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
            <h3 class="text-lg font-bold text-green-800">Total Charges: <span id="totalCharges" class="font-extrabold text-green-700">GHS 0.00</span></h3>
            <h3 class="text-lg font-bold text-green-800">Total Paid: <span id="totalPaid" class="font-extrabold text-green-700">GHS 0.00</span></h3>
            <h3 class="text-lg font-bold text-green-800">Outstanding Balance: <span id="outstandingBalance" class="font-extrabold">GHS 0.00</span></h3>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Fees Statement") + feesHtml;

      const feesTableBody = document.getElementById('feesTableBody');
      const feesMobileCards = document.getElementById('feesMobileCards');
      const totalChargesEl = document.getElementById('totalCharges');
      const totalPaidEl = document.getElementById('totalPaid');
      const outstandingBalanceEl = document.getElementById('outstandingBalance');
      const feesSemesterSelect = document.getElementById('fees-semester');
      const feesNoDataEl = document.getElementById('fees-no-data');
      const feesTableEl = document.getElementById('feesTable');

      let allTransactions = [];

      const renderFees = () => {
        const selectedSemester = feesSemesterSelect.value;
        let balance = 0;
        let totalCharges = 0;
        let totalPaid = 0;

        const filteredTransactions = selectedSemester === 'all'
          ? allTransactions
          : allTransactions.filter(t => t.semester === parseInt(selectedSemester));

        if (filteredTransactions.length === 0) {
          feesTableBody.innerHTML = '';
          feesMobileCards.innerHTML = '';
          feesNoDataEl.classList.remove('hidden');
          totalChargesEl.innerText = 'GHS 0.00';
          totalPaidEl.innerText = 'GHS 0.00';
          outstandingBalanceEl.innerText = 'GHS 0.00';
          outstandingBalanceEl.classList.remove('red', 'green');
          return;
        }

        feesNoDataEl.classList.add('hidden');
        feesTableBody.innerHTML = '';
        feesMobileCards.innerHTML = '';

        // Calculate running balance and totals
        const transactionsWithBalance = filteredTransactions.sort((a, b) => a.date.toDate() - b.date.toDate()).map(t => {
          balance += (t.debit || 0) - (t.credit || 0);
          totalCharges += t.debit || 0;
          totalPaid += t.credit || 0;
          return { ...t, balance };
        });

        // Render for desktop
        transactionsWithBalance.forEach(t => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="py-3 px-4 border-b border-gray-300">${new Date(t.date.toDate()).toLocaleDateString()}</td>
            <td class="py-3 px-4 border-b border-gray-300">${t.description}</td>
            <td class="py-3 px-4 border-b border-gray-300 text-right text-red-600">${t.debit ? `+${t.debit.toFixed(2)}` : '0.00'}</td>
            <td class="py-3 px-4 border-b border-gray-300 text-right text-green-600">${t.credit ? `-${t.credit.toFixed(2)}` : '0.00'}</td>
            <td class="py-3 px-4 border-b border-gray-300 text-right font-bold">${t.balance.toFixed(2)}</td>
          `;
          feesTableBody.appendChild(row);
        });
        feesTableEl.classList.remove('hidden');

        // Render for mobile
        transactionsWithBalance.forEach(t => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <p class="card-title">${t.description}</p>
            <p class="text-sm text-gray-500 mb-2">${new Date(t.date.toDate()).toLocaleDateString()}</p>
            <p class="flex justify-between"><strong>Debit:</strong> <span class="text-red-600">GHS ${t.debit ? t.debit.toFixed(2) : '0.00'}</span></p>
            <p class="flex justify-between"><strong>Credit:</strong> <span class="text-green-600">GHS ${t.credit ? t.credit.toFixed(2) : '0.00'}</span></p>
            <p class="flex justify-between mt-2 font-bold"><strong>Balance:</strong> <span>GHS ${t.balance.toFixed(2)}</span></p>
          `;
          feesMobileCards.appendChild(card);
        });

        // Update summary section
        totalChargesEl.innerText = `GHS ${totalCharges.toFixed(2)}`;
        totalPaidEl.innerText = `GHS ${totalPaid.toFixed(2)}`;
        outstandingBalanceEl.innerText = `GHS ${balance.toFixed(2)}`;
        outstandingBalanceEl.classList.toggle('red', balance > 0);
        outstandingBalanceEl.classList.toggle('green', balance <= 0);
      };

      const fetchFeesData = onSnapshot(collection(db, `students/${currentUserId}/feesStatement`), (querySnapshot) => {
        allTransactions = querySnapshot.docs.map(doc => doc.data());
        renderFees();
      });

      feesSemesterSelect.addEventListener('change', renderFees);
    }

    // Export Fees Statement
    window.exportFees = async function(type) {
      showLoading(`Exporting to ${type.toUpperCase()}...`);
      try {
          const feesSnapshot = await getDocs(query(collection(db, `students/${currentUserId}/feesStatement`), orderBy("date")));
          const transactions = feesSnapshot.docs.map(doc => doc.data());
          if (transactions.length === 0) {
              await showCustomModal("No Data", "There is no fees data to export.");
              return;
          }

          let balance = 0;
          const exportData = transactions.map(t => {
              balance += (t.debit || 0) - (t.credit || 0);
              return {
                  Date: new Date(t.date.toDate()).toLocaleDateString(),
                  Description: t.description,
                  Debit: t.debit || 0,
                  Credit: t.credit || 0,
                  Balance: balance
              };
          });

          if (type === 'pdf') {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              doc.autoTable({
                  head: [['Date', 'Description', 'Debit (GHS)', 'Credit (GHS)', 'Balance (GHS)']],
                  body: exportData.map(row => [row.Date, row.Description, row.Debit.toFixed(2), row.Credit.toFixed(2), row.Balance.toFixed(2)]),
                  startY: 20,
                  styles: { fontSize: 10, cellPadding: 2 },
                  headStyles: { fillColor: [0, 100, 0] }
              });
              doc.save('fees_statement.pdf');
          } else if (type === 'excel') {
              const csvData = [
                  ['Date', 'Description', 'Debit (GHS)', 'Credit (GHS)', 'Balance (GHS)'],
                  ...exportData.map(row => [row.Date, row.Description, row.Debit, row.Credit, row.Balance])
              ].map(e => e.join(",")).join("\n");

              const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement("a");
              if (link.download !== undefined) {
                  const url = URL.createObjectURL(blob);
                  link.setAttribute("href", url);
                  link.setAttribute("download", "fees_statement.csv");
                  link.style.visibility = 'hidden';
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
              }
          }
      } catch (error) {
          console.error(`Error exporting to ${type}:`, error);
          await showCustomModal("Export Failed", `‚ùå Failed to export fees statement. Please try again.`);
      } finally {
          hideLoading();
      }
    };


    // --- Main Dashboard Section Handler ---
    let currentSection = null;
    window.showDashboardSection = function(sectionId) {
      if (currentSection) {
        // Disconnect listeners to prevent memory leaks if needed
        if (typeof currentSection.unsubscribe === 'function') {
          currentSection.unsubscribe();
        }
      }

      switch (sectionId) {
        case 'home':
          loadHome();
          break;
        case 'courseReg':
          loadCourseReg();
          break;
        case 'timetable':
          loadTimetable();
          break;
        case 'grades':
          loadGrades();
          break;
        case 'graduation':
          loadGraduation();
          break;
        case 'clearance':
          loadClearance();
          break;
        case 'fees':
          loadFees();
          break;
        default:
          document.getElementById('dashboardContent').innerHTML = `<div class="p-6 text-center text-gray-500">Page not found.</div>`;
          break;
      }
      currentSection = { id: sectionId };
      sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile after selection
    };

    // Initialize with sample data if the student profile is new
    async function initializeSampleData() {
        const studentDoc = doc(db, 'students', currentUserId);
        const studentSnap = await getDoc(studentDoc);
        if (studentSnap.exists() && !studentSnap.data().dataInitialized) {
            console.log("Initializing sample data for new user.");

            const batch = writeBatch(db);

            // Update student profile with sample data
            batch.update(studentDoc, {
                regNo: "PDU/2023/12345",
                programme: "BSc. Computer Science",
                department: "Computer Science",
                yearOfStudy: 2,
                semester: 2,
                dataInitialized: true // Prevent re-initialization
            });

            // Sample Grades
            const gradesRef = collection(studentDoc, 'grades');
            batch.set(doc(gradesRef), { courseCode: "CS101", courseName: "Introduction to Programming", grade: "A", semester: 1, yearOfStudy: 1, courseUnit: 3 });
            batch.set(doc(gradesRef), { courseCode: "MATH101", courseName: "Calculus I", grade: "B+", semester: 1, yearOfStudy: 1, courseUnit: 4 });
            batch.set(doc(gradesRef), { courseCode: "PHY101", courseName: "General Physics I", grade: "C", semester: 1, yearOfStudy: 1, courseUnit: 3 });
            batch.set(doc(gradesRef), { courseCode: "CS102", courseName: "Data Structures", grade: "B", semester: 2, yearOfStudy: 1, courseUnit: 4 });
            batch.set(doc(gradesRef), { courseCode: "MATH102", courseName: "Linear Algebra", grade: "A", semester: 2, yearOfStudy: 1, courseUnit: 4 });
            batch.set(doc(gradesRef), { courseCode: "CS201", courseName: "Algorithms", grade: "A", semester: 1, yearOfStudy: 2, courseUnit: 4 });

            // Sample Fees Statement
            const feesRef = collection(studentDoc, 'feesStatement');
            batch.set(doc(feesRef), { date: new Date('2024-09-01'), description: "Semester 1 Tuition Fee", debit: 3500, credit: null, semester: 1, year: 2 });
            batch.set(doc(feesRef), { date: new Date('2024-09-05'), description: "Semester 1 Payment", debit: null, credit: 2000, semester: 1, year: 2 });
            batch.set(doc(feesRef), { date: new Date('2024-09-10'), description: "Library Fee", debit: 250, credit: null, semester: 1, year: 2 });
            batch.set(doc(feesRef), { date: new Date('2025-01-15'), description: "Semester 2 Tuition Fee", debit: 3500, credit: null, semester: 2, year: 2 });
            batch.set(doc(feesRef), { date: new Date('2025-01-20'), description: "Semester 2 Payment", debit: null, credit: 3000, semester: 2, year: 2 });

            // Sample Courses
            const coursesRef = collection(db, 'courses');
            batch.set(doc(coursesRef, "CS101"), { courseCode: "CS101", courseName: "Introduction to Programming", department: "Computer Science", yearOfStudy: 1, semester: 1 });
            batch.set(doc(coursesRef, "MATH101"), { courseCode: "MATH101", courseName: "Calculus I", department: "Mathematics", yearOfStudy: 1, semester: 1 });
            batch.set(doc(coursesRef, "CS201"), { courseCode: "CS201", courseName: "Algorithms", department: "Computer Science", yearOfStudy: 2, semester: 1 });
            batch.set(doc(coursesRef, "PHY201"), { courseCode: "PHY201", courseName: "Electromagnetism", department: "Physics", yearOfStudy: 2, semester: 1 });
            batch.set(doc(coursesRef, "CS202"), { courseCode: "CS202", courseName: "Database Systems", department: "Computer Science", yearOfStudy: 2, semester: 2 });

            // Sample Timetable
            const timetableRef = collection(db, 'timetables');
            batch.set(doc(timetableRef, "tt-cs-2-2"), {
              department: "Computer Science",
              yearOfStudy: 2,
              semester: 2,
              courseCode: "CS202",
              courseName: "Database Systems",
              lecturer: "Dr. Jane Doe",
              venue: "Lab 305",
              days: ["Monday", "Wednesday"],
              startTime: "10:00",
              endTime: "12:00"
            });
            batch.set(doc(timetableRef, "tt-cs-2-2-2"), {
              department: "Computer Science",
              yearOfStudy: 2,
              semester: 2,
              courseCode: "CS203",
              courseName: "Web Development",
              lecturer: "Prof. John Smith",
              venue: "Lab 306",
              days: ["Tuesday", "Thursday"],
              startTime: "13:00",
              endTime: "15:00"
            });
            batch.set(doc(timetableRef, "tt-cs-2-2-3"), {
              department: "Computer Science",
              yearOfStudy: 2,
              semester: 2,
              courseCode: "CS204",
              courseName: "Operating Systems",
              lecturer: "Dr. Alice Brown",
              venue: "Lecture Hall A",
              days: ["Wednesday"],
              startTime: "08:00",
              endTime: "10:00"
            });


            await batch.commit();
            console.log("Sample data successfully initialized!");
            showDashboardSection('home');
        }
    }

    // Call this function after the initial auth state is determined
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserId = user.uid;
            // The `onAuthStateChanged` handler in the main code handles fetching user data.
            // We just need to ensure our sample data initializer is called once.
            initializeSampleData();
        }
    });

    // Helper to run a batch write
    import { writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  </script>
</body>
</html>
