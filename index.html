<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('myschoolgate.png') no-repeat center center fixed;
      background-size: cover;
    }
    .gpa-circle-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 20px auto;
    }
    .gpa-circle-svg {
      transform: rotate(-90deg);
    }
    .gpa-circle-bg {
      stroke: #e0e0e0;
      stroke-width: 10;
      fill: none;
    }
    .gpa-circle-progress {
      stroke: #006400; /* University green */
      stroke-width: 10;
      fill: none;
      transition: stroke-dasharray 0.5s ease-in-out;
    }
    .gpa-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      font-weight: bold;
      color: #006400;
    }
    .fees-balance-text.red {
        color: #dc2626; /* Tailwind red-600 */
    }
    .fees-balance-text.green {
        color: #16a34a; /* Tailwind green-600 */
    }
    /* Hide scrollbar for announcements panel, but allow scrolling */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    /* Rotate chevron */
    .rotate-180 {
        transform: rotate(180deg);
    }

    /* New CSS for spacing and cards */
    .container {
        padding: 10px; /* Reduced padding for smaller screens */
    }
    /* Adjust main padding and gap on larger screens */
    @media (min-width: 1024px) { /* Equivalent to Tailwind's lg breakpoint */
        .main {
            padding: 20px;
            gap: 20px;
        }
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* Reduce sidebar width */
    #sidebar {
      width: 220px; /* Adjusted from 256px */
    }
    /* Adjust main content margin to account for new sidebar width */
    @media (min-width: 1024px) {
        #dashboardContent {
            margin-left: 220px; /* Adjusted from 256px */
        }
    }
  </style>
</head>
<body class="h-screen flex items-center justify-center">
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
    <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-300">
      <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
      <p id="modalMessage" class="mb-6 text-gray-700"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
        <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
      </div>
    </div>
  </div>

  <div id="authContainer" class="p-4 w-full h-full flex justify-center items-center">
    <div id="login-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5 active">
      <form id="login-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Login</h2>
        <div class="mb-6 text-left">
          <label for="email-login" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-login" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-login" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-login" placeholder="Enter your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="login-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Login</button>
        <div class="mt-6 text-sm flex justify-center space-x-4">
          <a href="#" onclick="showForm('signup')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Don't have an account? Sign Up</a>
          <a href="#" onclick="showForm('forgot-password')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Forgot Password?</a>
        </div>
      </form>
    </div>

    <div id="signup-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="signup-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Sign Up</h2>
        <div class="mb-6 text-left">
          <label for="full-name-signup" class="block text-gray-700 text-sm font-medium mb-2">Full Name</label>
          <input type="text" id="full-name-signup" placeholder="Enter your full name" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
        </div>
        <div class="mb-6 text-left">
          <label for="email-signup" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-signup" placeholder="Enter your email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-signup" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-signup" placeholder="Create a password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="confirm-password-signup" class="block text-gray-700 text-sm font-medium mb-2">Confirm Password</label>
          <input type="password" id="confirm-password-signup" placeholder="Confirm your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="confirm-password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="signup-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Sign Up</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Already have an account? Login</a>
        </div>
      </form>
    </div>

    <div id="forgot-password-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="forgot-password-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Forgot Password</h2>
        <div class="mb-6 text-left">
          <label for="email-forgot" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-forgot" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-forgot-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="recover-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Recover Password</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Back to Login</a>
        </div>
      </form>
    </div>
  </div>

  <div id="dashboardContainer" class="hidden h-screen flex flex-col bg-gray-100 w-full">
    <header class="bg-white text-green-800 p-4 flex justify-between items-center shadow-md sticky top-0 z-10 lg:px-8">
      <img src="myschoollogo.png" alt="University Logo" class="h-12 w-auto">
      <button id="menuToggle" class="lg:hidden text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
        <i class="fas fa-bars"></i>
      </button>
      <div class="hidden lg:flex items-center space-x-4">
        <span class="text-lg font-semibold text-green-700">Welcome, <span id="userName" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
       <div class="lg:hidden flex items-center space-x-4">
        <span class="text-md font-semibold text-green-700">Welcome, <span id="userNameMobile" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <div class="flex flex-grow">
      <nav id="sidebar" class="w-64 bg-green-900 text-white p-6 flex flex-col space-y-2 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20 fixed inset-y-0 left-0 lg:relative lg:flex-shrink-0 lg:h-auto overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Quick Menu</h3>
        <a onclick="showDashboardSection('home')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i> Home</a>
        <a onclick="showDashboardSection('profile')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user mr-3"></i> Personal Profile</a>

        <a onclick="toggleSubmenu('academics-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-book mr-3"></i> Academics <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="academics-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('courseReg')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-alt mr-3"></i> Course Registration</a>
          <a onclick="showDashboardSection('courses')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-list-alt mr-3"></i> Available Courses</a>
          <a onclick="showDashboardSection('timetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-calendar-alt mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-list mr-3"></i> Grades & Transcripts</a>
          <a onclick="showDashboardSection('graduation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-graduation-cap mr-3"></i> Graduation Request</a>
          <a onclick="showDashboardSection('clearance')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-check-circle mr-3"></i> Clearance Request</a>
        </div>

        <a onclick="toggleSubmenu('finance-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-money-bill-wave mr-3"></i> Finance <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="finance-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('fees')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-credit-card mr-3"></i> Fees Statement</a>
          <a onclick="showDashboardSection('receipts')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-receipt mr-3"></i> Receipts</a>
          <a onclick="showDashboardSection('examCard')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-id-card mr-3"></i> Exam Card</a>
        </div>

        <a onclick="toggleSubmenu('exam-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-laptop-code mr-3"></i> Examination <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="exam-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('examTimetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clock mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-invoice mr-3"></i> Transcripts</a>
        </div>
        <a onclick="showDashboardSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-hotel mr-3"></i> Accommodation</a>
        <a onclick="showDashboardSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i> Announcements</a>
        <a onclick="showDashboardSection('settings')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-cog mr-3"></i> Settings</a>
      </nav>

      <main id="dashboardContent" class="flex-grow p-6 overflow-y-auto lg:ml-64 w-full">
        </main>
    </div>

    <footer class="bg-white text-gray-600 text-center p-4 text-sm shadow-inner mt-auto">
      2025 © Prince Alex Design University. All rights reserved.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, arrayUnion, arrayRemove, addDoc, getDocs, deleteDoc, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Firebase Config: Replace with your actual Firebase project details
    const hardcodedFirebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A", // This is a placeholder. Ensure your actual Firebase API Key is used.
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId;
    const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    if (firebaseConfigFromCanvas) {
        app = initializeApp(firebaseConfigFromCanvas);
    } else {
        // Fallback for local development if __firebase_config is not defined
        app = initializeApp(hardcodedFirebaseConfig);
    }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let currentUserData = null;

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const authContainer = document.getElementById('authContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const sidebar = document.getElementById('sidebar');

    // --- Custom Modal Functions (replaces alert/confirm) ---
    function showCustomModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        if (modalTitle) modalTitle.innerText = title;
        if (modalMessage) modalMessage.innerText = message;

        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(true);
            };
        }
        if (modalCancelBtn) {
            modalCancelBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(false);
            };
            modalCancelBtn.classList.toggle('hidden', !isConfirm); // Toggle visibility based on isConfirm
        }
        if (modal) modal.classList.remove('hidden'); // Show modal
      });
    }

    window.alert = (message) => showCustomModal('Alert', message); // Override alert
    window.confirm = (message) => showCustomModal('Confirm', message, true); // Override confirm
    // --- End Custom Modal Functions ---

    // Function to set button loading state
    function setButtonLoading(button, isLoading) {
      if (button) {
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<i class="fas fa-spinner animate-spin mr-2"></i>Loading...' : button.dataset.originalHtml;
      }
    }

    // Function to store original button HTML for loading state
    function storeOriginalButtonHtml() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.dataset.originalHtml = button.innerHTML;
      });
    }

    // Inline form validation utility
    function validateInput(inputElement, validationFn, errorMessageElement) {
        if (validationFn(inputElement.value)) {
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-300', 'focus:ring-green-500');
            errorMessageElement.classList.add('hidden');
            return true;
        } else {
            inputElement.classList.remove('border-gray-300', 'focus:ring-green-500');
            inputElement.classList.add('border-red-500');
            errorMessageElement.innerText = `❌ ${errorMessageElement.dataset.errorMessage || 'Invalid input.'}`;
            errorMessageElement.classList.remove('hidden');
            return false;
        }
    }

    // Email validation regex (basic)
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    // Password validation regex (at least 6 characters)
    const isValidPassword = (password) => password.length >= 6;


    // Function to show specific authentication form and hide others
    window.showForm = function(formId) {
      const forms = document.querySelectorAll('.form-wrapper');
      forms.forEach(form => {
        form.classList.remove('active');
        form.classList.add('opacity-0', 'invisible', 'translate-y-5');
      });
      const activeForm = document.getElementById(`${formId}-form-wrapper`);
      if (activeForm) {
        activeForm.classList.remove('opacity-0', 'invisible', 'translate-y-5');
        activeForm.classList.add('active');
        // Autofocus the first input in the new form
        const firstInput = activeForm.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      }
    };

    // This function runs once the DOM is fully loaded and before onAuthStateChanged fires its initial state.
    async function initializeAppUI() {
        storeOriginalButtonHtml(); // Store original button HTML for loading states
        loadingText.innerText = "Initializing session...";
        loadingOverlay.classList.remove('hidden');

        // Attach inline validation listeners
        attachFormValidationListeners();

        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                await signInAnonymously(auth);
                console.log("Signed in anonymously due to custom token failure.");
            }
        } else {
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                await showCustomModal("Error", "Failed to initialize anonymous session. Please refresh.");
            }
        }
    }

    window.onload = initializeAppUI;

    // --- Authentication Forms Event Listeners ---
    document.getElementById('login-form').addEventListener('submit', loginUser);
    document.getElementById('signup-form').addEventListener('submit', signupUser);
    document.getElementById('forgot-password-form').addEventListener('submit', recoverPassword);

    function attachFormValidationListeners() {
        // Login form
        const emailLogin = document.getElementById('email-login');
        const emailLoginError = document.getElementById('email-login-error');
        if (emailLogin) {
            emailLoginError.dataset.errorMessage = "Please enter a valid email address.";
            emailLogin.addEventListener('input', () => validateInput(emailLogin, isValidEmail, emailLoginError));
        }
        const passwordLogin = document.getElementById('password-login');
        const passwordLoginError = document.getElementById('password-login-error');
        if (passwordLogin) {
            passwordLoginError.dataset.errorMessage = "Password must be at least 6 characters.";
            passwordLogin.addEventListener('input', () => validateInput(passwordLogin, isValidPassword, passwordLoginError));
        }

        // Signup form
        const emailSignup = document.getElementById('email-signup');
        const emailSignupError = document.getElementById('email-signup-error');
        if (emailSignup) {
            emailSignupError.dataset.errorMessage = "Please enter a valid email address.";
            emailSignup.addEventListener('input', () => validateInput(emailSignup, isValidEmail, emailSignupError));
        }
        const passwordSignup = document.getElementById('password-signup');
        const passwordSignupError = document.getElementById('password-signup-error');
        if (passwordSignup) {
            passwordSignupError.dataset.errorMessage = "Password must be at least 6 characters long.";
            passwordSignup.addEventListener('input', () => validateInput(passwordSignup, isValidPassword, passwordSignupError));
        }
        const confirmPasswordSignup = document.getElementById('confirm-password-signup');
        const confirmPasswordSignupError = document.getElementById('confirm-password-signup-error');
        if (confirmPasswordSignup) {
            confirmPasswordSignupError.dataset.errorMessage = "Passwords do not match.";
            confirmPasswordSignup.addEventListener('input', () => {
                const match = passwordSignup.value === confirmPasswordSignup.value;
                validateInput(confirmPasswordSignup, () => match, confirmPasswordSignupError);
            });
        }

        // Forgot password form
        const emailForgot = document.getElementById('email-forgot');
        const emailForgotError = document.getElementById('email-forgot-error');
        if (emailForgot) {
            emailForgotError.dataset.errorMessage = "Please enter a valid email address.";
            emailForgot.addEventListener('input', () => validateInput(emailForgot, isValidEmail, emailForgotError));
        }
    }


    // --- Authentication Flow ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("User authenticated (from onAuthStateChanged):", user.email, user.uid);

        // Fetch or create user data from Firestore
        const profileDocRef = doc(db, `students`, currentUserId);
        const profileDocSnap = await getDoc(profileDocRef);

        if (profileDocSnap.exists()) {
          currentUserData = profileDocSnap.data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
        } else {
          await setDoc(profileDocRef, {
            email: user.email,
            name: user.email.split("@")[0],
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
          });
          currentUserData = (await getDoc(profileDocRef)).data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          console.log("Created basic user profile during dashboard load fallback.");
        }

        authContainer.classList.add('hidden');
        dashboardContainer.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');

        if (currentUserData.regNo === 'N/A' || currentUserData.programme === 'N/A' || currentUserData.dob === 'N/A' || currentUserData.gender === 'N/A') {
            await showCustomModal("Welcome", "Please complete your profile information.");
            showDashboardSection('profile');
        } else {
            showDashboardSection('home');
        }

      } else {
        authContainer.classList.remove('hidden');
        dashboardContainer.classList.add('hidden');
        loadingOverlay.classList.add('hidden');
        showForm('login');
      }
    });

    // Function to log in user
    async function loginUser(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('login-btn');
      const emailInput = document.getElementById("email-login");
      const passwordInput = document.getElementById("password-login");
      const emailError = document.getElementById('email-login-error');
      const passwordError = document.getElementById('password-login-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);

      if (!isEmailValid || !isPasswordValid) {
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(loginBtn, true);

      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        await showCustomModal("Login Success", "✅ Login successful! Redirecting...");
      } catch (error) {
        let errorMessage = "❌ Login failed.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = "❌ Invalid email or password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "❌ Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Login Failed", errorMessage);
        console.error("Login error:", error);
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }

    // Function to sign up new user
    async function signupUser(event) {
      event.preventDefault();
      const signupBtn = document.getElementById('signup-btn');
      const fullNameInput = document.getElementById("full-name-signup");
      const emailInput = document.getElementById("email-signup");
      const passwordInput = document.getElementById("password-signup");
      const confirmPasswordInput = document.getElementById("confirm-password-signup");

      const emailError = document.getElementById('email-signup-error');
      const passwordError = document.getElementById('password-signup-error');
      const confirmPasswordError = document.getElementById('confirm-password-signup-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);
      const passwordsMatch = (passwordInput.value === confirmPasswordInput.value);
      const isConfirmPasswordValid = validateInput(confirmPasswordInput, () => passwordsMatch, confirmPasswordError);

      if (!isEmailValid || !isPasswordValid || !isConfirmPasswordValid || !passwordsMatch) {
          if (!passwordsMatch) {
              confirmPasswordError.innerText = "❌ Passwords do not match!";
              confirmPasswordError.classList.remove('hidden');
              confirmPasswordInput.classList.add('border-red-500');
          }
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(signupBtn, true);

      const fullName = fullNameInput.value.trim();
      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const userDocRef = doc(db, `students`, user.uid);
        await setDoc(userDocRef, {
            email: user.email,
            name: fullName,
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
        });
        console.log("User signed up and profile created:", user.email);

        await showCustomModal("Signup Success", "✅ Signup successful! Please log in with your new account.");

        showForm('login');

      } catch (error) {
        let errorMessage = "❌ Signup failed.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "❌ Email already in use. Try logging in or recovering password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Invalid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "❌ Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Signup Failed", errorMessage);
        console.error("Signup error:", error);
      } finally {
        setButtonLoading(signupBtn, false);
      }
    }

    // Function to recover password
    async function recoverPassword(event) {
      event.preventDefault();
      const recoverBtn = document.getElementById('recover-btn');
      const emailInput = document.getElementById("email-forgot");
      const emailError = document.getElementById('email-forgot-error');
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      if (!isEmailValid) {
        await showCustomModal("Validation Error", "Please enter a valid email address.");
        return;
      }

      setButtonLoading(recoverBtn, true);

      const email = emailInput.value.trim().toLowerCase();

      try {
        await sendPasswordResetEmail(auth, email);
        await showCustomModal("Password Recovery", "✅ Password reset email sent! Check your inbox.");
      } catch (error) {
        let errorMessage = "❌ Failed to send password reset email.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "❌ No account found with that email.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Password Recovery Failed", errorMessage);
        console.error("Password recovery error:", error);
      } finally {
        setButtonLoading(recoverBtn, false);
      }
    }

    // --- Dashboard Specific Functions ---

    // Logout function
    window.confirmLogout = async function() {
      const response = await confirm("Are you sure you want to log out?");
      if (response) {
        try {
          loadingText.innerText = "Logging out...";
          loadingOverlay.classList.remove('hidden');
          await signOut(auth);
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error logging out. Please try again.");
          loadingOverlay.classList.add('hidden');
        }
      }
    };

    window.toggleSubmenu = function(id) {
      const submenu = document.getElementById(id);
      if (submenu) submenu.classList.toggle('hidden');
      const chevron = submenu.previousElementSibling.querySelector('.fa-chevron-down');
      if (chevron) {
        chevron.classList.toggle('rotate-180');
      }
    };

    document.getElementById('menuToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.toggle('-translate-x-full');
    });

    function generateBreadcrumb(currentSectionTitle) {
      return `<div class="text-sm text-gray-600 mb-6">
        <a onclick="showDashboardSection('home')" class="text-green-700 hover:underline cursor-pointer">Home</a>
        <span class="mx-2">/</span>
        <span class="font-semibold text-green-800">${currentSectionTitle}</span>
      </div>`;
    }

    function showLoading(text) {
      loadingText.innerText = text;
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // --- GPA Calculation Utility ---
    function calculateGPA(grades) {
      let totalPoints = 0;
      let totalUnits = 0;
      const gradeMap = {
        'A': 4.0,
        'B': 3.0,
        'C': 2.0,
        'D': 1.0,
        'F': 0.0
      };
      grades.forEach(g => {
        const courseUnit = g.courseUnit || 3;
        const gradePoint = gradeMap[g.grade] || 0;
        totalPoints += gradePoint * courseUnit;
        totalUnits += courseUnit;
      });
      return totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : "0.00";
    }

    // --- Section-Specific Loaders ---

    // 1. Home Dashboard
    async function loadHome() {
      showLoading("Loading dashboard summary...");
      const announcementsRef = collection(db, `announcements`);
      const gradesRef = collection(db, `grades`);
      const feesRef = collection(db, `fees`);
      const registrationsRef = doc(db, `registrations`, currentUserId);
      const content = document.getElementById("dashboardContent");

      // Default values for dashboard data
      let studentName = "Student";
      let studentProgramme = "Programme Not Set";
      let studentRegNo = "Registration Number Not Set";
      let profilePhotoURL = 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';
      let gpa = "0.00";
      let latestGradeHtml = '';
      let balance = 0;
      let totalFees = 0;
      let totalPayments = 0;
      let upcomingDeadline = "No upcoming deadlines.";
      let registrationLink = `<button onclick="showDashboardSection('courseReg')" class="text-green-700 hover:underline">Register for Courses</button>`;
      let announcementsHtml = `<p class="text-gray-600 text-center py-4">No new announcements at this time.</p>`;

      try {
        // Fetch student profile
        const profileDocRef = doc(db, `students`, currentUserId);
        const profileSnap = await getDoc(profileDocRef);
        if (profileSnap.exists()) {
          const studentData = profileSnap.data();
          studentName = studentData.name || "Student";
          studentProgramme = studentData.programme && studentData.programme !== 'N/A' ? studentData.programme : "Programme Not Set";
          studentRegNo = studentData.regNo && studentData.regNo !== 'N/A' ? studentData.regNo : "Registration Number Not Set";
          profilePhotoURL = studentData.profilePhotoURL || profilePhotoURL;
        }

        // Fetch latest 3 announcements
        const announcementsQuery = query(announcementsRef, orderBy("date", "desc"), limit(3));
        const announcementsSnapshot = await getDocs(announcementsQuery);
        if (!announcementsSnapshot.empty) {
            const announcements = announcementsSnapshot.docs.map(doc => doc.data());
            announcementsHtml = `<ul class="space-y-3">${announcements.map(ann => `
              <li class="pb-2 border-b border-green-100 last:border-b-0">
                <p class="text-sm text-gray-500">${new Date(ann.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p class="font-medium text-green-800">${ann.title}</p>
                <p class="text-gray-700">${ann.message}</p>
              </li>
            `).join('')}</ul>`;
        }

        // Fetch fees data
        const feesDocRef = doc(db, feesRef, currentUserId);
        const feesSnapshot = await getDoc(feesDocRef);
        if (feesSnapshot.exists()) {
            const feesData = feesSnapshot.data();
            totalFees = feesData.totalFees || 0;
            totalPayments = (feesData.payments || []).reduce((sum, p) => sum + p.amount, 0);
            balance = totalFees - totalPayments;
        }

        // Fetch grades
        const gradesQuery = query(gradesRef, where("studentId", "==", currentUserId));
        const gradesSnapshot = await getDocs(gradesQuery);
        if (!gradesSnapshot.empty) {
            const grades = gradesSnapshot.docs.map(doc => doc.data());
            gpa = calculateGPA(grades);
            const latestGrade = grades.length > 0 ? grades.sort((a,b) => new Date(b.date) - new Date(a.date))[0] : null;
            latestGradeHtml = latestGrade ? `Your latest grade is a **${latestGrade.grade}** in **${latestGrade.courseCode}**. ` : '';
        }

        // Fetch registrations to find upcoming deadlines
        const registrationsSnap = await getDoc(registrationsRef);
        if (registrationsSnap.exists()) {
            const registrationsData = registrationsSnap.data().courses || [];
            const now = new Date();
            const futureDeadlines = registrationsData.filter(reg => new Date(reg.registrationDeadline) > now);

            if (futureDeadlines.length > 0) {
              futureDeadlines.sort((a,b) => new Date(a.registrationDeadline) - new Date(b.registrationDeadline));
              const nextDeadline = futureDeadlines[0];
              upcomingDeadline = `${nextDeadline.courseName} Registration Deadline: ${new Date(nextDeadline.registrationDeadline).toLocaleDateString()}`;
              registrationLink = `<a href="#" onclick="showDashboardSection('courseReg')" class="text-blue-500 hover:underline">View Registrations</a>`;
            }
        }

        const balanceColorClass = balance > 0 ? 'text-red-600' : 'text-green-600';
        const balanceText = `GHS ${balance.toFixed(2)}`;
        const gpaColor = gpa !== "0.00" ? '#006400' : '#888888';
        const gpaProgress = parseFloat(gpa) > 0 ? (parseFloat(gpa) / 4 * 314) : 0;

        const homeContentHtml = `
          <div class="bg-green-100 p-6 rounded-xl shadow-lg flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6 mb-8">
            <img src="${profilePhotoURL}" alt="Profile Photo" class="w-20 h-20 rounded-full border-4 border-white shadow-md">
            <div class="text-center md:text-left">
              <h2 class="text-2xl font-bold text-green-800">Welcome back, ${studentName}!</h2>
              <p class="text-gray-600">${studentProgramme} | ${studentRegNo}</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
              <h3 class="text-lg font-bold text-green-800 mb-2">My GPA</h3>
              <div class="gpa-circle-container">
                <svg viewBox="0 0 120 120" class="gpa-circle-svg w-full h-full">
                  <circle cx="60" cy="60" r="50" class="gpa-circle-bg"></circle>
                  <circle cx="60" cy="60" r="50" class="gpa-circle-progress" style="stroke-dasharray: ${gpaProgress}, 314.159; stroke: ${gpaColor};"></circle>
                </svg>
                <div class="gpa-text">${gpa}</div>
              </div>
              <p class="text-center text-gray-700">${latestGradeHtml} <a onclick="showDashboardSection('grades')" class="text-blue-500 hover:underline">View All Grades</a></p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
              <h3 class="text-lg font-bold text-green-800 mb-2">Fees Balance</h3>
              <p class="text-4xl font-extrabold ${balanceColorClass} mt-4">${balanceText}</p>
              <p class="text-gray-700 mt-4">Outstanding balance: <span class="font-semibold">${balanceText}</span></p>
              <div class="mt-4">
                <button onclick="showDashboardSection('fees')" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">View Statement</button>
              </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
              <h3 class="text-lg font-bold text-green-800 mb-2">Upcoming Deadlines</h3>
              <div class="space-y-4 mt-4">
                <p class="text-gray-700"><strong>${upcomingDeadline}</strong></p>
                <div class="flex flex-col space-y-2">
                  <p class="text-gray-700">Academic Calendar: ${new Date().getFullYear()}/${new Date().getFullYear() + 1}</p>
                  <a href="#" onclick="showDashboardSection('timetable')" class="text-blue-500 hover:underline">View Exam Timetable</a>
                  ${registrationLink}
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
            <h3 class="text-lg font-bold text-green-800 mb-4">Latest Announcements</h3>
            <div class="no-scrollbar overflow-y-auto max-h-64">
              ${announcementsHtml}
            </div>
          </div>
        `;
        content.innerHTML = generateBreadcrumb("Dashboard") + homeContentHtml;
      } catch (error) {
        // Log the error but don't stop rendering the basic structure
        console.error("Error fetching some dashboard data:", error);
        // The HTML structure with default/placeholder values will still be rendered
      }
      hideLoading();
    }

    // 2. Profile
    async function loadProfile() {
      showLoading("Loading personal profile...");
      const content = document.getElementById("dashboardContent");
      const profileDocRef = doc(db, `students`, currentUserId);
      try {
        const docSnap = await getDoc(profileDocRef);
        const data = docSnap.exists() ? docSnap.data() : {};
        const profileContentHtml = `
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
            <h3 class="text-2xl font-bold text-green-800 mb-4">Personal Profile</h3>
            <div class="flex flex-col md:flex-row items-center md:space-x-6 space-y-4 md:space-y-0 pb-6 border-b border-gray-200 mb-6">
                <div class="relative w-28 h-28 group">
                    <img id="profilePhoto" src="${data.profilePhotoURL || 'https://placehold.co/120x120/eeeeee/333333?text=Avatar'}" alt="Profile Photo" class="rounded-full w-full h-full object-cover border-4 border-white shadow-lg transition-transform duration-300 ease-in-out group-hover:scale-105">
                    <div class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex justify-center items-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer">
                        <i class="fas fa-camera text-white text-2xl"></i>
                    </div>
                    <input type="file" id="photoUpload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*">
                </div>
                <div class="text-center md:text-left flex-grow">
                    <h4 class="text-2xl font-bold text-gray-800" id="profileName">${data.name || 'N/A'}</h4>
                    <p class="text-gray-600" id="profileRegNo">${data.regNo || 'N/A'}</p>
                    <p class="text-gray-600" id="profileProgramme">${data.programme || 'N/A'}</p>
                </div>
            </div>
            <form id="profile-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col">
                        <label for="name" class="text-gray-600 font-medium mb-1">Full Name</label>
                        <input type="text" id="name" name="name" value="${data.name || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="email" class="text-gray-600 font-medium mb-1">Email</label>
                        <input type="email" id="email" name="email" value="${data.email || ''}" disabled class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed">
                    </div>
                    <div class="flex flex-col">
                        <label for="regNo" class="text-gray-600 font-medium mb-1">Registration Number</label>
                        <input type="text" id="regNo" name="regNo" value="${data.regNo || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="programme" class="text-gray-600 font-medium mb-1">Programme</label>
                        <input type="text" id="programme" name="programme" value="${data.programme || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="campus" class="text-gray-600 font-medium mb-1">Campus</label>
                        <input type="text" id="campus" name="campus" value="${data.campus || 'Main Campus'}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="dob" class="text-gray-600 font-medium mb-1">Date of Birth</label>
                        <input type="date" id="dob" name="dob" value="${data.dob || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="gender" class="text-gray-600 font-medium mb-1">Gender</label>
                        <select id="gender" name="gender" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">Select Gender</option>
                            <option value="Male" ${data.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${data.gender === 'Female' ? 'selected' : ''}>Female</option>
                            <option value="Other" ${data.gender === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="address" class="text-gray-600 font-medium mb-1">Address</label>
                        <textarea id="address" name="address" rows="3" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">${data.address || ''}</textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" id="updateProfileBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Update Profile</button>
                </div>
            </form>
          </div>
        `;
        content.innerHTML = generateBreadcrumb("Personal Profile") + profileContentHtml;
        document.getElementById('profile-form').addEventListener('submit', updateProfile);
        document.getElementById('photoUpload').addEventListener('change', uploadProfilePhoto);

      } catch (error) {
        console.error("Error loading profile:", error);
        content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load profile. Please try again later.</div>`;
      }
      hideLoading();
    }

    // Update Profile function
    async function updateProfile(event) {
        event.preventDefault();
        const updateBtn = document.getElementById('updateProfileBtn');
        setButtonLoading(updateBtn, true);

        const form = event.target;
        const formData = new FormData(form);
        const profileData = Object.fromEntries(formData.entries());
        const profileDocRef = doc(db, `students`, currentUserId);

        try {
            await updateDoc(profileDocRef, profileData);
            currentUserData = profileData; // Update local state
            // Update UI
            document.getElementById('profileName').innerText = profileData.name || 'N/A';
            document.getElementById('profileRegNo').innerText = profileData.regNo || 'N/A';
            document.getElementById('profileProgramme').innerText = profileData.programme || 'N/A';
            document.getElementById("userName").innerText = profileData.name ? profileData.name.split(" ")[0] : "User";
            const userNameMobile = document.getElementById("userNameMobile");
            if (userNameMobile) userNameMobile.innerText = profileData.name ? profileData.name.split(" ")[0] : "User";

            await showCustomModal("Profile Updated", "Your profile has been successfully updated.");
            console.log("Profile updated successfully.");
        } catch (error) {
            console.error("Error updating profile:", error);
            await showCustomModal("Update Failed", "Failed to update profile. Please try again.");
        } finally {
            setButtonLoading(updateBtn, false);
        }
    }

    // Upload Profile Photo function
    async function uploadProfilePhoto(event) {
        const file = event.target.files[0];
        if (!file) return;
        const photoUploadBtn = event.target;

        const confirmUpload = await confirm("Are you sure you want to upload this photo?");
        if (!confirmUpload) {
          event.target.value = null; // Clear the file input
          return;
        }

        const profilePhoto = document.getElementById('profilePhoto');
        const loadingText = "Uploading photo...";
        showLoading(loadingText);

        const storageRef = ref(storage, `profilePhotos/${currentUserId}/${file.name}`);
        try {
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);

            const profileDocRef = doc(db, `students`, currentUserId);
            await updateDoc(profileDocRef, {
                profilePhotoURL: downloadURL
            });
            currentUserData.profilePhotoURL = downloadURL; // Update local state
            profilePhoto.src = downloadURL;
            await showCustomModal("Photo Uploaded", "Profile photo uploaded successfully!");
            console.log("Photo uploaded and profile updated with new URL.");
        } catch (error) {
            console.error("Error uploading photo:", error);
            await showCustomModal("Upload Failed", "Failed to upload photo. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 3. Course Registration
    async function loadCourseReg() {
      showLoading("Loading course registration...");
      const content = document.getElementById("dashboardContent");
      const registrationsDocRef = doc(db, `registrations`, currentUserId);
      const coursesCollectionRef = collection(db, `courses`);
      const registeredCoursesCollectionRef = collection(db, `students`, currentUserId, `registeredCourses`);

      try {
        const registrationsSnap = await getDoc(registrationsDocRef);
        const registeredCourseIds = registrationsSnap.exists() ? registrationsSnap.data().courseIds : [];
        const availableCoursesSnapshot = await getDocs(coursesCollectionRef);
        const availableCourses = availableCoursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const semesterOptions = [...new Set(availableCourses.map(c => c.semester))].sort();

        let semestersHtml = '';
        if (semesterOptions.length > 0) {
            for (const semester of semesterOptions) {
                const coursesInSemester = availableCourses.filter(c => c.semester === semester);
                const registeredInSemester = coursesInSemester.filter(c => registeredCourseIds.includes(c.id));
                const notRegisteredInSemester = coursesInSemester.filter(c => !registeredCourseIds.includes(c.id));
                const totalUnits = registeredInSemester.reduce((sum, course) => sum + (course.courseUnit || 3), 0);

                let registeredTableHtml = '';
                if (registeredInSemester.length > 0) {
                    registeredTableHtml = `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-green-700 mb-2">Registered Courses</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-sm">
                                <thead class="bg-green-100 text-green-800">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                                        <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                                        <th class="py-3 px-4 text-left font-semibold">Units</th>
                                        <th class="py-3 px-4 text-left font-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${registeredInSemester.map(course => `
                                        <tr>
                                            <td class="py-3 px-4 border-b border-gray-200">${course.courseCode}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${course.courseName}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${course.courseUnit || 3}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">
                                                <button onclick="deregisterCourse('${course.id}')" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-md text-sm transition-colors duration-200">Deregister</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <p class="text-right text-gray-700 mt-2 font-medium">Total Units: ${totalUnits}</p>
                    </div>`;
                }

                let availableTableHtml = '';
                if (notRegisteredInSemester.length > 0) {
                    availableTableHtml = `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-green-700 mb-2">Available Courses to Register</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-sm">
                                <thead class="bg-green-100 text-green-800">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                                        <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                                        <th class="py-3 px-4 text-left font-semibold">Units</th>
                                        <th class="py-3 px-4 text-left font-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${notRegisteredInSemester.map(course => `
                                        <tr>
                                            <td class="py-3 px-4 border-b border-gray-200">${course.courseCode}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${course.courseName}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${course.courseUnit || 3}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">
                                                <button onclick="registerCourse('${course.id}')" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-md text-sm transition-colors duration-200">Register</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                }

                semestersHtml += `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">${semester}</h3>
                    ${registeredTableHtml}
                    ${availableTableHtml}
                </div>`;
            }
        } else {
            semestersHtml = `<p class="text-gray-600 text-center py-4">No courses available for registration at this time.</p>`;
        }


        const courseRegContentHtml = `
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
            <h3 class="text-2xl font-bold text-green-800 mb-4">Course Registration</h3>
            <p class="text-gray-700 mb-6">Register for your courses here. You can also view and deregister from your currently registered courses.</p>
          </div>
          <div class="mt-6">
            ${semestersHtml}
          </div>
        `;
        content.innerHTML = generateBreadcrumb("Course Registration") + courseRegContentHtml;
      } catch (error) {
        console.error("Error loading course registration:", error);
        content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load course registration. Please try again later.</div>`;
      }
      hideLoading();
    }

    window.registerCourse = async function(courseId) {
        const confirmReg = await confirm("Are you sure you want to register for this course?");
        if (!confirmReg) return;

        showLoading("Registering for course...");
        const registrationsDocRef = doc(db, `registrations`, currentUserId);
        const registeredCoursesCollectionRef = collection(db, `students`, currentUserId, `registeredCourses`);

        try {
            const courseDocRef = doc(db, `courses`, courseId);
            const courseDocSnap = await getDoc(courseDocRef);
            if (!courseDocSnap.exists()) {
                throw new Error("Course not found.");
            }
            const courseData = courseDocSnap.data();

            // Add the course ID to the main registrations document
            await updateDoc(registrationsDocRef, {
                courseIds: arrayUnion(courseId)
            }, { merge: true });

            // Also add the full course details to the student's subcollection
            await setDoc(doc(registeredCoursesCollectionRef, courseId), {
                ...courseData,
                registrationDate: new Date().toISOString()
            });

            await showCustomModal("Registration Success", "✅ Course registered successfully!");
            loadCourseReg(); // Reload the section to update UI
        } catch (error) {
            console.error("Error registering for course:", error);
            await showCustomModal("Registration Failed", "Failed to register for course. Please try again.");
            hideLoading();
        }
    };

    window.deregisterCourse = async function(courseId) {
        const confirmDereg = await confirm("Are you sure you want to deregister from this course?");
        if (!confirmDereg) return;

        showLoading("Deregistering from course...");
        const registrationsDocRef = doc(db, `registrations`, currentUserId);
        const registeredCoursesCollectionRef = collection(db, `students`, currentUserId, `registeredCourses`);

        try {
            // Remove the course ID from the main registrations document
            await updateDoc(registrationsDocRef, {
                courseIds: arrayRemove(courseId)
            });

            // Delete the course document from the student's subcollection
            await deleteDoc(doc(registeredCoursesCollectionRef, courseId));

            await showCustomModal("Deregistration Success", "✅ Course deregistered successfully!");
            loadCourseReg(); // Reload the section to update UI
        } catch (error) {
            console.error("Error deregistering from course:", error);
            await showCustomModal("Deregistration Failed", "Failed to deregister from course. Please try again.");
            hideLoading();
        }
    };

    // 4. Available Courses
    async function loadCourses() {
      showLoading("Loading available courses...");
      const content = document.getElementById("dashboardContent");
      const coursesCollectionRef = collection(db, `courses`);
      try {
        const coursesSnapshot = await getDocs(coursesCollectionRef);
        const courses = coursesSnapshot.docs.map(doc => doc.data());

        const coursesByProgramme = courses.reduce((acc, course) => {
            if (!acc[course.programme]) {
                acc[course.programme] = [];
            }
            acc[course.programme].push(course);
            return acc;
        }, {});

        let coursesHtml = Object.entries(coursesByProgramme).map(([programme, courseList]) => `
          <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
            <h3 class="text-2xl font-bold text-green-800 mb-4">${programme}</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white">
                <thead class="bg-green-100 text-green-800">
                  <tr>
                    <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                    <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                    <th class="py-3 px-4 text-left font-semibold">Units</th>
                    <th class="py-3 px-4 text-left font-semibold">Semester</th>
                  </tr>
                </thead>
                <tbody>
                  ${courseList.map(course => `
                    <tr>
                      <td class="py-3 px-4 border-b border-gray-200">${course.courseCode}</td>
                      <td class="py-3 px-4 border-b border-gray-200">${course.courseName}</td>
                      <td class="py-3 px-4 border-b border-gray-200">${course.courseUnit || 3}</td>
                      <td class="py-3 px-4 border-b border-gray-200">${course.semester}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `).join('');

        const coursesContentHtml = `
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
            <h3 class="text-2xl font-bold text-green-800 mb-4">Available Courses</h3>
            <p class="text-gray-700">Browse the list of all available courses across different academic programmes.</p>
          </div>
          ${coursesHtml}
        `;
        content.innerHTML = generateBreadcrumb("Available Courses") + coursesContentHtml;
      } catch (error) {
        console.error("Error loading courses:", error);
        content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load courses. Please try again later.</div>`;
      }
      hideLoading();
    }

    // 5. Timetable
    async function loadTimetable() {
      showLoading("Loading timetable...");
      const content = document.getElementById("dashboardContent");
      const timetablesCollectionRef = collection(db, `timetables`);
      try {
        const timetablesSnapshot = await getDocs(timetablesCollectionRef);
        const timetables = timetablesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        let timetableHtml = `<p class="text-gray-600 text-center py-4">No timetables available at this time.</p>`;
        if (timetables.length > 0) {
            timetableHtml = timetables.map(tt => `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">${tt.name}</h3>
                    <div class="flex items-center space-x-2 text-gray-700 mb-4">
                        <i class="fas fa-calendar-alt"></i>
                        <span>${tt.dateCreated ? new Date(tt.dateCreated).toLocaleDateString() : 'N/A'}</span>
                    </div>
                    ${tt.fileURL ? `<a href="${tt.fileURL}" target="_blank" class="inline-block bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg"><i class="fas fa-download mr-2"></i> Download Timetable</a>` : ''}
                </div>
            `).join('');
        }
        const timetableContentHtml = `
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
            <h3 class="text-2xl font-bold text-green-800 mb-4">Academic Timetable</h3>
            <p class="text-gray-700">Find and download academic and exam timetables here.</p>
          </div>
          <div class="mt-6">
            ${timetableHtml}
          </div>
        `;
        content.innerHTML = generateBreadcrumb("Timetable") + timetableContentHtml;
      } catch (error) {
        console.error("Error loading timetable:", error);
        content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load timetable. Please try again later.</div>`;
      }
      hideLoading();
    }

    // 6. Grades and Transcripts
    async function loadGrades() {
        showLoading("Loading grades and transcripts...");
        const content = document.getElementById("dashboardContent");
        const gradesCollectionRef = collection(db, `grades`);
        const transcriptsCollectionRef = collection(db, `transcripts`);

        try {
            // Fetch grades for the current user
            const gradesQuery = query(gradesCollectionRef, where("studentId", "==", currentUserId));
            const gradesSnapshot = await getDocs(gradesQuery);
            const grades = gradesSnapshot.docs.map(doc => doc.data());
            const gpa = calculateGPA(grades);

            const gradesBySemester = grades.reduce((acc, grade) => {
                if (!acc[grade.semester]) {
                    acc[grade.semester] = [];
                }
                acc[grade.semester].push(grade);
                return acc;
            }, {});

            let gradesHtml = '';
            if (Object.keys(gradesBySemester).length > 0) {
                gradesHtml = Object.entries(gradesBySemester).map(([semester, gradeList]) => `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">${semester}</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-green-100 text-green-800">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                                        <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                                        <th class="py-3 px-4 text-left font-semibold">Grade</th>
                                        <th class="py-3 px-4 text-left font-semibold">Units</th>
                                        <th class="py-3 px-4 text-left font-semibold">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${gradeList.map(grade => `
                                        <tr>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.courseCode}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.courseName}</td>
                                            <td class="py-3 px-4 border-b border-gray-200 font-bold">${grade.grade}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.courseUnit || 3}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${new Date(grade.date).toLocaleDateString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            } else {
                gradesHtml = `<p class="text-gray-600 text-center py-4">No grades found for you at this time.</p>`;
            }

            // Fetch transcripts
            const transcriptsQuery = query(transcriptsCollectionRef, where("studentId", "==", currentUserId), orderBy("date", "desc"));
            const transcriptsSnapshot = await getDocs(transcriptsQuery);
            const transcripts = transcriptsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let transcriptsHtml = `<p class="text-gray-600 text-center py-4">No transcripts available for download.</p>`;
            if (transcripts.length > 0) {
                transcriptsHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-6 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Official Transcripts</h4>
                        <div class="flex flex-col space-y-4">
                            ${transcripts.map(t => `
                                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-gray-800">Transcript on ${new Date(t.date).toLocaleDateString()}</p>
                                        <p class="text-sm text-gray-600">Issued: ${new Date(t.dateIssued).toLocaleDateString()}</p>
                                    </div>
                                    <a href="${t.fileURL}" target="_blank" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                                        <i class="fas fa-download mr-2"></i> Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            const gradesContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Grades & Transcripts</h3>
                    <p class="text-gray-700">View your grades per semester and download your official transcripts.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                        <h4 class="text-lg font-bold text-green-800 mb-2">Current GPA</h4>
                        <p class="text-4xl font-extrabold text-green-700">${gpa}</p>
                    </div>
                </div>
                ${gradesHtml}
                ${transcriptsHtml}
            `;
            content.innerHTML = generateBreadcrumb("Grades & Transcripts") + gradesContentHtml;
        } catch (error) {
            console.error("Error loading grades:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load grades. Please try again later.</div>`;
        }
        hideLoading();
    }

    // 7. Graduation Request
    async function loadGraduation() {
        showLoading("Loading graduation request form...");
        const content = document.getElementById("dashboardContent");
        const graduationRequestDocRef = doc(db, `graduationRequests`, currentUserId);
        try {
            const docSnap = await getDoc(graduationRequestDocRef);
            let graduationStatusHtml = '';
            let formHtml = '';

            if (docSnap.exists()) {
                const status = docSnap.data().status;
                const date = new Date(docSnap.data().dateRequested).toLocaleDateString();
                const statusColor = {
                    'Pending': 'bg-yellow-100 text-yellow-800',
                    'Approved': 'bg-green-100 text-green-800',
                    'Rejected': 'bg-red-100 text-red-800'
                }[status] || 'bg-gray-100 text-gray-800';

                graduationStatusHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Your Graduation Request Status</h4>
                        <div class="flex items-center justify-between p-4 rounded-lg ${statusColor}">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-info-circle text-2xl"></i>
                                <div>
                                    <p class="font-semibold">Status: ${status}</p>
                                    <p class="text-sm">Requested on: ${date}</p>
                                </div>
                            </div>
                            <button onclick="deleteGraduationRequest()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-200">Cancel Request</button>
                        </div>
                    </div>
                `;
            } else {
                formHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Request for Graduation</h4>
                        <form id="graduation-request-form">
                            <p class="text-gray-700 mb-4">Click the button below to submit your official request for graduation. Ensure all your academic and financial obligations are met before submitting.</p>
                            <button type="submit" id="submitGraduationBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Submit Graduation Request</button>
                        </form>
                    </div>
                `;
            }

            const graduationContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Graduation Request</h3>
                    <p class="text-gray-700">Submit your request to graduate and check the status of your application.</p>
                </div>
                ${graduationStatusHtml}
                ${formHtml}
            `;
            content.innerHTML = generateBreadcrumb("Graduation Request") + graduationContentHtml;
            if (!docSnap.exists()) {
                document.getElementById('graduation-request-form').addEventListener('submit', submitGraduationRequest);
            }
        } catch (error) {
            console.error("Error loading graduation request:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load graduation request. Please try again later.</div>`;
        }
        hideLoading();
    }

    async function submitGraduationRequest(event) {
        event.preventDefault();
        const confirmRequest = await confirm("Are you sure you want to submit your graduation request?");
        if (!confirmRequest) return;

        const submitBtn = document.getElementById('submitGraduationBtn');
        setButtonLoading(submitBtn, true);
        const graduationRequestDocRef = doc(db, `graduationRequests`, currentUserId);
        try {
            await setDoc(graduationRequestDocRef, {
                studentId: currentUserId,
                dateRequested: new Date().toISOString(),
                status: 'Pending'
            });
            await showCustomModal("Request Submitted", "✅ Your graduation request has been successfully submitted!");
            loadGraduation();
        } catch (error) {
            console.error("Error submitting graduation request:", error);
            await showCustomModal("Submission Failed", "Failed to submit request. Please try again.");
            hideLoading();
        }
    }

    async function deleteGraduationRequest() {
        const confirmDelete = await confirm("Are you sure you want to cancel your graduation request?");
        if (!confirmDelete) return;

        showLoading("Cancelling request...");
        const graduationRequestDocRef = doc(db, `graduationRequests`, currentUserId);
        try {
            await deleteDoc(graduationRequestDocRef);
            await showCustomModal("Request Cancelled", "✅ Your graduation request has been successfully cancelled.");
            loadGraduation();
        } catch (error) {
            console.error("Error deleting graduation request:", error);
            await showCustomModal("Cancellation Failed", "Failed to cancel request. Please try again.");
            hideLoading();
        }
    }

    // 8. Clearance Request
    async function loadClearance() {
        showLoading("Loading clearance request...");
        const content = document.getElementById("dashboardContent");
        const clearanceRequestDocRef = doc(db, `clearanceRequests`, currentUserId);
        try {
            const docSnap = await getDoc(clearanceDocRef);
            let clearanceStatusHtml = '';
            let formHtml = '';

            if (docSnap.exists()) {
                const status = docSnap.data().status;
                const date = new Date(docSnap.data().dateRequested).toLocaleDateString();
                const statusColor = {
                    'Pending': 'bg-yellow-100 text-yellow-800',
                    'Cleared': 'bg-green-100 text-green-800',
                    'Declined': 'bg-red-100 text-red-800'
                }[status] || 'bg-gray-100 text-gray-800';

                clearanceStatusHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Your Clearance Status</h4>
                        <div class="flex items-center justify-between p-4 rounded-lg ${statusColor}">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-info-circle text-2xl"></i>
                                <div>
                                    <p class="font-semibold">Status: ${status}</p>
                                    <p class="text-sm">Requested on: ${date}</p>
                                </div>
                            </div>
                            <button onclick="deleteClearanceRequest()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-200">Cancel Request</button>
                        </div>
                    </div>
                `;
            } else {
                formHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Request for Clearance</h4>
                        <form id="clearance-request-form">
                            <p class="text-gray-700 mb-4">To get officially cleared, please submit a request below. Your request will be reviewed by the finance and academic departments.</p>
                            <button type="submit" id="submitClearanceBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Submit Clearance Request</button>
                        </form>
                    </div>
                `;
            }

            const clearanceContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Clearance Request</h3>
                    <p class="text-gray-700">Submit your request to be cleared and view the status of your clearance.</p>
                </div>
                ${clearanceStatusHtml}
                ${formHtml}
            `;
            content.innerHTML = generateBreadcrumb("Clearance Request") + clearanceContentHtml;
            if (!docSnap.exists()) {
                document.getElementById('clearance-request-form').addEventListener('submit', submitClearanceRequest);
            }
        } catch (error) {
            console.error("Error loading clearance request:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load clearance request. Please try again later.</div>`;
        }
        hideLoading();
    }

    async function submitClearanceRequest(event) {
        event.preventDefault();
        const confirmRequest = await confirm("Are you sure you want to submit your clearance request?");
        if (!confirmRequest) return;

        const submitBtn = document.getElementById('submitClearanceBtn');
        setButtonLoading(submitBtn, true);
        const clearanceRequestDocRef = doc(db, `clearanceRequests`, currentUserId);
        try {
            await setDoc(clearanceRequestDocRef, {
                studentId: currentUserId,
                dateRequested: new Date().toISOString(),
                status: 'Pending'
            });
            await showCustomModal("Request Submitted", "✅ Your clearance request has been successfully submitted!");
            loadClearance();
        } catch (error) {
            console.error("Error submitting clearance request:", error);
            await showCustomModal("Submission Failed", "Failed to submit request. Please try again.");
            hideLoading();
        }
    }

    async function deleteClearanceRequest() {
        const confirmDelete = await confirm("Are you sure you want to cancel your clearance request?");
        if (!confirmDelete) return;

        showLoading("Cancelling request...");
        const clearanceRequestDocRef = doc(db, `clearanceRequests`, currentUserId);
        try {
            await deleteDoc(clearanceRequestDocRef);
            await showCustomModal("Request Cancelled", "✅ Your clearance request has been successfully cancelled.");
            loadClearance();
        } catch (error) {
            console.error("Error deleting clearance request:", error);
            await showCustomModal("Cancellation Failed", "Failed to cancel request. Please try again.");
            hideLoading();
        }
    }

    // 9. Fees Statement
    async function loadFees() {
        showLoading("Loading fees statement...");
        const content = document.getElementById("dashboardContent");
        const feesDocRef = doc(db, `fees`, currentUserId);

        let totalFees = 0;
        let totalPayments = 0;
        let balance = 0;
        let payments = [];

        try {
            const feesSnapshot = await getDoc(feesDocRef);
            if (feesSnapshot.exists()) {
                const feesData = feesSnapshot.data();
                totalFees = feesData.totalFees || 0;
                payments = feesData.payments || [];
                totalPayments = payments.reduce((sum, p) => sum + p.amount, 0);
                balance = totalFees - totalPayments;
            }
        } catch (error) {
            console.error("Error fetching fees data:", error);
            // Continue rendering with default values even if there's an error
        }

        const balanceColor = balance > 0 ? 'text-red-600' : 'text-green-600';
        const balanceText = `GHS ${balance.toFixed(2)}`;

        const feesContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Fees Statement</h3>
                <p class="text-gray-700">View your fees summary and payment history. For detailed inquiries, please contact the finance department.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h4 class="text-lg font-bold text-green-800 mb-2">Total Fees</h4>
                    <p class="text-4xl font-extrabold text-green-700">GHS ${totalFees.toFixed(2)}</p>
                    <p class="text-sm text-gray-500 mt-2">Total amount charged for your academic period.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h4 class="text-lg font-bold text-green-800 mb-2">Total Payments</h4>
                    <p class="text-4xl font-extrabold text-green-700">GHS ${totalPayments.toFixed(2)}</p>
                    <p class="text-sm text-gray-500 mt-2">Sum of all payments made to date.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h4 class="text-lg font-bold text-green-800 mb-2">Current Balance</h4>
                    <p class="text-4xl font-extrabold ${balanceColor}">${balanceText}</p>
                    <p class="text-sm text-gray-500 mt-2">${balance > 0 ? 'Amount still outstanding.' : 'Account fully settled!'}</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h4 class="text-xl font-bold text-green-800 mb-4">Payment History</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-green-100 text-green-800">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Date</th>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Payment ID</th>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Amount</th>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.length > 0 ? payments.map(p => `
                                <tr>
                                    <td class="py-3 px-4 border-b border-gray-200">${new Date(p.date).toLocaleDateString()}</td>
                                    <td class="py-3 px-4 border-b border-gray-200">${p.paymentId || 'N/A'}</td>
                                    <td class="py-3 px-4 border-b border-gray-200">GHS ${p.amount ? p.amount.toFixed(2) : '0.00'}</td>
                                    <td class="py-3 px-4 border-b border-gray-200">${p.method || 'N/A'}</td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="4" class="py-8 text-center text-gray-600 bg-gray-50">
                                        <i class="fas fa-money-bill-wave-alt text-4xl text-gray-400 mb-2"></i>
                                        <p>No payment history found yet. Payments will appear here once recorded.</p>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                <h4 class="text-xl font-bold text-green-800 mb-4">How to Make a Payment</h4>
                <p class="text-gray-700 mb-4">To settle your outstanding balance, please use one of the following official university payment methods:</p>
                <ul class="list-disc list-inside text-gray-700 space-y-2 ml-4">
                    <li><strong>Online Payment Portal:</strong> Visit the official university website and navigate to the student finance section to make secure online payments using your credit/debit card.</li>
                    <li><strong>Bank Transfer:</strong> You can transfer funds directly to the university's bank account. Please ensure you include your student ID as the reference. Bank details are available from the finance office.</li>
                    <li><strong>Finance Office:</strong> Payments can also be made in person at the university's finance office during working hours.</li>
                </ul>
                <p class="text-sm text-gray-600 mt-4">For any payment-related queries or to request specific bank details, kindly contact the Finance Department at finance@princeladesignuni.edu or call +233-XXX-XXXX.</p>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Fees Statement") + feesContentHtml;
        hideLoading();
    }

    // 10. Receipts
    async function loadReceipts() {
        showLoading("Loading receipts...");
        const content = document.getElementById("dashboardContent");
        const receiptsCollectionRef = collection(db, `receipts`);
        try {
            const receiptsQuery = query(receiptsCollectionRef, where("studentId", "==", currentUserId), orderBy("date", "desc"));
            const receiptsSnapshot = await getDocs(receiptsQuery);
            const receipts = receiptsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let receiptsHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <p class="text-gray-600 text-center py-4">No receipts available at this time.</p>
                </div>`;
            if (receipts.length > 0) {
                receiptsHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <div class="flex flex-col space-y-4">
                            ${receipts.map(r => `
                                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-gray-800">Payment of GHS ${r.amount.toFixed(2)}</p>
                                        <p class="text-sm text-gray-600">Receipt No: ${r.receiptNo}</p>
                                        <p class="text-sm text-gray-600">Date: ${new Date(r.date).toLocaleDateString()}</p>
                                    </div>
                                    <a href="${r.fileURL}" target="_blank" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                                        <i class="fas fa-download mr-2"></i> Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            const receiptsContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Payment Receipts</h3>
                    <p class="text-gray-700">Download your payment receipts here.</p>
                </div>
                ${receiptsHtml}
            `;
            content.innerHTML = generateBreadcrumb("Receipts") + receiptsContentHtml;
        } catch (error) {
            console.error("Error loading receipts:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load receipts. Please try again later.</div>`;
        }
        hideLoading();
    }

    // 11. Exam Card
    async function loadExamCard() {
        showLoading("Loading exam card...");
        const content = document.getElementById("dashboardContent");
        const examCardsCollectionRef = collection(db, `examCards`);
        try {
            const examCardsQuery = query(examCardsCollectionRef, where("studentId", "==", currentUserId), orderBy("dateGenerated", "desc"));
            const examCardsSnapshot = await getDocs(examCardsQuery);
            const examCards = examCardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let examCardHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <p class="text-gray-600 text-center py-4">No exam card available for this semester.</p>
                </div>`;
            if (examCards.length > 0) {
                examCardHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <div class="flex flex-col space-y-4">
                            ${examCards.map(ec => `
                                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-gray-800">Exam Card for ${ec.semester}</p>
                                        <p class="text-sm text-gray-600">Generated on: ${new Date(ec.dateGenerated).toLocaleDateString()}</p>
                                    </div>
                                    <a href="${ec.fileURL}" target="_blank" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                                        <i class="fas fa-download mr-2"></i> Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            const examCardContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Exam Card</h3>
                    <p class="text-gray-700">Download your official exam card for the current semester.</p>
                </div>
                ${examCardHtml}
            `;
            content.innerHTML = generateBreadcrumb("Exam Card") + examCardContentHtml;
        } catch (error) {
            console.error("Error loading exam card:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load exam card. Please try again later.</div>`;
        }
        hideLoading();
    }

    // 12. Hostels/Accommodation
    async function loadHostels() {
        showLoading("Loading accommodation options...");
        const content = document.getElementById("dashboardContent");
        const hostelSettingsDocRef = doc(db, `settings`, `hostelBooking`);
        const hostelsCollectionRef = collection(db, `hostels`);
        const accommodationRequestsCollectionRef = collection(db, `accommodationRequests`);

        try {
            const hostelSettingsSnap = await getDoc(hostelSettingsDocRef);
            const isBookingActivated = hostelSettingsSnap.exists() ? hostelSettingsSnap.data().isActivated : false;

            let hostelsContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Hostel Accommodation</h3>
                    <p class="text-gray-700">Explore your on-campus accommodation options and manage your hostel bookings.</p>
                </div>
            `;

            if (isBookingActivated) {
                const hostelsSnapshot = await getDocs(hostelsCollectionRef);
                const hostels = hostelsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const accommodationRequestsQuery = query(accommodationRequestsCollectionRef, where("studentId", "==", currentUserId), orderBy("dateRequested", "desc"));
                const accommodationRequestsSnapshot = await getDocs(accommodationRequestsQuery);
                const userBookings = accommodationRequestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let hostelOptionsHtml = '';
                if (hostels.length > 0) {
                    hostelOptionsHtml = hostels.map(h => `
                        <option value="${h.id}" data-price="${h.price}" data-occupants="${h.maxOccupants}" data-name="${h.name}" data-availablebeds="${h.availableBeds}">
                            ${h.name} (Price: GHS ${h.price.toFixed(2)}, Occupancy: ${h.maxOccupants} beds) - Available Beds: ${h.availableBeds}
                        </option>
                    `).join('');
                } else {
                    hostelOptionsHtml = `<option value="">No hostels available</option>`;
                }

                let bookingHistoryHtml = `<p class="text-gray-600 text-center py-4">You have no previous hostel bookings.</p>`;
                if (userBookings.length > 0) {
                    bookingHistoryHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-green-100 text-green-800">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold">Hostel</th>
                                        <th class="py-3 px-4 text-left font-semibold">Date Requested</th>
                                        <th class="py-3 px-4 text-left font-semibold">Status</th>
                                        <th class="py-3 px-4 text-left font-semibold">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${userBookings.map(booking => `
                                        <tr>
                                            <td class="py-3 px-4 border-b border-gray-200">${booking.hostelName || 'N/A'}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${new Date(booking.dateRequested).toLocaleDateString()}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">
                                                <span class="px-3 py-1 rounded-full text-xs font-semibold
                                                    ${booking.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                                                      booking.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                                      'bg-red-100 text-red-800'}">
                                                    ${booking.status}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 border-b border-gray-200">GHS ${booking.hostelPrice ? booking.hostelPrice.toFixed(2) : 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                hostelsContentHtml += `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Book a Hostel Room</h4>
                        <p class="text-gray-700 mb-6">Select an available hostel from the dropdown below and submit your booking request. Ensure you review the details carefully.</p>
                        <form id="book-hostel-form">
                            <div class="flex flex-col mb-4">
                                <label for="hostel-select" class="text-gray-600 font-medium mb-1">Choose a Hostel</label>
                                <select id="hostel-select" name="hostelId" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                                    <option value="">-- Select a Hostel --</option>
                                    ${hostelOptionsHtml}
                                </select>
                                <p id="hostel-details" class="text-sm text-gray-600 mt-2"></p>
                            </div>
                            <button type="submit" id="bookHostelBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg" ${hostels.length === 0 ? 'disabled' : ''}>
                                <i class="fas fa-bed mr-2"></i> Book Now
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Your Booking History</h4>
                        ${bookingHistoryHtml}
                    </div>
                `;
            } else {
                hostelsContentHtml += `
                    <div class="bg-red-100 p-6 rounded-xl shadow-md border border-red-300 text-red-800 text-center">
                        <h4 class="text-xl font-bold mb-2">Hostel Booking Currently Deactivated 🚫</h4>
                        <p class="text-lg">Hostel room booking is currently **deactivated** by the administration. Please check back later or contact the accommodation office for more information.</p>
                        <i class="fas fa-exclamation-circle text-5xl mt-4"></i>
                    </div>
                `;
            }

            content.innerHTML = generateBreadcrumb("Accommodation") + hostelsContentHtml;

            if (isBookingActivated) {
                const hostelSelect = document.getElementById('hostel-select');
                if (hostelSelect) {
                    hostelSelect.addEventListener('change', function() {
                        const selectedOption = hostelSelect.options[hostelSelect.selectedIndex];
                        const hostelDetailsDiv = document.getElementById('hostel-details');
                        if (selectedOption && selectedOption.value) {
                            const price = selectedOption.dataset.price;
                            const occupants = selectedOption.dataset.occupants;
                            const availableBeds = selectedOption.dataset.availablebeds;
                            hostelDetailsDiv.innerHTML = `<strong>Price:</strong> GHS ${parseFloat(price).toFixed(2)} per academic year | <strong>Max Occupants:</strong> ${occupants} | <strong>Available:</strong> ${availableBeds} beds`;
                        } else {
                            hostelDetailsDiv.innerText = '';
                        }
                    });
                }
                const bookHostelForm = document.getElementById('book-hostel-form');
                if (bookHostelForm) {
                    bookHostelForm.addEventListener('submit', bookHostel);
                }
            }

        } catch (error) {
            console.error("Error loading hostels:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load accommodation options. Please try again later.</div>`;
        }
        hideLoading();
    }

    async function bookHostel(event) {
        event.preventDefault();
        const bookHostelBtn = document.getElementById('bookHostelBtn');
        const hostelSelect = document.getElementById('hostel-select');
        const selectedOption = hostelSelect.options[hostelSelect.selectedIndex];
        const selectedHostelId = selectedOption.value;

        if (!selectedHostelId) {
            await showCustomModal("Error", "Please select a hostel to book.");
            return;
        }

        const confirmBooking = await confirm("Are you sure you want to book this hostel room?");
        if (!confirmBooking) return;

        setButtonLoading(bookHostelBtn, true);
        const accommodationRequestsCollectionRef = collection(db, `accommodationRequests`);
        const hostelsCollectionRef = collection(db, `hostels`);
        const hostelDocRef = doc(db, hostelsCollectionRef, selectedHostelId);

        try {
            // Fetch hostel details to save with the booking request
            const hostelSnap = await getDoc(hostelDocRef);
            if (!hostelSnap.exists()) {
                throw new Error("Selected hostel not found.");
            }
            const hostelData = hostelSnap.data();

            if (hostelData.availableBeds <= 0) {
                 await showCustomModal("Booking Failed", "This hostel currently has no available beds.");
                 return;
            }

            // Check if student already has an active booking
            const existingBookingsQuery = query(accommodationRequestsCollectionRef, where("studentId", "==", currentUserId), where("status", "in", ["Pending", "Approved"]));
            const existingBookingsSnapshot = await getDocs(existingBookingsQuery);

            if (!existingBookingsSnapshot.empty) {
                await showCustomModal("Booking Failed", "You already have an active or pending hostel booking.");
                return;
            }

            await addDoc(accommodationRequestsCollectionRef, {
                studentId: currentUserId,
                hostelId: selectedHostelId,
                hostelName: hostelData.name, // Store name for history display
                hostelPrice: hostelData.price, // Store price for history display
                dateRequested: new Date().toISOString(),
                status: 'Pending' // Initial status
            });

            // Decrement available beds
            await updateDoc(hostelDocRef, {
                availableBeds: Math.max(0, hostelData.availableBeds - 1)
            });

            await showCustomModal("Booking Submitted", `✅ Your request for ${hostelData.name} has been submitted! You will be notified once it's processed.`);
            loadHostels(); // Reload the section to update UI and history
        } catch (error) {
            console.error("Error submitting accommodation request:", error);
            await showCustomModal("Submission Failed", `Failed to submit request: ${error.message}. Please try again.`);
        } finally {
            setButtonLoading(bookHostelBtn, false);
        }
    }


    // 13. Announcements
    async function loadAnnouncements() {
        showLoading("Loading announcements...");
        const content = document.getElementById("dashboardContent");
        const announcementsCollectionRef = collection(db, `announcements`);
        try {
            const announcementsQuery = query(announcementsCollectionRef, orderBy("date", "desc"));
            const announcementsSnapshot = await getDocs(announcementsQuery);
            const announcements = announcementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let announcementsHtml = `<p class="text-gray-600 text-center py-4">No announcements at this time.</p>`;
            if (announcements.length > 0) {
                announcementsHtml = `<div class="space-y-4">${announcements.map(ann => `
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                        <p class="text-sm text-gray-500 mb-2">${new Date(ann.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                        <h4 class="text-xl font-bold text-green-800 mb-2">${ann.title}</h4>
                        <p class="text-gray-700">${ann.message}</p>
                    </div>
                `).join('')}</div>`;
            }
            const announcementsContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Announcements</h3>
                    <p class="text-gray-700">Stay up to date with the latest news and announcements from the university.</p>
                </div>
                ${announcementsHtml}
            `;
            content.innerHTML = generateBreadcrumb("Announcements") + announcementsContentHtml;
        } catch (error) {
            console.error("Error loading announcements:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load announcements. Please try again later.</div>`;
        }
        hideLoading();
    }

    // 14. Settings
    async function loadSettings() {
        showLoading("Loading settings...");
        const content = document.getElementById("dashboardContent");
        try {
            const settingsContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">Settings</h3>
                    <p class="text-gray-700 mb-6">Manage your account settings and preferences.</p>
                    <div class="space-y-8">
                        <div>
                            <h4 class="text-xl font-bold text-green-800 mb-2">Change Password</h4>
                            <form id="change-password-form">
                                <div class="flex flex-col mb-4">
                                    <label for="new-password" class="text-gray-600 font-medium mb-1">New Password</label>
                                    <input type="password" id="new-password" name="new-password" placeholder="Enter new password" required class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                                </div>
                                <div class="flex flex-col mb-4">
                                    <label for="confirm-new-password" class="text-gray-600 font-medium mb-1">Confirm New Password</label>
                                    <input type="password" id="confirm-new-password" name="confirm-new-password" placeholder="Confirm new password" required class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                                </div>
                                <button type="submit" id="changePasswordBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">Change Password</button>
                            </form>
                        </div>
                        <div>
                            <h4 class="text-xl font-bold text-red-800 mb-2">Delete Account</h4>
                            <p class="text-gray-700 mb-4">Permanently delete your account and all associated data. This action is irreversible.</p>
                            <button onclick="deleteAccount()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">Delete Account</button>
                        </div>
                    </div>
                </div>
            `;
            content.innerHTML = generateBreadcrumb("Settings") + settingsContentHtml;
            document.getElementById('change-password-form').addEventListener('submit', changePassword);
        } catch (error) {
            console.error("Error loading settings:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load settings. Please try again later.</div>`;
        }
        hideLoading();
    }

    async function changePassword(event) {
        event.preventDefault();
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        const changePasswordBtn = document.getElementById('changePasswordBtn');

        if (newPassword !== confirmNewPassword) {
            await showCustomModal("Error", "New passwords do not match.");
            return;
        }

        if (newPassword.length < 6) {
            await showCustomModal("Error", "Password must be at least 6 characters long.");
            return;
        }

        const confirmChange = await confirm("Are you sure you want to change your password?");
        if (!confirmChange) return;

        setButtonLoading(changePasswordBtn, true);
        const user = auth.currentUser;

        try {
            await updatePassword(user, newPassword);
            await showCustomModal("Password Changed", "✅ Your password has been successfully changed.");
            document.getElementById('change-password-form').reset();
        } catch (error) {
            console.error("Error changing password:", error);
            await showCustomModal("Change Failed", "Failed to change password. Please log out and log in again, then try changing your password.");
        } finally {
            setButtonLoading(changePasswordBtn, false);
        }
    }

    async function deleteAccount() {
        const confirmDelete = await confirm("Are you absolutely sure you want to delete your account? This action is irreversible and all your data will be lost.");
        if (!confirmDelete) return;

        const confirmFinal = await confirm("FINAL WARNING: All data will be permanently deleted. Are you certain?");
        if (!confirmFinal) return;

        showLoading("Deleting account...");
        const user = auth.currentUser;
        try {
            // Delete associated Firestore data
            const studentDocRef = doc(db, `students`, user.uid);
            const registrationsDocRef = doc(db, `registrations`, user.uid);
            const gradesQuery = query(collection(db, `grades`), where("studentId", "==", user.uid));
            const receiptsQuery = query(collection(db, `receipts`), where("studentId", "==", user.uid));
            const examCardsQuery = query(collection(db, `examCards`), where("studentId", "==", user.uid));
            const graduationRequestDocRef = doc(db, `graduationRequests`, user.uid);
            const clearanceRequestDocRef = doc(db, `clearanceRequests`, user.uid);

            const gradesSnapshot = await getDocs(gradesQuery);
            const receiptsSnapshot = await getDocs(receiptsQuery);
            const examCardsSnapshot = await getDocs(examCardsQuery);

            const deletePromises = [
                deleteDoc(studentDocRef).catch(e => console.warn("Failed to delete student doc:", e)),
                deleteDoc(registrationsDocRef).catch(e => console.warn("Failed to delete registrations doc:", e)),
                deleteDoc(graduationRequestDocRef).catch(e => console.warn("Failed to delete graduation request doc:", e)),
                deleteDoc(clearanceRequestDocRef).catch(e => console.warn("Failed to delete clearance request doc:", e))
            ];

            gradesSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete grade doc:", e))));
            receiptsSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete receipt doc:", e))));
            examCardsSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete exam card doc:", e))));

            await Promise.all(deletePromises);

            // Delete the user from Firebase Authentication
            await user.delete();
            await showCustomModal("Account Deleted", "✅ Your account has been permanently deleted.");
        } catch (error) {
            console.error("Error deleting account:", error);
            await showCustomModal("Deletion Failed", "Failed to delete account. Please try again or contact support.");
            hideLoading();
        }
    }

    // Main navigation handler
    window.showDashboardSection = function(section) {
      const content = document.getElementById("dashboardContent");
      content.innerHTML = '';
      sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile
      switch (section) {
        case 'home':
          loadHome();
          break;
        case 'profile':
          loadProfile();
          break;
        case 'courseReg':
          loadCourseReg();
          break;
        case 'courses':
          loadCourses();
          break;
        case 'timetable':
          loadTimetable();
          break;
        case 'grades':
          loadGrades();
          break;
        case 'graduation':
          loadGraduation();
          break;
        case 'clearance':
          loadClearance();
          break;
        case 'fees':
          loadFees();
          break;
        case 'receipts':
          loadReceipts();
          break;
        case 'examCard':
          loadExamCard();
          break;
        case 'hostels':
          loadHostels();
          break;
        case 'announcements':
          loadAnnouncements();
          break;
        case 'settings':
          loadSettings();
          break;
        case 'examTimetable': // Alias for timetable
          loadTimetable();
          break;
        default:
          loadHome();
          break;
      }
    };
  </script>
</body>
</html>
