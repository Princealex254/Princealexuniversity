<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('myschoolgate.png') no-repeat center center fixed;
      background-size: cover;
    }
    .gpa-circle-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 20px auto;
    }
    .gpa-circle-svg {
      transform: rotate(-90deg);
    }
    .gpa-circle-bg {
      stroke: #e0e0e0;
      stroke-width: 10;
      fill: none;
    }
    .gpa-circle-progress {
      stroke: #006400; /* University green */
      stroke-width: 10;
      fill: none;
      transition: stroke-dasharray 0.5s ease-in-out;
    }
    .gpa-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      font-weight: bold;
      color: #006400;
    }
    .fees-balance-text.red {
        color: #dc2626; /* Tailwind red-600 */
    }
    .fees-balance-text.green {
        color: #16a34a; /* Tailwind green-600 */
    }
    /* Hide scrollbar for announcements panel, but allow scrolling */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    /* Rotate chevron */
    .rotate-180 {
        transform: rotate(180deg);
    }

    /* New CSS for spacing and cards */
    .container {
        padding: 10px; /* Reduced padding for smaller screens */
    }
    /* Adjust main padding and gap on larger screens */
    @media (min-width: 1024px) { /* Equivalent to Tailwind's lg breakpoint */
        .main {
            padding: 20px;
            gap: 20px;
        }
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* Reduce sidebar width */
    #sidebar {
      width: 220px; /* Adjusted from 256px */
    }
    /* Adjust main content margin to account for new sidebar width */
    @media (min-width: 1024px) {
        #dashboardContent {
            margin-left: 220px; /* Adjusted from 256px */
        }
    }

    /* Styles for timetable grid on desktop */
    @media (min-width: 768px) {
        .timetable-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr); /* Time column + 5 days */
            gap: 1px;
            background-color: #e0e0e0; /* Grid lines */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .timetable-grid > div {
            background-color: #fff;
            padding: 8px;
            text-align: center;
        }
        .timetable-header {
            font-weight: bold;
            background-color: #f0fdf4; /* Light green for headers */
            color: #166534; /* Darker green */
        }
        .time-slot {
            font-weight: bold;
            background-color: #f0fdf4; /* Light green for time slots */
            color: #166534; /* Darker green */
        }
        .timetable-cell {
            min-height: 80px; /* Ensure cells have a minimum height */
            display: flex;
            flex-direction: column;
            justify-center: center;
            align-items: center;
            font-size: 0.85rem;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .timetable-cell strong {
            font-size: 0.9rem;
            color: #006400; /* University green */
        }
        .timetable-cell span {
            color: #374151; /* Gray-700 */
        }
    }

    /* Styles for timetable stacked cards on mobile */
    @media (max-width: 767px) {
        .timetable-card-day {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            padding: 16px;
        }
        .timetable-card-day h4 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #166534;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #d1fae5;
        }
        .timetable-card-entry {
            border-left: 4px solid #006400;
            padding-left: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .timetable-card-entry:last-child {
            margin-bottom: 0;
        }
        .timetable-card-entry p {
            margin-bottom: 4px;
            font-size: 0.95rem;
        }
        .timetable-card-entry p strong {
            color: #006400;
        }
        .timetable-card-entry p span {
            color: #374151;
        }
    }

    /* Styles for fees statement mobile cards */
    @media (max-width: 767px) {
        .fees-transaction-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            padding: 16px;
            border-left: 4px solid;
        }
        .fees-transaction-card.debit {
            border-left-color: #dc2626; /* red-600 */
        }
        .fees-transaction-card.credit {
            border-left-color: #16a34a; /* green-600 */
        }
        .fees-transaction-card h5 {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1f2937;
        }
        .fees-transaction-card p {
            margin-bottom: 4px;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .fees-transaction-card .amount {
            font-weight: bold;
            font-size: 1rem;
        }
        .fees-transaction-card .amount.debit {
            color: #dc2626;
        }
        .fees-transaction-card .amount.credit {
            color: #16a34a;
        }
    }
  </style>
</head>
<body class="h-screen flex items-center justify-center">
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
    <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-300">
      <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
      <p id="modalMessage" class="mb-6 text-gray-700"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
        <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
      </div>
    </div>
  </div>

  <div id="authContainer" class="p-4 w-full h-full flex justify-center items-center">
    <div id="login-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5 active">
      <form id="login-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Login</h2>
        <div class="mb-6 text-left">
          <label for="email-login" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-login" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-login" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-login" placeholder="Enter your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="login-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Login</button>
        <div class="mt-6 text-sm flex justify-center space-x-4">
          <a href="#" onclick="showForm('signup')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Don't have an account? Sign Up</a>
          <a href="#" onclick="showForm('forgot-password')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Forgot Password?</a>
        </div>
      </form>
    </div>

    <div id="signup-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="signup-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Sign Up</h2>
        <div class="mb-6 text-left">
          <label for="full-name-signup" class="block text-gray-700 text-sm font-medium mb-2">Full Name</label>
          <input type="text" id="full-name-signup" placeholder="Enter your full name" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
        </div>
        <div class="mb-6 text-left">
          <label for="email-signup" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-signup" placeholder="Enter your email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-signup" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-signup" placeholder="Create a password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="confirm-password-signup" class="block text-gray-700 text-sm font-medium mb-2">Confirm Password</label>
          <input type="password" id="confirm-password-signup" placeholder="Confirm your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="confirm-password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="signup-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Sign Up</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Already have an account? Login</a>
        </div>
      </form>
    </div>

    <div id="forgot-password-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="forgot-password-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Forgot Password</h2>
        <div class="mb-6 text-left">
          <label for="email-forgot" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-forgot" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-forgot-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="recover-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Recover Password</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Back to Login</a>
        </div>
      </form>
    </div>
  </div>

  <div id="dashboardContainer" class="hidden h-screen flex flex-col bg-gray-100 w-full">
    <header class="bg-white text-green-800 p-4 flex justify-between items-center shadow-md sticky top-0 z-10 lg:px-8">
      <img src="myschoollogo.png" alt="University Logo" class="h-12 w-auto">
      <button id="menuToggle" class="lg:hidden text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
        <i class="fas fa-bars"></i>
      </button>
      <div class="hidden lg:flex items-center space-x-4">
        <span class="text-lg font-semibold text-green-700">Welcome, <span id="userName" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
       <div class="lg:hidden flex items-center space-x-4">
        <span class="text-md font-semibold text-green-700">Welcome, <span id="userNameMobile" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <div class="flex flex-grow">
      <nav id="sidebar" class="w-64 bg-green-900 text-white p-6 flex flex-col space-y-2 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20 fixed inset-y-0 left-0 lg:relative lg:flex-shrink-0 lg:h-auto overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Quick Menu</h3>
        <a onclick="showDashboardSection('home')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i> Home</a>
        <a onclick="showDashboardSection('profile')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user mr-3"></i> Personal Profile</a>

        <a onclick="toggleSubmenu('academics-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-book mr-3"></i> Academics <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="academics-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('courseReg')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-alt mr-3"></i> Course Registration</a>
          <a onclick="showDashboardSection('courses')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-list-alt mr-3"></i> Available Courses</a>
          <a onclick="showDashboardSection('timetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-calendar-alt mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-list mr-3"></i> Grades & Transcripts</a>
          <a onclick="showDashboardSection('graduation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-graduation-cap mr-3"></i> Graduation Request</a>
          <a onclick="showDashboardSection('clearance')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-check-circle mr-3"></i> Clearance Request</a>
        </div>

        <a onclick="toggleSubmenu('finance-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-money-bill-wave mr-3"></i> Finance <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="finance-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('fees')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-credit-card mr-3"></i> Fees Statement</a>
          <a onclick="showDashboardSection('receipts')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-receipt mr-3"></i> Receipts</a>
          <a onclick="showDashboardSection('examCard')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-id-card mr-3"></i> Exam Card</a>
        </div>

        <a onclick="toggleSubmenu('exam-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-laptop-code mr-3"></i> Examination <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="exam-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('examTimetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clock mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-invoice mr-3"></i> Transcripts</a>
        </div>
        <a onclick="showDashboardSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-hotel mr-3"></i> Accommodation</a>
        <a onclick="showDashboardSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i> Announcements</a>
        <a onclick="showDashboardSection('settings')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-cog mr-3"></i> Settings</a>
      </nav>

      <main id="dashboardContent" class="flex-grow p-6 overflow-y-auto lg:ml-64 w-full">
        </main>
    </div>

    <footer class="bg-white text-gray-600 text-center p-4 text-sm shadow-inner mt-auto">
      2025 ¬© Prince Alex Design University. All rights reserved.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, arrayUnion, arrayRemove, addDoc, getDocs, deleteDoc, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Firebase Config: Replace with your actual Firebase project details
    const hardcodedFirebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A", // This is a placeholder. Ensure your actual Firebase API Key is used.
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId;
    const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    if (firebaseConfigFromCanvas) {
        app = initializeApp(firebaseConfigFromCanvas);
    } else {
        // Fallback for local development if __firebase_config is not defined
        app = initializeApp(hardcodedFirebaseConfig);
    }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let currentUserData = null;

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const authContainer = document.getElementById('authContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const sidebar = document.getElementById('sidebar');

    // --- Custom Modal Functions (replaces alert/confirm) ---
    function showCustomModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        if (modalTitle) modalTitle.innerText = title;
        if (modalMessage) modalMessage.innerText = message;

        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(true);
            };
        }
        if (modalCancelBtn) {
            modalCancelBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(false);
            };
            modalCancelBtn.classList.toggle('hidden', !isConfirm); // Toggle visibility based on isConfirm
        }
        if (modal) modal.classList.remove('hidden'); // Show modal
      });
    }

    window.alert = (message) => showCustomModal('Alert', message); // Override alert
    window.confirm = (message) => showCustomModal('Confirm', message, true); // Override confirm
    // --- End Custom Modal Functions ---

    // Function to set button loading state
    function setButtonLoading(button, isLoading) {
      if (button) {
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<i class="fas fa-spinner animate-spin mr-2"></i>Loading...' : button.dataset.originalHtml;
      }
    }

    // Function to store original button HTML for loading state
    function storeOriginalButtonHtml() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.dataset.originalHtml = button.innerHTML;
      });
    }

    // Inline form validation utility
    function validateInput(inputElement, validationFn, errorMessageElement) {
        if (validationFn(inputElement.value)) {
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-300', 'focus:ring-green-500');
            errorMessageElement.classList.add('hidden');
            return true;
        } else {
            inputElement.classList.remove('border-gray-300', 'focus:ring-green-500');
            inputElement.classList.add('border-red-500');
            errorMessageElement.innerText = `‚ùå ${errorMessageElement.dataset.errorMessage || 'Invalid input.'}`;
            errorMessageElement.classList.remove('hidden');
            return false;
        }
    }

    // Email validation regex (basic)
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    // Password validation regex (at least 6 characters)
    const isValidPassword = (password) => password.length >= 6;


    // Function to show specific authentication form and hide others
    window.showForm = function(formId) {
      const forms = document.querySelectorAll('.form-wrapper');
      forms.forEach(form => {
        form.classList.remove('active');
        form.classList.add('opacity-0', 'invisible', 'translate-y-5');
      });
      const activeForm = document.getElementById(`${formId}-form-wrapper`);
      if (activeForm) {
        activeForm.classList.remove('opacity-0', 'invisible', 'translate-y-5');
        activeForm.classList.add('active');
        // Autofocus the first input in the new form
        const firstInput = activeForm.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      }
    };

    // This function runs once the DOM is fully loaded and before onAuthStateChanged fires its initial state.
    async function initializeAppUI() {
        storeOriginalButtonHtml(); // Store original button HTML for loading states
        loadingText.innerText = "Initializing session...";
        loadingOverlay.classList.remove('hidden');

        // Attach inline validation listeners
        attachFormValidationListeners();

        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                await signInAnonymously(auth);
                console.log("Signed in anonymously due to custom token failure.");
            }
        } else {
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                await showCustomModal("Error", "Failed to initialize anonymous session. Please refresh.");
            }
        }
    }

    window.onload = initializeAppUI;

    // --- Authentication Forms Event Listeners ---
    document.getElementById('login-form').addEventListener('submit', loginUser);
    document.getElementById('signup-form').addEventListener('submit', signupUser);
    document.getElementById('forgot-password-form').addEventListener('submit', recoverPassword);

    function attachFormValidationListeners() {
        // Login form
        const emailLogin = document.getElementById('email-login');
        const emailLoginError = document.getElementById('email-login-error');
        if (emailLogin) {
            emailLoginError.dataset.errorMessage = "Please enter a valid email address.";
            emailLogin.addEventListener('input', () => validateInput(emailLogin, isValidEmail, emailLoginError));
        }
        const passwordLogin = document.getElementById('password-login');
        const passwordLoginError = document.getElementById('password-login-error');
        if (passwordLogin) {
            passwordLoginError.dataset.errorMessage = "Password must be at least 6 characters.";
            passwordLogin.addEventListener('input', () => validateInput(passwordLogin, isValidPassword, passwordLoginError));
        }

        // Signup form
        const emailSignup = document.getElementById('email-signup');
        const emailSignupError = document.getElementById('email-signup-error');
        if (emailSignup) {
            emailSignupError.dataset.errorMessage = "Please enter a valid email address.";
            emailSignup.addEventListener('input', () => validateInput(emailSignup, isValidEmail, emailSignupError));
        }
        const passwordSignup = document.getElementById('password-signup');
        const passwordSignupError = document.getElementById('password-signup-error');
        if (passwordSignup) {
            passwordSignupError.dataset.errorMessage = "Password must be at least 6 characters long.";
            passwordSignup.addEventListener('input', () => validateInput(passwordSignup, isValidPassword, passwordSignupError));
        }
        const confirmPasswordSignup = document.getElementById('confirm-password-signup');
        const confirmPasswordSignupError = document.getElementById('confirm-password-signup-error');
        if (confirmPasswordSignup) {
            confirmPasswordSignupError.dataset.errorMessage = "Passwords do not match.";
            confirmPasswordSignup.addEventListener('input', () => {
                const match = passwordSignup.value === confirmPasswordSignup.value;
                validateInput(confirmPasswordSignup, () => match, confirmPasswordSignupError);
            });
        }

        // Forgot password form
        const emailForgot = document.getElementById('email-forgot');
        const emailForgotError = document.getElementById('email-forgot-error');
        if (emailForgot) {
            emailForgotError.dataset.errorMessage = "Please enter a valid email address.";
            emailForgot.addEventListener('input', () => validateInput(emailForgot, isValidEmail, emailForgotError));
        }
    }


    // --- Authentication Flow ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("User authenticated (from onAuthStateChanged):", user.email, user.uid);

        // Fetch or create user data from Firestore
        const profileDocRef = doc(db, `students`, currentUserId);
        const profileDocSnap = await getDoc(profileDocRef);

        if (profileDocSnap.exists()) {
          currentUserData = profileDocSnap.data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
        } else {
          await setDoc(profileDocRef, {
            email: user.email,
            name: user.email.split("@")[0],
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
          });
          currentUserData = (await getDoc(profileDocRef)).data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          console.log("Created basic user profile during dashboard load fallback.");
        }

        authContainer.classList.add('hidden');
        dashboardContainer.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');

        if (currentUserData.regNo === 'N/A' || currentUserData.programme === 'N/A' || currentUserData.dob === 'N/A' || currentUserData.gender === 'N/A') {
            await showCustomModal("Welcome", "Please complete your profile information.");
            showDashboardSection('profile');
        } else {
            showDashboardSection('home');
        }

      } else {
        authContainer.classList.remove('hidden');
        dashboardContainer.classList.add('hidden');
        loadingOverlay.classList.add('hidden');
        showForm('login');
      }
    });

    // Function to log in user
    async function loginUser(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('login-btn');
      const emailInput = document.getElementById("email-login");
      const passwordInput = document.getElementById("password-login");
      const emailError = document.getElementById('email-login-error');
      const passwordError = document.getElementById('password-login-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);

      if (!isEmailValid || !isPasswordValid) {
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(loginBtn, true);

      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        await showCustomModal("Login Success", "‚úÖ Login successful! Redirecting...");
      } catch (error) {
        let errorMessage = "‚ùå Login failed.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = "‚ùå Invalid email or password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "‚ùå Please enter a valid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "‚ùå Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "‚ùå Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Login Failed", errorMessage);
        console.error("Login error:", error);
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }

    // Function to sign up new user
    async function signupUser(event) {
      event.preventDefault();
      const signupBtn = document.getElementById('signup-btn');
      const fullNameInput = document.getElementById("full-name-signup");
      const emailInput = document.getElementById("email-signup");
      const passwordInput = document.getElementById("password-signup");
      const confirmPasswordInput = document.getElementById("confirm-password-signup");

      const emailError = document.getElementById('email-signup-error');
      const passwordError = document.getElementById('password-signup-error');
      const confirmPasswordError = document.getElementById('confirm-password-signup-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);
      const passwordsMatch = (passwordInput.value === confirmPasswordInput.value);
      const isConfirmPasswordValid = validateInput(confirmPasswordInput, () => passwordsMatch, confirmPasswordError);

      if (!isEmailValid || !isPasswordValid || !isConfirmPasswordValid || !passwordsMatch) {
          if (!passwordsMatch) {
              confirmPasswordError.innerText = "‚ùå Passwords do not match!";
              confirmPasswordError.classList.remove('hidden');
              confirmPasswordInput.classList.add('border-red-500');
          }
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(signupBtn, true);

      const fullName = fullNameInput.value.trim();
      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const userDocRef = doc(db, `students`, user.uid);
        await setDoc(userDocRef, {
            email: user.email,
            name: fullName,
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
        });
        console.log("User signed up and profile created:", user.email);

        await showCustomModal("Signup Success", "‚úÖ Signup successful! Please log in with your new account.");

        showForm('login');

      } catch (error) {
        let errorMessage = "‚ùå Signup failed.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "‚ùå Email already in use. Try logging in or recovering password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "‚ùå Invalid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "‚ùå Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "‚ùå Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Signup Failed", errorMessage);
        console.error("Signup error:", error);
      } finally {
        setButtonLoading(signupBtn, false);
      }
    }

    // Function to recover password
    async function recoverPassword(event) {
      event.preventDefault();
      const recoverBtn = document.getElementById('recover-btn');
      const emailInput = document.getElementById("email-forgot");
      const emailError = document.getElementById('email-forgot-error');
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      if (!isEmailValid) {
        await showCustomModal("Validation Error", "Please enter a valid email address.");
        return;
      }

      setButtonLoading(recoverBtn, true);

      const email = emailInput.value.trim().toLowerCase();

      try {
        await sendPasswordResetEmail(auth, email);
        await showCustomModal("Password Recovery", "‚úÖ Password reset email sent! Check your inbox.");
      } catch (error) {
        let errorMessage = "‚ùå Failed to send password reset email.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "‚ùå No account found with that email.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "‚ùå Please enter a valid email address.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Password Recovery Failed", errorMessage);
        console.error("Password recovery error:", error);
      } finally {
        setButtonLoading(recoverBtn, false);
      }
    }

    // --- Dashboard Specific Functions ---

    // Logout function
    window.confirmLogout = async function() {
      const response = await confirm("Are you sure you want to log out?");
      if (response) {
        try {
          loadingText.innerText = "Logging out...";
          loadingOverlay.classList.remove('hidden');
          await signOut(auth);
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error logging out. Please try again.");
          loadingOverlay.classList.add('hidden');
        }
      }
    };

    window.toggleSubmenu = function(id) {
      const submenu = document.getElementById(id);
      if (submenu) submenu.classList.toggle('hidden');
      const chevron = submenu.previousElementSibling.querySelector('.fa-chevron-down');
      if (chevron) {
        chevron.classList.toggle('rotate-180');
      }
    };

    document.getElementById('menuToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.toggle('-translate-x-full');
    });

    function generateBreadcrumb(currentSectionTitle) {
      return `<div class="text-sm text-gray-600 mb-6">
        <a onclick="showDashboardSection('home')" class="text-green-700 hover:underline cursor-pointer">Home</a>
        <span class="mx-2">/</span>
        <span class="font-semibold text-green-800">${currentSectionTitle}</span>
      </div>`;
    }

    function showLoading(text) {
      loadingText.innerText = text;
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // --- GPA Calculation Utility ---
    function calculateGPA(grades) {
      let totalPoints = 0;
      let totalUnits = 0;
      const gradeMap = {
        'A+': 4.0, 'A': 4.0, 'A-': 3.7,
        'B+': 3.3, 'B': 3.0, 'B-': 2.7,
        'C+': 2.3, 'C': 2.0, 'C-': 1.7,
        'D+': 1.3, 'D': 1.0,
        'F': 0.0
      };
      grades.forEach(g => {
        const courseUnit = g.courseUnit || 3;
        const gradePoint = gradeMap[g.grade] || 0;
        totalPoints += gradePoint * courseUnit;
        totalUnits += courseUnit;
      });
      return totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : "0.00";
    }

    // --- Section-Specific Loaders ---

    // 1. Home Dashboard
    async function loadHome() {
        const content = document.getElementById("dashboardContent");
        const announcementsRef = collection(db, `announcements`);
        const gradesRef = collection(db, `grades`);
        const feesRef = collection(db, `fees`);
        const registrationsRef = doc(db, `registrations`, currentUserId);

        // --- Initial Render with placeholders ---
        const initialStudentName = currentUserData?.name || "Student";
        const initialStudentProgramme = currentUserData?.programme && currentUserData.programme !== 'N/A' ? currentUserData.programme : "Programme Not Set";
        const initialStudentRegNo = currentUserData?.regNo && currentUserData.regNo !== 'N/A' ? currentUserData.regNo : "Registration Number Not Set";
        const initialProfilePhotoURL = currentUserData?.profilePhotoURL || 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';

        const homeContentHtml = `
            <div class="bg-green-100 p-6 rounded-xl shadow-lg flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6 mb-8">
                <img id="dashboardProfilePhoto" src="${initialProfilePhotoURL}" alt="Profile Photo" class="w-20 h-20 rounded-full border-4 border-white shadow-md">
                <div class="text-center md:text-left">
                    <h2 class="text-2xl font-bold text-green-800">Welcome back, <span id="dashboardStudentName">${initialStudentName}</span>!</h2>
                    <p class="text-gray-600"><span id="dashboardStudentProgramme">${initialStudentProgramme}</span> | <span id="dashboardStudentRegNo">${initialStudentRegNo}</span></p>
                    <p class="text-gray-600 mt-2">Ready to embark on a productive day? Your academic journey awaits! üöÄ</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h3 class="text-lg font-bold text-green-800 mb-2">My GPA</h3>
                    <div class="gpa-circle-container">
                        <svg viewBox="0 0 120 120" class="gpa-circle-svg w-full h-full">
                            <circle cx="60" cy="60" r="50" class="gpa-circle-bg"></circle>
                            <circle id="gpaCircleProgress" cx="60" cy="60" r="50" class="gpa-circle-progress" style="stroke-dasharray: 0, 314.159; stroke: #888888;"></circle>
                        </svg>
                        <div id="gpaText" class="gpa-text">0.00</div>
                    </div>
                    <p id="latestGradeInfo" class="text-center text-gray-700">Loading grades... <a onclick="showDashboardSection('grades')" class="text-blue-500 hover:underline">View All Grades</a></p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h3 class="text-lg font-bold text-green-800 mb-2">Fees Balance</h3>
                    <p id="feesBalanceAmount" class="text-4xl font-extrabold text-gray-500 mt-4">GHS 0.00</p>
                    <p id="feesBalanceStatus" class="text-gray-700 mt-4">Outstanding balance: <span class="font-semibold text-gray-500">Loading...</span></p>
                    <div class="mt-4">
                        <button onclick="showDashboardSection('fees')" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">View Statement</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h3 class="text-lg font-bold text-green-800 mb-2">Upcoming Deadlines</h3>
                    <div class="space-y-4 mt-4">
                        <p id="upcomingDeadlineText" class="text-gray-700"><strong>Loading deadlines...</strong></p>
                        <div class="flex flex-col space-y-2">
                            <p class="text-gray-700">Academic Calendar: ${new Date().getFullYear()}/${new Date().getFullYear() + 1}</p>
                            <a href="#" onclick="showDashboardSection('timetable')" class="text-blue-500 hover:underline">View Exam Timetable</a>
                            <span id="registrationLinkPlaceholder"><button onclick="showDashboardSection('courseReg')" class="text-green-700 hover:underline">Register for Courses</button></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h3 class="text-lg font-bold text-green-800 mb-4">Latest Announcements</h3>
                <div id="announcementsPanel" class="no-scrollbar overflow-y-auto max-h-64">
                    <p class="text-gray-600 text-center py-4">Loading announcements...</p>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Dashboard") + homeContentHtml;
        // --- End Initial Render ---

        // --- Asynchronous Data Fetching and UI Update ---
        try {
            // Fetch student profile (already done in onAuthStateChanged, but update anyway)
            const profileDocRef = doc(db, `students`, currentUserId);
            const profileSnap = await getDoc(profileDocRef);
            if (profileSnap.exists()) {
                const studentData = profileSnap.data();
                document.getElementById("dashboardProfilePhoto").src = studentData.profilePhotoURL || 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';
                document.getElementById("dashboardStudentName").innerText = studentData.name || "Student";
                document.getElementById("dashboardStudentProgramme").innerText = studentData.programme && studentData.programme !== 'N/A' ? studentData.programme : "Programme Not Set";
                document.getElementById("dashboardStudentRegNo").innerText = studentData.regNo && studentData.regNo !== 'N/A' ? studentData.regNo : "Registration Number Not Set";
            }

            // Fetch announcements
            const announcementsQuery = query(announcementsRef, orderBy("date", "desc"), limit(3));
            const announcementsSnapshot = await getDocs(announcementsQuery);
            let announcementsHtml = `<p class="text-gray-600 text-center py-4">No new announcements at this time. üéâ</p>`;
            if (!announcementsSnapshot.empty) {
                const announcements = announcementsSnapshot.docs.map(doc => doc.data());
                announcementsHtml = `<ul class="space-y-3">${announcements.map(ann => `
                    <li class="pb-2 border-b border-green-100 last:border-b-0">
                        <p class="text-sm text-gray-500">${new Date(ann.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p class="font-medium text-green-800">${ann.title}</p>
                        <p class="text-gray-700">${ann.message}</p>
                    </li>
                `).join('')}</ul>`;
            }
            document.getElementById("announcementsPanel").innerHTML = announcementsHtml;

            // Fetch fees data
            const feesDocRef = doc(db, `fees`, currentUserId);
            const feesSnapshot = await getDoc(feesDocRef);
            let balance = 0;
            let totalFees = 0;
            let totalPayments = 0;
            if (feesSnapshot.exists()) {
                const feesData = feesSnapshot.data();
                totalFees = feesData.totalFees || 0;
                totalPayments = (feesData.payments || []).reduce((sum, p) => sum + p.amount, 0);
                balance = totalFees - totalPayments;
            }
            const balanceColorClass = balance > 0 ? 'text-red-600' : 'text-green-600';
            const balanceText = `GHS ${balance.toFixed(2)}`;
            document.getElementById("feesBalanceAmount").innerText = balanceText;
            document.getElementById("feesBalanceAmount").classList.remove('text-gray-500', 'text-red-600', 'text-green-600'); // Clean previous classes
            document.getElementById("feesBalanceAmount").classList.add(balanceColorClass);
            document.getElementById("feesBalanceStatus").innerHTML = `Outstanding balance: <span class="font-semibold ${balanceColorClass}">${balanceText}</span>`;

            // Fetch grades
            const gradesQuery = query(gradesRef, where("studentId", "==", currentUserId));
            const gradesSnapshot = await getDocs(gradesQuery);
            let gpa = "0.00";
            let latestGradeInfo = 'No grades recorded yet. üìù';
            let gpaCircleProgress = 0;
            let gpaCircleColor = '#888888'; // Default grey for no GPA
            if (!gradesSnapshot.empty) {
                const grades = gradesSnapshot.docs.map(doc => doc.data());
                gpa = calculateGPA(grades);
                const latestGrade = grades.length > 0 ? grades.sort((a,b) => new Date(b.date) - new Date(a.date))[0] : null;
                latestGradeInfo = latestGrade ? `Your latest grade is a **${latestGrade.grade}** in **${latestGrade.courseCode}**. ` : '';
                gpaCircleProgress = parseFloat(gpa) > 0 ? (parseFloat(gpa) / 4 * 314) : 0;
                gpaCircleColor = parseFloat(gpa) > 0 ? '#006400' : '#888888';
            }
            document.getElementById("gpaText").innerText = gpa;
            document.getElementById("latestGradeInfo").innerHTML = latestGradeInfo + ` <a onclick="showDashboardSection('grades')" class="text-blue-500 hover:underline">View All Grades</a>`;
            const progressCircle = document.getElementById("gpaCircleProgress");
            if (progressCircle) {
                progressCircle.style.strokeDasharray = `${gpaCircleProgress}, 314.159`;
                progressCircle.style.stroke = gpaCircleColor;
            }


            // Fetch registrations for upcoming deadlines
            const registrationsSnap = await getDoc(registrationsRef);
            let upcomingDeadline = "No upcoming deadlines. Enjoy your studies! üìö";
            let registrationLink = `<button onclick="showDashboardSection('courseReg')" class="text-green-700 hover:underline">Register for Courses</button>`;
            if (registrationsSnap.exists()) {
                const registrationsData = registrationsSnap.data().courses || [];
                const now = new Date();
                const futureDeadlines = registrationsData.filter(reg => new Date(reg.registrationDeadline) > now);

                if (futureDeadlines.length > 0) {
                    futureDeadlines.sort((a,b) => new Date(a.registrationDeadline) - new Date(a.registrationDeadline));
                    const nextDeadline = futureDeadlines[0];
                    upcomingDeadline = `${nextDeadline.courseName} Registration Deadline: ${new Date(nextDeadline.registrationDeadline).toLocaleDateString()}. Don't miss out! ‚è∞`;
                    registrationLink = `<a href="#" onclick="showDashboardSection('courseReg')" class="text-blue-500 hover:underline">View Registrations</a>`;
                }
            }
            document.getElementById("upcomingDeadlineText").innerHTML = `<strong>${upcomingDeadline}</strong>`;
            document.getElementById("registrationLinkPlaceholder").innerHTML = registrationLink;


        } catch (error) {
            console.error("Error fetching some dashboard data:", error);
            // The placeholder content already provides a good user experience.
            // No need to show a general "Error! Could not load dashboard data." message.
        }
        hideLoading();
    }


    // 2. Profile
    async function loadProfile() {
      showLoading("Loading personal profile...");
      const content = document.getElementById("dashboardContent");
      const profileDocRef = doc(db, `students`, currentUserId);
      try {
        const docSnap = await getDoc(profileDocRef);
        const data = docSnap.exists() ? docSnap.data() : {};
        const profileContentHtml = `
          <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
            <h3 class="text-2xl font-bold text-green-800 mb-4">Personal Profile</h3>
            <div class="flex flex-col md:flex-row items-center md:space-x-6 space-y-4 md:space-y-0 pb-6 border-b border-gray-200 mb-6">
                <div class="relative w-28 h-28 group">
                    <img id="profilePhoto" src="${data.profilePhotoURL || 'https://placehold.co/120x120/eeeeee/333333?text=Avatar'}" alt="Profile Photo" class="rounded-full w-full h-full object-cover border-4 border-white shadow-lg transition-transform duration-300 ease-in-out group-hover:scale-105">
                    <div class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex justify-center items-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer">
                        <input type="file" id="photoUpload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*">
                        <i class="fas fa-camera text-white text-2xl"></i>
                    </div>
                </div>
                <div class="text-center md:text-left flex-grow">
                    <h4 class="text-2xl font-bold text-gray-800" id="profileName">${data.name || 'N/A'}</h4>
                    <p class="text-gray-600" id="profileRegNo">${data.regNo || 'N/A'}</p>
                    <p class="text-gray-600" id="profileProgramme">${data.programme || 'N/A'}</p>
                </div>
            </div>
            <form id="profile-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col">
                        <label for="name" class="text-gray-600 font-medium mb-1">Full Name</label>
                        <input type="text" id="name" name="name" value="${data.name || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="email" class="text-gray-600 font-medium mb-1">Email</label>
                        <input type="email" id="email" name="email" value="${data.email || ''}" disabled class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed">
                    </div>
                    <div class="flex flex-col">
                        <label for="regNo" class="text-gray-600 font-medium mb-1">Registration Number</label>
                        <input type="text" id="regNo" name="regNo" value="${data.regNo || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="programme" class="text-gray-600 font-medium mb-1">Programme</label>
                        <input type="text" id="programme" name="programme" value="${data.programme || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="campus" class="text-gray-600 font-medium mb-1">Campus</label>
                        <input type="text" id="campus" name="campus" value="${data.campus || 'Main Campus'}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="dob" class="text-gray-600 font-medium mb-1">Date of Birth</label>
                        <input type="date" id="dob" name="dob" value="${data.dob || ''}" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    </div>
                    <div class="flex flex-col">
                        <label for="gender" class="text-gray-600 font-medium mb-1">Gender</label>
                        <select id="gender" name="gender" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">Select Gender</option>
                            <option value="Male" ${data.gender === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${data.gender === 'Female' ? 'selected' : ''}>Female</option>
                            <option value="Other" ${data.gender === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="address" class="text-gray-600 font-medium mb-1">Address</label>
                        <textarea id="address" name="address" rows="3" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">${data.address || ''}</textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button type="submit" id="updateProfileBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Update Profile</button>
                </div>
            </form>
          </div>
        `;
        content.innerHTML = generateBreadcrumb("Personal Profile") + profileContentHtml;
        document.getElementById('profile-form').addEventListener('submit', updateProfile);
        document.getElementById('photoUpload').addEventListener('change', uploadProfilePhoto);

      } catch (error) {
        console.error("Error loading profile:", error);
        content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load profile. Please try again later.</div>`;
      }
      hideLoading();
    }

    // Update Profile function
    async function updateProfile(event) {
        event.preventDefault();
        const updateBtn = document.getElementById('updateProfileBtn');
        setButtonLoading(updateBtn, true);

        const form = event.target;
        const formData = new FormData(form);
        const profileData = Object.fromEntries(formData.entries());
        const profileDocRef = doc(db, `students`, currentUserId);

        try {
            await updateDoc(profileDocRef, profileData);
            currentUserData = profileData; // Update local state
            // Update UI
            document.getElementById('profileName').innerText = profileData.name || 'N/A';
            document.getElementById('profileRegNo').innerText = profileData.regNo || 'N/A';
            document.getElementById('profileProgramme').innerText = profileData.programme || 'N/A';
            document.getElementById("userName").innerText = profileData.name ? profileData.name.split(" ")[0] : "User";
            const userNameMobile = document.getElementById("userNameMobile");
            if (userNameMobile) userNameMobile.innerText = profileData.name ? profileData.name.split(" ")[0] : "User";

            await showCustomModal("Profile Updated", "Your profile has been successfully updated.");
            console.log("Profile updated successfully.");
        } catch (error) {
            console.error("Error updating profile:", error);
            await showCustomModal("Update Failed", "Failed to update profile. Please try again.");
        } finally {
            setButtonLoading(updateBtn, false);
        }
    }

    // Upload Profile Photo function
    async function uploadProfilePhoto(event) {
        const file = event.target.files[0];
        if (!file) return;
        const photoUploadBtn = event.target;

        const confirmUpload = await confirm("Are you sure you want to upload this photo?");
        if (!confirmUpload) {
          event.target.value = null; // Clear the file input
          return;
        }

        const profilePhoto = document.getElementById('profilePhoto');
        const loadingText = "Uploading photo...";
        showLoading(loadingText);

        const storageRef = ref(storage, `profilePhotos/${currentUserId}/${file.name}`);
        try {
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);

            const profileDocRef = doc(db, `students`, currentUserId);
            await updateDoc(profileDocRef, {
                profilePhotoURL: downloadURL
            });
            currentUserData.profilePhotoURL = downloadURL; // Update local state
            profilePhoto.src = downloadURL;
            await showCustomModal("Photo Uploaded", "Profile photo uploaded successfully!");
            console.log("Photo uploaded and profile updated with new URL.");
        } catch (error) {
            console.error("Error uploading photo:", error);
            await showCustomModal("Upload Failed", "Failed to upload photo. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 3. Course Registration
    async function loadCourseReg() {
        showLoading("Loading course registration...");
        const content = document.getElementById("dashboardContent");
        const registeredCoursesCollectionRef = collection(db, `students`, currentUserId, `registeredCourses`);
        const coursesCollectionRef = collection(db, `courses`);

        // Placeholder content structure
        const courseRegContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Course Registration</h3>
                <p class="text-gray-700 mb-6">Select your department, year, and semester to view available courses and register.</p>
            </div>

            <div class="mt-6 bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h4 class="text-2xl font-bold text-green-800 mb-4">Select Courses</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="flex flex-col">
                        <label for="departmentSelect" class="text-gray-600 font-medium mb-1">Department</label>
                        <select id="departmentSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Departments</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="yearSelect" class="text-gray-600 font-medium mb-1">Year of Study</label>
                        <select id="yearSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Years</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="semesterSelect" class="text-gray-600 font-medium mb-1">Semester</label>
                        <select id="semesterSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Semesters</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-bold text-green-700 mb-2">Available Courses</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-green-100 text-green-800">
                                <tr>
                                    <th class="py-3 px-4 text-left font-semibold">Code</th>
                                    <th class="py-3 px-4 text-left font-semibold">Name</th>
                                    <th class="py-3 px-4 text-left font-semibold">Units</th>
                                    <th class="py-3 px-4 text-left font-semibold">Department</th>
                                    <th class="py-3 px-4 text-left font-semibold">Year</th>
                                    <th class="py-3 px-4 text-left font-semibold">Semester</th>
                                    <th class="py-3 px-4 text-left font-semibold">Action</th>
                                </tr>
                            </thead>
                            <tbody id="availableCoursesTableBody">
                                <tr>
                                    <td colspan="7" class="py-8 text-center text-gray-600 bg-gray-50">
                                        <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-2"></i>
                                        <p>Loading available courses...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-bold text-green-700 mb-2">Registered Courses</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-green-100 text-green-800">
                                <tr>
                                    <th class="py-3 px-4 text-left font-semibold">Code</th>
                                    <th class="py-3 px-4 text-left font-semibold">Name</th>
                                    <th class="py-3 px-4 text-left font-semibold">Units</th>
                                    <th class="py-3 px-4 text-left font-semibold">Department</th>
                                    <th class="py-3 px-4 text-left font-semibold">Year</th>
                                    <th class="py-3 px-4 text-left font-semibold">Semester</th>
                                    <th class="py-3 px-4 text-left font-semibold">Action</th>
                                </tr>
                            </thead>
                            <tbody id="registeredCoursesTableBody">
                                <tr>
                                    <td colspan="7" class="py-8 text-center text-gray-600 bg-gray-50">
                                        <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-2"></i>
                                        <p>Loading registered courses...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p id="totalUnitsRegistered" class="text-right text-gray-700 mt-2 font-medium">Total Units: 0</p>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Course Registration") + courseRegContentHtml;

        try {
            const coursesSnapshot = await getDocs(coursesCollectionRef);
            const allCourses = coursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const registeredCoursesSnapshot = await getDocs(registeredCoursesCollectionRef);
            const registeredCourseIds = registeredCoursesSnapshot.docs.map(doc => doc.id);

            const departments = [...new Set(allCourses.map(c => c.department))].sort();
            const yearsOfStudy = [...new Set(allCourses.map(c => c.yearOfStudy))].sort();
            const semesters = [...new Set(allCourses.map(c => c.semester))].sort();

            const departmentSelect = document.getElementById('departmentSelect');
            const yearSelect = document.getElementById('yearSelect');
            const semesterSelect = document.getElementById('semesterSelect');

            departments.forEach(dep => { departmentSelect.innerHTML += `<option value="${dep}">${dep}</option>`; });
            yearsOfStudy.forEach(year => { yearSelect.innerHTML += `<option value="${year}">${year}</option>`; });
            semesters.forEach(sem => { semesterSelect.innerHTML += `<option value="${sem}">${sem}</option>`; });

            const renderCourseTables = () => {
                const selectedDepartment = departmentSelect.value;
                const selectedYear = yearSelect.value;
                const selectedSemester = semesterSelect.value;

                const filteredCourses = allCourses.filter(course => {
                    return (selectedDepartment === "" || course.department === selectedDepartment) &&
                           (selectedYear === "" || course.yearOfStudy === selectedYear) &&
                           (selectedSemester === "" || course.semester === selectedSemester);
                });

                const coursesAvailableToRegister = filteredCourses.filter(course => !registeredCourseIds.includes(course.id));
                const currentlyRegisteredCourses = filteredCourses.filter(course => registeredCourseIds.includes(course.id));

                const totalUnits = currentlyRegisteredCourses.reduce((sum, course) => sum + (course.courseUnit || 3), 0);
                document.getElementById('totalUnitsRegistered').innerText = `Total Units: ${totalUnits}`;

                let availableHtml = '';
                if (coursesAvailableToRegister.length > 0) {
                    availableHtml = coursesAvailableToRegister.map(course => `
                        <tr>
                            <td class="py-3 px-4 border-b border-gray-200">${course.courseCode}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.courseName}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.courseUnit || 3}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.department || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.yearOfStudy || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.semester || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                <button onclick="registerCourse('${course.id}', '${course.department}', '${course.yearOfStudy}', '${course.semester}')" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-md text-sm transition-colors duration-200">Register</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    availableHtml = `<tr><td colspan="7" class="py-8 text-center text-gray-600 bg-gray-50">No courses available for registration matching your criteria.</td></tr>`;
                }
                document.getElementById('availableCoursesTableBody').innerHTML = availableHtml;

                let registeredHtml = '';
                if (currentlyRegisteredCourses.length > 0) {
                    registeredHtml = currentlyRegisteredCourses.map(course => `
                        <tr>
                            <td class="py-3 px-4 border-b border-gray-200">${course.courseCode}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.courseName}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.courseUnit || 3}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.department || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.yearOfStudy || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${course.semester || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                <button onclick="deregisterCourse('${course.id}')" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-md text-sm transition-colors duration-200">Deregister</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    registeredHtml = `<tr><td colspan="7" class="py-8 text-center text-gray-600 bg-gray-50">You are not registered for any courses in this selection.</td></tr>`;
                }
                document.getElementById('registeredCoursesTableBody').innerHTML = registeredHtml;
            };

            departmentSelect.addEventListener('change', renderCourseTables);
            yearSelect.addEventListener('change', renderCourseTables);
            semesterSelect.addEventListener('change', renderCourseTables);

            renderCourseTables(); // Initial render
        } catch (error) {
            console.error("Error loading course registration:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load course registration. Please try again later.</div>`;
        }
        hideLoading();
    }

    window.registerCourse = async function(courseId, courseDepartment, courseYear, courseSemester) {
        // Ensure that the student's program, year, and department match the course requirements
        if (currentUserData.programme !== courseDepartment || currentUserData.yearOfStudy !== courseYear) {
             await showCustomModal("Registration Failed", "You can only register for courses matching your program and year of study.");
             return;
        }

        const confirmReg = await confirm("Are you sure you want to register for this course?");
        if (!confirmReg) return;

        showLoading("Registering for course...");
        const registeredCoursesCollectionRef = collection(db, `students`, currentUserId, `registeredCourses`);

        try {
            // Check for duplicate registration in client-side data before trying to write
            const existingRegisteredCourseSnap = await getDoc(doc(registeredCoursesCollectionRef, courseId));
            if (existingRegisteredCourseSnap.exists()) {
                await showCustomModal("Registration Failed", "You are already registered for this course.");
                return;
            }

            const courseDocRef = doc(db, `courses`, courseId);
            const courseDocSnap = await getDoc(courseDocRef);
            if (!courseDocSnap.exists()) {
                throw new Error("Course not found.");
            }
            const courseData = courseDocSnap.data();

            // Save the full course details to the student's subcollection
            await setDoc(doc(registeredCoursesCollectionRef, courseId), {
                ...courseData,
                registrationDate: new Date().toISOString()
            });

            await showCustomModal("Registration Success", "‚úÖ Course registered successfully!");
            loadCourseReg(); // Reload the section to update UI
        } catch (error) {
            console.error("Error registering for course:", error);
            await showCustomModal("Registration Failed", `Failed to register for course: ${error.message}. Please try again.`);
            hideLoading();
        }
    };

    window.deregisterCourse = async function(courseId) {
        const confirmDereg = await confirm("Are you sure you want to deregister from this course?");
        if (!confirmDereg) return;

        showLoading("Deregistering from course...");
        const registeredCoursesCollectionRef = collection(db, `students`, currentUserId, `registeredCourses`);

        try {
            // Delete the course document from the student's subcollection
            await deleteDoc(doc(registeredCoursesCollectionRef, courseId));

            await showCustomModal("Deregistration Success", "‚úÖ Course deregistered successfully!");
            loadCourseReg(); // Reload the section to update UI
        } catch (error) {
            console.error("Error deregistering from course:", error);
            await showCustomModal("Deregistration Failed", "Failed to deregister from course. Please try again.");
            hideLoading();
        }
    };

    // 4. Available Courses
    async function loadCourses() {
      showLoading("Loading available courses...");
      const content = document.getElementById("dashboardContent");
      const coursesCollectionRef = collection(db, `courses`);

      // Initial Render with placeholders
      const placeholderCoursesHtml = `
          <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
            <h3 class="text-2xl font-bold text-green-800 mb-4">Undergraduate Programmes (Loading...)</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white">
                <thead class="bg-green-100 text-green-800">
                  <tr>
                    <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                    <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                    <th class="py-3 px-4 text-left font-semibold">Units</th>
                    <th class="py-3 px-4 text-left font-semibold">Semester</th>
                  </tr>
                </thead>
                <tbody>
                    <tr>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">PROG101</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">Introduction to Programming (Placeholder)</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">3</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">Fall 2025</td>
                    </tr>
                    <tr>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">DES205</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">Graphic Design Principles (Placeholder)</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">3</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">Spring 2026</td>
                    </tr>
                    <tr>
                      <td colspan="5" class="py-8 text-center text-gray-600 bg-gray-50">
                          <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-2"></i>
                          <p>Loading more courses...</p>
                      </td>
                    </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
            <h3 class="text-2xl font-bold text-green-800 mb-4">Postgraduate Programmes (Loading...)</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white">
                <thead class="bg-green-100 text-green-800">
                  <tr>
                    <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                    <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                    <th class="py-3 px-4 text-left font-semibold">Units</th>
                    <th class="py-3 px-4 text-left font-semibold">Semester</th>
                  </tr>
                </thead>
                <tbody>
                    <tr>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">RES500</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">Advanced Research Methods (Placeholder)</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">6</td>
                      <td class="py-3 px-4 border-b border-gray-200 text-gray-500">Fall 2025</td>
                    </tr>
                </tbody>
              </table>
            </div>
          </div>
      `;

      const coursesContentHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
          <h3 class="text-2xl font-bold text-green-800 mb-4">Available Courses</h3>
          <p class="text-gray-700">Browse the list of all available courses across different academic programmes. Data is loading dynamically.</p>
        </div>
        <div id="dynamicCoursesContainer">
            ${placeholderCoursesHtml}
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Available Courses") + coursesContentHtml;
      // End Initial Render

      try {
        const coursesSnapshot = await getDocs(coursesCollectionRef);
        const courses = coursesSnapshot.docs.map(doc => doc.data());

        const coursesByProgramme = courses.reduce((acc, course) => {
            if (!acc[course.programme]) {
                acc[course.programme] = [];
            }
            acc[course.programme].push(course);
            return acc;
        }, {});

        let dynamicCoursesHtml = '';
        if (Object.keys(coursesByProgramme).length > 0) {
            dynamicCoursesHtml = Object.entries(coursesByProgramme).map(([programme, courseList]) => `
              <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h3 class="text-2xl font-bold text-green-800 mb-4">${programme}</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full bg-white">
                    <thead class="bg-green-100 text-green-800">
                      <tr>
                        <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                        <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                        <th class="py-3 px-4 text-left font-semibold">Units</th>
                        <th class="py-3 px-4 text-left font-semibold">Semester</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${courseList.map(course => `
                        <tr>
                          <td class="py-3 px-4 border-b border-gray-200">${course.courseCode}</td>
                          <td class="py-3 px-4 border-b border-gray-200">${course.courseName}</td>
                          <td class="py-3 px-4 border-b border-gray-200">${course.courseUnit || 3}</td>
                          <td class="py-3 px-4 border-b border-gray-200">${course.semester}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `).join('');
        } else {
            dynamicCoursesHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <p class="text-gray-600 text-center py-8">
                        <i class="fas fa-book-open text-4xl text-gray-400 mb-2"></i>
                        <p>No courses currently available. Please check back later!</p>
                    </p>
                </div>
            `;
        }
        document.getElementById("dynamicCoursesContainer").innerHTML = dynamicCoursesHtml;

      } catch (error) {
        console.error("Error loading courses:", error);
        document.getElementById("dynamicCoursesContainer").innerHTML = `
            <div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load courses. Please try again later.</div>
        `;
      }
      hideLoading();
    }

    // 5. Timetable
    async function loadTimetable() {
        showLoading("Loading academic timetable...");
        const content = document.getElementById("dashboardContent");
        const timetablesCollectionRef = collection(db, `timetables`);

        // Placeholder content structure
        const timetableContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Academic Timetable</h3>
                <p class="text-gray-700">View your class schedule. Use the filters to find your specific timetable.</p>
            </div>

            <div class="mt-6 bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h4 class="text-2xl font-bold text-green-800 mb-4">Filter Timetable</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="flex flex-col">
                        <label for="timetableDepartmentSelect" class="text-gray-600 font-medium mb-1">Department</label>
                        <select id="timetableDepartmentSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Departments</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="timetableYearSelect" class="text-gray-600 font-medium mb-1">Year of Study</label>
                        <select id="timetableYearSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Years</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="timetableSemesterSelect" class="text-gray-600 font-medium mb-1">Semester</label>
                        <select id="timetableSemesterSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Semesters</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                </div>

                <div id="timetableDisplayArea">
                    <p class="text-gray-600 text-center py-8">
                        <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-2"></i>
                        <p>Loading timetable data...</p>
                    </p>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Academic Timetable") + timetableContentHtml;

        try {
            const timetablesSnapshot = await getDocs(timetablesCollectionRef);
            const allTimetables = timetablesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const departments = [...new Set(allTimetables.map(tt => tt.department))].sort();
            const yearsOfStudy = [...new Set(allTimetables.map(tt => tt.yearOfStudy))].sort();
            const semesters = [...new Set(allTimetables.map(tt => tt.semester))].sort();

            const departmentSelect = document.getElementById('timetableDepartmentSelect');
            const yearSelect = document.getElementById('timetableYearSelect');
            const semesterSelect = document.getElementById('timetableSemesterSelect');

            departments.forEach(dep => { departmentSelect.innerHTML += `<option value="${dep}">${dep}</option>`; });
            yearsOfStudy.forEach(year => { yearSelect.innerHTML += `<option value="${year}">${year}</option>`; });
            semesters.forEach(sem => { semesterSelect.innerHTML += `<option value="${sem}">${sem}</option>`; });

            const timetableDisplayArea = document.getElementById('timetableDisplayArea');
            const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            const timeSlots = [
                "08:00 - 09:00", "09:00 - 10:00", "10:00 - 11:00", "11:00 - 12:00",
                "12:00 - 13:00", "13:00 - 14:00", "14:00 - 15:00", "15:00 - 16:00",
                "16:00 - 17:00", "17:00 - 18:00"
            ]; // Example time slots

            const renderTimetable = () => {
                const selectedDepartment = departmentSelect.value;
                const selectedYear = yearSelect.value;
                const selectedSemester = semesterSelect.value;

                const filteredTimetables = allTimetables.filter(tt => {
                    return (selectedDepartment === "" || tt.department === selectedDepartment) &&
                           (selectedYear === "" || tt.yearOfStudy === selectedYear) &&
                           (selectedSemester === "" || tt.semester === selectedSemester);
                });

                if (filteredTimetables.length === 0) {
                    timetableDisplayArea.innerHTML = `
                        <p class="text-gray-600 text-center py-8">
                            <i class="fas fa-calendar-times text-4xl text-gray-400 mb-2"></i>
                            <p>No timetable available for the selected filters. Please try a different selection or check back later.</p>
                        </p>
                    `;
                    return;
                }

                // Assume we take the first matching timetable for simplicity, or merge if multiple.
                const timetableEntries = filteredTimetables[0].entries || [];

                // Desktop View (Table Grid)
                let desktopHtml = `
                    <div class="hidden md:grid timetable-grid">
                        <div class="timetable-header">Time</div>
                        ${daysOfWeek.map(day => `<div class="timetable-header">${day}</div>`).join('')}
                        ${timeSlots.map(time => `
                            <div class="time-slot">${time}</div>
                            ${daysOfWeek.map(day => {
                                const entry = timetableEntries.find(e => e.day === day && e.timeSlot === time);
                                return `
                                    <div class="timetable-cell border border-gray-200 rounded-md p-2">
                                        ${entry ? `
                                            <strong>${entry.courseCode}</strong>
                                            <span>${entry.courseName}</span>
                                            <span>${entry.lecturer}</span>
                                            <span>${entry.venue}</span>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        `).join('')}
                    </div>
                `;

                // Mobile View (Stacked Cards)
                let mobileHtml = `
                    <div class="md:hidden">
                        ${daysOfWeek.map(day => {
                            const entriesForDay = timetableEntries.filter(e => e.day === day)
                                .sort((a, b) => timeSlots.indexOf(a.timeSlot) - timeSlots.indexOf(b.timeSlot)); // Sort by time

                            return `
                                <div class="timetable-card-day">
                                    <h4>${day}</h4>
                                    ${entriesForDay.length > 0 ? entriesForDay.map(entry => `
                                        <div class="timetable-card-entry mb-3">
                                            <p><strong>${entry.timeSlot}</strong></p>
                                            <p><strong>Course:</strong> ${entry.courseCode} - ${entry.courseName}</p>
                                            <p><strong>Lecturer:</strong> ${entry.lecturer}</p>
                                            <p><strong>Venue:</strong> ${entry.venue}</p>
                                        </div>
                                    `).join('') : '<p class="text-gray-500">No classes scheduled.</p>'}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                timetableDisplayArea.innerHTML = desktopHtml + mobileHtml;
            };

            departmentSelect.addEventListener('change', renderTimetable);
            yearSelect.addEventListener('change', renderTimetable);
            semesterSelect.addEventListener('change', renderTimetable);

            renderTimetable(); // Initial render
        } catch (error) {
            console.error("Error loading timetable:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load timetable. Please try again later.</div>`;
        }
        hideLoading();
    }


    // 6. Grades and Transcripts
    async function loadGrades() {
        showLoading("Loading grades and transcripts...");
        const content = document.getElementById("dashboardContent");
        const gradesCollectionRef = collection(db, `grades`);

        const gradesContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Grades & Transcripts</h3>
                <p class="text-gray-700">View your grades per semester and download your official transcripts.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h4 class="text-lg font-bold text-green-800 mb-2">Current GPA</h4>
                    <p id="currentGpaDisplay" class="text-4xl font-extrabold text-gray-500">Loading...</p>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 col-span-1 md:col-span-2 flex flex-col justify-center items-center">
                    <h4 class="text-lg font-bold text-green-800 mb-4">Generate Official Transcript</h4>
                    <p class="text-gray-700 text-center mb-4">Generate and download your official academic transcript.</p>
                    <button id="generateTranscriptBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">
                        <i class="fas fa-file-pdf mr-2"></i> Generate PDF Transcript
                    </button>
                </div>
            </div>

            <div class="mt-6 bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h4 class="text-2xl font-bold text-green-800 mb-4">Filter Grades</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="flex flex-col">
                        <label for="gradesYearSelect" class="text-gray-600 font-medium mb-1">Year of Study</label>
                        <select id="gradesYearSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Years</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="gradesSemesterSelect" class="text-gray-600 font-medium mb-1">Semester</label>
                        <select id="gradesSemesterSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            <option value="">All Semesters</option>
                            <!-- Options will be dynamically loaded -->
                        </select>
                    </div>
                </div>

                <div id="dynamicGradesContainer">
                    <p class="text-gray-600 text-center py-8">
                        <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-2"></i>
                        <p>Loading your grades...</p>
                    </p>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Grades & Transcripts") + gradesContentHtml;
        document.getElementById("currentGpaDisplay").innerText = "0.00";

        try {
            const gradesQuery = query(gradesCollectionRef, where("studentId", "==", currentUserId));
            const gradesSnapshot = await getDocs(gradesQuery);
            const allGrades = gradesSnapshot.docs.map(doc => doc.data());

            const gpa = calculateGPA(allGrades);
            document.getElementById("currentGpaDisplay").innerText = gpa;

            const yearsOfStudy = [...new Set(allGrades.map(g => g.yearOfStudy))].sort();
            const semesters = [...new Set(allGrades.map(g => g.semester))].sort();

            const yearSelect = document.getElementById('gradesYearSelect');
            const semesterSelect = document.getElementById('gradesSemesterSelect');

            yearsOfStudy.forEach(year => { yearSelect.innerHTML += `<option value="${year}">${year}</option>`; });
            semesters.forEach(sem => { semesterSelect.innerHTML += `<option value="${sem}">${sem}</option>`; });

            const renderGrades = () => {
                const selectedYear = yearSelect.value;
                const selectedSemester = semesterSelect.value;

                const filteredGrades = allGrades.filter(grade => {
                    return (selectedYear === "" || grade.yearOfStudy === selectedYear) &&
                           (selectedSemester === "" || grade.semester === selectedSemester);
                });

                let gradesHtml = '';
                if (filteredGrades.length > 0) {
                    gradesHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-sm">
                                <thead class="bg-green-100 text-green-800">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold">Course Code</th>
                                        <th class="py-3 px-4 text-left font-semibold">Course Name</th>
                                        <th class="py-3 px-4 text-left font-semibold">Grade</th>
                                        <th class="py-3 px-4 text-left font-semibold">Units</th>
                                        <th class="py-3 px-4 text-left font-semibold">Semester</th>
                                        <th class="py-3 px-4 text-left font-semibold">Year</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredGrades.map(grade => `
                                        <tr>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.courseCode}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.courseName}</td>
                                            <td class="py-3 px-4 border-b border-gray-200 font-bold">${grade.grade}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.courseUnit || 3}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.semester}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${grade.yearOfStudy}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    gradesHtml = `
                        <p class="text-gray-600 text-center py-8">
                            <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-2"></i>
                            <p>No grades found for the selected filters. Please adjust your selection.</p>
                        </p>
                    `;
                }
                document.getElementById("dynamicGradesContainer").innerHTML = gradesHtml;
            };

            yearSelect.addEventListener('change', renderGrades);
            semesterSelect.addEventListener('change', renderGrades);

            renderGrades(); // Initial render

            document.getElementById('generateTranscriptBtn').addEventListener('click', () => generatePdfTranscript(allGrades, currentUserData));

        } catch (error) {
            console.error("Error loading grades:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load grades. Please try again later.</div>`;
        }
        hideLoading();
    }

    // Function to generate PDF transcript
    async function generatePdfTranscript(gradesData, studentData) {
        showLoading("Generating transcript...");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // University Header
        doc.setFontSize(24);
        doc.setTextColor(0, 100, 0); // Dark Green
        doc.text("Prince Alex Design University", doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text("Office of the Registrar", doc.internal.pageSize.getWidth() / 2, 27, { align: "center" });
        doc.text("123 University Ave, Cityville, Country | Email: info@padu.edu | Phone: +001 234 5678", doc.internal.pageSize.getWidth() / 2, 32, { align: "center" });
        doc.setDrawColor(0, 100, 0);
        doc.setLineWidth(0.5);
        doc.line(10, 38, doc.internal.pageSize.getWidth() - 10, 38);

        // Student Information
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Official Transcript for: ${studentData.name || 'N/A'}`, 15, 48);
        doc.text(`Student ID: ${studentData.regNo || 'N/A'}`, 15, 55);
        doc.text(`Program: ${studentData.programme || 'N/A'}`, 15, 62);
        doc.text(`Date of Birth: ${studentData.dob || 'N/A'}`, 15, 69);
        doc.text(`Date Issued: ${new Date().toLocaleDateString()}`, 15, 76);

        // Grades Table
        const columns = ["Course Code", "Course Name", "Units", "Grade", "Semester", "Year"];
        const rows = gradesData.map(grade => [
            grade.courseCode,
            grade.courseName,
            grade.courseUnit || 3,
            grade.grade,
            grade.semester,
            grade.yearOfStudy
        ]);

        doc.autoTable({
            startY: 85,
            head: [columns],
            body: rows,
            theme: 'striped',
            headStyles: { fillColor: [0, 100, 0], textColor: 255, fontStyle: 'bold' }, // Dark green header
            styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
            columnStyles: {
                0: { cellWidth: 25 },
                1: { cellWidth: 50 },
                2: { cellWidth: 15 },
                3: { cellWidth: 15 },
                4: { cellWidth: 25 },
                5: { cellWidth: 20 }
            }
        });

        // GPA and Remarks
        const finalY = doc.autoTable.previous.finalY;
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Cumulative GPA (CGPA): ${calculateGPA(gradesData)}`, 15, finalY + 10);
        doc.text("Remarks: This transcript is issued for official purposes only. Any alteration invalidates this document.", 15, finalY + 20);

        // Save the PDF
        doc.save(`${studentData.name || 'Student'}_Transcript_${studentData.regNo || ''}.pdf`);
        await showCustomModal("Transcript Generated", "‚úÖ Your PDF transcript has been successfully generated and downloaded!");
        hideLoading();
    }


    // 7. Graduation Request
    async function loadGraduation() {
        showLoading("Loading graduation request form...");
        const content = document.getElementById("dashboardContent");
        const graduationRequestDocRef = doc(db, `graduationRequests`, currentUserId);

        const studentName = currentUserData?.name || 'N/A';
        const studentRegNo = currentUserData?.regNo || 'N/A';
        const studentProgramme = currentUserData?.programme || 'N/A';
        const studentYear = currentUserData?.yearOfStudy || 'N/A';

        const graduationContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Graduation Request</h3>
                <p class="text-gray-700">Submit your request to graduate and check the status of your application.</p>
            </div>
            <div id="graduationStatusSection">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h4 class="text-xl font-bold text-green-800 mb-4">Your Graduation Request Status (Loading...)</h4>
                    <div class="flex items-center justify-between p-4 rounded-lg bg-gray-100 text-gray-800">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-hourglass-half text-2xl"></i>
                            <div>
                                <p class="font-semibold">Status: Checking...</p>
                                <p class="text-sm">Requested on: N/A</p>
                            </div>
                        </div>
                        <button class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Cancel Request</button>
                    </div>
                </div>
            </div>
            <div id="graduationFormSection">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h4 class="text-xl font-bold text-green-800 mb-4">Request for Graduation</h4>
                    <form id="graduation-request-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Full Name</label>
                                <input type="text" value="${studentName}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Student ID</label>
                                <input type="text" value="${studentRegNo}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Program</label>
                                <input type="text" value="${studentProgramme}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Year of Study</label>
                                <input type="text" value="${studentYear}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label for="graduationSession" class="text-gray-600 font-medium mb-1">Graduation Session</label>
                                <select id="graduationSession" name="session" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                                    <option value="">Select a Session</option>
                                    <option value="July 2025">July 2025</option>
                                    <option value="December 2025">December 2025</option>
                                    <option value="July 2026">July 2026</option>
                                    <option value="December 2026">December 2026</option>
                                </select>
                            </div>
                            <div class="flex items-center md:col-span-2 mt-2">
                                <input type="checkbox" id="confirmRequirements" name="confirmRequirements" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500" required>
                                <label for="confirmRequirements" class="ml-2 text-gray-700">I confirm that I have met all academic and financial requirements for graduation.</label>
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label for="specialNotes" class="text-gray-600 font-medium mb-1">Special Notes/Requests (Optional)</label>
                                <textarea id="specialNotes" name="notes" rows="4" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" placeholder="e.g., Request for special diploma delivery, specific name spelling, etc."></textarea>
                            </div>
                        </div>
                        <button type="submit" id="submitGraduationBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Submit Graduation Request</button>
                    </form>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Graduation Request") + graduationContentHtml;

        try {
            const docSnap = await getDoc(graduationRequestDocRef);
            let graduationStatusHtml = '';
            let formHtml = '';

            if (docSnap.exists()) {
                const status = docSnap.data().status;
                const date = new Date(docSnap.data().dateRequested).toLocaleDateString();
                const session = docSnap.data().session || 'N/A';
                const statusColor = {
                    'Pending': 'bg-yellow-100 text-yellow-800',
                    'Approved': 'bg-green-100 text-green-800',
                    'Declined': 'bg-red-100 text-red-800'
                }[status] || 'bg-gray-100 text-gray-800';

                graduationStatusHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Your Graduation Request Status</h4>
                        <div class="flex flex-col sm:flex-row items-center justify-between p-4 rounded-lg ${statusColor} space-y-3 sm:space-y-0">
                            <div class="flex items-center space-x-3 text-center sm:text-left">
                                <i class="fas fa-info-circle text-2xl"></i>
                                <div>
                                    <p class="font-semibold">Status: ${status}</p>
                                    <p class="text-sm">Requested on: ${date} for ${session} session</p>
                                </div>
                            </div>
                            <button onclick="deleteGraduationRequest()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-200">Cancel Request</button>
                        </div>
                    </div>
                `;
                document.getElementById('graduationFormSection').innerHTML = ''; // Hide form if request exists
            } else {
                formHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Request for Graduation</h4>
                        <form id="graduation-request-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Full Name</label>
                                    <input type="text" value="${studentName}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Student ID</label>
                                    <input type="text" value="${studentRegNo}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Program</label>
                                    <input type="text" value="${studentProgramme}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Year of Study</label>
                                    <input type="text" value="${studentYear}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col md:col-span-2">
                                    <label for="graduationSession" class="text-gray-600 font-medium mb-1">Graduation Session</label>
                                    <select id="graduationSession" name="session" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                                        <option value="">Select a Session</option>
                                        <option value="July 2025">July 2025</option>
                                        <option value="December 2025">December 2025</option>
                                        <option value="July 2026">July 2026</option>
                                        <option value="December 2026">December 2026</option>
                                    </select>
                                </div>
                                <div class="flex items-center md:col-span-2 mt-2">
                                    <input type="checkbox" id="confirmRequirements" name="confirmRequirements" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500" required>
                                    <label for="confirmRequirements" class="ml-2 text-gray-700">I confirm that I have met all academic and financial requirements for graduation.</label>
                                </div>
                                <div class="flex flex-col md:col-span-2">
                                    <label for="specialNotes" class="text-gray-600 font-medium mb-1">Special Notes/Requests (Optional)</label>
                                    <textarea id="specialNotes" name="notes" rows="4" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" placeholder="e.g., Request for special diploma delivery, specific name spelling, etc."></textarea>
                                </div>
                            </div>
                            <button type="submit" id="submitGraduationBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Submit Graduation Request</button>
                        </form>
                    </div>
                `;
            }
            document.getElementById('graduationStatusSection').innerHTML = graduationStatusHtml;
            document.getElementById('graduationFormSection').innerHTML = formHtml;

            if (!docSnap.exists()) {
                document.getElementById('graduation-request-form').addEventListener('submit', submitGraduationRequest);
            }
        } catch (error) {
            console.error("Error loading graduation request:", error);
            document.getElementById('graduationStatusSection').innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load graduation status.</div>`;
            document.getElementById('graduationFormSection').innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load graduation form.</div>`;
        }
        hideLoading();
    }

    async function submitGraduationRequest(event) {
        event.preventDefault();
        const confirmRequest = await confirm("Are you sure you want to submit your graduation request?");
        if (!confirmRequest) return;

        const submitBtn = document.getElementById('submitGraduationBtn');
        setButtonLoading(submitBtn, true);
        const graduationRequestDocRef = doc(db, `graduationRequests`, currentUserId);

        const session = document.getElementById('graduationSession').value;
        const confirmRequirements = document.getElementById('confirmRequirements').checked;
        const notes = document.getElementById('specialNotes').value;

        if (!session || !confirmRequirements) {
            await showCustomModal("Validation Error", "Please select a graduation session and confirm all requirements have been met.");
            setButtonLoading(submitBtn, false);
            return;
        }

        try {
            await setDoc(graduationRequestDocRef, {
                studentId: currentUserId,
                dateRequested: new Date().toISOString(),
                session: session,
                confirmedRequirements: confirmRequirements,
                notes: notes,
                status: 'Pending'
            });
            await showCustomModal("Request Submitted", "‚úÖ Your graduation request has been successfully submitted!");
            loadGraduation();
        } catch (error) {
            console.error("Error submitting graduation request:", error);
            await showCustomModal("Submission Failed", "Failed to submit request. Please try again.");
            hideLoading();
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    async function deleteGraduationRequest() {
        const confirmDelete = await confirm("Are you sure you want to cancel your graduation request?");
        if (!confirmDelete) return;

        showLoading("Cancelling request...");
        const graduationRequestDocRef = doc(db, `graduationRequests`, currentUserId);
        try {
            await deleteDoc(graduationRequestDocRef);
            await showCustomModal("Request Cancelled", "‚úÖ Your graduation request has been successfully cancelled.");
            loadGraduation();
        } catch (error) {
            console.error("Error deleting graduation request:", error);
            await showCustomModal("Cancellation Failed", "Failed to cancel request. Please try again.");
            hideLoading();
        }
    }

    // 8. Clearance Request
    async function loadClearance() {
        showLoading("Loading clearance request...");
        const content = document.getElementById("dashboardContent");
        const clearanceRequestDocRef = doc(db, `clearanceRequests`, currentUserId);

        const studentName = currentUserData?.name || 'N/A';
        const studentRegNo = currentUserData?.regNo || 'N/A';
        const studentProgramme = currentUserData?.programme || 'N/A';
        const studentYear = currentUserData?.yearOfStudy || 'N/A';

        const clearanceContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Clearance Request</h3>
                <p class="text-gray-700">Submit your request to be cleared and view the status of your clearance.</p>
            </div>
            <div id="clearanceStatusSection">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h4 class="text-xl font-bold text-green-800 mb-4">Your Clearance Status (Loading...)</h4>
                    <div class="flex items-center justify-between p-4 rounded-lg bg-gray-100 text-gray-800">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-hourglass-half text-2xl"></i>
                            <div>
                                <p class="font-semibold">Status: Checking...</p>
                                <p class="text-sm">Requested on: N/A</p>
                            </div>
                        </div>
                        <button class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>Cancel Request</button>
                    </div>
                </div>
            </div>
            <div id="clearanceFormSection">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h4 class="text-xl font-bold text-green-800 mb-4">Request for Clearance</h4>
                    <form id="clearance-request-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Full Name</label>
                                <input type="text" value="${studentName}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Student ID</label>
                                <input type="text" value="${studentRegNo}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Program</label>
                                <input type="text" value="${studentProgramme}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-gray-600 font-medium mb-1">Year of Study</label>
                                <input type="text" value="${studentYear}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label for="clearanceType" class="text-gray-600 font-medium mb-1">Clearance Type</label>
                                <select id="clearanceType" name="clearanceType" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                                    <option value="">Select Clearance Type</option>
                                    <option value="Final Graduation Clearance">Final Graduation Clearance</option>
                                    <option value="Library Clearance">Library Clearance</option>
                                    <option value="Hostel Clearance">Hostel Clearance</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="flex items-center md:col-span-2 mt-2">
                                <input type="checkbox" id="confirmDuesCleared" name="confirmDuesCleared" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500" required>
                                <label for="confirmDuesCleared" class="ml-2 text-gray-700">I confirm all items have been returned and dues cleared where applicable.</label>
                            </div>
                            <div class="flex flex-col md:col-span-2">
                                <label for="clearanceNotes" class="text-gray-600 font-medium mb-1">Additional Comments (Optional)</label>
                                <textarea id="clearanceNotes" name="notes" rows="4" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" placeholder="e.g., Details about returned items, specific issues, etc."></textarea>
                            </div>
                        </div>
                        <button type="submit" id="submitClearanceBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Submit Clearance Request</button>
                    </form>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Clearance Request") + clearanceContentHtml;

        try {
            const docSnap = await getDoc(clearanceRequestDocRef);
            let clearanceStatusHtml = '';
            let formHtml = '';

            if (docSnap.exists()) {
                const status = docSnap.data().status;
                const date = new Date(docSnap.data().dateRequested).toLocaleDateString();
                const clearanceType = docSnap.data().clearanceType || 'N/A';
                const statusColor = {
                    'Pending': 'bg-yellow-100 text-yellow-800',
                    'Approved': 'bg-green-100 text-green-800',
                    'Rejected': 'bg-red-100 text-red-800'
                }[status] || 'bg-gray-100 text-gray-800';

                clearanceStatusHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Your Clearance Status</h4>
                        <div class="flex flex-col sm:flex-row items-center justify-between p-4 rounded-lg ${statusColor} space-y-3 sm:space-y-0">
                            <div class="flex items-center space-x-3 text-center sm:text-left">
                                <i class="fas fa-info-circle text-2xl"></i>
                                <div>
                                    <p class="font-semibold">Status: ${status}</p>
                                    <p class="text-sm">Requested on: ${date} for ${clearanceType}</p>
                                </div>
                            </div>
                            <button onclick="deleteClearanceRequest()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-200">Cancel Request</button>
                        </div>
                    </div>
                `;
                document.getElementById('clearanceFormSection').innerHTML = ''; // Hide form if request exists
            } else {
                formHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Request for Clearance</h4>
                        <form id="clearance-request-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Full Name</label>
                                    <input type="text" value="${studentName}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Student ID</label>
                                    <input type="text" value="${studentRegNo}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Program</label>
                                    <input type="text" value="${studentProgramme}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-gray-600 font-medium mb-1">Year of Study</label>
                                    <input type="text" value="${studentYear}" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div class="flex flex-col md:col-span-2">
                                    <label for="clearanceType" class="text-gray-600 font-medium mb-1">Clearance Type</label>
                                    <select id="clearanceType" name="clearanceType" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" required>
                                        <option value="">Select Clearance Type</option>
                                        <option value="Final Graduation Clearance">Final Graduation Clearance</option>
                                        <option value="Library Clearance">Library Clearance</option>
                                        <option value="Hostel Clearance">Hostel Clearance</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="flex items-center md:col-span-2 mt-2">
                                    <input type="checkbox" id="confirmDuesCleared" name="confirmDuesCleared" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500" required>
                                    <label for="confirmDuesCleared" class="ml-2 text-gray-700">I confirm all items have been returned and dues cleared where applicable.</label>
                                </div>
                                <div class="flex flex-col md:col-span-2">
                                    <label for="clearanceNotes" class="text-gray-600 font-medium mb-1">Additional Comments (Optional)</label>
                                    <textarea id="clearanceNotes" name="notes" rows="4" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200" placeholder="e.g., Details about returned items, specific issues, etc."></textarea>
                                </div>
                            </div>
                            <button type="submit" id="submitClearanceBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Submit Clearance Request</button>
                        </form>
                    </div>
                `;
            }
            document.getElementById('clearanceStatusSection').innerHTML = clearanceStatusHtml;
            document.getElementById('clearanceFormSection').innerHTML = formHtml;

            if (!docSnap.exists()) {
                document.getElementById('clearance-request-form').addEventListener('submit', submitClearanceRequest);
            }
        } catch (error) {
            console.error("Error loading clearance request:", error);
            document.getElementById('clearanceStatusSection').innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load clearance status.</div>`;
            document.getElementById('clearanceFormSection').innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load clearance form.</div>`;
        }
        hideLoading();
    }

    async function submitClearanceRequest(event) {
        event.preventDefault();
        const confirmRequest = await confirm("Are you sure you want to submit your clearance request?");
        if (!confirmRequest) return;

        const submitBtn = document.getElementById('submitClearanceBtn');
        setButtonLoading(submitBtn, true);
        const clearanceRequestDocRef = doc(db, `clearanceRequests`, currentUserId);

        const clearanceType = document.getElementById('clearanceType').value;
        const confirmDuesCleared = document.getElementById('confirmDuesCleared').checked;
        const notes = document.getElementById('clearanceNotes').value;

        if (!clearanceType || !confirmDuesCleared) {
            await showCustomModal("Validation Error", "Please select a clearance type and confirm all items have been returned and dues cleared.");
            setButtonLoading(submitBtn, false);
            return;
        }

        try {
            await setDoc(clearanceRequestDocRef, {
                studentId: currentUserId,
                dateRequested: new Date().toISOString(),
                clearanceType: clearanceType,
                confirmedDuesCleared: confirmDuesCleared,
                notes: notes,
                status: 'Pending'
            });
            await showCustomModal("Request Submitted", "‚úÖ Your clearance request has been successfully submitted!");
            loadClearance();
        } catch (error) {
            console.error("Error submitting clearance request:", error);
            await showCustomModal("Submission Failed", "Failed to submit request. Please try again.");
            hideLoading();
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }

    async function deleteClearanceRequest() {
        const confirmDelete = await confirm("Are you sure you want to cancel your clearance request?");
        if (!confirmDelete) return;

        showLoading("Cancelling request...");
        const clearanceRequestDocRef = doc(db, `clearanceRequests`, currentUserId);
        try {
            await deleteDoc(clearanceRequestDocRef);
            await showCustomModal("Request Cancelled", "‚úÖ Your clearance request has been successfully cancelled.");
            loadClearance();
        } catch (error) {
            console.error("Error deleting clearance request:", error);
            await showCustomModal("Cancellation Failed", "Failed to cancel request. Please try again.");
            hideLoading();
        }
    }

    // 9. Fees Statement
    async function loadFees() {
        showLoading("Loading fees statement...");
        const content = document.getElementById("dashboardContent");
        const feesDocRef = doc(db, `fees`, currentUserId);

        const studentName = currentUserData?.name || 'N/A';
        const studentRegNo = currentUserData?.regNo || 'N/A';
        const studentProgramme = currentUserData?.programme || 'N/A';
        const studentYear = currentUserData?.yearOfStudy || 'N/A';

        // Placeholder for initial render
        const feesContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Fees Statement</h3>
                <p class="text-gray-700">View your fees summary and payment history. For detailed inquiries, please contact the finance department.</p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h4 class="text-xl font-bold text-green-800 mb-4">Student Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    <p><strong>Name:</strong> ${studentName}</p>
                    <p><strong>Student ID:</strong> ${studentRegNo}</p>
                    <p><strong>Program:</strong> ${studentProgramme}</p>
                    <p><strong>Year of Study:</strong> ${studentYear}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h4 class="text-lg font-bold text-green-800 mb-2">Total Charges</h4>
                    <p id="totalChargesDisplay" class="text-4xl font-extrabold text-green-700">GHS 0.00</p>
                    <p class="text-sm text-gray-500 mt-2">Total amount charged for your academic period.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h4 class="text-lg font-bold text-green-800 mb-2">Total Payments</h4>
                    <p id="totalPaymentsDisplay" class="text-4xl font-extrabold text-green-700">GHS 0.00</p>
                    <p class="text-sm text-gray-500 mt-2">Sum of all payments made to date.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h4 class="text-lg font-bold text-green-800 mb-2">Current Balance</h4>
                    <p id="outstandingBalanceDisplay" class="text-4xl font-extrabold text-gray-500">GHS 0.00</p>
                    <p class="text-sm text-gray-500 mt-2">Outstanding amount (if any).</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h4 class="text-xl font-bold text-green-800 mb-4">Transaction History</h4>
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-3 md:space-y-0 md:space-x-4">
                    <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                        <label for="feesSemesterFilter" class="text-gray-600 font-medium">Filter by Semester:</label>
                        <select id="feesSemesterFilter" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200 w-full md:w-auto">
                            <option value="">All Semesters</option>
                            <!-- Dynamic options -->
                        </select>
                    </div>
                    <div class="flex space-x-2 w-full md:w-auto justify-end">
                        <button id="exportPdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                    </div>
                </div>

                <div id="feesTransactionsTableContainer" class="hidden md:block overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-green-100 text-green-800">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Date</th>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Description</th>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Debit (GHS)</th>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Credit (GHS)</th>
                                <th class="py-3 px-4 text-left font-semibold border-b border-gray-200">Balance (GHS)</th>
                            </tr>
                        </thead>
                        <tbody id="feesTransactionsTableBody">
                            <tr>
                                <td colspan="5" class="py-8 text-center text-gray-600 bg-gray-50">
                                    <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-2"></i>
                                    <p>Loading transactions...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="feesTransactionsMobileCards" class="md:hidden">
                    <p class="text-gray-600 text-center py-8">
                        <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-2"></i>
                        <p>Loading transactions...</p>
                    </p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                <h4 class="text-xl font-bold text-green-800 mb-4">How to Make a Payment</h4>
                <p class="text-gray-700 mb-4">To settle your outstanding balance, please use one of the following official university payment methods:</p>
                <ul class="list-disc list-inside text-gray-700 space-y-2 ml-4">
                    <li><strong>Online Payment Portal:</strong> Visit the official university website and navigate to the student finance section to make secure online payments using your credit/debit card.</li>
                    <li><strong>Bank Transfer:</strong> You can transfer funds directly to the university's bank account. Please ensure you include your student ID as the reference. Bank details are available from the finance office.</li>
                    <li><strong>Finance Office:</strong> Payments can also be made in person at the university's finance office during working hours.</li>
                </ul>
                <p class="text-sm text-gray-600 mt-4">For any payment-related queries or to request specific bank details, kindly contact the Finance Department at finance@princeladesignuni.edu or call +233-XXX-XXXX.</p>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Fees Statement") + feesContentHtml;

        try {
            const feesSnapshot = await getDoc(feesDocRef);
            let totalFees = 0;
            let payments = [];
            let charges = [];
            let allTransactions = []; // Unified list of charges and payments

            if (feesSnapshot.exists()) {
                const feesData = feesSnapshot.data();
                totalFees = feesData.totalFees || 0;
                payments = feesData.payments || [];
                charges = feesData.charges || [{ description: "Tuition Fee", amount: totalFees, date: new Date().toISOString(), semester: "Fall 2025" }]; // Example charge if not present

                // Combine charges and payments into a single array for chronological display
                charges.forEach(c => allTransactions.push({ ...c, type: 'debit', transactionDate: new Date(c.date) }));
                payments.forEach(p => allTransactions.push({ ...p, type: 'credit', transactionDate: new Date(p.date) }));

                // Sort all transactions by date
                allTransactions.sort((a, b) => a.transactionDate - b.transactionDate);
            }

            // Populate semester filter
            const allSemesters = [...new Set(allTransactions.map(t => t.semester).filter(Boolean))].sort();
            const feesSemesterFilter = document.getElementById('feesSemesterFilter');
            feesSemesterFilter.innerHTML = `<option value="">All Semesters</option>` + allSemesters.map(sem => `<option value="${sem}">${sem}</option>`).join('');

            const renderFeesStatement = () => {
                const selectedSemester = feesSemesterFilter.value;
                let filteredTransactions = allTransactions;

                if (selectedSemester) {
                    filteredTransactions = allTransactions.filter(t => t.semester === selectedSemester);
                }

                let currentBalance = 0;
                let totalCharges = 0;
                let totalPaid = 0;

                const transactionsWithBalance = filteredTransactions.map(t => {
                    if (t.type === 'debit') {
                        currentBalance += t.amount;
                        totalCharges += t.amount;
                    } else if (t.type === 'credit') {
                        currentBalance -= t.amount;
                        totalPaid += t.amount;
                    }
                    return { ...t, runningBalance: currentBalance };
                });

                // Update summary displays
                document.getElementById('totalChargesDisplay').innerText = `GHS ${totalCharges.toFixed(2)}`;
                document.getElementById('totalPaymentsDisplay').innerText = `GHS ${totalPaid.toFixed(2)}`;
                const outstandingBalanceDisplay = document.getElementById('outstandingBalanceDisplay');
                outstandingBalanceDisplay.innerText = `GHS ${currentBalance.toFixed(2)}`;
                outstandingBalanceDisplay.classList.remove('text-red-600', 'text-green-600', 'text-gray-500');
                outstandingBalanceDisplay.classList.add(currentBalance > 0 ? 'text-red-600' : 'text-green-600');
                if (currentBalance === 0) outstandingBalanceDisplay.classList.add('text-gray-500'); // Neutral for 0 balance

                let tableHtml = '';
                let mobileCardsHtml = '';

                if (transactionsWithBalance.length > 0) {
                    tableHtml = transactionsWithBalance.map(t => `
                        <tr>
                            <td class="py-3 px-4 border-b border-gray-200">${new Date(t.transactionDate).toLocaleDateString()}</td>
                            <td class="py-3 px-4 border-b border-gray-200">${t.description || t.paymentId || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-red-600">${t.type === 'debit' ? t.amount.toFixed(2) : '0.00'}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-green-600">${t.type === 'credit' ? t.amount.toFixed(2) : '0.00'}</td>
                            <td class="py-3 px-4 border-b border-gray-200 ${t.runningBalance > 0 ? 'text-red-600' : 'text-green-600'}">${t.runningBalance.toFixed(2)}</td>
                        </tr>
                    `).join('');

                    mobileCardsHtml = transactionsWithBalance.map(t => `
                        <div class="fees-transaction-card ${t.type === 'debit' ? 'debit' : 'credit'}">
                            <h5>${t.description || t.paymentId || 'Transaction'}</h5>
                            <p><strong>Date:</strong> ${new Date(t.transactionDate).toLocaleDateString()}</p>
                            <p><strong>Amount:</strong> <span class="amount ${t.type === 'debit' ? 'debit' : 'credit'}">GHS ${t.amount.toFixed(2)} (${t.type === 'debit' ? 'Charged' : 'Paid'})</span></p>
                            <p><strong>Balance:</strong> <span class="amount ${t.runningBalance > 0 ? 'debit' : 'credit'}">GHS ${t.runningBalance.toFixed(2)}</span></p>
                        </div>
                    `).join('');

                } else {
                    tableHtml = `<tr><td colspan="5" class="py-8 text-center text-gray-600 bg-gray-50">No transactions found for the selected semester.</td></tr>`;
                    mobileCardsHtml = `<p class="text-gray-600 text-center py-8">No transactions found for the selected semester.</p>`;
                }

                document.getElementById('feesTransactionsTableBody').innerHTML = tableHtml;
                document.getElementById('feesTransactionsMobileCards').innerHTML = mobileCardsHtml;
            };

            feesSemesterFilter.addEventListener('change', renderFeesStatement);
            renderFeesStatement(); // Initial render

            // PDF Export
            document.getElementById('exportPdfBtn').addEventListener('click', () => {
                showLoading("Exporting to PDF...");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(22);
                doc.setTextColor(0, 100, 0);
                doc.text("Fees Statement", doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text("Prince Alex Design University", doc.internal.pageSize.getWidth() / 2, 27, { align: "center" });
                doc.setDrawColor(0, 100, 0);
                doc.setLineWidth(0.5);
                doc.line(10, 32, doc.internal.pageSize.getWidth() - 10, 32);

                let yPos = 40;
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Name: ${studentName}`, 15, yPos);
                doc.text(`Student ID: ${studentRegNo}`, 15, yPos + 7);
                doc.text(`Program: ${studentProgramme}`, 15, yPos + 14);
                doc.text(`Year of Study: ${studentYear}`, 15, yPos + 21);
                yPos += 30;

                const currentCharges = parseFloat(document.getElementById('totalChargesDisplay').innerText.replace('GHS ', ''));
                const currentPayments = parseFloat(document.getElementById('totalPaymentsDisplay').innerText.replace('GHS ', ''));
                const currentBalance = parseFloat(document.getElementById('outstandingBalanceDisplay').innerText.replace('GHS ', ''));

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total Charges: GHS ${currentCharges.toFixed(2)}`, 15, yPos + 5);
                doc.text(`Total Payments: GHS ${currentPayments.toFixed(2)}`, 15, yPos + 12);
                doc.setTextColor(currentBalance > 0 ? 220 : 0, currentBalance > 0 ? 38 : 100, currentBalance > 0 ? 38 : 0); // Red or Green
                doc.text(`Outstanding Balance: GHS ${currentBalance.toFixed(2)}`, 15, yPos + 19);
                doc.setTextColor(0, 0, 0); // Reset color

                doc.autoTable({
                    startY: yPos + 30,
                    head: [['Date', 'Description', 'Debit (GHS)', 'Credit (GHS)', 'Balance (GHS)']],
                    body: transactionsWithBalance.map(t => [
                        new Date(t.transactionDate).toLocaleDateString(),
                        t.description || t.paymentId || 'N/A',
                        t.type === 'debit' ? t.amount.toFixed(2) : '0.00',
                        t.type === 'credit' ? t.amount.toFixed(2) : '0.00',
                        t.runningBalance.toFixed(2)
                    ]),
                    theme: 'striped',
                    headStyles: { fillColor: [0, 100, 0], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 2, overflow: 'linebreak' },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 50 },
                        2: { cellWidth: 25 },
                        3: { cellWidth: 25 },
                        4: { cellWidth: 25 }
                    }
                });

                doc.save(`${studentName}_Fees_Statement.pdf`);
                showCustomModal("Export Successful", "‚úÖ Fees statement exported as PDF!");
                hideLoading();
            });

            // Excel Export (CSV simulation)
            document.getElementById('exportExcelBtn').addEventListener('click', () => {
                showLoading("Exporting to Excel...");
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Date,Description,Debit (GHS),Credit (GHS),Balance (GHS)\n";

                transactionsWithBalance.forEach(t => {
                    const row = [
                        new Date(t.transactionDate).toLocaleDateString(),
                        `"${(t.description || t.paymentId || 'N/A').replace(/"/g, '""')}"`, // Handle commas/quotes in description
                        t.type === 'debit' ? t.amount.toFixed(2) : '0.00',
                        t.type === 'credit' ? t.amount.toFixed(2) : '0.00',
                        t.runningBalance.toFixed(2)
                    ].join(',');
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${studentName}_Fees_Statement.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showCustomModal("Export Successful", "‚úÖ Fees statement exported as CSV (Excel compatible)!");
                hideLoading();
            });

        } catch (error) {
            console.error("Error loading fees statement:", error);
            content.innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load fees statement. Please try again later.</div>`;
        }
        hideLoading();
    }


    // 10. Receipts
    async function loadReceipts() {
        showLoading("Loading receipts...");
        const content = document.getElementById("dashboardContent");
        const receiptsCollectionRef = collection(db, `receipts`);

        // Initial Render with placeholders
        const placeholderReceiptsHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h4 class="text-xl font-bold text-green-800 mb-4">Your Payment Receipts (Loading...)</h4>
                <div class="flex flex-col space-y-4">
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                        <div>
                            <p class="font-semibold text-gray-800">Payment of GHS 500.00 (Placeholder)</p>
                            <p class="text-sm text-gray-600">Receipt No: R-P-001</p>
                            <p class="text-sm text-gray-600">Date: 2025-09-01</p>
                        </div>
                        <button class="bg-gray-400 text-white font-bold py-2 px-4 rounded-md cursor-not-allowed">
                            <i class="fas fa-download mr-2"></i> Download
                        </button>
                    </div>
                     <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                        <div>
                            <p class="font-semibold text-gray-800">Payment of GHS 1,200.00 (Placeholder)</p>
                            <p class="text-sm text-gray-600">Receipt No: R-P-002</p>
                            <p class="text-sm text-gray-600">Date: 2025-09-15</p>
                        </div>
                        <button class="bg-gray-400 text-white font-bold py-2 px-4 rounded-md cursor-not-allowed">
                            <i class="fas fa-download mr-2"></i> Download
                        </button>
                    </div>
                    <tr>
                        <td colspan="2" class="py-8 text-center text-gray-600 bg-gray-50">
                            <i class="fas fa-receipt text-4xl text-gray-400 mb-2"></i>
                            <p>Loading your official receipts...</p>
                        </td>
                    </tr>
                </div>
            </div>
        `;

        const receiptsContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Payment Receipts</h3>
                <p class="text-gray-700">Download your payment receipts here. Receipts load dynamically.</p>
            </div>
            <div id="dynamicReceiptsContainer">
                ${placeholderReceiptsHtml}
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Receipts") + receiptsContentHtml;
        // End Initial Render

        try {
            const receiptsQuery = query(receiptsCollectionRef, where("studentId", "==", currentUserId), orderBy("date", "desc"));
            const receiptsSnapshot = await getDocs(receiptsQuery);
            const receipts = receiptsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let dynamicReceiptsHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <p class="text-gray-600 text-center py-4">
                        <i class="fas fa-file-invoice-dollar text-4xl text-gray-400 mb-2"></i>
                        <p>No receipts available at this time. Payments will appear here once recorded.</p>
                    </p>
                </div>`;
            if (receipts.length > 0) {
                dynamicReceiptsHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <div class="flex flex-col space-y-4">
                            ${receipts.map(r => `
                                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-gray-800">Payment of GHS ${r.amount.toFixed(2)}</p>
                                        <p class="text-sm text-gray-600">Receipt No: ${r.receiptNo}</p>
                                        <p class="text-sm text-gray-600">Date: ${new Date(r.date).toLocaleDateString()}</p>
                                    </div>
                                    <a href="${r.fileURL}" target="_blank" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                                        <i class="fas fa-download mr-2"></i> Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            document.getElementById("dynamicReceiptsContainer").innerHTML = dynamicReceiptsHtml;
        } catch (error) {
            console.error("Error loading receipts:", error);
            document.getElementById("dynamicReceiptsContainer").innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load receipts. Please try again later.</div>`;
        }
        hideLoading();
    }

    // 11. Exam Card
    async function loadExamCard() {
        showLoading("Loading exam card...");
        const content = document.getElementById("dashboardContent");
        const examCardsCollectionRef = collection(db, `examCards`);

        // Initial Render with placeholders
        const placeholderExamCardHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                <h4 class="text-xl font-bold text-green-800 mb-4">Your Exam Card (Loading...)</h4>
                <div class="flex flex-col space-y-4">
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                        <div>
                            <p class="font-semibold text-gray-800">Exam Card for Fall 2025 (Placeholder)</p>
                            <p class="text-sm text-gray-600">Generated on: Pending</p>
                        </div>
                        <button class="bg-gray-400 text-white font-bold py-2 px-4 rounded-md cursor-not-allowed">
                            <i class="fas fa-download mr-2"></i> Download
                        </button>
                    </div>
                    <tr>
                        <td colspan="2" class="py-8 text-center text-gray-600 bg-gray-50">
                            <i class="fas fa-id-card-alt text-4xl text-gray-400 mb-2"></i>
                            <p>Loading your official exam cards...</p>
                        </td>
                    </tr>
                </div>
            </div>
        `;

        const examCardContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Exam Card</h3>
                <p class="text-gray-700">Download your official exam card for the current semester. Exam cards load dynamically.</p>
            </div>
            <div id="dynamicExamCardContainer">
                ${placeholderExamCardHtml}
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Exam Card") + examCardContentHtml;
        // End Initial Render

        try {
            const examCardsQuery = query(examCardsCollectionRef, where("studentId", "==", currentUserId), orderBy("dateGenerated", "desc"));
            const examCardsSnapshot = await getDocs(examCardsQuery);
            const examCards = examCardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let dynamicExamCardHtml = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <p class="text-gray-600 text-center py-4">
                        <i class="fas fa-credit-card text-4xl text-gray-400 mb-2"></i>
                        <p>No exam card available for this semester. Check for updates from the exams office.</p>
                    </p>
                </div>`;
            if (examCards.length > 0) {
                dynamicExamCardHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <div class="flex flex-col space-y-4">
                            ${examCards.map(ec => `
                                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                                    <div>
                                        <p class="font-semibold text-gray-800">Exam Card for ${ec.semester}</p>
                                        <p class="text-sm text-gray-600">Generated on: ${new Date(ec.dateGenerated).toLocaleDateString()}</p>
                                    </div>
                                    <a href="${ec.fileURL}" target="_blank" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                                        <i class="fas fa-download mr-2"></i> Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            document.getElementById("dynamicExamCardContainer").innerHTML = dynamicExamCardHtml;
        } catch (error) {
            console.error("Error loading exam card:", error);
            document.getElementById("dynamicExamCardContainer").innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load exam card. Please try again later.</div>`;
        }
        hideLoading();
    }

    // 12. Hostels/Accommodation
    async function loadHostels() {
        showLoading("Loading accommodation options...");
        const content = document.getElementById("dashboardContent");
        const hostelSettingsDocRef = doc(db, `settings`, `hostelBooking`);
        const hostelsCollectionRef = collection(db, `hostels`);
        const accommodationRequestsCollectionRef = collection(db, `accommodationRequests`);

        // Initial Render with placeholders for activated state
        const placeholderHostelOptionsHtml = `
            <option value="">-- Select a Hostel --</option>
            <option value="placeholder1">Grand View Hall (Price: GHS 2500.00, Occupancy: 2 beds) - Available Beds: 5 (Placeholder)</option>
            <option value="placeholder2">Riverside Dorms (Price: GHS 1800.00, Occupancy: 4 beds) - Available Beds: 10 (Placeholder)</option>
        `;
        const placeholderBookingHistoryHtml = `
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-green-100 text-green-800">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold">Hostel</th>
                            <th class="py-3 px-4 text-left font-semibold">Date Requested</th>
                            <th class="py-3 px-4 text-left font-semibold">Status</th>
                            <th class="py-3 px-4 text-left font-semibold">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="py-3 px-4 border-b border-gray-200 text-gray-500">Grand View Hall (Placeholder)</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-gray-500">2025-08-01</td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Pending</span>
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200 text-gray-500">GHS 2500.00</td>
                        </tr>
                        <tr>
                            <td colspan="4" class="py-8 text-center text-gray-600 bg-gray-50">
                                <i class="fas fa-bed text-4xl text-gray-400 mb-2"></i>
                                <p>Loading your booking history...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

        let hostelsContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Hostel Accommodation</h3>
                <p class="text-gray-700">Explore your on-campus accommodation options and manage your hostel bookings.</p>
            </div>
            <div id="dynamicHostelContent">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h4 class="text-xl font-bold text-green-800 mb-4">Book a Hostel Room (Loading...)</h4>
                    <p class="text-gray-700 mb-6">Select an available hostel from the dropdown below and submit your booking request. Ensure you review the details carefully.</p>
                    <form id="book-hostel-form-placeholder">
                        <div class="flex flex-col mb-4">
                            <label for="hostel-select-placeholder" class="text-gray-600 font-medium mb-1">Choose a Hostel</label>
                            <select id="hostel-select-placeholder" name="hostelId" class="p-3 border rounded-lg bg-gray-100 cursor-not-allowed" disabled>
                                ${placeholderHostelOptionsHtml}
                            </select>
                            <p id="hostel-details-placeholder" class="text-sm text-gray-600 mt-2">Price: Loading... | Max Occupants: Loading... | Available: Loading...</p>
                        </div>
                        <button type="submit" class="bg-gray-400 text-white font-bold py-3 px-8 rounded-lg text-lg cursor-not-allowed shadow-lg" disabled>
                            <i class="fas fa-spinner animate-spin mr-2"></i> Loading Booking Form...
                        </button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                    <h4 class="text-xl font-bold text-green-800 mb-4">Your Booking History (Loading...)</h4>
                    ${placeholderBookingHistoryHtml}
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Accommodation") + hostelsContentHtml;
        // End Initial Render

        try {
            const hostelSettingsSnap = await getDoc(hostelSettingsDocRef);
            const isBookingActivated = hostelSettingsSnap.exists() ? hostelSettingsSnap.data().isActivated : false;

            let dynamicHostelContentHtml = '';

            if (isBookingActivated) {
                const hostelsSnapshot = await getDocs(hostelsCollectionRef);
                const hostels = hostelsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const accommodationRequestsQuery = query(accommodationRequestsCollectionRef, where("studentId", "==", currentUserId), orderBy("dateRequested", "desc"));
                const accommodationRequestsSnapshot = await getDocs(accommodationRequestsQuery);
                const userBookings = accommodationRequestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let dynamicHostelOptionsHtml = '';
                if (hostels.length > 0) {
                    dynamicHostelOptionsHtml = hostels.map(h => `
                        <option value="${h.id}" data-price="${h.price}" data-occupants="${h.maxOccupants}" data-name="${h.name}" data-availablebeds="${h.availableBeds}">
                            ${h.name} (Price: GHS ${h.price.toFixed(2)}, Occupancy: ${h.maxOccupants} beds) - Available Beds: ${h.availableBeds}
                        </option>
                    `).join('');
                } else {
                    dynamicHostelOptionsHtml = `<option value="">No hostels available</option>`;
                }

                let dynamicBookingHistoryHtml = `<p class="text-gray-600 text-center py-4">You have no previous hostel bookings. Start your journey! üéí</p>`;
                if (userBookings.length > 0) {
                    dynamicBookingHistoryHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-green-100 text-green-800">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold">Hostel</th>
                                        <th class="py-3 px-4 text-left font-semibold">Date Requested</th>
                                        <th class="py-3 px-4 text-left font-semibold">Status</th>
                                        <th class="py-3 px-4 text-left font-semibold">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${userBookings.map(booking => `
                                        <tr>
                                            <td class="py-3 px-4 border-b border-gray-200">${booking.hostelName || 'N/A'}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">${new Date(booking.dateRequested).toLocaleDateString()}</td>
                                            <td class="py-3 px-4 border-b border-gray-200">
                                                <span class="px-3 py-1 rounded-full text-xs font-semibold
                                                    ${booking.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                                                      booking.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                                      'bg-red-100 text-red-800'}">
                                                    ${booking.status}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 border-b border-gray-200">GHS ${booking.hostelPrice ? booking.hostelPrice.toFixed(2) : 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                dynamicHostelContentHtml += `
                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Book a Hostel Room</h4>
                        <p class="text-gray-700 mb-6">Select an available hostel from the dropdown below and submit your booking request. Ensure you review the details carefully.</p>
                        <form id="book-hostel-form">
                            <div class="flex flex-col mb-4">
                                <label for="hostel-select" class="text-gray-600 font-medium mb-1">Choose a Hostel</label>
                                <select id="hostel-select" name="hostelId" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200 w-full" required>
                                    <option value="">-- Select a Hostel --</option>
                                    ${dynamicHostelOptionsHtml}
                                </select>
                                <p id="hostel-details" class="text-sm text-gray-600 mt-2"></p>
                            </div>
                            <button type="submit" id="bookHostelBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg" ${hostels.length === 0 ? 'disabled' : ''}>
                                <i class="fas fa-bed mr-2"></i> Book Now
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-t-4 border-green-600">
                        <h4 class="text-xl font-bold text-green-800 mb-4">Your Booking History</h4>
                        ${dynamicBookingHistoryHtml}
                    </div>
                `;
            } else {
                dynamicHostelContentHtml += `
                    <div class="bg-red-100 p-6 rounded-xl shadow-md border border-red-300 text-red-800 text-center">
                        <h4 class="text-xl font-bold mb-2">Hostel Booking Currently Deactivated üö´</h4>
                        <p class="text-lg">Hostel room booking is currently **deactivated** by the administration. Please check back later or contact the accommodation office for more information.</p>
                        <i class="fas fa-exclamation-circle text-5xl mt-4"></i>
                    </div>
                `;
            }
            document.getElementById("dynamicHostelContent").innerHTML = dynamicHostelContentHtml;

            if (isBookingActivated) {
                const hostelSelect = document.getElementById('hostel-select');
                if (hostelSelect) {
                    hostelSelect.addEventListener('change', function() {
                        const selectedOption = hostelSelect.options[hostelSelect.selectedIndex];
                        const hostelDetailsDiv = document.getElementById('hostel-details');
                        if (selectedOption && selectedOption.value) {
                            const price = selectedOption.dataset.price;
                            const occupants = selectedOption.dataset.occupants;
                            const availableBeds = selectedOption.dataset.availablebeds;
                            hostelDetailsDiv.innerHTML = `<strong>Price:</strong> GHS ${parseFloat(price).toFixed(2)} per academic year | <strong>Max Occupants:</strong> ${occupants} | <strong>Available:</strong> ${availableBeds} beds`;
                        } else {
                            hostelDetailsDiv.innerText = '';
                        }
                    });
                }
                const bookHostelForm = document.getElementById('book-hostel-form');
                if (bookHostelForm) {
                    bookHostelForm.addEventListener('submit', bookHostel);
                }
            }

        } catch (error) {
            console.error("Error loading hostels:", error);
            document.getElementById("dynamicHostelContent").innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load accommodation options. Please try again later.</div>`;
        }
        hideLoading();
    }

    async function bookHostel(event) {
        event.preventDefault();
        const bookHostelBtn = document.getElementById('bookHostelBtn');
        const hostelSelect = document.getElementById('hostel-select');
        const selectedOption = hostelSelect.options[hostelSelect.selectedIndex];
        const selectedHostelId = selectedOption.value;

        if (!selectedHostelId) {
            await showCustomModal("Error", "Please select a hostel to book.");
            return;
        }

        const confirmBooking = await confirm("Are you sure you want to book this hostel room?");
        if (!confirmBooking) return;

        setButtonLoading(bookHostelBtn, true);
        const accommodationRequestsCollectionRef = collection(db, `accommodationRequests`);
        const hostelsCollectionRef = collection(db, `hostels`);
        const hostelDocRef = doc(db, hostelsCollectionRef, selectedHostelId);

        try {
            // Fetch hostel details to save with the booking request
            const hostelSnap = await getDoc(hostelDocRef);
            if (!hostelSnap.exists()) {
                throw new Error("Selected hostel not found.");
            }
            const hostelData = hostelSnap.data();

            if (hostelData.availableBeds <= 0) {
                 await showCustomModal("Booking Failed", "This hostel currently has no available beds.");
                 return;
            }

            // Check if student already has an active booking
            const existingBookingsQuery = query(accommodationRequestsCollectionRef, where("studentId", "==", currentUserId), where("status", "in", ["Pending", "Approved"]));
            const existingBookingsSnapshot = await getDocs(existingBookingsQuery);

            if (!existingBookingsSnapshot.empty) {
                await showCustomModal("Booking Failed", "You already have an active or pending hostel booking.");
                return;
            }

            await addDoc(accommodationRequestsCollectionRef, {
                studentId: currentUserId,
                hostelId: selectedHostelId,
                hostelName: hostelData.name, // Store name for history display
                hostelPrice: hostelData.price, // Store price for history display
                dateRequested: new Date().toISOString(),
                status: 'Pending' // Initial status
            });

            // Decrement available beds
            await updateDoc(hostelDocRef, {
                availableBeds: Math.max(0, hostelData.availableBeds - 1)
            });

            await showCustomModal("Booking Submitted", `‚úÖ Your request for ${hostelData.name} has been submitted! You will be notified once it's processed.`);
            loadHostels(); // Reload the section to update UI and history
        } catch (error) {
            console.error("Error submitting accommodation request:", error);
            await showCustomModal("Submission Failed", `Failed to submit request: ${error.message}. Please try again.`);
        } finally {
            setButtonLoading(bookHostelBtn, false);
        }
    }


    // 13. Announcements
    async function loadAnnouncements() {
        showLoading("Loading announcements...");
        const content = document.getElementById("dashboardContent");
        const announcementsCollectionRef = collection(db, `announcements`);

        // Initial Render with placeholders
        const placeholderAnnouncementsHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                <p class="text-sm text-gray-500 mb-2">2025-08-01</p>
                <h4 class="text-xl font-bold text-green-800 mb-2">Welcome to the New Academic Year! (Placeholder)</h4>
                <p class="text-gray-700">A warm welcome to all new and returning students! We're excited for a productive year ahead.</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                <p class="text-sm text-gray-500 mb-2">2025-07-25</p>
                <h4 class="text-xl font-bold text-green-800 mb-2">Course Registration Open Soon (Placeholder)</h4>
                <p class="text-gray-700">Get ready to register for your courses! Check the academic calendar for specific dates and deadlines.</p>
            </div>
            <tr>
                <td colspan="2" class="py-8 text-center text-gray-600 bg-gray-50">
                    <i class="fas fa-bullhorn text-4xl text-gray-400 mb-2"></i>
                    <p>Loading the latest announcements...</p>
                </td>
            </tr>
        `;

        const announcementsContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Announcements</h3>
                <p class="text-gray-700">Stay up to date with the latest news and announcements from the university. Announcements load dynamically.</p>
            </div>
            <div id="dynamicAnnouncementsContainer" class="space-y-4">
                ${placeholderAnnouncementsHtml}
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Announcements") + announcementsContentHtml;
        // End Initial Render

        try {
            const announcementsQuery = query(announcementsCollectionRef, orderBy("date", "desc"));
            const announcementsSnapshot = await getDocs(announcementsQuery);
            const announcements = announcementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let dynamicAnnouncementsHtml = `<p class="text-gray-600 text-center py-4">No announcements at this time. Stay tuned for updates! üéâ</p>`;
            if (announcements.length > 0) {
                dynamicAnnouncementsHtml = `<div class="space-y-4">${announcements.map(ann => `
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                        <p class="text-sm text-gray-500 mb-2">${new Date(ann.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                        <h4 class="text-xl font-bold text-green-800 mb-2">${ann.title}</h4>
                        <p class="text-gray-700">${ann.message}</p>
                    </div>
                `).join('')}</div>`;
            }
            document.getElementById("dynamicAnnouncementsContainer").innerHTML = dynamicAnnouncementsHtml;
        } catch (error) {
            console.error("Error loading announcements:", error);
            document.getElementById("dynamicAnnouncementsContainer"].innerHTML = `<div class="bg-red-100 p-4 rounded-md text-red-700">Failed to load announcements. Please try again later.</div>`;
        }
        hideLoading();
    }

    // 14. Settings
    async function loadSettings() {
        showLoading("Loading settings...");
        const content = document.getElementById("dashboardContent");

        // Initial Render with placeholders
        const settingsContentHtml = `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-4">Settings</h3>
                <p class="text-gray-700 mb-6">Manage your account settings and preferences.</p>
                <div class="space-y-8">
                    <div>
                        <h4 class="text-xl font-bold text-green-800 mb-2">Change Password</h4>
                        <form id="change-password-form">
                            <div class="flex flex-col mb-4">
                                <label for="new-password" class="text-gray-600 font-medium mb-1">New Password</label>
                                <input type="password" id="new-password" name="new-password" placeholder="Enter new password" required class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            </div>
                            <div class="flex flex-col mb-4">
                                <label for="confirm-new-password" class="text-gray-600 font-medium mb-1">Confirm New Password</label>
                                <input type="password" id="confirm-new-password" name="confirm-new-password" placeholder="Confirm new password" required class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                            </div>
                            <button type="submit" id="changePasswordBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">Change Password</button>
                        </form>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-red-800 mb-2">Delete Account</h4>
                        <p class="text-gray-700 mb-4">Permanently delete your account and all associated data. This action is irreversible.</p>
                        <button onclick="deleteAccount()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">Delete Account</button>
                    </div>
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h4 class="text-xl font-bold text-green-800 mb-2">Privacy Policy & Terms of Service</h4>
                        <p class="text-gray-700">Review our <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a> and <a href="#" class="text-blue-600 hover:underline">Terms of Service</a> to understand how your data is handled.</p>
                    </div>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Settings") + settingsContentHtml;
        document.getElementById('change-password-form').addEventListener('submit', changePassword);
        // End Initial Render

        // No dynamic data fetching for settings in this current iteration, so hideLoading immediately.
        hideLoading();
    }

    async function changePassword(event) {
        event.preventDefault();
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        const changePasswordBtn = document.getElementById('changePasswordBtn');

        if (newPassword !== confirmNewPassword) {
            await showCustomModal("Error", "New passwords do not match.");
            return;
        }

        if (newPassword.length < 6) {
            await showCustomModal("Error", "Password must be at least 6 characters long.");
            return;
        }

        const confirmChange = await confirm("Are you sure you want to change your password?");
        if (!confirmChange) return;

        setButtonLoading(changePasswordBtn, true);
        const user = auth.currentUser;

        try {
            await updatePassword(user, newPassword);
            await showCustomModal("Password Changed", "‚úÖ Your password has been successfully changed.");
            document.getElementById('change-password-form').reset();
        } catch (error) {
            console.error("Error changing password:", error);
            await showCustomModal("Change Failed", "Failed to change password. Please log out and log in again, then try changing your password.");
        } finally {
            setButtonLoading(changePasswordBtn, false);
        }
    }

    async function deleteAccount() {
        const confirmDelete = await confirm("Are you absolutely sure you want to delete your account? This action is irreversible and all your data will be lost.");
        if (!confirmDelete) return;

        const confirmFinal = await confirm("FINAL WARNING: All data will be permanently deleted. Are you certain?");
        if (!confirmFinal) return;

        showLoading("Deleting account...");
        const user = auth.currentUser;
        try {
            // Delete associated Firestore data
            const studentDocRef = doc(db, `students`, user.uid);
            const registrationsDocRef = doc(db, `registrations`, user.uid); // This one is deprecated by subcollection but keep for robustness if old data exists
            const feesDocRef = doc(db, `fees`, user.uid);
            const graduationRequestDocRef = doc(db, `graduationRequests`, user.uid);
            const clearanceRequestDocRef = doc(db, `clearanceRequests`, user.uid);
            const accommodationRequestDocRef = doc(db, `accommodationRequests`, user.uid); // Check for a direct document

            // Query and delete documents from subcollections and main collections
            const gradesQuery = query(collection(db, `grades`), where("studentId", "==", user.uid));
            const receiptsQuery = query(collection(db, `receipts`), where("studentId", "==", user.uid));
            const examCardsQuery = query(collection(db, `examCards`), where("studentId", "==", user.uid));
            const registeredCoursesQuery = query(collection(db, `students`, user.uid, `registeredCourses`));
            const accommodationRequestsUserQuery = query(collection(db, `accommodationRequests`), where("studentId", "==", user.uid));


            const gradesSnapshot = await getDocs(gradesQuery);
            const receiptsSnapshot = await getDocs(receiptsQuery);
            const examCardsSnapshot = await getDocs(examCardsQuery);
            const registeredCoursesSnapshot = await getDocs(registeredCoursesQuery);
            const accommodationRequestsUserSnapshot = await getDocs(accommodationRequestsUserQuery);

            const deletePromises = [
                deleteDoc(studentDocRef).catch(e => console.warn("Failed to delete student doc:", e)),
                deleteDoc(registrationsDocRef).catch(e => console.warn("Failed to delete registrations doc:", e)), // Deprecated but safe to keep for old data
                deleteDoc(feesDocRef).catch(e => console.warn("Failed to delete fees doc:", e)),
                deleteDoc(graduationRequestDocRef).catch(e => console.warn("Failed to delete graduation request doc:", e)),
                deleteDoc(clearanceRequestDocRef).catch(e => console.warn("Failed to delete clearance request doc:", e)),
                deleteDoc(accommodationRequestDocRef).catch(e => console.warn("Failed to delete direct accommodation request doc:", e)) // For direct documents, if any
            ];

            gradesSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete grade doc:", e))));
            receiptsSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete receipt doc:", e))));
            examCardsSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete exam card doc:", e))));
            registeredCoursesSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete registered course doc:", e))));
            accommodationRequestsUserSnapshot.forEach(d => deletePromises.push(deleteDoc(d.ref).catch(e => console.warn("Failed to delete accommodation request doc:", e))));


            await Promise.all(deletePromises);

            // Delete the user from Firebase Authentication
            await user.delete();
            await showCustomModal("Account Deleted", "‚úÖ Your account has been permanently deleted.");
        } catch (error) {
            console.error("Error deleting account:", error);
            await showCustomModal("Deletion Failed", "Failed to delete account. Please try again or contact support.");
            hideLoading();
        }
    }


    // Main navigation handler
    window.showDashboardSection = function(section) {
      const content = document.getElementById("dashboardContent");
      content.innerHTML = '';
      sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile
      switch (section) {
        case 'home':
          loadHome();
          break;
        case 'profile':
          loadProfile();
          break;
        case 'courseReg':
          loadCourseReg();
          break;
        case 'courses':
          loadCourses();
          break;
        case 'timetable':
          loadTimetable();
          break;
        case 'grades':
          loadGrades();
          break;
        case 'graduation':
          loadGraduation();
          break;
        case 'clearance':
          loadClearance();
          break;
        case 'fees':
          loadFees();
          break;
        case 'receipts':
          loadReceipts();
          break;
        case 'examCard':
          loadExamCard();
          break;
        case 'hostels':
          loadHostels();
          break;
        case 'announcements':
          loadAnnouncements();
          break;
        case 'settings':
          loadSettings();
          break;
        case 'examTimetable': // Alias for timetable
          loadTimetable();
          break;
        default:
          loadHome();
          break;
      }
    };
  </script>
</body>
</html>
