<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('myschoolgate.png') no-repeat center center fixed;
      background-size: cover;
    }
    .gpa-circle-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 20px auto;
    }
    .gpa-circle-svg {
      transform: rotate(-90deg);
    }
    .gpa-circle-bg {
      stroke: #e0e0e0;
      stroke-width: 10;
      fill: none;
    }
    .gpa-circle-progress {
      stroke: #006400; /* University green */
      stroke-width: 10;
      fill: none;
      transition: stroke-dasharray 0.5s ease-in-out;
    }
    .gpa-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      font-weight: bold;
      color: #006400;
    }
    .fees-balance-text.red {
        color: #dc2626; /* Tailwind red-600 */
    }
    .fees-balance-text.green {
        color: #16a34a; /* Tailwind green-600 */
    }
    /* Hide scrollbar for announcements panel, but allow scrolling */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    /* Rotate chevron */
    .rotate-180 {
        transform: rotate(180deg);
    }
  </style>
</head>
<body class="h-screen flex items-center justify-center">
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
    <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-300">
      <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
      <p id="modalMessage" class="mb-6 text-gray-700"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
        <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
      </div>
    </div>
  </div>

  <div id="authContainer" class="p-4 w-full h-full flex justify-center items-center">
    <div id="login-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5 active">
      <form id="login-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Login</h2>
        <div class="mb-6 text-left">
          <label for="email-login" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-login" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-login" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-login" placeholder="Enter your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="login-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Login</button>
        <div class="mt-6 text-sm flex justify-center space-x-4">
          <a href="#" onclick="showForm('signup')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Don't have an account? Sign Up</a>
          <a href="#" onclick="showForm('forgot-password')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Forgot Password?</a>
        </div>
      </form>
    </div>

    <div id="signup-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="signup-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Sign Up</h2>
        <div class="mb-6 text-left">
          <label for="full-name-signup" class="block text-gray-700 text-sm font-medium mb-2">Full Name</label>
          <input type="text" id="full-name-signup" placeholder="Enter your full name" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
        </div>
        <div class="mb-6 text-left">
          <label for="email-signup" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-signup" placeholder="Enter your email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-signup" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-signup" placeholder="Create a password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="confirm-password-signup" class="block text-gray-700 text-sm font-medium mb-2">Confirm Password</label>
          <input type="password" id="confirm-password-signup" placeholder="Confirm your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="confirm-password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="signup-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Sign Up</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Already have an account? Login</a>
        </div>
      </form>
    </div>

    <div id="forgot-password-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
      <form id="forgot-password-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Forgot Password</h2>
        <div class="mb-6 text-left">
          <label for="email-forgot" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-forgot" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          <p id="email-forgot-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="recover-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Recover Password</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Back to Login</a>
        </div>
      </form>
    </div>
  </div>

  <div id="dashboardContainer" class="hidden h-screen flex flex-col bg-gray-100 w-full">
    <header class="bg-white text-green-800 p-4 flex justify-between items-center shadow-md sticky top-0 z-10 lg:px-8">
      <img src="myschoollogo.png" alt="University Logo" class="h-12 w-auto">
      <button id="menuToggle" class="lg:hidden text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
        <i class="fas fa-bars"></i>
      </button>
      <div class="hidden lg:flex items-center space-x-4">
        <span class="text-lg font-semibold text-green-700">Welcome, <span id="userName" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
       <div class="lg:hidden flex items-center space-x-4">
        <span class="text-md font-semibold text-green-700">Welcome, <span id="userNameMobile" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <div class="flex flex-grow">
      <nav id="sidebar" class="w-64 bg-green-900 text-white p-6 flex flex-col space-y-2 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20 fixed inset-y-0 left-0 lg:relative lg:flex-shrink-0 lg:h-auto overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Quick Menu</h3>
        <a onclick="showDashboardSection('home')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i> Home</a>
        <a onclick="showDashboardSection('profile')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user mr-3"></i> Personal Profile</a>

        <a onclick="toggleSubmenu('academics-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-book mr-3"></i> Academics <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="academics-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('courseReg')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-alt mr-3"></i> Course Registration</a>
          <a onclick="showDashboardSection('courses')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-list-alt mr-3"></i> Available Courses</a>
          <a onclick="showDashboardSection('timetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-calendar-alt mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-list mr-3"></i> Grades & Transcripts</a>
          <a onclick="showDashboardSection('graduation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-graduation-cap mr-3"></i> Graduation Request</a>
          <a onclick="showDashboardSection('clearance')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-check-circle mr-3"></i> Clearance Request</a>
        </div>

        <a onclick="toggleSubmenu('finance-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-money-bill-wave mr-3"></i> Finance <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="finance-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('fees')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-credit-card mr-3"></i> Fees Statement</a>
          <a onclick="showDashboardSection('receipts')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-receipt mr-3"></i> Receipts</a>
          <a onclick="showDashboardSection('examCard')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-id-card mr-3"></i> Exam Card</a>
        </div>

        <a onclick="toggleSubmenu('exam-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-laptop-code mr-3"></i> Examination <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="exam-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('examTimetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clock mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-invoice mr-3"></i> Transcripts</a>
        </div>
        <a onclick="showDashboardSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-hotel mr-3"></i> Accommodation</a>
        <a onclick="showDashboardSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i> Announcements</a>
        <a onclick="showDashboardSection('settings')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-cog mr-3"></i> Settings</a>
      </nav>

      <main id="dashboardContent" class="flex-grow p-6 overflow-y-auto lg:ml-64 w-full">
        </main>
    </div>

    <footer class="bg-white text-gray-600 text-center p-4 text-sm shadow-inner mt-auto">
      2025 © Prince Alex Design University. All rights reserved.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, arrayUnion, arrayRemove, addDoc, getDocs, deleteDoc, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Firebase Config: Replace with your actual Firebase project details
    const hardcodedFirebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A", // This is a placeholder. Ensure your actual Firebase API Key is used.
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId;
    const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    if (firebaseConfigFromCanvas) {
        app = initializeApp(firebaseConfigFromCanvas);
    } else {
        // Fallback for local development if __firebase_config is not defined
        app = initializeApp(hardcodedFirebaseConfig);
    }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let currentUserData = null;

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const authContainer = document.getElementById('authContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const sidebar = document.getElementById('sidebar');

    // --- Custom Modal Functions (replaces alert/confirm) ---
    function showCustomModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        if (modalTitle) modalTitle.innerText = title;
        if (modalMessage) modalMessage.innerText = message;

        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(true);
            };
        }
        if (modalCancelBtn) {
            modalCancelBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(false);
            };
            modalCancelBtn.classList.toggle('hidden', !isConfirm); // Toggle visibility based on isConfirm
        }
        if (modal) modal.classList.remove('hidden'); // Show modal
      });
    }

    window.alert = (message) => showCustomModal('Alert', message); // Override alert
    window.confirm = (message) => showCustomModal('Confirm', message, true); // Override confirm
    // --- End Custom Modal Functions ---

    // Function to set button loading state
    function setButtonLoading(button, isLoading) {
      if (button) {
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<i class="fas fa-spinner animate-spin mr-2"></i>Loading...' : button.dataset.originalHtml;
      }
    }

    // Function to store original button HTML for loading state
    function storeOriginalButtonHtml() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.dataset.originalHtml = button.innerHTML;
      });
    }

    // Inline form validation utility
    function validateInput(inputElement, validationFn, errorMessageElement) {
        if (validationFn(inputElement.value)) {
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-300', 'focus:ring-green-500');
            errorMessageElement.classList.add('hidden');
            return true;
        } else {
            inputElement.classList.remove('border-gray-300', 'focus:ring-green-500');
            inputElement.classList.add('border-red-500');
            errorMessageElement.innerText = `❌ ${errorMessageElement.dataset.errorMessage || 'Invalid input.'}`;
            errorMessageElement.classList.remove('hidden');
            return false;
        }
    }

    // Email validation regex (basic)
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    // Password validation regex (at least 6 characters)
    const isValidPassword = (password) => password.length >= 6;


    // Function to show specific authentication form and hide others
    window.showForm = function(formId) {
      const forms = document.querySelectorAll('.form-wrapper');
      forms.forEach(form => {
        form.classList.remove('active');
        form.classList.add('opacity-0', 'invisible', 'translate-y-5');
      });
      const activeForm = document.getElementById(`${formId}-form-wrapper`);
      if (activeForm) {
        activeForm.classList.remove('opacity-0', 'invisible', 'translate-y-5');
        activeForm.classList.add('active');
        // Autofocus the first input in the new form
        const firstInput = activeForm.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      }
    };

    // This function runs once the DOM is fully loaded and before onAuthStateChanged fires its initial state.
    async function initializeAppUI() {
        storeOriginalButtonHtml(); // Store original button HTML for loading states
        loadingText.innerText = "Initializing session...";
        loadingOverlay.classList.remove('hidden');

        // Attach inline validation listeners
        attachFormValidationListeners();

        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                await signInAnonymously(auth);
                console.log("Signed in anonymously due to custom token failure.");
            }
        } else {
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                await showCustomModal("Error", "Failed to initialize anonymous session. Please refresh.");
            }
        }
    }

    window.onload = initializeAppUI;

    // --- Authentication Forms Event Listeners ---
    document.getElementById('login-form').addEventListener('submit', loginUser);
    document.getElementById('signup-form').addEventListener('submit', signupUser);
    document.getElementById('forgot-password-form').addEventListener('submit', recoverPassword);

    function attachFormValidationListeners() {
        // Login form
        const emailLogin = document.getElementById('email-login');
        const emailLoginError = document.getElementById('email-login-error');
        if (emailLogin) {
            emailLoginError.dataset.errorMessage = "Please enter a valid email address.";
            emailLogin.addEventListener('input', () => validateInput(emailLogin, isValidEmail, emailLoginError));
        }
        const passwordLogin = document.getElementById('password-login');
        const passwordLoginError = document.getElementById('password-login-error');
        if (passwordLogin) {
            passwordLoginError.dataset.errorMessage = "Password must be at least 6 characters.";
            passwordLogin.addEventListener('input', () => validateInput(passwordLogin, isValidPassword, passwordLoginError));
        }

        // Signup form
        const emailSignup = document.getElementById('email-signup');
        const emailSignupError = document.getElementById('email-signup-error');
        if (emailSignup) {
            emailSignupError.dataset.errorMessage = "Please enter a valid email address.";
            emailSignup.addEventListener('input', () => validateInput(emailSignup, isValidEmail, emailSignupError));
        }
        const passwordSignup = document.getElementById('password-signup');
        const passwordSignupError = document.getElementById('password-signup-error');
        if (passwordSignup) {
            passwordSignupError.dataset.errorMessage = "Password must be at least 6 characters long.";
            passwordSignup.addEventListener('input', () => validateInput(passwordSignup, isValidPassword, passwordSignupError));
        }
        const confirmPasswordSignup = document.getElementById('confirm-password-signup');
        const confirmPasswordSignupError = document.getElementById('confirm-password-signup-error');
        if (confirmPasswordSignup) {
            confirmPasswordSignupError.dataset.errorMessage = "Passwords do not match.";
            confirmPasswordSignup.addEventListener('input', () => {
                const match = passwordSignup.value === confirmPasswordSignup.value;
                validateInput(confirmPasswordSignup, () => match, confirmPasswordSignupError);
            });
        }

        // Forgot password form
        const emailForgot = document.getElementById('email-forgot');
        const emailForgotError = document.getElementById('email-forgot-error');
        if (emailForgot) {
            emailForgotError.dataset.errorMessage = "Please enter a valid email address.";
            emailForgot.addEventListener('input', () => validateInput(emailForgot, isValidEmail, emailForgotError));
        }
    }


    // --- Authentication Flow ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("User authenticated (from onAuthStateChanged):", user.email, user.uid);

        // Fetch or create user data from Firestore
        const profileDocRef = doc(db, `students`, currentUserId);
        const profileDocSnap = await getDoc(profileDocRef);

        if (profileDocSnap.exists()) {
          currentUserData = profileDocSnap.data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
        } else {
          await setDoc(profileDocRef, {
            email: user.email,
            name: user.email.split("@")[0],
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
          });
          currentUserData = (await getDoc(profileDocRef)).data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          console.log("Created basic user profile during dashboard load fallback.");
        }

        authContainer.classList.add('hidden');
        dashboardContainer.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');

        if (currentUserData.regNo === 'N/A' || currentUserData.programme === 'N/A' || currentUserData.dob === 'N/A' || currentUserData.gender === 'N/A') {
            await showCustomModal("Welcome", "Please complete your profile information.");
            showDashboardSection('profile');
        } else {
            showDashboardSection('home');
        }

      } else {
        authContainer.classList.remove('hidden');
        dashboardContainer.classList.add('hidden');
        loadingOverlay.classList.add('hidden');
        showForm('login');
      }
    });

    // Function to log in user
    async function loginUser(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('login-btn');
      const emailInput = document.getElementById("email-login");
      const passwordInput = document.getElementById("password-login");
      const emailError = document.getElementById('email-login-error');
      const passwordError = document.getElementById('password-login-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);

      if (!isEmailValid || !isPasswordValid) {
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(loginBtn, true);

      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        await showCustomModal("Login Success", "✅ Login successful! Redirecting...");
      } catch (error) {
        let errorMessage = "❌ Login failed.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = "❌ Invalid email or password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Login Failed", errorMessage);
        console.error("Login error:", error);
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }

    // Function to sign up new user
    async function signupUser(event) {
      event.preventDefault();
      const signupBtn = document.getElementById('signup-btn');
      const fullNameInput = document.getElementById("full-name-signup");
      const emailInput = document.getElementById("email-signup");
      const passwordInput = document.getElementById("password-signup");
      const confirmPasswordInput = document.getElementById("confirm-password-signup");

      const emailError = document.getElementById('email-signup-error');
      const passwordError = document.getElementById('password-signup-error');
      const confirmPasswordError = document.getElementById('confirm-password-signup-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);
      const passwordsMatch = (passwordInput.value === confirmPasswordInput.value);
      const isConfirmPasswordValid = validateInput(confirmPasswordInput, () => passwordsMatch, confirmPasswordError);

      if (!isEmailValid || !isPasswordValid || !isConfirmPasswordValid || !passwordsMatch) {
          if (!passwordsMatch) {
              confirmPasswordError.innerText = "❌ Passwords do not match!";
              confirmPasswordError.classList.remove('hidden');
              confirmPasswordInput.classList.add('border-red-500');
          }
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(signupBtn, true);

      const fullName = fullNameInput.value.trim();
      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const userDocRef = doc(db, `students`, user.uid);
        await setDoc(userDocRef, {
            email: user.email,
            name: fullName,
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
        });
        console.log("User signed up and profile created:", user.email);

        await showCustomModal("Signup Success", "✅ Signup successful! Please log in with your new account.");

        showForm('login');

      } catch (error) {
        let errorMessage = "❌ Signup failed.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "❌ Email already in use. Try logging in or recovering password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Invalid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "❌ Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Signup Failed", errorMessage);
        console.error("Signup error:", error);
      } finally {
        setButtonLoading(signupBtn, false);
      }
    }

    // Function to recover password
    async function recoverPassword(event) {
      event.preventDefault();
      const recoverBtn = document.getElementById('recover-btn');
      const emailInput = document.getElementById("email-forgot");
      const emailError = document.getElementById('email-forgot-error');
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      if (!isEmailValid) {
        await showCustomModal("Validation Error", "Please enter a valid email address.");
        return;
      }
      setButtonLoading(recoverBtn, true);
      const email = emailInput.value.trim().toLowerCase();
      try {
        await sendPasswordResetEmail(auth, email);
        await showCustomModal("Password Recovery", "✅ Password reset email sent! Check your inbox.");
      } catch (error) {
        let errorMessage = "❌ Failed to send password reset email.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "❌ No account found with that email.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Password Recovery Failed", errorMessage);
        console.error("Password recovery error:", error);
      } finally {
        setButtonLoading(recoverBtn, false);
      }
    }

    // --- Dashboard Specific Functions ---
    // Logout function
    window.confirmLogout = async function() {
      const response = await confirm("Are you sure you want to log out?");
      if (response) {
        try {
          loadingText.innerText = "Logging out...";
          loadingOverlay.classList.remove('hidden');
          await signOut(auth);
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error logging out. Please try again.");
          loadingOverlay.classList.add('hidden');
        }
      }
    };
    window.toggleSubmenu = function(id) {
      const submenu = document.getElementById(id);
      if (submenu) submenu.classList.toggle('hidden');
      const chevron = submenu.previousElementSibling.querySelector('.fa-chevron-down');
      if (chevron) {
        chevron.classList.toggle('rotate-180');
      }
    };
    document.getElementById('menuToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.toggle('-translate-x-full');
    });

    function generateBreadcrumb(currentSectionTitle) {
      return `<div class="text-sm text-gray-600 mb-6">
        <a onclick="showDashboardSection('home')" class="text-green-700 hover:underline cursor-pointer">Home</a>
        <span class="mx-2">/</span>
        <span class="font-semibold text-green-800">${currentSectionTitle}</span>
      </div>`;
    }

    function showLoading(text) {
        loadingText.innerText = text;
        loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
        loadingOverlay.classList.add('hidden');
    }

    // --- GPA Calculation Utility ---
    function calculateGPA(grades) {
        let totalPoints = 0;
        let totalUnits = 0;
        const gradeMap = { 'A': 4.0, 'B': 3.0, 'C': 2.0, 'D': 1.0, 'F': 0.0 };
        grades.forEach(g => {
            const courseUnit = g.courseUnit || 3;
            const gradePoint = gradeMap[g.grade] || 0;
            totalPoints += gradePoint * courseUnit;
            totalUnits += courseUnit;
        });
        return totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : "0.00";
    }

    // --- Section-Specific Loaders ---

    // 1. Home Dashboard
    async function loadHome() {
        showLoading("Loading dashboard summary...");
        const announcementsRef = collection(db, `announcements`);
        const gradesRef = collection(db, `grades`);
        const feesRef = collection(db, `fees`);
        const registrationsRef = doc(db, `registrations`, currentUserId);
        const content = document.getElementById("dashboardContent");

        try {
            // Fetch student profile
            const profileDocRef = doc(db, `students`, currentUserId);
            const profileSnap = await getDoc(profileDocRef);
            const studentData = profileSnap.exists() ? profileSnap.data() : {};
            const studentName = studentData.name || "Student";
            const studentProgramme = studentData.programme && studentData.programme !== 'N/A' ? studentData.programme : "Programme Not Set";
            const studentRegNo = studentData.regNo && studentData.regNo !== 'N/A' ? studentData.regNo : "Registration Number Not Set";
            const profilePhotoURL = studentData.profilePhotoURL || 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';

            // Fetch latest 3 announcements
            const announcementsQuery = query(announcementsRef, orderBy("date", "desc"), limit(3));
            const announcementsSnapshot = await getDocs(announcementsQuery);
            const announcements = announcementsSnapshot.docs.map(doc => doc.data());

            // Fetch fees data
            const feesDocRef = doc(db, feesRef, currentUserId);
            const feesSnapshot = await getDoc(feesDocRef);
            const feesData = feesSnapshot.exists() ? feesSnapshot.data() : { totalFees: 0, payments: [] };
            const totalPayments = feesData.payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = feesData.totalFees - totalPayments;
            const balanceColorClass = balance > 0 ? 'text-red-600' : 'text-green-600';
            const balanceText = balance !== 0 ? `GHS ${balance.toFixed(2)}` : `GHS 0.00 (Paid in Full)`;

            // Fetch grades
            const gradesQuery = query(gradesRef, where("studentId", "==", currentUserId));
            const gradesSnapshot = await getDocs(gradesQuery);
            const grades = gradesSnapshot.docs.map(doc => doc.data());
            const gpa = calculateGPA(grades);
            const latestGrade = grades.length > 0 ? grades.sort((a,b) => new Date(b.date) - new Date(a.date))[0] : null;

            // Fetch registrations to find upcoming deadlines
            const registrationsSnap = await getDoc(registrationsRef);
            const registrationsData = registrationsSnap.exists() ? registrationsSnap.data().courses : [];
            let upcomingDeadline = "No upcoming deadlines.";
            let registrationLink = `<button onclick="showDashboardSection('courseReg')" class="text-green-700 hover:underline">Register for Courses</button>`;
            const now = new Date();
            const futureDeadlines = registrationsData.filter(reg => new Date(reg.registrationDeadline) > now);
            if (futureDeadlines.length > 0) {
                futureDeadlines.sort((a,b) => new Date(a.registrationDeadline) - new Date(b.registrationDeadline));
                const nextDeadline = futureDeadlines[0];
                upcomingDeadline = `${nextDeadline.courseName} Registration Deadline: ${new Date(nextDeadline.registrationDeadline).toLocaleDateString()}`;
                registrationLink = `<a href="#" onclick="showDashboardSection('courseReg')" class="text-blue-500 hover:underline">View Registrations</a>`;
            }

            let announcementsHtml = `<p class="text-gray-600 text-center py-4">No new announcements at this time.</p>`;
            if (announcements.length > 0) {
                announcementsHtml = `<ul class="space-y-3">${announcements.map(ann => `
                    <li class="pb-2 border-b border-green-100 last:border-b-0">
                        <p class="text-sm text-gray-500">${new Date(ann.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p class="font-medium text-green-800">${ann.title}</p>
                        <p class="text-gray-700">${ann.message}</p>
                    </li>
                `).join('')}</ul>`;
            }

            const latestGradeHtml = latestGrade ? `Your latest grade is a **${latestGrade.grade}** in **${latestGrade.courseCode}**. ` : '';
            const gpaColor = gpa > 0 ? '#006400' : '#888888';
            const gpaProgress = gpa > 0 ? (gpa / 4 * 314) : 0;

            const homeContentHtml = `
                <div class="bg-green-100 p-6 rounded-xl shadow-lg flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6 mb-8">
                    <img src="${profilePhotoURL}" alt="Profile Photo" class="w-20 h-20 rounded-full border-4 border-white shadow-md">
                    <div class="text-center md:text-left">
                        <h2 class="text-2xl font-bold text-green-800">Welcome back, ${studentName}!</h2>
                        <p class="text-green-700 text-lg">${studentProgramme} - ${studentRegNo}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">Current GPA</h3>
                        <div class="gpa-circle-container">
                            <svg class="gpa-circle-svg" width="120" height="120">
                                <circle class="gpa-circle-bg" r="50" cx="60" cy="60"></circle>
                                <circle class="gpa-circle-progress" r="50" cx="60" cy="60" style="stroke-dasharray: ${gpaProgress}; stroke: ${gpaColor};"></circle>
                            </svg>
                            <span class="gpa-text" style="color: ${gpaColor};">${gpa}</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-2">${latestGradeHtml}</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">Outstanding Fees</h3>
                        <div class="my-6">
                            <i class="fas fa-money-bill-wave text-5xl ${balanceColorClass}"></i>
                        </div>
                        <p class="text-2xl font-bold ${balanceColorClass}">${balanceText}</p>
                        <p class="text-gray-600 text-sm mt-2">Check your fees statement for a full breakdown.</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">Next Deadline</h3>
                        <div class="my-6">
                            <i class="fas fa-calendar-alt text-5xl text-blue-600"></i>
                        </div>
                        <p class="text-xl font-bold text-gray-800">${upcomingDeadline}</p>
                        <p class="text-gray-600 text-sm mt-2">${registrationLink}</p>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h4 class="text-2xl font-semibold text-green-700 mb-4 flex items-center"><i class="fas fa-bullhorn mr-3"></i> Latest Announcements</h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 h-48 overflow-y-auto no-scrollbar">
                        ${announcementsHtml}
                    </div>
                </div>
            `;

            content.innerHTML = generateBreadcrumb('Dashboard Overview') + homeContentHtml;
        } catch (error) {
            console.error("Error loading home dashboard data:", error);
            await showCustomModal("Error", "Failed to load dashboard data. Please try again later.");
            content.innerHTML = generateBreadcrumb('Dashboard Overview') + `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Error!</strong><span class="block sm:inline"> Could not load dashboard data.</span></div>`;
        } finally {
            hideLoading();
        }
    }

    // 2. Personal Profile
    async function loadProfile() {
        showLoading("Loading personal profile...");
        const content = document.getElementById("dashboardContent");
        const profileDocRef = doc(db, `students`, currentUserId);
        try {
            const profileSnap = await getDoc(profileDocRef);
            const studentData = profileSnap.exists() ? profileSnap.data() : {};
            let profilePhotoURL = studentData.profilePhotoURL || 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';
            
            const profileHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Personal Profile</h2>
                    <form id="profile-form">
                        <div class="flex flex-col md:flex-row items-center mb-6 space-y-4 md:space-y-0 md:space-x-8">
                            <div class="flex-shrink-0">
                                <img id="profile-photo" src="${profilePhotoURL}" alt="Profile Photo" class="w-24 h-24 rounded-full object-cover border-4 border-green-200">
                                <input type="file" id="profile-photo-input" class="hidden" accept="image/*">
                                <button type="button" id="change-photo-btn" class="mt-2 text-sm text-green-700 hover:underline">Change Photo</button>
                            </div>
                            <div class="flex-grow w-full">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label class="block text-gray-700 font-semibold">Name:</label><p class="mt-1 p-2 bg-gray-100 rounded-md">${studentData.name || 'Not Set Yet'}</p></div>
                                    <div><label class="block text-gray-700 font-semibold">Email:</label><p class="mt-1 p-2 bg-gray-100 rounded-md">${studentData.email || 'Not Set Yet'}</p></div>
                                    <div><label class="block text-gray-700 font-semibold">Student ID:</label><p class="mt-1 p-2 bg-gray-100 rounded-md">${studentData.regNo || 'N/A'}</p></div>
                                    <div><label class="block text-gray-700 font-semibold">Programme:</label><p class="mt-1 p-2 bg-gray-100 rounded-md">${studentData.programme || 'Not Set Yet'}</p></div>
                                    <div><label class="block text-gray-700 font-semibold">Year of Study:</label><p class="mt-1 p-2 bg-gray-100 rounded-md">${studentData.yearOfStudy || 'Not Set Yet'}</p></div>
                                    <div><label class="block text-gray-700 font-semibold">Campus:</label><p class="mt-1 p-2 bg-gray-100 rounded-md">${studentData.campus || 'Main Campus'}</p></div>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-2xl font-semibold text-green-700 mb-4 mt-8">Contact Information (Editable)</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="dob" class="block text-gray-700">Date of Birth</label>
                                <input type="date" id="dob" value="${studentData.dob !== 'N/A' ? studentData.dob : ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="gender" class="block text-gray-700">Gender</label>
                                <select id="gender" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">Select Gender</option>
                                    <option value="Male" ${studentData.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${studentData.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${studentData.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label for="address" class="block text-gray-700">Address</label>
                                <input type="text" id="address" value="${studentData.address !== 'N/A' ? studentData.address : ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                            <button type="submit" id="update-profile-btn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Update Profile</button>
                        </div>
                    </form>
                </div>
            `;
            content.innerHTML = generateBreadcrumb('Personal Profile') + profileHtml;

            // Add event listeners for profile updates
            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
            document.getElementById('change-photo-btn').addEventListener('click', () => {
                document.getElementById('profile-photo-input').click();
            });
            document.getElementById('profile-photo-input').addEventListener('change', handleProfilePhotoUpload);

        } catch(e) {
            console.error("Error loading profile data:", e);
            content.innerHTML = generateBreadcrumb('Personal Profile') + `<p class="text-center text-gray-500 py-8">Error loading profile data.</p>`;
            await showCustomModal("Error", "Failed to load personal profile. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function handleProfileUpdate(event) {
        event.preventDefault();
        const updateBtn = document.getElementById('update-profile-btn');
        setButtonLoading(updateBtn, true);

        const dob = document.getElementById('dob').value;
        const gender = document.getElementById('gender').value;
        const address = document.getElementById('address').value;

        const profileDocRef = doc(db, `students`, currentUserId);
        try {
            await updateDoc(profileDocRef, {
                dob: dob || "N/A",
                gender: gender || "N/A",
                address: address || "N/A"
            });
            await showCustomModal("Success", "Profile updated successfully!");
        } catch (error) {
            console.error("Error updating profile:", error);
            await showCustomModal("Error", "Failed to update profile. Please try again.");
        } finally {
            setButtonLoading(updateBtn, false);
        }
    }

    async function handleProfilePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        showLoading("Uploading photo...");
        const photoRef = ref(storage, `profile_photos/${currentUserId}`);

        try {
            const snapshot = await uploadBytes(photoRef, file);
            const photoURL = await getDownloadURL(snapshot.ref);

            const profileDocRef = doc(db, `students`, currentUserId);
            await updateDoc(profileDocRef, {
                profilePhotoURL: photoURL
            });
            document.getElementById('profile-photo').src = photoURL;
            await showCustomModal("Success", "Profile photo updated successfully!");
        } catch (error) {
            console.error("Error uploading photo:", error);
            await showCustomModal("Error", "Failed to upload photo. Please try again.");
        } finally {
            hideLoading();
        }
    }
    
    // 3. Available Courses
    async function loadCourses() {
        showLoading("Loading available courses...");
        const content = document.getElementById("dashboardContent");
        const coursesRef = collection(db, `courses`);

        try {
            const coursesSnapshot = await getDocs(coursesRef);
            const allCourses = coursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let courseTableHtml = `<p class="text-center text-gray-500 py-8">No courses available at this time.</p>`;
            if (allCourses.length > 0) {
                courseTableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-gray-200 text-gray-700">
                                <tr>
                                    <th class="py-3 px-6 text-left">Course Code</th>
                                    <th class="py-3 px-6 text-left">Course Name</th>
                                    <th class="py-3 px-6 text-left">Credits</th>
                                    <th class="py-3 px-6 text-left">Lecturer</th>
                                    <th class="py-3 px-6 text-left">Schedule</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600">
                                ${allCourses.map(course => `
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6">${course.courseCode}</td>
                                    <td class="py-3 px-6">${course.courseName}</td>
                                    <td class="py-3 px-6">${course.credits}</td>
                                    <td class="py-3 px-6">${course.lecturer}</td>
                                    <td class="py-3 px-6">${course.schedule}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            content.innerHTML = generateBreadcrumb('Available Courses') + `<div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-3xl font-bold text-green-800 mb-6">Available Courses</h2>${courseTableHtml}</div>`;
        } catch (e) {
            console.error("Error loading available courses:", e);
            content.innerHTML = generateBreadcrumb('Available Courses') + `<p class="text-center text-gray-500 py-8">Error loading courses.</p>`;
            await showCustomModal("Error", "Failed to load available courses. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 4. Course Registration
    async function loadRegistrations() {
        showLoading("Loading course registration...");
        const content = document.getElementById("dashboardContent");
        const registrationsDocRef = doc(db, `registrations`, currentUserId);
        const coursesRef = collection(db, `courses`);

        try {
            const registrationsSnap = await getDoc(registrationsDocRef);
            const registeredCourses = registrationsSnap.exists() ? registrationsSnap.data().courses : [];
            const coursesSnapshot = await getDocs(coursesRef);
            const allCourses = coursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let registrationTableHtml = `
                <p class="text-center text-gray-500 py-8">You have not registered for any courses yet.</p>
                <div class="flex justify-center mt-4">
                    <button onclick="showDashboardSection('courseReg')" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Register for Courses</button>
                </div>
            `;
            if (registeredCourses.length > 0) {
                registrationTableHtml = `
                    <h3 class="text-2xl font-semibold text-green-700 mb-4">Your Registered Courses</h3>
                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-gray-200 text-gray-700">
                                <tr>
                                    <th class="py-3 px-6 text-left">Course Code</th>
                                    <th class="py-3 px-6 text-left">Course Name</th>
                                    <th class="py-3 px-6 text-center">Status</th>
                                    <th class="py-3 px-6 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600">
                                ${registeredCourses.map(course => `
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6">${course.courseCode}</td>
                                    <td class="py-3 px-6">${course.courseName}</td>
                                    <td class="py-3 px-6 text-center">
                                        <span class="px-2 py-1 font-semibold leading-tight rounded-full bg-green-100 text-green-800">Registered</span>
                                    </td>
                                    <td class="py-3 px-6 text-center">
                                        <button class="text-red-500 hover:text-red-700" onclick="dropCourse('${course.courseCode}')">Drop</button>
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            let courseSelectionHtml = `
                <h3 class="text-2xl font-semibold text-green-700 mb-4 mt-8">Register New Courses</h3>
                <p class="text-center text-gray-500 py-4">Course registration is currently closed.</p>
            `;
            // This is a placeholder, a real implementation would check a setting like `/settings/registrationOpen`
            const isRegistrationOpen = true; 
            if (isRegistrationOpen && allCourses.length > 0) {
                const availableCourses = allCourses.filter(course => !registeredCourses.some(reg => reg.courseCode === course.courseCode));
                if (availableCourses.length > 0) {
                    courseSelectionHtml = `
                        <h3 class="text-2xl font-semibold text-green-700 mb-4 mt-8">Register for Courses</h3>
                        <div class="mb-4">
                            <label for="new-course-select" class="block text-gray-700 mb-2">Select a course to register:</label>
                            <select id="new-course-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                ${availableCourses.map(course => `<option value="${course.id}">${course.courseCode} - ${course.courseName}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="registerCourse()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Register</button>
                    `;
                } else {
                    courseSelectionHtml = `<h3 class="text-2xl font-semibold text-green-700 mb-4 mt-8">Register for Courses</h3><p class="text-center text-gray-500 py-4">You have registered for all available courses.</p>`;
                }
            }


            content.innerHTML = generateBreadcrumb('Course Registration') + `<div class="bg-white p-8 rounded-xl shadow-lg">${registrationTableHtml}${courseSelectionHtml}</div>`;

            window.registerCourse = async function() {
                const courseId = document.getElementById('new-course-select').value;
                if (!courseId) return;
                showLoading("Registering course...");

                try {
                    const courseDoc = await getDoc(doc(db, `courses`, courseId));
                    if (!courseDoc.exists()) {
                        await showCustomModal("Error", "Selected course not found.");
                        return;
                    }
                    const courseData = courseDoc.data();
                    const newCourseEntry = {
                        id: courseId,
                        courseCode: courseData.courseCode,
                        courseName: courseData.courseName,
                        registrationDate: new Date().toISOString(),
                        status: 'Registered'
                    };

                    await updateDoc(registrationsDocRef, {
                        courses: arrayUnion(newCourseEntry)
                    });
                    await showCustomModal("Success", `${courseData.courseCode} registered successfully!`);
                    await loadRegistrations(); // Reload section to show new course
                } catch (error) {
                    console.error("Error registering course:", error);
                    await showCustomModal("Error", "Failed to register course. Please try again.");
                } finally {
                    hideLoading();
                }
            }

            window.dropCourse = async function(courseCode) {
                const confirmation = await confirm(`Are you sure you want to drop course ${courseCode}?`);
                if (!confirmation) return;
                showLoading("Dropping course...");
                try {
                    const registrationsSnap = await getDoc(registrationsDocRef);
                    const registeredCourses = registrationsSnap.exists() ? registrationsSnap.data().courses : [];
                    const courseToDrop = registeredCourses.find(c => c.courseCode === courseCode);
                    if (courseToDrop) {
                        await updateDoc(registrationsDocRef, {
                            courses: arrayRemove(courseToDrop)
                        });
                        await showCustomModal("Success", `${courseCode} dropped successfully!`);
                        await loadRegistrations();
                    }
                } catch (error) {
                    console.error("Error dropping course:", error);
                    await showCustomModal("Error", "Failed to drop course. Please try again.");
                } finally {
                    hideLoading();
                }
            }

        } catch (e) {
            console.error("Error loading registration data:", e);
            content.innerHTML = generateBreadcrumb('Course Registration') + `<p class="text-center text-gray-500 py-8">Error loading registration data.</p>`;
            await showCustomModal("Error", "Failed to load course registration. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 5. Fees Statement
    async function loadFees() {
        showLoading("Loading fees statement...");
        const content = document.getElementById("dashboardContent");
        const feesDocRef = doc(db, `fees`, currentUserId);
        try {
            const feesSnap = await getDoc(feesDocRef);
            if (!feesSnap.exists() || !feesSnap.data().payments || feesSnap.data().payments.length === 0) {
                content.innerHTML = generateBreadcrumb('Fees Statement') + `
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold text-green-800 mb-6">Fees Statement</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-8">
                            <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                                <h4 class="text-lg font-semibold text-blue-700">Total Fees</h4>
                                <p class="text-3xl font-bold text-blue-900 mt-2">GHS 0.00</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg shadow-inner">
                                <h4 class="text-lg font-semibold text-green-700">Total Payments</h4>
                                <p class="text-3xl font-bold text-green-900 mt-2">GHS 0.00</p>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                                <h4 class="text-lg font-semibold text-gray-700">Balance</h4>
                                <p class="text-3xl font-bold text-gray-900 mt-2">GHS 0.00</p>
                            </div>
                        </div>
                        <p class="text-center text-gray-500 py-8">No fee records found.</p>
                    </div>`;
                return;
            }

            const feesData = feesSnap.data();
            const totalPayments = feesData.payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = feesData.totalFees - totalPayments;
            const balanceColorClass = balance > 0 ? 'text-red-600' : 'text-green-600';
            const balanceText = balance !== 0 ? `GHS ${balance.toFixed(2)}` : `GHS 0.00`;

            const paymentHistoryHtml = feesData.payments.map(p => `
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6">${new Date(p.date).toLocaleDateString()}</td>
                    <td class="py-3 px-6">${p.description}</td>
                    <td class="py-3 px-6 text-right">${p.amount.toFixed(2)}</td>
                </tr>`).join('');

            const feesHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-green-800">Fees Statement</h2>
                        <button onclick="downloadFeesStatement()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-download mr-2"></i>Download PDF</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-8">
                        <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold text-blue-700">Total Fees</h4>
                            <p class="text-3xl font-bold text-blue-900 mt-2">GHS ${feesData.totalFees.toFixed(2)}</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold text-green-700">Total Payments</h4>
                            <p class="text-3xl font-bold text-green-900 mt-2">GHS ${totalPayments.toFixed(2)}</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold text-gray-700">Balance</h4>
                            <p class="text-3xl font-bold ${balanceColorClass} mt-2">GHS ${balanceText}</p>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-2xl font-semibold text-green-700 mb-4">Payment History</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-md">
                                <thead class="bg-gray-200 text-gray-700">
                                    <tr>
                                        <th class="py-3 px-6 text-left">Date</th>
                                        <th class="py-3 px-6 text-left">Description</th>
                                        <th class="py-3 px-6 text-right">Amount (GHS)</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-600">
                                    ${paymentHistoryHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            content.innerHTML = generateBreadcrumb('Fees Statement') + feesHtml;

            window.downloadFeesStatement = async function() {
                showLoading("Generating PDF...");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(22);
                doc.setTextColor(30, 94, 30); // University green
                doc.text("Prince Alex Design University", 14, 20);
                doc.setFontSize(16);
                doc.text("Fees Statement", 14, 30);
                doc.line(14, 32, 196, 32);

                doc.setFontSize(12);
                doc.setTextColor(51, 51, 51);
                doc.text(`Student Name: ${currentUserData.name}`, 14, 45);
                doc.text(`Student ID: ${currentUserData.regNo}`, 14, 52);
                doc.text(`Statement Date: ${new Date().toLocaleDateString()}`, 14, 59);

                const paymentsTableData = feesData.payments.map(p => [
                    new Date(p.date).toLocaleDateString(),
                    p.description,
                    `GHS ${p.amount.toFixed(2)}`
                ]);

                doc.autoTable({
                    startY: 70,
                    head: [['Date', 'Description', 'Amount (GHS)']],
                    body: paymentsTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [46, 114, 46], textColor: 255 },
                    margin: { top: 60 }
                });

                const finalY = doc.autoTable.previous.finalY + 10;
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total Fees: GHS ${feesData.totalFees.toFixed(2)}`, 14, finalY);
                doc.text(`Total Payments: GHS ${totalPayments.toFixed(2)}`, 14, finalY + 7);
                doc.setTextColor(balance > 0 ? 220 : 22, 38, balance > 0 ? 38 : 163);
                doc.setFontSize(16);
                doc.text(`Balance: GHS ${balance.toFixed(2)}`, 14, finalY + 18);
                
                doc.save(`fees-statement-${currentUserData.regNo}.pdf`);
                hideLoading();
                await showCustomModal("Success", "PDF download initiated.");
            };

        } catch(e) {
            console.error("Error loading fees data:", e);
            content.innerHTML = generateBreadcrumb('Fees Statement') + `<p class="text-center text-gray-500 py-8">Error loading fees data.</p>`;
            await showCustomModal("Error", "Failed to load fees statement. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 6. Grades & Transcripts
    async function loadGrades() {
        showLoading("Loading grades and transcripts...");
        const content = document.getElementById("dashboardContent");
        const gradesRef = collection(db, `grades`);
        try {
            const gradesQuery = query(gradesRef, where("studentId", "==", currentUserId), orderBy("courseCode"));
            const gradesSnapshot = await getDocs(gradesQuery);
            const grades = gradesSnapshot.docs.map(doc => doc.data());

            let gradesContent = `
                <div class="flex justify-center my-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center w-64">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">Overall GPA</h3>
                        <div class="gpa-circle-container">
                            <svg class="gpa-circle-svg" width="120" height="120">
                                <circle class="gpa-circle-bg" r="50" cx="60" cy="60"></circle>
                                <circle class="gpa-circle-progress" r="50" cx="60" cy="60" style="stroke-dasharray: 0; stroke: #888;"></circle>
                            </svg>
                            <span class="gpa-text" style="color: #888;">0.00</span>
                        </div>
                    </div>
                </div>
                <p class="text-center text-gray-500 py-8">No grades recorded yet.</p>
            `;
            if (grades.length > 0) {
                const gpa = calculateGPA(grades);
                const gpaProgress = gpa / 4 * 314;
                const gpaColor = gpa > 0 ? '#006400' : '#888888';

                gradesContent = `
                    <div class="flex justify-center my-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center w-64">
                            <h3 class="text-xl font-semibold text-green-800 mb-2">Overall GPA</h3>
                            <div class="gpa-circle-container">
                                <svg class="gpa-circle-svg" width="120" height="120">
                                    <circle class="gpa-circle-bg" r="50" cx="60" cy="60"></circle>
                                    <circle class="gpa-circle-progress" r="50" cx="60" cy="60" style="stroke-dasharray: ${gpaProgress}; stroke: ${gpaColor};"></circle>
                                </svg>
                                <span class="gpa-text" style="color: ${gpaColor};">${gpa}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-8">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-gray-200 text-gray-700">
                                <tr>
                                    <th class="py-3 px-6 text-left">Course Code</th>
                                    <th class="py-3 px-6 text-left">Course Name</th>
                                    <th class="py-3 px-6 text-center">Grade</th>
                                    <th class="py-3 px-6 text-center">Credit Hours</th>
                                    <th class="py-3 px-6 text-left">Remarks</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600">
                                ${grades.map(grade => `
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6">${grade.courseCode}</td>
                                    <td class="py-3 px-6">${grade.courseName}</td>
                                    <td class="py-3 px-6 text-center">${grade.grade}</td>
                                    <td class="py-3 px-6 text-center">${grade.courseUnit}</td>
                                    <td class="py-3 px-6">${grade.remarks || 'N/A'}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            content.innerHTML = generateBreadcrumb('Grades & Transcripts') + `<div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-3xl font-bold text-green-800 mb-6">Academic Transcripts</h2>${gradesContent}</div>`;
        } catch(e) {
            console.error("Error loading grades:", e);
            content.innerHTML = generateBreadcrumb('Grades & Transcripts') + `<p class="text-center text-gray-500 py-8">Error loading grades.</p>`;
            await showCustomModal("Error", "Failed to load grades. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 7. Accommodation (Hostels)
    async function loadHostels() {
        showLoading("Loading hostel data...");
        const content = document.getElementById("dashboardContent");
        const hostelsRef = collection(db, `hostels`);
        const settingsRef = doc(db, `settings`, 'hostelApplications');

        try {
            const hostelsSnapshot = await getDocs(hostelsRef);
            const allHostels = hostelsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const settingsSnap = await getDoc(settingsRef);
            const isApplicationsOpen = settingsSnap.exists() && settingsSnap.data().open;
            
            let hostelsContent = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${allHostels.length > 0 ? allHostels.map(hostel => `
                    <div class="bg-gray-100 p-6 rounded-lg shadow-md border-t-4 border-green-500">
                        <h3 class="text-2xl font-bold text-green-800 mb-2">${hostel.name}</h3>
                        <p class="text-gray-600">Price: <span class="font-semibold">GHS ${hostel.price.toFixed(2)} / semester</span></p>
                        <p class="text-gray-600">Spaces Available: <span class="font-semibold text-blue-600">${hostel.spacesAvailable}</span></p>
                        <p class="text-gray-600 mt-2">${hostel.description}</p>
                        <div class="mt-4">
                            ${isApplicationsOpen ? `
                                <button onclick="applyForHostel('${hostel.id}', '${hostel.name}')" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 w-full">Apply Now</button>
                            ` : `
                                <p class="text-red-500 text-sm">Applications are currently closed.</p>
                            `}
                        </div>
                    </div>
                    `).join('') : `
                    <div class="bg-white p-8 rounded-xl shadow-lg md:col-span-2">
                        <p class="text-center text-gray-500 py-8">No hostel availability data at this time.</p>
                    </div>
                    `}
                </div>
            `;
            
            if (isApplicationsOpen) {
                 const appliedDocRef = doc(db, `hostelApplications`, currentUserId);
                 const appliedSnap = await getDoc(appliedDocRef);
                 if (appliedSnap.exists()) {
                     hostelsContent = `
                        <div class="bg-white p-8 rounded-xl shadow-lg mb-8 text-center">
                            <h3 class="text-2xl font-bold text-green-700 mb-2">Hostel Application Status</h3>
                            <p class="text-xl text-green-600">You have already applied for a hostel.</p>
                            <p class="text-gray-600">Your application for <span class="font-semibold">${appliedSnap.data().hostelName}</span> is currently <span class="font-bold text-yellow-600">${appliedSnap.data().status}</span>.</p>
                        </div>
                     ` + hostelsContent;
                } else {
                    hostelsContent = `
                        <div class="bg-white p-8 rounded-xl shadow-lg mb-8">
                            <h3 class="text-2xl font-bold text-green-700 mb-2">Apply for a Hostel</h3>
                            <p class="text-gray-600 mb-4">Please select a hostel from the list below to submit your application.</p>
                        </div>
                    ` + hostelsContent;
                }
            } else {
                hostelsContent = `
                    <div class="bg-white p-8 rounded-xl shadow-lg mb-8">
                        <h3 class="text-2xl font-bold text-green-700 mb-2">Accommodation</h3>
                        <p class="text-red-500 font-semibold">Hostel applications are currently closed.</p>
                        <p class="text-gray-600 mt-2">Please check back later for the next application period.</p>
                    </div>
                ` + hostelsContent;
            }

            content.innerHTML = generateBreadcrumb('Accommodation') + hostelsContent;

            window.applyForHostel = async function(hostelId, hostelName) {
                const confirmation = await confirm(`Are you sure you want to apply for ${hostelName}?`);
                if (!confirmation) return;
                showLoading("Submitting application...");

                try {
                    const applicationDocRef = doc(db, `hostelApplications`, currentUserId);
                    await setDoc(applicationDocRef, {
                        studentId: currentUserId,
                        studentName: currentUserData.name,
                        hostelId: hostelId,
                        hostelName: hostelName,
                        applicationDate: new Date().toISOString(),
                        status: 'Pending'
                    });
                    await showCustomModal("Success", "Your application has been submitted successfully!");
                    await loadHostels();
                } catch(e) {
                    console.error("Error submitting hostel application:", e);
                    await showCustomModal("Error", "Failed to submit application. Please try again.");
                } finally {
                    hideLoading();
                }
            }

        } catch (e) {
            console.error("Error loading hostel data:", e);
            content.innerHTML = generateBreadcrumb('Accommodation') + `<p class="text-center text-gray-500 py-8">Error loading hostel data.</p>`;
            await showCustomModal("Error", "Failed to load accommodation data. Please try again.");
        } finally {
            hideLoading();
        }
    }
    
    // 8. Announcements
    async function loadAnnouncements() {
        showLoading("Loading announcements...");
        const content = document.getElementById("dashboardContent");
        const announcementsRef = collection(db, `announcements`);
        try {
            const announcementsQuery = query(announcementsRef, orderBy("date", "desc"));
            const announcementsSnapshot = await getDocs(announcementsQuery);
            const announcements = announcementsSnapshot.docs.map(doc => doc.data());

            let announcementsHtml = `<p class="text-center text-gray-500 py-8">No announcements available at this time.</p>`;
            if (announcements.length > 0) {
                announcementsHtml = `<ul class="space-y-4">${announcements.map(ann => `
                    <li class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-semibold text-green-800">${ann.title}</h3>
                            <span class="text-sm text-gray-500">${new Date(ann.date).toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-700">${ann.message}</p>
                    </li>`).join('')}</ul>`;
            }
            content.innerHTML = generateBreadcrumb('Announcements') + `<div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-3xl font-bold text-green-800 mb-6">Announcements</h2>${announcementsHtml}</div>`;
        } catch(e) {
            console.error("Error loading announcements:", e);
            content.innerHTML = generateBreadcrumb('Announcements') + `<p class="text-center text-gray-500 py-8">Error loading announcements.</p>`;
            await showCustomModal("Error", "Failed to load announcements. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 9. Graduation Request
    async function loadGraduation() {
        showLoading("Loading graduation requests...");
        const content = document.getElementById("dashboardContent");
        const graduationRef = collection(db, `graduationRequests`);
        try {
            const requestsQuery = query(graduationRef, where("studentId", "==", currentUserId), orderBy("submissionDate", "desc"));
            const requestsSnap = await getDocs(requestsQuery);
            const requests = requestsSnap.docs.map(doc => doc.data());

            let requestHistoryHtml = `<p class="text-center text-gray-500 py-4">No graduation requests submitted yet.</p>`;
            if (requests.length > 0) {
                requestHistoryHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-gray-200 text-gray-700">
                                <tr>
                                    <th class="py-3 px-6 text-left">Date Submitted</th>
                                    <th class="py-3 px-6 text-left">Status</th>
                                    <th class="py-3 px-6 text-left">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600">
                                ${requests.map(req => {
                                    let statusColor = 'text-gray-800';
                                    if (req.status === 'Pending') statusColor = 'text-yellow-600';
                                    else if (req.status === 'Approved') statusColor = 'text-green-600';
                                    else if (req.status === 'Denied') statusColor = 'text-red-600';
                                    return `
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-3 px-6">${new Date(req.submissionDate).toLocaleDateString()}</td>
                                        <td class="py-3 px-6"><span class="font-bold ${statusColor}">${req.status}</span></td>
                                        <td class="py-3 px-6">${req.notes || 'N/A'}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            const graduationFormHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Graduation Request</h2>
                    <div class="border-b border-gray-200 mb-6 pb-6">
                        <h3 class="text-2xl font-semibold text-green-700 mb-4">Submit a New Request</h3>
                        <p class="text-gray-600 mb-4">You can submit a graduation request once all your academic requirements are met. Your request will be reviewed by the academic office.</p>
                        <button onclick="submitGraduationRequest()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Submit Request</button>
                    </div>
                    <h3 class="text-2xl font-semibold text-green-700 mb-4">Request History</h3>
                    ${requestHistoryHtml}
                </div>
            `;
            content.innerHTML = generateBreadcrumb('Graduation Request') + graduationFormHtml;
            
            window.submitGraduationRequest = async function() {
                const confirmation = await confirm("Are you sure you want to submit a new graduation request?");
                if (!confirmation) return;
                showLoading("Submitting request...");
                try {
                    await addDoc(collection(db, `graduationRequests`), {
                        studentId: currentUserId,
                        submissionDate: new Date().toISOString(),
                        status: 'Pending',
                        notes: 'Awaiting review'
                    });
                    await showCustomModal("Success", "Your graduation request has been submitted!");
                    await loadGraduation();
                } catch(e) {
                    console.error("Error submitting graduation request:", e);
                    await showCustomModal("Error", "Failed to submit request. Please try again.");
                } finally {
                    hideLoading();
                }
            }

        } catch(e) {
            console.error("Error loading graduation requests:", e);
            content.innerHTML = generateBreadcrumb('Graduation Request') + `<p class="text-center text-gray-500 py-8">Error loading graduation requests.</p>`;
            await showCustomModal("Error", "Failed to load graduation requests. Please try again.");
        } finally {
            hideLoading();
        }
    }

    // 10. Clearance Request
    async function loadClearance() {
        showLoading("Loading clearance requests...");
        const content = document.getElementById("dashboardContent");
        const clearanceRef = collection(db, `clearanceRequests`);
        try {
            const requestsQuery = query(clearanceRef, where("studentId", "==", currentUserId), orderBy("submissionDate", "desc"));
            const requestsSnap = await getDocs(requestsQuery);
            const requests = requestsSnap.docs.map(doc => doc.data());

            let requestHistoryHtml = `<p class="text-center text-gray-500 py-4">No clearance requests submitted yet.</p>`;
            if (requests.length > 0) {
                requestHistoryHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-gray-200 text-gray-700">
                                <tr>
                                    <th class="py-3 px-6 text-left">Date Submitted</th>
                                    <th class="py-3 px-6 text-left">Status</th>
                                    <th class="py-3 px-6 text-left">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600">
                                ${requests.map(req => {
                                    let statusColor = 'text-gray-800';
                                    if (req.status === 'Pending') statusColor = 'text-yellow-600';
                                    else if (req.status === 'Approved') statusColor = 'text-green-600';
                                    else if (req.status === 'Denied') statusColor = 'text-red-600';
                                    return `
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-3 px-6">${new Date(req.submissionDate).toLocaleDateString()}</td>
                                        <td class="py-3 px-6"><span class="font-bold ${statusColor}">${req.status}</span></td>
                                        <td class="py-3 px-6">${req.notes || 'N/A'}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            const clearanceFormHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Clearance Request</h2>
                    <div class="border-b border-gray-200 mb-6 pb-6">
                        <h3 class="text-2xl font-semibold text-green-700 mb-4">Submit a New Request</h3>
                        <p class="text-gray-600 mb-4">Upload a PDF document and submit your clearance request. It will be reviewed by the administration.</p>
                        <form id="clearance-form">
                            <div class="mb-4">
                                <label for="clearance-pdf" class="block text-gray-700 font-semibold mb-2">Upload Clearance Document (PDF)</label>
                                <input type="file" id="clearance-pdf" accept="application/pdf" class="w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <p id="clearance-error" class="text-red-500 text-sm mt-1 hidden">Please select a PDF file.</p>
                            </div>
                            <button type="submit" id="submit-clearance-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Submit Request</button>
                        </form>
                    </div>
                    <h3 class="text-2xl font-semibold text-green-700 mb-4">Request History</h3>
                    ${requestHistoryHtml}
                </div>
            `;
            content.innerHTML = generateBreadcrumb('Clearance Request') + clearanceFormHtml;

            document.getElementById('clearance-form').addEventListener('submit', handleClearanceSubmission);

        } catch(e) {
            console.error("Error loading clearance requests:", e);
            content.innerHTML = generateBreadcrumb('Clearance Request') + `<p class="text-center text-gray-500 py-8">Error loading clearance requests.</p>`;
            await showCustomModal("Error", "Failed to load clearance requests. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function handleClearanceSubmission(event) {
        event.preventDefault();
        const submitBtn = document.getElementById('submit-clearance-btn');
        const fileInput = document.getElementById('clearance-pdf');
        const errorElement = document.getElementById('clearance-error');
        const file = fileInput.files[0];

        if (!file || file.type !== "application/pdf") {
            errorElement.classList.remove('hidden');
            return;
        }
        errorElement.classList.add('hidden');
        setButtonLoading(submitBtn, true);

        showLoading("Uploading document and submitting request...");

        try {
            const fileRef = ref(storage, `clearance_documents/${currentUserId}_${Date.now()}.pdf`);
            const snapshot = await uploadBytes(fileRef, file);
            const fileURL = await getDownloadURL(snapshot.ref);

            await addDoc(collection(db, `clearanceRequests`), {
                studentId: currentUserId,
                submissionDate: new Date().toISOString(),
                status: 'Pending',
                documentURL: fileURL,
                notes: 'Awaiting review'
            });
            await showCustomModal("Success", "Your clearance request has been submitted!");
            await loadClearance();
        } catch (e) {
            console.error("Error submitting clearance request:", e);
            await showCustomModal("Error", "Failed to submit request. Please try again.");
        } finally {
            setButtonLoading(submitBtn, false);
            hideLoading();
        }
    }


    // Main navigation handler
    async function showDashboardSection(section) {
      sidebar.classList.add('-translate-x-full');

      if (!currentUserId) {
        console.log("currentUserId is null. Redirecting to login from showDashboardSection.");
        authContainer.classList.remove('hidden');
        dashboardContainer.classList.add('hidden');
        showForm('login');
        return;
      }

      const content = document.getElementById("dashboardContent");
      content.innerHTML = '';

      switch (section) {
        case 'home':
          await loadHome();
          break;
        case 'profile':
          await loadProfile();
          break;
        case 'courses':
          await loadCourses();
          break;
        case 'courseReg':
          await loadRegistrations();
          break;
        case 'fees':
          await loadFees();
          break;
        case 'grades':
        case 'transcripts':
          await loadGrades();
          break;
        case 'hostels':
          await loadHostels();
          break;
        case 'announcements':
          await loadAnnouncements();
          break;
        case 'graduation':
          await loadGraduation();
          break;
        case 'clearance':
          await loadClearance();
          break;
        default:
          content.innerHTML = generateBreadcrumb(section.charAt(0).toUpperCase() + section.slice(1)) + `<p class="text-center text-gray-500 py-8">Content for this section is coming soon.</p>`;
          break;
      }
    }

    // New menu items for Course and Announcements
    const academicsSubmenu = document.getElementById('academics-submenu');
    if (academicsSubmenu) {
      academicsSubmenu.innerHTML = `
        <a onclick="showDashboardSection('courses')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-list-alt mr-3"></i> Available Courses</a>
        <a onclick="showDashboardSection('courseReg')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-alt mr-3"></i> Course Registration</a>
        <a onclick="showDashboardSection('timetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-calendar-alt mr-3"></i> Timetable</a>
        <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-list mr-3"></i> Grades & Transcripts</a>
        <a onclick="showDashboardSection('graduation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-graduation-cap mr-3"></i> Graduation Request</a>
        <a onclick="showDashboardSection('clearance')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-check-circle mr-3"></i> Clearance Request</a>
      `;
    }

    const examSubmenu = document.getElementById('exam-submenu');
    if(examSubmenu) {
      examSubmenu.innerHTML = `
        <a onclick="showDashboardSection('examTimetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clock mr-3"></i> Timetable</a>
        <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-invoice mr-3"></i> Transcripts</a>
      `;
    }

    // Expose functions to global scope
    window.loadTimetable = async function() {
        const content = document.getElementById("dashboardContent");
        content.innerHTML = generateBreadcrumb('Timetable') + `<p class="text-center text-gray-500 py-8">Timetable section is under development.</p>`;
    };
    window.loadExamCard = async function() {
        const content = document.getElementById("dashboardContent");
        content.innerHTML = generateBreadcrumb('Exam Card') + `<p class="text-center text-gray-500 py-8">Exam Card section is under development.</p>`;
    };
    window.loadExamTimetable = async function() {
        const content = document.getElementById("dashboardContent");
        content.innerHTML = generateBreadcrumb('Examination Timetable') + `<p class="text-center text-gray-500 py-8">Examination Timetable section is under development.</p>`;
    };
    window.loadReceipts = async function() {
        const content = document.getElementById("dashboardContent");
        content.innerHTML = generateBreadcrumb('Receipts') + `<p class="text-center text-gray-500 py-8">Receipts section is under development.</p>`;
    };
    window.loadEvaluation = async function() {
        const content = document.getElementById("dashboardContent");
        content.innerHTML = generateBreadcrumb('Course Evaluation') + `<p class="text-center text-gray-500 py-8">Course Evaluation section is under development.</p>`;
    };
    window.loadSettings = async function() {
        const content = document.getElementById("dashboardContent");
        content.innerHTML = generateBreadcrumb('Settings') + `<p class="text-center text-gray-500 py-8">Settings section is under development.</p>`;
    };


    window.showDashboardSection = showDashboardSection;
  </script>
</body>
</html>
