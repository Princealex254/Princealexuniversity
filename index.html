<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prince Alex Design University - Login/Signup</title>
  <style>
    /* Global styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body, html {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Container for the entire page, with background image */
    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: url('myschoolgate.png') no-repeat center center; /* Ensure this image path is correct */
      background-size: cover;
      position: relative; /* Needed for overlay */
    }

    /* Styling for each form wrapper (login, signup, forgot password) */
    .form-wrapper {
      background-color: rgba(255, 255, 255, 0.95); /* Semi-transparent white background */
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
      width: 100%;
      max-width: 450px; /* Max width for forms */
      text-align: center;
      position: absolute; /* Allows forms to stack and be shown/hidden */
      transition: all 0.5s ease-in-out; /* Smooth transition for form changes */
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
    }
    .form-wrapper.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      position: relative; /* Bring active form into document flow */
    }
    .form-wrapper:not(.active) {
        /* Position inactive forms off-screen but maintain layout for transition */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) translateY(20px);
        pointer-events: none; /* Disable interaction with hidden forms */
    }

    /* Titles for forms */
    h2 {
      color: #006400; /* Dark green for headings */
      margin-bottom: 25px;
      font-size: 2em;
      font-weight: 600;
    }

    /* Form input and button styling */
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    .input-group input[type="email"],
    .input-group input[type="password"],
    .input-group input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .input-group input[type="email"]:focus,
    .input-group input[type="password"]:focus,
    .input-group input[type="text"]:focus {
      border-color: #006400;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.2);
    }

    /* Buttons */
    button {
      background-color: #006400;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      background-color: #004d00;
      transform: translateY(-2px);
    }
    button:disabled {
      background-color: #a0a0a0;
      cursor: not-allowed;
      transform: none;
    }

    /* Links within forms */
    .form-links {
      margin-top: 20px;
      font-size: 0.95em;
    }
    .form-links a {
      color: #006400;
      text-decoration: none;
      margin: 0 10px;
      transition: color 0.3s;
    }
    .form-links a:hover {
      color: #004d00;
      text-decoration: underline;
    }

    /* Message for results/errors */
    #resultMsg {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1em;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        z-index: 9999; /* Higher than other content */
        flex-direction: column;
    }

    .loading-spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #006400;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        margin-top: 20px;
        font-size: 1.2em;
        color: #006400;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Custom Modal Styles (replaces alert/confirm) */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 10000; /* Sit on top (higher than loading overlay) */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      justify-content: center; /* Center content horizontally */
      align-items: center; /* Center content vertically */
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be more or less, depending on screen size */
      max-width: 400px; /* Max width for consistency */
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .modal-content h3 {
      margin-bottom: 15px;
      color: #006400;
    }

    .modal-content p {
      margin-bottom: 20px;
      color: #333;
    }

    .modal-buttons button {
      background-color: #006400;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
    }

    .modal-buttons button.cancel {
      background-color: #ccc;
      color: #333;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .form-wrapper {
        margin: 20px;
        padding: 30px 20px;
      }
      h2 {
        font-size: 1.8em;
      }
      button {
        padding: 10px 20px;
        font-size: 1em;
      }
      .form-links a {
        display: block;
        margin: 10px 0;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Custom Modal for Alerts/Confirms -->
  <div id="customModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <p id="modalMessage"></p>
      <div class="modal-buttons">
        <button id="modalConfirmBtn">OK</button>
        <button id="modalCancelBtn" class="cancel">Cancel</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Login Form -->
    <div id="login-form-wrapper" class="form-wrapper active">
      <form id="login-form" onsubmit="loginUser(event)">
        <h2>Login</h2>
        <div class="input-group">
          <label for="email-login">Email</label>
          <input type="email" id="email-login" placeholder="Enter your email" required />
        </div>
        <div class="input-group">
          <label for="password-login">Password</label>
          <input type="password" id="password-login" placeholder="Enter your password" required />
        </div>
        <button type="submit" id="login-btn">Login</button>
        <div class="form-links">
          <a href="#" onclick="showForm('signup')">Don't have an account? Sign Up</a>
          <a href="#" onclick="showForm('forgot-password')">Forgot Password?</a>
        </div>
        <p id="loginResultMsg" style="color: red;"></p>
      </form>
    </div>

    <!-- Signup Form -->
    <div id="signup-form-wrapper" class="form-wrapper">
      <form id="signup-form" onsubmit="signupUser(event)">
        <h2>Sign Up</h2>
        <div class="input-group">
          <label for="full-name-signup">Full Name</label>
          <input type="text" id="full-name-signup" placeholder="Enter your full name" required />
        </div>
        <div class="input-group">
          <label for="email-signup">Email</label>
          <input type="email" id="email-signup" placeholder="Enter your email" required />
        </div>
        <div class="input-group">
          <label for="password-signup">Password</label>
          <input type="password" id="password-signup" placeholder="Create a password" required />
        </div>
        <div class="input-group">
          <label for="confirm-password-signup">Confirm Password</label>
          <input type="password" id="confirm-password-signup" placeholder="Confirm your password" required />
        </div>
        <button type="submit" id="signup-btn">Sign Up</button>
        <div class="form-links">
          <a href="#" onclick="showForm('login')">Already have an account? Login</a>
        </div>
        <p id="signupResultMsg" style="color: red;"></p>
      </form>
    </div>

    <!-- Forgot Password Form -->
    <div id="forgot-password-form-wrapper" class="form-wrapper">
      <form id="forgot-password-form" onsubmit="recoverPassword(event)">
        <h2>Forgot Password</h2>
        <div class="input-group">
          <label for="email-forgot">Email</label>
          <input type="email" id="email-forgot" placeholder="Enter your email" required />
        </div>
        <button type="submit" id="recover-btn">Recover Password</button>
        <div class="form-links">
          <a href="#" onclick="showForm('login')">Back to Login</a>
        </div>
        <p id="resultMsg" style="color: red;"></p>
      </form>
    </div>
  </div>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com", // Updated storageBucket
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId; // Define appId for Firestore paths

    // --- Custom Modal Functions (replaces alert/confirm) ---
    let resolveModalPromise;
    function showCustomModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        if (modalTitle) modalTitle.innerText = title;
        if (modalMessage) modalMessage.innerText = message;
        
        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = () => {
                if (modal) modal.style.display = 'none';
                resolve(true);
            };
        }
        if (modalCancelBtn) {
            modalCancelBtn.onclick = () => {
                if (modal) modal.style.display = 'none';
                resolve(false);
            };
            modalCancelBtn.style.display = isConfirm ? 'inline-block' : 'none';
        }
        if (modal) modal.style.display = 'flex'; // Use flex to center
        resolveModalPromise = resolve;
      });
    }

    window.alert = (message) => showCustomModal('Alert', message); // Override alert
    window.confirm = (message) => showCustomModal('Confirm', message, true); // Override confirm
    // --- End Custom Modal Functions ---

    // Get loading overlay elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.querySelector('#loadingOverlay .loading-text');

    // Function to set button loading state
    function setButtonLoading(button, isLoading) {
      if (button) {
        button.disabled = isLoading;
        button.innerText = isLoading ? "Loading..." : (button.id === "login-btn" ? "Login" : (button.id === "signup-btn" ? "Sign Up" : "Recover Password"));
      }
    }

    // Function to show specific form and hide others
    window.showForm = function(formId) {
      const forms = document.querySelectorAll('.form-wrapper');
      forms.forEach(form => {
        form.classList.remove('active');
      });
      const activeForm = document.getElementById(`${formId}-form-wrapper`);
      if (activeForm) {
        activeForm.classList.add('active');
        // Clear previous messages when switching forms
        const loginResultMsg = document.getElementById('loginResultMsg');
        const signupResultMsg = document.getElementById('signupResultMsg');
        const resultMsg = document.getElementById('resultMsg');
        if (loginResultMsg) loginResultMsg.innerText = '';
        if (signupResultMsg) signupResultMsg.innerText = '';
        if (resultMsg) resultMsg.innerText = '';
      }
    };

    // --- Auth State Check for Initial Load ---
    // This checks if a user is already authenticated (due to persistence)
    // and redirects to dashboard immediately.
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in, redirect to dashboard
        loadingText.innerText = "Logged in! Redirecting...";
        loadingOverlay.style.display = 'flex';
        window.location.href = window.location.origin + "/dashboard.html";
      } else {
        // No user signed in, hide loading overlay and show login form
        loadingOverlay.style.display = 'none';
        showForm('login'); // Ensure login form is visible by default
      }
    });

    // Function to log in user
    async function loginUser(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('login-btn');
      const loginResultMsg = document.getElementById('loginResultMsg');
      setButtonLoading(loginBtn, true);
      loginResultMsg.innerText = ''; // Clear previous messages

      const email = document.getElementById("email-login").value.trim().toLowerCase();
      const password = document.getElementById("password-login").value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log("User logged in:", user.email);

        // Fetch user data from Firestore to confirm registration
        // Path adjusted to look for user profile directly under /users/{uid}
        const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
        const userDocSnap = await getDoc(userDocRef);

        if (!userDocSnap.exists()) {
            // This case should ideally not happen if signup creates the doc,
            // but as a fallback, create a basic user doc if it doesn't exist.
            await setDoc(userDocRef, {
                email: user.email,
                name: email.split('@')[0], // Basic name from email
                createdAt: new Date().toISOString(),
                initialized: true // Mark as initialized
            }, { merge: true });
            console.log("Created basic user profile during login fallback.");
        }

        loginResultMsg.innerText = "✅ Login successful!";
        loginResultMsg.style.color = "green";
        
        loadingText.innerText = "Login successful! Redirecting...";
        loadingOverlay.style.display = 'flex';
        setTimeout(() => {
          window.location.href = window.location.origin + "/dashboard.html";
        }, 1500); // Give user a moment to see success message
      } catch (error) {
        setButtonLoading(loginBtn, false);
        let errorMessage = "❌ Login failed.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          errorMessage = "❌ Invalid email or password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        loginResultMsg.innerText = errorMessage;
        loginResultMsg.style.color = "red";
        console.error("Login error:", error);
      }
    }

    // Function to sign up new user
    async function signupUser(event) {
      event.preventDefault();
      const signupBtn = document.getElementById('signup-btn');
      const signupResultMsg = document.getElementById('signupResultMsg');
      setButtonLoading(signupBtn, true);
      signupResultMsg.innerText = ''; // Clear previous messages

      const fullName = document.getElementById("full-name-signup").value.trim();
      const email = document.getElementById("email-signup").value.trim().toLowerCase();
      const password = document.getElementById("password-signup").value;
      const confirmPassword = document.getElementById("confirm-password-signup").value;

      if (password !== confirmPassword) {
        signupResultMsg.innerText = "❌ Passwords do not match!";
        signupResultMsg.style.color = "red";
        setButtonLoading(signupBtn, false);
        return;
      }
      if (password.length < 6) {
        signupResultMsg.innerText = "❌ Password must be at least 6 characters long.";
        signupResultMsg.style.color = "red";
        setButtonLoading(signupBtn, false);
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Create a user document in Firestore under the 'students' subcollection (as per original logic)
        const studentDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/students`, user.uid);
        await setDoc(studentDocRef, {
            email: user.email,
            name: fullName,
            regNo: "N/A", // Placeholder, can be updated later
            programme: "N/A", // Placeholder
            campus: "Main Campus", // Default
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true // Mark as initialized
        });
        console.log("User signed up and detailed student profile created:", user.email);

        // Create minimal profile doc for dashboard login
        await setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
            email: user.email,
            name: fullName,
            createdAt: new Date().toISOString()
        }, { merge: true }); // Use merge to avoid overwriting if doc was created by login fallback
        console.log("Basic user profile created/merged under /users/{uid}:", user.email);


        signupResultMsg.innerText = "✅ Signup successful! You can now login.";
        signupResultMsg.style.color = "green";
        // Optionally redirect to login form after successful signup
        setTimeout(() => {
          showForm('login');
        }, 1500);
      } catch (error) {
        setButtonLoading(signupBtn, false);
        let errorMessage = "❌ Signup failed.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "❌ Email already in use. Try logging in or recovering password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Invalid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "❌ Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        signupResultMsg.innerText = errorMessage;
        signupResultMsg.style.color = "red";
        console.error("Signup error:", error);
      }
    }

    // Function to recover password
    async function recoverPassword(event) {
      event.preventDefault();
      const recoverBtn = document.getElementById('recover-btn');
      const resultMsg = document.getElementById('resultMsg');
      setButtonLoading(recoverBtn, true);
      resultMsg.innerText = ''; // Clear previous messages

      const email = document.getElementById("email-forgot").value.trim().toLowerCase();

      try {
        await sendPasswordResetEmail(auth, email);
        resultMsg.innerText = "✅ Password reset email sent! Check your inbox.";
        resultMsg.style.color = "green";
      } catch (error) {
        let errorMessage = "❌ Failed to send password reset email.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "❌ No account found with that email.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        resultMsg.innerText = errorMessage;
        resultMsg.style.color = "red";
        console.error("Password recovery error:", error);
      } finally {
        setButtonLoading(recoverBtn, false);
      }
    }

    // Expose functions to global scope
    window.loginUser = loginUser;
    window.signupUser = signupUser;
    window.recoverPassword = recoverPassword;
    window.setButtonLoading = setButtonLoading; // Keep for potential future use by other functions
  </script>
</body>
</html>
