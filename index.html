<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
  <style>
    /* Dark Mode Body and Glassmorphism Base */
    body {
      font-family: 'Inter', sans-serif;
      background: url('myschoolgate.png') no-repeat center center fixed;
      background-size: cover;
      background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
      color: #e2e8f0; /* Light text for dark background */
    }

    /* Main glassmorphism effect for panels */
    .glass-panel {
      background: rgba(255, 255, 255, 0.1); /* Semi-transparent white */
      backdrop-filter: blur(10px); /* Blur effect */
      -webkit-backdrop-filter: blur(10px); /* For Safari */
      border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
      border-radius: 15px; /* More rounded corners */
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); /* Stronger shadow */
    }

    /* Override for specific elements if needed to ensure dark theme compatibility */
    .bg-white {
        background-color: rgba(255, 255, 255, 0.15); /* Lighter glass for cards */
    }
    .text-gray-700 {
        color: #cbd5e1; /* Lighter gray for text */
    }
    .text-gray-600 {
        color: #a0aec0; /* Even lighter gray */
    }
    .text-gray-500 {
        color: #718096; /* Lightest gray */
    }
    .text-green-800 {
        color: #34d399; /* Brighter green for headings */
    }
    .text-green-700 {
        color: #10b981; /* Primary green */
    }
    .text-green-600 {
        color: #059669;
    }
    .bg-green-700 {
        background-color: #10b981; /* Brighter green for buttons */
    }
    .hover\:bg-green-800:hover {
        background-color: #065f46; /* Darker hover green */
    }
    .border-gray-300 {
        border-color: rgba(255, 255, 255, 0.3); /* Lighter border */
    }
    .focus\:ring-green-500:focus {
        --tw-ring-color: #34d399; /* Bright green ring */
    }
    .bg-gray-100 {
        background-color: rgba(255, 255, 255, 0.08); /* Darker background for light gray elements */
    }
    .bg-gray-200 {
        background-color: rgba(255, 255, 255, 0.12);
    }
    .bg-green-100 {
      background-color: rgba(16, 185, 129, 0.2); /* Light green tint with transparency */
    }
    .border-green-600 {
        border-color: #059669;
    }
    .shadow-md {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .shadow-lg {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    .shadow-2xl {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    }

    /* Specific overrides for status colors */
    .text-red-500 {
        color: #ef4444;
    }
    .text-red-600 {
        color: #dc2626;
    }
    .bg-red-100 {
      background-color: rgba(239, 68, 68, 0.2); /* Transparent red */
    }
    .text-blue-500 {
        color: #3b82f6;
    }
    .text-blue-800 {
        color: #60a5fa;
    }
    .bg-blue-100 {
      background-color: rgba(59, 130, 246, 0.2);
    }
    .text-purple-800 {
      color: #a78bfa;
    }
    .bg-purple-100 {
      background-color: rgba(168, 85, 247, 0.2);
    }
    .text-yellow-800 {
      color: #fcd34d;
    }
    .bg-yellow-100 {
      background-color: rgba(250, 204, 21, 0.2);
    }

    /* Login/Auth forms fixed center */
    #authContainer {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem; /* Add padding for mobile */
    }
    .form-wrapper {
        border-radius: 15px; /* More rounded */
        padding: 2.5rem; /* Consistent padding */
    }
    @media (max-width: 768px) {
      .form-wrapper {
        width: 100%;
        margin: 1rem;
      }
    }


    /* GPA Circle */
    .gpa-circle-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 20px auto;
    }
    .gpa-circle-svg {
      transform: rotate(-90deg);
    }
    .gpa-circle-bg {
      stroke: rgba(255, 255, 255, 0.2); /* Light on dark */
      stroke-width: 10;
      fill: none;
    }
    .gpa-circle-progress {
      stroke: #10b981; /* University green */
      stroke-width: 10;
      fill: none;
      transition: stroke-dasharray 0.5s ease-in-out;
    }
    .gpa-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      font-weight: bold;
      color: #10b981; /* University green */
    }
    .fees-balance-text.red {
        color: #ef4444; /* Tailwind red-500 */
    }
    .fees-balance-text.green {
        color: #22c55e; /* Tailwind green-500 */
    }
    /* Hide scrollbar for announcements panel, but allow scrolling */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    /* Rotate chevron */
    .rotate-180 {
        transform: rotate(180deg);
    }

    /* New CSS for spacing and cards */
    .container {
        padding: 10px; /* Reduced padding for smaller screens */
    }
    /* Adjust main padding and gap on larger screens */
    @media (min-width: 1024px) { /* Equivalent to Tailwind's lg breakpoint */
        .main {
            padding: 20px;
            gap: 20px;
        }
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.15); /* Lighter glass for cards */
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.3);
    }
    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #34d399; /* Brighter green */
    }

    /* Reduce sidebar width */
    #sidebar {
      width: 256px; /* Retain standard width for now, can adjust if needed */
      background: rgba(0, 0, 0, 0.5); /* Darker glass for sidebar */
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    #sidebar a {
      color: #e2e8f0; /* Light text for sidebar links */
    }
    #sidebar a.hover\:bg-green-700:hover {
        background-color: rgba(16, 185, 129, 0.3); /* Transparent green hover */
    }
    #sidebar h3 {
        color: #34d399; /* Green for sidebar title */
    }
    /* Adjust main content margin to account for new sidebar width */
    @media (min-width: 1024px) {
        #dashboardContent {
            margin-left: 256px; /* Keep consistent with sidebar width */
        }
    }

    /* Timetable Specific CSS */
    .timetable-grid {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 1px;
      background-color: rgba(255, 255, 255, 0.1); /* Darker grid lines */
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .timetable-header, .timetable-cell {
      background-color: rgba(255, 255, 255, 0.1); /* Glass effect for cells */
      padding: 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #e2e8f0;
    }

    .timetable-header {
      font-weight: bold;
      background-color: rgba(255, 255, 255, 0.15); /* Slightly darker header */
      color: #34d399;
    }

    .timetable-cell {
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 0.875rem;
    }
    .timetable-cell p {
      color: #cbd5e1;
    }
    .timetable-cell p.font-bold {
      color: #e2e8f0;
    }
    .timetable-cell p.text-gray-600 {
      color: #a0aec0;
    }

    /* Responsive Timetable on Mobile */
    @media (max-width: 1023px) {
      .timetable-grid {
        display: block; /* Stack on mobile */
      }
      .timetable-day-card {
        background-color: rgba(255, 255, 255, 0.15); /* Glass card */
        border-radius: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        margin-bottom: 16px;
        padding: 16px;
      }
      .timetable-day-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #3b82f6; /* Blue for title */
        margin-bottom: 12px;
      }
      .timetable-class-item {
        border-top: 1px solid rgba(255, 255, 255, 0.1); /* Lighter separator */
        padding-top: 12px;
        margin-top: 12px;
      }
      .timetable-class-item:first-child {
        border-top: none;
        padding-top: 0;
        margin-top: 0;
      }
    }

    /* Collapsible styles for Settings and Announcements */
    .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: rgba(255, 255, 255, 0.1); /* Glass header */
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease;
        border-radius: 10px; /* Slightly less rounded than main panel */
        color: #e2e8f0;
    }
    .collapsible-header:hover {
        background-color: rgba(255, 255, 255, 0.15);
    }
    .collapsible-header h3 {
        color: #34d399; /* Green heading */
    }
    .collapsible-content {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        display: none; /* Hidden by default */
        overflow: hidden;
        transition: max-height 0.3s ease-out; /* For smooth collapse */
        max-height: 0;
        background-color: rgba(0, 0, 0, 0.2); /* Darker content background */
        border-radius: 0 0 10px 10px;
    }
    .collapsible-content.expanded {
        max-height: 1000px; /* Large enough to show content */
        display: block;
    }
    .collapsible-header i.fa-chevron-down {
        transition: transform 0.3s ease;
    }
    .collapsible-header.expanded i.fa-chevron-down {
        transform: rotate(180deg);
    }

    /* Specific styles for Delete Account section */
    .collapsible-header.bg-red-100 {
        background-color: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    .collapsible-header.hover\:bg-red-200:hover {
        background-color: rgba(239, 68, 68, 0.3);
    }
    .collapsible-content.bg-red-50 {
        background-color: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.4);
    }
    .collapsible-content .text-red-700 {
        color: #fca5a5; /* Lighter red for text */
    }
    .collapsible-content .text-red-500 {
        color: #f87171;
    }
    .collapsible-content .border-red-300 {
        border-color: rgba(252, 165, 165, 0.5);
    }


    /* Dashboard Header */
    header {
      background: rgba(0, 0, 0, 0.5); /* Darker glass for header */
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
    }
    header .text-green-800 {
        color: #34d399;
    }
    header .hover\:bg-gray-100:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* Footer */
    footer {
      background: rgba(0, 0, 0, 0.5); /* Darker glass for footer */
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #a0aec0;
    }

    /* Profile Image on Dashboard Header */
    #headerProfilePic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #10b981; /* Green border */
    }
    #notificationBadge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #ef4444; /* Red badge */
      color: white;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 9999px; /* Full pill shape */
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Breadcrumbs */
    .text-gray-600 {
      color: #cbd5e1;
    }
    .text-green-700 {
      color: #10b981;
    }
    .text-green-800 {
      color: #34d399;
    }

    /* Status cards in Dashboard Home */
    .dashboard-stat-card {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        border-top: 4px solid #10b981; /* Default green */
        color: #e2e8f0;
    }
    .dashboard-stat-card.red-border {
        border-top-color: #ef4444;
    }
    .dashboard-stat-card.green-border {
        border-top-color: #22c55e;
    }
    .dashboard-stat-card h3 {
        color: #34d399;
    }
    .dashboard-stat-card p.text-gray-600 {
        color: #a0aec0;
    }
    .dashboard-stat-card p.text-3xl {
        color: #e2e8f0;
    }
    .dashboard-stat-card .text-4xl {
      color: #e2e8f0;
    }


    /* Profile Photo in Dashboard Welcome */
    #dashboardProfilePhoto {
      border-color: rgba(255, 255, 255, 0.3);
    }
    #dashboardStudentName, #dashboardStudentProgramme, #dashboardStudentRegNo {
      color: #e2e8f0;
    }

    /* Form elements inside glass panels */
    input, select, textarea {
        background-color: rgba(0, 0, 0, 0.3); /* Darker input fields */
        border-color: rgba(255, 255, 255, 0.2);
        color: #e2e8f0;
    }
    input::placeholder, textarea::placeholder {
        color: #a0aec0;
    }
    input:disabled {
        background-color: rgba(0, 0, 0, 0.1);
        color: #a0aec0;
    }

    /* Table styles for dark mode */
    table {
        background-color: rgba(255, 255, 255, 0.15);
        border-collapse: separate; /* Use separate to allow border-radius on outer table */
        border-spacing: 0;
        border-radius: 15px; /* Apply rounded corners to table */
        overflow: hidden; /* Ensures content respects border-radius */
    }
    table thead {
        background-color: rgba(255, 255, 255, 0.2);
        color: #e2e8f0;
    }
    table th, table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        color: #e2e8f0;
    }
    table th:last-child, table td:last-child {
        border-right: none;
    }
    table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Loading overlay */
    #loadingOverlay {
        background-color: rgba(0, 0, 0, 0.8);
    }
    #loadingText {
        color: #34d399;
    }
    .border-green-700 {
        border-color: #10b981;
    }

    /* Custom modal */
    #customModal .bg-white {
        background-color: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #e2e8f0;
    }
    #modalTitle {
        color: #34d399;
    }
    #modalMessage {
        color: #cbd5e1;
    }
    #modalConfirmBtn {
        background-color: #10b981;
    }
    #modalCancelBtn {
        background-color: rgba(255, 255, 255, 0.2);
        color: #e2e8f0;
    }
    #modalCancelBtn:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }

  </style>
</head>
<body class="h-screen flex items-center justify-center">
  <div id="loadingOverlay" class="fixed inset-0 bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
    <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
    <div class="glass-panel p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-700">
      <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
      <p id="modalMessage" class="mb-6 text-gray-200"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
        <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
      </div>
    </div>
  </div>

  <div id="authContainer" class="p-4 w-full h-full flex justify-center items-center">
    <div id="login-form-wrapper" class="form-wrapper glass-panel p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out active">
      <form id="login-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Login</h2>
        <div class="mb-6 text-left">
          <label for="email-login" class="block text-gray-200 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-login" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-transparent transition-colors duration-200" />
          <p id="email-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-login" class="block text-gray-200 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-login" placeholder="Enter your password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-transparent transition-colors duration-200" />
          <p id="password-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="login-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Login</button>
        <div class="mt-6 text-sm flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
          <a href="#" onclick="showForm('signup')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Don't have an account? Sign Up</a>
          <a href="#" onclick="showForm('forgot-password')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Forgot Password?</a>
        </div>
      </form>
    </div>

    <div id="signup-form-wrapper" class="form-wrapper glass-panel p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible">
      <form id="signup-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Sign Up</h2>
        <div class="mb-6 text-left">
          <label for="full-name-signup" class="block text-gray-200 text-sm font-medium mb-2">Full Name</label>
          <input type="text" id="full-name-signup" placeholder="Enter your full name" required autofocus class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-transparent transition-colors duration-200" />
        </div>
        <div class="mb-6 text-left">
          <label for="email-signup" class="block text-gray-200 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-signup" placeholder="Enter your email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-transparent transition-colors duration-200" />
          <p id="email-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="password-signup" class="block text-gray-200 text-sm font-medium mb-2">Password</label>
          <input type="password" id="password-signup" placeholder="Create a password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-transparent transition-colors duration-200" />
          <p id="password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <div class="mb-6 text-left">
          <label for="confirm-password-signup" class="block text-gray-200 text-sm font-medium mb-2">Confirm Password</label>
          <input type="password" id="confirm-password-signup" placeholder="Confirm your password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-transparent transition-colors duration-200" />
          <p id="confirm-password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="signup-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Sign Up</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Already have an account? Login</a>
        </div>
      </form>
    </div>

    <div id="forgot-password-form-wrapper" class="form-wrapper glass-panel p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all duration-500 ease-in-out opacity-0 invisible">
      <form id="forgot-password-form">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8">Forgot Password</h2>
        <div class="mb-6 text-left">
          <label for="email-forgot" class="block text-gray-200 text-sm font-medium mb-2">Email</label>
          <input type="email" id="email-forgot" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-transparent transition-colors duration-200" />
          <p id="email-forgot-error" class="text-red-500 text-sm mt-1 hidden"></p>
        </div>
        <button type="submit" id="recover-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Recover Password</button>
        <div class="mt-6 text-sm">
          <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Back to Login</a>
        </div>
      </form>
    </div>
  </div>

  <div id="dashboardContainer" class="hidden h-screen flex flex-col w-full">
    <header class="glass-panel text-green-800 p-4 flex justify-between items-center shadow-md sticky top-0 z-10 lg:px-8 rounded-none border-t-0 border-l-0 border-r-0">
      <img src="myschoollogo.png" alt="University Logo" class="h-12 w-auto">
      <button id="menuToggle" class="lg:hidden text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Toggle menu">
        <i class="fas fa-bars"></i>
      </button>
      <div class="hidden lg:flex items-center space-x-6">
        <div class="relative">
          <i class="fas fa-bell text-2xl cursor-pointer text-gray-200 hover:text-green-500" title="Notifications"></i>
          <span id="notificationBadge" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full" aria-label="Unread notifications">0</span>
        </div>
        <div class="flex items-center space-x-3">
            <img id="headerProfilePic" src="https://placehold.co/40x40/eeeeee/333333?text=AV" alt="Profile Picture" class="w-10 h-10 rounded-full border-2 border-green-500">
            <div>
              <span id="userName" class="text-lg font-bold text-green-700 block">User</span>
              <span id="userProgram" class="text-sm text-gray-300 block">Program</span>
            </div>
        </div>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm" title="Logout">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
       <div class="lg:hidden flex items-center space-x-4">
        <span class="text-md font-semibold text-green-700">Welcome, <span id="userNameMobile" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition duration-300 ease-in-out shadow-sm" title="Logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <div class="flex flex-grow">
      <nav id="sidebar" class="glass-panel w-64 p-6 flex flex-col space-y-2 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20 fixed inset-y-0 left-0 lg:relative lg:flex-shrink-0 lg:h-auto overflow-y-auto rounded-none border-r border-b-0 border-t-0 border-l-0">
        <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Quick Menu</h3>
        <a onclick="showDashboardSection('home')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i> Dashboard</a>
        <a onclick="showDashboardSection('profile')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user mr-3"></i> Personal Profile</a>
        <a onclick="showDashboardSection('settings')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-cog mr-3"></i> Settings</a>

        <a onclick="toggleSubmenu('academics-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-book mr-3"></i> Academics <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="academics-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('courseReg')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-alt mr-3"></i> Course Registration</a>
          <a onclick="showDashboardSection('timetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-calendar-alt mr-3"></i> Academic Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-list mr-3"></i> Grades & Transcripts</a>
          <a onclick="showDashboardSection('examCard')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-id-card mr-3"></i> Exam Card</a>
          <a onclick="showDashboardSection('graduation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-graduation-cap mr-3"></i> Graduation Request</a>
          <a onclick="showDashboardSection('clearance')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-check-circle mr-3"></i> Clearance Request</a>
        </div>

        <a onclick="toggleSubmenu('finance-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-money-bill-wave mr-3"></i> Finance <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="finance-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('fees')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-credit-card mr-3"></i> Fees Statement</a>
        </div>
        <a onclick="showDashboardSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-hotel mr-3"></i> Hostel Accommodation</a>
        <a onclick="showDashboardSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i> Announcements</a>
      </nav>

      <main id="dashboardContent" class="flex-grow p-6 overflow-y-auto lg:ml-64 w-full">
        </main>
    </div>

    <footer class="glass-panel text-gray-600 text-center p-4 text-sm shadow-inner mt-auto rounded-none border-b-0 border-l-0 border-r-0">
      2025 © Prince Alex Design University. All rights reserved.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword, signInWithCustomToken, signInAnonymously, updateEmail, reauthenticateWithCredential, EmailAuthProvider, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, arrayUnion, arrayRemove, addDoc, getDocs, deleteDoc, where, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Firebase Config: Replace with your actual Firebase project details
    const hardcodedFirebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A", // This is a placeholder. Ensure your actual Firebase API Key is used.
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId;
    const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    if (firebaseConfigFromCanvas) {
        app = initializeApp(firebaseConfigFromCanvas);
    } else {
        // Fallback for local development if __firebase_config is not defined
        app = initializeApp(hardcodedFirebaseConfig);
    }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let currentUserData = null;

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const authContainer = document.getElementById('authContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const sidebar = document.getElementById('sidebar');
    const headerProfilePic = document.getElementById('headerProfilePic');
    const userProgramHeader = document.getElementById('userProgram');
    const notificationBadge = document.getElementById('notificationBadge');

    // --- Custom Modal Functions (replaces alert/confirm) ---
    function showCustomModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        if (modalTitle) modalTitle.innerText = title;
        if (modalMessage) modalMessage.innerText = message;

        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(true);
            };
        }
        if (modalCancelBtn) {
            modalCancelBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(false);
            };
            modalCancelBtn.classList.toggle('hidden', !isConfirm); // Toggle visibility based on isConfirm
        }
        if (modal) modal.classList.remove('hidden'); // Show modal
      });
    }

    // Overriding window.alert and window.confirm to use the custom modal
    window.alert = (message) => showCustomModal('Alert', message);
    window.confirm = (message) => showCustomModal('Confirm', message, true);
    // --- End Custom Modal Functions ---

    // Function to set button loading state
    function setButtonLoading(button, isLoading) {
      if (button) {
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<i class="fas fa-spinner animate-spin mr-2"></i>Loading...' : button.dataset.originalHtml;
      }
    }

    // Function to store original button HTML for loading state
    function storeOriginalButtonHtml() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.dataset.originalHtml = button.innerHTML;
      });
    }

    // Inline form validation utility
    function validateInput(inputElement, validationFn, errorMessageElement) {
        if (validationFn(inputElement.value)) {
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-300', 'focus:ring-green-500');
            errorMessageElement.classList.add('hidden');
            return true;
        } else {
            inputElement.classList.remove('border-gray-300', 'focus:ring-green-500');
            inputElement.classList.add('border-red-500');
            errorMessageElement.innerText = `❌ ${errorMessageElement.dataset.errorMessage || 'Invalid input.'}`;
            errorMessageElement.classList.remove('hidden');
            return false;
        }
    }

    // Email validation regex (basic)
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    // Password validation regex (at least 6 characters)
    const isValidPassword = (password) => password.length >= 6;


    // Function to show specific authentication form and hide others
    window.showForm = function(formId) {
      const forms = document.querySelectorAll('.form-wrapper');
      forms.forEach(form => {
        form.classList.remove('active');
        form.classList.add('opacity-0', 'invisible'); // Removed translate-y-5
      });
      const activeForm = document.getElementById(`${formId}-form-wrapper`);
      if (activeForm) {
        activeForm.classList.remove('opacity-0', 'invisible'); // Removed translate-y-5
        activeForm.classList.add('active');
        // Autofocus the first input in the new form
        const firstInput = activeForm.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      }
    };

    // This function runs once the DOM is fully loaded and before onAuthStateChanged fires its initial state.
    async function initializeAppUI() {
        storeOriginalButtonHtml(); // Store original button HTML for loading states
        loadingText.innerText = "Initializing session...";
        loadingOverlay.classList.remove('hidden');

        // Attach inline validation listeners
        attachFormValidationListeners();

        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                // No alert here, just console log and attempt anonymous sign-in
                await signInAnonymously(auth);
                console.log("Signed in anonymously due to custom token failure.");
            }
        } else {
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                // No alert here either, just console log
            }
        }
    }

    window.onload = initializeAppUI;

    // --- Authentication Forms Event Listeners ---
    document.getElementById('login-form').addEventListener('submit', loginUser);
    document.getElementById('signup-form').addEventListener('submit', signupUser);
    document.getElementById('forgot-password-form').addEventListener('submit', recoverPassword);

    function attachFormValidationListeners() {
        // Login form
        const emailLogin = document.getElementById('email-login');
        const emailLoginError = document.getElementById('email-login-error');
        if (emailLogin) {
            emailLoginError.dataset.errorMessage = "Please enter a valid email address.";
            emailLogin.addEventListener('input', () => validateInput(emailLogin, isValidEmail, emailLoginError));
        }
        const passwordLogin = document.getElementById('password-login');
        const passwordLoginError = document.getElementById('password-login-error');
        if (passwordLogin) {
            passwordLoginError.dataset.errorMessage = "Password must be at least 6 characters.";
            passwordLogin.addEventListener('input', () => validateInput(passwordLogin, isValidPassword, passwordLoginError));
        }

        // Signup form
        const emailSignup = document.getElementById('email-signup');
        const emailSignupError = document.getElementById('email-signup-error');
        if (emailSignup) {
            emailSignupError.dataset.errorMessage = "Please enter a valid email address.";
            emailSignup.addEventListener('input', () => validateInput(emailSignup, isValidEmail, emailSignupError));
        }
        const passwordSignup = document.getElementById('password-signup');
        const passwordSignupError = document.getElementById('password-signup-error');
        if (passwordSignup) {
            passwordSignupError.dataset.errorMessage = "Password must be at least 6 characters long.";
            passwordSignup.addEventListener('input', () => validateInput(passwordSignup, isValidPassword, passwordSignupError));
        }
        const confirmPasswordSignup = document.getElementById('confirm-password-signup');
        const confirmPasswordSignupError = document.getElementById('confirm-password-signup-error');
        if (confirmPasswordSignup) {
            confirmPasswordSignupError.dataset.errorMessage = "Passwords do not match.";
            confirmPasswordSignup.addEventListener('input', () => {
                const match = passwordSignup.value === confirmPasswordSignup.value;
                validateInput(confirmPasswordSignup, () => match, confirmPasswordSignupError);
            });
        }

        // Forgot password form
        const emailForgot = document.getElementById('email-forgot');
        const emailForgotError = document.getElementById('email-forgot-error');
        if (emailForgot) {
            emailForgotError.dataset.errorMessage = "Please enter a valid email address.";
            emailForgot.addEventListener('input', () => validateInput(emailForgot, isValidEmail, emailForgotError));
        }
    }


    // --- Authentication Flow ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("User authenticated (from onAuthStateChanged):", user.email, user.uid);

        // Fetch or create user data from Firestore
        const profileDocRef = doc(db, `students`, currentUserId);
        const profileDocSnap = await getDoc(profileDocRef);

        if (profileDocSnap.exists()) {
          currentUserData = profileDocSnap.data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          if (headerProfilePic) headerProfilePic.src = currentUserData.profilePhotoURL || 'https://placehold.co/40x40/eeeeee/333333?text=AV';
          if (userProgramHeader) userProgramHeader.innerText = currentUserData.programme && currentUserData.programme !== 'N/A' ? currentUserData.programme : "Program";

        } else {
          await setDoc(profileDocRef, {
            email: user.email,
            name: user.email.split("@")[0],
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
          });
          currentUserData = (await getDoc(profileDocRef)).data();
          document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          const userNameMobile = document.getElementById("userNameMobile");
          if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          if (headerProfilePic) headerProfilePic.src = currentUserData.profilePhotoURL || 'https://placehold.co/40x40/eeeeee/333333?text=AV';
          if (userProgramHeader) userProgramHeader.innerText = currentUserData.programme && currentUserData.programme !== 'N/A' ? currentUserData.programme : "Program";

          console.log("Created basic user profile during dashboard load fallback.");
        }

        authContainer.classList.add('hidden');
        dashboardContainer.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');

        // Setup unread notifications badge
        const unreadAnnouncementsQuery = query(collection(db, 'announcements'), where('date', '>', currentUserData.lastVisitedAnnouncements || new Date(0)));
        onSnapshot(unreadAnnouncementsQuery, (snapshot) => {
            if (notificationBadge) {
                notificationBadge.innerText = snapshot.size;
                notificationBadge.classList.toggle('hidden', snapshot.size === 0);
            }
        });

        if (currentUserData.regNo === 'N/A' || currentUserData.programme === 'N/A' || currentUserData.dob === 'N/A' || currentUserData.gender === 'N/A') {
            await showCustomModal("Welcome", "Please complete your profile information.");
            showDashboardSection('profile');
        } else {
            showDashboardSection('home');
        }

      } else {
        authContainer.classList.remove('hidden');
        dashboardContainer.classList.add('hidden');
        loadingOverlay.classList.add('hidden');
        showForm('login');
      }
    });

    // Function to log in user
    async function loginUser(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('login-btn');
      const emailInput = document.getElementById("email-login");
      const passwordInput = document.getElementById("password-login");
      const emailError = document.getElementById('email-login-error');
      const passwordError = document.getElementById('password-login-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);

      if (!isEmailValid || !isPasswordValid) {
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(loginBtn, true);

      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        await showCustomModal("Login Success", "✅ Login successful! Redirecting...");
      } catch (error) {
        let errorMessage = "❌ Login failed.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = "❌ Invalid email or password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "❌ Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Login Failed", errorMessage);
        console.error("Login error:", error);
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }

    // Function to sign up new user
    async function signupUser(event) {
      event.preventDefault();
      const signupBtn = document.getElementById('signup-btn');
      const fullNameInput = document.getElementById("full-name-signup");
      const emailInput = document.getElementById("email-signup");
      const passwordInput = document.getElementById("password-signup");
      const confirmPasswordInput = document.getElementById("confirm-password-signup");

      const emailError = document.getElementById('email-signup-error');
      const passwordError = document.getElementById('password-signup-error');
      const confirmPasswordError = document.getElementById('confirm-password-signup-error');

      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);
      const passwordsMatch = (passwordInput.value === confirmPasswordInput.value);
      const isConfirmPasswordValid = validateInput(confirmPasswordInput, () => passwordsMatch, confirmPasswordError);

      if (!isEmailValid || !isPasswordValid || !isConfirmPasswordValid || !passwordsMatch) {
          if (!passwordsMatch) {
              confirmPasswordError.innerText = "❌ Passwords do not match!";
              confirmPasswordError.classList.remove('hidden');
              confirmPasswordInput.classList.add('border-red-500');
          }
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      setButtonLoading(signupBtn, true);

      const fullName = fullNameInput.value.trim();
      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        const userDocRef = doc(db, `students`, user.uid);
        await setDoc(userDocRef, {
            email: user.email,
            name: fullName,
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
        });
        console.log("User signed up and profile created:", user.email);

        await showCustomModal("Signup Success", "✅ Signup successful! Please log in with your new account.");

        showForm('login');

      } catch (error) {
        let errorMessage = "❌ Signup failed.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "❌ Email already in use. Try logging in or recovering password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Invalid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "❌ Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Signup Failed", errorMessage);
        console.error("Signup error:", error);
      } finally {
        setButtonLoading(signupBtn, false);
      }
    }

    // Function to recover password
    async function recoverPassword(event) {
      event.preventDefault();
      const recoverBtn = document.getElementById('recover-btn');
      const emailInput = document.getElementById("email-forgot");
      const emailError = document.getElementById('email-forgot-error');
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      if (!isEmailValid) {
          await showCustomModal("Validation Error", "Please enter a valid email address.");
          return;
      }
      setButtonLoading(recoverBtn, true);
      const email = emailInput.value.trim().toLowerCase();
      try {
        await sendPasswordResetEmail(auth, email);
        await showCustomModal("Password Recovery", "✅ Password reset email sent! Check your inbox.");
      } catch (error) {
        let errorMessage = "❌ Failed to send password reset email.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "❌ No account found with that email.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Password Recovery Failed", errorMessage);
        console.error("Password recovery error:", error);
      } finally {
        setButtonLoading(recoverBtn, false);
      }
    }

    // --- Dashboard Specific Functions ---
    // Logout function
    window.confirmLogout = async function() {
      const response = await confirm("Are you sure you want to log out?");
      if (response) {
        try {
          loadingText.innerText = "Logging out...";
          loadingOverlay.classList.remove('hidden');
          await signOut(auth);
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error logging out. Please try again.");
          loadingOverlay.classList.add('hidden');
        }
      }
    };

    window.toggleSubmenu = function(id) {
      const submenu = document.getElementById(id);
      if (submenu) submenu.classList.toggle('hidden');
      const chevron = submenu.previousElementSibling.querySelector('.fa-chevron-down');
      if (chevron) {
        chevron.classList.toggle('rotate-180');
      }
    };

    document.getElementById('menuToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.toggle('-translate-x-full');
    });

    function generateBreadcrumb(currentSectionTitle) {
      return `
        <div class="text-sm text-gray-300 mb-6">
          <a onclick="showDashboardSection('home')" class="text-green-500 hover:underline cursor-pointer">Dashboard</a>
          <span class="mx-2">/</span>
          <span class="font-semibold text-green-300">${currentSectionTitle}</span>
        </div>
      `;
    }

    function showLoading(text) {
      loadingText.innerText = text;
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // Function to toggle collapsible sections (for Settings and Announcements)
    function setupCollapsibles() {
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.removeEventListener('click', toggleCollapsible); // Remove old listeners
            header.addEventListener('click', toggleCollapsible); // Add new listener
        });
    }

    function toggleCollapsible(event) {
        const header = event.currentTarget;
        const content = header.nextElementSibling; // Get the content div
        if (content && content.classList.contains('collapsible-content')) {
            const isExpanded = header.classList.toggle('expanded');
            content.classList.toggle('expanded', isExpanded); // Toggle content visibility/height
        }
    }

    // --- GPA Calculation Utility ---
    function calculateGPA(grades) {
      let totalPoints = 0;
      let totalUnits = 0;
      const gradeMap = {
        'A': 4.0,
        'B+': 3.5,
        'B': 3.0,
        'C+': 2.5,
        'C': 2.0,
        'D+': 1.5,
        'D': 1.0,
        'F': 0.0
      };
      grades.forEach(g => {
        const courseUnit = g.courseUnit || 3;
        const gradePoint = gradeMap[g.grade.toUpperCase().trim()] || 0;
        totalPoints += gradePoint * courseUnit;
        totalUnits += courseUnit;
      });
      return totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : "0.00";
    }

    // --- Section-Specific Loaders ---
    // 1. Home Dashboard
    async function loadHome() {
      const content = document.getElementById("dashboardContent");
      const announcementsRef = collection(db, `announcements`);
      const gradesRef = collection(db, `students/${currentUserId}/grades`);
      const feesRef = collection(db, `students/${currentUserId}/feesStatement`);
      const registrationsRef = collection(db, `students/${currentUserId}/registrations`);


      // --- Initial Render with placeholders ---
      const initialStudentName = currentUserData?.name || "Student";
      const initialStudentProgramme = currentUserData?.programme && currentUserData.programme !== 'N/A' ? currentUserData.programme : "Programme Not Set";
      const initialStudentRegNo = currentUserData?.regNo && currentUserData.regNo !== 'N/A' ? currentUserData.regNo : "Registration Number Not Set";
      const initialProfilePhotoURL = currentUserData?.profilePhotoURL || 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';
      const homeContentHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-lg flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6 mb-8">
          <img id="dashboardProfilePhoto" src="${initialProfilePhotoURL}" alt="Profile Photo" class="w-20 h-20 rounded-full border-4 border-green-500 shadow-md">
          <div class="text-center md:text-left">
            <h2 class="text-2xl font-bold text-green-800">Welcome back, <span id="dashboardStudentName">${initialStudentName}</span>!</h2>
            <p class="text-gray-300"><span id="dashboardStudentProgramme">${initialStudentProgramme}</span> | <span id="dashboardStudentRegNo">${initialStudentRegNo}</span></p>
            <p class="text-gray-300 mt-2">Ready to embark on a productive day? Your academic journey awaits! 🚀</p>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <div id="registeredUnitsCard" class="dashboard-stat-card">
            <h3 class="text-lg font-bold mb-2">Registered Units</h3>
            <p class="text-4xl font-extrabold text-green-500 mt-4">--</p>
            <p class="text-gray-400">Total courses registered</p>
          </div>
          <div id="feesBalanceCard" class="dashboard-stat-card">
            <h3 class="text-lg font-bold mb-2">Fees Balance</h3>
            <p class="text-4xl font-extrabold text-gray-400 mt-4">GHS 0.00</p>
            <p id="feesBalanceStatus" class="text-gray-400">Outstanding balance: <span class="font-semibold text-gray-400">Loading...</span></p>
          </div>
          <div id="semesterProgressCard" class="dashboard-stat-card">
            <h3 class="text-lg font-bold mb-2">Semester Progress</h3>
            <p class="text-4xl font-extrabold text-blue-500 mt-4">--</p>
            <p class="text-gray-400">Next exam date or semester info</p>
          </div>
        </div>
        <div class="glass-panel p-6 rounded-xl shadow-md border-t-4 border-green-600 mb-8">
          <h3 class="text-xl font-bold text-green-800 mb-4">Latest Announcements</h3>
          <div id="announcementsList" class="space-y-4 no-scrollbar max-h-96 overflow-y-auto">
            <p class="text-gray-400">Loading announcements...</p>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Dashboard") + homeContentHtml;

      // Update header details from current user data
      if (headerProfilePic) headerProfilePic.src = currentUserData.profilePhotoURL || 'https://placehold.co/40x40/eeeeee/333333?text=AV';
      if (userProgramHeader) userProgramHeader.innerText = currentUserData.programme && currentUserData.programme !== 'N/A' ? currentUserData.programme : "Program";


      // --- Data Fetching and Updating UI ---
      // Fetch Registered Units
      const registeredUnitsCard = document.getElementById('registeredUnitsCard');
      const registeredUnitsQuery = query(registrationsRef);
      onSnapshot(registeredUnitsQuery, (querySnapshot) => {
          if (registeredUnitsCard) {
              const count = querySnapshot.size;
              registeredUnitsCard.querySelector('p:first-of-type').innerText = count;
              registeredUnitsCard.querySelector('p:last-of-type').innerText = `Total courses registered`;
          }
      }, (error) => {
          console.error("Error fetching registered units:", error);
          if (registeredUnitsCard) registeredUnitsCard.querySelector('p:first-of-type').innerText = "Error";
      });


      // Fetch Fees Balance
      const feesBalanceCard = document.getElementById('feesBalanceCard');
      const feesBalanceStatusEl = document.getElementById('feesBalanceStatus');
      const feesQuery = query(feesRef, orderBy("date", "desc"));
      onSnapshot(feesQuery, (querySnapshot) => {
        const transactions = querySnapshot.docs.map(doc => doc.data());
        let balance = 0;
        transactions.forEach(t => {
          balance += t.debit || 0;
          balance -= t.credit || 0;
        });

        if (feesBalanceCard) {
            feesBalanceCard.querySelector('p:first-of-type').innerText = `GHS ${balance.toFixed(2)}`;
            feesBalanceCard.classList.remove('red-border', 'green-border'); // Reset borders
            if (balance > 0) {
              feesBalanceCard.classList.add('red-border');
              feesBalanceCard.querySelector('p:first-of-type').classList.remove('text-gray-400');
              feesBalanceCard.querySelector('p:first-of-type').classList.add('text-red-500');
              if (feesBalanceStatusEl) feesBalanceStatusEl.innerHTML = `Outstanding balance: <span class="font-semibold text-red-500">Outstanding</span>`;
            } else {
              feesBalanceCard.classList.add('green-border');
              feesBalanceCard.querySelector('p:first-of-type').classList.remove('text-gray-400');
              feesBalanceCard.querySelector('p:first-of-type').classList.add('text-green-500');
              if (feesBalanceStatusEl) feesBalanceStatusEl.innerHTML = `Outstanding balance: <span class="font-semibold text-green-500">Cleared</span>`;
            }
        }
      });

      // Semester Progress / Next Exam Date
      const semesterProgressCard = document.getElementById('semesterProgressCard');
      const studentSemester = currentUserData.semester && currentUserData.semester !== 'N/A' ? currentUserData.semester : null;
      const studentYear = currentUserData.yearOfStudy && currentUserData.yearOfStudy !== 'N/A' ? currentUserData.yearOfStudy : null;

      if (semesterProgressCard) {
          if (studentSemester && studentYear) {
              semesterProgressCard.querySelector('p:first-of-type').innerText = `Year ${studentYear}, Sem ${studentSemester}`;
              semesterProgressCard.querySelector('p:last-of-type').innerText = "Current Semester";
              semesterProgressCard.classList.add('blue-border'); /* You can define a blue-border if needed */
              semesterProgressCard.querySelector('p:first-of-type').classList.add('text-blue-500');
          } else {
              semesterProgressCard.querySelector('p:first-of-type').innerText = "N/A";
              semesterProgressCard.querySelector('p:last-of-type').innerText = "Update your profile for details.";
              semesterProgressCard.classList.add('red-border');
          }
      }


      // Fetch Announcements
      const announcementsQuery = query(announcementsRef, orderBy("date", "desc"), limit(3));
      onSnapshot(announcementsQuery, (querySnapshot) => {
        const announcementsList = document.getElementById('announcementsList');
        announcementsList.innerHTML = '';
        if (querySnapshot.empty) {
          announcementsList.innerHTML = `<p class="text-gray-400">No recent announcements.</p>`;
        } else {
          querySnapshot.forEach(doc => {
            const announcement = doc.data();
            const date = announcement.date ? new Date(announcement.date.toDate()).toLocaleDateString() : 'N/A';
            const itemHtml = `
              <div class="glass-panel border-b pb-3 p-4 mb-2">
                <p class="text-sm text-gray-400">${date}</p>
                <h4 class="font-semibold text-md text-green-500">${announcement.title}</h4>
                <p class="text-sm text-gray-300">${announcement.content}</p>
              </div>
            `;
            announcementsList.innerHTML += itemHtml;
          });
        }
      });
    }

    // 2. Course Registration
    async function loadCourseReg() {
      const content = document.getElementById("dashboardContent");
      const courseRegHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Course Registration</h2>
          <form id="course-reg-form">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              <div>
                <label for="reg-department" class="block text-gray-200 font-medium mb-2">Department</label>
                <select id="reg-department" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
                  <option value="">Select Department</option>
                </select>
              </div>
              <div>
                <label for="reg-year" class="block text-gray-200 font-medium mb-2">Year of Study</label>
                <select id="reg-year" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
                  <option value="">Select Year</option>
                  <option value="1">Year 1</option>
                  <option value="2">Year 2</option>
                  <option value="3">Year 3</option>
                  <option value="4">Year 4</option>
                </select>
              </div>
              <div>
                <label for="reg-semester" class="block text-gray-200 font-medium mb-2">Semester</label>
                <select id="reg-semester" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
                  <option value="">Select Semester</option>
                  <option value="1">Semester 1</option>
                  <option value="2">Semester 2</option>
                </select>
              </div>
              <div>
                <label for="reg-course" class="block text-gray-200 font-medium mb-2">Course</label>
                <select id="reg-course" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
                  <option value="">Select Course</option>
                </select>
              </div>
            </div>
            <button type="submit" id="registerCourseBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
              Register Course
            </button>
          </form>
          <div id="courseRegStatus" class="mt-6 text-md font-semibold text-center hidden"></div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Course Registration") + courseRegHtml;

      const deptSelect = document.getElementById('reg-department');
      const yearSelect = document.getElementById('reg-year');
      const semesterSelect = document.getElementById('reg-semester');
      const courseSelect = document.getElementById('reg-course');
      const regForm = document.getElementById('course-reg-form');
      const regStatus = document.getElementById('courseRegStatus');

      let allCourses = [];

      // Fetch all courses and populate initial dropdowns
      showLoading("Fetching courses...");
      try {
        const coursesQuery = query(collection(db, 'courses'));
        const querySnapshot = await getDocs(coursesQuery);
        allCourses = querySnapshot.docs.map(doc => doc.data());

        const departments = [...new Set(allCourses.map(c => c.department))];
        departments.sort();
        departments.forEach(d => {
          const option = document.createElement('option');
          option.value = d;
          option.textContent = d;
          deptSelect.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching courses:", error);
        alert("Failed to load courses. Please try again.");
      } finally {
        hideLoading();
      }

      // Filter courses based on selections
      const filterCourses = () => {
        const selectedDept = deptSelect.value;
        const selectedYear = yearSelect.value;
        const selectedSem = semesterSelect.value;

        courseSelect.innerHTML = '<option value="">Select Course</option>';
        const filteredCourses = allCourses.filter(c =>
          (selectedDept === "" || c.department === selectedDept) &&
          (selectedYear === "" || c.yearOfStudy === parseInt(selectedYear)) &&
          (selectedSem === "" || c.semester === parseInt(selectedSem))
        );

        if (filteredCourses.length > 0) {
          filteredCourses.sort((a, b) => a.courseCode.localeCompare(b.courseCode));
          filteredCourses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.courseCode;
            option.textContent = `${course.courseCode} - ${course.courseName}`;
            courseSelect.appendChild(option);
          });
        }
      };

      deptSelect.addEventListener('change', filterCourses);
      yearSelect.addEventListener('change', filterCourses);
      semesterSelect.addEventListener('change', filterCourses);

      regForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const registerBtn = document.getElementById('registerCourseBtn');
        setButtonLoading(registerBtn, true);
        regStatus.classList.add('hidden');

        const courseCode = courseSelect.value;
        if (!courseCode) {
          alert("Please select a course to register.");
          setButtonLoading(registerBtn, false);
          return;
        }

        const selectedCourse = allCourses.find(c => c.courseCode === courseCode);
        const student = currentUserData;

        // Validation based on student's profile
        if (student.department !== selectedCourse.department || student.yearOfStudy !== selectedCourse.yearOfStudy || student.semester !== selectedCourse.semester) {
          regStatus.innerText = "❌ Registration failed: This course does not match your academic profile.";
          regStatus.classList.remove('hidden');
          setButtonLoading(registerBtn, false);
          return;
        }

        try {
          const studentRegistrationsRef = collection(db, `students/${currentUserId}/registrations`);
          const existingRegQuery = query(studentRegistrationsRef, where("courseCode", "==", courseCode));
          const existingRegSnapshot = await getDocs(existingRegQuery);

          if (!existingRegSnapshot.empty) {
            regStatus.innerText = "⚠️ You are already registered for this course.";
            regStatus.classList.remove('hidden');
          } else {
            await addDoc(studentRegistrationsRef, {
              courseCode: selectedCourse.courseCode,
              courseName: selectedCourse.courseName,
              department: selectedCourse.department,
              yearOfStudy: selectedCourse.yearOfStudy,
              semester: selectedCourse.semester,
              registeredAt: new Date(),
              status: "Registered"
            });
            regStatus.innerText = "✅ Registration successful!";
            regStatus.classList.remove('hidden');
            await showCustomModal("Success", "Course registered successfully!");
          }
        } catch (error) {
          console.error("Error registering course:", error);
          regStatus.innerText = "❌ An error occurred during registration. Please try again.";
          regStatus.classList.remove('hidden');
        } finally {
          setButtonLoading(registerBtn, false);
        }
      });
    }

    // 3. Academic Timetable
    async function loadTimetable() {
      const content = document.getElementById("dashboardContent");
      const timetableHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Academic Timetable</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <div>
              <label for="tt-department" class="block text-gray-200 font-medium mb-2">Department</label>
              <select id="tt-department" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200">
                <option value="">Select Department</option>
              </select>
            </div>
            <div>
              <label for="tt-year" class="block text-gray-200 font-medium mb-2">Year of Study</label>
              <select id="tt-year" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200">
                <option value="">Select Year</option>
                <option value="1">Year 1</option>
                <option value="2">Year 2</option>
                <option value="3">Year 3</option>
                <option value="4">Year 4</option>
              </select>
            </div>
            <div>
              <label for="tt-semester" class="block text-gray-200 font-medium mb-2">Semester</label>
              <select id="tt-semester" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200">
                <option value="">Select Semester</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
              </select>
            </div>
          </div>
          <div id="timetableDisplay" class="overflow-x-auto">
            <p class="text-center text-gray-400 mt-8">Please select a Department, Year, and Semester to view the timetable.</p>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Academic Timetable") + timetableHtml;

      const deptSelect = document.getElementById('tt-department');
      const yearSelect = document.getElementById('tt-year');
      const semesterSelect = document.getElementById('tt-semester');
      const timetableDisplay = document.getElementById('timetableDisplay');

      let allTimetables = [];
      let allDepartments = [];

      // Fetch all timetable data and departments on load
      showLoading("Loading timetable data...");
      try {
          const timetableDocs = await getDocs(collection(db, 'timetables'));
          allTimetables = timetableDocs.docs.map(doc => doc.data());
          allDepartments = [...new Set(allTimetables.map(t => t.department))].sort();

          allDepartments.forEach(d => {
              const option = document.createElement('option');
              option.value = d;
              option.textContent = d;
              deptSelect.appendChild(option);
          });

      } catch (error) {
          console.error("Error fetching timetable data:", error);
          alert("Failed to load timetable data. Please try again.");
      } finally {
          hideLoading();
      }

      const renderTimetable = () => {
        const selectedDept = deptSelect.value;
        const selectedYear = parseInt(yearSelect.value);
        const selectedSem = parseInt(semesterSelect.value);

        if (!selectedDept || !selectedYear || !selectedSem) {
          timetableDisplay.innerHTML = `<p class="text-center text-gray-400 mt-8">Please select a Department, Year, and Semester to view the timetable.</p>`;
          return;
        }

        const filteredTimetables = allTimetables.filter(t =>
          t.department === selectedDept && t.yearOfStudy === selectedYear && t.semester === selectedSem
        );

        if (filteredTimetables.length === 0) {
          timetableDisplay.innerHTML = `<p class="text-center text-red-500 font-semibold mt-8">No timetable found for the selected criteria. Please check back later.</p>`;
          return;
        }

        // Aggregate classes by day and time
        const classesByDay = {
          'Monday': [], 'Tuesday': [], 'Wednesday': [], 'Thursday': [], 'Friday': []
        };
        const allTimes = new Set();
        filteredTimetables.forEach(t => {
          t.days.forEach(day => {
            if (classesByDay[day]) {
              classesByDay[day].push(t);
              allTimes.add(t.startTime);
              allTimes.add(t.endTime);
            }
          });
        });
        const sortedTimes = [...allTimes].sort();

        // Mobile View (Stacked Cards)
        const mobileTimetableHtml = `
          <div class="lg:hidden">
            ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => `
              <div class="timetable-day-card glass-panel">
                <h3 class="timetable-day-title">${day}</h3>
                ${classesByDay[day].length > 0 ? classesByDay[day].map(cls => `
                  <div class="timetable-class-item">
                    <p class="font-bold text-gray-100">${cls.startTime} - ${cls.endTime}</p>
                    <p class="text-gray-200">${cls.courseCode} - ${cls.courseName}</p>
                    <p class="text-sm text-gray-400">Lecturer: ${cls.lecturer}</p>
                    <p class="text-sm text-gray-400">Venue: ${cls.venue}</p>
                  </div>
                `).join('') : '<p class="text-gray-400">No classes</p>'}
              </div>
            `).join('')}
          </div>
        `;

        // Desktop View (Grid)
        const desktopTimetableHtml = `
          <div class="hidden lg:block timetable-grid">
            <div class="timetable-header">Time</div>
            <div class="timetable-header">Monday</div>
            <div class="timetable-header">Tuesday</div>
            <div class="timetable-header">Wednesday</div>
            <div class="timetable-header">Thursday</div>
            <div class="timetable-header">Friday</div>
            ${sortedTimes.map(time => `
              <div class="timetable-header">${time}</div>
              ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => {
                const classAtTime = classesByDay[day].find(c => c.startTime === time);
                if (classAtTime) {
                  return `
                    <div class="timetable-cell">
                      <p class="font-bold">${classAtTime.courseCode}</p>
                      <p>${classAtTime.courseName}</p>
                      <p class="text-sm text-gray-600">${classAtTime.lecturer}</p>
                      <p class="text-sm text-gray-600">${classAtTime.venue}</p>
                    </div>
                  `;
                } else {
                  return `<div class="timetable-cell"></div>`;
                }
              }).join('')}
            `).join('')}
          </div>
        `;

        timetableDisplay.innerHTML = mobileTimetableHtml + desktopTimetableHtml;
      };

      deptSelect.addEventListener('change', renderTimetable);
      yearSelect.addEventListener('change', renderTimetable);
      semesterSelect.addEventListener('change', renderTimetable);
    }

    // 4. Grades & Transcripts
    async function loadGrades() {
      const content = document.getElementById("dashboardContent");
      const gradesHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Grades & Transcripts</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <label for="grades-year" class="block text-gray-200 font-medium mb-2">Year of Study</label>
              <select id="grades-year" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200">
                <option value="all">All Years</option>
              </select>
            </div>
            <div>
              <label for="grades-semester" class="block text-gray-200 font-medium mb-2">Semester</label>
              <select id="grades-semester" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200">
                <option value="all">All Semesters</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
              </select>
            </div>
          </div>
          <div class="overflow-x-auto mb-6">
            <table class="min-w-full glass-panel border-collapse">
              <thead class="bg-gray-200 text-gray-200">
                <tr>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Course Code</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Course Name</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Grade</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Semester</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700">Year</th>
                </tr>
              </thead>
              <tbody id="gradesTableBody">
                <tr><td colspan="5" class="text-center py-4 text-gray-400">Loading grades...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="glass-panel p-4 rounded-md flex flex-col md:flex-row justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-green-800">Cumulative GPA (CGPA): <span id="cgpaValue" class="text-xl font-extrabold text-green-500">0.00</span></h3>
            <h3 class="text-lg font-bold text-green-800">Current GPA: <span id="gpaValue" class="text-xl font-extrabold text-green-500">0.00</span></h3>
          </div>
          <div class="flex justify-start space-x-4">
            <button onclick="generateTranscript()" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">
              <i class="fas fa-file-pdf mr-2"></i>Generate Transcript (PDF)
            </button>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Grades & Transcripts") + gradesHtml;

      const gradesTableBody = document.getElementById('gradesTableBody');
      const gradesYearSelect = document.getElementById('grades-year');
      const gradesSemesterSelect = document.getElementById('grades-semester');
      const gpaValue = document.getElementById('gpaValue');
      const cgpaValue = document.getElementById('cgpaValue');

      let allGrades = [];

      const renderGrades = () => {
        const selectedYear = gradesYearSelect.value;
        const selectedSemester = gradesSemesterSelect.value;

        let filteredGrades = allGrades;
        if (selectedYear !== 'all') {
          filteredGrades = filteredGrades.filter(g => g.yearOfStudy === parseInt(selectedYear));
        }
        if (selectedSemester !== 'all') {
          filteredGrades = filteredGrades.filter(g => g.semester === parseInt(selectedSemester));
        }

        gradesTableBody.innerHTML = '';
        if (filteredGrades.length === 0) {
          gradesTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">No grades found for the selected filter.</td></tr>`;
          gpaValue.innerText = "0.00";
        } else {
          filteredGrades.forEach(grade => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="py-3 px-4 border-b border-gray-700 border-r">${grade.courseCode}</td>
              <td class="py-3 px-4 border-b border-gray-700 border-r">${grade.courseName}</td>
              <td class="py-3 px-4 border-b border-gray-700 border-r font-bold">${grade.grade}</td>
              <td class="py-3 px-4 border-b border-gray-700 border-r">${grade.semester}</td>
              <td class="py-3 px-4 border-b border-gray-700">${grade.yearOfStudy}</td>
            `;
            gradesTableBody.appendChild(row);
          });
          gpaValue.innerText = calculateGPA(filteredGrades);
        }
      };

      const fetchGrades = onSnapshot(collection(db, `students/${currentUserId}/grades`), (querySnapshot) => {
        allGrades = querySnapshot.docs.map(doc => doc.data());
        allGrades.sort((a, b) => {
          if (a.yearOfStudy !== b.yearOfStudy) return a.yearOfStudy - b.yearOfStudy;
          return a.semester - b.semester;
        });

        // Populate year filter
        const years = [...new Set(allGrades.map(g => g.yearOfStudy))].sort();
        gradesYearSelect.innerHTML = '<option value="all">All Years</option>';
        years.forEach(y => {
          const option = document.createElement('option');
          option.value = y;
          option.textContent = `Year ${y}`;
          gradesYearSelect.appendChild(option);
        });

        cgpaValue.innerText = calculateGPA(allGrades);
        renderGrades();
      });

      gradesYearSelect.addEventListener('change', renderGrades);
      gradesSemesterSelect.addEventListener('change', renderGrades);
    }

    // PDF Generation Logic (Transcript)
    window.generateTranscript = async function() {
        const studentInfo = currentUserData;
        if (!studentInfo || studentInfo.regNo === 'N/A') {
            await showCustomModal("Error", "Student information is incomplete. Please update your profile first.");
            return;
        }

        showLoading("Generating transcript...");
        try {
            const gradesSnapshot = await getDocs(query(collection(db, `students/${currentUserId}/grades`), orderBy("yearOfStudy"), orderBy("semester")));
            const allGrades = gradesSnapshot.docs.map(doc => doc.data());
            const cgpa = calculateGPA(allGrades);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.setTextColor(0, 51, 0); // Dark Green
            doc.text("OFFICIAL ACADEMIC TRANSCRIPT", 105, 20, null, null, "center");
            doc.setFontSize(10);
            doc.setTextColor(51, 51, 51); // Dark Gray
            doc.text("Prince Alex Design University", 105, 27, null, null, "center");
            doc.text("P.O Box 1234, University Road, Cityville", 105, 32, null, null, "center");
            doc.text("www.princealex.edu", 105, 37, null, null, "center");
            doc.addImage('myschoollogo.png', 'PNG', 10, 15, 30, 30); // Logo

            // Student Info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "bold");
            doc.text("Student Information:", 15, 50);
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${studentInfo.name}`, 15, 57);
            doc.text(`Student ID: ${studentInfo.regNo}`, 15, 62);
            doc.text(`Program: ${studentInfo.programme}`, 15, 67);
            doc.text(`Date of Issue: ${new Date().toLocaleDateString()}`, 15, 72);

            // Grades Table
            const tableHeaders = ["Course Code", "Course Name", "Grade", "Semester", "Year of Study"];
            const tableData = allGrades.map(g => [
                g.courseCode,
                g.courseName,
                g.grade,
                g.semester,
                g.yearOfStudy
            ]);

            doc.autoTable({
                startY: 80,
                head: [tableHeaders],
                body: tableData,
                styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [0, 100, 0], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 75, left: 15, right: 15, bottom: 20 },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(8);
                    doc.text("Prince Alex Design University | Official Transcript", data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            // Summary
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Academic Summary:", 15, finalY);
            doc.setFont("helvetica", "normal");
            doc.text(`Cumulative GPA (CGPA): ${cgpa}`, 15, finalY + 7);
            doc.text("Remarks: Good Standing", 15, finalY + 14);

            doc.save(`Transcript-${studentInfo.regNo}.pdf`);
        } catch (error) {
            console.error("Error generating PDF:", error);
            await showCustomModal("Error", "Failed to generate transcript. Please try again.");
        } finally {
            hideLoading();
        }
    };

    // 5. Graduation Request
    async function loadGraduation() {
      const content = document.getElementById("dashboardContent");
      const graduationHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Graduation Request</h2>
          <form id="graduation-form">
            <div class="space-y-4 mb-6">
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Student Name:</p>
                <p id="grad-name" class="font-semibold text-gray-200">${currentUserData.name || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Student ID:</p>
                <p id="grad-regno" class="font-semibold text-gray-200">${currentUserData.regNo || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Program:</p>
                <p id="grad-program" class="font-semibold text-gray-200">${currentUserData.programme || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <label for="expected-grad-date" class="block text-gray-200 font-medium mb-2">Expected Graduation Date</label>
                <input type="date" id="expected-grad-date" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <label for="grad-special-notes" class="block text-gray-200 font-medium mb-2">Special Notes (Optional)</label>
                <textarea id="grad-special-notes" rows="3" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" placeholder="e.g., specific ceremony requests, diploma delivery address if different"></textarea>
              </div>
            </div>
            <div id="gradEligibilityStatus" class="p-4 rounded-md mb-6 hidden"></div>
            <button type="submit" id="submitGradRequestBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
              Submit Graduation Request
            </button>
          </form>
          <div class="mt-8">
            <h3 class="text-xl font-bold text-green-800 mb-4">Your Graduation Request Status</h3>
            <div id="gradRequestStatusDisplay" class="glass-panel p-4 rounded-md text-gray-300">
              <p>No pending graduation request.</p>
            </div>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Graduation Request") + graduationHtml;

      const gradForm = document.getElementById('graduation-form');
      const gradEligibilityStatus = document.getElementById('gradEligibilityStatus');
      const gradRequestStatusDisplay = document.getElementById('gradRequestStatusDisplay');
      const submitGradRequestBtn = document.getElementById('submitGradRequestBtn');

      let currentGradRequest = null;

      // Check eligibility and existing request on load
      const checkGraduationStatus = async () => {
        showLoading("Checking graduation status...");
        try {
          const gradRequestDocRef = doc(db, `students/${currentUserId}/graduation`, 'request');
          const gradRequestSnap = await getDoc(gradRequestDocRef);
          if (gradRequestSnap.exists()) {
            currentGradRequest = gradRequestSnap.data();
            gradRequestStatusDisplay.innerHTML = `
              <p><strong>Status:</strong> <span class="font-bold text-blue-500">${currentGradRequest.status}</span></p>
              <p><strong>Requested Date:</strong> ${new Date(currentGradRequest.expectedGradDate.toDate()).toLocaleDateString()}</p>
              <p><strong>Submitted On:</strong> ${new Date(currentGradRequest.submittedAt.toDate()).toLocaleDateString()}</p>
              ${currentGradRequest.notes ? `<p><strong>Notes:</strong> ${currentGradRequest.notes}</p>` : ''}
              ${currentGradRequest.adminComments ? `<p><strong>Admin Comments:</strong> <span class="text-yellow-500">${currentGradRequest.adminComments}</span></p>` : ''}
              <button id="cancelGradRequestBtn" class="mt-4 bg-red-600 hover:bg-red-700 text-white py-1 px-4 rounded-md">Cancel Request</button>
            `;
            if (currentGradRequest.status === 'Approved' || currentGradRequest.status === 'Denied') {
              submitGradRequestBtn.disabled = true;
              gradForm.querySelector('input, textarea').forEach(el => el.disabled = true);
              if (document.getElementById('cancelGradRequestBtn')) document.getElementById('cancelGradRequestBtn').disabled = true;
            } else {
              submitGradRequestBtn.disabled = false;
              if (document.getElementById('cancelGradRequestBtn')) {
                document.getElementById('cancelGradRequestBtn').addEventListener('click', async () => {
                  const confirm = await showCustomModal('Confirm Cancellation', 'Are you sure you want to cancel your graduation request?', true);
                  if (confirm) {
                    showLoading("Cancelling request...");
                    await deleteDoc(gradRequestDocRef);
                    currentGradRequest = null;
                    await showCustomModal("Cancelled", "Graduation request cancelled.");
                    checkGraduationStatus(); // Re-render status
                  }
                  hideLoading();
                });
              }
            }
          } else {
            gradRequestStatusDisplay.innerHTML = `<p>No pending graduation request.</p>`;
            submitGradRequestBtn.disabled = false;
            gradForm.querySelector('input, textarea').forEach(el => el.disabled = false);
          }

          // Simple eligibility check (can be expanded)
          const gradesSnapshot = await getDocs(collection(db, `students/${currentUserId}/grades`));
          const totalGrades = gradesSnapshot.size;
          const cgpa = calculateGPA(gradesSnapshot.docs.map(doc => doc.data()));
          const hasOutstandingFees = await checkFeesBalance(); // This function would need to be defined
          const hasOutstandingClearance = await checkClearanceStatus(); // This would also need to be defined

          gradEligibilityStatus.classList.remove('hidden');
          if (parseFloat(cgpa) >= 2.0 && totalGrades >= 40 && !hasOutstandingFees && !hasOutstandingClearance) {
            gradEligibilityStatus.innerHTML = `<p class="text-green-500"><i class="fas fa-check-circle"></i> You are provisionally eligible for graduation!</p>`;
            gradEligibilityStatus.classList.add('bg-green-100', 'border-green-600');
            gradEligibilityStatus.classList.remove('bg-red-100', 'border-red-600');
            submitGradRequestBtn.disabled = currentGradRequest !== null;
          } else {
            let message = `<p class="text-red-500"><i class="fas fa-times-circle"></i> You are currently not eligible for graduation. Reasons:</p><ul class="list-disc ml-5 text-sm text-gray-300">`;
            if (parseFloat(cgpa) < 2.0) message += `<li>CGPA too low (${cgpa}). Minimum 2.0 required.</li>`;
            if (totalGrades < 40) message += `<li>Insufficient registered courses (${totalGrades}). At least 40 required.</li>`;
            if (hasOutstandingFees) message += `<li>Outstanding fees balance.</li>`;
            if (hasOutstandingClearance) message += `<li>Outstanding clearance items.</li>`;
            message += `</ul>`;
            gradEligibilityStatus.innerHTML = message;
            gradEligibilityStatus.classList.add('bg-red-100', 'border-red-600');
            gradEligibilityStatus.classList.remove('bg-green-100', 'border-green-600');
            submitGradRequestBtn.disabled = true; // Disable if not eligible or request already exists
          }
        } catch (error) {
          console.error("Error checking graduation status:", error);
          gradEligibilityStatus.innerHTML = `<p class="text-red-500">Error checking eligibility. Please try again.</p>`;
          gradEligibilityStatus.classList.add('bg-red-100');
        } finally {
          hideLoading();
        }
      };

      // Helper stubs for eligibility checks
      async function checkFeesBalance() {
          const feesSnapshot = await getDocs(collection(db, `students/${currentUserId}/feesStatement`));
          let balance = 0;
          feesSnapshot.forEach(doc => {
              const data = doc.data();
              balance += data.debit || 0;
              balance -= data.credit || 0;
          });
          return balance > 0;
      }

      async function checkClearanceStatus() {
          const clearanceSnapshot = await getDoc(doc(db, `students/${currentUserId}/clearance`, 'status'));
          if (clearanceSnapshot.exists()) {
              const data = clearanceSnapshot.data();
              return data.status !== 'Cleared'; // Return true if not cleared
          }
          return true; // Assume not cleared if no document exists
      }


      gradForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        setButtonLoading(submitGradRequestBtn, true);

        const expectedGradDate = document.getElementById('expected-grad-date').value;
        const specialNotes = document.getElementById('grad-special-notes').value.trim();

        if (!expectedGradDate) {
          await showCustomModal("Validation Error", "Please select an expected graduation date.");
          setButtonLoading(submitGradRequestBtn, false);
          return;
        }

        try {
          const gradRequestDocRef = doc(db, `students/${currentUserId}/graduation`, 'request');
          await setDoc(gradRequestDocRef, {
            expectedGradDate: new Date(expectedGradDate),
            specialNotes: specialNotes,
            status: "Pending",
            submittedAt: new Date(),
            studentId: currentUserId,
            studentName: currentUserData.name,
            studentRegNo: currentUserData.regNo,
            studentProgram: currentUserData.programme
          });
          await showCustomModal("Success", "Graduation request submitted successfully! We will review your application.");
          checkGraduationStatus(); // Re-render status
        } catch (error) {
          console.error("Error submitting graduation request:", error);
          await showCustomModal("Error", "Failed to submit graduation request. Please try again.");
        } finally {
          setButtonLoading(submitGradRequestBtn, false);
        }
      });

      checkGraduationStatus(); // Initial load
    }

    // 6. Clearance Request
    async function loadClearance() {
      const content = document.getElementById("dashboardContent");
      const clearanceHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Clearance Request</h2>
          <form id="clearance-form">
            <div class="space-y-4 mb-6">
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Student Name:</p>
                <p id="clearance-name" class="font-semibold text-gray-200">${currentUserData.name || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Student ID:</p>
                <p id="clearance-regno" class="font-semibold text-gray-200">${currentUserData.regNo || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Program:</p>
                <p id="clearance-program" class="font-semibold text-gray-200">${currentUserData.programme || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <label for="clearance-type" class="block text-gray-200 font-medium mb-2">Clearance Type</label>
                <select id="clearance-type" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
                  <option value="">Select Type</option>
                  <option value="graduation">Graduation Clearance</option>
                  <option value="withdrawal">Withdrawal Clearance</option>
                  <option value="transfer">Transfer Clearance</option>
                </select>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <label for="clearance-reason" class="block text-gray-200 font-medium mb-2">Reason for Clearance</label>
                <textarea id="clearance-reason" rows="3" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" placeholder="Briefly state your reason"></textarea>
              </div>
            </div>
            <div id="clearanceStatusMessage" class="p-4 rounded-md mb-6 hidden"></div>
            <button type="submit" id="submitClearanceRequestBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
              Submit Clearance Request
            </button>
          </form>
          <div class="mt-8">
            <h3 class="text-xl font-bold text-green-800 mb-4">Your Current Clearance Status</h3>
            <div id="clearanceRequestDisplay" class="glass-panel p-4 rounded-md text-gray-300">
              <p>No pending clearance request.</p>
            </div>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Clearance Request") + clearanceHtml;

      const clearanceForm = document.getElementById('clearance-form');
      const clearanceStatusMessage = document.getElementById('clearanceStatusMessage');
      const clearanceRequestDisplay = document.getElementById('clearanceRequestDisplay');
      const submitClearanceRequestBtn = document.getElementById('submitClearanceRequestBtn');

      let currentClearanceRequest = null;

      const checkClearanceRequest = async () => {
        showLoading("Checking clearance status...");
        try {
          const clearanceDocRef = doc(db, `students/${currentUserId}/clearance`, 'request');
          const clearanceSnap = await getDoc(clearanceDocRef);

          if (clearanceSnap.exists()) {
            currentClearanceRequest = clearanceSnap.data();
            clearanceRequestDisplay.innerHTML = `
              <p><strong>Type:</strong> <span class="font-semibold text-gray-200">${currentClearanceRequest.type}</span></p>
              <p><strong>Reason:</strong> <span class="text-gray-300">${currentClearanceRequest.reason}</span></p>
              <p><strong>Status:</strong> <span class="font-bold text-blue-500">${currentClearanceRequest.status}</span></p>
              <p><strong>Requested On:</strong> ${new Date(currentClearanceRequest.requestedAt.toDate()).toLocaleDateString()}</p>
              ${currentClearanceRequest.adminComments ? `<p><strong>Admin Comments:</strong> <span class="text-yellow-500">${currentClearanceRequest.adminComments}</span></p>` : ''}
              <button id="cancelClearanceRequestBtn" class="mt-4 bg-red-600 hover:bg-red-700 text-white py-1 px-4 rounded-md">Cancel Request</button>
            `;
            if (currentClearanceRequest.status === 'Approved' || currentClearanceRequest.status === 'Denied') {
              submitClearanceRequestBtn.disabled = true;
              clearanceForm.querySelector('input, textarea, select').forEach(el => el.disabled = true);
              if (document.getElementById('cancelClearanceRequestBtn')) document.getElementById('cancelClearanceRequestBtn').disabled = true;
            } else {
              submitClearanceRequestBtn.disabled = true; // Disable if a request is already pending
              clearanceForm.querySelector('input, textarea, select').forEach(el => el.disabled = true);
              if (document.getElementById('cancelClearanceRequestBtn')) {
                document.getElementById('cancelClearanceRequestBtn').addEventListener('click', async () => {
                  const confirm = await showCustomModal('Confirm Cancellation', 'Are you sure you want to cancel your clearance request?', true);
                  if (confirm) {
                    showLoading("Cancelling request...");
                    await deleteDoc(clearanceDocRef);
                    currentClearanceRequest = null;
                    await showCustomModal("Cancelled", "Clearance request cancelled.");
                    checkClearanceRequest(); // Re-render status
                  }
                  hideLoading();
                });
              }
            }
          } else {
            clearanceRequestDisplay.innerHTML = `<p>No pending clearance request.</p>`;
            submitClearanceRequestBtn.disabled = false;
            clearanceForm.querySelector('input, textarea, select').forEach(el => el.disabled = false);
          }
        } catch (error) {
          console.error("Error fetching clearance request:", error);
          clearanceStatusMessage.innerHTML = `<p class="text-red-500">Error loading clearance status. Please try again.</p>`;
          clearanceStatusMessage.classList.remove('hidden');
        } finally {
          hideLoading();
        }
      };

      clearanceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        setButtonLoading(submitClearanceRequestBtn, true);

        const clearanceType = document.getElementById('clearance-type').value;
        const clearanceReason = document.getElementById('clearance-reason').value.trim();

        if (!clearanceType || !clearanceReason) {
          await showCustomModal("Validation Error", "Please fill in all required fields.");
          setButtonLoading(submitClearanceRequestBtn, false);
          return;
        }

        try {
          const clearanceDocRef = doc(db, `students/${currentUserId}/clearance`, 'request');
          await setDoc(clearanceDocRef, {
            type: clearanceType,
            reason: clearanceReason,
            status: "Pending",
            requestedAt: new Date(),
            studentId: currentUserId,
            studentName: currentUserData.name,
            studentRegNo: currentUserData.regNo,
            studentProgram: currentUserData.programme
          });
          await showCustomModal("Success", "Clearance request submitted successfully! Please await approval.");
          checkClearanceRequest(); // Re-render status
        } catch (error) {
          console.error("Error submitting clearance request:", error);
          await showCustomModal("Error", "Failed to submit clearance request. Please try again.");
        } finally {
          setButtonLoading(submitClearanceRequestBtn, false);
        }
      });

      checkClearanceRequest(); // Initial load
    }

    // 7. Fees Statement
    async function loadFees() {
      const content = document.getElementById("dashboardContent");
      const feesHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Fees Statement</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <div class="glass-panel p-4 rounded-md">
              <p class="text-sm text-gray-400">Total Charged:</p>
              <p id="totalCharged" class="font-semibold text-gray-200 text-lg">GHS 0.00</p>
            </div>
            <div class="glass-panel p-4 rounded-md">
              <p class="text-sm text-gray-400">Total Payments:</p>
              <p id="totalPayments" class="font-semibold text-gray-200 text-lg">GHS 0.00</p>
            </div>
            <div class="glass-panel p-4 rounded-md">
              <p class="text-sm text-gray-400">Current Balance:</p>
              <p id="currentBalance" class="font-semibold text-gray-200 text-lg"></p>
            </div>
          </div>

          <div class="overflow-x-auto mb-6">
            <table class="min-w-full glass-panel border-collapse">
              <thead class="bg-gray-200 text-gray-200">
                <tr>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Date</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Description</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Debit (GHS)</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700">Credit (GHS)</th>
                </tr>
              </thead>
              <tbody id="feesTableBody">
                <tr><td colspan="4" class="text-center py-4 text-gray-400">Loading fees statement...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="flex justify-start space-x-4">
            <button onclick="generateFeesStatement()" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">
              <i class="fas fa-file-pdf mr-2"></i>Generate Statement (PDF)
            </button>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Fees Statement") + feesHtml;

      const feesTableBody = document.getElementById('feesTableBody');
      const totalChargedEl = document.getElementById('totalCharged');
      const totalPaymentsEl = document.getElementById('totalPayments');
      const currentBalanceEl = document.getElementById('currentBalance');

      onSnapshot(query(collection(db, `students/${currentUserId}/feesStatement`), orderBy("date", "desc")), (querySnapshot) => {
        let totalCharged = 0;
        let totalPayments = 0;
        let currentBalance = 0;
        feesTableBody.innerHTML = '';

        if (querySnapshot.empty) {
          feesTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">No fees transactions found.</td></tr>`;
        } else {
          querySnapshot.forEach(doc => {
            const transaction = doc.data();
            const date = transaction.date ? new Date(transaction.date.toDate()).toLocaleDateString() : 'N/A';
            const debit = transaction.debit || 0;
            const credit = transaction.credit || 0;

            totalCharged += debit;
            totalPayments += credit;

            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="py-3 px-4 border-b border-gray-700 border-r">${date}</td>
              <td class="py-3 px-4 border-b border-gray-700 border-r">${transaction.description}</td>
              <td class="py-3 px-4 border-b border-gray-700 border-r text-red-400">${debit > 0 ? debit.toFixed(2) : '-'}</td>
              <td class="py-3 px-4 border-b border-gray-700 text-green-400">${credit > 0 ? credit.toFixed(2) : '-'}</td>
            `;
            feesTableBody.appendChild(row);
          });
        }
        currentBalance = totalCharged - totalPayments;
        totalChargedEl.innerText = `GHS ${totalCharged.toFixed(2)}`;
        totalPaymentsEl.innerText = `GHS ${totalPayments.toFixed(2)}`;
        currentBalanceEl.innerText = `GHS ${currentBalance.toFixed(2)}`;
        currentBalanceEl.classList.remove('text-red-500', 'text-green-500');
        if (currentBalance > 0) {
          currentBalanceEl.classList.add('text-red-500');
        } else {
          currentBalanceEl.classList.add('text-green-500');
        }
      });
    }

    // PDF Generation Logic (Fees Statement)
    window.generateFeesStatement = async function() {
      const studentInfo = currentUserData;
      if (!studentInfo || studentInfo.regNo === 'N/A') {
          await showCustomModal("Error", "Student information is incomplete. Please update your profile first.");
          return;
      }

      showLoading("Generating fees statement...");
      try {
          const feesSnapshot = await getDocs(query(collection(db, `students/${currentUserId}/feesStatement`), orderBy("date")));
          const transactions = feesSnapshot.docs.map(doc => doc.data());

          let totalCharged = 0;
          let totalPayments = 0;
          let currentBalance = 0;

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Header
          doc.setFontSize(18);
          doc.setTextColor(0, 51, 0);
          doc.text("FEES STATEMENT", 105, 20, null, null, "center");
          doc.setFontSize(10);
          doc.setTextColor(51, 51, 51);
          doc.text("Prince Alex Design University", 105, 27, null, null, "center");
          doc.text("P.O Box 1234, University Road, Cityville", 105, 32, null, null, "center");
          doc.text("www.princealex.edu", 105, 37, null, null, "center");
          doc.addImage('myschoollogo.png', 'PNG', 10, 15, 30, 30); // Logo

          // Student Info
          doc.setFontSize(12);
          doc.setTextColor(0, 0, 0);
          doc.setFont("helvetica", "bold");
          doc.text("Student Information:", 15, 50);
          doc.setFont("helvetica", "normal");
          doc.text(`Name: ${studentInfo.name}`, 15, 57);
          doc.text(`Student ID: ${studentInfo.regNo}`, 15, 62);
          doc.text(`Program: ${studentInfo.programme}`, 15, 67);
          doc.text(`Date of Issue: ${new Date().toLocaleDateString()}`, 15, 72);

          // Transactions Table
          const tableHeaders = ["Date", "Description", "Debit (GHS)", "Credit (GHS)"];
          const tableData = transactions.map(t => {
              totalCharged += t.debit || 0;
              totalPayments += t.credit || 0;
              return [
                  t.date ? new Date(t.date.toDate()).toLocaleDateString() : 'N/A',
                  t.description,
                  t.debit ? t.debit.toFixed(2) : '-',
                  t.credit ? t.credit.toFixed(2) : '-'
              ];
          });
          currentBalance = totalCharged - totalPayments;

          doc.autoTable({
              startY: 80,
              head: [tableHeaders],
              body: tableData,
              styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
              headStyles: { fillColor: [0, 100, 0], textColor: 255, fontStyle: 'bold' },
              alternateRowStyles: { fillColor: [240, 240, 240] },
              margin: { top: 75, left: 15, right: 15, bottom: 20 },
              didDrawPage: function(data) {
                  doc.setFontSize(8);
                  doc.text("Prince Alex Design University | Fees Statement", data.settings.margin.left, doc.internal.pageSize.height - 10);
              }
          });

          // Summary
          let finalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(12);
          doc.setFont("helvetica", "bold");
          doc.text("Summary:", 15, finalY);
          doc.setFont("helvetica", "normal");
          doc.text(`Total Charged: GHS ${totalCharged.toFixed(2)}`, 15, finalY + 7);
          doc.text(`Total Payments: GHS ${totalPayments.toFixed(2)}`, 15, finalY + 14);
          doc.text(`Current Balance: GHS ${currentBalance.toFixed(2)}`, 15, finalY + 21);

          doc.save(`FeesStatement-${studentInfo.regNo}.pdf`);
      } catch (error) {
          console.error("Error generating fees statement PDF:", error);
          await showCustomModal("Error", "Failed to generate fees statement. Please try again.");
      } finally {
          hideLoading();
      }
    };

    // 8. Exam Card
    async function loadExamCard() {
      const content = document.getElementById("dashboardContent");
      const examCardHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Exam Card</h2>
          <div class="glass-panel p-4 rounded-md mb-6">
            <p class="text-sm text-gray-400">Student Name:</p>
            <p id="examcard-name" class="font-semibold text-gray-200">${currentUserData.name || 'N/A'}</p>
            <p class="text-sm text-gray-400 mt-2">Student ID:</p>
            <p id="examcard-regno" class="font-semibold text-gray-200">${currentUserData.regNo || 'N/A'}</p>
            <p class="text-sm text-gray-400 mt-2">Program:</p>
            <p id="examcard-program" class="font-semibold text-gray-200">${currentUserData.programme || 'N/A'}</p>
          </div>

          <div class="overflow-x-auto mb-6">
            <table class="min-w-full glass-panel border-collapse">
              <thead class="bg-gray-200 text-gray-200">
                <tr>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Course Code</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Course Name</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Date</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700 border-r">Time</th>
                  <th class="py-3 px-4 text-left font-bold border-b border-gray-700">Venue</th>
                </tr>
              </thead>
              <tbody id="examCardTableBody">
                <tr><td colspan="5" class="text-center py-4 text-gray-400">Loading exam schedule...</td></tr>
              </tbody>
            </table>
          </div>
          <div id="examCardStatus" class="p-4 rounded-md mb-6 hidden"></div>
          <div class="flex justify-start space-x-4">
            <button onclick="downloadExamCard()" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">
              <i class="fas fa-download mr-2"></i>Download Exam Card
            </button>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Exam Card") + examCardHtml;

      const examCardTableBody = document.getElementById('examCardTableBody');
      const examCardStatus = document.getElementById('examCardStatus');

      const fetchExamSchedule = async () => {
        showLoading("Fetching exam schedule...");
        try {
          const registrationsSnapshot = await getDocs(collection(db, `students/${currentUserId}/registrations`));
          const registeredCourseCodes = registrationsSnapshot.docs.map(doc => doc.data().courseCode);

          if (registeredCourseCodes.length === 0) {
            examCardTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">You are not registered for any courses.</td></tr>`;
            examCardStatus.innerHTML = `<p class="text-red-500"><i class="fas fa-exclamation-triangle"></i> You have no registered courses, cannot generate exam card.</p>`;
            examCardStatus.classList.add('bg-red-100');
            examCardStatus.classList.remove('hidden');
            return;
          }

          const examScheduleQuery = query(collection(db, 'examSchedule'), where('courseCode', 'in', registeredCourseCodes));
          const examScheduleSnapshot = await getDocs(examScheduleQuery);

          examCardTableBody.innerHTML = '';
          if (examScheduleSnapshot.empty) {
            examCardTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">No exam schedule available for your registered courses.</td></tr>`;
            examCardStatus.innerHTML = `<p class="text-red-500"><i class="fas fa-exclamation-triangle"></i> Exam schedule not yet released or no exams for your courses.</p>`;
            examCardStatus.classList.add('bg-red-100');
            examCardStatus.classList.remove('hidden');
          } else {
            examScheduleSnapshot.forEach(doc => {
              const exam = doc.data();
              const examDate = exam.date ? new Date(exam.date.toDate()).toLocaleDateString() : 'N/A';
              const row = document.createElement('tr');
              row.innerHTML = `
                <td class="py-3 px-4 border-b border-gray-700 border-r">${exam.courseCode}</td>
                <td class="py-3 px-4 border-b border-gray-700 border-r">${exam.courseName}</td>
                <td class="py-3 px-4 border-b border-gray-700 border-r">${examDate}</td>
                <td class="py-3 px-4 border-b border-gray-700 border-r">${exam.time}</td>
                <td class="py-3 px-4 border-b border-gray-700">${exam.venue}</td>
              `;
              examCardTableBody.appendChild(row);
            });
            examCardStatus.innerHTML = `<p class="text-green-500"><i class="fas fa-check-circle"></i> Your exam card is ready.</p>`;
            examCardStatus.classList.add('bg-green-100');
            examCardStatus.classList.remove('hidden');
          }
        } catch (error) {
          console.error("Error fetching exam schedule:", error);
          examCardTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load exam schedule.</td></tr>`;
          examCardStatus.innerHTML = `<p class="text-red-500">Error loading exam schedule. Please try again.</p>`;
          examCardStatus.classList.add('bg-red-100');
          examCardStatus.classList.remove('hidden');
        } finally {
          hideLoading();
        }
      };
      fetchExamSchedule();
    }

    // PDF Generation Logic (Exam Card)
    window.downloadExamCard = async function() {
      const studentInfo = currentUserData;
      if (!studentInfo || studentInfo.regNo === 'N/A') {
          await showCustomModal("Error", "Student information is incomplete. Please update your profile first.");
          return;
      }

      showLoading("Generating exam card...");
      try {
          const registrationsSnapshot = await getDocs(collection(db, `students/${currentUserId}/registrations`));
          const registeredCourseCodes = registrationsSnapshot.docs.map(doc => doc.data().courseCode);

          if (registeredCourseCodes.length === 0) {
              await showCustomModal("Error", "You are not registered for any courses. Cannot generate exam card.");
              return;
          }

          const examScheduleQuery = query(collection(db, 'examSchedule'), where('courseCode', 'in', registeredCourseCodes));
          const examScheduleSnapshot = await getDocs(examScheduleQuery);
          const examData = examScheduleSnapshot.docs.map(doc => doc.data());

          if (examData.length === 0) {
              await showCustomModal("Info", "No exam schedule available for your registered courses yet.");
              return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Header
          doc.setFontSize(18);
          doc.setTextColor(0, 51, 0);
          doc.text("EXAMINATION CARD", 105, 20, null, null, "center");
          doc.setFontSize(10);
          doc.setTextColor(51, 51, 51);
          doc.text("Prince Alex Design University", 105, 27, null, null, "center");
          doc.text("P.O Box 1234, University Road, Cityville", 105, 32, null, null, "center");
          doc.text("www.princealex.edu", 105, 37, null, null, "center");
          doc.addImage('myschoollogo.png', 'PNG', 10, 15, 30, 30); // Logo

          // Student Info
          doc.setFontSize(12);
          doc.setTextColor(0, 0, 0);
          doc.setFont("helvetica", "bold");
          doc.text("Student Information:", 15, 50);
          doc.setFont("helvetica", "normal");
          doc.text(`Name: ${studentInfo.name}`, 15, 57);
          doc.text(`Student ID: ${studentInfo.regNo}`, 15, 62);
          doc.text(`Program: ${studentInfo.programme}`, 15, 67);
          doc.text(`Academic Year: ${currentUserData.yearOfStudy || 'N/A'}`, 15, 72);
          doc.text(`Semester: ${currentUserData.semester || 'N/A'}`, 15, 77);
          doc.text(`Date of Issue: ${new Date().toLocaleDateString()}`, 15, 82);

          // Exam Schedule Table
          const tableHeaders = ["Course Code", "Course Name", "Date", "Time", "Venue"];
          const tableData = examData.map(e => [
              e.courseCode,
              e.courseName,
              e.date ? new Date(e.date.toDate()).toLocaleDateString() : 'N/A',
              e.time,
              e.venue
          ]);

          doc.autoTable({
              startY: 90,
              head: [tableHeaders],
              body: tableData,
              styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
              headStyles: { fillColor: [0, 100, 0], textColor: 255, fontStyle: 'bold' },
              alternateRowStyles: { fillColor: [240, 240, 240] },
              margin: { top: 85, left: 15, right: 15, bottom: 20 },
              didDrawPage: function(data) {
                  doc.setFontSize(8);
                  doc.text("Prince Alex Design University | Examination Card", data.settings.margin.left, doc.internal.pageSize.height - 10);
              }
          });

          // Important Notes (example)
          let finalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(10);
          doc.setTextColor(51, 51, 51);
          doc.setFont("helvetica", "bold");
          doc.text("Important Notes:", 15, finalY);
          doc.setFont("helvetica", "normal");
          doc.text("- Bring your student ID and this exam card to the examination hall.", 15, finalY + 7);
          doc.text("- Arrive at least 30 minutes before the start of the examination.", 15, finalY + 12);
          doc.text("- Any form of malpractice will lead to severe disciplinary action.", 15, finalY + 17);

          doc.save(`ExamCard-${studentInfo.regNo}.pdf`);

      } catch (error) {
          console.error("Error generating exam card PDF:", error);
          await showCustomModal("Error", "Failed to generate exam card. Please try again.");
      } finally {
          hideLoading();
      }
    };

    // 9. Hostel Accommodation Booking
    async function loadHostels() {
      const content = document.getElementById("dashboardContent");
      const hostelsHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Hostel Accommodation Booking</h2>
          <form id="hostel-booking-form">
            <div class="space-y-4 mb-6">
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Student Name:</p>
                <p id="hostel-name" class="font-semibold text-gray-200">${currentUserData.name || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <p class="text-sm text-gray-400">Student ID:</p>
                <p id="hostel-regno" class="font-semibold text-gray-200">${currentUserData.regNo || 'N/A'}</p>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <label for="hostel-type" class="block text-gray-200 font-medium mb-2">Hostel Type</label>
                <select id="hostel-type" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
                  <option value="">Select Hostel Type</option>
                  <option value="male">Male Hostel</option>
                  <option value="female">Female Hostel</option>
                </select>
              </div>
              <div class="glass-panel p-4 rounded-md">
                <label for="room-preference" class="block text-gray-200 font-medium mb-2">Room Preference (Optional)</label>
                <input type="text" id="room-preference" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" placeholder="e.g., Single, Double, specific room number if known">
              </div>
              <div class="glass-panel p-4 rounded-md">
                <label for="booking-period" class="block text-gray-200 font-medium mb-2">Booking Period</label>
                <select id="booking-period" class="w-full p-2 border rounded-md focus:ring-2 focus:border-transparent transition-colors duration-200" required>
                  <option value="">Select Period</option>
                  <option value="semester">One Semester</option>
                  <option value="academic-year">Full Academic Year</option>
                </select>
              </div>
            </div>
            <div id="hostelBookingStatusMessage" class="p-4 rounded-md mb-6 hidden"></div>
            <button type="submit" id="submitHostelBookingBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
              Submit Booking Request
            </button>
          </form>
          <div class="mt-8">
            <h3 class="text-xl font-bold text-green-800 mb-4">Your Current Hostel Booking</h3>
            <div id="hostelBookingDisplay" class="glass-panel p-4 rounded-md text-gray-300">
              <p>No active hostel booking.</p>
            </div>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Hostel Accommodation") + hostelsHtml;

      const hostelBookingForm = document.getElementById('hostel-booking-form');
      const hostelBookingStatusMessage = document.getElementById('hostelBookingStatusMessage');
      const hostelBookingDisplay = document.getElementById('hostelBookingDisplay');
      const submitHostelBookingBtn = document.getElementById('submitHostelBookingBtn');

      let currentHostelBooking = null;

      const checkHostelBooking = async () => {
        showLoading("Checking hostel booking status...");
        try {
          const bookingDocRef = doc(db, `students/${currentUserId}/hostel`, 'booking');
          const bookingSnap = await getDoc(bookingDocRef);

          if (bookingSnap.exists()) {
            currentHostelBooking = bookingSnap.data();
            hostelBookingDisplay.innerHTML = `
              <p><strong>Type:</strong> <span class="font-semibold text-gray-200">${currentHostelBooking.type}</span></p>
              <p><strong>Room Preference:</strong> <span class="text-gray-300">${currentHostelBooking.roomPreference || 'N/A'}</span></p>
              <p><strong>Period:</strong> <span class="font-semibold text-gray-200">${currentHostelBooking.bookingPeriod}</span></p>
              <p><strong>Status:</strong> <span class="font-bold text-blue-500">${currentHostelBooking.status}</span></p>
              <p><strong>Booked On:</strong> ${new Date(currentHostelBooking.bookedAt.toDate()).toLocaleDateString()}</p>
              ${currentHostelBooking.allocatedRoom ? `<p><strong>Allocated Room:</strong> <span class="text-green-500 font-bold">${currentHostelBooking.allocatedRoom}</span></p>` : ''}
              ${currentHostelBooking.adminComments ? `<p><strong>Admin Comments:</strong> <span class="text-yellow-500">${currentHostelBooking.adminComments}</span></p>` : ''}
              <button id="cancelHostelBookingBtn" class="mt-4 bg-red-600 hover:bg-red-700 text-white py-1 px-4 rounded-md">Cancel Booking</button>
            `;
            if (currentHostelBooking.status === 'Approved' || currentHostelBooking.status === 'Denied') {
              submitHostelBookingBtn.disabled = true;
              hostelBookingForm.querySelector('input, select').forEach(el => el.disabled = true);
              if (document.getElementById('cancelHostelBookingBtn')) document.getElementById('cancelHostelBookingBtn').disabled = true;
            } else {
              submitHostelBookingBtn.disabled = true; // Disable if a request is already pending
              hostelBookingForm.querySelector('input, select').forEach(el => el.disabled = true);
              if (document.getElementById('cancelHostelBookingBtn')) {
                document.getElementById('cancelHostelBookingBtn').addEventListener('click', async () => {
                  const confirm = await showCustomModal('Confirm Cancellation', 'Are you sure you want to cancel your hostel booking request?', true);
                  if (confirm) {
                    showLoading("Cancelling request...");
                    await deleteDoc(bookingDocRef);
                    currentHostelBooking = null;
                    await showCustomModal("Cancelled", "Hostel booking request cancelled.");
                    checkHostelBooking(); // Re-render status
                  }
                  hideLoading();
                });
              }
            }
          } else {
            hostelBookingDisplay.innerHTML = `<p>No active hostel booking.</p>`;
            submitHostelBookingBtn.disabled = false;
            hostelBookingForm.querySelector('input, select').forEach(el => el.disabled = false);
          }
        } catch (error) {
          console.error("Error fetching hostel booking:", error);
          hostelBookingStatusMessage.innerHTML = `<p class="text-red-500">Error loading hostel booking status. Please try again.</p>`;
          hostelBookingStatusMessage.classList.remove('hidden');
        } finally {
          hideLoading();
        }
      };

      hostelBookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        setButtonLoading(submitHostelBookingBtn, true);

        const hostelType = document.getElementById('hostel-type').value;
        const roomPreference = document.getElementById('room-preference').value.trim();
        const bookingPeriod = document.getElementById('booking-period').value;

        if (!hostelType || !bookingPeriod) {
          await showCustomModal("Validation Error", "Please select hostel type and booking period.");
          setButtonLoading(submitHostelBookingBtn, false);
          return;
        }

        try {
          const bookingDocRef = doc(db, `students/${currentUserId}/hostel`, 'booking');
          await setDoc(bookingDocRef, {
            type: hostelType,
            roomPreference: roomPreference || 'Any',
            bookingPeriod: bookingPeriod,
            status: "Pending",
            bookedAt: new Date(),
            studentId: currentUserId,
            studentName: currentUserData.name,
            studentRegNo: currentUserData.regNo,
            studentProgram: currentUserData.programme
          });
          await showCustomModal("Success", "Hostel booking request submitted successfully! We will notify you of your room allocation.");
          checkHostelBooking(); // Re-render status
        } catch (error) {
          console.error("Error submitting hostel booking:", error);
          await showCustomModal("Error", "Failed to submit hostel booking. Please try again.");
        } finally {
          setButtonLoading(submitHostelBookingBtn, false);
        }
      });

      checkHostelBooking(); // Initial load
    }

    // 10. Announcements
    async function loadAnnouncements() {
      const content = document.getElementById("dashboardContent");
      const announcementsHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Announcements</h2>
          <div id="announcementsFilter" class="flex flex-wrap gap-4 mb-6">
            <button class="filter-btn bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-md transition duration-200" data-filter="all">All</button>
            <button class="filter-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition duration-200" data-filter="general">General</button>
            <button class="filter-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition duration-200" data-filter="academic">Academic</button>
            <button class="filter-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition duration-200" data-filter="financial">Financial</button>
            <button class="filter-btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition duration-200" data-filter="campuslife">Campus Life</button>
          </div>
          <div id="announcementsListFull" class="space-y-4">
            <p class="text-gray-400">Loading announcements...</p>
          </div>
        </div>
      `;
      content.innerHTML = generateBreadcrumb("Announcements") + announcementsHtml;

      const announcementsListFull = document.getElementById('announcementsListFull');
      const filterButtons = document.querySelectorAll('.filter-btn');

      let allAnnouncements = [];

      // Mark announcements as read by updating lastVisitedAnnouncements for current user
      const updateLastVisitedAnnouncements = async () => {
        if (currentUserData) {
          try {
            const userDocRef = doc(db, `students`, currentUserId);
            await updateDoc(userDocRef, {
              lastVisitedAnnouncements: new Date()
            });
            // Update the badge count immediately
            if (notificationBadge) {
                notificationBadge.innerText = '0';
                notificationBadge.classList.add('hidden');
            }
          } catch (error) {
            console.error("Error updating last visited announcements:", error);
          }
        }
      };
      updateLastVisitedAnnouncements(); // Call on section load

      const renderAnnouncements = (filter = 'all') => {
        announcementsListFull.innerHTML = '';
        let filteredAnnouncements = allAnnouncements;

        if (filter !== 'all') {
          filteredAnnouncements = allAnnouncements.filter(ann => ann.category.toLowerCase() === filter.toLowerCase());
        }

        if (filteredAnnouncements.length === 0) {
          announcementsListFull.innerHTML = `<p class="text-gray-400">No announcements found for this category.</p>`;
        } else {
          filteredAnnouncements.forEach(announcement => {
            const date = announcement.date ? new Date(announcement.date.toDate()).toLocaleDateString() : 'N/A';
            const itemHtml = `
              <div class="glass-panel p-4 rounded-md shadow-sm">
                <div class="flex items-center justify-between text-sm text-gray-400 mb-2">
                  <span>${date}</span>
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${
                    announcement.category === 'General' ? 'bg-blue-100 text-blue-800' :
                    announcement.category === 'Academic' ? 'bg-purple-100 text-purple-800' :
                    announcement.category === 'Financial' ? 'bg-green-100 text-green-800' :
                    announcement.category === 'Campus Life' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'
                  }">${announcement.category}</span>
                </div>
                <h3 class="font-bold text-lg text-green-500 mb-2">${announcement.title}</h3>
                <p class="text-gray-300 text-sm">${announcement.content}</p>
              </div>
            `;
            announcementsListFull.innerHTML += itemHtml;
          });
        }
      };

      // Fetch announcements once
      showLoading("Fetching announcements...");
      onSnapshot(query(collection(db, 'announcements'), orderBy('date', 'desc')), (querySnapshot) => {
        allAnnouncements = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAnnouncements(); // Initial render with all announcements
        hideLoading();
      }, (error) => {
        console.error("Error fetching announcements:", error);
        announcementsListFull.innerHTML = `<p class="text-red-500">Failed to load announcements. Please try again.</p>`;
        hideLoading();
      });

      // Add event listeners for filter buttons
      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          filterButtons.forEach(btn => {
            btn.classList.remove('bg-green-700', 'hover:bg-green-800');
            btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
          });
          button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
          button.classList.add('bg-green-700', 'hover:bg-green-800');
          renderAnnouncements(button.dataset.filter);
        });
      });
    }

    // 11. Personal Profile
    async function loadProfile() {
        const content = document.getElementById("dashboardContent");
        const profileHtml = `
            <div class="glass-panel p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-green-800 mb-6">Personal Profile</h2>
                <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8 mb-8">
                    <div class="flex-shrink-0 text-center">
                        <img id="profilePhoto" src="${currentUserData.profilePhotoURL || 'https://placehold.co/150x150/eeeeee/333333?text=Avatar'}" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-green-500 shadow-lg mx-auto mb-4">
                        <input type="file" id="profilePhotoUpload" accept="image/*" class="hidden">
                        <button onclick="document.getElementById('profilePhotoUpload').click()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            <i class="fas fa-upload mr-2"></i>Change Photo
                        </button>
                    </div>
                    <form id="profile-form" class="flex-grow w-full space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="name" class="block text-gray-200 font-medium mb-1">Full Name</label>
                                <input type="text" id="name" class="w-full p-2 border rounded-md" value="${currentUserData.name || ''}" required>
                            </div>
                            <div>
                                <label for="email" class="block text-gray-200 font-medium mb-1">Email</label>
                                <input type="email" id="email" class="w-full p-2 border rounded-md" value="${currentUserData.email || ''}" disabled>
                            </div>
                            <div>
                                <label for="regNo" class="block text-gray-200 font-medium mb-1">Registration Number</label>
                                <input type="text" id="regNo" class="w-full p-2 border rounded-md" value="${currentUserData.regNo || ''}">
                            </div>
                            <div>
                                <label for="programme" class="block text-gray-200 font-medium mb-1">Programme</label>
                                <input type="text" id="programme" class="w-full p-2 border rounded-md" value="${currentUserData.programme || ''}">
                            </div>
                            <div>
                                <label for="campus" class="block text-gray-200 font-medium mb-1">Campus</label>
                                <input type="text" id="campus" class="w-full p-2 border rounded-md" value="${currentUserData.campus || ''}">
                            </div>
                            <div>
                                <label for="dob" class="block text-gray-200 font-medium mb-1">Date of Birth</label>
                                <input type="date" id="dob" class="w-full p-2 border rounded-md" value="${currentUserData.dob || ''}">
                            </div>
                            <div>
                                <label for="gender" class="block text-gray-200 font-medium mb-1">Gender</label>
                                <select id="gender" class="w-full p-2 border rounded-md">
                                    <option value="">Select Gender</option>
                                    <option value="Male" ${currentUserData.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${currentUserData.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${currentUserData.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="address" class="block text-gray-200 font-medium mb-1">Address</label>
                                <input type="text" id="address" class="w-full p-2 border rounded-md" value="${currentUserData.address || ''}">
                            </div>
                            <div>
                                <label for="yearOfStudy" class="block text-gray-200 font-medium mb-1">Year of Study</label>
                                <select id="yearOfStudy" class="w-full p-2 border rounded-md">
                                  <option value="">Select Year</option>
                                  <option value="1" ${currentUserData.yearOfStudy === 1 ? 'selected' : ''}>Year 1</option>
                                  <option value="2" ${currentUserData.yearOfStudy === 2 ? 'selected' : ''}>Year 2</option>
                                  <option value="3" ${currentUserData.yearOfStudy === 3 ? 'selected' : ''}>Year 3</option>
                                  <option value="4" ${currentUserData.yearOfStudy === 4 ? 'selected' : ''}>Year 4</option>
                                </select>
                            </div>
                            <div>
                                <label for="semester" class="block text-gray-200 font-medium mb-1">Current Semester</label>
                                <select id="semester" class="w-full p-2 border rounded-md">
                                  <option value="">Select Semester</option>
                                  <option value="1" ${currentUserData.semester === 1 ? 'selected' : ''}>Semester 1</option>
                                  <option value="2" ${currentUserData.semester === 2 ? 'selected' : ''}>Semester 2</option>
                                </select>
                            </div>
                        </div>
                        <div id="profileUpdateStatus" class="mt-4 text-center hidden"></div>
                        <button type="submit" id="updateProfileBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
                            <i class="fas fa-save mr-2"></i>Save Profile
                        </button>
                    </form>
                </div>
            </div>
        `;
        content.innerHTML = generateBreadcrumb("Personal Profile") + profileHtml;

        const profileForm = document.getElementById('profile-form');
        const profilePhotoInput = document.getElementById('profilePhotoUpload');
        const profilePhotoImg = document.getElementById('profilePhoto');
        const profileUpdateStatus = document.getElementById('profileUpdateStatus');
        const updateProfileBtn = document.getElementById('updateProfileBtn');

        // Handle profile photo upload
        profilePhotoInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading("Uploading photo...");
            try {
                const storageRef = ref(storage, `profilePhotos/${currentUserId}/${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const photoURL = await getDownloadURL(snapshot.ref);

                await updateDoc(doc(db, `students`, currentUserId), {
                    profilePhotoURL: photoURL
                });
                profilePhotoImg.src = photoURL;
                headerProfilePic.src = photoURL; // Update header photo too
                await showCustomModal("Success", "Profile photo updated successfully!");
                // Update local currentUserData for immediate reflection
                currentUserData.profilePhotoURL = photoURL;
            } catch (error) {
                console.error("Error uploading profile photo:", error);
                await showCustomModal("Error", "Failed to upload photo. Please try again.");
            } finally {
                hideLoading();
            }
        });

        // Handle profile form submission
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(updateProfileBtn, true);
            profileUpdateStatus.classList.add('hidden');

            const updatedData = {
                name: document.getElementById('name').value.trim(),
                regNo: document.getElementById('regNo').value.trim(),
                programme: document.getElementById('programme').value.trim(),
                campus: document.getElementById('campus').value.trim(),
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                address: document.getElementById('address').value.trim(),
                yearOfStudy: parseInt(document.getElementById('yearOfStudy').value) || null,
                semester: parseInt(document.getElementById('semester').value) || null,
            };

            // Basic validation
            if (!updatedData.name || !updatedData.regNo || !updatedData.programme) {
                profileUpdateStatus.innerText = "❌ Please fill in Name, Registration Number, and Programme.";
                profileUpdateStatus.classList.remove('hidden');
                profileUpdateStatus.classList.add('text-red-500');
                setButtonLoading(updateProfileBtn, false);
                return;
            }

            try {
                await updateDoc(doc(db, `students`, currentUserId), updatedData);
                currentUserData = { ...currentUserData, ...updatedData }; // Update local data
                document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
                const userNameMobile = document.getElementById("userNameMobile");
                if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
                if (userProgramHeader) userProgramHeader.innerText = currentUserData.programme && currentUserData.programme !== 'N/A' ? currentUserData.programme : "Program";

                profileUpdateStatus.innerText = "✅ Profile updated successfully!";
                profileUpdateStatus.classList.remove('hidden', 'text-red-500');
                profileUpdateStatus.classList.add('text-green-500');
                await showCustomModal("Success", "Your profile has been updated!");
            } catch (error) {
                console.error("Error updating profile:", error);
                profileUpdateStatus.innerText = "❌ Failed to update profile. Please try again.";
                profileUpdateStatus.classList.remove('hidden', 'text-green-500');
                profileUpdateStatus.classList.add('text-red-500');
                await showCustomModal("Error", "Failed to update profile. Please try again.");
            } finally {
                setButtonLoading(updateProfileBtn, false);
            }
        });
    }

    // 12. Settings
    async function loadSettings() {
      const content = document.getElementById("dashboardContent");
      const settingsHtml = `
        <div class="glass-panel p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-green-800 mb-6">Settings</h2>

          <!-- Change Password Section -->
          <div class="collapsible-header glass-panel p-4 rounded-md mb-4 flex items-center justify-between">
            <h3 class="text-xl font-bold text-green-800">Change Password</h3>
            <i class="fas fa-chevron-down text-gray-300"></i>
          </div>
          <div class="collapsible-content glass-panel p-4 rounded-b-md mb-6">
            <form id="change-password-form" class="space-y-4">
              <div>
                <label for="current-password" class="block text-gray-200 font-medium mb-1">Current Password</label>
                <input type="password" id="current-password" class="w-full p-2 border rounded-md" required>
                <p id="current-password-error" class="text-red-500 text-sm mt-1 hidden"></p>
              </div>
              <div>
                <label for="new-password" class="block text-gray-200 font-medium mb-1">New Password</label>
                <input type="password" id="new-password" class="w-full p-2 border rounded-md" required>
                <p id="new-password-error" class="text-red-500 text-sm mt-1 hidden"></p>
              </div>
              <div>
                <label for="confirm-new-password" class="block text-gray-200 font-medium mb-1">Confirm New Password</label>
                <input type="password" id="confirm-new-password" class="w-full p-2 border rounded-md" required>
                <p id="confirm-new-password-error" class="text-red-500 text-sm mt-1 hidden"></p>
              </div>
              <div id="password-change-status" class="mt-4 text-center hidden"></div>
              <button type="submit" id="changePasswordBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
                <i class="fas fa-key mr-2"></i>Change Password
              </button>
            </form>
          </div>

          <!-- Change Email Section -->
          <div class="collapsible-header glass-panel p-4 rounded-md mb-4 flex items-center justify-between">
            <h3 class="text-xl font-bold text-green-800">Change Email</h3>
            <i class="fas fa-chevron-down text-gray-300"></i>
          </div>
          <div class="collapsible-content glass-panel p-4 rounded-b-md mb-6">
            <form id="change-email-form" class="space-y-4">
              <div>
                <label for="current-email" class="block text-gray-200 font-medium mb-1">Current Email</label>
                <input type="email" id="current-email" class="w-full p-2 border rounded-md" value="${currentUserData.email || ''}" disabled>
              </div>
              <div>
                <label for="new-email" class="block text-gray-200 font-medium mb-1">New Email</label>
                <input type="email" id="new-email" class="w-full p-2 border rounded-md" required>
                <p id="new-email-error" class="text-red-500 text-sm mt-1 hidden"></p>
              </div>
              <div>
                <label for="email-reauth-password" class="block text-gray-200 font-medium mb-1">Confirm Current Password</label>
                <input type="password" id="email-reauth-password" class="w-full p-2 border rounded-md" required>
                <p id="email-reauth-password-error" class="text-red-500 text-sm mt-1 hidden"></p>
              </div>
              <div id="email-change-status" class="mt-4 text-center hidden"></div>
              <button type="submit" id="changeEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
                <i class="fas fa-envelope mr-2"></i>Change Email
              </button>
            </form>
          </div>

          <!-- Delete Account Section -->
          <div class="collapsible-header glass-panel p-4 rounded-md mb-4 flex items-center justify-between bg-red-100 hover:bg-red-200">
            <h3 class="text-xl font-bold text-red-700">Delete Account</h3>
            <i class="fas fa-chevron-down text-gray-300"></i>
          </div>
          <div class="collapsible-content glass-panel p-4 rounded-b-md mb-6 bg-red-50 border border-red-300">
            <p class="text-red-700 mb-4">Deleting your account is permanent and cannot be undone. All your data will be removed.</p>
            <form id="delete-account-form" class="space-y-4">
              <div>
                <label for="delete-password" class="block text-red-700 font-medium mb-1">Enter Password to Confirm</label>
                <input type="password" id="delete-password" class="w-full p-2 border border-red-300 rounded-md focus:ring-red-500" required>
                <p id="delete-password-error" class="text-red-500 text-sm mt-1 hidden"></p>
              </div>
              <div id="delete-account-status" class="mt-4 text-center hidden"></div>
              <button type="submit" id="deleteAccountBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out shadow-lg">
                <i class="fas fa-trash-alt mr-2"></i>Delete My Account
              </button>
            </form>
          </div>

        </div>
      `;
      content.innerHTML = generateBreadcrumb("Settings") + settingsHtml;
      setupCollapsibles(); // Initialize collapsible behavior

      // --- Change Password Logic ---
      const changePasswordForm = document.getElementById('change-password-form');
      const currentPasswordInput = document.getElementById('current-password');
      const newPasswordInput = document.getElementById('new-password');
      const confirmNewPasswordInput = document.getElementById('confirm-new-password');
      const passwordChangeStatus = document.getElementById('password-change-status');
      const changePasswordBtn = document.getElementById('changePasswordBtn');

      const currentPasswordError = document.getElementById('current-password-error');
      const newPasswordError = document.getElementById('new-password-error');
      const confirmNewPasswordError = document.getElementById('confirm-new-password-error');

      currentPasswordError.dataset.errorMessage = "Please enter your current password.";
      newPasswordError.dataset.errorMessage = "New password must be at least 6 characters.";
      confirmNewPasswordError.dataset.errorMessage = "New passwords do not match.";

      currentPasswordInput.addEventListener('input', () => validateInput(currentPasswordInput, (val) => val.length > 0, currentPasswordError));
      newPasswordInput.addEventListener('input', () => validateInput(newPasswordInput, isValidPassword, newPasswordError));
      confirmNewPasswordInput.addEventListener('input', () => validateInput(confirmNewPasswordInput, (val) => val === newPasswordInput.value && isValidPassword(val), confirmNewPasswordError));

      changePasswordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          setButtonLoading(changePasswordBtn, true);
          passwordChangeStatus.classList.add('hidden');

          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const confirmNewPassword = confirmNewPasswordInput.value;

          const isCurrentValid = validateInput(currentPasswordInput, (val) => val.length > 0, currentPasswordError);
          const isNewValid = validateInput(newPasswordInput, isValidPassword, newPasswordError);
          const isConfirmNewValid = validateInput(confirmNewPasswordInput, (val) => val === newPassword && isValidPassword(val), confirmNewPasswordError);

          if (!isCurrentValid || !isNewValid || !isConfirmNewValid) {
              await showCustomModal("Validation Error", "Please correct the highlighted fields.");
              setButtonLoading(changePasswordBtn, false);
              return;
          }

          if (newPassword !== confirmNewPassword) {
              confirmNewPasswordError.innerText = "❌ New passwords do not match.";
              confirmNewPasswordError.classList.remove('hidden');
              confirmNewPasswordInput.classList.add('border-red-500');
              await showCustomModal("Validation Error", "New passwords do not match.");
              setButtonLoading(changePasswordBtn, false);
              return;
          }

          try {
              const user = auth.currentUser;
              const credential = EmailAuthProvider.credential(user.email, currentPassword);
              await reauthenticateWithCredential(user, credential);
              await updatePassword(user, newPassword);
              passwordChangeStatus.innerText = "✅ Password changed successfully!";
              passwordChangeStatus.classList.remove('hidden', 'text-red-500');
              passwordChangeStatus.classList.add('text-green-500');
              await showCustomModal("Success", "Your password has been changed successfully!");
              changePasswordForm.reset();
              currentPasswordInput.classList.remove('border-red-500', 'border-green-500');
              newPasswordInput.classList.remove('border-red-500', 'border-green-500');
              confirmNewPasswordInput.classList.remove('border-red-500', 'border-green-500');
              currentPasswordError.classList.add('hidden');
              newPasswordError.classList.add('hidden');
              confirmNewPasswordError.classList.add('hidden');
          } catch (error) {
              console.error("Error changing password:", error);
              let errorMessage = "❌ Failed to change password.";
              if (error.code === 'auth/wrong-password') {
                  errorMessage = "❌ Current password is incorrect.";
                  currentPasswordError.innerText = errorMessage;
                  currentPasswordError.classList.remove('hidden');
                  currentPasswordInput.classList.add('border-red-500');
              } else if (error.code === 'auth/weak-password') {
                  errorMessage = "❌ New password is too weak.";
                  newPasswordError.innerText = errorMessage;
                  newPasswordError.classList.remove('hidden');
                  newPasswordInput.classList.add('border-red-500');
              } else if (error.code === 'auth/requires-recent-login') {
                  errorMessage = "❌ Please log in again to change your password.";
              }
              passwordChangeStatus.innerText = errorMessage;
              passwordChangeStatus.classList.remove('hidden', 'text-green-500');
              passwordChangeStatus.classList.add('text-red-500');
              await showCustomModal("Error", errorMessage);
          } finally {
              setButtonLoading(changePasswordBtn, false);
          }
      });

      // --- Change Email Logic ---
      const changeEmailForm = document.getElementById('change-email-form');
      const newEmailInput = document.getElementById('new-email');
      const emailReauthPasswordInput = document.getElementById('email-reauth-password');
      const emailChangeStatus = document.getElementById('email-change-status');
      const changeEmailBtn = document.getElementById('changeEmailBtn');

      const newEmailError = document.getElementById('new-email-error');
      const emailReauthPasswordError = document.getElementById('email-reauth-password-error');

      newEmailError.dataset.errorMessage = "Please enter a valid email address.";
      emailReauthPasswordError.dataset.errorMessage = "Please enter your current password.";

      newEmailInput.addEventListener('input', () => validateInput(newEmailInput, isValidEmail, newEmailError));
      emailReauthPasswordInput.addEventListener('input', () => validateInput(emailReauthPasswordInput, (val) => val.length > 0, emailReauthPasswordError));


      changeEmailForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          setButtonLoading(changeEmailBtn, true);
          emailChangeStatus.classList.add('hidden');

          const newEmail = newEmailInput.value.trim().toLowerCase();
          const reauthPassword = emailReauthPasswordInput.value;

          const isNewEmailValid = validateInput(newEmailInput, isValidEmail, newEmailError);
          const isReauthPasswordValid = validateInput(emailReauthPasswordInput, (val) => val.length > 0, emailReauthPasswordError);

          if (!isNewEmailValid || !isReauthPasswordValid) {
              await showCustomModal("Validation Error", "Please correct the highlighted fields.");
              setButtonLoading(changeEmailBtn, false);
              return;
          }

          if (newEmail === currentUserData.email) {
            emailChangeStatus.innerText = "⚠️ New email cannot be the same as current email.";
            emailChangeStatus.classList.remove('hidden');
            emailChangeStatus.classList.add('text-yellow-500');
            setButtonLoading(changeEmailBtn, false);
            return;
          }

          try {
              const user = auth.currentUser;
              const credential = EmailAuthProvider.credential(user.email, reauthPassword);
              await reauthenticateWithCredential(user, credential);
              await updateEmail(user, newEmail);

              // Update Firestore with new email
              await updateDoc(doc(db, `students`, currentUserId), { email: newEmail });
              currentUserData.email = newEmail; // Update local data

              document.getElementById('current-email').value = newEmail; // Update display
              emailChangeStatus.innerText = "✅ Email changed successfully! You may need to verify your new email.";
              emailChangeStatus.classList.remove('hidden', 'text-red-500');
              emailChangeStatus.classList.add('text-green-500');
              await showCustomModal("Success", "Your email has been changed successfully! Please check your new email for verification if prompted.");
              changeEmailForm.reset();
              newEmailInput.classList.remove('border-red-500', 'border-green-500');
              emailReauthPasswordInput.classList.remove('border-red-500', 'border-green-500');
              newEmailError.classList.add('hidden');
              emailReauthPasswordError.classList.add('hidden');
          } catch (error) {
              console.error("Error changing email:", error);
              let errorMessage = "❌ Failed to change email.";
              if (error.code === 'auth/wrong-password') {
                  errorMessage = "❌ Incorrect current password.";
                  emailReauthPasswordError.innerText = errorMessage;
                  emailReauthPasswordError.classList.remove('hidden');
                  emailReauthPasswordInput.classList.add('border-red-500');
              } else if (error.code === 'auth/email-already-in-use') {
                  errorMessage = "❌ This email is already in use by another account.";
                  newEmailError.innerText = errorMessage;
                  newEmailError.classList.remove('hidden');
                  newEmailInput.classList.add('border-red-500');
              } else if (error.code === 'auth/invalid-email') {
                  errorMessage = "❌ Invalid new email address.";
                  newEmailError.innerText = errorMessage;
                  newEmailError.classList.remove('hidden');
                  newEmailInput.classList.add('border-red-500');
              } else if (error.code === 'auth/requires-recent-login') {
                  errorMessage = "❌ Please log in again to change your email.";
              }
              emailChangeStatus.innerText = errorMessage;
              emailChangeStatus.classList.remove('hidden', 'text-green-500');
              emailChangeStatus.classList.add('text-red-500');
              await showCustomModal("Error", errorMessage);
          } finally {
              setButtonLoading(changeEmailBtn, false);
          }
      });

      // --- Delete Account Logic ---
      const deleteAccountForm = document.getElementById('delete-account-form');
      const deletePasswordInput = document.getElementById('delete-password');
      const deleteAccountStatus = document.getElementById('delete-account-status');
      const deleteAccountBtn = document.getElementById('deleteAccountBtn');

      const deletePasswordError = document.getElementById('delete-password-error');
      deletePasswordError.dataset.errorMessage = "Please enter your password to confirm deletion.";

      deletePasswordInput.addEventListener('input', () => validateInput(deletePasswordInput, (val) => val.length > 0, deletePasswordError));

      deleteAccountForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const confirmDeletion = await showCustomModal("Confirm Deletion", "Are you absolutely sure you want to delete your account? This action is irreversible.", true);
          if (!confirmDeletion) {
              return;
          }

          setButtonLoading(deleteAccountBtn, true);
          deleteAccountStatus.classList.add('hidden');

          const password = deletePasswordInput.value;
          const isPasswordValid = validateInput(deletePasswordInput, (val) => val.length > 0, deletePasswordError);

          if (!isPasswordValid) {
              await showCustomModal("Validation Error", "Please enter your password to confirm deletion.");
              setButtonLoading(deleteAccountBtn, false);
              return;
          }

          try {
              const user = auth.currentUser;
              const credential = EmailAuthProvider.credential(user.email, password);
              await reauthenticateWithCredential(user, credential);

              // Delete user data from Firestore
              const batch = writeBatch(db);
              const userDocRef = doc(db, `students`, user.uid);
              batch.delete(userDocRef);

              // Delete subcollections (example, iterate and delete documents in batches)
              const subcollectionsToDelete = ['grades', 'registrations', 'feesStatement', 'clearance', 'graduation', 'hostel'];
              for (const subcol of subcollectionsToDelete) {
                  const subColRef = collection(userDocRef, subcol);
                  const subColSnapshot = await getDocs(subColRef);
                  subColSnapshot.forEach(subDoc => {
                      batch.delete(subDoc.ref);
                  });
              }
              await batch.commit();
              console.log("Firestore data deleted.");

              // Delete profile photo from storage if exists
              if (currentUserData.profilePhotoURL) {
                  const photoRef = ref(storage, `profilePhotos/${currentUserId}/`); // Adjust path if you store individual files directly
                  // Note: Deleting a folder recursively in Firebase Storage client SDK is complex.
                  // This example assumes simple single file deletion. For complex cases, use Cloud Functions.
                  // For now, we will just delete the user's main profile photo if it exists.
                  try {
                      const fileRef = ref(storage, currentUserData.profilePhotoURL);
                      await deleteObject(fileRef);
                      console.log("Profile photo deleted from storage.");
                  } catch (storageError) {
                      console.warn("Could not delete profile photo from storage (may not exist or permission issue):", storageError);
                  }
              }

              await deleteUser(user);

              deleteAccountStatus.innerText = "✅ Account successfully deleted. Redirecting...";
              deleteAccountStatus.classList.remove('hidden', 'text-red-500');
              deleteAccountStatus.classList.add('text-green-500');
              await showCustomModal("Success", "Your account and all associated data have been permanently deleted.");
              // Firebase onAuthStateChanged listener will handle redirect to login form
          } catch (error) {
              console.error("Error deleting account:", error);
              let errorMessage = "❌ Failed to delete account.";
              if (error.code === 'auth/wrong-password') {
                  errorMessage = "❌ Incorrect password. Please try again.";
                  deletePasswordError.innerText = errorMessage;
                  deletePasswordError.classList.remove('hidden');
                  deletePasswordInput.classList.add('border-red-500');
              } else if (error.code === 'auth/requires-recent-login') {
                  errorMessage = "❌ Please log in again to delete your account (for security reasons).";
              } else {
                  errorMessage += ` Error: ${error.message}`;
              }
              deleteAccountStatus.innerText = errorMessage;
              deleteAccountStatus.classList.remove('hidden', 'text-green-500');
              deleteAccountStatus.classList.add('text-red-500');
              await showCustomModal("Error", errorMessage);
          } finally {
              setButtonLoading(deleteAccountBtn, false);
          }
      });
    }

    // Main navigation handler
    window.showDashboardSection = function(section) {
      const content = document.getElementById("dashboardContent");
      content.innerHTML = '';
      sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile
      switch (section) {
        case 'home':
          loadHome();
          break;
        case 'profile':
          loadProfile();
          break;
        case 'courseReg':
          loadCourseReg();
          break;
        case 'courses': // Assuming this would list all available courses, not just registered
          // A dedicated loadCourses() function can be added here
          // For now, it will default to home if not implemented.
          loadHome();
          break;
        case 'timetable':
        case 'examTimetable': // Alias for timetable
          loadTimetable();
          break;
        case 'grades':
          loadGrades();
          break;
        case 'graduation':
          loadGraduation();
          break;
        case 'clearance':
          loadClearance();
          break;
        case 'fees':
        case 'receipts': // Receipts would typically be part of fees statement or a sub-section
          loadFees();
          break;
        case 'examCard':
          loadExamCard();
          break;
        case 'hostels':
          loadHostels();
          break;
        case 'announcements':
          loadAnnouncements();
          break;
        case 'settings':
          loadSettings();
          break;
        default:
          loadHome();
      }
    };
  </script>
</body>
</html>
