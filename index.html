<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('myschoolgate.png') no-repeat center center fixed;
      background-size: cover;
      /* Removed h-screen flex items-center justify-center from body */
    }
    /* Centering forms with new wrapper */
    .auth-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh; /* Ensures it takes full viewport height for centering */
      padding: 20px; /* Provides padding around the form */
      overflow-y: auto; /* Allows scrolling on small screens if content overflows */
    }
    .form-wrapper.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .gpa-circle-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 20px auto;
    }
    .gpa-circle-svg {
      transform: rotate(-90deg);
    }
    .gpa-circle-bg {
      stroke: #e0e0e0;
      stroke-width: 10;
      fill: none;
    }
    .gpa-circle-progress {
      stroke: #006400; /* University green */
      stroke-width: 10;
      fill: none;
      transition: stroke-dasharray 0.5s ease-in-out;
    }
    /* Style for GPA circle when GPA is zero/no data */
    .gpa-circle-progress.no-gpa {
      stroke: #a0a0a0; /* Grey color for no GPA */
    }
    .gpa-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.8rem;
      font-weight: bold;
      color: #006400;
    }
    /* Style for GPA text when GPA is zero */
    .gpa-text.no-gpa {
        color: #718096; /* Tailwind gray-600 */
    }
    .fees-balance-text.red {
        color: #dc2626; /* Tailwind red-600 */
    }
    .fees-balance-text.green {
        color: #16a34a; /* Tailwind green-600 */
    }
    /* Hide scrollbar for announcements panel, but allow scrolling */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    /* General table styling */
    .styled-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .styled-table thead tr {
      background-color: #e2e8f0; /* Light gray for header */
      text-align: left;
    }
    .styled-table th, .styled-table td {
      padding: 12px 15px;
      border: 1px solid #cbd5e0; /* Light border */
    }
    .styled-table tbody tr:nth-of-type(even) {
      background-color: #f8fafc; /* Lighter alternating row */
    }
    .styled-table tbody tr:hover {
      background-color: #eff6ff; /* Blue tint on hover */
    }
    .styled-table tbody tr.no-data-row td {
      text-align: center;
      font-style: italic;
      color: #718096;
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
    <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-300">
      <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
      <p id="modalMessage" class="mb-6 text-gray-700"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
        <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Authentication Forms Container -->
  <div id="authContainer">
    <!-- Login Form Wrapper -->
    <div class="auth-wrapper">
      <div id="login-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-[420px] text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5 active">
        <form id="login-form">
          <h2 class="text-4xl font-extrabold text-green-800 mb-8">Login</h2>
          <div class="mb-6 text-left">
            <label for="email-login" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
            <input type="email" id="email-login" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
            <p id="email-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
          </div>
          <div class="mb-6 text-left">
            <label for="password-login" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
            <input type="password" id="password-login" placeholder="Enter your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
            <p id="password-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
          </div>
          <button type="submit" id="login-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Login</button>
          <div class="mt-6 text-sm flex justify-center space-x-4">
            <a href="#" onclick="showForm('signup')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Don't have an account? Sign Up</a>
            <a href="#" onclick="showForm('forgot-password')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Forgot Password?</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Signup Form Wrapper -->
    <div class="auth-wrapper">
      <div id="signup-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-[420px] text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
        <form id="signup-form">
          <h2 class="text-4xl font-extrabold text-green-800 mb-8">Sign Up</h2>
          <div class="mb-6 text-left">
            <label for="full-name-signup" class="block text-gray-700 text-sm font-medium mb-2">Full Name</label>
            <input type="text" id="full-name-signup" placeholder="Enter your full name" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
          </div>
          <div class="mb-6 text-left">
            <label for="email-signup" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
            <input type="email" id="email-signup" placeholder="Enter your email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
            <p id="email-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
          </div>
          <div class="mb-6 text-left">
            <label for="password-signup" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
            <input type="password" id="password-signup" placeholder="Create a password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
            <p id="password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
          </div>
          <div class="mb-6 text-left">
            <label for="confirm-password-signup" class="block text-gray-700 text-sm font-medium mb-2">Confirm Password</label>
            <input type="password" id="confirm-password-signup" placeholder="Confirm your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
            <p id="confirm-password-signup-error" class="text-red-500 text-sm mt-1 hidden"></p>
          </div>
          <button type="submit" id="signup-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Sign Up</button>
          <div class="mt-6 text-sm">
            <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Already have an account? Login</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Forgot Password Form Wrapper -->
    <div class="auth-wrapper">
      <div id="forgot-password-form-wrapper" class="form-wrapper bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-[420px] text-center transform transition-all duration-500 ease-in-out opacity-0 invisible translate-y-5">
        <form id="forgot-password-form">
          <h2 class="text-4xl font-extrabold text-green-800 mb-8">Forgot Password</h2>
          <div class="mb-6 text-left">
            <label for="email-forgot" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
            <input type="email" id="email-forgot" placeholder="Enter your email" required autofocus class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200" />
            <p id="email-forgot-error" class="text-red-500 text-sm mt-1 hidden"></p>
          </div>
          <button type="submit" id="recover-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Recover Password</button>
          <div class="mt-6 text-sm">
            <a href="#" onclick="showForm('login')" class="text-green-700 hover:text-green-900 hover:underline transition-colors duration-200">Back to Login</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="dashboardContainer" class="hidden h-screen flex flex-col bg-gray-100 w-full">
    <header class="bg-white text-green-800 p-4 flex justify-between items-center shadow-md sticky top-0 z-10 lg:px-8">
      <img src="https://placehold.co/150x50/34D399/FFFFFF?text=Logo" alt="University Logo" class="h-12 w-auto">
      <button id="menuToggle" class="lg:hidden text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
        <i class="fas fa-bars"></i>
      </button>
      <div class="hidden lg:flex items-center space-x-4">
        <span class="text-lg font-semibold text-green-700">Welcome, <span id="userName" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
       <div class="lg:hidden flex items-center space-x-4">
        <span class="text-md font-semibold text-green-700">Welcome, <span id="userNameMobile" class="font-bold">User</span>!</span>
        <button onclick="confirmLogout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition duration-300 ease-in-out shadow-sm">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <div class="flex flex-grow">
      <nav id="sidebar" class="w-64 bg-green-900 text-white p-6 flex flex-col space-y-2 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20 fixed inset-y-0 left-0 lg:relative lg:flex-shrink-0 lg:h-auto overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Quick Menu</h3>
        <a onclick="showDashboardSection('home')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i> Home</a>
        <a onclick="showDashboardSection('profile')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user mr-3"></i> Personal Profile</a>

        <a onclick="toggleSubmenu('academics-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-book mr-3"></i> Academics <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="academics-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('courses')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-book-open mr-3"></i> All Courses</a>
          <a onclick="showDashboardSection('registrations')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-alt mr-3"></i> Course Registration</a>
          <a onclick="showDashboardSection('timetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-calendar-alt mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('grades')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-check mr-3"></i> Grades</a>
          <a onclick="showDashboardSection('evaluation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clipboard-list mr-3"></i> Course Evaluation</a>
          <a onclick="showDashboardSection('graduation')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-graduation-cap mr-3"></i> Graduation Request</a>
          <a onclick="showDashboardSection('clearance')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-check-circle mr-3"></i> Clearance Request</a>
        </div>

        <a onclick="toggleSubmenu('finance-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-money-bill-wave mr-3"></i> Finance <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="finance-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('fees')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-credit-card mr-3"></i> Fees Statement</a>
          <a onclick="showDashboardSection('receipts')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-receipt mr-3"></i> Receipts</a>
          <a onclick="showDashboardSection('examCard')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-id-card mr-3"></i> Exam Card</a>
        </div>

        <a onclick="toggleSubmenu('exam-submenu')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg cursor-pointer"><i class="fas fa-laptop-code mr-3"></i> Examination <i class="fas fa-chevron-down ml-auto text-sm"></i></a>
        <div id="exam-submenu" class="ml-6 py-2 hidden">
          <a onclick="showDashboardSection('examTimetable')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-clock mr-3"></i> Timetable</a>
          <a onclick="showDashboardSection('transcripts')" class="flex items-center p-2 rounded-lg hover:bg-green-800 transition-colors duration-200 text-base"><i class="fas fa-file-invoice mr-3"></i> Transcripts</a>
        </div>
        <a onclick="showDashboardSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-hotel mr-3"></i> Accommodation</a>
        <a onclick="showDashboardSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i> Announcements</a>
        <a onclick="showDashboardSection('settings')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-cog mr-3"></i> Settings</a>
      </nav>

      <main id="dashboardContent" class="flex-grow p-6 overflow-y-auto lg:ml-64 w-full">
        </main>
    </div>

    <footer class="bg-white text-gray-600 text-center p-4 text-sm shadow-inner mt-auto">
      2025 © Prince Alex Design University. All rights reserved.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, arrayUnion, arrayRemove, addDoc, getDocs, deleteDoc, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Firebase Config: Replace with your actual Firebase project details
    const hardcodedFirebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A", // This is a placeholder. Ensure your actual Firebase API Key is used.
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : hardcodedFirebaseConfig.projectId; // Kept for consistency if needed, though not directly in new Firestore paths
    const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    // Corrected the typo here: use __initial_auth_token directly
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

    let app;
    if (firebaseConfigFromCanvas) {
        app = initializeApp(firebaseConfigFromCanvas);
    } else {
        // Fallback for local development if __firebase_config is not defined
        app = initializeApp(hardcodedFirebaseConfig);
    }

    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let currentUserData = null;

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const authContainer = document.getElementById('authContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const sidebar = document.getElementById('sidebar');

    // --- Custom Modal Functions (replaces alert/confirm) ---
    function showCustomModal(title, message, isConfirm = false) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        if (modalTitle) modalTitle.innerText = title;
        if (modalMessage) modalMessage.innerText = message;

        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(true);
            };
        }
        if (modalCancelBtn) {
            modalCancelBtn.onclick = () => {
                if (modal) modal.classList.add('hidden');
                resolve(false);
            };
            modalCancelBtn.classList.toggle('hidden', !isConfirm); // Toggle visibility based on isConfirm
        }
        if (modal) modal.classList.remove('hidden'); // Show modal
      });
    }

    window.alert = (message) => showCustomModal('Alert', message); // Override alert
    window.confirm = (message) => showCustomModal('Confirm', message, true); // Override confirm
    // --- End Custom Modal Functions ---

    // Function to set button loading state
    function setButtonLoading(button, isLoading) {
      if (button) {
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<i class="fas fa-spinner animate-spin mr-2"></i>Loading...' : button.dataset.originalHtml;
      }
    }

    // Function to store original button HTML for loading state
    function storeOriginalButtonHtml() {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.dataset.originalHtml = button.innerHTML;
      });
    }

    // Inline form validation utility
    function validateInput(inputElement, validationFn, errorMessageElement) {
        if (validationFn(inputElement.value)) {
            inputElement.classList.remove('border-red-500');
            inputElement.classList.add('border-gray-300', 'focus:ring-green-500');
            errorMessageElement.classList.add('hidden');
            return true;
        } else {
            inputElement.classList.remove('border-gray-300', 'focus:ring-green-500');
            inputElement.classList.add('border-red-500');
            errorMessageElement.innerText = `❌ ${errorMessageElement.dataset.errorMessage || 'Invalid input.'}`;
            errorMessageElement.classList.remove('hidden');
            return false;
        }
    }

    // Email validation regex (basic)
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    // Password validation regex (at least 6 characters)
    const isValidPassword = (password) => password.length >= 6;


    // Function to show specific authentication form and hide others
    window.showForm = function(formId) {
      const allAuthWrappers = document.querySelectorAll('.auth-wrapper');
      allAuthWrappers.forEach(wrapper => wrapper.classList.add('hidden')); // Hide all auth wrappers initially

      const forms = document.querySelectorAll('.form-wrapper');
      forms.forEach(form => {
        form.classList.remove('active');
        form.classList.add('opacity-0', 'invisible', 'translate-y-5');
      });

      const activeFormWrapper = document.getElementById(`${formId}-form-wrapper`);
      if (activeFormWrapper) {
        // Show the parent auth-wrapper
        activeFormWrapper.closest('.auth-wrapper').classList.remove('hidden');
        activeFormWrapper.classList.remove('opacity-0', 'invisible', 'translate-y-5');
        activeFormWrapper.classList.add('active');
        // Autofocus the first input in the new form
        const firstInput = activeFormWrapper.querySelector('input:not([type="hidden"]), select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      }
    };

    // This function runs once the DOM is fully loaded and before onAuthStateChanged fires its initial state.
    async function initializeAppUI() {
        storeOriginalButtonHtml(); // Store original button HTML for loading states
        // Removed initial loading overlay display here. onAuthStateChanged will manage initial UI.

        // Attach inline validation listeners
        attachFormValidationListeners();

        // The initial sign-in attempt (custom token or anonymous) will happen in the background.
        // The onAuthStateChanged listener will then handle the UI update based on the result.
        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Attempted sign-in with custom token.");
            } catch (error) {
                console.error("Error with custom token, attempting anonymous sign-in:", error);
                await signInAnonymously(auth); // Fallback to anonymous if custom token fails
                console.log("Attempted anonymous sign-in.");
            }
        } else {
            try {
                await signInAnonymously(auth);
                console.log("Attempted anonymous sign-in.");
            } catch (error) {
                console.error("Error during initial anonymous sign-in attempt:", error);
                // No modal here; onAuthStateChanged will direct to login if sign-in fails.
            }
        }
    }

    window.onload = initializeAppUI;

    // --- Authentication Forms Event Listeners ---
    document.getElementById('login-form').addEventListener('submit', loginUser);
    document.getElementById('signup-form').addEventListener('submit', signupUser);
    document.getElementById('forgot-password-form').addEventListener('submit', recoverPassword);

    function attachFormValidationListeners() {
        // Login form
        const emailLogin = document.getElementById('email-login');
        const emailLoginError = document.getElementById('email-login-error');
        if (emailLogin) {
            emailLoginError.dataset.errorMessage = "Please enter a valid email address.";
            emailLogin.addEventListener('input', () => validateInput(emailLogin, isValidEmail, emailLoginError));
        }
        const passwordLogin = document.getElementById('password-login');
        const passwordLoginError = document.getElementById('password-login-error');
        if (passwordLogin) {
            passwordLoginError.dataset.errorMessage = "Password must be at least 6 characters.";
            passwordLogin.addEventListener('input', () => validateInput(passwordLogin, isValidPassword, passwordLoginError));
        }

        // Signup form
        const emailSignup = document.getElementById('email-signup');
        const emailSignupError = document.getElementById('email-signup-error');
        if (emailSignup) {
            emailSignupError.dataset.errorMessage = "Please enter a valid email address.";
            emailSignup.addEventListener('input', () => validateInput(emailSignup, isValidEmail, emailSignupError));
        }
        const passwordSignup = document.getElementById('password-signup');
        const passwordSignupError = document.getElementById('password-signup-error');
        if (passwordSignup) {
            passwordSignupError.dataset.errorMessage = "Password must be at least 6 characters long.";
            passwordSignup.addEventListener('input', () => validateInput(passwordSignup, isValidPassword, passwordSignupError));
        }
        const confirmPasswordSignup = document.getElementById('confirm-password-signup');
        const confirmPasswordSignupError = document.getElementById('confirm-password-signup-error');
        if (confirmPasswordSignup) {
            confirmPasswordSignupError.dataset.errorMessage = "Passwords do not match.";
            confirmPasswordSignup.addEventListener('input', () => {
                const match = passwordSignup.value === confirmPasswordSignup.value;
                validateInput(confirmPasswordSignup, () => match, confirmPasswordSignupError);
            });
        }

        // Forgot password form
        const emailForgot = document.getElementById('email-forgot');
        const emailForgotError = document.getElementById('email-forgot-error');
        if (emailForgot) {
            emailForgotError.dataset.errorMessage = "Please enter a valid email address.";
            emailForgot.addEventListener('input', () => validateInput(emailForgot, isValidEmail, emailForgotError));
        }
    }


    // --- Authentication Flow ---
    onAuthStateChanged(auth, async (user) => {
      try {
        if (user) {
          currentUserId = user.uid;
          console.log("User authenticated (from onAuthStateChanged):", user.email, user.uid);

          // Fetch or create user data from Firestore
          const profileDocRef = doc(db, `students`, currentUserId); // Updated path: /students/{uid}
          const profileDocSnap = await getDoc(profileDocRef);

          if (profileDocSnap.exists()) {
            currentUserData = profileDocSnap.data();
            document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
            // Update mobile greeting
            const userNameMobile = document.getElementById("userNameMobile");
            if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
          } else {
            // If profile does not exist (e.g., first login/anonymous signup), create a basic one
            await setDoc(profileDocRef, {
              email: user.email,
              name: user.email.split("@")[0], // Placeholder name
              regNo: "N/A",
              programme: "N/A",
              campus: "Main Campus",
              dob: "N/A",
              gender: "N/A",
              address: "N/A",
              profilePhotoURL: "",
              createdAt: new Date().toISOString(),
              initialized: true
            });
            currentUserData = (await getDoc(profileDocRef)).data();
            document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
            const userNameMobile = document.getElementById("userNameMobile");
            if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
            console.log("Created basic user profile during dashboard load fallback.");
          }

          // --- UI Transition to Dashboard ---
          authContainer.classList.add('hidden'); // Hide auth forms container
          dashboardContainer.classList.remove('hidden'); // Show dashboard
          

          // Check if essential profile data is incomplete (adjust as needed for what constitutes 'incomplete')
          if (currentUserData.regNo === 'N/A' || currentUserData.programme === 'N/A' || currentUserData.dob === 'N/A' || currentUserData.gender === 'N/A') {
              await showCustomModal("Welcome", "Please complete your profile information.");
              showDashboardSection('profile'); // Direct user to profile page
          } else {
              showDashboardSection('home'); // Show default dashboard content
          }

        } else {
          // User is signed out or not logged in, show login page
          // authContainer is already visible by default in HTML
          dashboardContainer.classList.add('hidden'); // Ensure dashboard is hidden
          showForm('login'); // Ensure login form is visible and active
        }
      } catch (error) {
          console.error("Error in onAuthStateChanged:", error);
          await showCustomModal("Initialization Error", "Failed to load user data or dashboard. Please try again.");
          // Fallback to showing login form on unhandled error during dashboard init
          dashboardContainer.classList.add('hidden');
          showForm('login');
      } finally {
          hideLoading(); // Ensure loading overlay is hidden regardless of outcome
      }
    });

    // Function to log in user
    async function loginUser(event) {
      event.preventDefault();
      const loginBtn = document.getElementById('login-btn');
      const emailInput = document.getElementById("email-login");
      const passwordInput = document.getElementById("password-login");
      const emailError = document.getElementById('email-login-error');
      const passwordError = document.getElementById('password-login-error');

      // Perform client-side validation first
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);

      if (!isEmailValid || !isPasswordValid) {
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      showLoading("Logging in..."); // Show loading overlay specifically for login
      setButtonLoading(loginBtn, true);

      const email = emailInput.value.trim().toLowerCase();
      const password = password.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        await showCustomModal("Login Success", "✅ Login successful! Redirecting...");
        // onAuthStateChanged listener will handle the UI update after successful login.
      } catch (error) {
        let errorMessage = "❌ Login failed.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = "❌ Invalid email or password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Login Failed", errorMessage);
        console.error("Login error:", error);
      } finally {
        setButtonLoading(loginBtn, false);
        hideLoading(); // Hide loading overlay after login attempt
      }
    }

    // Function to sign up new user
    async function signupUser(event) {
      event.preventDefault();
      const signupBtn = document.getElementById('signup-btn');
      const fullNameInput = document.getElementById("full-name-signup");
      const emailInput = document.getElementById("email-signup");
      const passwordInput = document.getElementById("password-signup");
      const confirmPasswordInput = document.getElementById("confirm-password-signup");

      const emailError = document.getElementById('email-signup-error');
      const passwordError = document.getElementById('password-signup-error');
      const confirmPasswordError = document.getElementById('confirm-password-signup-error');

      // Client-side validation
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      const isPasswordValid = validateInput(passwordInput, isValidPassword, passwordError);
      const passwordsMatch = (passwordInput.value === confirmPasswordInput.value);
      const isConfirmPasswordValid = validateInput(confirmPasswordInput, () => passwordsMatch, confirmPasswordError);

      if (!isEmailValid || !isPasswordValid || !isConfirmPasswordValid || !passwordsMatch) {
          if (!passwordsMatch) {
              confirmPasswordError.innerText = "❌ Passwords do not match!";
              confirmPasswordError.classList.remove('hidden');
              confirmPasswordInput.classList.add('border-red-500');
          }
          await showCustomModal("Validation Error", "Please correct the highlighted fields.");
          return;
      }

      showLoading("Signing up..."); // Show loading overlay specifically for signup
      setButtonLoading(signupBtn, true);

      const fullName = fullNameInput.value.trim();
      const email = emailInput.value.trim().toLowerCase();
      const password = password.value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Create user document in Firestore directly under /students/{uid}
        const userDocRef = doc(db, `students`, user.uid); // Updated path
        await setDoc(userDocRef, {
            email: user.email,
            name: fullName,
            regNo: "N/A",
            programme: "N/A",
            campus: "Main Campus",
            dob: "N/A",
            gender: "N/A",
            address: "N/A",
            profilePhotoURL: "",
            createdAt: new Date().toISOString(),
            initialized: true
        });
        console.log("User signed up and profile created:", user.email);

        await showCustomModal("Signup Success", "✅ Signup successful! Please log in with your new account.");

        // Redirect to login form after successful signup and modal close
        showForm('login');

      } catch (error) {
        let errorMessage = "❌ Signup failed.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "❌ Email already in use. Try logging in or recovering password.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Invalid email address.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "❌ Password is too weak. Please choose a stronger password.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "❌ Network error. Please check your internet connection.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Signup Failed", errorMessage);
        console.error("Signup error:", error);
      } finally {
        setButtonLoading(signupBtn, false);
        hideLoading(); // Hide loading overlay after signup attempt
      }
    }

    // Function to recover password
    async function recoverPassword(event) {
      event.preventDefault();
      const recoverBtn = document.getElementById('recover-btn');
      const emailInput = document.getElementById("email-forgot");
      const emailError = document.getElementById('email-forgot-error');
      const isEmailValid = validateInput(emailInput, isValidEmail, emailError);
      if (!isEmailValid) {
        await showCustomModal("Validation Error", "Please enter a valid email address.");
        return;
      }
      showLoading("Sending recovery email..."); // Show loading overlay specifically for password recovery
      setButtonLoading(recoverBtn, true);
      const email = emailInput.value.trim().toLowerCase();
      try {
        await sendPasswordResetEmail(auth, email);
        await showCustomModal("Password Recovery", "✅ Password reset email sent! Check your inbox.");
      } catch (error) {
        let errorMessage = "❌ Failed to send password reset email.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "❌ No account found with that email.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "❌ Please enter a valid email address.";
        } else {
          errorMessage += ` Error: ${error.message}`;
        }
        await showCustomModal("Password Recovery Failed", errorMessage);
        console.error("Password recovery error:", error);
      } finally {
        setButtonLoading(recoverBtn, false);
        hideLoading(); // Hide loading overlay after recovery attempt
      }
    }

    // --- Dashboard Specific Functions ---
    // Logout function
    window.confirmLogout = async function() {
      const response = await confirm("Are you sure you want to log out?");
      if (response) {
        try {
          loadingText.innerText = "Logging out...";
          loadingOverlay.classList.remove('hidden'); // Show loading overlay for logout
          await signOut(auth);
          // onAuthStateChanged will handle UI update and show login form
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error logging out. Please try again.");
          loadingOverlay.classList.add('hidden'); // Ensure hidden on error
        }
      }
    };
    window.toggleSubmenu = function(id) {
      const submenu = document.getElementById(id);
      if (submenu) submenu.classList.toggle('hidden');
      // Rotate chevron icon for indicating expanded/collapsed state (optional)
      const chevron = submenu.previousElementSibling.querySelector('.fa-chevron-down');
      if (chevron) {
        chevron.classList.toggle('rotate-180');
      }
    };
    document.getElementById('menuToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.toggle('-translate-x-full');
    });

    function generateBreadcrumb(currentSectionTitle) {
      return `<div class="text-sm text-gray-600 mb-6">
        <a onclick="showDashboardSection('home')" class="text-green-700 hover:underline cursor-pointer">Home</a>
        <span class="mx-2">/</span>
        <span class="font-semibold text-green-800">${currentSectionTitle}</span>
      </div>`;
    }

    // Helper to generate a "No data available" row for tables
    function generateNoDataRow(colSpan, message = "No data available.") {
        return `<tr class="no-data-row"><td colspan="${colSpan}" class="py-3 px-6">${message}</td></tr>`;
    }

    // New: Calculate GPA
    function calculateGPA(grades) {
        let totalPoints = 0;
        let totalUnits = 0;
        const gradeMap = { 'A': 4.0, 'B': 3.0, 'C': 2.0, 'D': 1.0, 'F': 0.0 };

        grades.forEach(g => {
            const courseUnit = g.courseUnit || 3; // Default to 3 if not specified
            const gradePoint = gradeMap[g.grade] || 0;
            totalPoints += gradePoint * courseUnit;
            totalUnits += courseUnit;
        });

        return totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : "0.00";
    }

    // New: Load Home Dashboard Data
    async function loadHomeDashboard() {
        showLoading("Loading dashboard summary...");
        const content = document.getElementById("dashboardContent");
        try {
            // Fetch student profile info
            const studentDocRef = doc(db, `students`, currentUserId);
            const studentDocSnap = await getDoc(studentDocRef);
            // Default profile for empty state
            const studentProfile = studentDocSnap.exists() ? studentDocSnap.data() : {
                name: "Student", // Default name
                regNo: "N/A",
                programme: "N/A",
                profilePhotoURL: 'https://placehold.co/100x100/e0e0e0/333333?text=Avatar' // Default avatar
            };

            // Fetch latest 3 announcements
            const announcementsRef = collection(db, `announcements`);
            const announcementsQuery = query(announcementsRef, orderBy("date", "desc"), limit(3));
            const announcementsSnapshot = await getDocs(announcementsQuery);
            const announcements = announcementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Fetch fees data to get outstanding balance
            const feesDocRef = doc(db, `fees`, currentUserId);
            const feesSnapshot = await getDoc(feesDocRef);
            const feesData = feesSnapshot.exists() ? feesSnapshot.data() : { totalFees: 0, payments: [] };
            const totalPayments = feesData.payments.reduce((sum, p) => sum + p.amount, 0);
            const outstandingBalance = (feesData.totalFees || 0) - totalPayments; // Ensure totalFees defaults to 0 if not present

            // Fetch grades for GPA
            const gradesRef = collection(db, `grades`);
            const gradesQuery = query(gradesRef, where("studentId", "==", currentUserId));
            const gradesSnapshot = await getDocs(gradesQuery);
            const grades = gradesSnapshot.docs.map(doc => doc.data());
            const gpa = calculateGPA(grades);
            const latestGrade = grades.length > 0 ? grades.sort((a,b) => new Date(b.date) - new Date(a.date))[0] : null;

            // Fetch registrations to find next upcoming course/registration
            const registrationsRef = collection(db, `registrations`);
            const registrationsQuery = query(registrationsRef, where("studentId", "==", currentUserId));
            const registrationsSnapshot = await getDocs(registrationsQuery);
            const registrationsData = registrationsSnapshot.docs.map(doc => doc.data().courses || []).flat();

            let nextUpcomingCourse = `
                <p class="text-xl font-bold text-gray-800">No upcoming classes.</p>
                <p class="text-gray-600 text-sm mt-2">Time to register for new courses!</p>
                <button onclick="showDashboardSection('registrations')" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                    Register for Courses
                </button>
            `;
            const now = new Date();
            const futureRegistrations = registrationsData.filter(reg => new Date(reg.registrationDeadline) > now);
            if (futureRegistrations.length > 0) {
                futureRegistrations.sort((a,b) => new Date(a.registrationDeadline) - new Date(b.registrationDeadline));
                const nextReg = futureRegistrations[0];
                nextUpcomingCourse = `
                    <p class="text-xl font-bold text-gray-800">${nextReg.courseName} (${nextReg.courseCode})</p>
                    <p class="text-gray-600 text-sm mt-2">Registration Deadline: ${new Date(nextReg.registrationDeadline).toLocaleDateString()}</p>
                `;
            }

            const balanceColorClass = outstandingBalance > 0 ? 'text-red-600' : 'text-green-600';
            const balanceText = `GHS ${outstandingBalance.toFixed(2)}`;
            const latestGradeHtml = latestGrade ? `Your latest grade is a **${latestGrade.grade}** in **${latestGrade.courseName || latestGrade.courseCode}**. ` : 'No grades recorded yet.';

            let announcementsHtml = `<p class="text-gray-600 text-center py-4">No new announcements at this time. Check back later for updates!</p>`;
            if (announcements.length > 0) {
                announcementsHtml = `<ul class="space-y-3">${announcements.map(ann => `
                    <li class="pb-2 border-b border-green-100 last:border-b-0">
                        <p class="text-sm text-gray-500">${new Date(ann.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p class="font-medium text-green-800">${ann.title}</p>
                        <p class="text-gray-700">${ann.message}</p>
                    </li>
                `).join('')}</ul>`;
            }

            const gpaCircleClass = parseFloat(gpa) === 0.00 ? 'gpa-circle-progress no-gpa' : 'gpa-circle-progress';
            const gpaTextClass = parseFloat(gpa) === 0.00 ? 'gpa-text no-gpa' : 'gpa-text';


            const homeContentHtml = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row items-center">
                    <img src="${studentProfile.profilePhotoURL}" alt="Profile" class="w-24 h-24 rounded-full object-cover mr-4 mb-4 md:mb-0 border-4 border-green-200">
                    <div>
                        <h2 class="text-3xl font-extrabold text-green-800 mb-2">Welcome, ${studentProfile.name}!</h2>
                        <p class="text-gray-700 text-lg">Reg No: <span class="font-semibold">${studentProfile.regNo}</span> | Programme: <span class="font-semibold">${studentProfile.programme}</span></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">Current GPA</h3>
                        <div class="gpa-circle-container">
                            <svg class="gpa-circle-svg" width="120" height="120">
                                <circle class="gpa-circle-bg" r="50" cx="60" cy="60"></circle>
                                <circle class="${gpaCircleClass}" r="50" cx="60" cy="60" style="stroke-dasharray: ${(parseFloat(gpa) / 4) * (2 * Math.PI * 50)};"></circle>
                            </svg>
                            <span class="${gpaTextClass}">${gpa}</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-2">${latestGradeHtml}</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">Outstanding Fees</h3>
                        <div class="my-6">
                            <i class="fas fa-money-bill-wave text-5xl ${balanceColorClass}"></i>
                        </div>
                        <p class="text-2xl font-bold ${balanceColorClass}">${balanceText}</p>
                        <p class="text-gray-600 text-sm mt-2">Check your fees statement for a full breakdown.</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg text-center flex flex-col items-center">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">Next Upcoming</h3>
                        <div class="my-6">
                            <i class="fas fa-calendar-alt text-5xl text-blue-600"></i>
                        </div>
                        ${nextUpcomingCourse}
                    </div>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h4 class="text-2xl font-semibold text-green-700 mb-4 flex items-center"><i class="fas fa-bullhorn mr-3"></i> Latest Announcements</h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 h-48 overflow-y-auto no-scrollbar">
                        ${announcementsHtml}
                    </div>
                </div>
            `;

            content.innerHTML = generateBreadcrumb('Dashboard Overview') + homeContentHtml;
        } catch (error) {
            console.error("Error loading home dashboard data:", error);
            // Even on error, render the basic structure with error message
            content.innerHTML = generateBreadcrumb('Dashboard Overview') + `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row items-center">
                    <img src="https://placehold.co/100x100/e0e0e0/333333?text=Error" alt="Profile" class="w-24 h-24 rounded-full object-cover mr-4 mb-4 md:mb-0 border-4 border-red-200">
                    <div>
                        <h2 class="text-3xl font-extrabold text-red-800 mb-2">Oops!</h2>
                        <p class="text-gray-700 text-lg">Failed to load dashboard data.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center"><p class="text-gray-500 py-4">Error loading GPA.</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center"><p class="text-gray-500 py-4">Error loading fees.</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center"><p class="text-gray-500 py-4">Error loading upcoming.</p></div>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h4 class="text-2xl font-semibold text-green-700 mb-4 flex items-center"><i class="fas fa-bullhorn mr-3"></i> Latest Announcements</h4>
                    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Error!</strong><span class="block sm:inline"> Could not load announcements.</span></div>
                </div>
            `;
            await showCustomModal("Error", "Failed to load dashboard data. Please try again later.");
        } finally {
            hideLoading();
        }
    }

    // New: Loaders for each section
    async function loadProfile() {
        showLoading("Loading personal profile...");
        const content = document.getElementById("dashboardContent");
        const profileDocRef = doc(db, `students`, currentUserId);
        try {
            const profileSnap = await getDoc(profileDocRef);
            // Default student data for empty state
            const studentData = profileSnap.exists() ? profileSnap.data() : {
                name: "New Student", email: "user@example.com", regNo: "N/A", programme: "Not Set Yet", campus: "Not Set Yet",
                dob: "", gender: "", address: "Not Set Yet", profilePhotoURL: 'https://placehold.co/100x100/eeeeee/333333?text=Avatar'
            };

            let profilePhotoURL = studentData.profilePhotoURL || 'https://placehold.co/100x100/eeeeee/333333?text=Avatar';

            const profileHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Personal Profile</h2>
                    <form id="profile-form" class="space-y-6">
                        <div class="flex flex-col items-center mb-6">
                            <img id="profile-photo-preview" src="${profilePhotoURL}" alt="Profile Photo" class="w-32 h-32 rounded-full object-cover border-4 border-green-300 shadow-md mb-4">
                            <input type="file" id="profile-photo-upload" accept="image/*" class="hidden">
                            <label for="profile-photo-upload" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer transition duration-300 ease-in-out">
                                <i class="fas fa-camera mr-2"></i>Upload Photo
                            </label>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="profile-name" class="block text-gray-700 font-semibold mb-2">Full Name</label>
                                <input type="text" id="profile-name" value="${studentData.name || 'Not set yet'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                            </div>
                            <div>
                                <label for="profile-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                                <input type="email" id="profile-email" value="${studentData.email || 'N/A'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            </div>
                            <div>
                                <label for="profile-regNo" class="block text-gray-700 font-semibold mb-2">Registration Number</label>
                                <input type="text" id="profile-regNo" value="${studentData.regNo || 'Not set yet'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="profile-programme" class="block text-gray-700 font-semibold mb-2">Program Of Study</label>
                                <input type="text" id="profile-programme" value="${studentData.programme || 'Not set yet'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="profile-campus" class="block text-gray-700 font-semibold mb-2">Campus</label>
                                <input type="text" id="profile-campus" value="${studentData.campus || 'Not set yet'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="profile-dob" class="block text-gray-700 font-semibold mb-2">Date of Birth</label>
                                <input type="date" id="profile-dob" value="${studentData.dob || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="profile-gender" class="block text-gray-700 font-semibold mb-2">Gender</label>
                                <select id="profile-gender" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">Select Gender</option>
                                    <option value="Male" ${studentData.gender === 'Male' ? 'selected' : ''}>Male</option>
                                    <option value="Female" ${studentData.gender === 'Female' ? 'selected' : ''}>Female</option>
                                    <option value="Other" ${studentData.gender === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="profile-address" class="block text-gray-700 font-semibold mb-2">Address</label>
                                <textarea id="profile-address" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">${studentData.address || 'Not set yet'}</textarea>
                            </div>
                        </div>
                        <button type="submit" id="save-profile-btn" class="mt-8 w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">
                            <i class="fas fa-save mr-2"></i>Save Profile
                        </button>
                    </form>
                </div>
            `;
            content.innerHTML = generateBreadcrumb('Personal Profile') + profileHtml;

            // Add event listeners after HTML is rendered
            document.getElementById('profile-photo-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                showLoading("Uploading photo...");
                try {
                    const storageRef = ref(storage, `profilePhotos/${currentUserId}/${file.name}`);
                    await uploadBytes(storageRef, file);
                    const photoURL = await getDownloadURL(storageRef);

                    await updateDoc(profileDocRef, { profilePhotoURL: photoURL });
                    document.getElementById('profile-photo-preview').src = photoURL;
                    await showCustomModal("Success", "Profile photo updated successfully!");
                } catch (error) {
                    console.error("Error uploading profile photo:", error);
                    await showCustomModal("Error", "Failed to upload profile photo.");
                } finally {
                    hideLoading();
                }
            });

            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('save-profile-btn');
                setButtonLoading(saveBtn, true);
                try {
                    await updateDoc(profileDocRef, {
                        name: document.getElementById('profile-name').value,
                        regNo: document.getElementById('profile-regNo').value,
                        programme: document.getElementById('profile-programme').value,
                        campus: document.getElementById('profile-campus').value,
                        dob: document.getElementById('profile-dob').value,
                        gender: document.getElementById('profile-gender').value,
                        address: document.getElementById('profile-address').value,
                    });
                    await showCustomModal("Success", "Profile updated successfully!");
                    // Update current user data in memory
                    currentUserData = (await getDoc(profileDocRef)).data();
                    document.getElementById("userName").innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
                    const userNameMobile = document.getElementById("userNameMobile");
                    if (userNameMobile) userNameMobile.innerText = currentUserData.name ? currentUserData.name.split(" ")[0] : "User";
                } catch (error) {
                    console.error("Error updating profile:", error);
                    await showCustomModal("Error", "Failed to update profile.");
                } finally {
                    setButtonLoading(saveBtn, false);
                }
            });

        } catch(e) {
            content.innerHTML = generateBreadcrumb('Personal Profile') + `<p class="text-center text-gray-500 py-8">Error loading profile data. Please try again.</p>`;
            await showCustomModal("Error", "Failed to load personal profile. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadCourses() {
        showLoading("Loading all courses...");
        const content = document.getElementById("dashboardContent");
        const coursesRef = collection(db, `courses`);
        try {
            const coursesSnapshot = await getDocs(coursesRef);
            let courses = coursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let courseTableRows = '';
            if (courses.length > 0) {
                // Sort courses by courseCode for better readability
                courses.sort((a, b) => a.courseCode.localeCompare(b.courseCode));
                courseTableRows = courses.map(course => `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6">${course.courseCode || 'N/A'}</td>
                        <td class="py-3 px-6">${course.courseName || 'N/A'}</td>
                        <td class="py-3 px-6 text-center">${course.creditHours || 'N/A'}</td>
                        <td class="py-3 px-6">${course.lecturer || 'N/A'}</td>
                        <td class="py-3 px-6">${course.schedule || 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                courseTableRows = generateNoDataRow(5, "No courses found at this time. Please check back later for course listings."); // 5 columns in the table
            }

            const coursesHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">All Available Courses</h2>
                    <div class="mb-4">
                        <input type="text" id="course-search" placeholder="Search by course code or name..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left">Course Code</th>
                                    <th class="py-3 px-6 text-left">Course Name</th>
                                    <th class="py-3 px-6 text-center">Credits</th>
                                    <th class="py-3 px-6 text-left">Lecturer</th>
                                    <th class="py-3 px-6 text-left">Schedule</th>
                                </tr>
                            </thead>
                            <tbody id="courses-table-body">
                                ${courseTableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            content.innerHTML = generateBreadcrumb('All Courses') + coursesHtml;

            // Add search functionality
            document.getElementById('course-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCourses = courses.filter(course =>
                    (course.courseCode || '').toLowerCase().includes(searchTerm) ||
                    (course.courseName || '').toLowerCase().includes(searchTerm) ||
                    (course.lecturer || '').toLowerCase().includes(searchTerm)
                );
                let filteredRows = '';
                if (filteredCourses.length > 0) {
                    filteredRows = filteredCourses.map(course => `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6">${course.courseCode || 'N/A'}</td>
                            <td class="py-3 px-6">${course.courseName || 'N/A'}</td>
                            <td class="py-3 px-6 text-center">${course.creditHours || 'N/A'}</td>
                            <td class="py-3 px-6">${course.lecturer || 'N/A'}</td>
                            <td class="py-3 px-6">${course.schedule || 'N/A'}</td>
                        </tr>
                    `).join('');
                } else {
                    filteredRows = generateNoDataRow(5, "No courses match your search criteria.");
                }
                document.getElementById('courses-table-body').innerHTML = filteredRows;
            });

        } catch(e) {
            console.error("Error loading courses:", e);
            content.innerHTML = generateBreadcrumb('All Courses') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">All Available Courses</h2>
                    <p class="text-center text-gray-500 py-8">Error loading courses data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load courses. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadRegistrations() {
        showLoading("Loading registered courses...");
        const content = document.getElementById("dashboardContent");
        const registrationsDocRef = doc(db, `registrations`, currentUserId); // Path: /registrations/{uid}

        try {
            const registrationsSnap = await getDoc(registrationsDocRef);
            const registeredCourses = registrationsSnap.exists() ? registrationsSnap.data().courses || [] : [];

            let registrationsTableRows = '';
            let registrationActionHtml = '';
            if (registeredCourses.length > 0) {
                // Sort by academicYear, then semester, then courseCode
                registeredCourses.sort((a, b) => {
                    if (a.academicYear !== b.academicYear) return (a.academicYear || '').localeCompare(b.academicYear || '');
                    if (a.semester !== b.semester) return (a.semester || '').localeCompare(b.semester || '');
                    return (a.courseCode || '').localeCompare(b.courseCode || '');
                });

                registrationsTableRows = registeredCourses.map(course => `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6">${course.academicYear || 'N/A'}</td>
                        <td class="py-3 px-6">${course.semester || 'N/A'}</td>
                        <td class="py-3 px-6">${course.courseCode || 'N/A'}</td>
                        <td class="py-3 px-6">${course.courseName || 'N/A'}</td>
                        <td class="py-3 px-6 text-center">${course.status || 'N/A'}</td>
                        <td class="py-3 px-6 text-center">${course.registrationDate ? new Date(course.registrationDate).toLocaleDateString() : 'N/A'}</td>
                    </tr>
                `).join('');
                 registrationActionHtml = `
                    <div class="text-center mt-6">
                        <button onclick="showDashboardSection('courses')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                            <i class="fas fa-plus-circle mr-2"></i>Add/Drop Courses
                        </button>
                    </div>
                `;
            } else {
                registrationsTableRows = generateNoDataRow(6, "No courses registered yet. Click the button below to start your registration!"); // 6 columns
                registrationActionHtml = `
                    <div class="text-center mt-6">
                        <button onclick="showDashboardSection('courses')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                            <i class="fas fa-plus-circle mr-2"></i>Register for Courses
                        </button>
                    </div>
                `;
            }

            const registrationsHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">My Course Registrations</h2>
                    <div class="overflow-x-auto">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left">Academic Year</th>
                                    <th class="py-3 px-6 text-left">Semester</th>
                                    <th class="py-3 px-6 text-left">Course Code</th>
                                    <th class="py-3 px-6 text-left">Course Name</th>
                                    <th class="py-3 px-6 text-center">Status</th>
                                    <th class="py-3 px-6 text-center">Registration Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${registrationsTableRows}
                            </tbody>
                        </table>
                    </div>
                    ${registrationActionHtml}
                </div>
            `;
            content.innerHTML = generateBreadcrumb('Course Registrations') + registrationsHtml;

        } catch(e) {
            console.error("Error loading registrations:", e);
            content.innerHTML = generateBreadcrumb('Course Registrations') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">My Course Registrations</h2>
                    <p class="text-center text-gray-500 py-8">Error loading registration data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load course registrations. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadFees() {
        showLoading("Loading fees statement...");
        const content = document.getElementById("dashboardContent");
        const feesDocRef = doc(db, `fees`, currentUserId); // Path: /fees/{uid}
        try {
            const feesSnap = await getDoc(feesDocRef);
            // Default to empty/zero values if no fees document exists
            const feesData = feesSnap.exists() ? feesSnap.data() : { totalFees: 0, payments: [] };
            // Ensure payments is an array, default to empty if not found
            const payments = Array.isArray(feesData.payments) ? feesData.payments : [];
            const totalPayments = payments.reduce((sum, p) => sum + p.amount, 0);
            const balance = (feesData.totalFees || 0) - totalPayments; 
            
            // Neutral color for 0 balance, red for positive, green for negative (credit)
            let balanceColorClass = 'text-gray-600';
            if (balance > 0) {
                balanceColorClass = 'text-red-600';
            } else if (balance < 0) {
                balanceColorClass = 'text-green-600';
            }

            let paymentHistoryRows = '';
            if (payments.length > 0) {
                // Sort payments by date descending
                payments.sort((a,b) => new Date(b.date) - new Date(a.date));
                paymentHistoryRows = payments.map(p => `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6">${p.date ? new Date(p.date).toLocaleDateString() : 'N/A'}</td>
                        <td class="py-3 px-6">${p.description || 'N/A'}</td>
                        <td class="py-3 px-6 text-right">GHS ${p.amount !== undefined ? p.amount.toFixed(2) : '0.00'}</td>
                        <td class="py-3 px-6 text-right">${p.transactionId || 'N/A'}</td>
                    </tr>`).join('');
            } else {
                paymentHistoryRows = generateNoDataRow(4, "No payment history available. Payments will appear here."); // 4 columns
            }

            const feesHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Fees Statement</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-8">
                        <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold text-blue-700">Total Fees Due</h4>
                            <p class="text-3xl font-bold text-blue-900 mt-2">GHS ${(feesData.totalFees || 0).toFixed(2)}</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold text-green-700">Total Payments</h4>
                            <p class="text-3xl font-bold text-green-900 mt-2">GHS ${totalPayments.toFixed(2)}</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                            <h4 class="text-lg font-semibold text-gray-700">Outstanding Balance</h4>
                            <p class="text-3xl font-bold ${balanceColorClass} mt-2">GHS ${balance.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex justify-end mb-6">
                        <button id="download-fees-pdf-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                            <i class="fas fa-download mr-2"></i>Download PDF Statement
                        </button>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-2xl font-semibold text-green-700 mb-4">Payment History</h3>
                        <div class="overflow-x-auto">
                            <table class="styled-table">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-6 text-left">Date</th>
                                        <th class="py-3 px-6 text-left">Description</th>
                                        <th class="py-3 px-6 text-right">Amount (GHS)</th>
                                        <th class="py-3 px-6 text-left">Transaction ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paymentHistoryRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            content.innerHTML = generateBreadcrumb('Fees Statement') + feesHtml;

            // PDF Download functionality
            document.getElementById('download-fees-pdf-btn').addEventListener('click', async () => {
                showLoading("Generating PDF...");
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Fetch student profile for PDF header
                    const studentDocRef = doc(db, `students`, currentUserId);
                    const studentDocSnap = await getDoc(studentDocRef);
                    const studentProfile = studentDocSnap.exists() ? studentDocSnap.data() : {};

                    doc.setFontSize(18);
                    doc.text("Fees Statement - Prince Alex Design University", 14, 20);
                    doc.setFontSize(12);
                    doc.text(`Student Name: ${studentProfile.name || 'N/A'}`, 14, 30);
                    doc.text(`Registration No: ${studentProfile.regNo || 'N/A'}`, 14, 37);
                    doc.text(`Email: ${studentProfile.email || 'N/A'}`, 14, 44);

                    doc.setFontSize(14);
                    doc.text("Summary:", 14, 60);
                    doc.setFontSize(12);
                    doc.text(`Total Fees Due: GHS ${(feesData.totalFees || 0).toFixed(2)}`, 14, 68);
                    doc.text(`Total Payments: GHS ${totalPayments.toFixed(2)}`, 14, 75);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Outstanding Balance: GHS ${balance.toFixed(2)}`, 14, 82);
                    doc.setFont("helvetica", "normal");


                    doc.setFontSize(14);
                    doc.text("Payment History:", 14, 98);

                    const tableColumn = ["Date", "Description", "Amount (GHS)", "Transaction ID"];
                    const tableRows = [];

                    payments.forEach(p => {
                        const rowData = [
                            p.date ? new Date(p.date).toLocaleDateString() : 'N/A',
                            p.description || 'N/A',
                            p.amount !== undefined ? p.amount.toFixed(2) : '0.00',
                            p.transactionId || 'N/A'
                        ];
                        tableRows.push(rowData);
                    });

                    // Add autoTable for payment history
                    doc.autoTable(tableColumn, tableRows, {
                        startY: 105,
                        headStyles: { fillColor: [52, 73, 94] },
                        footStyles: { fillColor: [52, 73, 94] },
                        alternateRowStyles: { fillColor: [240, 240, 240] },
                        styles: { font: 'Inter', fontSize: 10, cellPadding: 3 },
                        margin: { top: 10 },
                    });

                    doc.save(`Fees_Statement_${studentProfile.regNo || 'N/A'}.pdf`);
                    await showCustomModal("Success", "Fees statement downloaded!");
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    await showCustomModal("Error", "Failed to generate PDF statement.");
                } finally {
                    hideLoading();
                }
            });

        } catch(e) {
            console.error("Error loading fees data:", e);
            content.innerHTML = generateBreadcrumb('Fees Statement') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Fees Statement</h2>
                    <p class="text-center text-gray-500 py-8">Error loading fees data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load fees statement. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadGrades() {
        showLoading("Loading grades...");
        const content = document.getElementById("dashboardContent");
        const gradesRef = collection(db, `grades`); // Path: /grades
        try {
            const gradesQuery = query(gradesRef, where("studentId", "==", currentUserId));
            const gradesSnapshot = await getDocs(gradesQuery);
            const grades = gradesSnapshot.docs.map(doc => doc.data());

            let gradesTableRows = '';
            let gpa = "0.00";
            let latestGradeHtml = "No grades recorded yet.";

            if (grades.length > 0) {
                gpa = calculateGPA(grades);
                // Sort grades by academicYear, then semester, then courseCode
                grades.sort((a, b) => {
                    if (a.academicYear !== b.academicYear) return (a.academicYear || '').localeCompare(b.academicYear || '');
                    if (a.semester !== b.semester) return (a.semester || '').localeCompare(b.semester || '');
                    return (a.courseCode || '').localeCompare(b.courseCode || '');
                });

                gradesTableRows = grades.map(grade => `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6">${grade.academicYear || 'N/A'}</td>
                        <td class="py-3 px-6">${grade.semester || 'N/A'}</td>
                        <td class="py-3 px-6">${grade.courseCode || 'N/A'}</td>
                        <td class="py-3 px-6">${grade.courseName || 'N/A'}</td>
                        <td class="py-3 px-6 text-center">${grade.grade || 'N/A'}</td>
                        <td class="py-3 px-6 text-center">${grade.remarks || 'N/A'}</td>
                    </tr>
                `).join('');
                latestGradeHtml = `Your latest grade is a **${grades[0].grade || 'N/A'}** in **${grades[0].courseName || grades[0].courseCode || 'N/A'}**.`;
            } else {
                gradesTableRows = generateNoDataRow(6, "No grades available yet. Please check back after exams."); // 6 columns
            }

            const gpaCircleClass = parseFloat(gpa) === 0.00 ? 'gpa-circle-progress no-gpa' : 'gpa-circle-progress';
            const gpaTextClass = parseFloat(gpa) === 0.00 ? 'gpa-text no-gpa' : 'gpa-text';


            const gradesHtml = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">My Grades</h2>
                    <div class="flex flex-col items-center my-6">
                        <div class="bg-green-50 p-6 rounded-xl shadow-inner text-center w-64">
                            <h3 class="text-xl font-semibold text-green-800 mb-2">Overall GPA</h3>
                            <div class="gpa-circle-container">
                                <svg class="gpa-circle-svg" width="120" height="120">
                                    <circle class="gpa-circle-bg" r="50" cx="60" cy="60"></circle>
                                    <circle class="${gpaCircleClass}" r="50" cx="60" cy="60" style="stroke-dasharray: ${(parseFloat(gpa) / 4) * (2 * Math.PI * 50)};"></circle>
                                </svg>
                                <span class="${gpaTextClass}">${gpa}</span>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mt-4 text-center">${latestGradeHtml}</p>
                    </div>
                    <div class="overflow-x-auto mt-8">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left">Academic Year</th>
                                    <th class="py-3 px-6 text-left">Semester</th>
                                    <th class="py-3 px-6 text-left">Course Code</th>
                                    <th class="py-3 px-6 text-left">Course Name</th>
                                    <th class="py-3 px-6 text-center">Grade</th>
                                    <th class="py-3 px-6 text-center">Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${gradesTableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            content.innerHTML = generateBreadcrumb('My Grades') + gradesHtml;
        } catch(e) {
            console.error("Error loading grades:", e);
            content.innerHTML = generateBreadcrumb('My Grades') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">My Grades</h2>
                    <p class="text-center text-gray-500 py-8">Error loading grades data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load grades. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadHostels() {
        showLoading("Loading hostel information...");
        const content = document.getElementById("dashboardContent");
        const hostelsRef = collection(db, `hostels`); // Path: /hostels
        const settingsDocRef = doc(db, `settings`, `hostelApplications`); // Path: /settings/hostelApplications
        try {
            const hostelsSnapshot = await getDocs(hostelsRef);
            const hostels = hostelsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const settingsSnap = await getDoc(settingsDocRef);
            const hostelApplicationsOpen = settingsSnap.exists() && settingsSnap.data().open === true;

            let hostelsHtml = '';
            if (hostels.length > 0) {
                hostelsHtml = hostels.map(hostel => `
                    <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col items-center text-center">
                        <img src="${hostel.imageUrl || 'https://placehold.co/200x150/e0e0e0/333333?text=Hostel'}" alt="${hostel.name || 'Hostel'}" class="w-full h-40 object-cover rounded-lg mb-4">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">${hostel.name || 'Unknown Hostel'}</h3>
                        <p class="text-gray-700 mb-2">${hostel.location || 'N/A'}</p>
                        <div class="flex justify-between items-center w-full mb-4">
                            <span class="text-md font-medium text-gray-600">Capacity: ${hostel.capacity !== undefined ? hostel.capacity : 'N/A'}</span>
                            <span class="text-md font-bold ${hostel.availableSpaces > 0 ? 'text-green-600' : 'text-red-600'}">Available: ${hostel.availableSpaces !== undefined ? hostel.availableSpaces : 'N/A'}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-4">Price: GHS ${hostel.price !== undefined ? hostel.price.toFixed(2) : 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-4">${hostel.description || 'No description available.'}</p>
                        <button onclick="applyForHostel('${hostel.id}', '${hostel.name || 'Unknown Hostel'}')" ${hostel.availableSpaces <= 0 || !hostelApplicationsOpen ? 'disabled' : ''} class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm ${hostel.availableSpaces <= 0 || !hostelApplicationsOpen ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i class="fas fa-bed mr-2"></i>${hostelApplicationsOpen ? 'Apply Now' : 'Applications Closed'}
                        </button>
                    </div>
                `).join('');
                hostelsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${hostelsHtml}</div>`;
            } else {
                hostelsHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center col-span-full">
                        <h3 class="text-xl font-semibold text-green-800 mb-2">No Hostel Availability Data</h3>
                        <p class="text-gray-700 py-4">It looks like there is no information about hostels available right now.</p>
                        <p class="text-gray-600 text-sm mb-4">Please check back later, or contact administration for more details.</p>
                        <button onclick="showCustomModal('Info', 'For inquiries, please contact the Accommodation Office.');" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                            <i class="fas fa-info-circle mr-2"></i>Contact Info
                        </button>
                    </div>
                `;
                 hostelsHtml = `<div class="grid grid-cols-1">${hostelsHtml}</div>`; // Wrap in grid for consistency
            }

            content.innerHTML = generateBreadcrumb('Accommodation') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Hostel Accommodation</h2>
                    ${hostelApplicationsOpen ? `
                        <p class="text-green-700 font-medium mb-4 text-center"><i class="fas fa-check-circle mr-2"></i>Hostel applications are currently OPEN!</p>
                    ` : `
                        <p class="text-red-700 font-medium mb-4 text-center"><i class="fas fa-times-circle mr-2"></i>Hostel applications are currently CLOSED.</p>
                    `}
                    ${hostelsHtml}
                </div>
            `;

            window.applyForHostel = async (hostelId, hostelName) => {
                const confirmed = await showCustomModal("Confirm Application", `Are you sure you want to apply for ${hostelName}?`, true);
                if (confirmed) {
                    showLoading(`Applying for ${hostelName}...`);
                    try {
                        const applicationRef = collection(db, `hostelApplications`); // New collection for applications
                        await addDoc(applicationRef, {
                            studentId: currentUserId,
                            studentName: currentUserData.name || 'N/A', // Ensure student name is provided
                            hostelId: hostelId,
                            hostelName: hostelName,
                            applicationDate: new Date().toISOString(),
                            status: "Pending" // Initial status
                        });
                        await showCustomModal("Application Submitted", `Your application for ${hostelName} has been submitted successfully! We will notify you of the status.`);
                    } catch (error) {
                        console.error("Error applying for hostel:", error);
                        await showCustomModal("Error", "Failed to submit hostel application. Please try again.");
                    } finally {
                        hideLoading();
                        // Re-load hostels to update available spaces if necessary (requires server-side rule to decrement)
                        loadHostels();
                    }
                }
            };

        } catch(e) {
            console.error("Error loading hostels:", e);
            content.innerHTML = generateBreadcrumb('Accommodation') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Hostel Accommodation</h2>
                    <p class="text-center text-gray-500 py-8">Error loading hostel data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load hostel information. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadAnnouncements() {
        showLoading("Loading announcements...");
        const content = document.getElementById("dashboardContent");
        const announcementsRef = collection(db, `announcements`); // Path: /announcements
        try {
            const announcementsQuery = query(announcementsRef, orderBy("date", "desc"));
            const announcementsSnapshot = await getDocs(announcementsQuery);
            const announcements = announcementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let announcementsListHtml = '';
            if (announcements.length > 0) {
                announcementsListHtml = `<ul class="space-y-4">`;
                announcementsListHtml += announcements.map(ann => `
                    <li class="bg-green-50 p-4 rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-semibold text-green-800">${ann.title || 'No Title'}</h3>
                            <span class="text-sm text-gray-500">${ann.date ? new Date(ann.date).toLocaleDateString() : 'N/A'}</span>
                        </div>
                        <p class="text-gray-700">${ann.message || 'No message content.'}</p>
                        ${ann.detailsLink ? `<a href="${ann.detailsLink}" target="_blank" class="text-blue-600 hover:underline mt-2 inline-block">Read More <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>` : ''}
                    </li>
                `).join('');
                announcementsListHtml += `</ul>`;
            } else {
                announcementsListHtml = `
                    <div class="text-center bg-gray-50 p-6 rounded-lg shadow-inner">
                        <p class="text-gray-700 py-8">No announcements available at this time. Check back later for university updates!</p>
                    </div>
                `;
            }

            content.innerHTML = generateBreadcrumb('Announcements') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">University Announcements</h2>
                    ${announcementsListHtml}
                </div>
            `;
        } catch(e) {
            console.error("Error loading announcements:", e);
            content.innerHTML = generateBreadcrumb('Announcements') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">University Announcements</h2>
                    <p class="text-center text-gray-500 py-8">Error loading announcements data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load announcements. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadGraduationRequest() {
        showLoading("Loading graduation requests...");
        const content = document.getElementById("dashboardContent");
        const graduationRequestDocRef = doc(db, `graduationRequests`, currentUserId); // Path: /graduationRequests/{uid}

        try {
            const gradSnap = await getDoc(graduationRequestDocRef);
            const requestData = gradSnap.exists() ? gradSnap.data() : null;

            let statusHtml = '';
            let formHtml = '';
            let requestTableRows = '';

            if (requestData) {
                let statusColorClass = 'text-gray-700';
                if (requestData.status === 'Pending') statusColorClass = 'text-yellow-600';
                else if (requestData.status === 'Approved') statusColorClass = 'text-green-600';
                else if (requestData.status === 'Denied') statusColorClass = 'text-red-600';

                // Display single request in a table-like format for consistency
                requestTableRows = `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6">${requestData.academicYear || 'N/A'}</td>
                        <td class="py-3 px-6">${requestData.program || 'N/A'}</td>
                        <td class="py-3 px-6 text-center"><span class="font-bold ${statusColorClass}">${requestData.status || 'N/A'}</span></td>
                        <td class="py-3 px-6">${requestData.submissionDate ? new Date(requestData.submissionDate).toLocaleDateString() : 'N/A'}</td>
                        <td class="py-3 px-6">${requestData.notes || 'No notes.'}</td>
                    </tr>
                `;
                formHtml = `<p class="text-center text-gray-600 mt-4">You have an active graduation request. Only one request is allowed at a time.</p>`;
            } else {
                requestTableRows = generateNoDataRow(5, "No graduation requests submitted yet.");
                formHtml = `
                    <form id="graduation-request-form" class="space-y-6 mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-xl font-semibold text-blue-800 mb-4">Submit New Request</h3>
                        <p class="text-gray-700 mb-4">Please fill out the form below to submit your graduation request. Ensure all academic and financial requirements are met before submission.</p>
                        <div>
                            <label for="grad-academic-year" class="block text-gray-700 font-semibold mb-2">Academic Year of Graduation</label>
                            <input type="text" id="grad-academic-year" placeholder="e.g., 2024/2025" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div>
                            <label for="grad-program" class="block text-gray-700 font-semibold mb-2">Program of Study</label>
                            <input type="text" id="grad-program" value="${currentUserData.programme || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div>
                            <label for="grad-notes" class="block text-gray-700 font-semibold mb-2">Additional Notes (Optional)</label>
                            <textarea id="grad-notes" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Any specific requests or information..."></textarea>
                        </div>
                        <button type="submit" id="submit-grad-request-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">
                            <i class="fas fa-paper-plane mr-2"></i>Submit Request
                        </button>
                    </form>
                `;
            }

            content.innerHTML = generateBreadcrumb('Graduation Request') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Graduation Request</h2>
                     <h3 class="text-2xl font-semibold text-green-700 mb-4">Request History</h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-left">Academic Year</th>
                                    <th class="py-3 px-6 text-left">Program</th>
                                    <th class="py-3 px-6 text-center">Status</th>
                                    <th class="py-3 px-6 text-left">Submitted On</th>
                                    <th class="py-3 px-6 text-left">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${requestTableRows}
                            </tbody>
                        </table>
                    </div>
                    ${formHtml}
                </div>
            `;

            if (!requestData) { // Only attach listener if form is visible
                document.getElementById('graduation-request-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = document.getElementById('submit-grad-request-btn');
                    setButtonLoading(submitBtn, true);
                    try {
                        await setDoc(graduationRequestDocRef, { // Using setDoc to create/overwrite
                            studentId: currentUserId,
                            academicYear: document.getElementById('grad-academic-year').value,
                            program: document.getElementById('grad-program').value,
                            notes: document.getElementById('grad-notes').value,
                            submissionDate: new Date().toISOString(),
                            status: 'Pending'
                        });
                        await showCustomModal("Request Submitted", "Your graduation request has been submitted successfully!");
                        loadGraduationRequest(); // Re-load section to show status
                    } catch (error) {
                        console.error("Error submitting graduation request:", error);
                        await showCustomModal("Error", "Failed to submit graduation request. Please try again.");
                    } finally {
                        setButtonLoading(submitBtn, false);
                    }
                });
            }
        } catch(e) {
            console.error("Error loading graduation requests:", e);
            content.innerHTML = generateBreadcrumb('Graduation Request') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Graduation Request</h2>
                    <p class="text-center text-gray-500 py-8">Error loading graduation requests data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load graduation requests. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadClearanceRequest() {
        showLoading("Loading clearance requests...");
        const content = document.getElementById("dashboardContent");
        const clearanceRequestDocRef = doc(db, `clearanceRequests`, currentUserId); // Path: /clearanceRequests/{uid}

        try {
            const clearanceSnap = await getDoc(clearanceRequestDocRef);
            const requestData = clearanceSnap.exists() ? clearanceSnap.data() : null;

            let statusHtml = '';
            let formHtml = '';
            let requestTableRows = '';

            if (requestData) {
                let statusColorClass = 'text-gray-700';
                if (requestData.status === 'Pending') statusColorClass = 'text-yellow-600';
                else if (requestData.status === 'Approved') statusColorClass = 'text-green-600';
                else if (requestData.status === 'Denied') statusColorClass = 'text-red-600';

                requestTableRows = `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-center"><span class="font-bold ${statusColorClass}">${requestData.status || 'N/A'}</span></td>
                        <td class="py-3 px-6">${requestData.submissionDate ? new Date(requestData.submissionDate).toLocaleDateString() : 'N/A'}</td>
                        <td class="py-3 px-6">${requestData.documentURL ? `<a href="${requestData.documentURL}" target="_blank" class="text-blue-600 hover:underline">View Document <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>` : 'N/A'}</td>
                        <td class="py-3 px-6">${requestData.notes || 'No notes.'}</td>
                    </tr>
                `;
                formHtml = `<p class="text-center text-gray-600 mt-4">You have an active clearance request. Only one request is allowed at a time.</p>`;
            } else {
                requestTableRows = generateNoDataRow(4, "No clearance requests submitted yet.");
                formHtml = `
                    <form id="clearance-request-form" class="space-y-6 mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-xl font-semibold text-blue-800 mb-4">Submit New Request</h3>
                        <p class="text-gray-700 mb-4">To apply for clearance, please upload any required documents (e.g., completed clearance form) and provide any relevant notes.</p>
                        <div>
                            <label for="clearance-document-upload" class="block text-gray-700 font-semibold mb-2">Upload Clearance Document (PDF only)</label>
                            <input type="file" id="clearance-document-upload" accept=".pdf" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <p id="clearance-document-name" class="text-sm text-gray-500 mt-2">No file chosen.</p>
                        </div>
                        <div>
                            <label for="clearance-notes" class="block text-gray-700 font-semibold mb-2">Additional Notes (Optional)</label>
                            <textarea id="clearance-notes" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Any specific requests or information..."></textarea>
                        </div>
                        <button type="submit" id="submit-clearance-request-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">
                            <i class="fas fa-upload mr-2"></i>Submit Request
                        </button>
                    </form>
                `;
            }

            content.innerHTML = generateBreadcrumb('Clearance Request') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Clearance Request</h2>
                     <h3 class="text-2xl font-semibold text-green-700 mb-4">Request History</h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-center">Status</th>
                                    <th class="py-3 px-6 text-left">Submitted On</th>
                                    <th class="py-3 px-6 text-left">Document</th>
                                    <th class="py-3 px-6 text-left">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${requestTableRows}
                            </tbody>
                        </table>
                    </div>
                    ${formHtml}
                </div>
            `;

            if (!requestData) { // Only attach listener if form is visible
                let uploadedFile = null;
                document.getElementById('clearance-document-upload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type === 'application/pdf') {
                        uploadedFile = file;
                        document.getElementById('clearance-document-name').innerText = `Selected: ${file.name}`;
                    } else {
                        uploadedFile = null;
                        document.getElementById('clearance-document-name').innerText = `No file chosen. (Please select a PDF)`;
                        showCustomModal("Invalid File Type", "Please upload a PDF document for clearance.");
                    }
                });

                document.getElementById('clearance-request-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = document.getElementById('submit-clearance-request-btn');
                    setButtonLoading(submitBtn, true);

                    let documentURL = '';
                    if (uploadedFile) {
                        showLoading("Uploading document...");
                        try {
                            const storageRef = ref(storage, `clearanceDocuments/${currentUserId}/${uploadedFile.name}`);
                            await uploadBytes(storageRef, uploadedFile);
                            documentURL = await getDownloadURL(storageRef);
                        } catch (uploadError) {
                            console.error("Error uploading clearance document:", uploadError);
                            await showCustomModal("Upload Failed", "Failed to upload clearance document. Please try again.");
                            setButtonLoading(submitBtn, false);
                            return;
                        }
                    }

                    showLoading("Submitting request...");
                    try {
                        await setDoc(clearanceRequestDocRef, { // Using setDoc to create/overwrite
                            studentId: currentUserId,
                            documentURL: documentURL,
                            notes: document.getElementById('clearance-notes').value,
                            submissionDate: new Date().toISOString(),
                            status: 'Pending'
                        });
                        await showCustomModal("Request Submitted", "Your clearance request has been submitted successfully!");
                        loadClearanceRequest(); // Re-load section to show status
                    } catch (error) {
                        console.error("Error submitting clearance request:", error);
                        await showCustomModal("Error", "Failed to submit clearance request. Please try again.");
                    } finally {
                        setButtonLoading(submitBtn, false);
                    }
                });
            }
        } catch(e) {
            console.error("Error loading clearance requests:", e);
            content.innerHTML = generateBreadcrumb('Clearance Request') + `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Clearance Request</h2>
                    <p class="text-center text-gray-500 py-8">Error loading clearance requests data. Please try again.</p>
                </div>
            `;
            await showCustomModal("Error", "Failed to load clearance requests. Please try again.");
        } finally {
            hideLoading();
        }
    }

    async function loadTranscripts() {
        showLoading("Loading transcripts...");
        const content = document.getElementById("dashboardContent");
        // For now, this is a placeholder. In a real app, you would fetch transcript data.
        content.innerHTML = generateBreadcrumb('Transcripts') + `
            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                <h2 class="text-3xl font-bold text-green-800 mb-6">Academic Transcripts</h2>
                <p class="text-gray-700 py-8">Your academic transcripts are not yet available online. Please contact the academic registrar's office for assistance.</p>
                <button onclick="showCustomModal('Contact Info', 'Academic Registrar Office: registrar@university.edu');" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                    <i class="fas fa-envelope mr-2"></i>Contact Registrar
                </button>
            </div>
        `;
        hideLoading();
    }


    function showLoading(text) {
        loadingText.innerText = text;
        loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
        loadingOverlay.classList.add('hidden');
    }

    // Main navigation handler
    async function showDashboardSection(section) {
      // Hide mobile sidebar on selection
      sidebar.classList.add('-translate-x-full');

      if (!currentUserId) {
        console.log("currentUserId is null. Redirecting to login from showDashboardSection.");
        authContainer.classList.remove('hidden');
        dashboardContainer.classList.add('hidden');
        showForm('login');
        return;
      }

      const content = document.getElementById("dashboardContent");
      content.innerHTML = ''; // Clear content
      
      switch (section) {
        case 'home':
          await loadHomeDashboard();
          break;
        case 'profile':
          await loadProfile();
          break;
        case 'courses': // New case for 'All Courses'
          await loadCourses();
          break;
        case 'registrations': // New case for 'Course Registration' (My Registrations)
          await loadRegistrations();
          break;
        case 'fees': // Renamed from feesStatement
          await loadFees();
          break;
        case 'grades': // New case for 'Grades'
          await loadGrades();
          break;
        case 'hostels': // Renamed from hostelBooking
          await loadHostels();
          break;
        case 'announcements': // New case for 'Announcements'
          await loadAnnouncements();
          break;
        case 'graduation':
          await loadGraduationRequest();
          break;
        case 'clearance':
          await loadClearanceRequest();
          break;
        case 'timetable':
            showLoading("Loading timetable...");
            content.innerHTML = generateBreadcrumb('Timetable') + `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Academic Timetable</h2>
                    <p class="text-gray-700 py-8">The academic timetable is currently being finalized. Please check back closer to the semester start date.</p>
                    <button onclick="showCustomModal('Info', 'Timetable updates will be posted on the announcements board.');" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                        <i class="fas fa-calendar-check mr-2"></i>View Announcements
                    </button>
                </div>
            `;
            hideLoading();
            break;
        case 'evaluation':
            showLoading("Loading course evaluation...");
            content.innerHTML = generateBreadcrumb('Course Evaluation') + `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Course Evaluation</h2>
                    <p class="text-gray-700 py-8">Course evaluations are not open at this time. They usually become available towards the end of the semester.</p>
                </div>
            `;
            hideLoading();
            break;
        case 'receipts':
            showLoading("Loading receipts...");
            content.innerHTML = generateBreadcrumb('Receipts') + `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Payment Receipts</h2>
                    <p class="text-gray-700 py-8">No official receipts are available online at this moment. You can always refer to your <a href="#" onclick="showDashboardSection('fees')" class="text-blue-600 hover:underline">Fees Statement</a> for payment records.</p>
                </div>
            `;
            hideLoading();
            break;
        case 'examCard':
            showLoading("Loading exam card...");
            content.innerHTML = generateBreadcrumb('Exam Card') + `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Exam Card</h2>
                    <p class="text-gray-700 py-8">Your exam card will be generated once all your fees are cleared and your course registration is confirmed.</p>
                    <button onclick="showDashboardSection('fees')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm">
                        <i class="fas fa-money-bill-wave mr-2"></i>Check Fees Statement
                    </button>
                </div>
            `;
            hideLoading();
            break;
        case 'examTimetable':
            showLoading("Loading exam timetable...");
            content.innerHTML = generateBreadcrumb('Exam Timetable') + `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Examination Timetable</h2>
                    <p class="text-gray-700 py-8">The examination timetable has not been released yet. Please check back closer to the examination period.</p>
                </div>
            `;
            hideLoading();
            break;
        case 'transcripts':
          await loadTranscripts(); // Calls the dedicated loadTranscripts function
          break;
        case 'settings':
            showLoading("Loading settings...");
            content.innerHTML = generateBreadcrumb('Settings') + `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-6">Settings</h2>
                    <p class="text-gray-700 py-8">Settings options are under development. Check back later!</p>
                </div>
            `;
            hideLoading();
            break;
        default:
          showLoading(`Loading ${section.charAt(0).toUpperCase() + section.slice(1)}...`);
          content.innerHTML = generateBreadcrumb(section.charAt(0).toUpperCase() + section.slice(1)) + `<p class="text-center text-gray-500 py-8">Content for this section is coming soon.</p>`;
          hideLoading();
          break;
      }
    }

    // Existing functions that don't need changes but are included for completeness
    async function populateInitialData() {
        // This function can be modified to create initial data if it doesn't exist
        // or can be removed if all data is created during signup.
    }
    
    // Existing functions (evaluation, receipts, examCard, examTimetable, hostelBooking, settings)
    // can be updated similarly with dedicated load functions and data fetching logic.
    window.showDashboardSection = showDashboardSection; // Expose to the global scope
  </script>
</body>
</html>
