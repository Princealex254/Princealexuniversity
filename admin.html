<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Â· Prince Alex Design University</title>

  <!-- Tailwind and icons (same theme) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <!-- Firebase modular SDK (kept similar to student dashboard) -->
  <script type="module">
    // The admin page imports firebase modules inside the main script below.
  </script>

  <style>
    body { font-family: 'Roboto', sans-serif; background:#f8f9fa; }
    .btn-primary { background:#0d6efd; color:#fff; padding:0.5rem 0.9rem; border-radius:6px; }
    .btn-danger { background:#dc3545; color:#fff; padding:0.5rem 0.9rem; border-radius:6px; }
    .card { background:#fff; border-radius:8px; padding:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:1rem; }
    .sidebar a.active { background:#e6f0ff; color:#0d47a1; }
    .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.85); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .hidden { display:none; }
  </style>
</head>
<body class="min-h-screen flex">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-blue-600 border-gray-200"></div>
      <div class="mt-3 text-blue-700 font-semibold">Loading admin console...</div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r p-4 sidebar hidden md:block overflow-auto" id="sidebar">
    <div class="mb-6">
      <img src="myschoollogo.png" alt="logo" class="h-12" />
    </div>
    <nav class="space-y-1">
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="home"><i class="fas fa-tachometer-alt mr-2"></i> Dashboard</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="students"><i class="fas fa-user-graduate mr-2"></i> Students</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="courses"><i class="fas fa-book mr-2"></i> Courses</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="timetable"><i class="fas fa-calendar-alt mr-2"></i> Timetable</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="grades"><i class="fas fa-clipboard-list mr-2"></i> Grades</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="hostels"><i class="fas fa-hotel mr-2"></i> Hostels</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="finance"><i class="fas fa-money-bill-wave mr-2"></i> Finance</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="graduations"><i class="fas fa-graduation-cap mr-2"></i> Graduations</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="clearances"><i class="fas fa-check-circle mr-2"></i> Clearances</a>
      <a href="#" class="block p-2 rounded hover:bg-gray-100" data-section="announcements"><i class="fas fa-bullhorn mr-2"></i> Announcements</a>
    </nav>

    <div class="mt-6 border-t pt-4">
      <div class="text-sm text-gray-600">Signed in as</div>
      <div id="adminEmail" class="font-semibold text-blue-700"></div>
      <button id="adminLogout" class="mt-3 btn-danger w-full"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
    </div>
  </aside>

  <!-- Main content -->
  <div class="flex-1 p-6 overflow-auto">
    <!-- header for small screens -->
    <div class="md:hidden mb-4 flex items-center justify-between">
      <img src="myschoollogo.png" class="h-10" alt="logo"/>
      <div>
        <button id="mobileMenuBtn" class="btn-primary px-3 py-1">Menu</button>
      </div>
    </div>

    <!-- Sections container -->
    <div id="sections">

      <!-- Home / overview -->
      <section id="home" class="section card hidden">
        <h2 class="text-2xl font-bold mb-4">Admin Dashboard Overview</h2>
        <div id="adminStats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- stats cards populate here -->
        </div>
      </section>

      <!-- Students -->
      <section id="students" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Students</h2>
          <div class="flex gap-2">
            <button id="refreshStudents" class="btn-primary">Refresh</button>
          </div>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Add / Update Student</h3>
          <form id="studentForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="s_fullName" placeholder="Full name" class="border p-2 rounded" />
            <input id="s_email" placeholder="Email" class="border p-2 rounded" />
            <input id="s_phone" placeholder="Phone" class="border p-2 rounded" />
            <input id="s_admissionNo" placeholder="Admission No (optional)" class="border p-2 rounded" />
            <input id="s_program" placeholder="Program" class="border p-2 rounded" />
            <div class="flex gap-2">
              <select id="s_year" class="border p-2 rounded flex-1">
                <option value="">Year</option>
                <option>1</option><option>2</option><option>3</option><option>4</option>
              </select>
              <select id="s_semester" class="border p-2 rounded flex-1">
                <option value="">Semester</option>
                <option>1</option><option>2</option><option>3</option>
              </select>
            </div>
            <div class="md:col-span-3 flex gap-2">
              <button id="saveStudent" type="button" class="btn-primary">Save Student</button>
              <button id="deleteStudent" type="button" class="btn-danger">Delete Student</button>
              <div id="studentFormMsg" class="text-sm text-green-600 ml-2"></div>
            </div>
          </form>
        </div>

        <div class="card mt-4">
          <h3 class="font-semibold mb-2">All Students</h3>
          <div class="overflow-auto">
            <table class="w-full text-left border-collapse">
              <thead class="bg-gray-100">
                <tr>
                  <th class="p-2 border">Name</th>
                  <th class="p-2 border">Email</th>
                  <th class="p-2 border">Program</th>
                  <th class="p-2 border">Year</th>
                  <th class="p-2 border">Admission No</th>
                  <th class="p-2 border">Actions</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody">
                <!-- rows -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Courses -->
      <section id="courses" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Courses</h2>
          <div class="flex gap-2">
            <button id="refreshCourses" class="btn-primary">Refresh</button>
          </div>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Add Course</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
            <input id="c_code" placeholder="Course code (e.g., CSC101)" class="border p-2 rounded"/>
            <input id="c_title" placeholder="Course title" class="border p-2 rounded"/>
            <input id="c_credits" placeholder="Credits" class="border p-2 rounded" type="number"/>
            <div class="flex gap-2">
              <select id="c_year" class="border p-2 rounded">
                <option value="">Year</option><option>1</option><option>2</option><option>3</option><option>4</option>
              </select>
              <select id="c_semester" class="border p-2 rounded">
                <option value="">Semester</option><option>1</option><option>2</option><option>3</option>
              </select>
            </div>
            <input id="c_lecturer" placeholder="Lecturer" class="border p-2 rounded"/>
            <div class="md:col-span-4 flex gap-2">
              <button id="saveCourse" class="btn-primary">Save Course</button>
              <div id="courseFormMsg" class="text-sm text-green-600"></div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <h3 class="font-semibold mb-2">All Courses</h3>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-100">
                <tr><th class="p-2 border">Code</th><th class="p-2 border">Title</th><th class="p-2 border">Credits</th><th class="p-2 border">Year</th><th class="p-2 border">Semester</th><th class="p-2 border">Lecturer</th><th class="p-2 border">Actions</th></tr>
              </thead>
              <tbody id="coursesTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Timetable -->
      <section id="timetable" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Timetable</h2>
          <button id="refreshTimetable" class="btn-primary">Refresh</button>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Add Timetable Slot</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
            <select id="tt_course" class="border p-2 rounded"></select>
            <select id="tt_day" class="border p-2 rounded">
              <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option>
            </select>
            <input id="tt_time" placeholder="08:00-10:00" class="border p-2 rounded"/>
            <input id="tt_venue" placeholder="Venue (e.g., Hall A)" class="border p-2 rounded"/>
            <select id="tt_year" class="border p-2 rounded"><option value="">Year</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
            <select id="tt_semester" class="border p-2 rounded"><option value="">Semester</option><option>1</option><option>2</option><option>3</option></select>
            <div class="md:col-span-4 flex gap-2">
              <button id="saveTimetable" class="btn-primary">Save Slot</button>
              <div id="timetableMsg" class="text-sm text-green-600"></div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <h3 class="font-semibold mb-2">All Timetable Slots</h3>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-100">
                <tr><th class="p-2 border">Course</th><th class="p-2 border">Day</th><th class="p-2 border">Time</th><th class="p-2 border">Venue</th><th class="p-2 border">Year/Sem</th><th class="p-2 border">Action</th></tr>
              </thead>
              <tbody id="timetableTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Grades -->
      <section id="grades" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Grades</h2>
          <button id="refreshGrades" class="btn-primary">Refresh</button>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Enter / Update Grade</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <select id="g_selectStudent" class="border p-2 rounded"></select>
            <select id="g_selectCourse" class="border p-2 rounded"></select>
            <input id="g_grade" placeholder="Grade (e.g., A)" class="border p-2 rounded"/>
            <input id="g_points" placeholder="Grade Points (e.g., 12)" type="number" class="border p-2 rounded"/>
            <input id="g_credits" placeholder="Credits" type="number" class="border p-2 rounded"/>
            <div class="md:col-span-3 flex gap-2">
              <button id="saveGrade" class="btn-primary">Save Grade</button>
              <div id="gradeMsg" class="text-sm text-green-600"></div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <h3 class="font-semibold mb-2">Student Grades (select student)</h3>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-100"><tr><th class="p-2 border">Course</th><th class="p-2 border">Title</th><th class="p-2 border">Credits</th><th class="p-2 border">Grade</th><th class="p-2 border">Points</th></tr></thead>
              <tbody id="studentGradesTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Hostels -->
      <section id="hostels" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Hostels</h2>
          <button id="refreshHostels" class="btn-primary">Refresh</button>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Add Hostel</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <input id="h_name" placeholder="Hostel name" class="border p-2 rounded"/>
            <select id="h_type" class="border p-2 rounded"><option>Male</option><option>Female</option><option>Mixed</option></select>
            <input id="h_capacity" placeholder="Capacity (rooms)" type="number" class="border p-2 rounded"/>
            <input id="h_location" placeholder="Location" class="border p-2 rounded"/>
            <div class="md:col-span-3 flex gap-2">
              <button id="saveHostel" class="btn-primary">Save Hostel</button>
              <div id="hostelMsg" class="text-sm text-green-600"></div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <h3 class="font-semibold mb-2">Hostel List & Rooms</h3>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-100"><tr><th class="p-2 border">Hostel</th><th class="p-2 border">Type</th><th class="p-2 border">Capacity</th><th class="p-2 border">Available</th><th class="p-2 border">Actions</th></tr></thead>
              <tbody id="hostelsTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Finance -->
      <section id="finance" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Finance</h2>
          <button id="refreshFinance" class="btn-primary">Refresh</button>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Add Transaction for Student</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <select id="f_selectStudent" class="border p-2 rounded"></select>
            <input id="f_amount" placeholder="Amount" type="number" class="border p-2 rounded"/>
            <select id="f_type" class="border p-2 rounded"><option value="charge">Charge</option><option value="payment">Payment</option></select>
            <input id="f_description" placeholder="Description" class="border p-2 rounded md:col-span-2"/>
            <div class="md:col-span-3 flex gap-2">
              <button id="saveTransaction" class="btn-primary">Save Transaction</button>
              <div id="financeMsg" class="text-sm text-green-600"></div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <h3 class="font-semibold mb-2">Student Finance Snapshot</h3>
          <div id="financeSnapshot" class="overflow-auto"></div>
        </div>
      </section>

      <!-- Graduations -->
      <section id="graduations" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Graduation Requests</h2>
          <button id="refreshGraduations" class="btn-primary">Refresh</button>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Pending Requests</h3>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-100"><tr><th class="p-2 border">Student</th><th class="p-2 border">Program</th><th class="p-2 border">Submitted</th><th class="p-2 border">Approvals</th><th class="p-2 border">Action</th></tr></thead>
              <tbody id="graduationsTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Clearances -->
      <section id="clearances" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Clearance Requests</h2>
          <button id="refreshClearances" class="btn-primary">Refresh</button>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Pending Clearances</h3>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-100"><tr><th class="p-2 border">Student</th><th class="p-2 border">Submitted</th><th class="p-2 border">Approvals</th><th class="p-2 border">Action</th></tr></thead>
              <tbody id="clearancesTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Announcements -->
      <section id="announcements" class="section hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Announcements</h2>
          <button id="refreshAnnouncements" class="btn-primary">Refresh</button>
        </div>

        <div class="card">
          <h3 class="font-semibold mb-2">Create Announcement</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <input id="a_title" placeholder="Title" class="border p-2 rounded"/>
            <select id="a_category" class="border p-2 rounded"><option>Academics</option><option>Finance</option><option>Hostel</option><option>Events</option><option>General</option></select>
            <div class="flex items-center gap-2">
              <label class="flex items-center gap-2"><input id="a_pinned" type="checkbox"/> Pinned</label>
            </div>
            <textarea id="a_message" placeholder="Message" class="border p-2 rounded md:col-span-3"></textarea>
            <div class="md:col-span-3 flex gap-2">
              <button id="saveAnnouncement" class="btn-primary">Publish</button>
              <div id="announceMsg" class="text-sm text-green-600"></div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <h3 class="font-semibold mb-2">All Announcements</h3>
          <div class="overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-100"><tr><th class="p-2 border">Title</th><th class="p-2 border">Category</th><th class="p-2 border">Pinned</th><th class="p-2 border">Date</th><th class="p-2 border">Actions</th></tr></thead>
              <tbody id="announcementsTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div><!-- sections -->

  </div><!-- main content -->

  <!-- Mobile sidebar modal -->
  <div id="mobileSidebar" class="hidden fixed inset-0 bg-black bg-opacity-40 z-40">
    <div class="w-64 bg-white h-full p-4">
      <button id="mobileClose" class="mb-4 btn-danger">Close</button>
      <div id="mobileLinks"></div>
    </div>
  </div>

  <!-- Script: main admin logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Use same firebaseConfig as your student dashboard
    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI references
    const loadingOverlay = document.getElementById('loadingOverlay');
    const sidebar = document.getElementById('sidebar');
    const sections = document.querySelectorAll('.section');
    const adminEmail = document.getElementById('adminEmail');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobileClose = document.getElementById('mobileClose');
    const mobileLinks = document.getElementById('mobileLinks');

    // helpers
    function showSection(id) {
      sections.forEach(s => s.classList.add('hidden'));
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');

      // highlight sidebar link
      document.querySelectorAll('#sidebar a').forEach(a => {
        a.classList.toggle('active', a.dataset.section === id);
      });
      // on mobile close sidebar
      mobileSidebar.classList.add('hidden');
    }

    // wire sidebar clicks
    document.querySelectorAll('#sidebar a').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const sec = a.dataset.section;
        showSection(sec);
      });
    });

    // mobile menu wiring
    mobileMenuBtn?.addEventListener('click', () => {
      mobileSidebar.classList.remove('hidden');
      // populate links
      mobileLinks.innerHTML = document.querySelector('#sidebar nav').innerHTML;
      mobileLinks.querySelectorAll('a').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const sec = a.getAttribute('data-section');
          showSection(sec);
        });
      });
    });
    mobileClose?.addEventListener('click', () => mobileSidebar.classList.add('hidden'));

    // sign out
    document.getElementById('adminLogout').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    });

    // Wait for auth and check admin permission
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      try {
        // check admins collection
        const adminDocRef = doc(db, 'admins', user.uid);
        const adminSnap = await getDoc(adminDocRef);
        if (!adminSnap.exists() || !adminSnap.data().isAdmin) {
          // not admin
          alert('Access denied: Admin privileges are required.');
          await signOut(auth);
          window.location.href = 'login.html';
          return;
        }

        // show UI
        adminEmail.textContent = user.email;
        sidebar.classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.add('hidden');
        showSection('home');

        // initial loads
        loadAdminStats();
        loadStudents();
        loadCourses();
        loadTimetable();
        loadStudentsSelects(); // for selects in other sections
        loadHostels();
        loadAnnouncements();
        loadGraduations();
        loadClearances();

      } catch (err) {
        console.error('Admin auth check error', err);
        alert('Error verifying admin privileges: ' + err.message);
        await signOut(auth);
        window.location.href = 'login.html';
      }
    });

    /* --------------------------
       Dashboard / stats
       -------------------------- */
    async function loadAdminStats() {
      try {
        const studentsSnap = await getDocs(collection(db, 'students'));
        const studentsCount = studentsSnap.size;

        const gradSnap = await getDocs(query(collection(db, 'graduations'), where('overallStatus', '==', 'Pending')));
        const pendingGrad = gradSnap.size;

        const clearanceSnap = await getDocs(query(collection(db, 'clearances'), where('overallStatus', '==', 'Pending')));
        const pendingClear = clearanceSnap.size;

        // finance: count transactions
        const financeColl = collection(db, 'finance');
        const financeDocs = await getDocs(financeColl);
        // compute some simple totals
        let totalBalance = 0;
        // finance collection structure may vary; try to read per doc
        for (const fd of financeDocs.docs) {
          const d = fd.data();
          if (d.balance !== undefined) totalBalance += Number(d.balance) || 0;
        }

        const statsHtml = `
          <div class="card">
            <div class="text-sm text-gray-500">Students</div>
            <div class="text-2xl font-bold">${studentsCount}</div>
          </div>
          <div class="card">
            <div class="text-sm text-gray-500">Pending Graduations</div>
            <div class="text-2xl font-bold">${pendingGrad}</div>
          </div>
          <div class="card">
            <div class="text-sm text-gray-500">Pending Clearances</div>
            <div class="text-2xl font-bold">${pendingClear}</div>
          </div>
          <div class="card">
            <div class="text-sm text-gray-500">Total Outstanding (approx)</div>
            <div class="text-2xl font-bold">KES ${totalBalance.toLocaleString()}</div>
          </div>
        `;
        document.getElementById('adminStats').innerHTML = statsHtml;
      } catch (err) {
        console.error('loadAdminStats', err);
      }
    }

    /* --------------------------
       STUDENTS
       -------------------------- */
    async function loadStudents() {
      try {
        document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="6" class="p-4">Loading...</td></tr>';
        const snap = await getDocs(collection(db, 'students'));
        const rows = [];
        snap.forEach(docSnap => {
          const s = docSnap.data();
          rows.push({ id: docSnap.id, ...s });
        });
        if (rows.length === 0) {
          document.getElementById('studentsTableBody').innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No students found.</td></tr>';
          return;
        }
        const html = rows.map(s => `
          <tr class="border-b">
            <td class="p-2">${s.name || ''}</td>
            <td class="p-2">${s.email || ''}</td>
            <td class="p-2">${s.program || ''}</td>
            <td class="p-2">${s.year || ''}</td>
            <td class="p-2">${s.admissionNo || ''}</td>
            <td class="p-2">
              <button class="btn-primary text-sm" onclick="editStudent('${s.id}')">Edit</button>
            </td>
          </tr>
        `).join('');
        document.getElementById('studentsTableBody').innerHTML = html;
      } catch (err) {
        console.error('loadStudents', err);
        document.getElementById('studentsTableBody').innerHTML = `<tr><td colspan="6" class="p-4 text-red-600">Error loading students.</td></tr>`;
      }
    }

    window.editStudent = async (id) => {
      try {
        const docRef = doc(db, 'students', id);
        const snap = await getDoc(docRef);
        if (!snap.exists()) return alert('Student not found');
        const s = snap.data();
        document.getElementById('s_fullName').value = s.name || '';
        document.getElementById('s_email').value = s.email || '';
        document.getElementById('s_phone').value = s.phone || '';
        document.getElementById('s_admissionNo').value = s.admissionNo || '';
        document.getElementById('s_program').value = s.program || '';
        document.getElementById('s_year').value = s.year || '';
        document.getElementById('s_semester').value = s.semester || '';
        // store id for update
        document.getElementById('studentForm').dataset.editId = id;
        showSection('students');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        console.error(err);
      }
    };

    document.getElementById('saveStudent').addEventListener('click', async () => {
      const id = document.getElementById('studentForm').dataset.editId;
      const data = {
        name: document.getElementById('s_fullName').value.trim(),
        email: document.getElementById('s_email').value.trim(),
        phone: document.getElementById('s_phone').value.trim(),
        admissionNo: document.getElementById('s_admissionNo').value.trim(),
        program: document.getElementById('s_program').value.trim(),
        year: document.getElementById('s_year').value,
        semester: document.getElementById('s_semester').value,
      };
      try {
        if (!data.email || !data.name) return alert('Name and email are required');
        if (id) {
          await updateDoc(doc(db, 'students', id), data);
          document.getElementById('studentFormMsg').textContent = 'Student updated';
        } else {
          // create new doc with auto id; use email's local part as display id? we create doc with auto id
          const newDoc = await addDoc(collection(db, 'students'), { ...data, createdAt: serverTimestamp() });
          document.getElementById('studentFormMsg').textContent = 'Student added';
          document.getElementById('studentForm').dataset.editId = newDoc.id;
        }
        await loadStudents();
        await loadStudentsSelects();
      } catch (err) {
        console.error('saveStudent', err);
        alert('Error saving student: ' + err.message);
      }
    });

    document.getElementById('deleteStudent').addEventListener('click', async () => {
      const id = document.getElementById('studentForm').dataset.editId;
      if (!id) return alert('Select a student to delete (Edit first)');
      if (!confirm('Delete this student? This is irreversible.')) return;
      try {
        await deleteDoc(doc(db, 'students', id));
        document.getElementById('studentFormMsg').textContent = 'Student deleted';
        document.getElementById('studentForm').dataset.editId = '';
        document.getElementById('studentForm').reset();
        await loadStudents();
        await loadStudentsSelects();
      } catch (err) {
        console.error('deleteStudent', err);
      }
    });

    document.getElementById('refreshStudents').addEventListener('click', loadStudents);

    /* --------------------------
       COURSES
       -------------------------- */
    async function loadCourses() {
      try {
        document.getElementById('coursesTableBody').innerHTML = '<tr><td colspan="7" class="p-4">Loading...</td></tr>';
        const snap = await getDocs(collection(db, 'courses'));
        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        if (rows.length === 0) {
          document.getElementById('coursesTableBody').innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No courses.</td></tr>';
          return;
        }
        document.getElementById('coursesTableBody').innerHTML = rows.map(c => `
          <tr class="border-b">
            <td class="p-2">${c.code}</td>
            <td class="p-2">${c.title}</td>
            <td class="p-2">${c.credits}</td>
            <td class="p-2">${c.year}</td>
            <td class="p-2">${c.semester}</td>
            <td class="p-2">${c.lecturer || ''}</td>
            <td class="p-2">
              <button class="btn-primary text-sm" onclick="editCourse('${c.id}')">Edit</button>
              <button class="btn-danger text-sm ml-1" onclick="deleteCourse('${c.id}')">Delete</button>
            </td>
          </tr>
        `).join('');
        // fill course selects for timetable and grades
        populateCourseSelects(rows);
      } catch (err) {
        console.error('loadCourses', err);
      }
    }

    window.editCourse = async (id) => {
      const snap = await getDoc(doc(db, 'courses', id));
      if (!snap.exists()) return alert('course not found');
      const c = snap.data();
      document.getElementById('c_code').value = c.code || '';
      document.getElementById('c_title').value = c.title || '';
      document.getElementById('c_credits').value = c.credits || '';
      document.getElementById('c_year').value = c.year || '';
      document.getElementById('c_semester').value = c.semester || '';
      document.getElementById('c_lecturer').value = c.lecturer || '';
      document.getElementById('saveCourse').dataset.editId = id;
      showSection('courses');
    };

    window.deleteCourse = async (id) => {
      if (!confirm('Delete course?')) return;
      try {
        await deleteDoc(doc(db, 'courses', id));
        await loadCourses();
      } catch (err) {
        console.error('deleteCourse', err);
      }
    };

    document.getElementById('saveCourse').addEventListener('click', async () => {
      const id = document.getElementById('saveCourse').dataset.editId;
      const data = {
        code: document.getElementById('c_code').value.trim(),
        title: document.getElementById('c_title').value.trim(),
        credits: Number(document.getElementById('c_credits').value) || 0,
        year: document.getElementById('c_year').value,
        semester: document.getElementById('c_semester').value,
        lecturer: document.getElementById('c_lecturer').value.trim()
      };
      if (!data.code || !data.title) return alert('Course code and title required');
      try {
        if (id) {
          await updateDoc(doc(db, 'courses', id), data);
          document.getElementById('courseFormMsg').textContent = 'Course updated';
        } else {
          await addDoc(collection(db, 'courses'), { ...data, createdAt: serverTimestamp() });
          document.getElementById('courseFormMsg').textContent = 'Course added';
        }
        await loadCourses();
        document.getElementById('saveCourse').dataset.editId = '';
      } catch (err) {
        console.error('saveCourse', err);
      }
    });

    document.getElementById('refreshCourses').addEventListener('click', loadCourses);

    function populateCourseSelects(coursesArray) {
      const selectT = document.getElementById('tt_course');
      const selectG = document.getElementById('g_selectCourse');
      selectT.innerHTML = '<option value="">Select course</option>';
      selectG.innerHTML = '<option value="">Select course</option>';
      coursesArray.forEach(c => {
        const opt = `<option value="${c.id}" data-code="${c.code}">${c.code} - ${c.title}</option>`;
        selectT.insertAdjacentHTML('beforeend', opt);
        selectG.insertAdjacentHTML('beforeend', opt);
      });
    }

    /* --------------------------
       TIMETABLE
       -------------------------- */
    async function loadTimetable() {
      try {
        document.getElementById('timetableTableBody').innerHTML = '<tr><td colspan="6" class="p-4">Loading...</td></tr>';
        const snap = await getDocs(collection(db, 'timetable'));
        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        if (rows.length === 0) {
          document.getElementById('timetableTableBody').innerHTML = '<tr><td colspan="6" class="p-4 text-gray-500 text-center">No timetable entries</td></tr>';
          return;
        }
        document.getElementById('timetableTableBody').innerHTML = rows.map(r => `
          <tr class="border-b">
            <td class="p-2">${r.courseCode || r.courseId || ''}</td>
            <td class="p-2">${r.day}</td>
            <td class="p-2">${r.time}</td>
            <td class="p-2">${r.venue}</td>
            <td class="p-2">${r.year || ''}/${r.semester || ''}</td>
            <td class="p-2"><button class="btn-danger text-sm" onclick="deleteTimetable('${r.id}')">Delete</button></td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('loadTimetable', err);
      }
    }

    document.getElementById('saveTimetable').addEventListener('click', async () => {
      try {
        const cId = document.getElementById('tt_course').value;
        const courseText = document.getElementById('tt_course').selectedOptions[0]?.text || '';
        const courseCode = courseText.split(' - ')[0] || '';
        const data = {
          courseId: cId || null,
          courseCode: courseCode,
          day: document.getElementById('tt_day').value,
          time: document.getElementById('tt_time').value,
          venue: document.getElementById('tt_venue').value,
          year: document.getElementById('tt_year').value,
          semester: document.getElementById('tt_semester').value,
          createdAt: serverTimestamp()
        };
        if (!data.courseCode || !data.day || !data.time) return alert('Course, day and time are required');
        await addDoc(collection(db, 'timetable'), data);
        document.getElementById('timetableMsg').textContent = 'Saved';
        await loadTimetable();
      } catch (err) {
        console.error('saveTimetable', err);
      }
    });

    window.deleteTimetable = async (id) => {
      if (!confirm('Delete this slot?')) return;
      try {
        await deleteDoc(doc(db, 'timetable', id));
        await loadTimetable();
      } catch (err) { console.error(err); }
    };
    document.getElementById('refreshTimetable').addEventListener('click', loadTimetable);

    /* --------------------------
       GRADES
       -------------------------- */
    async function loadStudentsSelects() {
      // populate student select dropdowns used across admin pages
      try {
        const snap = await getDocs(collection(db, 'students'));
        const students = [];
        snap.forEach(d => students.push({ id: d.id, ...d.data() }));
        const gsel = document.getElementById('g_selectStudent');
        const fsel = document.getElementById('f_selectStudent');
        gsel.innerHTML = '<option value="">Select student</option>';
        fsel.innerHTML = '<option value="">Select student</option>';
        students.forEach(s => {
          const name = s.name || s.email || s.id;
          gsel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${name} (${s.admissionNo || s.id})</option>`);
          fsel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${name}</option>`);
        });
      } catch (err) { console.error('loadStudentsSelects', err); }
    }

    document.getElementById('saveGrade').addEventListener('click', async () => {
      try {
        const studentId = document.getElementById('g_selectStudent').value;
        const courseId = document.getElementById('g_selectCourse').value;
        const grade = document.getElementById('g_grade').value.trim();
        const points = Number(document.getElementById('g_points').value) || 0;
        const credits = Number(document.getElementById('g_credits').value) || 0;
        if (!studentId || !courseId || !grade) return alert('Student, course and grade required');
        const courseSnap = await getDoc(doc(db, 'courses', courseId));
        const courseCode = courseSnap.exists() ? courseSnap.data().code : courseId;
        // write to grades/{uid}/results/{courseId}
        await setDoc(doc(db, 'grades', studentId, 'results', courseId), {
          courseCode,
          courseTitle: courseSnap.exists() ? courseSnap.data().title : '',
          credits,
          grade,
          gpaPoints: points,
          lecturer: courseSnap.exists() ? courseSnap.data().lecturer : '',
          year: courseSnap.exists() ? courseSnap.data().year : null,
          semester: courseSnap.exists() ? courseSnap.data().semester : null,
          updatedAt: serverTimestamp()
        });
        document.getElementById('gradeMsg').textContent = 'Grade saved';
        // reload student grades view if currently selected
        await loadStudentGrades(studentId);
      } catch (err) {
        console.error('saveGrade', err);
      }
    });

    document.getElementById('g_selectStudent').addEventListener('change', (e) => {
      loadStudentGrades(e.target.value);
    });

    async function loadStudentGrades(studentId) {
      const tbody = document.getElementById('studentGradesTable');
      tbody.innerHTML = '<tr><td colspan="5" class="p-4">Loading...</td></tr>';
      if (!studentId) {
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-gray-500">Select a student.</td></tr>';
        return;
      }
      try {
        const snap = await getDocs(collection(db, 'grades', studentId, 'results'));
        const rows = [];
        snap.forEach(d => rows.push(d.data()));
        if (rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-gray-500">No grades for this student.</td></tr>';
          return;
        }
        tbody.innerHTML = rows.map(r => `
          <tr class="border-b">
            <td class="p-2">${r.courseCode}</td>
            <td class="p-2">${r.courseTitle}</td>
            <td class="p-2">${r.credits}</td>
            <td class="p-2">${r.grade}</td>
            <td class="p-2">${r.gpaPoints}</td>
          </tr>
        `).join('');
      } catch (err) { console.error('loadStudentGrades', err); }
    }

    document.getElementById('refreshGrades').addEventListener('click', () => {
      loadStudentsSelects();
    });

    /* --------------------------
       HOSTELS
       -------------------------- */
    async function loadHostels() {
      try {
        document.getElementById('hostelsTableBody').innerHTML = '<tr><td colspan="5" class="p-4">Loading...</td></tr>';
        const snap = await getDocs(collection(db, 'hostels'));
        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        if (!rows.length) {
          document.getElementById('hostelsTableBody').innerHTML = '<tr><td colspan="5" class="p-4 text-gray-500">No hostels found.</td></tr>';
          return;
        }
        document.getElementById('hostelsTableBody').innerHTML = rows.map(h => `
          <tr class="border-b">
            <td class="p-2">${h.name}</td>
            <td class="p-2">${h.type}</td>
            <td class="p-2">${h.capacity || ''}</td>
            <td class="p-2">${h.availableRooms || ''}</td>
            <td class="p-2">
              <button class="btn-primary text-sm" onclick="editHostel('${h.id}')">Edit</button>
            </td>
          </tr>
        `).join('');
      } catch (err) { console.error('loadHostels', err); }
    }

    document.getElementById('saveHostel').addEventListener('click', async () => {
      try {
        const data = {
          name: document.getElementById('h_name').value.trim(),
          type: document.getElementById('h_type').value,
          capacity: Number(document.getElementById('h_capacity').value) || 0,
          location: document.getElementById('h_location').value.trim(),
          availableRooms: Number(document.getElementById('h_capacity').value) || 0,
          createdAt: serverTimestamp()
        };
        if (!data.name) return alert('Hostel name required');
        await addDoc(collection(db, 'hostels'), data);
        document.getElementById('hostelMsg').textContent = 'Hostel added';
        await loadHostels();
      } catch (err) { console.error('saveHostel', err); }
    });

    window.editHostel = async (id) => {
      const snap = await getDoc(doc(db, 'hostels', id));
      if (!snap.exists()) return alert('Hostel not found');
      const h = snap.data();
      document.getElementById('h_name').value = h.name || '';
      document.getElementById('h_type').value = h.type || '';
      document.getElementById('h_capacity').value = h.capacity || '';
      document.getElementById('h_location').value = h.location || '';
      document.getElementById('saveHostel').dataset.editId = id;
      showSection('hostels');
    };

    document.getElementById('refreshHostels').addEventListener('click', loadHostels);

    /* --------------------------
       FINANCE
       -------------------------- */
    document.getElementById('saveTransaction').addEventListener('click', async () => {
      try {
        const studentId = document.getElementById('f_selectStudent').value;
        const amount = Number(document.getElementById('f_amount').value) || 0;
        const type = document.getElementById('f_type').value;
        const description = document.getElementById('f_description').value.trim();
        if (!studentId || !amount) return alert('Student and amount required');
        // create transaction doc under finance/{uid}/transactions
        const txnRef = collection(db, 'finance', studentId, 'transactions');
        await addDoc(txnRef, {
          amount,
          type,
          description,
          date: serverTimestamp()
        });
        // update balance in finance/{uid}
        const finDocRef = doc(db, 'finance', studentId);
        const finSnap = await getDoc(finDocRef);
        let newBalance = 0;
        if (finSnap.exists()) {
          const cur = finSnap.data().balance || 0;
          newBalance = type === 'payment' ? (cur - amount) : (cur + amount);
          await updateDoc(finDocRef, { balance: newBalance });
        } else {
          newBalance = type === 'payment' ? (-amount) : amount;
          await setDoc(finDocRef, { balance: newBalance });
        }
        document.getElementById('financeMsg').textContent = 'Transaction saved';
        await loadStudentFinanceSnapshot(studentId);
      } catch (err) { console.error('saveTransaction', err); }
    });

    async function loadStudentFinanceSnapshot(studentId) {
      if (!studentId) {
        document.getElementById('financeSnapshot').innerHTML = '<div class="p-4 text-gray-500">Select a student to view snapshot.</div>';
        return;
      }
      try {
        const finDoc = await getDoc(doc(db, 'finance', studentId));
        const txnsSnap = await getDocs(collection(db, 'finance', studentId, 'transactions'));
        const txns = [];
        txnsSnap.forEach(t => txns.push({ id: t.id, ...t.data() }));
        let html = `<div class="p-4"><div><strong>Balance:</strong> KES ${ (finDoc.exists() && finDoc.data().balance !== undefined) ? Number(finDoc.data().balance).toLocaleString() : '0' }</div>`;
        html += '<h4 class="mt-4 font-semibold">Transactions</h4>';
        if (txns.length === 0) html += '<div class="text-gray-500">No transactions</div>';
        else {
          html += '<ul class="mt-2">';
          txns.forEach(t => {
            const date = t.date && t.date.seconds ? new Date(t.date.seconds * 1000).toLocaleString() : '';
            html += `<li class="border-b py-2">${date} â ${t.type} â KES ${t.amount} â ${t.description || ''}</li>`;
          });
          html += '</ul>';
        }
        html += '</div>';
        document.getElementById('financeSnapshot').innerHTML = html;
      } catch (err) { console.error('loadStudentFinanceSnapshot', err); }
    }

    document.getElementById('f_selectStudent').addEventListener('change', (e) => {
      loadStudentFinanceSnapshot(e.target.value);
    });
    document.getElementById('refreshFinance').addEventListener('click', () => {
      loadStudentsSelects();
    });

    /* --------------------------
       GRADUATIONS & CLEARANCES
       -------------------------- */
    async function loadGraduations() {
      try {
        const snap = await getDocs(collection(db, 'graduations'));
        const rows = []; snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        if (!rows.length) {
          document.getElementById('graduationsTableBody').innerHTML = '<tr><td colspan="5" class="p-4 text-gray-500">No requests</td></tr>';
          return;
        }
        document.getElementById('graduationsTableBody').innerHTML = rows.map(r => {
          const approvals = r.approvals || {};
          const appSummary = Object.keys(approvals).map(k => `${k}: ${approvals[k].status || 'Pending'}`).join('<br/>');
          return `
            <tr class="border-b">
              <td class="p-2">${r.name || r.admissionNo || r.studentId || r.id}</td>
              <td class="p-2">${r.program || ''}</td>
              <td class="p-2">${r.dateSubmitted ? (r.dateSubmitted.seconds? new Date(r.dateSubmitted.seconds*1000).toLocaleDateString(): r.dateSubmitted) : ''}</td>
              <td class="p-2">${appSummary}</td>
              <td class="p-2">
                <button class="btn-primary text-sm" onclick="openGraduation('${r.id}')">View</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (err) { console.error('loadGraduations', err); }
    }

    window.openGraduation = async (id) => {
      // show details modal (simple prompt-based admin actions)
      const snap = await getDoc(doc(db, 'graduations', id));
      if (!snap.exists()) return alert('Not found');
      const data = snap.data();
      // allow admin to set department approvals
      const dept = prompt('Enter department to update (finance/academics/library/dean):');
      if (!dept) return;
      const status = prompt('Enter status (Approved / Rejected / Pending):', 'Approved');
      const comments = prompt('Comments (optional):', '');
      // update approvals and overall status
      const approvals = data.approvals || {};
      approvals[dept] = { status, comments };
      // compute overall
      let overall = 'Pending';
      const statuses = Object.values(approvals).map(v => v.status);
      if (statuses.includes('Rejected')) overall = 'Rejected';
      else if (statuses.length > 0 && statuses.every(s => s === 'Approved')) overall = 'Approved';
      else overall = 'Pending';
      await updateDoc(doc(db, 'graduations', id), { approvals, overallStatus: overall });
      alert('Updated');
      await loadGraduations();
    };

    async function loadClearances() {
      try {
        const snap = await getDocs(collection(db, 'clearances'));
        const rows = []; snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        if (!rows.length) {
          document.getElementById('clearancesTableBody').innerHTML = '<tr><td colspan="4" class="p-4 text-gray-500">No requests</td></tr>';
          return;
        }
        document.getElementById('clearancesTableBody').innerHTML = rows.map(r => {
          const approvals = r.approvals || {};
          const appSummary = Object.keys(approvals).map(k => `${k}: ${approvals[k].status || 'Pending'}`).join('<br/>');
          return `
            <tr class="border-b">
              <td class="p-2">${r.admissionNo || r.studentId || r.id}</td>
              <td class="p-2">${r.dateSubmitted ? (r.dateSubmitted.seconds? new Date(r.dateSubmitted.seconds*1000).toLocaleDateString(): r.dateSubmitted) : ''}</td>
              <td class="p-2">${appSummary}</td>
              <td class="p-2"><button class="btn-primary text-sm" onclick="openClearance('${r.id}')">View</button></td>
            </tr>
          `;
        }).join('');
      } catch (err) { console.error('loadClearances', err); }
    }

    window.openClearance = async (id) => {
      const snap = await getDoc(doc(db, 'clearances', id));
      if (!snap.exists()) return alert('Not found');
      const data = snap.data();
      const dept = prompt('Enter department to update (library/finance/hostel/dean):');
      if (!dept) return;
      const status = prompt('Enter status (Approved / Rejected / Pending):', 'Approved');
      const comments = prompt('Comments (optional):', '');
      const approvals = data.approvals || {};
      approvals[dept] = { status, comments };
      let overall = 'Pending';
      const statuses = Object.values(approvals).map(v => v.status);
      if (statuses.includes('Rejected')) overall = 'Rejected';
      else if (statuses.length > 0 && statuses.every(s => s === 'Approved')) overall = 'Approved';
      else overall = 'Pending';
      await updateDoc(doc(db, 'clearances', id), { approvals, overallStatus: overall });
      alert('Updated');
      await loadClearances();
    };

    document.getElementById('refreshGraduations').addEventListener('click', loadGraduations);
    document.getElementById('refreshClearances').addEventListener('click', loadClearances);

    /* --------------------------
       ANNOUNCEMENTS
       -------------------------- */
    document.getElementById('saveAnnouncement').addEventListener('click', async () => {
      try {
        const title = document.getElementById('a_title').value.trim();
        const category = document.getElementById('a_category').value;
        const pinned = document.getElementById('a_pinned').checked;
        const message = document.getElementById('a_message').value.trim();
        if (!title || !message) return alert('Title and message required');
        await addDoc(collection(db, 'announcements'), {
          title, category, pinned, message, author: auth.currentUser.email, date: serverTimestamp()
        });
        document.getElementById('announceMsg').textContent = 'Published';
        await loadAnnouncements();
      } catch (err) { console.error('saveAnnouncement', err); }
    });

    async function loadAnnouncements() {
      try {
        const snap = await getDocs(query(collection(db, 'announcements'), orderBy('date', 'desc')));
        const rows = []; snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        if (!rows.length) {
          document.getElementById('announcementsTableBody').innerHTML = '<tr><td colspan="5" class="p-4 text-gray-500">No announcements</td></tr>';
          return;
        }
        document.getElementById('announcementsTableBody').innerHTML = rows.map(a => `
          <tr class="border-b">
            <td class="p-2">${a.title}</td>
            <td class="p-2">${a.category}</td>
            <td class="p-2">${a.pinned ? 'Yes' : 'No'}</td>
            <td class="p-2">${a.date && a.date.seconds ? new Date(a.date.seconds*1000).toLocaleString() : ''}</td>
            <td class="p-2">
              <button class="btn-danger text-sm" onclick="deleteAnnouncement('${a.id}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (err) { console.error('loadAnnouncements', err); }
    }

    window.deleteAnnouncement = async (id) => {
      if (!confirm('Delete announcement?')) return;
      try { await deleteDoc(doc(db, 'announcements', id)); await loadAnnouncements(); } catch (err) { console.error(err); }
    };

    document.getElementById('refreshAnnouncements').addEventListener('click', loadAnnouncements);

    /* --------------------------
       Utility: load all initial selects
       -------------------------- */
    async function loadStudents() { await loadStudents(); } // placeholder so refresh button works (already called earlier)

    // Avoid name clash: ensure functions exist - earlier loadStudents declared; ensure selects loaded
    // loadStudents and other initial calls were already called after admin check

    // Final UI ready: hide loading overlay if still visible
    setTimeout(()=> { document.getElementById('loadingOverlay').classList.add('hidden'); }, 1000);

    // Expose some functions used in inline handlers to window
    window.loadStudentsSelects = loadStudentsSelects;
    window.loadStudents = loadStudents;
    window.loadCourses = loadCourses;
    window.loadTimetable = loadTimetable;
    window.loadHostels = loadHostels;
    window.loadAnnouncements = loadAnnouncements;
    window.loadGraduations = loadGraduations;
    window.loadClearances = loadClearances;
    window.loadAdminStats = loadAdminStats;

  </script>
</body>
</html>
