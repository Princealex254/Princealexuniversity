<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Full Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small visual nicety */
    .side-link.active { background: rgba(255,255,255,0.08); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Popup (6s auto-hide) -->
  <div id="popup" class="fixed top-4 left-1/2 -translate-x-1/2 hidden z-50 max-w-xl w-full px-4">
    <div id="popupInner" class="p-3 rounded shadow text-white flex justify-between items-center"></div>
  </div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-sky-600 to-indigo-600 text-white p-4 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <button id="hamburger" class="md:hidden p-2 bg-white/10 rounded">‚ò∞</button>
      <div class="text-lg font-bold">University Admin Dashboard</div>
    </div>
    <div class="text-sm">Connected Project: <span id="projectLabel" class="font-medium">universityweb</span></div>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="hidden md:block w-64 bg-white border-r min-h-screen p-4 space-y-3">
      <nav>
        <button class="side-link block w-full text-left p-2 rounded" data-view="dashboard">üè† Dashboard</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="students">üë®‚Äçüéì Students</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="admins">üõ°Ô∏è Admins</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="clearance">‚úÖ Clearance</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="courseReg">üìö Courses</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="registrations">üìù Registrations</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="examCard">üìÑ Exam Cards</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="finance">üí≥ Finance</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="grades">üßÆ Grades</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="graduation">üéì Graduation</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="hostels">üè® Hostels</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="timetable">üìÖ Timetable</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="profile">üîé Profile</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="settings">‚öôÔ∏è Settings</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="view">
        <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Total students</div>
            <div id="stat_total_students" class="text-2xl font-semibold">‚Äî</div>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Active students</div>
            <div id="stat_active_students" class="text-2xl font-semibold">‚Äî</div>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Admins</div>
            <div id="stat_admins" class="text-2xl font-semibold">‚Äî</div>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Pending clearance</div>
            <div id="stat_pending_clearance" class="text-2xl font-semibold">‚Äî</div>
          </div>
        </div>
      </section>

      <!-- STUDENTS -->
      <section id="view-students" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Students</h2>
          <div class="flex gap-2">
            <input id="students_search" placeholder="Search name / admissionNo / email" class="border p-2 rounded" />
            <button id="students_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
            <button id="students_new" class="bg-gray-200 px-3 py-2 rounded">New</button>
          </div>
        </div>

        <!-- table -->
        <div class="overflow-x-auto bg-white rounded shadow">
          <table class="w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 border">Name</th>
                <th class="p-2 border">Admission No</th>
                <th class="p-2 border">Email</th>
                <th class="p-2 border">Programme</th>
                <th class="p-2 border">Year</th>
                <th class="p-2 border">Active</th>
                <th class="p-2 border">Actions</th>
              </tr>
            </thead>
            <tbody id="students_tbody">
              <tr><td colspan="7" class="p-4 text-center text-gray-500">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <!-- form -->
        <div class="mt-6 bg-white rounded shadow p-4">
          <h3 class="font-semibold mb-2">Add / Edit Student</h3>
          <form id="studentForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="stu_id" type="hidden" />
            <input id="stu_name" placeholder="name" class="border p-2 rounded" />
            <input id="stu_admissionNo" placeholder="admissionNo (LMC/94/16)" class="border p-2 rounded" />
            <input id="stu_email" placeholder="email" class="border p-2 rounded" />
            <input id="stu_regNo" placeholder="regNo" class="border p-2 rounded" />
            <input id="stu_programme" placeholder="programme" class="border p-2 rounded" />
            <input id="stu_yearOfStudy" type="number" placeholder="yearOfStudy (2025)" class="border p-2 rounded" />
            <input id="stu_campus" placeholder="campus (Main)" class="border p-2 rounded" />
            <input id="stu_address" placeholder="address" class="border p-2 rounded" />
            <label class="flex items-center gap-2"><input id="stu_isActive" type="checkbox" /> isActive</label>
            <div class="md:col-span-3 flex gap-2">
              <button id="stu_save" type="button" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
              <button id="stu_clear" type="button" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
            </div>
          </form>
        </div>
      </section>

      <!-- ADMINS -->
      <section id="view-admins" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Admins</h2>
          <button id="admins_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
        </div>

        <div class="bg-white p-4 rounded shadow mb-4">
          <form id="adminForm" class="flex gap-2">
            <input id="admin_email" placeholder="admin email" class="border p-2 rounded flex-1" />
            <button id="admin_add" type="button" class="bg-green-600 text-white px-4 py-2 rounded">Add Admin</button>
          </form>
        </div>

        <div id="admins_list" class="bg-white p-4 rounded shadow">
          Loading admins‚Ä¶
        </div>
      </section>

      <!-- CLEARANCE -->
      <section id="view-clearance" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Clearance Requests</h2>
          <button id="clearance_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
        </div>
        <div class="bg-white rounded shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100"><tr>
              <th class="p-2 border">Student Email</th>
              <th class="p-2 border">Reason</th>
              <th class="p-2 border">Status</th>
              <th class="p-2 border">Departments</th>
              <th class="p-2 border">Actions</th>
            </tr></thead>
            <tbody id="clearance_tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- COURSES -->
      <section id="view-courseReg" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Courses (courses collection)</h2>
          <div class="flex gap-2">
            <button id="courses_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
          </div>
        </div>

        <div class="bg-white rounded shadow p-4 mb-4">
          <form id="courseForm" class="grid md:grid-cols-4 gap-3">
            <input id="course_id" type="hidden"/>
            <input id="course_courseCode" placeholder="courseCode" class="border p-2 rounded" />
            <input id="course_courseName" placeholder="courseName" class="border p-2 rounded" />
            <input id="course_department" placeholder="department" class="border p-2 rounded" />
            <input id="course_semester" placeholder="semester" class="border p-2 rounded" />
            <input id="course_yearOfStudy" placeholder="yearOfStudy" class="border p-2 rounded" />
            <div class="md:col-span-4 flex gap-2">
              <button id="course_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Course</button>
              <button id="course_clear" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
            </div>
          </form>
        </div>

        <div class="bg-white rounded shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100"><tr><th class="p-2 border">Code</th><th class="p-2 border">Name</th><th class="p-2 border">Dept</th><th class="p-2 border">Sem</th><th class="p-2 border">Year</th><th class="p-2 border">Actions</th></tr></thead>
            <tbody id="courses_tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- REGISTRATIONS (for examCard / course assignments) -->
      <section id="view-registrations" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Registrations (registrations/{uid}/courses)</h2>
          <div class="flex gap-2">
            <input id="reg_uid" placeholder="Student UID" class="border p-2 rounded" />
            <button id="reg_load" class="bg-sky-600 text-white px-3 py-2 rounded">Load</button>
          </div>
        </div>

        <div id="reg_panel" class="hidden bg-white rounded shadow p-4">
          <h3 class="font-semibold">Registered Courses</h3>
          <div id="reg_list" class="mt-3"></div>
          <h4 class="mt-4 font-semibold">Add by course ID</h4>
          <div class="flex gap-2 mt-2">
            <input id="reg_courseId" placeholder="course doc id" class="border p-2 rounded flex-1" />
            <button id="reg_add" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
          </div>
        </div>
      </section>

      <!-- EXAM CARD (view and export) -->
      <section id="view-examCard" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Exam Card</h2>
          <div class="flex gap-2">
            <input id="exam_uid" placeholder="Student UID" class="border p-2 rounded" />
            <button id="exam_load" class="bg-sky-600 text-white px-3 py-2 rounded">Load</button>
          </div>
        </div>

        <div id="exam_panel" class="hidden bg-white rounded shadow p-4">
          <div id="exam_table" class="overflow-x-auto"></div>
          <div class="mt-4">
            <button id="exam_download" class="bg-indigo-600 text-white px-4 py-2 rounded">Download (simple table export)</button>
          </div>
        </div>
      </section>

      <!-- FINANCE -->
      <section id="view-finance" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Finance</h2>
          <div class="flex gap-2">
            <input id="fin_uid" placeholder="Student UID" class="border p-2 rounded" />
            <button id="fin_load" class="bg-sky-600 text-white px-3 py-2 rounded">Load</button>
          </div>
        </div>

        <div id="fin_panel" class="hidden bg-white rounded shadow p-4">
          <div class="grid md:grid-cols-3 gap-4">
            <div>Total Fees: <div id="fin_total">KES 0</div></div>
            <div>Total Paid: <div id="fin_paid">KES 0</div></div>
            <div>Balance: <div id="fin_balance">KES 0</div></div>
          </div>

          <div class="mt-4">
            <h4 class="font-semibold">Add Transaction</h4>
            <div class="grid md:grid-cols-4 gap-2 mt-2">
              <input id="txn_method" placeholder="method" class="border p-2 rounded" />
              <input id="txn_reference" placeholder="reference" class="border p-2 rounded" />
              <input id="txn_amount" type="number" placeholder="amount" class="border p-2 rounded" />
              <select id="txn_status" class="border p-2 rounded">
                <option>Confirmed</option>
                <option>Pending</option>
                <option>Failed</option>
              </select>
              <div class="md:col-span-4 mt-2">
                <button id="txn_add" class="bg-green-600 text-white px-4 py-2 rounded">Add Transaction</button>
              </div>
            </div>
          </div>

          <div id="txn_list" class="mt-4"></div>
        </div>
      </section>

      <!-- GRADES -->
      <section id="view-grades" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Grades</h2>
          <div class="flex gap-2">
            <input id="grades_uid" placeholder="Student UID" class="border p-2 rounded" />
            <button id="grades_load" class="bg-sky-600 text-white px-3 py-2 rounded">Load</button>
          </div>
        </div>

        <div id="grades_panel" class="hidden bg-white rounded shadow p-4">
          <h4 class="font-semibold">Add / Update Result</h4>
          <div class="grid md:grid-cols-6 gap-2 mt-2">
            <input id="gr_code" placeholder="code" class="border p-2 rounded" />
            <input id="gr_title" placeholder="title" class="border p-2 rounded" />
            <input id="gr_credits" type="number" placeholder="credits" class="border p-2 rounded" />
            <input id="gr_grade" placeholder="grade" class="border p-2 rounded" />
            <input id="gr_points" type="number" step="0.01" placeholder="gpaPoints" class="border p-2 rounded" />
            <div class="flex gap-2">
              <input id="gr_year" type="number" placeholder="year" class="border p-2 rounded" />
              <input id="gr_sem" type="number" placeholder="semester" class="border p-2 rounded" />
            </div>
            <div class="md:col-span-6 mt-2">
              <button id="gr_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Result</button>
            </div>
          </div>

          <div id="grades_list" class="mt-4"></div>
        </div>
      </section>

      <!-- GRADUATION -->
      <section id="view-graduation" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Graduation Requests</h2>
          <button id="grad_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
        </div>
        <div class="bg-white rounded shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100"><tr><th class="p-2 border">Student</th><th class="p-2 border">Status</th><th class="p-2 border">Requested</th><th class="p-2 border">Actions</th></tr></thead>
            <tbody id="graduation_tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- HOSTELS -->
      <section id="view-hostels" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Hostels & Rooms</h2>
          <div class="flex gap-2">
            <button id="hostels_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
            <button id="hostels_recalc" class="bg-indigo-600 text-white px-3 py-2 rounded">Recalc Availability</button>
          </div>
        </div>

        <div class="bg-white rounded shadow p-4 mb-4">
          <h4 class="font-semibold">Add / Edit Hostel</h4>
          <div class="grid md:grid-cols-4 gap-2 mt-2">
            <input id="hostel_id" type="hidden"/>
            <input id="hostel_name" placeholder="name" class="border p-2 rounded" />
            <input id="hostel_gender" placeholder="gender" class="border p-2 rounded" />
            <input id="hostel_capacity" type="number" placeholder="capacity" class="border p-2 rounded" />
            <input id="hostel_available" type="number" placeholder="available" class="border p-2 rounded" />
            <div class="md:col-span-4 mt-2">
              <button id="hostel_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Hostel</button>
            </div>
          </div>
        </div>

        <div id="hostels_list" class="bg-white rounded shadow p-4"></div>

        <div class="bg-white rounded shadow p-4 mt-4">
          <h4 class="font-semibold">Rooms (select hostel to manage rooms below)</h4>
          <div class="grid md:grid-cols-4 gap-2 mt-2">
            <input id="room_hostelId" placeholder="hostelId" class="border p-2 rounded" />
            <input id="room_id" type="hidden" />
            <input id="room_number" placeholder="number" class="border p-2 rounded" />
            <input id="room_capacity" type="number" placeholder="capacity" class="border p-2 rounded" />
            <input id="room_occupants" type="number" placeholder="occupants" class="border p-2 rounded" />
            <div class="md:col-span-4 mt-2">
              <button id="room_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Room</button>
              <button id="room_load" class="bg-gray-200 px-4 py-2 rounded ml-2">Load Rooms</button>
            </div>
          </div>

          <div id="rooms_list" class="mt-4"></div>
        </div>
      </section>

      <!-- TIMETABLE -->
      <section id="view-timetable" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Timetable</h2>
          <div class="flex gap-2">
            <input id="timetable_uid" placeholder="Student UID" class="border p-2 rounded" />
            <button id="timetable_load" class="bg-sky-600 text-white px-3 py-2 rounded">Load</button>
          </div>
        </div>

        <div id="timetable_panel" class="hidden bg-white rounded shadow p-4">
          <h4 class="font-semibold">Schedule JSON (array of {day,time,courseCode,venue})</h4>
          <textarea id="timetable_json" rows="6" class="w-full border p-2 rounded"></textarea>
          <div class="mt-2">
            <button id="timetable_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Timetable</button>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" class="view hidden">
        <h2 class="text-2xl font-semibold mb-4">Profile Management</h2>
        <div class="flex gap-2 mb-4">
          <input id="profile_search" placeholder="Search by admissionNo / regNo / email" class="border p-2 rounded flex-1"/>
          <button id="profile_search_btn" class="bg-sky-600 text-white px-3 py-2 rounded">Search</button>
        </div>
        <div id="profile_result" class="bg-white rounded shadow p-4 hidden"></div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="view hidden">
        <h2 class="text-2xl font-semibold mb-4">Settings</h2>
        <div class="bg-white p-4 rounded shadow">
          <h4 class="font-semibold">Password Reset</h4>
          <div class="flex gap-2 mt-2">
            <input id="reset_email" placeholder="student email" class="border p-2 rounded flex-1"/>
            <button id="reset_send" class="bg-red-600 text-white px-4 py-2 rounded">Send Reset Email</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Note: Client can trigger password reset email; changing Auth email/password fully requires Admin SDK.</p>
        </div>
      </section>

    </main>
  </div>

  <!-- Firebase & App Logic -->
  <script type="module">
    // Firebase imports (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, getDoc, doc, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /* ---------- popup helper (6s) ---------- */
    let popupTimeout = null;
    function showPopup(message, type="info") {
      clearTimeout(popupTimeout);
      const container = document.getElementById('popup');
      const inner = document.getElementById('popupInner');
      inner.textContent = message;
      inner.className = 'p-3 rounded shadow text-white flex justify-between items-center';
      if (type === 'success') inner.classList.add('bg-green-600'); 
      else if (type === 'error') inner.classList.add('bg-red-600');
      else inner.classList.add('bg-sky-600');
      container.classList.remove('hidden');
      popupTimeout = setTimeout(()=> container.classList.add('hidden'), 6000);
      document.getElementById('popupClose').onclick = ()=> container.classList.add('hidden');
    }

    /* ---------- view switch ---------- */
    const views = Array.from(document.querySelectorAll('.view'));
    function showView(viewId) {
      views.forEach(v=>v.classList.add('hidden'));
      const el = document.getElementById('view-' + viewId.replace('view-','').replace('view-','') )
      // we used id naming like view-students; but side uses data-view -> map:
      const map = {
        dashboard: 'view-dashboard',
        students: 'view-students',
        admins: 'view-admins',
        clearance: 'view-clearance',
        courseReg: 'view-courseReg',
        registrations: 'view-registrations',
        examCard: 'view-examCard',
        finance: 'view-finance',
        grades: 'view-grades',
        graduation: 'view-graduation',
        hostels: 'view-hostels',
        timetable: 'view-timetable',
        profile: 'view-profile',
        settings: 'view-settings'
      };
      const id = map[viewId] || 'view-dashboard';
      document.getElementById(id).classList.remove('hidden');
      // highlight sidebar
      document.querySelectorAll('.side-link').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.side-link[data-view]').forEach(b=>{
        if (b.dataset.view === viewId) b.classList.add('active');
      });
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Sidebar button wiring (desktop)
    document.querySelectorAll('.side-link').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const v = btn.dataset.view;
        showView(v);
      });
    });
    // Hamburger
    document.getElementById('hamburger').addEventListener('click', ()=>{
      document.getElementById('sidebar').classList.toggle('hidden');
    });

    /* ---------- DASHBOARD stats ---------- */
    async function refreshDashboardStats(){
      try {
        const sSnap = await getDocs(collection(db,'students'));
        document.getElementById('stat_total_students').textContent = sSnap.size;
        let active = 0;
        sSnap.forEach(d=> { if (d.data().isActive) active++; });
        document.getElementById('stat_active_students').textContent = active;

        const aSnap = await getDocs(collection(db,'admins'));
        document.getElementById('stat_admins').textContent = aSnap.size;

        const cSnap = await getDocs(collection(db,'clearanceRequests'));
        let pending = 0;
        cSnap.forEach(d=> { if ((d.data().status||'').toLowerCase() === 'pending') pending++; });
        document.getElementById('stat_pending_clearance').textContent = pending;
      } catch (e) {
        console.error(e);
        showPopup('Error loading stats: ' + e.message, 'error');
      }
    }

    /* ========== STUDENTS CRUD (exact fields) ========== */
    const studentsTbody = document.getElementById('students_tbody');
    const studentsSearch = document.getElementById('students_search');
    async function loadStudents(){
      studentsTbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Loading‚Ä¶</td></tr>';
      try {
        const snap = await getDocs(collection(db,'students'));
        studentsTbody.innerHTML = '';
        const rows = [];
        snap.forEach(d=> rows.push({ id: d.id, ...d.data() }));
        // simple render
        rows.forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border">${escapeHtml(s.name||'')}</td>
            <td class="p-2 border">${escapeHtml(s.admissionNo||'')}</td>
            <td class="p-2 border">${escapeHtml(s.email||'')}</td>
            <td class="p-2 border">${escapeHtml(s.programme||'')}</td>
            <td class="p-2 border">${escapeHtml(s.yearOfStudy||'')}</td>
            <td class="p-2 border">${s.isActive ? '‚úÖ' : '‚ùå'}</td>
            <td class="p-2 border">
              <button data-id="${s.id}" class="stu_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
              <button data-id="${s.id}" class="stu_delete ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
            </td>
          `;
          studentsTbody.appendChild(tr);
        });
        // wire edit/delete
        document.querySelectorAll('.stu_edit').forEach(btn=>{
          btn.addEventListener('click', async ()=> {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db,'students',id));
            if (!snap.exists()) return showPopup('Student not found','error');
            const s = snap.data();
            document.getElementById('stu_id').value = id;
            document.getElementById('stu_name').value = s.name || '';
            document.getElementById('stu_admissionNo').value = s.admissionNo || '';
            document.getElementById('stu_email').value = s.email || '';
            document.getElementById('stu_regNo').value = s.regNo || '';
            document.getElementById('stu_programme').value = s.programme || '';
            document.getElementById('stu_yearOfStudy').value = s.yearOfStudy || '';
            document.getElementById('stu_campus').value = s.campus || '';
            document.getElementById('stu_address').value = s.address || '';
            document.getElementById('stu_isActive').checked = !!s.isActive;
            showPopup('Loaded student into form','info');
            showView('students');
          });
        });
        document.querySelectorAll('.stu_delete').forEach(btn=>{
          btn.addEventListener('click', async ()=> {
            if (!confirm('Delete student record?')) return;
            await deleteDoc(doc(db,'students',btn.dataset.id));
            showPopup('Student deleted','success');
            await loadStudents();
            await refreshDashboardStats();
          });
        });
      } catch (e) {
        console.error(e);
        studentsTbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-600">Error loading students</td></tr>`;
        showPopup('Error loading students: ' + e.message, 'error');
      }
    }

    // student form save
    document.getElementById('stu_save').addEventListener('click', async ()=>{
      const id = document.getElementById('stu_id').value.trim();
      const payload = {
        name: document.getElementById('stu_name').value.trim(),
        admissionNo: document.getElementById('stu_admissionNo').value.trim(),
        email: document.getElementById('stu_email').value.trim(),
        regNo: document.getElementById('stu_regNo').value.trim(),
        programme: document.getElementById('stu_programme').value.trim(),
        yearOfStudy: Number(document.getElementById('stu_yearOfStudy').value) || null,
        campus: document.getElementById('stu_campus').value.trim(),
        address: document.getElementById('stu_address').value.trim(),
        isActive: !!document.getElementById('stu_isActive').checked,
        // keep createdAt if exists; if creating set serverTimestamp
      };
      try {
        if (id) {
          await updateDoc(doc(db,'students',id), { ...payload, updatedAt: serverTimestamp() });
          showPopup('Student updated','success');
        } else {
          payload.createdAt = serverTimestamp();
          const ref = await addDoc(collection(db,'students'), payload);
          showPopup('Student created (id: '+ref.id+')','success');
        }
        document.getElementById('studentForm').reset();
        document.getElementById('stu_id').value = '';
        await loadStudents();
        await refreshDashboardStats();
      } catch (e) {
        console.error(e);
        showPopup('Error saving student: ' + e.message, 'error');
      }
    });

    document.getElementById('stu_clear').addEventListener('click', ()=>{
      document.getElementById('studentForm').reset();
      document.getElementById('stu_id').value = '';
    });

    document.getElementById('students_refresh').addEventListener('click', loadStudents);
    document.getElementById('students_new').addEventListener('click', ()=>{
      document.getElementById('studentForm').reset();
      document.getElementById('stu_id').value = '';
      showPopup('Ready for new student','info');
    });

    studentsSearch.addEventListener('input', ()=>{
      const q = studentsSearch.value.trim().toLowerCase();
      document.querySelectorAll('#students_tbody tr').forEach(tr=>{
        tr.style.display = q === '' ? '' : (tr.textContent.toLowerCase().includes(q) ? '' : 'none');
      });
    });

    /* ========== ADMINS ========== */
    async function loadAdmins(){
      const container = document.getElementById('admins_list');
      try {
        const snap = await getDocs(collection(db,'admins'));
        container.innerHTML = '';
        if (snap.empty) container.textContent = 'No admins';
        else {
          snap.forEach(d=>{
            const item = d.data();
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 border-b';
            div.innerHTML = `<div class="text-sm">${escapeHtml(item.email||d.id)}</div>
              <div><button data-id="${d.id}" class="admin_remove bg-red-600 text-white px-2 py-1 rounded text-xs">Remove</button></div>`;
            container.appendChild(div);
          });
          document.querySelectorAll('.admin_remove').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              if (!confirm('Remove this admin?')) return;
              await deleteDoc(doc(db,'admins',btn.dataset.id));
              showPopup('Admin removed','success');
              loadAdmins();
              refreshDashboardStats();
            });
          });
        }
      } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="text-red-600">Error loading admins</div>';
        showPopup('Error loading admins: ' + e.message, 'error');
      }
    }
    document.getElementById('admin_add').addEventListener('click', async ()=>{
      const email = document.getElementById('admin_email').value.trim();
      if (!email) return showPopup('Enter admin email','error');
      try {
        await addDoc(collection(db,'admins'), { email, createdAt: serverTimestamp() });
        showPopup('Admin added','success');
        document.getElementById('admin_email').value = '';
        loadAdmins();
        refreshDashboardStats();
      } catch (e) { console.error(e); showPopup('Error adding admin: ' + e.message,'error'); }
    });
    document.getElementById('admins_refresh').addEventListener('click', loadAdmins);

    /* ========== CLEARANCE ========== */
    async function loadClearance(){
      const tbody = document.getElementById('clearance_tbody');
      tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading‚Ä¶</td></tr>';
      try {
        const snap = await getDocs(collection(db,'clearanceRequests'));
        tbody.innerHTML = '';
        snap.forEach(d=>{
          const c = d.data();
          const deps = c.departments || { Finance:'Pending', Library:'Pending', Hostel:'Pending', Dean:'Pending' };
          const depHtml = Object.entries(deps).map(([k,v])=>`<div class="inline-block mr-2 px-2 py-0.5 rounded text-xs ${v==='Cleared'?'bg-green-100 text-green-800':v==='Rejected'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}">${k}: ${v}</div>`).join('');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border">${escapeHtml(c.email||d.id)}</td>
            <td class="p-2 border">${escapeHtml(c.reason||'')}</td>
            <td class="p-2 border">${escapeHtml(c.status||'')}</td>
            <td class="p-2 border">${depHtml}</td>
            <td class="p-2 border">
              <select data-id="${d.id}" class="dep_select border p-1 rounded text-sm">
                <option>Finance</option><option>Library</option><option>Hostel</option><option>Dean</option>
              </select>
              <select data-val="${d.id}" class="dep_val border p-1 rounded text-sm">
                <option>Pending</option><option>Cleared</option><option>Rejected</option>
              </select>
              <button data-apply="${d.id}" class="ml-1 bg-blue-600 text-white px-2 py-1 rounded text-xs">Apply</button>
              <button data-clear="${d.id}" class="ml-1 bg-green-600 text-white px-2 py-1 rounded text-xs">Mark All Cleared</button>
              <button data-rej="${d.id}" class="ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        // wire apply
        document.querySelectorAll('[data-apply]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.dataset.apply;
            const dep = document.querySelector(`.dep_select[data-id='${id}']`).value;
            const val = document.querySelector(`.dep_val[data-val='${id}']`).value;
            const ref = doc(db,'clearanceRequests',id);
            const snap = await getDoc(ref);
            if (!snap.exists()) return showPopup('Request not found','error');
            const data = snap.data();
            const departments = data.departments || { Finance:'Pending', Library:'Pending', Hostel:'Pending', Dean:'Pending' };
            departments[dep] = val;
            await updateDoc(ref, { departments, updatedAt: serverTimestamp() });
            showPopup(`Set ${dep} ‚Üí ${val}`,'success');
            loadClearance();
          });
        });
        document.querySelectorAll('[data-clear]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Mark request as Cleared?')) return;
            await updateDoc(doc(db,'clearanceRequests',btn.dataset.clear), { status: 'Cleared', updatedAt: serverTimestamp() });
            showPopup('Request marked Cleared','success');
            loadClearance();
            refreshDashboardStats();
          });
        });
        document.querySelectorAll('[data-rej]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Reject this request?')) return;
            await updateDoc(doc(db,'clearanceRequests',btn.dataset.rej), { status: 'Rejected', updatedAt: serverTimestamp() });
            showPopup('Request rejected','success');
            loadClearance(); refreshDashboardStats();
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-red-600">Error loading</td></tr>`;
        showPopup('Error loading clearance: '+e.message,'error');
      }
    }
    document.getElementById('clearance_refresh').addEventListener('click', loadClearance);

    /* ========== COURSES (courses collection) ========== */
    async function loadCourses(){
      const tbody = document.getElementById('courses_tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Loading‚Ä¶</td></tr>';
      try {
        const snap = await getDocs(collection(db,'courses'));
        tbody.innerHTML = '';
        snap.forEach(d=>{
          const c = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2 border">${escapeHtml(c.courseCode||'')}</td>
            <td class="p-2 border">${escapeHtml(c.courseName||'')}</td>
            <td class="p-2 border">${escapeHtml(c.department||'')}</td>
            <td class="p-2 border">${escapeHtml(c.semester||'')}</td>
            <td class="p-2 border">${escapeHtml(c.yearOfStudy||'')}</td>
            <td class="p-2 border">
              <button data-id="${d.id}" class="course_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
              <button data-id="${d.id}" class="course_del ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.course_edit').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db,'courses',id));
            if (!snap.exists()) return showPopup('Course not found','error');
            const c = snap.data();
            document.getElementById('course_id').value = id;
            document.getElementById('course_courseCode').value = c.courseCode || '';
            document.getElementById('course_courseName').value = c.courseName || '';
            document.getElementById('course_department').value = c.department || '';
            document.getElementById('course_semester').value = c.semester || '';
            document.getElementById('course_yearOfStudy').value = c.yearOfStudy || '';
            showPopup('Course loaded into form','info');
          });
        });
        document.querySelectorAll('.course_del').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Delete this course?')) return;
            await deleteDoc(doc(db,'courses',btn.dataset.id));
            showPopup('Course deleted','success');
            loadCourses();
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-red-600">Error</td></tr>`;
        showPopup('Error loading courses: '+e.message,'error');
      }
    }
    document.getElementById('courses_refresh').addEventListener('click', loadCourses);
    document.getElementById('course_save').addEventListener('click', async ()=>{
      const id = document.getElementById('course_id').value.trim();
      const payload = {
        courseCode: document.getElementById('course_courseCode').value.trim(),
        courseName: document.getElementById('course_courseName').value.trim(),
        department: document.getElementById('course_department').value.trim(),
        semester: document.getElementById('course_semester').value.trim(),
        yearOfStudy: document.getElementById('course_yearOfStudy').value.trim(),
        updatedAt: serverTimestamp()
      };
      try {
        if (id) {
          await updateDoc(doc(db,'courses',id), payload);
          showPopup('Course updated','success');
        } else {
          await addDoc(collection(db,'courses'), { ...payload, createdAt: serverTimestamp() });
          showPopup('Course created','success');
        }
        document.getElementById('courseForm').reset();
        loadCourses();
      } catch (e) { console.error(e); showPopup('Error saving course: '+e.message,'error'); }
    });
    document.getElementById('course_clear').addEventListener('click', ()=> document.getElementById('courseForm').reset());

    /* ========== REGISTRATIONS (registrations/{uid}/courses) ========== */
    document.getElementById('reg_load').addEventListener('click', async ()=>{
      const uid = document.getElementById('reg_uid').value.trim();
      if (!uid) return showPopup('Enter student UID','error');
      try {
        const snap = await getDocs(collection(db,'registrations',uid,'courses'));
        const list = document.getElementById('reg_list');
        list.innerHTML = '';
        if (snap.empty) list.textContent = 'No registered courses';
        else {
          snap.forEach(d=>{
            const v = d.data();
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center border-b p-2';
            div.innerHTML = `<div>${escapeHtml(v.registeredAt?.toDate?.() ? v.registeredAt.toDate().toLocaleString() : d.id)}</div>
              <div><button data-id="${d.id}" class="reg_del bg-red-600 text-white px-2 py-1 rounded text-xs">Drop</button></div>`;
            list.appendChild(div);
          });
          document.querySelectorAll('.reg_del').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              await deleteDoc(doc(db,'registrations',uid,'courses',btn.dataset.id));
              showPopup('Dropped course','success');
              document.getElementById('reg_load').click();
            });
          });
        }
        document.getElementById('reg_panel').classList.remove('hidden');
      } catch (e) { console.error(e); showPopup('Error loading registrations: '+e.message,'error'); }
    });
    document.getElementById('reg_add').addEventListener('click', async ()=>{
      const uid = document.getElementById('reg_uid').value.trim();
      const courseId = document.getElementById('reg_courseId').value.trim();
      if (!uid || !courseId) return showPopup('Enter UID and courseId','error');
      try {
        await setDoc(doc(db,'registrations',uid,'courses',courseId), { registeredAt: serverTimestamp() });
        showPopup('Course registered','success');
        document.getElementById('reg_courseId').value = '';
        document.getElementById('reg_load').click();
      } catch (e) { console.error(e); showPopup('Error registering: '+e.message,'error'); }
    });

    /* ========== EXAM CARD (load registered courses) ========== */
    document.getElementById('exam_load').addEventListener('click', async ()=>{
      const uid = document.getElementById('exam_uid').value.trim();
      if (!uid) return showPopup('Enter student UID','error');
      try {
        const snap = await getDocs(collection(db,'registrations',uid,'courses'));
        const table = document.getElementById('exam_table');
        table.innerHTML = '';
        if (snap.empty) table.textContent = 'No registered courses';
        else {
          const rows = [];
          for (const d of snap.docs) {
            const courseId = d.id;
            const courseSnap = await getDoc(doc(db,'courses',courseId));
            const c = courseSnap.exists() ? courseSnap.data() : { courseCode: courseId, courseName: 'Unknown' };
            rows.push(`<tr><td class="p-2 border">${escapeHtml(c.courseCode||courseId)}</td><td class="p-2 border">${escapeHtml(c.courseName||'')}</td></tr>`);
          }
          table.innerHTML = `<table class="w-full"><thead class="bg-gray-100"><tr><th class="p-2 border">Code</th><th class="p-2 border">Title</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
          document.getElementById('exam_panel').classList.remove('hidden');
        }
      } catch (e) { console.error(e); showPopup('Error loading exam card: '+e.message,'error'); }
    });

    /* ========== FINANCE ========== */
    let fin_loaded_uid = '';
    document.getElementById('fin_load').addEventListener('click', async ()=>{
      const uid = document.getElementById('fin_uid').value.trim();
      if (!uid) return showPopup('Enter UID','error');
      fin_loaded_uid = uid;
      try {
        // summary
        const summaryDoc = await getDoc(doc(db,'finance',uid,'summary','totals'));
        const totals = summaryDoc.exists() ? summaryDoc.data() : { totalFees:0 };
        // transactions
        const txSnap = await getDocs(collection(db,'finance',uid,'transactions'));
        let totalPaid = 0;
        const list = [];
        txSnap.forEach(d=>{
          const t = d.data();
          if (t.status === 'Confirmed') totalPaid += (t.amount||0);
          list.push(t);
        });
        const balance = (totals.totalFees || 0) - totalPaid;
        document.getElementById('fin_total').textContent = 'KES ' + (totals.totalFees||0).toLocaleString();
        document.getElementById('fin_paid').textContent = 'KES ' + totalPaid.toLocaleString();
        document.getElementById('fin_balance').textContent = 'KES ' + balance.toLocaleString();
        document.getElementById('fin_panel').classList.remove('hidden');
        const listEl = document.getElementById('txn_list');
        listEl.innerHTML = list.length ? list.map(t=>`<div class="p-2 border-b">${escapeHtml(t.method||'-')} | ${escapeHtml(t.reference||'-')} | KES ${(t.amount||0).toLocaleString()} | ${escapeHtml(t.status||'-')}</div>`).join('') : '<div class="text-gray-500 p-2">No transactions</div>';
      } catch (e) { console.error(e); showPopup('Error loading finance: '+e.message,'error'); }
    });
    document.getElementById('txn_add').addEventListener('click', async ()=>{
      if (!fin_loaded_uid) return showPopup('Load a student first','error');
      const payload = {
        method: document.getElementById('txn_method').value.trim(),
        reference: document.getElementById('txn_reference').value.trim(),
        amount: Number(document.getElementById('txn_amount').value) || 0,
        status: document.getElementById('txn_status').value,
        date: serverTimestamp()
      };
      try {
        await addDoc(collection(db,'finance',fin_loaded_uid,'transactions'), payload);
        showPopup('Transaction added','success');
        document.getElementById('fin_load').click();
      } catch (e) { console.error(e); showPopup('Error adding txn: '+e.message,'error'); }
    });

    /* ========== GRADES ========== */
    let gradesLoadedUid = '';
    document.getElementById('grades_load').addEventListener('click', async ()=>{
      const uid = document.getElementById('grades_uid').value.trim();
      if (!uid) return showPopup('Enter UID','error');
      gradesLoadedUid = uid;
      try {
        const snap = await getDocs(collection(db,'grades',uid,'results'));
        const out = [];
        snap.forEach(d=> out.push(d.data()));
        document.getElementById('grades_panel').classList.remove('hidden');
        document.getElementById('grades_list').innerHTML = out.length ? out.map(r=>`<div class="p-2 border-b">${escapeHtml(r.code)} - ${escapeHtml(r.title)} | ${escapeHtml(r.grade)} | ${r.gpaPoints}</div>`).join('') : '<div class="text-gray-500 p-2">No results</div>';
      } catch (e) { console.error(e); showPopup('Error loading grades: '+e.message,'error'); }
    });
    document.getElementById('gr_save').addEventListener('click', async ()=>{
      if (!gradesLoadedUid) return showPopup('Load student first','error');
      const id = document.getElementById('gr_code').value.trim();
      if (!id) return showPopup('Enter course code','error');
      const payload = {
        code: id,
        title: document.getElementById('gr_title').value.trim(),
        credits: Number(document.getElementById('gr_credits').value) || 0,
        grade: document.getElementById('gr_grade').value.trim(),
        gpaPoints: Number(document.getElementById('gr_points').value) || 0,
        year: Number(document.getElementById('gr_year').value) || 0,
        semester: Number(document.getElementById('gr_sem').value) || 0,
        updatedAt: serverTimestamp()
      };
      try {
        await setDoc(doc(db,'grades',gradesLoadedUid,'results',id), payload, { merge:true });
        showPopup('Result saved','success');
        document.getElementById('grades_load').click();
      } catch (e) { console.error(e); showPopup('Error saving result: '+e.message,'error'); }
    });

    /* ========== GRADUATION ========== */
    async function loadGraduation(){
      const tbody = document.getElementById('graduation_tbody');
      tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Loading‚Ä¶</td></tr>';
      try {
        const snap = await getDocs(collection(db,'graduationRequests'));
        tbody.innerHTML = '';
        snap.forEach(d=>{
          const g = d.data();
          const tr = document.createElement('tr');
          const req = g.requestedAt?.toDate ? g.requestedAt.toDate().toLocaleString() : '-';
          tr.innerHTML = `<td class="p-2 border">${escapeHtml(g.email||d.id)}</td><td class="p-2 border">${escapeHtml(g.status||'')}</td><td class="p-2 border">${req}</td><td class="p-2 border">
            <button data-id="${d.id}" class="grad_approve bg-green-600 text-white px-2 py-1 rounded text-xs">Approve</button>
            <button data-id="${d.id}" class="grad_reject ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Reject</button>
          </td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.grad_approve').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            await updateDoc(doc(db,'graduationRequests',btn.dataset.id), { status: 'approved', updatedAt: serverTimestamp() });
            showPopup('Graduation approved','success');
            loadGraduation(); refreshDashboardStats();
          });
        });
        document.querySelectorAll('.grad_reject').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            await updateDoc(doc(db,'graduationRequests',btn.dataset.id), { status: 'rejected', updatedAt: serverTimestamp() });
            showPopup('Graduation rejected','success');
            loadGraduation(); refreshDashboardStats();
          });
        });
      } catch (e) { console.error(e); tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-red-600">Error</td></tr>`; showPopup('Error loading graduation: '+e.message,'error'); }
    }
    document.getElementById('grad_refresh').addEventListener('click', loadGraduation);

    /* ========== HOSTELS & ROOMS ========== */
    async function loadHostels(){
      const container = document.getElementById('hostels_list');
      container.innerHTML = 'Loading‚Ä¶';
      try {
        const snap = await getDocs(collection(db,'hostels'));
        container.innerHTML = '';
        if (snap.empty) container.textContent = 'No hostels';
        else {
          snap.forEach(d=>{
            const h = d.data();
            const div = document.createElement('div');
            div.className = 'p-3 border-b flex justify-between items-center';
            div.innerHTML = `<div><div class="font-semibold">${escapeHtml(h.name||d.id)}</div><div class="text-xs text-gray-500">Cap: ${h.capacity||0} | Avail: ${h.available||0}</div></div>
              <div>
                <button data-id="${d.id}" class="hostel_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
                <button data-id="${d.id}" class="hostel_del ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
                <button data-id="${d.id}" class="hostel_rooms ml-1 bg-gray-200 px-2 py-1 rounded text-xs">Rooms</button>
              </div>`;
            container.appendChild(div);
          });
          document.querySelectorAll('.hostel_edit').forEach(btn=>{
            btn.addEventListener('click', async ()=> {
              const id = btn.dataset.id;
              const snapH = await getDoc(doc(db,'hostels',id));
              if (!snapH.exists()) return showPopup('Hostel not found','error');
              const h = snapH.data();
              document.getElementById('hostel_id').value = id;
              document.getElementById('hostel_name').value = h.name || '';
              document.getElementById('hostel_gender').value = h.gender || '';
              document.getElementById('hostel_capacity').value = h.capacity || 0;
              document.getElementById('hostel_available').value = h.available || 0;
              document.getElementById('room_hostelId').value = id;
              showPopup('Hostel loaded','info');
            });
          });
          document.querySelectorAll('.hostel_del').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              if (!confirm('Delete hostel?')) return;
              await deleteDoc(doc(db,'hostels',btn.dataset.id));
              showPopup('Hostel deleted','success');
              loadHostels();
            });
          });
          document.querySelectorAll('.hostel_rooms').forEach(btn=>{
            btn.addEventListener('click', ()=> {
              document.getElementById('room_hostelId').value = btn.dataset.id;
              loadRooms(btn.dataset.id);
            });
          });
        }
      } catch (e) { console.error(e); container.innerHTML = '<div class="text-red-600">Error</div>'; showPopup('Error loading hostels: '+e.message,'error'); }
    }
    document.getElementById('hostels_refresh').addEventListener('click', loadHostels);

    document.getElementById('hostel_save').addEventListener('click', async ()=>{
      const id = document.getElementById('hostel_id').value.trim();
      const payload = {
        name: document.getElementById('hostel_name').value.trim(),
        gender: document.getElementById('hostel_gender').value.trim(),
        capacity: Number(document.getElementById('hostel_capacity').value) || 0,
        available: Number(document.getElementById('hostel_available').value) || 0,
        updatedAt: serverTimestamp()
      };
      try {
        if (id) {
          await updateDoc(doc(db,'hostels',id), payload);
          showPopup('Hostel updated','success');
        } else {
          await addDoc(collection(db,'hostels'), { ...payload, createdAt: serverTimestamp() });
          showPopup('Hostel created','success');
        }
        document.getElementById('hostel_id').value='';
        loadHostels();
      } catch (e) { console.error(e); showPopup('Error saving hostel: '+e.message,'error'); }
    });

    // rooms
    async function loadRooms(hostelId){
      if (!hostelId) return showPopup('hostelId required','error');
      const list = document.getElementById('rooms_list');
      list.innerHTML = 'Loading‚Ä¶';
      try {
        const snap = await getDocs(collection(db,'hostels',hostelId,'rooms'));
        list.innerHTML = '';
        if (snap.empty) list.textContent = 'No rooms';
        else {
          snap.forEach(d=>{
            const r = d.data();
            const div = document.createElement('div');
            div.className = 'p-2 border-b flex justify-between items-center';
            div.innerHTML = `<div>${escapeHtml(r.number||d.id)} ‚Äî ${r.occupants||0}/${r.capacity||0}</div>
              <div>
                <button data-id="${d.id}" data-hostel="${hostelId}" class="room_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
                <button data-id="${d.id}" data-hostel="${hostelId}" class="room_del ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
              </div>`;
            list.appendChild(div);
          });
          document.querySelectorAll('.room_edit').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const h = btn.dataset.hostel;
              const rId = btn.dataset.id;
              const snap = await getDoc(doc(db,'hostels',h,'rooms',rId));
              if (!snap.exists()) return showPopup('Room not found','error');
              const r = snap.data();
              document.getElementById('room_id').value = rId;
              document.getElementById('room_hostelId').value = h;
              document.getElementById('room_number').value = r.number || '';
              document.getElementById('room_capacity').value = r.capacity || 0;
              document.getElementById('room_occupants').value = r.occupants || 0;
              showPopup('Room loaded','info');
            });
          });
          document.querySelectorAll('.room_del').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const h = btn.dataset.hostel;
              const rId = btn.dataset.id;
              if (!confirm('Delete room?')) return;
              await deleteDoc(doc(db,'hostels',h,'rooms',rId));
              showPopup('Room deleted','success');
              loadRooms(h);
            });
          });
        }
      } catch (e) { console.error(e); list.innerHTML = '<div class="text-red-600">Error</div>'; showPopup('Error loading rooms: '+e.message,'error'); }
    }
    document.getElementById('room_load').addEventListener('click', ()=> {
      const h = document.getElementById('room_hostelId').value.trim();
      if (!h) return showPopup('Enter hostelId','error');
      loadRooms(h);
    });
    document.getElementById('room_save').addEventListener('click', async ()=>{
      const h = document.getElementById('room_hostelId').value.trim();
      if (!h) return showPopup('Enter hostelId','error');
      const id = document.getElementById('room_id').value.trim();
      const payload = {
        number: document.getElementById('room_number').value.trim(),
        capacity: Number(document.getElementById('room_capacity').value) || 0,
        occupants: Number(document.getElementById('room_occupants').value) || 0,
        updatedAt: serverTimestamp()
      };
      try {
        if (id) {
          await updateDoc(doc(db,'hostels',h,'rooms',id), payload);
          showPopup('Room updated','success');
        } else {
          await addDoc(collection(db,'hostels',h,'rooms'), payload);
          showPopup('Room created','success');
        }
        document.getElementById('room_id').value='';
        loadRooms(h);
      } catch (e) { console.error(e); showPopup('Error saving room: '+e.message,'error'); }
    });

    // recalc availability
    document.getElementById('hostels_recalc').addEventListener('click', async ()=>{
      try {
        const hostelsSnap = await getDocs(collection(db,'hostels'));
        for (const hdoc of hostelsSnap.docs) {
          let sum = 0;
          const roomsSnap = await getDocs(collection(db,'hostels',hdoc.id,'rooms'));
          roomsSnap.forEach(r=> sum += (r.data().occupants||0));
          const capacity = hdoc.data().capacity || 0;
          const available = Math.max(0, capacity - sum);
          await updateDoc(doc(db,'hostels',hdoc.id), { available });
        }
        showPopup('Availability recalculated','success');
        loadHostels();
      } catch (e) { console.error(e); showPopup('Error recalculating: '+e.message,'error'); }
    });

    /* ========== TIMETABLE (timetable/{uid}) ========== */
    document.getElementById('timetable_load').addEventListener('click', async ()=>{
      const uid = document.getElementById('timetable_uid').value.trim();
      if (!uid) return showPopup('Enter UID','error');
      try {
        const snap = await getDoc(doc(db,'timetable',uid));
        if (!snap.exists()) {
          document.getElementById('timetable_json').value = '[]';
          showPopup('No timetable found; editing blank JSON','info');
        } else {
          const schedule = snap.data().schedule || [];
          document.getElementById('timetable_json').value = JSON.stringify(schedule, null, 2);
        }
        document.getElementById('timetable_panel').classList.remove('hidden');
      } catch (e) { console.error(e); showPopup('Error loading timetable: '+e.message,'error'); }
    });
    document.getElementById('timetable_save').addEventListener('click', async ()=>{
      const uid = document.getElementById('timetable_uid').value.trim();
      if (!uid) return showPopup('Enter UID','error');
      try {
        const schedule = JSON.parse(document.getElementById('timetable_json').value || '[]');
        await setDoc(doc(db,'timetable',uid), { schedule, updatedAt: serverTimestamp() }, { merge:true });
        showPopup('Timetable saved','success');
      } catch (e) { console.error(e); showPopup('Invalid JSON or error saving: '+e.message,'error'); }
    });

    /* ========== PROFILE SEARCH & UPDATE ========== */
    document.getElementById('profile_search_btn').addEventListener('click', async ()=>{
      const q = document.getElementById('profile_search').value.trim();
      if (!q) return showPopup('Enter search term','error');
      try {
        let results = [];
        // search email
        const q1 = query(collection(db,'students'), where('email','==',q));
        const s1 = await getDocs(q1);
        s1.forEach(d=> results.push({ id: d.id, ...d.data() }));
        // search admissionNo
        const q2 = query(collection(db,'students'), where('admissionNo','==',q));
        const s2 = await getDocs(q2);
        s2.forEach(d=> results.push({ id: d.id, ...d.data() }));
        // search regNo
        const q3 = query(collection(db,'students'), where('regNo','==',q));
        const s3 = await getDocs(q3);
        s3.forEach(d=> results.push({ id: d.id, ...d.data() }));

        const container = document.getElementById('profile_result');
        container.innerHTML = '';
        if (!results.length) { container.innerHTML = '<div class="text-gray-500 p-2">No match</div>'; container.classList.remove('hidden'); return; }
        results.forEach(r=>{
          const div = document.createElement('div');
          div.className = 'p-3 border-b';
          div.innerHTML = `<div class="font-semibold">${escapeHtml(r.name)}</div>
            <div class="text-xs text-gray-600">admissionNo: ${escapeHtml(r.admissionNo)} | regNo: ${escapeHtml(r.regNo)} | email: ${escapeHtml(r.email)}</div>
            <div class="mt-2">
              <button data-id="${r.id}" class="profile_edit bg-blue-600 text-white px-3 py-1 rounded">Edit</button>
            </div>`;
          container.appendChild(div);
        });
        document.querySelectorAll('.profile_edit').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.dataset.id;
            const sSnap = await getDoc(doc(db,'students',id));
            if (!sSnap.exists()) return showPopup('Student not found','error');
            const s = sSnap.data();
            // populate student form for editing
            document.getElementById('stu_id').value = id;
            document.getElementById('stu_name').value = s.name || '';
            document.getElementById('stu_admissionNo').value = s.admissionNo || '';
            document.getElementById('stu_email').value = s.email || '';
            document.getElementById('stu_regNo').value = s.regNo || '';
            document.getElementById('stu_programme').value = s.programme || '';
            document.getElementById('stu_yearOfStudy').value = s.yearOfStudy || '';
            document.getElementById('stu_campus').value = s.campus || '';
            document.getElementById('stu_address').value = s.address || '';
            document.getElementById('stu_isActive').checked = !!s.isActive;
            showView('students');
            showPopup('Loaded for editing','info');
          });
        });
        container.classList.remove('hidden');
      } catch (e) { console.error(e); showPopup('Error searching: '+e.message,'error'); }
    });

    /* ========== SETTINGS (password reset) ========== */
    document.getElementById('reset_send').addEventListener('click', async ()=>{
      const email = document.getElementById('reset_email').value.trim();
      if (!email) return showPopup('Enter email','error');
      try {
        await sendPasswordResetEmail(auth, email);
        showPopup('Password reset email sent','success');
      } catch (e) {
        console.error(e);
        showPopup('Error sending reset: '+e.message,'error');
      }
    });

    /* ========== Utilities & initial load ========== */
    function escapeHtml(s='') {
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // initial
    (async function init(){
      showView('dashboard');
      await refreshDashboardStats();
      await loadStudents();
      await loadAdmins();
      await loadCourses();
      await loadClearance();
      await loadGraduation();
      await loadHostels();
    })();

  </script>
</body>
</html>
