<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard | Prince Alex Design University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f7f6; }
        .btn-primary { background: #0d6efd; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
        .btn-primary:hover { background: #0b5ed7; }
        .btn-red { background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
        .btn-red:hover { background: #bb2d3b; }
        .btn-green { background: #28a745; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
        .btn-green:hover { background: #218838; }
        
        #sidebar a { padding: 0.75rem; border-radius: 4px; display: block; margin-bottom: 0.5rem; transition: background-color 0.2s; }
        #sidebar a:hover { background-color: #e2e8f0; }
        #sidebar a.active { background-color: #d1e7ff; color: #0d6efd; font-weight: 600; }

        .admin-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .section-title { font-size: 1.75rem; font-weight: bold; color: #1a202c; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.75rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #e2e8f0; padding: 0.75rem; text-align: left; }
        th { background-color: #f1f5f9; font-weight: 600; color: #334155; }
        tr:nth-child(even) { background-color: #f8fafc; }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #334155; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-badge.pending { background-color: #fefcbf; color: #8a6d3b; }
        .status-badge.approved { background-color: #d1fae5; color: #065f46; }
        .status-badge.rejected { background-color: #fee2e2; color: #991b1b; }
        .status-badge.active { background-color: #d1fae5; color: #065f46; } /* Hostel status */
        .status-badge.full { background-color: #fee2e2; color: #991b1b; } /* Hostel status */
        .status-badge.available { background-color: #d1fae5; color: #065f46; } /* Hostel status */
        .status-badge.cleared { background-color: #d1fae5; color: #065f46; } /* Finance status */
        .status-badge.inactive { background-color: #e0e0e0; color: #757575; } /* Student status */

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #0d6efd; /* Theme blue spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 10px;
            font-weight: 500;
            color: #0d6efd;
        }
        /* Custom Alert/Confirm Modal Styles */
        .custom-alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than other modals */
        }
        .custom-alert-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .custom-alert-content p {
            margin-bottom: 0; /* Remove default paragraph margin */
            font-size: 1.1em;
            color: #1a1a1a; /* Default text color */
        }
        .custom-alert-content button {
            background-color: #0d6efd; /* Primary blue for OK button */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color .3s ease;
        }
        .custom-alert-content button:hover {
            background-color: #0a58ca;
        }
        /* Specific styles for alert types */
        .custom-alert-content.error {
            background-color: #dc3545; /* Red for error */
            color: white;
        }
        .custom-alert-content.success {
            background-color: #28a745; /* Green for success */
            color: white;
        }
        .custom-alert-content.info {
            background-color: #002d6b; /* Dark Blue for info */
            color: white;
        }
        .admin-stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease-in-out;
            min-height: 150px;
            justify-content: center;
        }
        .admin-stat-card:hover {
            transform: translateY(-5px);
        }
        .admin-stat-card .icon {
            font-size: 2.5rem;
            color: #0d6efd;
            margin-bottom: 0.5rem;
        }
        .admin-stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1a1a1a;
        }
        .admin-stat-card .label {
            font-size: 0.9rem;
            color: #555;
            margin-top: 0.2rem;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text">Loading admin dashboard...</div>
    </div>

    <header class="p-4 flex justify-between items-center shadow-md bg-white sticky top-0 z-50">
        <img src="myschoollogo.png" alt="Logo" class="h-12">
        <div class="flex items-center space-x-4">
            <span id="adminEmail" class="text-blue-600 font-bold"></span>
            <button id="logoutBtn" class="btn-red"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </header>

    <div class="flex flex-grow">
        <nav id="sidebar" class="w-64 bg-white border-r p-4 hidden md:block overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-blue-800">Admin Menu</h3>
            <a href="#" class="active" onclick="showSection('adminDashboard')"><i class="fas fa-chart-line mr-2"></i> Dashboard</a>
            <a href="#" onclick="showSection('createStudent')"><i class="fas fa-user-plus mr-2"></i> Create Student</a>
            <a href="#" onclick="showSection('manageStudents')"><i class="fas fa-users mr-2"></i> Students</a>
            <a href="#" onclick="showSection('manageCourses')"><i class="fas fa-book-open mr-2"></i> Courses</a>
            <a href="#" onclick="showSection('manageTimetable')"><i class="fas fa-calendar-alt mr-2"></i> Timetable</a>
            <a href="#" onclick="showSection('manageGrades')"><i class="fas fa-award mr-2"></i> Grades</a>
            <a href="#" onclick="showSection('manageExamSchedule')"><i class="fas fa-clipboard-list mr-2"></i> Exam Cards</a>
            <a href="#" onclick="showSection('manageAnnouncements')"><i class="fas fa-bullhorn mr-2"></i> Announcements</a>
            <a href="#" onclick="showSection('manageHostels')"><i class="fas fa-hotel mr-2"></i> Hostels</a>
            <a href="#" onclick="showSection('manageGraduation')"><i class="fas fa-graduation-cap mr-2"></i> Graduation Requests</a>
            <a href="#" onclick="showSection('manageClearance')"><i class="fas fa-check-double mr-2"></i> Clearance Requests</a>
            <a href="#" onclick="showSection('manageFinance')"><i class="fas fa-wallet mr-2"></i> Finance</a>
            <a href="#" onclick="showSection('manageAdmins')"><i class="fas fa-user-shield mr-2"></i> Admins & Roles</a>
        </nav>

        <main id="adminMainContent" class="flex-grow p-6 overflow-y-auto">

            <div id="adminDashboard" class="admin-card">
                <h2 class="section-title">Admin Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="admin-stat-card">
                        <i class="fas fa-users icon"></i>
                        <div id="totalStudents" class="value">0</div>
                        <div class="label">Total Students</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-book-open icon"></i>
                        <div id="totalCourses" class="value">0</div>
                        <div class="label">Active Courses</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-money-bill-wave icon"></i>
                        <div id="totalOutstandingFees" class="value">KES 0</div>
                        <div class="label">Total Outstanding Fees</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-hourglass-half icon"></i>
                        <div id="pendingGraduations" class="value">0</div>
                        <div class="label">Pending Grad Requests</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-clipboard-check icon"></i>
                        <div id="pendingClearances" class="value">0</div>
                        <div class="label">Pending Clearance</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-hotel icon"></i>
                        <div id="availableHostelRooms" class="value">0</div>
                        <div class="label">Available Hostel Rooms</div>
                    </div>
                </div>
            </div>

            <div id="createStudent" class="admin-card hidden">
                <h2 class="section-title">Create New Student Account</h2>
                <form id="createStudentForm" class="space-y-4">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newStudentName">Full Name</label>
                            <input type="text" id="newStudentName" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentEmail">Email</label>
                            <input type="email" id="newStudentEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentAdmissionNo">Admission Number</label>
                            <input type="text" id="newStudentAdmissionNo" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentPassword">Password</label>
                            <input type="password" id="newStudentPassword" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Create Student Account</button>
                </form>
            </div>

            <div id="manageStudents" class="admin-card hidden">
                <h2 class="section-title">Manage Students</h2>
                <div class="mb-4 flex flex-col sm:flex-row gap-2 items-center">
                    <input type="text" id="studentSearchInput" placeholder="Search by name, email, or admission no." class="p-2 border rounded-md flex-grow">
                    <button onclick="searchStudents()" class="btn-primary">Search</button>
                    <button onclick="loadStudents()" class="btn-primary">Clear Search</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Admission No</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Program</th>
                                <th>Year/Sem</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading students...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="studentDetailModal" class="custom-alert-modal hidden">
                    <div class="custom-alert-content" style="max-width: 700px; text-align: left; background: white; color: #1a1a1a;">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">Student Details</h3>
                        <form id="editStudentForm" class="space-y-4">
                            <input type="hidden" id="editStudentUid">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editAdmissionNo">Admission No</label>
                                    <input type="text" id="editAdmissionNo" required>
                                </div>
                                <div class="form-group">
                                    <label for="editName">Full Name</label>
                                    <input type="text" id="editName" required>
                                </div>
                                <div class="form-group">
                                    <label for="editEmail">Email</label>
                                    <input type="email" id="editEmail" readonly class="bg-gray-100">
                                </div>
                                <div class="form-group">
                                    <label for="editPhone">Phone Number</label>
                                    <input type="text" id="editPhone">
                                </div>
                                <div class="form-group">
                                    <label for="editDob">Date of Birth</label>
                                    <input type="date" id="editDob">
                                </div>
                                <div class="form-group">
                                    <label for="editGender">Gender</label>
                                    <select id="editGender">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editAddress">Address</label>
                                    <textarea id="editAddress" rows="2"></textarea>
                                </div>
                                <div class="col-span-full">
                                    <h4 class="text-lg font-semibold text-blue-600 mt-4 mb-2">Guardian Information</h4>
                                </div>
                                <div class="form-group">
                                    <label for="editGuardianName">Guardian Name</label>
                                    <input type="text" id="editGuardianName">
                                </div>
                                <div class="form-group">
                                    <label for="editGuardianPhone">Guardian Phone</label>
                                    <input type="text" id="editGuardianPhone">
                                </div>
                                <div class="form-group">
                                    <label for="editGuardianRelation">Relationship</label>
                                    <input type="text" id="editGuardianRelation">
                                </div>
                                <div class="col-span-full">
                                    <h4 class="text-lg font-semibold text-blue-600 mt-4 mb-2">Academic Information</h4>
                                </div>
                                <div class="form-group">
                                    <label for="editProgram">Program</label>
                                    <input type="text" id="editProgram">
                                </div>
                                <div class="form-group">
                                    <label for="editYear">Year</label>
                                    <select id="editYear">
                                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editSemester">Semester</label>
                                    <select id="editSemester">
                                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editEnrollmentDate">Enrollment Date</label>
                                    <input type="text" id="editEnrollmentDate" readonly class="bg-gray-100">
                                </div>
                                <div class="form-group flex items-center gap-2 mt-4 col-span-full">
                                    <input type="checkbox" id="editIsActive" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="editIsActive" class="mb-0">Account Active</label>
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeModal('studentDetailModal')" class="btn-red">Cancel</button>
                                <button type="submit" class="btn-primary">Save Changes</button>
                            </div>
                        </form>
                        <div class="flex justify-start gap-2 mt-4 pt-4 border-t border-gray-200">
                            <button onclick="resetStudentPassword(document.getElementById('editStudentUid').value, document.getElementById('editEmail').value)" class="btn-primary"><i class="fas fa-redo mr-2"></i> Reset Password</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="manageCourses" class="admin-card hidden">
                <h2 class="section-title">Manage Courses</h2>
                <form id="courseForm" class="space-y-4 mb-6">
                    <input type="hidden" id="courseId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="courseCode">Course Code</label>
                            <input type="text" id="courseCode" required>
                        </div>
                        <div class="form-group">
                            <label for="courseTitle">Course Title</label>
                            <input type="text" id="courseTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="courseCredits">Credits</label>
                            <input type="number" id="courseCredits" required>
                        </div>
                        <div class="form-group">
                            <label for="courseLecturer">Lecturer</label>
                            <input type="text" id="courseLecturer" required>
                        </div>
                        <div class="form-group">
                            <label for="courseYear">Year</label>
                            <select id="courseYear" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="courseSemester">Semester</label>
                            <select id="courseSemester" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveCourseBtn">Add Course</button>
                    <button type="button" class="btn-red hidden" id="cancelEditCourseBtn" onclick="resetCourseForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="coursesTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Title</th>
                                <th>Credits</th>
                                <th>Lecturer</th>
                                <th>Year</th>
                                <th>Semester</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading courses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="manageTimetable" class="admin-card hidden">
                <h2 class="section-title">Manage Timetable</h2>
                <form id="timetableForm" class="space-y-4 mb-6">
                    <input type="hidden" id="timetableId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="timetableCourseCode">Course Code</label>
                            <input type="text" id="timetableCourseCode" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableDay">Day</label>
                            <select id="timetableDay" required>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timetableStartTime">Start Time</label>
                            <input type="time" id="timetableStartTime" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableEndTime">End Time</label>
                            <input type="time" id="timetableEndTime" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableVenue">Venue</label>
                            <input type="text" id="timetableVenue" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableLecturer">Lecturer</label>
                            <input type="text" id="timetableLecturer" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableYear">Year</label>
                            <select id="timetableYear" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timetableSemester">Semester</label>
                            <select id="timetableSemester" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveTimetableBtn">Add Timetable Entry</button>
                    <button type="button" class="btn-red hidden" id="cancelEditTimetableBtn" onclick="resetTimetableForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="timetableTable">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Venue</th>
                                <th>Lecturer</th>
                                <th>Year/Sem</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading timetable entries...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="manageGrades" class="admin-card hidden">
                <h2 class="section-title">Manage Grades</h2>
                <div class="mb-4 form-grid">
                    <div class="form-group">
                        <label for="gradeStudentId">Student (UID)</label>
                        <input type="text" id="gradeStudentId" placeholder="Enter Student UID" list="studentUids">
                        <datalist id="studentUids"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="gradeYear">Year</label>
                        <select id="gradeYear">
                            <option value="">Select Year</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gradeSemester">Semester</label>
                        <select id="gradeSemester">
                            <option value="">Select Semester</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        </select>
                    </div>
                </div>
                <button onclick="loadStudentGrades()" class="btn-primary mb-6">Load Student Grades</button>

                <form id="gradeEntryForm" class="space-y-4 mb-6 hidden">
                    <input type="hidden" id="gradeEntryId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="gradeCourseCode">Course Code</label>
                            <input type="text" id="gradeCourseCode" placeholder="Enter Course Code" list="courseCodes" required>
                            <datalist id="courseCodes"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="gradeCourseTitle">Course Title</label>
                            <input type="text" id="gradeCourseTitle" readonly class="bg-gray-100">
                        </div>
                        <div class="form-group">
                            <label for="gradeCredits">Credits</label>
                            <input type="number" id="gradeCredits" readonly class="bg-gray-100">
                        </div>
                        <div class="form-group">
                            <label for="gradeGrade">Grade (A-F)</label>
                            <input type="text" id="gradeGrade" pattern="[A-Fa-f]" maxlength="1" required>
                        </div>
                        <div class="form-group">
                            <label for="gradePoints">GPA Points</label>
                            <input type="number" id="gradePoints" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="gradeLecturer">Lecturer</label>
                            <input type="text" id="gradeLecturer" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveGradeBtn">Save Grade</button>
                    <button type="button" class="btn-red hidden" id="cancelEditGradeBtn" onclick="resetGradeForm()">Cancel Edit</button>
                </form>

                <h3 class="text-xl font-bold text-blue-700 mt-8 mb-4">Grades for Selected Student/Semester</h3>
                <div class="overflow-x-auto">
                    <table id="gradesTable">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Title</th>
                                <th>Credits</th>
                                <th>Grade</th>
                                <th>GPA Points</th>
                                <th>Lecturer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">No grades loaded. Select student, year, and semester.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="manageExamSchedule" class="admin-card hidden">
                <h2 class="section-title">Manage Exam Schedule</h2>
                <form id="examScheduleForm" class="space-y-4 mb-6">
                    <input type="hidden" id="examScheduleId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="examScheduleCourseCode">Course Code</label>
                            <input type="text" id="examScheduleCourseCode" required list="courseCodesExam">
                            <datalist id="courseCodesExam"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleDate">Exam Date</label>
                            <input type="date" id="examScheduleDate" required>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleTime">Exam Time</label>
                            <input type="time" id="examScheduleTime" required>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleVenue">Venue</label>
                            <input type="text" id="examScheduleVenue" required>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleLecturer">Lecturer</label>
                            <input type="text" id="examScheduleLecturer">
                        </div>
                        <div class="form-group">
                            <label for="examScheduleYear">Year</label>
                            <select id="examScheduleYear" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleSemester">Semester</label>
                            <select id="examScheduleSemester" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveExamScheduleBtn">Add Exam Schedule</button>
                    <button type="button" class="btn-red hidden" id="cancelEditExamScheduleBtn" onclick="resetExamScheduleForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="examScheduleTable">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Venue</th>
                                <th>Lecturer</th>
                                <th>Year/Sem</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading exam schedules...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="manageAnnouncements" class="admin-card hidden">
                <h2 class="section-title">Manage Announcements</h2>
                <form id="announcementForm" class="space-y-4 mb-6">
                    <input type="hidden" id="announcementId">
                    <div class="form-group">
                        <label for="announcementTitle">Title</label>
                        <input type="text" id="announcementTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="announcementMessage">Message</label>
                        <textarea id="announcementMessage" rows="5" required></textarea>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="announcementAuthor">Author</label>
                            <input type="text" id="announcementAuthor" required>
                        </div>
                        <div class="form-group">
                            <label for="announcementCategory">Category</label>
                            <select id="announcementCategory" required>
                                <option value="General">General</option>
                                <option value="Academics">Academics</option>
                                <option value="Finance">Finance</option>
                                <option value="Hostel">Hostel</option>
                                <option value="Events">Events</option>
                            </select>
                        </div>
                        <div class="form-group flex items-center gap-2">
                            <input type="checkbox" id="announcementPinned" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="announcementPinned" class="mb-0">Pin to Top</label>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveAnnouncementBtn">Publish Announcement</button>
                    <button type="button" class="btn-red hidden" id="cancelEditAnnouncementBtn" onclick="resetAnnouncementForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="announcementsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Author</th>
                                <th>Date</th>
                                <th>Pinned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" class="text-center text-gray-500 p-4">Loading announcements...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="manageHostels" class="admin-card hidden">
                <h2 class="section-title">Manage Hostels</h2>
                <form id="hostelForm" class="space-y-4 mb-6">
                    <input type="hidden" id="hostelId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="hostelName">Hostel Name</label>
                            <input type="text" id="hostelName" required>
                        </div>
                        <div class="form-group">
                            <label for="hostelType">Type (e.g., Male, Female)</label>
                            <input type="text" id="hostelType" required>
                        </div>
                        <div class="form-group">
                            <label for="hostelCapacity">Total Capacity</label>
                            <input type="number" id="hostelCapacity" required>
                        </div>
                        <div class="form-group">
                            <label for="hostelLocation">Location</label>
                            <input type="text" id="hostelLocation">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveHostelBtn">Add Hostel</button>
                    <button type="button" class="btn-red hidden" id="cancelEditHostelBtn" onclick="resetHostelForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="hostelsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Capacity</th>
                                <th>Location</th>
                                <th>Available Rooms</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" class="text-center text-gray-500 p-4">Loading hostels...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="roomsManagementArea" class="mt-8 pt-6 border-t border-gray-200 hidden">
                    <h3 class="text-xl font-bold text-blue-700 mb-4" id="roomsOfHostelTitle">Rooms in [Hostel Name]</h3>
                    <button type="button" class="btn-primary mb-4" onclick="showHostelsList()"><i class="fas fa-arrow-left mr-2"></i> Back to Hostels</button>

                    <form id="roomForm" class="space-y-4 mb-6">
                        <input type="hidden" id="roomHostelId">
                        <input type="hidden" id="roomId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="roomNo">Room Number</label>
                                <input type="text" id="roomNo" required>
                            </div>
                            <div class="form-group">
                                <label for="roomCapacity">Capacity (beds)</label>
                                <input type="number" id="roomCapacity" required>
                            </div>
                            <div class="form-group" id="roomAvailableSlotsDisplay" style="display:none;">
                                <label>Available Slots</label>
                                <span id="displayAvailableSlots" class="block p-2 border rounded-md bg-gray-100 text-gray-700"></span>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" id="saveRoomBtn">Add Room</button>
                        <button type="button" class="btn-red hidden" id="cancelEditRoomBtn" onclick="resetRoomForm()">Cancel Edit</button>
                    </form>

                    <div class="overflow-x-auto">
                        <table id="roomsTable">
                            <thead>
                                <tr>
                                    <th>Room No</th>
                                    <th>Capacity</th>
                                    <th>Available Slots</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="text-center text-gray-500 p-4">Loading rooms...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="manageGraduation" class="admin-card hidden">
                <h2 class="section-title">Manage Graduation Requests</h2>
                <div class="overflow-x-auto">
                    <table id="graduationRequestsTable">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Admission No</th>
                                <th>Program</th>
                                <th>Date Submitted</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" class="text-center text-gray-500 p-4">Loading graduation requests...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="graduationDetailModal" class="custom-alert-modal hidden">
                    <div class="custom-alert-content" style="max-width: 700px; text-align: left; background: white; color: #1a1a1a;">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">Graduation Request Details</h3>
                        <p><strong>Student Name:</strong> <span id="gradModalStudentName"></span></p>
                        <p><strong>Admission No:</strong> <span id="gradModalAdmNo"></span></p>
                        <p><strong>Program:</strong> <span id="gradModalProgram"></span></p>
                        <p><strong>Date Submitted:</strong> <span id="gradModalDateSubmitted"></span></p>
                        <p class="mb-4"><strong>Current Status:</strong> <span id="gradModalCurrentStatus" class="status-badge"></span></p>
                        <h4 class="font-bold text-blue-600 mt-4 mb-2">Uploaded Documents:</h4>
                        <ul id="gradModalDocuments" class="list-disc ml-5 mb-4">
                            </ul>
                        <form id="updateGradStatusForm" class="space-y-4">
                            <input type="hidden" id="gradModalUid">
                            <div class="form-group">
                                <label for="gradModalStatus">Update Status</label>
                                <select id="gradModalStatus" required>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gradModalComments">Admin Comments</label>
                                <textarea id="gradModalComments" rows="3"></textarea>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeModal('graduationDetailModal')" class="btn-red">Cancel</button>
                                <button type="submit" class="btn-primary">Update Status</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="manageClearance" class="admin-card hidden">
                <h2 class="section-title">Manage Clearance Requests</h2>
                <div class="overflow-x-auto">
                    <table id="clearanceRequestsTable">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Admission No</th>
                                <th>Date Submitted</th>
                                <th>Overall Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center text-gray-500 p-4">Loading clearance requests...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="clearanceDetailModal" class="custom-alert-modal hidden">
                    <div class="custom-alert-content" style="max-width: 800px; text-align: left; background: white; color: #1a1a1a;">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">Clearance Request Details</h3>
                        <p><strong>Student Name:</strong> <span id="clearanceModalStudentName"></span></p>
                        <p><strong>Admission No:</strong> <span id="clearanceModalAdmNo"></span></p>
                        <p class="mb-4"><strong>Date Submitted:</strong> <span id="clearanceModalDateSubmitted"></span></p>
                        <p class="mb-4"><strong>Overall Status:</strong> <span id="clearanceModalOverallStatus" class="status-badge"></span></p>
                        <h4 class="font-bold text-blue-600 mt-4 mb-2">Departmental Approvals:</h4>
                        <form id="updateClearanceStatusForm" class="space-y-4">
                            <input type="hidden" id="clearanceModalUid">
                            <div id="departmentApprovalForms" class="space-y-3">
                                </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeModal('clearanceDetailModal')" class="btn-red">Cancel</button>
                                <button type="submit" class="btn-primary">Update Approvals</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="manageFinance" class="admin-card hidden">
                <h2 class="section-title">Manage Finance</h2>
                <div class="mb-4 form-grid">
                    <div class="form-group">
                        <label for="financeStudentId">Student (UID)</label>
                        <input type="text" id="financeStudentId" placeholder="Enter Student UID" list="financeStudentUids">
                        <datalist id="financeStudentUids"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="financeAction">Action</label>
                        <select id="financeAction" onchange="toggleFinanceActionFields()">
                            <option value="view">View Statement</option>
                            <option value="addFees">Add Fees</option>
                            <option value="recordPayment">Record Payment</option>
                            <option value="adjustBalance">Adjust Balance</option>
                        </select>
                    </div>
                </div>
                <button onclick="performFinanceAction()" class="btn-primary mb-6">Execute Action</button>
                <div id="financeActionFields" class="space-y-4 hidden">
                    <div id="addFeesFields" class="space-y-4 hidden">
                        <div class="form-group">
                            <label for="feeAmount">Amount</label>
                            <input type="number" id="feeAmount" required>
                        </div>
                        <div class="form-group">
                            <label for="feeDescription">Description</label>
                            <input type="text" id="feeDescription" required>
                        </div>
                        <button type="button" onclick="addFees()" class="btn-green">Add Fees</button>
                    </div>
                    <div id="recordPaymentFields" class="space-y-4 hidden">
                        <div class="form-group">
                            <label for="paymentAmount">Amount</label>
                            <input type="number" id="paymentAmount" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method</label>
                            <input type="text" id="paymentMethod" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentRef">Reference No.</label>
                            <input type="text" id="paymentRef">
                        </div>
                        <button type="button" onclick="recordPayment()" class="btn-green">Record Payment</button>
                    </div>
                    <div id="adjustBalanceFields" class="space-y-4 hidden">
                        <div class="form-group">
                            <label for="adjustmentAmount">Amount (positive for credit, negative for debit)</label>
                            <input type="number" id="adjustmentAmount" required>
                        </div>
                        <div class="form-group">
                            <label for="adjustmentReason">Reason</label>
                            <input type="text" id="adjustmentReason" required>
                        </div>
                        <button type="button" onclick="adjustBalance()" class="btn-green">Adjust Balance</button>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-blue-700 mt-8 mb-4">Student Financial Statement</h3>
                <p id="financeStudentNameDisplay" class="mb-2 hidden"></p>
                <p id="financeBalanceDisplay" class="mb-4 text-lg font-bold hidden"></p>
                <div class="overflow-x-auto">
                    <table id="financeTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount (Credit)</th>
                                <th>Amount (Debit)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center text-gray-500 p-4">Select a student and action.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="manageAdmins" class="admin-card hidden">
                <h2 class="section-title">Manage Admins & Roles</h2>
                <form id="adminForm" class="space-y-4 mb-6">
                    <input type="hidden" id="adminUid">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="adminName">Full Name</label>
                            <input type="text" id="adminName" required>
                        </div>
                        <div class="form-group">
                            <label for="adminEmail">Email</label>
                            <input type="email" id="adminEmailInput" required>
                        </div>
                        <div class="form-group">
                            <label for="adminRole">Role</label>
                            <select id="adminRole" required>
                                <option value="superadmin">Super Admin</option>
                                <option value="admin">Admin</option>
                                <option value="finance">Finance Admin</option>
                                <option value="hostel">Hostel Admin</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveAdminBtn">Add Admin</button>
                    <button type="button" class="btn-red hidden" id="cancelEditAdminBtn" onclick="resetAdminForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="adminsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" class="text-center text-gray-500 p-4">Loading admin accounts...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase config object
        const firebaseConfig = {
            apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
            authDomain: "universityweb-19e1e.firebaseapp.com",
            projectId: "universityweb-19e1e",
            storageBucket: "universityweb-19e1e.appspot.com",
            messagingSenderId: "401942926589",
            appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const firestore = firebase.firestore;
    </script>

    <script>
        (function() {
            // General UI functions
            const loadingOverlay = document.getElementById('loadingOverlay');
            const adminEmailSpan = document.getElementById('adminEmail');
            const mainContent = document.getElementById('adminMainContent');
            const sidebar = document.getElementById('sidebar');
            const sections = mainContent.querySelectorAll('.admin-card');
            let isEditing = false; // A flag to manage edit state

            function showLoading(message = "Loading...") {
                loadingOverlay.classList.remove('hidden');
                document.querySelector('.loading-text').textContent = message;
            }

            function hideLoading() {
                loadingOverlay.classList.add('hidden');
            }

            // Custom Alert/Confirm Modals
            let currentResolve;
            function showCustomAlert(message, type = 'info') {
                const modal = document.createElement('div');
                modal.className = 'custom-alert-modal';
                modal.innerHTML = `
                    <div class="custom-alert-content ${type}">
                        <p>${message}</p>
                        <button onclick="closeModal(this.parentNode.parentNode.id)">OK</button>
                    </div>
                `;
                modal.id = 'temp-alert-modal-' + Date.now();
                document.body.appendChild(modal);
            }

            function showCustomConfirm(message, actionType, resolveFunction) {
                const modal = document.createElement('div');
                modal.className = 'custom-alert-modal';
                modal.innerHTML = `
                    <div class="custom-alert-content info">
                        <p>${message}</p>
                        <div class="flex justify-center gap-4">
                            <button class="btn-red" onclick="closeModal(this.parentNode.parentNode.parentNode.id); window.currentResolve(false);">Cancel</button>
                            <button class="btn-primary" onclick="closeModal(this.parentNode.parentNode.parentNode.id); window.currentResolve(true);">Confirm</button>
                        </div>
                    </div>
                `;
                modal.id = 'temp-confirm-modal-' + Date.now();
                document.body.appendChild(modal);
                window.currentResolve = resolveFunction;
            }

            window.closeModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.remove();
                }
            };

            function showSection(sectionId) {
                sections.forEach(section => section.classList.add('hidden'));
                document.getElementById(sectionId).classList.remove('hidden');
                sidebar.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                sidebar.querySelector(`a[onclick*="${sectionId}"]`).classList.add('active');
            }

            // Authentication & initial data load
            auth.onAuthStateChanged(user => {
                if (user) {
                    adminEmailSpan.textContent = user.email;
                    showLoading("Loading dashboard data...");
                    loadDashboardStats();
                    // Load initial data for first section
                    loadStudents();
                } else {
                    window.location.href = "index.html";
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut().then(() => {
                    showCustomAlert("You have been logged out.", 'info');
                }).catch(error => {
                    showCustomAlert("Logout Failed: " + error.message, 'error');
                });
            });

            // Dashboard
            async function loadDashboardStats() {
                try {
                    const studentCount = (await db.collection('students').get()).size;
                    document.getElementById('totalStudents').textContent = studentCount;

                    const courseCount = (await db.collection('courses').get()).size;
                    document.getElementById('totalCourses').textContent = courseCount;

                    // Placeholder for finance stats
                    // const financeSnapshot = await db.collection('finance').get();
                    // ... calculate total outstanding fees
                    document.getElementById('totalOutstandingFees').textContent = "KES 0 (Placeholder)";

                    const pendingGrads = (await db.collection('graduationRequests').where('status', '==', 'Pending').get()).size;
                    document.getElementById('pendingGraduations').textContent = pendingGrads;

                    const pendingClearances = (await db.collection('clearances').where('overallStatus', '==', 'Pending').get()).size;
                    document.getElementById('pendingClearances').textContent = pendingClearances;

                    const hostelSnapshot = await db.collection('hostels').get();
                    let totalAvailableRooms = 0;
                    hostelSnapshot.forEach(doc => {
                        const data = doc.data();
                        totalAvailableRooms += data.availableRooms || 0;
                    });
                    document.getElementById('availableHostelRooms').textContent = totalAvailableRooms;
                    
                } catch(e) {
                    console.error("Error loading dashboard stats:", e);
                    showCustomAlert("Failed to load dashboard stats.", 'error');
                } finally {
                    hideLoading();
                }
            }

            // Student management
            async function loadStudents() {
                showLoading("Loading student data...");
                const studentsTableBody = document.getElementById('studentsTable').querySelector('tbody');
                studentsTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading students...</td></tr>';
                try {
                    const studentsSnapshot = await db.collection('students').orderBy('admissionNo').get();
                    studentsTableBody.innerHTML = '';
                    if (studentsSnapshot.empty) {
                        studentsTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">No students found.</td></tr>';
                    } else {
                        studentsSnapshot.forEach(doc => {
                            const student = doc.data();
                            const row = studentsTableBody.insertRow();
                            row.innerHTML = `
                                <td>${student.admissionNo}</td>
                                <td>${student.fullName}</td>
                                <td>${student.email}</td>
                                <td>${student.program || 'N/A'}</td>
                                <td>${student.year}/${student.semester}</td>
                                <td><span class="status-badge ${student.isActive ? 'active' : 'inactive'}">${student.isActive ? 'Active' : 'Inactive'}</span></td>
                                <td class="space-x-2">
                                    <button onclick="editStudent('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteStudent('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                    hideLoading();
                } catch (e) {
                    console.error("Error loading students:", e);
                    showCustomAlert("Failed to load student data.", 'error');
                    studentsTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">Failed to load data.</td></tr>';
                    hideLoading();
                }
            }

            // Student CRUD
            window.editStudent = async function(uid) {
                showLoading("Loading student details...");
                try {
                    const docRef = db.collection('students').doc(uid);
                    const docSnap = await docRef.get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('editStudentUid').value = uid;
                        document.getElementById('editAdmissionNo').value = data.admissionNo || '';
                        document.getElementById('editName').value = data.fullName || '';
                        document.getElementById('editEmail').value = data.email || '';
                        document.getElementById('editPhone').value = data.phoneNumber || '';
                        document.getElementById('editDob').value = data.dateOfBirth || '';
                        document.getElementById('editGender').value = data.gender || '';
                        document.getElementById('editAddress').value = data.address || '';
                        document.getElementById('editGuardianName').value = data.guardianName || '';
                        document.getElementById('editGuardianPhone').value = data.guardianPhone || '';
                        document.getElementById('editGuardianRelation').value = data.guardianRelation || '';
                        document.getElementById('editProgram').value = data.program || '';
                        document.getElementById('editYear').value = data.year || '';
                        document.getElementById('editSemester').value = data.semester || '';
                        document.getElementById('editEnrollmentDate').value = data.enrollmentDate || '';
                        document.getElementById('editIsActive').checked = data.isActive || false;
                        document.getElementById('studentDetailModal').classList.remove('hidden');
                    } else {
                        showCustomAlert("Student not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing student:", e);
                    showCustomAlert("Failed to load student details for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteStudent = async function(uid) {
                showCustomConfirm("Are you sure you want to delete this student and all their data?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting student data...");
                    try {
                        await db.collection('students').doc(uid).delete();
                        await db.collection('grades').doc(uid).delete();
                        showCustomAlert("Student deleted successfully!", 'success');
                        loadStudents();
                    } catch (e) {
                        console.error("Error deleting student:", e);
                        showCustomAlert("Failed to delete student.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving student changes...");
                const uid = document.getElementById('editStudentUid').value;
                const data = {
                    admissionNo: document.getElementById('editAdmissionNo').value,
                    fullName: document.getElementById('editName').value,
                    phoneNumber: document.getElementById('editPhone').value,
                    dateOfBirth: document.getElementById('editDob').value,
                    gender: document.getElementById('editGender').value,
                    address: document.getElementById('editAddress').value,
                    guardianName: document.getElementById('editGuardianName').value,
                    guardianPhone: document.getElementById('editGuardianPhone').value,
                    guardianRelation: document.getElementById('editGuardianRelation').value,
                    program: document.getElementById('editProgram').value,
                    year: document.getElementById('editYear').value,
                    semester: document.getElementById('editSemester').value,
                    isActive: document.getElementById('editIsActive').checked
                };
                try {
                    await db.collection('students').doc(uid).update(data);
                    showCustomAlert("Student updated successfully!", 'success');
                    closeModal('studentDetailModal');
                    loadStudents();
                } catch (e) {
                    console.error("Error updating student:", e);
                    showCustomAlert("Failed to save student changes.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Course management
            async function loadCourses() {
                showLoading("Loading courses...");
                const coursesTableBody = document.getElementById('coursesTable').querySelector('tbody');
                coursesTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading courses...</td></tr>';
                try {
                    const coursesSnapshot = await db.collection('courses').get();
                    coursesTableBody.innerHTML = '';
                    if (coursesSnapshot.empty) {
                        coursesTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">No courses found.</td></tr>';
                    } else {
                        coursesSnapshot.forEach(doc => {
                            const course = doc.data();
                            const row = coursesTableBody.insertRow();
                            row.innerHTML = `
                                <td>${course.courseCode}</td>
                                <td>${course.courseTitle}</td>
                                <td>${course.credits}</td>
                                <td>${course.lecturer}</td>
                                <td>${course.year}</td>
                                <td>${course.semester}</td>
                                <td class="space-x-2">
                                    <button onclick="editCourse('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteCourse('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading courses:", e);
                    showCustomAlert("Failed to load course data.", 'error');
                } finally {
                    hideLoading();
                }
            }

            // Course CRUD
            window.editCourse = async function(id) {
                showLoading("Loading course details...");
                try {
                    const docSnap = await db.collection('courses').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('courseId').value = id;
                        document.getElementById('courseCode').value = data.courseCode;
                        document.getElementById('courseTitle').value = data.courseTitle;
                        document.getElementById('courseCredits').value = data.credits;
                        document.getElementById('courseLecturer').value = data.lecturer;
                        document.getElementById('courseYear').value = data.year;
                        document.getElementById('courseSemester').value = data.semester;
                        document.getElementById('saveCourseBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditCourseBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Course not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing course:", e);
                    showCustomAlert("Failed to load course details for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteCourse = async function(id) {
                showCustomConfirm("Are you sure you want to delete this course?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting course...");
                    try {
                        await db.collection('courses').doc(id).delete();
                        showCustomAlert("Course deleted successfully!", 'success');
                        loadCourses();
                    } catch (e) {
                        console.error("Error deleting course:", e);
                        showCustomAlert("Failed to delete course.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetCourseForm() {
                document.getElementById('courseForm').reset();
                document.getElementById('courseId').value = '';
                document.getElementById('saveCourseBtn').textContent = "Add Course";
                document.getElementById('cancelEditCourseBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('courseForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving course...");
                const courseId = document.getElementById('courseId').value;
                const data = {
                    courseCode: document.getElementById('courseCode').value,
                    courseTitle: document.getElementById('courseTitle').value,
                    credits: parseInt(document.getElementById('courseCredits').value),
                    lecturer: document.getElementById('courseLecturer').value,
                    year: document.getElementById('courseYear').value,
                    semester: document.getElementById('courseSemester').value
                };
                try {
                    if (courseId) {
                        await db.collection('courses').doc(courseId).update(data);
                        showCustomAlert("Course updated successfully!", 'success');
                    } else {
                        await db.collection('courses').add(data);
                        showCustomAlert("Course added successfully!", 'success');
                    }
                    resetCourseForm();
                    loadCourses();
                } catch (e) {
                    console.error("Error saving course:", e);
                    showCustomAlert("Failed to save course.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Timetable management
            async function loadTimetable() {
                showLoading("Loading timetable...");
                const timetableTableBody = document.getElementById('timetableTable').querySelector('tbody');
                timetableTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading timetable entries...</td></tr>';
                try {
                    const timetableSnapshot = await db.collection('timetable').orderBy('day').get();
                    timetableTableBody.innerHTML = '';
                    if (timetableSnapshot.empty) {
                        timetableTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">No timetable entries found.</td></tr>';
                    } else {
                        timetableSnapshot.forEach(doc => {
                            const entry = doc.data();
                            const row = timetableTableBody.insertRow();
                            row.innerHTML = `
                                <td>${entry.courseCode}</td>
                                <td>${entry.day}</td>
                                <td>${entry.startTime} - ${entry.endTime}</td>
                                <td>${entry.venue}</td>
                                <td>${entry.lecturer}</td>
                                <td>Year ${entry.year}, Sem ${entry.semester}</td>
                                <td class="space-x-2">
                                    <button onclick="editTimetable('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteTimetable('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading timetable:", e);
                    showCustomAlert("Failed to load timetable data.", 'error');
                } finally {
                    hideLoading();
                }
            }

            // Timetable CRUD
            window.editTimetable = async function(id) {
                showLoading("Loading timetable entry...");
                try {
                    const docSnap = await db.collection('timetable').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('timetableId').value = id;
                        document.getElementById('timetableCourseCode').value = data.courseCode;
                        document.getElementById('timetableDay').value = data.day;
                        document.getElementById('timetableStartTime').value = data.startTime;
                        document.getElementById('timetableEndTime').value = data.endTime;
                        document.getElementById('timetableVenue').value = data.venue;
                        document.getElementById('timetableLecturer').value = data.lecturer;
                        document.getElementById('timetableYear').value = data.year;
                        document.getElementById('timetableSemester').value = data.semester;
                        document.getElementById('saveTimetableBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditTimetableBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Timetable entry not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing timetable entry:", e);
                    showCustomAlert("Failed to load timetable entry for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };

            window.deleteTimetable = async function(id) {
                showCustomConfirm("Are you sure you want to delete this timetable entry?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting timetable entry...");
                    try {
                        await db.collection('timetable').doc(id).delete();
                        showCustomAlert("Timetable entry deleted successfully!", 'success');
                        loadTimetable();
                    } catch (e) {
                        console.error("Error deleting timetable entry:", e);
                        showCustomAlert("Failed to delete timetable entry.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetTimetableForm() {
                document.getElementById('timetableForm').reset();
                document.getElementById('timetableId').value = '';
                document.getElementById('saveTimetableBtn').textContent = "Add Timetable Entry";
                document.getElementById('cancelEditTimetableBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('timetableForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving timetable entry...");
                const timetableId = document.getElementById('timetableId').value;
                const data = {
                    courseCode: document.getElementById('timetableCourseCode').value,
                    day: document.getElementById('timetableDay').value,
                    startTime: document.getElementById('timetableStartTime').value,
                    endTime: document.getElementById('timetableEndTime').value,
                    venue: document.getElementById('timetableVenue').value,
                    lecturer: document.getElementById('timetableLecturer').value,
                    year: document.getElementById('timetableYear').value,
                    semester: document.getElementById('timetableSemester').value,
                };
                try {
                    if (timetableId) {
                        await db.collection('timetable').doc(timetableId).update(data);
                        showCustomAlert("Timetable entry updated successfully!", 'success');
                    } else {
                        await db.collection('timetable').add(data);
                        showCustomAlert("Timetable entry added successfully!", 'success');
                    }
                    resetTimetableForm();
                    loadTimetable();
                } catch (e) {
                    console.error("Error saving timetable entry:", e);
                    showCustomAlert("Failed to save timetable entry.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Grades management
            async function loadStudentGrades() {
                const studentUid = document.getElementById('gradeStudentId').value;
                const year = document.getElementById('gradeYear').value;
                const semester = document.getElementById('gradeSemester').value;
                const gradesTableBody = document.getElementById('gradesTable').querySelector('tbody');
                gradesTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading grades...</td></tr>';
                document.getElementById('gradeEntryForm').classList.remove('hidden');
                resetGradeForm();

                if (!studentUid || !year || !semester) {
                    gradesTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">Select a student, year, and semester to view grades.</td></tr>';
                    return;
                }

                showLoading("Loading grades...");
                try {
                    const studentRef = db.collection('grades').doc(studentUid);
                    const gradesRef = studentRef.collection('grades');
                    const gradesSnapshot = await gradesRef.where('year', '==', year).where('semester', '==', semester).get();
                    
                    gradesTableBody.innerHTML = '';
                    if (gradesSnapshot.empty) {
                        gradesTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">No grades found for this selection.</td></tr>';
                    } else {
                        gradesSnapshot.forEach(doc => {
                            const grade = doc.data();
                            const row = gradesTableBody.insertRow();
                            row.innerHTML = `
                                <td>${grade.courseCode}</td>
                                <td>${grade.courseTitle}</td>
                                <td>${grade.credits}</td>
                                <td>${grade.grade}</td>
                                <td>${grade.points}</td>
                                <td>${grade.lecturer}</td>
                                <td class="space-x-2">
                                    <button onclick="editGrade('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteGrade('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading grades:", e);
                    showCustomAlert("Failed to load grades data.", 'error');
                } finally {
                    hideLoading();
                }
            }

            // Grades CRUD
            window.editGrade = async function(id) {
                showLoading("Loading grade entry...");
                const studentUid = document.getElementById('gradeStudentId').value;
                if (!studentUid) {
                    showCustomAlert("Please select a student first.", 'error');
                    hideLoading();
                    return;
                }
                try {
                    const docSnap = await db.collection('grades').doc(studentUid).collection('grades').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('gradeEntryId').value = id;
                        document.getElementById('gradeCourseCode').value = data.courseCode;
                        document.getElementById('gradeCourseTitle').value = data.courseTitle;
                        document.getElementById('gradeCredits').value = data.credits;
                        document.getElementById('gradeGrade').value = data.grade;
                        document.getElementById('gradePoints').value = data.points;
                        document.getElementById('gradeLecturer').value = data.lecturer;
                        document.getElementById('saveGradeBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditGradeBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Grade not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing grade:", e);
                    showCustomAlert("Failed to load grade details for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteGrade = async function(id) {
                const studentUid = document.getElementById('gradeStudentId').value;
                if (!studentUid) {
                    showCustomAlert("Please select a student first.", 'error');
                    return;
                }
                showCustomConfirm("Are you sure you want to delete this grade entry?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting grade...");
                    try {
                        await db.collection('grades').doc(studentUid).collection('grades').doc(id).delete();
                        showCustomAlert("Grade deleted successfully!", 'success');
                        loadStudentGrades();
                    } catch (e) {
                        console.error("Error deleting grade:", e);
                        showCustomAlert("Failed to delete grade.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetGradeForm() {
                document.getElementById('gradeEntryForm').reset();
                document.getElementById('gradeEntryId').value = '';
                document.getElementById('saveGradeBtn').textContent = "Save Grade";
                document.getElementById('cancelEditGradeBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('gradeEntryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving grade...");
                const studentUid = document.getElementById('gradeStudentId').value;
                const gradeId = document.getElementById('gradeEntryId').value;
                const data = {
                    courseCode: document.getElementById('gradeCourseCode').value,
                    courseTitle: document.getElementById('gradeCourseTitle').value,
                    credits: parseInt(document.getElementById('gradeCredits').value),
                    grade: document.getElementById('gradeGrade').value.toUpperCase(),
                    points: parseFloat(document.getElementById('gradePoints').value),
                    lecturer: document.getElementById('gradeLecturer').value,
                    year: document.getElementById('gradeYear').value,
                    semester: document.getElementById('gradeSemester').value,
                    timestamp: firestore.FieldValue.serverTimestamp()
                };
                try {
                    if (gradeId) {
                        await db.collection('grades').doc(studentUid).collection('grades').doc(gradeId).update(data);
                        showCustomAlert("Grade updated successfully!", 'success');
                    } else {
                        await db.collection('grades').doc(studentUid).collection('grades').add(data);
                        showCustomAlert("Grade added successfully!", 'success');
                    }
                    resetGradeForm();
                    loadStudentGrades();
                } catch (e) {
                    console.error("Error saving grade:", e);
                    showCustomAlert("Failed to save grade.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Exam Schedule management
            async function loadExamSchedules() {
                showLoading("Loading exam schedules...");
                const examScheduleTableBody = document.getElementById('examScheduleTable').querySelector('tbody');
                examScheduleTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading exam schedules...</td></tr>';
                try {
                    const schedulesSnapshot = await db.collection('examSchedule').get();
                    examScheduleTableBody.innerHTML = '';
                    if (schedulesSnapshot.empty) {
                        examScheduleTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-4">No exam schedules found.</td></tr>';
                    } else {
                        schedulesSnapshot.forEach(doc => {
                            const schedule = doc.data();
                            const row = examScheduleTableBody.insertRow();
                            row.innerHTML = `
                                <td>${schedule.courseCode}</td>
                                <td>${schedule.date}</td>
                                <td>${schedule.time}</td>
                                <td>${schedule.venue}</td>
                                <td>${schedule.lecturer || 'N/A'}</td>
                                <td>Year ${schedule.year}, Sem ${schedule.semester}</td>
                                <td class="space-x-2">
                                    <button onclick="editExamSchedule('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteExamSchedule('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading exam schedules:", e);
                    showCustomAlert("Failed to load exam schedules data.", 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Exam Schedule CRUD
            window.editExamSchedule = async function(id) {
                showLoading("Loading exam schedule entry...");
                try {
                    const docSnap = await db.collection('examSchedule').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('examScheduleId').value = id;
                        document.getElementById('examScheduleCourseCode').value = data.courseCode;
                        document.getElementById('examScheduleDate').value = data.date;
                        document.getElementById('examScheduleTime').value = data.time;
                        document.getElementById('examScheduleVenue').value = data.venue;
                        document.getElementById('examScheduleLecturer').value = data.lecturer || '';
                        document.getElementById('examScheduleYear').value = data.year;
                        document.getElementById('examScheduleSemester').value = data.semester;
                        document.getElementById('saveExamScheduleBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditExamScheduleBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Exam schedule entry not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing exam schedule entry:", e);
                    showCustomAlert("Failed to load exam schedule for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteExamSchedule = async function(id) {
                showCustomConfirm("Are you sure you want to delete this exam schedule entry?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting exam schedule entry...");
                    try {
                        await db.collection('examSchedule').doc(id).delete();
                        showCustomAlert("Exam schedule entry deleted successfully!", 'success');
                        loadExamSchedules();
                    } catch (e) {
                        console.error("Error deleting exam schedule entry:", e);
                        showCustomAlert("Failed to delete exam schedule entry.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetExamScheduleForm() {
                document.getElementById('examScheduleForm').reset();
                document.getElementById('examScheduleId').value = '';
                document.getElementById('saveExamScheduleBtn').textContent = "Add Exam Schedule";
                document.getElementById('cancelEditExamScheduleBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('examScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving exam schedule...");
                const scheduleId = document.getElementById('examScheduleId').value;
                const data = {
                    courseCode: document.getElementById('examScheduleCourseCode').value,
                    date: document.getElementById('examScheduleDate').value,
                    time: document.getElementById('examScheduleTime').value,
                    venue: document.getElementById('examScheduleVenue').value,
                    lecturer: document.getElementById('examScheduleLecturer').value,
                    year: document.getElementById('examScheduleYear').value,
                    semester: document.getElementById('examScheduleSemester').value
                };
                try {
                    if (scheduleId) {
                        await db.collection('examSchedule').doc(scheduleId).update(data);
                        showCustomAlert("Exam schedule updated successfully!", 'success');
                    } else {
                        await db.collection('examSchedule').add(data);
                        showCustomAlert("Exam schedule added successfully!", 'success');
                    }
                    resetExamScheduleForm();
                    loadExamSchedules();
                } catch (e) {
                    console.error("Error saving exam schedule:", e);
                    showCustomAlert("Failed to save exam schedule.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Announcements management
            async function loadAnnouncements() {
                showLoading("Loading announcements...");
                const announcementsTableBody = document.getElementById('announcementsTable').querySelector('tbody');
                announcementsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading announcements...</td></tr>';
                try {
                    const announcementsSnapshot = await db.collection('announcements').orderBy('timestamp', 'desc').get();
                    announcementsTableBody.innerHTML = '';
                    if (announcementsSnapshot.empty) {
                        announcementsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">No announcements found.</td></tr>';
                    } else {
                        announcementsSnapshot.forEach(doc => {
                            const announcement = doc.data();
                            const row = announcementsTableBody.insertRow();
                            const date = announcement.timestamp ? new Date(announcement.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                            row.innerHTML = `
                                <td>${announcement.title}</td>
                                <td>${announcement.category}</td>
                                <td>${announcement.author}</td>
                                <td>${date}</td>
                                <td>${announcement.pinned ? 'Yes' : 'No'}</td>
                                <td class="space-x-2">
                                    <button onclick="editAnnouncement('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteAnnouncement('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading announcements:", e);
                    showCustomAlert("Failed to load announcements data.", 'error');
                } finally {
                    hideLoading();
                }
            }

            // Announcements CRUD
            window.editAnnouncement = async function(id) {
                showLoading("Loading announcement...");
                try {
                    const docSnap = await db.collection('announcements').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('announcementId').value = id;
                        document.getElementById('announcementTitle').value = data.title;
                        document.getElementById('announcementMessage').value = data.message;
                        document.getElementById('announcementAuthor').value = data.author;
                        document.getElementById('announcementCategory').value = data.category;
                        document.getElementById('announcementPinned').checked = data.pinned;
                        document.getElementById('saveAnnouncementBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditAnnouncementBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Announcement not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing announcement:", e);
                    showCustomAlert("Failed to load announcement for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };

            window.deleteAnnouncement = async function(id) {
                showCustomConfirm("Are you sure you want to delete this announcement?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting announcement...");
                    try {
                        await db.collection('announcements').doc(id).delete();
                        showCustomAlert("Announcement deleted successfully!", 'success');
                        loadAnnouncements();
                    } catch (e) {
                        console.error("Error deleting announcement:", e);
                        showCustomAlert("Failed to delete announcement.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetAnnouncementForm() {
                document.getElementById('announcementForm').reset();
                document.getElementById('announcementId').value = '';
                document.getElementById('saveAnnouncementBtn').textContent = "Publish Announcement";
                document.getElementById('cancelEditAnnouncementBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('announcementForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving announcement...");
                const announcementId = document.getElementById('announcementId').value;
                const data = {
                    title: document.getElementById('announcementTitle').value,
                    message: document.getElementById('announcementMessage').value,
                    author: document.getElementById('announcementAuthor').value,
                    category: document.getElementById('announcementCategory').value,
                    pinned: document.getElementById('announcementPinned').checked,
                    timestamp: firestore.FieldValue.serverTimestamp()
                };
                try {
                    if (announcementId) {
                        await db.collection('announcements').doc(announcementId).update(data);
                        showCustomAlert("Announcement updated successfully!", 'success');
                    } else {
                        await db.collection('announcements').add(data);
                        showCustomAlert("Announcement published successfully!", 'success');
                    }
                    resetAnnouncementForm();
                    loadAnnouncements();
                } catch (e) {
                    console.error("Error saving announcement:", e);
                    showCustomAlert("Failed to save announcement.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Hostels & Rooms management
            async function loadHostels() {
                showLoading("Loading hostels...");
                const hostelsTableBody = document.getElementById('hostelsTable').querySelector('tbody');
                hostelsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading hostels...</td></tr>';
                try {
                    const hostelsSnapshot = await db.collection('hostels').get();
                    hostelsTableBody.innerHTML = '';
                    if (hostelsSnapshot.empty) {
                        hostelsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">No hostels found.</td></tr>';
                    } else {
                        for (const doc of hostelsSnapshot.docs) {
                            const hostel = doc.data();
                            const row = hostelsTableBody.insertRow();
                            row.innerHTML = `
                                <td>${hostel.name}</td>
                                <td>${hostel.type}</td>
                                <td>${hostel.capacity}</td>
                                <td>${hostel.location || 'N/A'}</td>
                                <td>${hostel.availableRooms}</td>
                                <td class="space-x-2">
                                    <button onclick="editHostel('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteHostel('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                    <button onclick="showRooms('${doc.id}', '${hostel.name}')" class="btn-primary text-xs"><i class="fas fa-bed"></i> Rooms</button>
                                </td>
                            `;
                        }
                    }
                } catch (e) {
                    console.error("Error loading hostels:", e);
                    showCustomAlert("Failed to load hostel data.", 'error');
                } finally {
                    hideLoading();
                }
            }

            window.showRooms = async function(hostelId, hostelName) {
                showLoading("Loading rooms...");
                document.getElementById('roomsOfHostelTitle').textContent = `Rooms in ${hostelName}`;
                document.getElementById('roomHostelId').value = hostelId;
                showSection('manageHostels');
                document.getElementById('hostelForm').classList.add('hidden');
                document.getElementById('hostelsTable').parentNode.classList.add('hidden');
                document.getElementById('roomsManagementArea').classList.remove('hidden');
                await loadRooms(hostelId);
                hideLoading();
            }

            window.showHostelsList = function() {
                showSection('manageHostels');
                document.getElementById('hostelForm').classList.remove('hidden');
                document.getElementById('hostelsTable').parentNode.classList.remove('hidden');
                document.getElementById('roomsManagementArea').classList.add('hidden');
                loadHostels();
            }

            async function loadRooms(hostelId) {
                const roomsTableBody = document.getElementById('roomsTable').querySelector('tbody');
                roomsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 p-4">Loading rooms...</td></tr>';
                try {
                    const roomsSnapshot = await db.collection('hostels').doc(hostelId).collection('rooms').get();
                    roomsTableBody.innerHTML = '';
                    if (roomsSnapshot.empty) {
                        roomsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 p-4">No rooms found.</td></tr>';
                    } else {
                        roomsSnapshot.forEach(doc => {
                            const room = doc.data();
                            const row = roomsTableBody.insertRow();
                            const status = room.availableSlots > 0 ? 'available' : 'full';
                            row.innerHTML = `
                                <td>${room.roomNo}</td>
                                <td>${room.capacity}</td>
                                <td>${room.availableSlots} <span class="status-badge ${status}">${status}</span></td>
                                <td class="space-x-2">
                                    <button onclick="editRoom('${hostelId}', '${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteRoom('${hostelId}', '${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading rooms:", e);
                    showCustomAlert("Failed to load room data.", 'error');
                }
            }

            async function syncHostelCapacity(hostelId) {
                try {
                    const roomsSnapshot = await db.collection('hostels').doc(hostelId).collection('rooms').get();
                    let totalAvailableSlots = 0;
                    if (!roomsSnapshot.empty) {
                        roomsSnapshot.forEach(doc => {
                            totalAvailableSlots += doc.data().availableSlots;
                        });
                    }
                    await db.collection('hostels').doc(hostelId).update({ availableRooms: totalAvailableSlots });
                } catch(e) {
                    console.error("Error syncing hostel capacity:", e);
                    showCustomAlert("Failed to sync hostel capacity.", 'error');
                }
            }

            // Hostels CRUD
            window.editHostel = async function(id) {
                showLoading("Loading hostel details...");
                try {
                    const docSnap = await db.collection('hostels').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('hostelId').value = id;
                        document.getElementById('hostelName').value = data.name;
                        document.getElementById('hostelType').value = data.type;
                        document.getElementById('hostelCapacity').value = data.capacity;
                        document.getElementById('hostelLocation').value = data.location;
                        document.getElementById('saveHostelBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditHostelBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Hostel not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing hostel:", e);
                    showCustomAlert("Failed to load hostel details for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteHostel = async function(id) {
                showCustomConfirm("Are you sure you want to delete this hostel and all its rooms?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting hostel and its rooms...");
                    try {
                        const roomsRef = db.collection('hostels').doc(id).collection('rooms');
                        const roomsSnapshot = await roomsRef.get();
                        const batch = db.batch();
                        roomsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        await db.collection('hostels').doc(id).delete();
                        showCustomAlert("Hostel deleted successfully!", 'success');
                        loadHostels();
                    } catch (e) {
                        console.error("Error deleting hostel:", e);
                        showCustomAlert("Failed to delete hostel.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetHostelForm() {
                document.getElementById('hostelForm').reset();
                document.getElementById('hostelId').value = '';
                document.getElementById('saveHostelBtn').textContent = "Add Hostel";
                document.getElementById('cancelEditHostelBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('hostelForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving hostel...");
                const hostelId = document.getElementById('hostelId').value;
                const capacity = parseInt(document.getElementById('hostelCapacity').value);
                const data = {
                    name: document.getElementById('hostelName').value,
                    type: document.getElementById('hostelType').value,
                    capacity: capacity,
                    location: document.getElementById('hostelLocation').value,
                    availableRooms: capacity
                };
                try {
                    if (hostelId) {
                        await db.collection('hostels').doc(hostelId).update(data);
                        showCustomAlert("Hostel updated successfully!", 'success');
                    } else {
                        await db.collection('hostels').add(data);
                        showCustomAlert("Hostel added successfully!", 'success');
                    }
                    resetHostelForm();
                    loadHostels();
                } catch (e) {
                    console.error("Error saving hostel:", e);
                    showCustomAlert("Failed to save hostel.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Rooms CRUD
            window.editRoom = async function(hostelId, roomId) {
                showLoading("Loading room details...");
                try {
                    const docSnap = await db.collection('hostels').doc(hostelId).collection('rooms').doc(roomId).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('roomId').value = roomId;
                        document.getElementById('roomNo').value = data.roomNo;
                        document.getElementById('roomCapacity').value = data.capacity;
                        document.getElementById('saveRoomBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditRoomBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Room not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing room:", e);
                    showCustomAlert("Failed to load room details for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteRoom = async function(hostelId, roomId) {
                showCustomConfirm("Are you sure you want to delete this room?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting room...");
                    try {
                        await db.collection('hostels').doc(hostelId).collection('rooms').doc(roomId).delete();
                        showCustomAlert("Room deleted successfully!", 'success');
                        await syncHostelCapacity(hostelId);
                        loadRooms(hostelId);
                    } catch (e) {
                        console.error("Error deleting room:", e);
                        showCustomAlert("Failed to delete room.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetRoomForm() {
                document.getElementById('roomForm').reset();
                document.getElementById('roomId').value = '';
                document.getElementById('saveRoomBtn').textContent = "Add Room";
                document.getElementById('cancelEditRoomBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('roomForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving room...");
                const hostelId = document.getElementById('roomHostelId').value;
                const roomId = document.getElementById('roomId').value;
                const capacity = parseInt(document.getElementById('roomCapacity').value);
                const data = {
                    roomNo: document.getElementById('roomNo').value,
                    capacity: capacity,
                    availableSlots: capacity // Initial available slots
                };
                try {
                    if (roomId) {
                        await db.collection('hostels').doc(hostelId).collection('rooms').doc(roomId).update(data);
                        showCustomAlert("Room updated successfully!", 'success');
                    } else {
                        await db.collection('hostels').doc(hostelId).collection('rooms').add(data);
                        showCustomAlert("Room added successfully!", 'success');
                    }
                    await syncHostelCapacity(hostelId);
                    resetRoomForm();
                    loadRooms(hostelId);
                } catch (e) {
                    console.error("Error saving room:", e);
                    showCustomAlert("Failed to save room.", 'error');
                } finally {
                    hideLoading();
                }
            });
            
            // Graduation requests management
            async function loadGraduations() {
                showLoading("Loading graduation requests...");
                const graduationRequestsTableBody = document.getElementById('graduationRequestsTable').querySelector('tbody');
                graduationRequestsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading graduation requests...</td></tr>';
                try {
                    const requestsSnapshot = await db.collection('graduationRequests').get();
                    graduationRequestsTableBody.innerHTML = '';
                    if (requestsSnapshot.empty) {
                        graduationRequestsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">No graduation requests found.</td></tr>';
                    } else {
                        requestsSnapshot.forEach(doc => {
                            const request = doc.data();
                            const row = graduationRequestsTableBody.insertRow();
                            const date = request.dateSubmitted ? new Date(request.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                            row.innerHTML = `
                                <td>${request.studentName}</td>
                                <td>${request.admissionNo}</td>
                                <td>${request.program}</td>
                                <td>${date}</td>
                                <td><span class="status-badge ${request.status.toLowerCase()}">${request.status}</span></td>
                                <td class="space-x-2">
                                    <button onclick="editGraduation('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteGraduation('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading graduation requests:", e);
                    showCustomAlert("Failed to load graduation requests.", 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Graduation CRUD
            window.editGraduation = async function(id) {
                showLoading("Loading graduation details...");
                try {
                    const docSnap = await db.collection('graduationRequests').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('gradModalStudentName').textContent = data.studentName;
                        document.getElementById('gradModalAdmNo').textContent = data.admissionNo;
                        document.getElementById('gradModalProgram').textContent = data.program;
                        document.getElementById('gradModalDateSubmitted').textContent = data.dateSubmitted ? new Date(data.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                        document.getElementById('gradModalCurrentStatus').textContent = data.status;
                        document.getElementById('gradModalCurrentStatus').className = `status-badge ${data.status.toLowerCase()}`;
                        document.getElementById('gradModalStatus').value = data.status;
                        document.getElementById('gradModalComments').value = data.comments || '';
                        document.getElementById('gradModalUid').value = id;

                        const docsList = document.getElementById('gradModalDocuments');
                        docsList.innerHTML = '';
                        if (data.documents) {
                            for (const [key, url] of Object.entries(data.documents)) {
                                const li = document.createElement('li');
                                li.innerHTML = `<a href="${url}" target="_blank" class="text-blue-600 hover:underline">${key} <i class="fas fa-external-link-alt text-xs"></i></a>`;
                                docsList.appendChild(li);
                            }
                        } else {
                            docsList.innerHTML = '<li>No documents uploaded.</li>';
                        }
                        
                        document.getElementById('graduationDetailModal').classList.remove('hidden');
                    } else {
                        showCustomAlert("Graduation request not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing graduation request:", e);
                    showCustomAlert("Failed to load graduation request details.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteGraduation = async function(id) {
                showCustomConfirm("Are you sure you want to delete this graduation request?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting graduation request...");
                    try {
                        await db.collection('graduationRequests').doc(id).delete();
                        showCustomAlert("Graduation request deleted successfully!", 'success');
                        loadGraduations();
                    } catch (e) {
                        console.error("Error deleting graduation request:", e);
                        showCustomAlert("Failed to delete graduation request.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            document.getElementById('updateGradStatusForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Updating graduation status...");
                const uid = document.getElementById('gradModalUid').value;
                const status = document.getElementById('gradModalStatus').value;
                const comments = document.getElementById('gradModalComments').value;
                try {
                    await db.collection('graduationRequests').doc(uid).update({ status: status, comments: comments });
                    showCustomAlert("Graduation status updated!", 'success');
                    closeModal('graduationDetailModal');
                    loadGraduations();
                } catch(e) {
                    console.error("Error updating graduation status:", e);
                    showCustomAlert("Failed to update graduation status.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Clearance requests management
            async function loadClearances() {
                showLoading("Loading clearance requests...");
                const clearanceRequestsTableBody = document.getElementById('clearanceRequestsTable').querySelector('tbody');
                clearanceRequestsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">Loading clearance requests...</td></tr>';
                try {
                    const requestsSnapshot = await db.collection('clearances').get();
                    clearanceRequestsTableBody.innerHTML = '';
                    if (requestsSnapshot.empty) {
                        clearanceRequestsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">No clearance requests found.</td></tr>';
                    } else {
                        requestsSnapshot.forEach(doc => {
                            const request = doc.data();
                            const row = clearanceRequestsTableBody.insertRow();
                            const date = request.dateSubmitted ? new Date(request.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                            row.innerHTML = `
                                <td>${request.studentName}</td>
                                <td>${request.admissionNo}</td>
                                <td>${date}</td>
                                <td><span class="status-badge ${request.overallStatus.toLowerCase().replace(' ', '-')}">${request.overallStatus}</span></td>
                                <td class="space-x-2">
                                    <button onclick="editClearance('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteClearance('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading clearance requests:", e);
                    showCustomAlert("Failed to load clearance requests.", 'error');
                } finally {
                    hideLoading();
                }
            }

            // Clearance CRUD
            window.editClearance = async function(id) {
                showLoading("Loading clearance details...");
                try {
                    const docSnap = await db.collection('clearances').doc(id).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('clearanceModalStudentName').textContent = data.studentName;
                        document.getElementById('clearanceModalAdmNo').textContent = data.admissionNo;
                        document.getElementById('clearanceModalDateSubmitted').textContent = data.dateSubmitted ? new Date(data.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                        document.getElementById('clearanceModalOverallStatus').textContent = data.overallStatus;
                        document.getElementById('clearanceModalOverallStatus').className = `status-badge ${data.overallStatus.toLowerCase().replace(' ', '-')}`;
                        document.getElementById('clearanceModalUid').value = id;

                        const deptForms = document.getElementById('departmentApprovalForms');
                        deptForms.innerHTML = '';
                        for (const dept in data.departments) {
                            const deptData = data.departments[dept];
                            deptForms.innerHTML += `
                                <div class="p-3 border rounded-md">
                                    <h5 class="font-semibold">${dept}</h5>
                                    <p>Status: <span class="status-badge ${deptData.status.toLowerCase()}">${deptData.status}</span></p>
                                    <div class="form-group mt-2">
                                        <label for="status-${dept}">Update Status</label>
                                        <select id="status-${dept}" class="w-full">
                                            <option value="Pending" ${deptData.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="Cleared" ${deptData.status === 'Cleared' ? 'selected' : ''}>Cleared</option>
                                            <option value="Not Cleared" ${deptData.status === 'Not Cleared' ? 'selected' : ''}>Not Cleared</option>
                                        </select>
                                    </div>
                                </div>
                            `;
                        }
                        
                        document.getElementById('clearanceDetailModal').classList.remove('hidden');
                    } else {
                        showCustomAlert("Clearance request not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing clearance request:", e);
                    showCustomAlert("Failed to load clearance request details.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteClearance = async function(id) {
                showCustomConfirm("Are you sure you want to delete this clearance request?", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting clearance request...");
                    try {
                        await db.collection('clearances').doc(id).delete();
                        showCustomAlert("Clearance request deleted successfully!", 'success');
                        loadClearances();
                    } catch (e) {
                        console.error("Error deleting clearance request:", e);
                        showCustomAlert("Failed to delete clearance request.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            document.getElementById('updateClearanceStatusForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Updating clearance approvals...");
                const uid = document.getElementById('clearanceModalUid').value;
                const newDepartments = {};
                document.querySelectorAll('#departmentApprovalForms select').forEach(select => {
                    const dept = select.id.replace('status-', '');
                    newDepartments[dept] = { status: select.value };
                });
                
                // Determine overall status
                let overallStatus = 'Pending';
                const allCleared = Object.values(newDepartments).every(dept => dept.status === 'Cleared');
                const anyNotCleared = Object.values(newDepartments).some(dept => dept.status === 'Not Cleared');
                if (allCleared) {
                    overallStatus = 'Cleared';
                } else if (anyNotCleared) {
                    overallStatus = 'Not Cleared';
                }

                try {
                    await db.collection('clearances').doc(uid).update({ departments: newDepartments, overallStatus: overallStatus });
                    showCustomAlert("Clearance approvals updated!", 'success');
                    closeModal('clearanceDetailModal');
                    loadClearances();
                } catch(e) {
                    console.error("Error updating clearance approvals:", e);
                    showCustomAlert("Failed to update clearance approvals.", 'error');
                } finally {
                    hideLoading();
                }
            });
            
            // Finance management
            async function loadFinanceEntries(studentUid) {
                const financeTableBody = document.getElementById('financeTable').querySelector('tbody');
                financeTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">Loading financial data...</td></tr>';
                document.getElementById('financeStudentNameDisplay').classList.add('hidden');
                document.getElementById('financeBalanceDisplay').classList.add('hidden');

                if (!studentUid) {
                    financeTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">Select a student.</td></tr>';
                    return;
                }

                showLoading("Loading financial statement...");
                try {
                    const financeRef = db.collection('finance').doc(studentUid);
                    const studentRef = db.collection('students').doc(studentUid);

                    const [financeSnap, studentSnap] = await Promise.all([financeRef.collection('transactions').orderBy('date', 'desc').get(), studentRef.get()]);

                    if (studentSnap.exists) {
                        const studentData = studentSnap.data();
                        document.getElementById('financeStudentNameDisplay').textContent = `Student: ${studentData.fullName}`;
                        document.getElementById('financeStudentNameDisplay').classList.remove('hidden');
                    }

                    const financeDocSnap = await financeRef.get();
                    if (financeDocSnap.exists) {
                        document.getElementById('financeBalanceDisplay').textContent = `Current Balance: KES ${financeDocSnap.data().currentBalance}`;
                        document.getElementById('financeBalanceDisplay').classList.remove('hidden');
                    }
                    
                    financeTableBody.innerHTML = '';
                    if (financeSnap.empty) {
                        financeTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 p-4">No financial transactions found.</td></tr>';
                    } else {
                        financeSnap.forEach(doc => {
                            const entry = doc.data();
                            const row = financeTableBody.insertRow();
                            const date = entry.date ? new Date(entry.date.seconds * 1000).toLocaleDateString() : 'N/A';
                            const amountCredit = entry.type === 'payment' || entry.type === 'adjustment' && entry.amount < 0 ? Math.abs(entry.amount) : '';
                            const amountDebit = entry.type === 'fees' || entry.type === 'adjustment' && entry.amount > 0 ? Math.abs(entry.amount) : '';
                            row.innerHTML = `
                                <td>${date}</td>
                                <td>${entry.description}</td>
                                <td>${amountCredit}</td>
                                <td>${amountDebit}</td>
                                <td class="space-x-2">
                                    <button onclick="editFinance('${studentUid}', '${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteFinance('${studentUid}', '${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch(e) {
                    console.error("Error loading financial data:", e);
                    showCustomAlert("Failed to load financial data.", 'error');
                } finally {
                    hideLoading();
                }
            }

            // Finance CRUD (simplified as requested in prompt, but with edit/delete added)
            // Note: Full financial system logic for balance updates would be more complex
            window.editFinance = async function(studentUid, entryId) {
                showCustomAlert("Editing finance entries is not fully supported in this view. Please manually update the transaction or balance.", 'info');
                // You would implement a modal here to edit the entry
            };

            window.deleteFinance = async function(studentUid, entryId) {
                showCustomConfirm("Are you sure you want to delete this financial transaction? This will not automatically adjust the student's balance.", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Deleting transaction...");
                    try {
                        const transactionRef = db.collection('finance').doc(studentUid).collection('transactions').doc(entryId);
                        const transactionSnap = await transactionRef.get();
                        if (transactionSnap.exists) {
                            await transactionRef.delete();
                            showCustomAlert("Transaction deleted successfully!", 'success');
                            loadFinanceEntries(studentUid);
                        }
                    } catch (e) {
                        console.error("Error deleting finance entry:", e);
                        showCustomAlert("Failed to delete transaction.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            // Admins management
            async function loadAdmins() {
                showLoading("Loading admins...");
                const adminsTableBody = document.getElementById('adminsTable').querySelector('tbody');
                adminsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 p-4">Loading admin accounts...</td></tr>';
                try {
                    const adminsSnapshot = await db.collection('admins').get();
                    adminsTableBody.innerHTML = '';
                    if (adminsSnapshot.empty) {
                        adminsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 p-4">No admins found.</td></tr>';
                    } else {
                        adminsSnapshot.forEach(doc => {
                            const admin = doc.data();
                            const row = adminsTableBody.insertRow();
                            row.innerHTML = `
                                <td>${admin.name}</td>
                                <td>${admin.email}</td>
                                <td>${admin.role}</td>
                                <td class="space-x-2">
                                    <button onclick="editAdmin('${doc.id}')" class="btn-primary text-xs"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteAdmin('${doc.id}')" class="btn-red text-xs"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        });
                    }
                } catch (e) {
                    console.error("Error loading admins:", e);
                    showCustomAlert("Failed to load admin data.", 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Admins CRUD
            window.editAdmin = async function(uid) {
                showLoading("Loading admin details...");
                try {
                    const docSnap = await db.collection('admins').doc(uid).get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        document.getElementById('adminUid').value = uid;
                        document.getElementById('adminName').value = data.name;
                        document.getElementById('adminEmailInput').value = data.email;
                        document.getElementById('adminEmailInput').setAttribute('readonly', true);
                        document.getElementById('adminRole').value = data.role;
                        document.getElementById('saveAdminBtn').textContent = "Save Changes";
                        document.getElementById('cancelEditAdminBtn').classList.remove('hidden');
                        isEditing = true;
                    } else {
                        showCustomAlert("Admin not found.", 'error');
                    }
                } catch (e) {
                    console.error("Error editing admin:", e);
                    showCustomAlert("Failed to load admin details for editing.", 'error');
                } finally {
                    hideLoading();
                }
            };
            
            window.deleteAdmin = async function(uid) {
                showCustomConfirm("Are you sure you want to remove this admin? This action cannot be undone.", 'delete', async (c) => {
                    if (!c) return;
                    showLoading("Removing admin...");
                    try {
                        await db.collection('admins').doc(uid).delete();
                        showCustomAlert("Admin removed successfully!", 'success');
                        loadAdmins();
                    } catch (e) {
                        console.error("Error removing admin:", e);
                        showCustomAlert("Failed to remove admin.", 'error');
                    } finally {
                        hideLoading();
                    }
                });
            };

            function resetAdminForm() {
                document.getElementById('adminForm').reset();
                document.getElementById('adminUid').value = '';
                document.getElementById('adminEmailInput').removeAttribute('readonly');
                document.getElementById('saveAdminBtn').textContent = "Add Admin";
                document.getElementById('cancelEditAdminBtn').classList.add('hidden');
                isEditing = false;
            }

            document.getElementById('adminForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Saving admin...");
                const adminUid = document.getElementById('adminUid').value;
                const data = {
                    name: document.getElementById('adminName').value,
                    email: document.getElementById('adminEmailInput').value,
                    role: document.getElementById('adminRole').value
                };
                try {
                    if (adminUid) {
                        await db.collection('admins').doc(adminUid).update(data);
                        showCustomAlert("Admin updated successfully!", 'success');
                    } else {
                        const docRef = await db.collection('admins').add(data);
                        await db.collection('admins').doc(docRef.id).update({ uid: docRef.id });
                        showCustomAlert("Admin added successfully!", 'success');
                    }
                    resetAdminForm();
                    loadAdmins();
                } catch (e) {
                    console.error("Error saving admin:", e);
                    showCustomAlert("Failed to save admin.", 'error');
                } finally {
                    hideLoading();
                }
            });

            // Section switching logic
            window.showSection = function(sectionId) {
                document.querySelectorAll('.admin-card').forEach(sec => sec.classList.add('hidden'));
                document.getElementById(sectionId).classList.remove('hidden');
                document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active'));
                document.querySelector(`a[onclick*="${sectionId}"]`).classList.add('active');
                
                // Call the appropriate load function for the selected section
                switch(sectionId) {
                    case 'adminDashboard':
                        loadDashboardStats();
                        break;
                    case 'manageStudents':
                        loadStudents();
                        break;
                    case 'manageCourses':
                        loadCourses();
                        break;
                    case 'manageTimetable':
                        loadTimetable();
                        break;
                    case 'manageGrades':
                        // The load function requires input, so we don't call it on section switch
                        break;
                    case 'manageExamSchedule':
                        loadExamSchedules();
                        break;
                    case 'manageAnnouncements':
                        loadAnnouncements();
                        break;
                    case 'manageHostels':
                        showHostelsList(); // Loads hostels by default
                        break;
                    case 'manageGraduation':
                        loadGraduations();
                        break;
                    case 'manageClearance':
                        loadClearances();
                        break;
                    case 'manageFinance':
                        // The load function requires input, so we don't call it on section switch
                        break;
                    case 'manageAdmins':
                        loadAdmins();
                        break;
                }
            };
            
        })();
    </script>
</body>
</html>

