<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard — University Portal (Upgraded)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Custom CSS Variables and Base Styles */
    :root {
      --primary: #065f46; /* Dark green */
      --primary-hover: #047857; /* Slightly brighter green */
      --background: #f3f4f6; /* Light grey */
      --card-bg: #ffffff; /* White for cards */
      --text-dark: #1f2937; /* Dark gray for general text */
      --text-muted: #6b7280; /* Muted gray for secondary text */
      --error-red: #dc2626; /* Red for errors */
      --pending-yellow: #f59e0b; /* Yellow for pending */
      --success-green: #16a34a; /* Green for success */
    }

    html, body {
      height: 100%;
      font-family: 'Inter', sans-serif;
      background-color: var(--background);
      color: var(--text-dark);
    }

    /* Loading Overlay */
    .loading-overlay {
      background-color: rgba(255, 255, 255, 0.8);
    }

    .spinner {
      border-color: var(--primary);
      border-top-color: transparent;
    }

    /* Login Card Styling */
    .login-card {
      background-color: var(--card-bg);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* App Shell Layout */
    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Styling */
    .sidebar {
      width: 250px; /* Fixed width */
      background-color: #0c431b; /* Dark green */
      color: white;
      transition: transform 0.3s ease-in-out;
      flex-shrink: 0; /* Prevent sidebar from shrinking */
    }

    /* Mobile Sidebar Hidden by default */
    .sidebar.mobile-hidden {
      transform: translateX(-100%);
    }

    /* Sidebar Nav Links */
    .navlink {
      @apply flex items-center gap-3 rounded-lg px-4 py-3 text-lg transition-colors;
    }

    .navlink:hover {
      background-color: #1a6f3b; /* Slightly lighter green for hover */
    }

    .navlink.active {
      background-color: var(--primary-hover); /* Brighter green for active */
      font-weight: 600;
    }

    /* Logout Button in Sidebar */
    .btn-logout {
      background-color: var(--error-red);
      color: white;
      @apply rounded-lg px-4 py-2 font-semibold;
      transition: background-color 0.2s ease-in-out;
    }

    .btn-logout:hover {
      background-color: #b91c1c; /* Darker red on hover */
    }

    /* Mobile Header Bar */
    .mobile-header {
      background-color: var(--card-bg); /* White background for mobile header */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      z-index: 50;
    }

    /* Main Content Area */
    .main-content {
      flex-grow: 1; /* Occupy remaining space */
      padding: 1.5rem; /* Equivalent to p-6 */
    }

    /* Section Titles */
    .section-title {
      color: var(--text-dark);
      @apply text-2xl lg:text-3xl font-bold;
    }

    /* Card Styling */
    .stat-card, .content-card {
      background-color: var(--card-bg);
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* subtle shadows */
      padding: 1.5rem; /* p-6 */
    }

    .stat-card {
      text-align: center;
    }

    .stat-card .icon {
      margin-bottom: 0.5rem;
    }

    /* No Data Message */
    .no-data {
      background-color: #ecfdf5; /* Light green */
      border: 1px solid var(--success-green); /* Green border */
      color: var(--success-green); /* Green text for heading */
    }

    /* Table Styling */
    .table-container {
      overflow-x: auto;
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      background-color: var(--card-bg);
    }

    table.data {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--card-bg);
    }

    table.data th, table.data td {
      text-align: left;
      padding: 1rem 1.5rem; /* Adjust padding for better look */
      border-bottom: 1px solid #e5e7eb; /* Light gray border */
    }

    table.data thead th {
      position: sticky;
      top: 0;
      background-color: var(--card-bg); /* Match card background */
      z-index: 1;
      text-transform: uppercase;
      font-size: 0.75rem; /* text-xs */
      letter-spacing: 0.05em;
      color: var(--text-muted);
      font-weight: 600;
    }

    table.data tbody tr:nth-child(even) {
      background-color: #f9fafb; /* Lighter background for striped rows */
    }

    table.data tbody tr:hover {
      background-color: #f3f4f6; /* Hover highlight */
    }

    /* Button Styling */
    .btn {
      @apply inline-flex items-center gap-2 rounded-lg px-4 py-2 font-semibold transition-colors duration-200;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
    }

    .btn-muted {
      background-color: #e5e7eb; /* Light grey */
      color: var(--text-dark);
      border: 1px solid #d1d5db;
    }

    .btn-muted:hover {
      background-color: #d1d5db;
    }

    .btn-red {
        background-color: var(--error-red);
        color: white;
    }
    .btn-red:hover {
        background-color: #b91c1c;
    }

    /* Utility */
    .chip {
      @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium;
    }
    .chip-success { background-color: #d1fae5; color: var(--success-green); }
    .chip-error { background-color: #fee2e2; color: var(--error-red); }
    .chip-pending { background-color: #fef3c7; color: var(--pending-yellow); }

    /* Responsive Adjustments */
    @media (max-width: 1023px) { /* On small screens (lg breakpoint is 1024px) */
      .sidebar {
        position: fixed;
        height: 100dvh;
        z-index: 60; /* Higher z-index for sidebar */
      }
      .app-shell {
        flex-direction: column; /* Stack header, main content, and sidebar */
      }
      .main-content {
        margin-left: 0; /* Remove fixed margin for mobile */
      }
    }
    @media (min-width: 1024px) { /* On desktop */
      .mobile-header {
        display: none;
      }
      .sidebar.mobile-hidden {
        transform: translateX(0); /* Ensure sidebar is visible on desktop */
      }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading" class="loading-overlay fixed inset-0 hidden place-items-center z-[100]">
    <div class="w-72 bg-white p-6 rounded-2xl shadow-2xl text-center">
      <div class="mx-auto mb-4 h-12 w-12 rounded-full border-4 spinner animate-spin"></div>
      <div id="loadingText" class="text-green-600 font-semibold">Loading…</div>
    </div>
  </div>

  <!-- Auth / Login Card -->
  <div id="loginView" class="min-h-screen grid place-items-center p-6 bg-gray-100">
    <div class="w-full max-w-md login-card rounded-2xl p-8 shadow-lg">
      <div class="flex items-center justify-center gap-3 mb-6">
        <div class="h-12 w-12 rounded-xl bg-green-700 grid place-items-center text-white text-2xl"><i class="fa-solid fa-shield-halved"></i></div>
        <h1 class="text-3xl font-bold text-gray-800">Admin Login</h1>
      </div>
      <p class="text-sm text-gray-600 mb-6 text-center">Sign in with an account whose UID exists in <span class="font-mono text-gray-800">admins/{uid}</span> and has <span class="font-mono text-gray-800">isAdmin: true</span>.</p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input id="email" type="email" class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-green-500 focus:border-green-500" placeholder="admin@example.com" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input id="password" type="password" class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-green-500 focus:border-green-500" placeholder="••••••••" />
        </div>
        <button id="loginBtn" class="btn btn-primary w-full justify-center"><i class="fa-solid fa-right-to-bracket"></i> Sign In</button>
      </div>
    </div>
  </div>

  <!-- App Shell -->
  <div id="app" class="hidden app-shell">
    <!-- Topbar (mobile) -->
    <header class="mobile-header fixed top-0 w-full lg:hidden px-4 py-3 flex items-center justify-between">
      <button id="burger" class="btn btn-muted px-3 py-2"><i class="fa-solid fa-bars"></i></button>
      <div class="flex items-center gap-2 font-semibold text-gray-800">
        <div class="h-8 w-8 rounded-full bg-green-600 grid place-items-center text-white text-base"><i class="fa-solid fa-graduation-cap"></i></div>
        Admin Portal
      </div>
      <button id="logoutBtnMobile" class="btn btn-logout px-3 py-2"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full flex flex-col p-4 mobile-hidden lg:relative lg:translate-x-0">
      <div class="hidden lg:flex items-center gap-3 px-2 py-4">
        <div class="h-10 w-10 rounded-xl bg-green-600 grid place-items-center text-white text-xl"><i class="fa-solid fa-graduation-cap"></i></div>
        <div>
          <div class="font-semibold text-white leading-tight text-lg">University Admin</div>
          <div class="text-sm text-gray-300">Control Center</div>
        </div>
      </div>
      <nav class="mt-4 space-y-3 flex-1">
        <a data-section="dashboard" class="navlink active" href="#"><i class="fa-solid fa-chart-line w-6 text-center"></i><span>Dashboard</span></a>
        <a data-section="students" class="navlink" href="#"><i class="fa-solid fa-users w-6 text-center"></i><span>Students</span></a>
        <a data-section="courses" class="navlink" href="#"><i class="fa-solid fa-book w-6 text-center"></i><span>Courses</span></a>
        <a data-section="fees" class="navlink" href="#"><i class="fa-solid fa-money-bill-wave w-6 text-center"></i><span>Fees</span></a>
        <a data-section="grades" class="navlink" href="#"><i class="fa-solid fa-award w-6 text-center"></i><span>Grades</span></a>
        <a data-section="hostels" class="navlink" href="#"><i class="fa-solid fa-building w-6 text-center"></i><span>Hostels</span></a>
        <a data-section="announcements" class="navlink" href="#"><i class="fa-solid fa-bullhorn w-6 text-center"></i><span>Announcements</span></a>
        <a data-section="graduation" class="navlink" href="#"><i class="fa-solid fa-user-graduate w-6 text-center"></i><span>Graduation</span></a>
        <a data-section="clearance" class="navlink" href="#"><i class="fa-solid fa-circle-check w-6 text-center"></i><span>Clearance</span></a>
        <a data-section="admins" class="navlink" href="#"><i class="fa-solid fa-user-shield w-6 text-center"></i><span>Admins</span></a>
      </nav>
      <div class="mt-auto p-2">
        <button id="logoutBtnDesktop" class="btn btn-logout w-full justify-center"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button>
      </div>
    </aside>

    <!-- Main area -->
    <main class="main-content flex-1 pt-20 lg:pt-8 space-y-6">
      <div class="flex items-center justify-between mb-6">
        <h1 class="section-title" id="currentSectionTitle">Dashboard</h1>
        <div class="text-sm text-gray-600" id="adminBadge"><span class="chip chip-pending">Not verified</span></div>
      </div>

      <!-- Sections -->
      <section id="dashboardSection" class="space-y-6"></section>
      <section id="studentsSection" class="hidden space-y-4"></section>
      <section id="coursesSection" class="hidden space-y-4"></section>
      <section id="feesSection" class="hidden space-y-4"></section>
      <section id="gradesSection" class="hidden space-y-4"></section>
      <section id="hostelsSection" class="hidden space-y-4"></section>
      <section id="announcementsSection" class="hidden space-y-4"></section>
      <section id="graduationSection" class="hidden space-y-4"></section>
      <section id="clearanceSection" class="hidden space-y-4"></section>
      <section id="adminsSection" class="hidden space-y-4"></section>
    </main>
  </div>

  <!-- Firebase + App Code -->
  <script type="module">
    /* =========================
       Firebase Setup
    ==========================*/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase config from original file - DO NOT MODIFY
    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.firebaseostorage.app",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Single admin check flag (set ONCE after login)
    let isAdminUser = false;

    /* =========================
       DOM helpers
    ==========================*/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    const setLoading = (on, text='Loading…') => {
      const overlay = $('#loading');
      $('#loadingText').textContent = text;
      if (on) {
        overlay.classList.remove('hidden');
        overlay.classList.add('grid'); // Ensure grid display for centering
      } else {
        overlay.classList.add('hidden');
        overlay.classList.remove('grid');
      }
    };

    const renderPlaceholder = (container, { title, icon, lines = [], note }) => {
      container.innerHTML = `
        <div class="no-data rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-1"><i class="${icon} mr-2 text-green-700"></i>${title}</h3>
          ${lines.map(l => `<p class="text-sm text-green-800">${l}</p>`).join('')}
          ${note ? `<p class="text-xs mt-2 text-green-700 opacity-80">${note}</p>`: ''}
        </div>`;
    };

    // renderSkeletonCards function is no longer explicitly called in preloadSection for tables,
    // as it's replaced by immediate table rendering or placeholder.
    // However, keeping it just in case it's used elsewhere.
    const renderSkeletonCards = (container, n=4) => {
      container.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">${
        Array.from({length:n}).map(() => `<div class="stat-card skeleton h-28"></div>`).join('')
      }</div>`;
    };

    // Updated table helper for new styling
    const table = (headers, rows, tableId) => `
      <div class="table-container">
        <table id="${tableId}" class="data">
          <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
          <tbody>
            ${rows.length ? rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="${headers.length}" class="py-6 text-center text-gray-500">No data available.</td></tr>`}
          </tbody>
        </table>
      </div>`;

    const exportTable = (tableId, filename) => {
      const tbl = document.getElementById(tableId);
      if(!tbl) return;
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(tbl);
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, `${filename}.xlsx`);
    };

    /* =========================
       Auth flow (single admin check)
    ==========================*/
    const loginView = $('#loginView');
    const appShell = $('#app');

    const showApp = () => { hide(loginView); show(appShell); };
    const showLogin = () => { show(loginView); hide(appShell); };

    onAuthStateChanged(auth, async (user) => {
      if(!user){ isAdminUser=false; showLogin(); return; }
      setLoading(true, 'Verifying administrator…');
      try {
        const adminDoc = await getDoc(doc(db, 'admins', user.uid));
        if(adminDoc.exists() && adminDoc.data().isAdmin === true){
          isAdminUser = true; // ✅ set once
          $('#adminBadge').innerHTML = '<span class="chip chip-success">Admin Verified</span>';
          showApp();
          // default section
          activateSection('dashboard');
        } else {
          await signOut(auth);
          // Replaced alert with a simple message within the login view area or custom modal
          const messageContainer = document.createElement('div');
          messageContainer.className = 'mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm';
          messageContainer.textContent = 'Your account is not authorized as an administrator.';
          loginView.querySelector('.login-card').appendChild(messageContainer);
        }
      } catch(err){
        console.error(err);
        // Replaced alert with a simple message within the login view area
        const messageContainer = document.createElement('div');
        messageContainer.className = 'mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm';
        messageContainer.textContent = 'Login verification failed: ' + err.message;
        loginView.querySelector('.login-card').appendChild(messageContainer);
      } finally { setLoading(false); }
    });

    $('#loginBtn').addEventListener('click', async() => {
      const email = $('#email').value.trim();
      const password = $('#password').value;
      if(!email || !password){
        const messageContainer = document.createElement('div');
        messageContainer.className = 'mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm';
        messageContainer.textContent = 'Please enter both email and password.';
        loginView.querySelector('.login-card').appendChild(messageContainer);
        return;
      }
      setLoading(true, 'Signing in…');
      try{
        await signInWithEmailAndPassword(auth, email, password);
      } catch(e){
        const messageContainer = document.createElement('div');
        messageContainer.className = 'mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm';
        messageContainer.textContent = 'Login failed: ' + e.message;
        loginView.querySelector('.login-card').appendChild(messageContainer);
      } finally{ setLoading(false); }
    });

    const doLogout = async () => {
        try{
            await signOut(auth);
        } catch(e){
            // Use a custom message display instead of alert
            const messageContainer = document.createElement('div');
            messageContainer.className = 'mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm';
            messageContainer.textContent = 'Logout failed: ' + e.message;
            document.body.appendChild(messageContainer); // Or append to a designated area
            setTimeout(() => messageContainer.remove(), 5000); // Remove after 5 seconds
        }
    };
    $('#logoutBtnMobile').addEventListener('click', doLogout);
    $('#logoutBtnDesktop').addEventListener('click', doLogout);

    // Mobile sidebar toggle
    $('#burger').addEventListener('click', ()=> {
      const sb = $('#sidebar');
      sb.classList.toggle('mobile-hidden');
    });

    // Close sidebar when clicking outside (on mobile)
    appShell.addEventListener('click', (e) => {
        const sidebar = $('#sidebar');
        const burgerButton = $('#burger');
        // If sidebar is open and click is outside sidebar and not on burger button
        if (!sidebar.classList.contains('mobile-hidden') && !sidebar.contains(e.target) && !burgerButton.contains(e.target)) {
            sidebar.classList.add('mobile-hidden');
        }
    });

    /* =========================
       Navigation + sections
    ==========================*/
    const activateSection = (key) => {
      // Update section title
      const titleMap = {
          dashboard: 'Dashboard',
          students: 'Students Management',
          courses: 'Courses Management',
          fees: 'Fees Management',
          grades: 'Grades Management',
          hostels: 'Hostels Management',
          announcements: 'Announcements',
          graduation: 'Graduation Requests',
          clearance: 'Clearance Requests',
          admins: 'Admin Accounts'
      };
      $('#currentSectionTitle').textContent = titleMap[key] || 'Admin Dashboard';

      // links
      $$(".navlink").forEach(a=>{
        if(a.dataset.section===key) a.classList.add('active'); else a.classList.remove('active');
      });
      // sections
      const ids = ['dashboard','students','courses','fees','grades','hostels','announcements','graduation','clearance','admins'];
      ids.forEach(id => { const sec = document.getElementById(id+"Section"); id===key ? show(sec) : hide(sec); });
      // render immediate placeholders (never blocked by Firestore)
      preloadSection(key);
      // then fetch
      fetchSection(key);
      // close mobile sidebar if open
      $('#sidebar').classList.add('mobile-hidden');
    };

    $$(".navlink").forEach(a => a.addEventListener('click', e => { e.preventDefault(); activateSection(a.dataset.section); }));

    const preloadSection = (key) => {
      const sec = document.getElementById(key+"Section");
      if(!sec) return;
      sec.innerHTML = '';
      // Always show an informative header + skeletons or default tips
      if(key==='dashboard'){
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6'; // Adjusted gap for spacing
        wrap.innerHTML = `
            <div class="stat-card flex flex-col justify-center items-center">
                <i class="fa-solid fa-users text-green-500 text-3xl mb-2"></i>
                <div class="text-sm text-gray-600">Total Students</div>
                <div id="statStudents" class="text-4xl font-extrabold mt-1 text-gray-900">0</div>
            </div>
            <div class="stat-card flex flex-col justify-center items-center">
                <i class="fa-solid fa-book-open text-blue-500 text-3xl mb-2"></i>
                <div class="text-sm text-gray-600">Total Courses</div>
                <div id="statCourses" class="text-4xl font-extrabold mt-1 text-gray-900">0</div>
            </div>
            <div class="stat-card flex flex-col justify-center items-center">
                <i class="fa-solid fa-hourglass-half text-yellow-500 text-3xl mb-2"></i>
                <div class="text-sm text-gray-600">Pending Graduation</div>
                <div id="statGrad" class="text-4xl font-extrabold mt-1 text-gray-900">0</div>
            </div>
            <div class="stat-card flex flex-col justify-center items-center">
                <i class="fa-solid fa-clipboard-check text-red-500 text-3xl mb-2"></i>
                <div class="text-sm text-gray-600">Pending Clearance</div>
                <div id="statClear" class="text-4xl font-extrabold mt-1 text-gray-900">0</div>
            </div>
          `;
        sec.appendChild(wrap);
        const dashTips = document.createElement('div');
        dashTips.id = 'dashTips';
        sec.appendChild(dashTips);
        renderPlaceholder(dashTips, { title: 'Dashboard Overview', icon: 'fa-solid fa-chart-line', lines:[
          'This overview will auto-populate when connected to Firestore.',
          'Use the sidebar to manage students, courses, finances, and more.'
        ], note: 'Tip: Click Students or Courses to begin.' });
      } else {
        const tips = document.createElement('div');
        sec.appendChild(tips);
        const map = {
          students: ['Manage and view registered students.', 'Search, edit, export, and print lists.'],
          courses: ['Manage available courses.', 'Add, edit, or remove courses.'],
          fees: ['Search a student to view their statement.', 'Record charges/payments and export.'],
          grades: ['View and record student grades.', 'Generate transcripts as needed.'],
          hostels: ['Manage hostel capacity and settings.', 'Toggle applications open/closed.'],
          announcements: ['Create announcements for all users.', 'Edit or remove outdated notices.'],
          graduation: ['Track graduation requests and status.'],
          clearance: ['Track clearance requests and status.'],
          admins: ['Manage admin accounts and roles.']
        };
        renderPlaceholder(tips, { title: key.charAt(0).toUpperCase()+key.slice(1) + ' Management', icon:'fa-solid fa-circle-info', lines: map[key]||[], note: 'This appears even without Firestore data.'});
      }
    };

    /* =========================
       Fetchers (execute after UI shows)
       Note: they rely on isAdminUser; UI never blocks
    ==========================*/
    const fetchSection = async (key) => {
      try{
        if(!isAdminUser) return; // respect single admin verification; do not re-check
        if(key==='dashboard') return fetchDashboard();
        if(key==='students') return fetchStudents();
        if(key==='courses') return fetchCourses();
        if(key==='fees') return renderFeesSearch();
        if(key==='grades') return renderGradesSearch();
        if(key==='hostels') return fetchHostels();
        if(key==='announcements') return fetchAnnouncements();
        if(key==='graduation') return fetchGraduation();
        if(key==='clearance') return fetchClearance();
        if(key==='admins') return fetchAdmins();
      } catch(e){
        console.error(e);
        const sec = document.getElementById(key+"Section");
        if (sec) {
            sec.innerHTML = `<div class="no-data rounded-lg p-4 bg-red-100 border-red-400 text-red-700">
                <h3 class="text-lg font-semibold mb-1"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Error Loading Data</h3>
                <p class="text-sm">Failed to load ${key} data. Please check your Firestore connection and permissions. ${e.message}</p>
            </div>`;
        }
      }
    };

    /* ============= Dashboard ============= */
    const fetchDashboard = async () => {
      const [studentsSnap, coursesSnap, gradSnap, clearSnap] = await Promise.all([
        getDocs(collection(db,'students')),
        getDocs(collection(db,'courses')),
        getDocs(query(collection(db,'graduationRequests'), where('status','==','Pending'))),
        getDocs(query(collection(db,'clearanceRequests'), where('status','==','Pending')))
      ]);
      $('#statStudents').textContent = studentsSnap.size;
      $('#statCourses').textContent = coursesSnap.size;
      $('#statGrad').textContent = gradSnap.size;
      $('#statClear').textContent = clearSnap.size;
    };

    /* ============= Students ============= */
    const fetchStudents = async () => {
      const sec = $('#studentsSection');
      const snap = await getDocs(collection(db,'students'));
      const rows = snap.docs.map(d => ({ uid:d.id, ...d.data() }));
      const hdrs = ['Name','Email','Program','Year','Contact','Actions'];
      const box = document.createElement('div');
      box.className = 'content-card space-y-4'; // Use content-card for general sections
      box.innerHTML = `
        <div class="flex flex-col sm:flex-row gap-4 sm:items-center justify-between">
          <input id="studentSearch" class="w-full sm:w-72 rounded-lg border border-gray-300 px-4 py-2 focus:ring-green-500 focus:border-green-500" placeholder="Search students…"/>
          <div class="flex gap-2">
            <button class="btn btn-primary" onclick="window.addStudent()"><i class="fa-solid fa-user-plus"></i> Add Student</button>
            <button class="btn btn-muted" onclick="window.exportById('studentsTbl','Students')"><i class="fa-solid fa-file-export"></i> Export</button>
          </div>
        </div>
        ${table(hdrs, rows.map(r => [
                r.name||'—', r.email||'—', r.programme||'—', r.year||'—', r.contact||'—',
                `<div class="flex gap-2">
                    <button class="btn btn-muted btn-sm" onclick="window.editStudent('${r.uid}')">Edit</button>
                    <button class="btn btn-red btn-sm" onclick="window.deleteStudent('${r.uid}')">Delete</button>
                </div>`
            ]), 'studentsTbl')}`;
      sec.innerHTML = ''; // Clear existing preload content
      sec.appendChild(box);
      // simple client filter
      const input = $('#studentSearch');
      input?.addEventListener('input', () => {
        const v = input.value.toLowerCase();
        $$('#studentsTbl tbody tr').forEach(tr => {
          tr.style.display = tr.textContent.toLowerCase().includes(v) ? '' : 'none';
        });
      });
    };

    // Basic CRUD exposed globally for inline handlers
    window.addStudent = () => {
      const name = prompt('Full name'); if(!name) return;
      const email = prompt('Email (document id)'); if(!email) return;
      setDoc(doc(db,'students', email.toLowerCase()), { name, email: email.toLowerCase(), createdAt: serverTimestamp() });
      activateSection('students'); // Re-render section after add
    };
    window.editStudent = async(uid) => {
      const snap = await getDoc(doc(db,'students', uid)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const name = prompt('Full name', cur.name||''); if(!name) return;
      await updateDoc(doc(db,'students', uid), { name });
      activateSection('students'); // Re-render section after edit
    };
    window.deleteStudent = async(uid) => {
        // Use a custom confirmation modal or message instead of alert/confirm
        if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
            return;
        }
        await deleteDoc(doc(db,'students', uid));
        activateSection('students'); // Re-render section after delete
    };

    /* ============= Courses ============= */
    const fetchCourses = async () => {
      const sec = $('#coursesSection');
      const snap = await getDocs(collection(db,'courses'));
      const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      const hdrs = ['Code','Name','Credits','Lecturer','Schedule','Actions'];
      sec.innerHTML = `
        <div class="content-card space-y-4">
            <div class="flex items-center justify-between gap-2">
                <p class="text-sm text-gray-600">Manage courses and their details.</p>
                <div class="flex gap-2">
                    <button class="btn btn-primary" onclick="window.addCourse()"><i class="fa-solid fa-plus"></i> Add Course</button>
                    <button class="btn btn-muted" onclick="window.exportById('coursesTbl','Courses')"><i class="fa-solid fa-file-export"></i> Export</button>
                </div>
            </div>
            ${table(hdrs, rows.map(r=>`<tr>
              <td>${r.code||r.id}</td><td>${r.title||'—'}</td><td>${r.credits||'—'}</td><td>${r.lecturer||'—'}</td><td>${r.schedule||'—'}</td>
              <td><div class="flex gap-2">
                <button class="btn btn-muted btn-sm" onclick="window.editCourse('${r.id}')">Edit</button>
                <button class="btn btn-red btn-sm" onclick="window.deleteCourse('${r.id}')">Delete</button>
              </div></td>
            </tr>`), 'coursesTbl')}
        </div>`;
    };
    window.addCourse = async () => {
      const code = prompt('Course code (document ID)'); if(!code) return;
      const title = prompt('Course name'); if(!title) return;
      await setDoc(doc(db,'courses', code), { code, title, createdAt: serverTimestamp() });
      activateSection('courses');
    };
    window.editCourse = async (id) => {
      const snap = await getDoc(doc(db,'courses', id)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const title = prompt('Course name', cur.title||''); if(!title) return;
      await updateDoc(doc(db,'courses', id), { title });
      activateSection('courses');
    };
    window.deleteCourse = async(id) => {
        if (!confirm('Are you sure you want to delete this course?')) return;
        await deleteDoc(doc(db,'courses', id));
        activateSection('courses');
    };

    /* ============= Fees ============= */
    const renderFeesSearch = () => {
      const sec = $('#feesSection');
      sec.innerHTML = `
        <div class="content-card space-y-4">
          <div class="flex flex-col sm:flex-row gap-4 sm:items-center justify-between">
            <input id="feesEmail" class="w-full sm:w-80 rounded-lg border border-gray-300 px-4 py-2 focus:ring-green-500 focus:border-green-500" placeholder="Search student by email…"/>
            <button class="btn btn-primary" id="btnFeesSearch"><i class="fa-solid fa-magnifying-glass"></i> Search Student</button>
          </div>
          <div id="feesInfo"></div>
          <div id="feesTableWrap"></div>
        </div>`;
      $('#btnFeesSearch').addEventListener('click', doFeesSearch);
      renderPlaceholder($('#feesInfo'), { title:'Fees Management', icon:'fa-solid fa-money-bill-wave', lines:['Look up a student to view their statement.']});
    };

    const doFeesSearch = async () => {
      const email = ($('#feesEmail').value||'').toLowerCase();
      if(!email) {
          // Custom message
          $('#feesTableWrap').innerHTML = '<div class="no-data rounded-lg p-3 bg-red-100 border-red-400 text-red-700">Please enter a student email to search.</div>';
          return;
      }
      setLoading(true, 'Searching for student…');
      try {
          const q = query(collection(db,'students'), where('email','==', email));
          const res = await getDocs(q);
          if(res.empty) {
              $('#feesInfo').innerHTML = ''; // Clear previous info
              $('#feesTableWrap').innerHTML = '<div class="no-data rounded-lg p-3 bg-red-100 border-red-400 text-red-700">Student not found with that email.</div>';
              return;
          }
          const stu = { uid: res.docs[0].id, ...res.docs[0].data() }; // Corrected line: removed 'федера'
          $('#feesInfo').innerHTML = `<div class="text-lg font-semibold text-gray-800">Statement for <span class="text-green-700">${stu.name||email}</span></div>`;
          // simple demo table — adapt to your structure
          const hdrs = ['Date','Description','Amount','Balance', 'Actions'];
          // Example: Fetch actual fee records for the student if available
          const feeRecordsSnap = await getDocs(query(collection(db, 'fees'), where('studentUid', '==', stu.uid)));
          const feeRows = feeRecordsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

          const tableRows = feeRows.map(f => [
              (f.date && f.date.toDate) ? f.date.toDate().toLocaleDateString() : '—',
              f.description || '—',
              `$${f.amount?.toFixed(2) || '0.00'}`,
              `$${f.balance?.toFixed(2) || '0.00'}`,
              `<div class="flex gap-2">
                    <button class="btn btn-muted btn-sm" onclick="window.editFee('${f.id}')">Edit</button>
                    <button class="btn btn-red btn-sm" onclick="window.deleteFee('${f.id}')">Delete</button>
                </div>`
          ]);

          $('#feesTableWrap').innerHTML = table(hdrs, tableRows, 'feesTbl');
      } catch (error) {
          console.error("Error fetching fees:", error);
          $('#feesTableWrap').innerHTML = '<div class="no-data rounded-lg p-3 bg-red-100 border-red-400 text-red-700">Error loading fee data.</div>';
      } finally {
          setLoading(false);
      }
    };

    // Placeholder for fee CRUD operations (if needed in future)
    window.editFee = (id) => { /* Implement modal or form for editing fee record */ console.log("Edit fee:", id); };
    window.deleteFee = (id) => { /* Implement confirmation and deletion */ console.log("Delete fee:", id); };

    /* ============= Grades ============= */
    const renderGradesSearch = () => {
      const sec = $('#gradesSection');
      sec.innerHTML = `
        <div class="content-card space-y-4">
          <div class="flex flex-col sm:flex-row gap-4 sm:items-center justify-between">
            <input id="gradesEmail" class="w-full sm:w-80 rounded-lg border border-gray-300 px-4 py-2 focus:ring-green-500 focus:border-green-500" placeholder="Search student by email…"/>
            <button class="btn btn-primary" id="btnGradesSearch"><i class="fa-solid fa-magnifying-glass"></i> Search Student</button>
          </div>
          <div id="gradesInfo"></div>
          <div id="gradesTableWrap"></div>
        </div>`;
      $('#btnGradesSearch').addEventListener('click', doGradesSearch);
      renderPlaceholder($('#gradesInfo'), { title:'Grades Management', icon:'fa-solid fa-award', lines:['Look up a student to view their grades.']});
    };
    const doGradesSearch = async () => {
      const email = ($('#gradesEmail').value||'').toLowerCase();
      if(!email) {
          $('#gradesTableWrap').innerHTML = '<div class="no-data rounded-lg p-3 bg-red-100 border-red-400 text-red-700">Please enter a student email to search.</div>';
          return;
      }
      setLoading(true, 'Searching for student grades…');
      try {
          const q = query(collection(db,'students'), where('email','==', email));
          const res = await getDocs(q);
          if(res.empty) {
              $('#gradesInfo').innerHTML = ''; // Clear previous info
              $('#gradesTableWrap').innerHTML = '<div class="no-data rounded-lg p-3 bg-red-100 border-red-400 text-red-700">Student not found with that email.</div>';
              return;
          }
          const stu = { uid: res.docs[0].id, ...res.docs[0].data() };
          $('#gradesInfo').innerHTML = `<div class="text-lg font-semibold text-gray-800">Grades for <span class="text-green-700">${stu.name||email}</span></div>`;
          const hdrs = ['Course Code','Course Name','Grade', 'Actions'];
          // Example: Fetch actual grade records for the student
          const gradeRecordsSnap = await getDocs(query(collection(db, 'grades'), where('studentUid', '==', stu.uid)));
          const gradeRows = gradeRecordsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

          const tableRows = gradeRows.map(g => [
              g.courseCode || '—',
              g.courseName || '—',
              g.grade || '—',
              `<div class="flex gap-2">
                    <button class="btn btn-muted btn-sm" onclick="window.editGrade('${g.id}')">Edit</button>
                    <button class="btn btn-red btn-sm" onclick="window.deleteGrade('${g.id}')">Delete</button>
                </div>`
          ]);

          $('#gradesTableWrap').innerHTML = table(hdrs, tableRows, 'gradesTbl');
      } catch (error) {
          console.error("Error fetching grades:", error);
          $('#gradesTableWrap').innerHTML = '<div class="no-data rounded-lg p-3 bg-red-100 border-red-400 text-red-700">Error loading grade data.</div>';
      } finally {
          setLoading(false);
      }
    };

    // Placeholder for grade CRUD operations (if needed in future)
    window.editGrade = (id) => { /* Implement modal or form for editing grade */ console.log("Edit grade:", id); };
    window.deleteGrade = (id) => { /* Implement confirmation and deletion */ console.log("Delete grade:", id); };

    /* ============= Hostels ============= */
    const fetchHostels = async () => {
      const sec = $('#hostelsSection');
      const snap = await getDocs(collection(db,'hostels'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const hdrs = ['Hostel','Capacity','Occupied','Status','Actions'];
      sec.innerHTML = `
        <div class="content-card space-y-4">
            <div class="flex items-center justify-between gap-2">
                <p class="text-sm text-gray-600">Manage hostel capacities and availability.</p>
                <button class="btn btn-primary" onclick="window.addHostel()"><i class="fa-solid fa-plus"></i> Add Hostel</button>
            </div>
            ${table(hdrs, rows.map(r=>`<tr>
              <td>${r.name||r.id}</td><td>${r.capacity||'—'}</td><td>${r.occupied||0}</td>
              <td>${r.open===false?'<span class="chip chip-error">Closed</span>':'<span class="chip chip-success">Open</span>'}</td>
              <td><div class="flex gap-2">
                <button class="btn btn-muted btn-sm" onclick="window.editHostel('${r.id}')">Edit</button>
                <button class="btn btn-red btn-sm" onclick="window.deleteHostel('${r.id}')">Delete</button>
              </div></td>
            </tr>`), 'hostelsTbl')}
        </div>`;
    };
    window.addHostel = async () => {
      const id = prompt('Hostel ID'); if(!id) return;
      const name = prompt('Hostel name'); if(!name) return;
      await setDoc(doc(db,'hostels', id), { name, capacity: 0, occupied: 0, open: true, createdAt: serverTimestamp() });
      activateSection('hostels');
    };
    window.editHostel = async (id) => {
      const snap = await getDoc(doc(db,'hostels', id)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const capacity = parseInt(prompt('Capacity', cur.capacity||0));
      await updateDoc(doc(db,'hostels', id), { capacity });
      activateSection('hostels');
    };
    window.deleteHostel = async (id) => {
        if (!confirm('Are you sure you want to delete this hostel?')) return;
        await deleteDoc(doc(db,'hostels', id));
        activateSection('hostels');
    };

    /* ============= Announcements ============= */
    const fetchAnnouncements = async () => {
      const sec = $('#announcementsSection');
      const snap = await getDocs(collection(db,'announcements'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const hdrs = ['Title','Body','Created','Actions'];
      sec.innerHTML = `
        <div class="content-card space-y-4">
            <div class="flex items-center justify-between gap-2">
                <p class="text-sm text-gray-600">Post and manage announcements for all portal users.</p>
                <button class="btn btn-primary" onclick="window.addAnnouncement()"><i class="fa-solid fa-plus"></i> Add Announcement</button>
            </div>
            ${table(hdrs, rows.map(r=>`<tr>
              <td>${r.title||'—'}</td><td>${r.body||'—'}</td><td>${(r.createdAt && r.createdAt.toDate)? r.createdAt.toDate().toLocaleString():'—'}</td>
              <td><div class="flex gap-2">
                <button class="btn btn-muted btn-sm" onclick="window.editAnnouncement('${r.id}')">Edit</button>
                <button class="btn btn-red btn-sm" onclick="window.deleteAnnouncement('${r.id}')">Delete</button>
              </div></td>
            </tr>`), 'annTbl')}
        </div>`;
    };
    window.addAnnouncement = async () => {
      const id = crypto.randomUUID();
      const title = prompt('Title'); if(!title) return;
      const body = prompt('Body'); if(!body) return;
      await setDoc(doc(db,'announcements', id), { title, body, createdAt: serverTimestamp() });
      activateSection('announcements');
    };
    window.editAnnouncement = async (id) => {
      const snap = await getDoc(doc(db,'announcements', id)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const title = prompt('Title', cur.title||''); if(!title) return;
      const body = prompt('Body', cur.body||''); if(!body) return;
      await updateDoc(doc(db,'announcements', id), { title, body });
      activateSection('announcements');
    };
    window.deleteAnnouncement = async (id) => {
        if (!confirm('Are you sure you want to delete this announcement?')) return;
        await deleteDoc(doc(db,'announcements', id));
        activateSection('announcements');
    };

    /* ============= Graduation & Clearance ============= */
    const fetchGraduation = async () => {
      const sec = $('#graduationSection');
      const snap = await getDocs(collection(db,'graduationRequests'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const hdrs = ['Student Email','Status','Requested Date', 'Actions'];
      sec.innerHTML = `
        <div class="content-card">
            <p class="text-sm text-gray-600 mb-4">Review and manage student graduation requests.</p>
            ${table(hdrs, rows.map(r=>[
                r.studentEmail||r.id,
                r.status === 'Pending' ? `<span class="chip chip-pending">${r.status}</span>` : `<span class="chip chip-success">${r.status}</span>`,
                (r.createdAt && r.createdAt.toDate)? r.createdAt.toDate().toLocaleDateString():'—',
                `<div class="flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="window.updateGraduationStatus('${r.id}', 'Approved')">Approve</button>
                    <button class="btn btn-red btn-sm" onclick="window.updateGraduationStatus('${r.id}', 'Rejected')">Reject</button>
                </div>`
            ]), 'graduationTbl')}
        </div>`;
    };

    window.updateGraduationStatus = async (id, status) => {
        await updateDoc(doc(db, 'graduationRequests', id), { status });
        activateSection('graduation');
    };

    const fetchClearance = async () => {
      const sec = $('#clearanceSection');
      const snap = await getDocs(collection(db,'clearanceRequests'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const hdrs = ['Student Email','Status','Requested Date', 'Actions'];
      sec.innerHTML = `
        <div class="content-card">
            <p class="text-sm text-gray-600 mb-4">Review and manage student clearance requests.</p>
            ${table(hdrs, rows.map(r=>[
                r.studentEmail||r.id,
                r.status === 'Pending' ? `<span class="chip chip-pending">${r.status}</span>` : `<span class="chip chip-success">${r.status}</span>`,
                (r.createdAt && r.createdAt.toDate)? r.createdAt.toDate().toLocaleDateString():'—',
                `<div class="flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="window.updateClearanceStatus('${r.id}', 'Approved')">Approve</button>
                    <button class="btn btn-red btn-sm" onclick="window.updateClearanceStatus('${r.id}', 'Rejected')">Reject</button>
                </div>`
            ]), 'clearanceTbl')}
        </div>`;
    };

    window.updateClearanceStatus = async (id, status) => {
        await updateDoc(doc(db, 'clearanceRequests', id), { status });
        activateSection('clearance');
    };

    /* ============= Admins ============= */
    const fetchAdmins = async () => {
      const sec = $('#adminsSection');
      const snap = await getDocs(collection(db,'admins'));
      const rows = snap.docs.map(d=>({ uid:d.id, ...d.data() }));
      const hdrs = ['UID','Email','Admin Status','Actions'];
      sec.innerHTML = `
        <div class="content-card space-y-4">
            <div class="flex items-center justify-between gap-2">
                <p class="text-sm text-gray-600">Manage administrator accounts and their permissions.</p>
                <button class="btn btn-primary" onclick="window.addAdmin()"><i class="fa-solid fa-user-plus"></i> Add Admin</button>
            </div>
            ${table(hdrs, rows.map(r=>`<tr>
              <td>${r.uid}</td><td>${r.email||'—'}</td>
              <td>${r.isAdmin? '<span class="chip chip-success">Yes</span>':'<span class="chip chip-error">No</span>'}</td>
              <td><div class="flex gap-2">
                <button class="btn btn-muted btn-sm" onclick="window.toggleAdmin('${r.uid}', ${!!r.isAdmin})">Toggle Admin</button>
                <button class="btn btn-red btn-sm" onclick="window.deleteAdmin('${r.uid}')">Delete</button>
              </div></td>
            </tr>`), 'adminsTbl')}
        </div>`;
    };
    window.addAdmin = async () => {
      const uid = prompt('Auth UID'); if(!uid) return;
      const email = prompt('Email (optional)');
      await setDoc(doc(db,'admins', uid), { email: email||null, isAdmin:true, createdAt: serverTimestamp()});
      activateSection('admins');
    };
    window.toggleAdmin = async (uid, cur) => {
        await updateDoc(doc(db,'admins', uid), { isAdmin: !cur });
        activateSection('admins');
    };
    window.deleteAdmin = async (uid) => {
        if (!confirm('Are you sure you want to delete this admin account?')) return;
        await deleteDoc(doc(db,'admins', uid));
        activateSection('admins');
    };

    // Utility export by DOM id
    window.exportById = (id, name) => exportTable(id, name);

    // Start on dashboard placeholders if html opens already authenticated
    // (onAuthStateChanged will re-render)
    preloadSection('dashboard');
  </script>
</body>
</html>
