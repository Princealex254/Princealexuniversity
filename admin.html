<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Firebase Configuration and Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateEmail, updatePassword, sendPasswordResetEmail, deleteUser, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where, updateDoc, deleteDoc, orderBy, serverTimestamp, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;

    // --- UTILITY FUNCTIONS ---
    function showPopup(message, type = 'success') {
      const popup = document.getElementById('popupMsg');
      const popupText = document.getElementById('popupText');
      popupText.textContent = message;
      popup.className = `fixed top-4 inset-x-0 max-w-md mx-auto z-50 shadow-lg rounded p-4 flex items-start justify-between transition-transform duration-500 transform ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} translate-y-0`;
      popup.classList.remove('hidden');
      setTimeout(() => {
        popup.classList.add('translate-y-[-150%]');
        popup.addEventListener('transitionend', () => {
          popup.classList.add('hidden');
        }, { once: true });
      }, 5000);
    }
    
    document.getElementById('popupClose').addEventListener('click', () => {
      document.getElementById('popupMsg').classList.add('hidden');
    });

    function toggleLoading(isLoading) {
      document.getElementById('loadingOverlay').classList.toggle('hidden', !isLoading);
    }
    
    // Generic modal close function
    window.closeModal = (modalId) => {
      document.getElementById(modalId).classList.add('hidden');
    };

    // --- AUTHENTICATION CHECK ---
    onAuthStateChanged(auth, async (user) => {
      toggleLoading(true);
      if (user) {
        try {
          const adminDoc = await getDoc(doc(db, "admins", user.uid));
          if (adminDoc.exists() && adminDoc.data().isAdmin) {
            currentUser = user;
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('userName').textContent = adminDoc.data().name || user.email;
            renderSection('dashboard');
          } else {
            showPopup("Access Denied: Not an admin.", "error");
            await signOut(auth);
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
          }
        } catch (err) {
          showPopup(`Error checking admin status: ${err.message}`, "error");
          await signOut(auth);
          document.getElementById('loadingOverlay').classList.add('hidden');
          document.getElementById('loginPage').classList.remove('hidden');
        }
      } else {
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const password = e.target.password.value;
      try {
        toggleLoading(true);
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        showPopup(`Login failed: ${err.message}`, "error");
        toggleLoading(false);
      }
    });

    document.getElementById('btnLogout').addEventListener('click', () => {
      signOut(auth).then(() => {
        showPopup("Logged out successfully.");
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
      });
    });

    // --- NAVIGATION ---
    const sections = ['dashboard', 'profile', 'settings', 'timetable', 'hostels', 'finance', 'clearance', 'admins', 'students'];

    function renderSection(sectionId) {
      sections.forEach(id => {
        const element = document.getElementById(`section-${id}`);
        if (element) {
          element.classList.add('hidden');
        }
      });
      document.getElementById(`section-${sectionId}`).classList.remove('hidden');
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('bg-slate-700');
        if (item.getAttribute('data-section') === sectionId) {
          item.classList.add('bg-slate-700');
        }
      });
      // Call specific load functions for each section
      if (sectionId === 'profile') loadProfile();
      if (sectionId === 'timetable') loadTimetable();
      if (sectionId === 'hostels') loadHostels();
      if (sectionId === 'finance') loadFinance();
      if (sectionId === 'clearance') loadClearance();
      if (sectionId === 'admins') loadAdmins();
      if (sectionId === 'students') loadStudents();
    }

    document.querySelectorAll('.sidebar-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const section = e.currentTarget.getAttribute('data-section');
        renderSection(section);
      });
    });

    // --- SECTION LOGIC ---
    // Dashboard (Home)
    document.getElementById('dashboard-cards').innerHTML = `
      <div class="p-4 bg-white shadow rounded text-center">
        <h3 class="text-lg font-semibold">Total Students</h3>
        <p id="statStudents" class="text-2xl text-blue-600">-</p>
      </div>
      <div class="p-4 bg-white shadow rounded text-center">
        <h3 class="text-lg font-semibold">Admins</h3>
        <p id="statAdmins" class="text-2xl text-green-600">-</p>
      </div>
      <div class="p-4 bg-white shadow rounded text-center">
        <h3 class="text-lg font-semibold">Pending Clearance</h3>
        <p id="statClearance" class="text-2xl text-red-600">-</p>
      </div>
    `;

    async function loadDashboardStats() {
      try {
        const studentsSnap = await getDocs(collection(db, "students"));
        document.getElementById('statStudents').textContent = studentsSnap.size;

        const adminsSnap = await getDocs(collection(db, "admins"));
        document.getElementById('statAdmins').textContent = adminsSnap.size;

        const clearanceSnap = await getDocs(query(collection(db, "clearanceRequests"), where("status", "==", "Pending")));
        document.getElementById('statClearance').textContent = clearanceSnap.size;
      } catch (err) {
        showPopup(`Error loading stats: ${err.message}`, 'error');
      }
    }
    loadDashboardStats();

    // Profile Section
    async function loadProfile() {
      if (!currentUser) return;
      try {
        const studentDoc = await getDoc(doc(db, "students", currentUser.uid));
        const adminDoc = await getDoc(doc(db, "admins", currentUser.uid));
        const data = { ...studentDoc.data(), ...adminDoc.data() };
        document.getElementById("pf_name").value = data.name || '';
        document.getElementById("pf_address").value = data.address || '';
        document.getElementById("pf_dob").value = data.dob || '';
        document.getElementById("pf_gender").value = data.gender || '';
        document.getElementById("pf_email").textContent = currentUser.email;
        document.getElementById("pf_regNo").textContent = data.regNo || '-';
        document.getElementById("pf_programme").textContent = data.programme || '-';
        document.getElementById("pf_year").textContent = data.year || '-';
        document.getElementById("pf_semester").textContent = data.semester || '-';
        if (data.profilePhotoURL) {
          document.getElementById('pf_photo_preview').src = data.profilePhotoURL;
          document.getElementById('pf_photo_preview').classList.remove('hidden');
        }
        document.getElementById("pf_notify_ann").checked = data.notificationPreferences?.announcements || false;
        document.getElementById("pf_notify_fees").checked = data.notificationPreferences?.fees || false;
        document.getElementById("pf_notify_grades").checked = data.notificationPreferences?.grades || false;
      } catch (err) {
        showPopup("Error loading profile: " + err.message, "error");
      }
    }

    document.getElementById("profileForm").addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      toggleLoading(true);
      try {
        const updates = {
          name: document.getElementById("pf_name").value,
          address: document.getElementById("pf_address").value,
          dob: document.getElementById("pf_dob").value,
          gender: document.getElementById("pf_gender").value,
          notificationPreferences: {
            announcements: document.getElementById("pf_notify_ann").checked,
            fees: document.getElementById("pf_notify_fees").checked,
            grades: document.getElementById("pf_notify_grades").checked
          }
        };

        const photoFile = document.getElementById("pf_photo").files[0];
        if (photoFile) {
          const photoRef = ref(storage, `admins/${currentUser.uid}/profile.jpg`);
          await uploadBytes(photoRef, photoFile);
          updates.profilePhotoURL = await getDownloadURL(photoRef);
        }

        await updateDoc(doc(db, "admins", currentUser.uid), updates);
        showPopup("Profile updated successfully!", "success");
      } catch (err) {
        showPopup("Error updating profile: " + err.message, "error");
      } finally {
        toggleLoading(false);
      }
    });

    // Account Settings
    document.getElementById("btnUpdateEmail").onclick = async () => {
      const newEmail = document.getElementById("newEmail").value;
      if (!newEmail) return showPopup("Please enter a new email.", "error");
      try {
        await updateEmail(currentUser, newEmail);
        showPopup("Email updated successfully!", "success");
      } catch (err) {
        showPopup("Error updating email: " + err.message, "error");
      }
    };

    document.getElementById("btnUpdatePassword").onclick = async () => {
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmPassword").value;
      if (!newPass || !confirmPass) return showPopup("Please fill in both password fields.", "error");
      if (newPass !== confirmPass) return showPopup("Passwords do not match.", "error");
      if (newPass.length < 6) return showPopup("Password must be at least 6 characters.", "error");
      try {
        await updatePassword(currentUser, newPass);
        showPopup("Password changed successfully!", "success");
      } catch (err) {
        showPopup("Error updating password: " + err.message, "error");
      }
    };

    document.getElementById("btnResetPassword").onclick = async () => {
      try {
        await sendPasswordResetEmail(auth, currentUser.email);
        showPopup("Password reset email sent to " + currentUser.email, "success");
      } catch (err) {
        showPopup("Error sending reset email: " + err.message, "error");
      }
    };

    document.getElementById("btnDeleteAccount").onclick = async () => {
      if (!confirm("Are you sure you want to delete your account? This cannot be undone.")) return;
      try {
        await deleteUser(currentUser);
        await updateDoc(doc(db, "admins", currentUser.uid), { active: false });
        showPopup("Account deleted successfully.", "success");
      } catch (err) {
        showPopup("Error deleting account: " + err.message, "error");
      }
    };

    // Timetable
    async function loadTimetable() {
        const year = document.getElementById("timetableYear").value;
        const semester = document.getElementById("timetableSemester").value;
        const timetableBody = document.getElementById("timetableBody");
        timetableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Loading timetable...</td></tr>`;

        if (!year || !semester) {
            timetableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Please select year and semester.</td></tr>`;
            return;
        }

        try {
            const timetableRef = doc(db, "timetables", `${year}-${semester}`);
            const timetableSnap = await getDoc(timetableRef);

            if (timetableSnap.exists()) {
                const timetableData = timetableSnap.data().courses;
                timetableBody.innerHTML = "";
                timetableData.forEach(c => {
                    const row = `
                        <tr>
                            <td class="p-2 border">${c.courseCode}</td>
                            <td class="p-2 border">${c.courseName}</td>
                            <td class="p-2 border">${c.day}</td>
                            <td class="p-2 border">${c.time}</td>
                        </tr>
                    `;
                    timetableBody.innerHTML += row;
                });
                showPopup("Timetable loaded successfully.", "success");
            } else {
                timetableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">No timetable found.</td></tr>`;
                showPopup("No timetable found for the selected year and semester.", "error");
            }
        } catch (err) {
            showPopup(`Error loading timetable: ${err.message}`, "error");
        }
    }
    document.getElementById("btnLoadTimetable").onclick = loadTimetable;

    // --- HOSTEL MANAGEMENT ---
    let allStudents = [];
    let allHostels = [];

    async function loadHostels() {
      const hostelsList = document.getElementById('hostelsList');
      const bookingsTableBody = document.getElementById('bookingsTableBody');
      const studentSearchInput = document.getElementById('studentSearch');
      hostelsList.innerHTML = '<p class="text-center p-4">Loading hostels...</p>';
      bookingsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading student bookings...</td></tr>';
      
      try {
        // Fetch all students and hostels
        const studentsSnap = await getDocs(collection(db, 'students'));
        allStudents = studentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const hostelsSnap = await getDocs(collection(db, 'hostels'));
        allHostels = await Promise.all(hostelsSnap.docs.map(async doc => {
          const hostel = doc.data();
          const roomsSnap = await getDocs(collection(db, `hostels/${doc.id}/rooms`));
          const rooms = roomsSnap.docs.map(rDoc => ({ id: rDoc.id, ...rDoc.data() }));
          const totalOccupants = rooms.reduce((sum, room) => sum + room.occupants, 0);
          return { id: doc.id, ...hostel, rooms, totalOccupants };
        }));

        renderHostelsList(allHostels);
        renderBookingsTable(allStudents);

        studentSearchInput.addEventListener('input', filterBookings);
        
      } catch (err) {
        showPopup(`Error loading hostel data: ${err.message}`, 'error');
      }
    }

    function renderHostelsList(hostels) {
      const hostelsList = document.getElementById('hostelsList');
      hostelsList.innerHTML = '';
      if (hostels.length === 0) {
        hostelsList.innerHTML = '<p class="text-center p-4 text-gray-500">No hostels found.</p>';
        return;
      }
      hostels.forEach(hostel => {
        const occupancy = hostel.totalOccupants;
        const capacity = hostel.capacity;
        const available = capacity - occupancy;
        const occupancyPercentage = capacity > 0 ? (occupancy / capacity) * 100 : 0;
        hostelsList.innerHTML += `
          <div class="bg-white p-4 rounded-lg shadow">
            <h4 class="font-semibold text-lg">${hostel.name}</h4>
            <p class="text-sm text-gray-600">Gender: ${hostel.gender}</p>
            <p class="text-sm text-gray-600">Capacity: ${capacity} | Available: ${available}</p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 my-2">
              <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${occupancyPercentage}%"></div>
            </div>
            <button onclick="viewHostelRooms('${hostel.id}')" class="bg-slate-500 text-white px-3 py-1 rounded text-sm mt-2">View Rooms</button>
          </div>
        `;
      });
    }

    function renderBookingsTable(students) {
      const bookingsTableBody = document.getElementById('bookingsTableBody');
      const bookedStudents = students.filter(s => s.hostelBooking);
      bookingsTableBody.innerHTML = '';
      if (bookedStudents.length === 0) {
        bookingsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No students have booked a room.</td></tr>';
        return;
      }
      bookedStudents.forEach(student => {
        const booking = student.hostelBooking;
        bookingsTableBody.innerHTML += `
          <tr class="hover:bg-gray-50">
            <td class="p-2 border-b">${student.name || '-'}</td>
            <td class="p-2 border-b">${student.email || '-'}</td>
            <td class="p-2 border-b">${booking.hostelName || '-'}</td>
            <td class="p-2 border-b">${booking.roomNumber || '-'}</td>
            <td class="p-2 border-b">
              <button onclick="openCancelBookingModal('${student.id}', '${student.name}')" class="bg-red-500 text-white px-3 py-1 rounded">Cancel Booking</button>
            </td>
          </tr>
        `;
      });
    }

    function filterBookings() {
      const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
      const filteredStudents = allStudents.filter(s =>
        s.name?.toLowerCase().includes(searchTerm) ||
        s.email?.toLowerCase().includes(searchTerm)
      );
      renderBookingsTable(filteredStudents);
    }

    window.openBookRoomModal = async () => {
      document.getElementById('bookRoomModal').classList.remove('hidden');
      const studentSearch = document.getElementById('bookStudentSearch');
      studentSearch.value = '';
      document.getElementById('studentSearchResults').innerHTML = '';
      
      const hostelSelect = document.getElementById('bookHostelSelect');
      hostelSelect.innerHTML = '<option value="">Select a Hostel...</option>';
      const roomSelect = document.getElementById('bookRoomSelect');
      roomSelect.innerHTML = '<option value="">Select a Hostel first...</option>';

      allHostels.forEach(hostel => {
        if (hostel.totalOccupants < hostel.capacity) {
          hostelSelect.innerHTML += `<option value="${hostel.id}">${hostel.name} (${hostel.gender})</option>`;
        }
      });
    };

    document.getElementById('bookStudentSearch').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const resultsDiv = document.getElementById('studentSearchResults');
      resultsDiv.innerHTML = '';
      if (searchTerm.length < 2) return;
      
      const filteredStudents = allStudents.filter(s =>
        (s.name?.toLowerCase().includes(searchTerm) || s.email?.toLowerCase().includes(searchTerm)) && !s.hostelBooking
      );
      
      if (filteredStudents.length === 0) {
        resultsDiv.innerHTML = '<p class="p-2 text-sm text-gray-500">No students found or all have a booking.</p>';
        return;
      }
      
      filteredStudents.forEach(student => {
        resultsDiv.innerHTML += `
          <div onclick="selectStudentForBooking('${student.id}', '${student.name}')" class="p-2 hover:bg-gray-100 cursor-pointer text-sm border-b last:border-b-0">
            ${student.name} (${student.email})
          </div>
        `;
      });
    });

    window.selectStudentForBooking = (studentId, studentName) => {
      document.getElementById('selectedStudentName').textContent = studentName;
      document.getElementById('bookRoomForm').dataset.studentId = studentId;
    };

    document.getElementById('bookHostelSelect').addEventListener('change', async (e) => {
      const hostelId = e.target.value;
      const roomSelect = document.getElementById('bookRoomSelect');
      roomSelect.innerHTML = '<option value="">Loading rooms...</option>';
      
      if (!hostelId) {
        roomSelect.innerHTML = '<option value="">Select a Hostel first...</option>';
        return;
      }
      
      try {
        const roomsSnap = await getDocs(collection(db, `hostels/${hostelId}/rooms`));
        const rooms = roomsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        roomSelect.innerHTML = '<option value="">Select a Room...</option>';
        rooms.forEach(room => {
          if (room.occupants < room.capacity) {
            roomSelect.innerHTML += `<option value="${room.id}">${room.number} (${room.occupants}/${room.capacity})</option>`;
          }
        });
      } catch (err) {
        showPopup(`Error loading rooms: ${err.message}`, 'error');
      }
    });

    document.getElementById('bookRoomForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = e.target.dataset.studentId;
      if (!studentId) return showPopup('Please select a student.', 'error');
      
      const hostelId = document.getElementById('bookHostelSelect').value;
      const roomId = document.getElementById('bookRoomSelect').value;
      
      if (!hostelId || !roomId) return showPopup('Please select a hostel and room.', 'error');
      
      toggleLoading(true);
      try {
        const studentRef = doc(db, 'students', studentId);
        const roomRef = doc(db, `hostels/${hostelId}/rooms`, roomId);
        const hostelRef = doc(db, 'hostels', hostelId);

        await runTransaction(db, async (transaction) => {
          const studentDoc = await transaction.get(studentRef);
          const roomDoc = await transaction.get(roomRef);
          const hostelDoc = await transaction.get(hostelRef);

          if (!studentDoc.exists() || !roomDoc.exists() || !hostelDoc.exists()) {
            throw new Error("Student, hostel, or room document does not exist.");
          }
          
          if (studentDoc.data().hostelBooking) {
            throw new Error("Student already has a booking.");
          }

          if (roomDoc.data().occupants >= roomDoc.data().capacity) {
            throw new Error("Room is full.");
          }

          const newRoomOccupants = roomDoc.data().occupants + 1;
          const newHostelAvailable = hostelDoc.data().available - 1;

          transaction.update(studentRef, {
            hostelBooking: {
              hostelId: hostelDoc.id,
              hostelName: hostelDoc.data().name,
              roomId: roomDoc.id,
              roomNumber: roomDoc.data().number,
              status: 'Booked',
              timestamp: serverTimestamp()
            }
          });
          transaction.update(roomRef, { occupants: newRoomOccupants });
          transaction.update(hostelRef, { available: newHostelAvailable });
        });
        
        showPopup('Room booked successfully!', 'success');
        closeModal('bookRoomModal');
        loadHostels();
      } catch (err) {
        showPopup(`Error booking room: ${err.message}`, 'error');
      } finally {
        toggleLoading(false);
      }
    });

    window.openCancelBookingModal = (studentId, studentName) => {
      document.getElementById('cancelStudentName').textContent = studentName;
      document.getElementById('confirmCancelBtn').dataset.studentId = studentId;
      document.getElementById('cancelBookingModal').classList.remove('hidden');
    };

    window.cancelStudentBooking = async () => {
      const studentId = document.getElementById('confirmCancelBtn').dataset.studentId;
      
      toggleLoading(true);
      try {
        const studentRef = doc(db, "students", studentId);
        const studentDoc = await getDoc(studentRef);

        if (!studentDoc.exists() || !studentDoc.data().hostelBooking) {
          throw new Error("Student has no active booking to cancel.");
        }

        const booking = studentDoc.data().hostelBooking;
        const roomRef = doc(db, "hostels", booking.hostelId, "rooms", booking.roomId);
        const hostelRef = doc(db, "hostels", booking.hostelId);
        
        await runTransaction(db, async (transaction) => {
            const roomDoc = await transaction.get(roomRef);
            const hostelDoc = await transaction.get(hostelRef);
            
            if (roomDoc.exists() && hostelDoc.exists()) {
                const newOccupants = roomDoc.data().occupants > 0 ? roomDoc.data().occupants - 1 : 0;
                const newAvailable = hostelDoc.data().available + 1;
                transaction.update(roomRef, { occupants: newOccupants });
                transaction.update(hostelRef, { available: newAvailable });
            }
            transaction.update(studentRef, { hostelBooking: deleteField() });
        });

        showPopup('Booking canceled successfully!', 'success');
        closeModal('cancelBookingModal');
        loadHostels();
      } catch (err) {
        showPopup(`Error canceling booking: ${err.message}`, 'error');
      } finally {
        toggleLoading(false);
      }
    };
    
    // View Hostel Rooms Modal
    window.viewHostelRooms = async (hostelId) => {
      const roomGrid = document.getElementById('roomGrid');
      const hostel = allHostels.find(h => h.id === hostelId);
      if (!hostel) return showPopup('Hostel not found.', 'error');
      
      document.getElementById('roomsHostelName').textContent = hostel.name;
      roomGrid.innerHTML = '';
      
      hostel.rooms.forEach(room => {
        const isFull = room.occupants === room.capacity;
        const color = isFull ? 'bg-red-200' : 'bg-green-200';
        const borderColor = isFull ? 'border-red-500' : 'border-green-500';
        
        roomGrid.innerHTML += `
          <div class="p-4 border ${borderColor} rounded-lg text-center ${color}">
            <h5 class="font-semibold text-xl">Room ${room.number}</h5>
            <p class="text-sm">${room.occupants} / ${room.capacity}</p>
            <p class="text-xs text-gray-600">${isFull ? 'Full' : 'Available'}</p>
          </div>
        `;
      });
      document.getElementById('viewRoomsModal').classList.remove('hidden');
    };

    // Finance
    let allStudentsData = []; // Cache all students
    
    async function loadFinance() {
      const financeTableBody = document.getElementById('financeTableBody');
      const searchInput = document.getElementById('financeSearch');
      
      financeTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading finance records...</td></tr>';
      
      try {
        const studentsSnap = await getDocs(collection(db, 'students'));
        allStudentsData = await Promise.all(studentsSnap.docs.map(async sDoc => {
          const studentData = sDoc.data();
          const financeDoc = await getDoc(doc(db, 'finance', sDoc.id));
          const balance = financeDoc.exists() ? (financeDoc.data().balance || 0) : 0;
          return { id: sDoc.id, ...studentData, balance };
        }));
        
        // Initial render without filter
        renderFinanceTable(allStudentsData);
        
        // Add event listener for search input
        searchInput.addEventListener('input', filterStudents);
        
      } catch (err) {
        showPopup(`Error loading finance data: ${err.message}`, 'error');
      }
    }
    
    function filterStudents() {
      const searchTerm = document.getElementById('financeSearch').value.toLowerCase();
      const filteredStudents = allStudentsData.filter(s =>
        s.name?.toLowerCase().includes(searchTerm) ||
        s.email?.toLowerCase().includes(searchTerm) ||
        s.regNo?.toLowerCase().includes(searchTerm)
      );
      renderFinanceTable(filteredStudents);
    }
    
    function renderFinanceTable(students) {
      const financeTableBody = document.getElementById('financeTableBody');
      financeTableBody.innerHTML = '';
      if (students.length === 0) {
        financeTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No matching students found.</td></tr>';
        return;
      }
      
      students.forEach(student => {
        const row = `
          <tr class="hover:bg-gray-50">
            <td class="p-2 border-b">${student.name || '-'}</td>
            <td class="p-2 border-b">${student.email || '-'}</td>
            <td class="p-2 border-b">KES ${student.balance?.toLocaleString() || '0'}</td>
            <td class="p-2 border-b space-x-2">
              <button onclick="viewTransactions('${student.id}', '${student.name}')" class="bg-blue-600 text-white px-3 py-1 rounded">View Transactions</button>
              <button onclick="printStatement('${student.id}')" class="bg-slate-500 text-white px-3 py-1 rounded">Print Statement</button>
            </td>
          </tr>
        `;
        financeTableBody.innerHTML += row;
      });
    }

    // New Functions for Finance
    window.viewTransactions = async (studentId, studentName) => {
      const modal = document.getElementById('transactionsModal');
      const studentNameSpan = document.getElementById('transactionsStudentName');
      studentNameSpan.textContent = studentName;
      modal.classList.remove('hidden');
      modal.dataset.studentId = studentId;
      await loadStudentTransactions(studentId);
    };

    window.closeTransactionsModal = () => {
      document.getElementById('transactionsModal').classList.add('hidden');
    };
    
    window.openAddTransactionModal = () => {
      document.getElementById('addTransactionModal').classList.remove('hidden');
      document.getElementById('addTransactionForm').reset();
    };

    window.closeAddTransactionModal = () => {
      document.getElementById('addTransactionModal').classList.add('hidden');
    };

    window.openEditTransactionModal = (transId, type, amount, desc) => {
      document.getElementById('editTransactionModal').classList.remove('hidden');
      document.getElementById('editTransactionForm').dataset.transactionId = transId;
      document.getElementById('edit_type').value = type;
      document.getElementById('edit_amount').value = amount;
      document.getElementById('edit_description').value = desc;
    };
    
    window.closeEditTransactionModal = () => {
      document.getElementById('editTransactionModal').classList.add('hidden');
    };

    async function loadStudentTransactions(studentId) {
      const transactionsBody = document.getElementById('transactionTableBody');
      transactionsBody.innerHTML = '<tr><td colspan="5" class="text-center p-2">Loading...</td></tr>';
      try {
        const transactionsSnap = await getDocs(query(collection(db, `finance/${studentId}/transactions`), orderBy("timestamp", "desc")));
        transactionsBody.innerHTML = '';
        if (transactionsSnap.empty) {
          transactionsBody.innerHTML = '<tr><td colspan="5" class="text-center p-2">No transactions found.</td></tr>';
        } else {
          transactionsSnap.forEach(tDoc => {
            const tData = tDoc.data();
            const row = `
              <tr>
                <td class="p-2 border-b">${new Date(tData.timestamp?.seconds * 1000).toLocaleDateString()}</td>
                <td class="p-2 border-b">${tData.type}</td>
                <td class="p-2 border-b">KES ${tData.amount?.toLocaleString() || '0'}</td>
                <td class="p-2 border-b">${tData.description || ''}</td>
                <td class="p-2 border-b space-x-2">
                  <button onclick="openEditTransactionModal('${tDoc.id}', '${tData.type}', ${tData.amount}, '${tData.description}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Edit</button>
                  <button onclick="deleteTransaction('${studentId}', '${tDoc.id}')" class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
                </td>
              </tr>
            `;
            transactionsBody.innerHTML += row;
          });
        }
      } catch (err) {
        showPopup(`Error loading transactions: ${err.message}`, 'error');
      }
    }

    document.getElementById('addTransactionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('transactionsModal').dataset.studentId;
      const amount = parseFloat(e.target.amount.value);
      const type = e.target.type.value;
      const description = e.target.description.value;
      
      if (isNaN(amount) || amount <= 0) return showPopup('Please enter a valid amount.', 'error');
      
      toggleLoading(true);
      try {
        await runTransaction(db, async (transaction) => {
          const financeRef = doc(db, 'finance', studentId);
          const financeDoc = await transaction.get(financeRef);
          
          let currentBalance = 0;
          if (financeDoc.exists()) {
            currentBalance = financeDoc.data().balance || 0;
          }
          
          const newBalance = type === 'bill' ? currentBalance + amount : currentBalance - amount;
          
          transaction.set(financeRef, { balance: newBalance }, { merge: true });
          
          const transactionRef = doc(collection(db, `finance/${studentId}/transactions`));
          const transactionData = { amount, type, description, timestamp: serverTimestamp() };
          transaction.set(transactionRef, transactionData);
        });
        
        showPopup('Transaction added successfully!', 'success');
        e.target.reset();
        closeAddTransactionModal();
        loadStudentTransactions(studentId);
        loadFinance();
      } catch (err) {
        showPopup(`Error adding transaction: ${err.message}`, 'error');
      } finally {
        toggleLoading(false);
      }
    });

    document.getElementById('editTransactionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentId = document.getElementById('transactionsModal').dataset.studentId;
      const transId = e.target.dataset.transactionId;
      const newAmount = parseFloat(e.target.amount.value);
      const newType = e.target.type.value;
      const newDescription = e.target.description.value;
      
      if (isNaN(newAmount) || newAmount <= 0) return showPopup('Please enter a valid amount.', 'error');
      
      toggleLoading(true);
      try {
        await runTransaction(db, async (transaction) => {
          const financeRef = doc(db, 'finance', studentId);
          const financeDoc = await transaction.get(financeRef);
          const transactionRef = doc(db, `finance/${studentId}/transactions`, transId);
          const transactionDoc = await transaction.get(transactionRef);
          
          if (!financeDoc.exists() || !transactionDoc.exists()) throw new Error("Document not found.");
          
          const currentBalance = financeDoc.data().balance || 0;
          const oldAmount = transactionDoc.data().amount;
          const oldType = transactionDoc.data().type;
          
          // Revert old transaction's effect on balance
          let tempBalance = currentBalance;
          tempBalance = oldType === 'bill' ? tempBalance - oldAmount : tempBalance + oldAmount;
          
          // Apply new transaction's effect on balance
          const newBalance = newType === 'bill' ? tempBalance + newAmount : tempBalance - newAmount;
          
          transaction.update(financeRef, { balance: newBalance });
          transaction.update(transactionRef, { amount: newAmount, type: newType, description: newDescription });
        });
        
        showPopup('Transaction updated successfully!', 'success');
        closeEditTransactionModal();
        loadStudentTransactions(studentId);
        loadFinance();
      } catch (err) {
        showPopup(`Error updating transaction: ${err.message}`, 'error');
      } finally {
        toggleLoading(false);
      }
    });

    window.deleteTransaction = async (studentId, transId) => {
      if (!confirm("Are you sure you want to delete this transaction?")) return;
      toggleLoading(true);
      try {
        await runTransaction(db, async (transaction) => {
          const financeRef = doc(db, 'finance', studentId);
          const financeDoc = await transaction.get(financeRef);
          const transactionRef = doc(db, `finance/${studentId}/transactions`, transId);
          const transactionDoc = await transaction.get(transactionRef);
          
          if (!financeDoc.exists() || !transactionDoc.exists()) throw new Error("Document not found.");
          
          const currentBalance = financeDoc.data().balance || 0;
          const amount = transactionDoc.data().amount;
          const type = transactionDoc.data().type;
          
          // Revert transaction's effect on balance
          const newBalance = type === 'bill' ? currentBalance - amount : currentBalance + amount;
          
          transaction.update(financeRef, { balance: newBalance });
          transaction.delete(transactionRef);
        });
        
        showPopup('Transaction deleted successfully!', 'success');
        loadStudentTransactions(studentId);
        loadFinance();
      } catch (err) {
        showPopup(`Error deleting transaction: ${err.message}`, 'error');
      } finally {
        toggleLoading(false);
      }
    };

    window.printStatement = async (studentId) => {
      const statementContent = document.getElementById('printableStatementContent');
      statementContent.innerHTML = 'Generating statement...';
      document.getElementById('printableStatementModal').classList.remove('hidden');

      try {
        const studentDoc = await getDoc(doc(db, 'students', studentId));
        const transactionsSnap = await getDocs(query(collection(db, `finance/${studentId}/transactions`), orderBy("timestamp", "asc")));
        const studentData = studentDoc.data();
        
        let totalCredits = 0;
        let totalDebits = 0;
        let transactionRows = '';
        
        transactionsSnap.forEach(tDoc => {
          const tData = tDoc.data();
          const date = new Date(tData.timestamp?.seconds * 1000).toLocaleDateString();
          const amount = tData.amount?.toLocaleString() || '0';
          const type = tData.type;
          const description = tData.description || '';
          
          if (type === 'payment' || type === 'credit') {
            totalCredits += tData.amount;
          } else if (type === 'bill' || type === 'debit') {
            totalDebits += tData.amount;
          }

          transactionRows += `
            <tr>
              <td class="p-2 border">${date}</td>
              <td class="p-2 border">${type}</td>
              <td class="p-2 border text-right">KES ${amount}</td>
              <td class="p-2 border">${description}</td>
            </tr>
          `;
        });

        const finalBalance = totalDebits - totalCredits;
        
        statementContent.innerHTML = `
          <div class="p-8">
            <h1 class="text-2xl font-bold text-center mb-6">Student Financial Statement</h1>
            <div class="mb-6 border p-4 rounded-lg">
              <h2 class="text-xl font-semibold mb-2">Student Information</h2>
              <p><strong>Name:</strong> ${studentData.name || '-'}</p>
              <p><strong>Admission No:</strong> ${studentData.regNo || '-'}</p>
              <p><strong>Email:</strong> ${studentData.email || '-'}</p>
              <p><strong>Programme:</strong> ${studentData.programme || '-'}</p>
              <p><strong>Year/Semester:</strong> ${studentData.year || '-'} / ${studentData.semester || '-'}</p>
            </div>
            <h2 class="text-xl font-semibold mb-4">Transaction History</h2>
            <table class="w-full border-collapse border mb-6">
              <thead>
                <tr>
                  <th class="p-2 border bg-gray-200 text-left">Date</th>
                  <th class="p-2 border bg-gray-200 text-left">Type</th>
                  <th class="p-2 border bg-gray-200 text-right">Amount</th>
                  <th class="p-2 border bg-gray-200 text-left">Description</th>
                </tr>
              </thead>
              <tbody>
                ${transactionRows || `<tr><td colspan="4" class="text-center p-4">No transactions recorded.</td></tr>`}
              </tbody>
            </table>
            <div class="border-t pt-4 text-right">
              <p class="text-lg"><strong>Total Debits:</strong> KES ${totalDebits.toLocaleString()}</p>
              <p class="text-lg"><strong>Total Credits:</strong> KES ${totalCredits.toLocaleString()}</p>
              <p class="text-xl font-bold mt-2">Final Balance: KES ${finalBalance.toLocaleString()}</p>
            </div>
          </div>
        `;
        
        document.getElementById('btnPrintStatement').style.display = 'block';

      } catch (err) {
        showPopup(`Error generating statement: ${err.message}`, 'error');
        statementContent.innerHTML = '<p class="text-center text-red-500">Could not generate statement.</p>';
        document.getElementById('btnPrintStatement').style.display = 'none';
      }
    };
    
    window.closePrintableStatementModal = () => {
      document.getElementById('printableStatementModal').classList.add('hidden');
    };

    window.triggerPrint = () => {
      window.print();
    };

    // Admins
    async function loadAdmins() {
      try {
        const adminsList = document.getElementById('adminsList');
        adminsList.innerHTML = '';
        const adminsSnap = await getDocs(collection(db, 'admins'));
        
        if (adminsSnap.empty) {
          adminsList.innerHTML = '<li class="p-4 text-center text-gray-500">No other admins found.</li>';
          return;
        }

        adminsSnap.forEach(aDoc => {
          const admin = aDoc.data();
          const row = `
            <li class="p-4 border rounded shadow flex justify-between items-center">
              <span>${admin.email}</span>
              <button onclick="removeAdmin('${aDoc.id}')" class="bg-red-500 text-white px-3 py-1 rounded">Remove</button>
            </li>
          `;
          adminsList.innerHTML += row;
        });
      } catch (err) {
        showPopup(`Error loading admins: ${err.message}`, 'error');
      }
    }

    document.getElementById('addAdminForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = e.target.adminEmail.value;
      try {
        const studentsSnap = await getDocs(query(collection(db, "students"), where("email", "==", email)));
        if (studentsSnap.empty) {
          return showPopup('No student found with that email.', 'error');
        }
        
        const student = studentsSnap.docs[0];
        await setDoc(doc(db, "admins", student.id), {
          isAdmin: true,
          email: email,
          name: student.data().name || 'Admin',
        });
        showPopup('Admin added successfully!', 'success');
        e.target.reset();
        loadAdmins();
      } catch (err) {
        showPopup(`Error adding admin: ${err.message}`, 'error');
      }
    });

    window.removeAdmin = async (adminId) => {
      try {
        if (currentUser.uid === adminId) {
          return showPopup("You cannot remove your own admin access.", "error");
        }
        await deleteDoc(doc(db, "admins", adminId));
        showPopup('Admin removed successfully.', 'success');
        loadAdmins();
      } catch (err) {
        showPopup(`Error removing admin: ${err.message}`, 'error');
      }
    };
    
    // Students
    async function loadStudents() {
        try {
            const studentsBody = document.getElementById('studentsBody');
            studentsBody.innerHTML = '';
            const studentsSnap = await getDocs(collection(db, 'students'));
            if (studentsSnap.empty) {
                studentsBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No students found.</td></tr>';
                return;
            }
            studentsSnap.forEach(sDoc => {
                const student = sDoc.data();
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2 border-b">${student.name || '-'}</td>
                        <td class="p-2 border-b">${student.regNo || '-'}</td>
                        <td class="p-2 border-b">${student.email || '-'}</td>
                        <td class="p-2 border-b">${student.programme || '-'}</td>
                        <td class="p-2 border-b">
                            <button onclick="deleteStudent('${sDoc.id}')" class="bg-red-500 text-white px-3 py-1 rounded">Delete</button>
                        </td>
                    </tr>
                `;
                studentsBody.innerHTML += row;
            });
        } catch (err) {
            showPopup(`Error loading students: ${err.message}`, 'error');
        }
    }
    
    document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = e.target.name.value;
      const regNo = e.target.regNo.value;
      const email = e.target.email.value;
      const password = e.target.password.value;
      const programme = e.target.programme.value;

      if (password.length < 6) return showPopup("Password must be at least 6 characters.", "error");

      toggleLoading(true);
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;
        
        await setDoc(doc(db, "students", uid), {
          name, regNo, email, programme,
          createdAt: serverTimestamp()
        });
        
        showPopup('Student account created successfully!', 'success');
        e.target.reset();
        loadStudents();
      } catch (err) {
        showPopup(`Error creating student: ${err.message}`, 'error');
      } finally {
        toggleLoading(false);
      }
    });

    window.deleteStudent = async (studentId) => {
      if (!confirm("Are you sure you want to delete this student account? This will permanently remove all their data.")) return;
      try {
        // Note: Firebase Auth user deletion requires server-side logic for security. 
        // This client-side code will only delete the Firestore record.
        // A production app should have a Cloud Function for this.
        await deleteDoc(doc(db, "students", studentId));
        await deleteDoc(doc(db, "finance", studentId));
        await deleteDoc(doc(db, "clearanceRequests", studentId));
        showPopup("Student account data deleted successfully.", "success");
        loadStudents();
      } catch (err) {
        showPopup(`Error deleting student data: ${err.message}`, 'error');
      }
    };
    
    </script>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

  <div id="loadingOverlay" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"></div>
      <p class="mt-2 text-gray-700">Loading...</p>
    </div>
  </div>

  <div id="popupMsg" class="hidden fixed top-4 inset-x-0 max-w-md mx-auto z-50 shadow-lg rounded p-4 flex items-start justify-between">
    <span id="popupText" class="text-sm"></span>
    <button id="popupClose" class="ml-4 px-3 py-1 rounded bg-white/20 text-sm font-medium">OK</button>
  </div>

  <div id="loginPage" class="hidden flex items-center justify-center w-full min-h-screen">
    <div class="p-8 bg-white shadow rounded-lg w-full max-w-md">
      <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Email</label>
          <input type="email" name="email" class="w-full mt-1 p-2 border rounded" required>
        </div>
        <div>
          <label class="block text-sm font-medium">Password</label>
          <input type="password" name="password" class="w-full mt-1 p-2 border rounded" required>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Login</button>
      </form>
    </div>
  </div>

  <div id="mainContent" class="hidden flex flex-1">
    <aside class="w-64 bg-slate-800 text-white flex flex-col p-4">
      <div class="flex items-center gap-2 mb-6">
        <svg class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <h1 class="text-xl font-bold">Admin Panel</h1>
      </div>
      <p class="text-sm text-slate-400 mb-4">Welcome, <span id="userName" class="font-semibold"></span></p>
      <nav class="flex-1 space-y-2">
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item bg-slate-700" data-section="dashboard">Dashboard</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="profile">Profile</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="settings">Account Settings</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="timetable">Timetable</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="hostels">Hostels</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="finance">Finance</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="clearance">Clearance</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="admins">Admins</a>
        <a href="#" class="block p-2 rounded hover:bg-slate-700 sidebar-item" data-section="students">Students</a>
      </nav>
      <div class="mt-auto">
        <button id="btnLogout" class="w-full text-left p-2 rounded hover:bg-slate-700">Logout</button>
      </div>
    </aside>

    <main class="flex-1 p-6 overflow-y-auto">
      <section id="section-dashboard" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
        <div id="dashboard-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </section>

      <section id="section-profile" class="hidden">
        <h2 class="text-2xl font-bold mb-6">My Profile</h2>
        <div class="bg-white p-6 rounded-lg shadow">
          <form id="profileForm" class="space-y-4">
            <div class="flex items-center space-x-4">
              <img id="pf_photo_preview" src="https://via.placeholder.com/100" alt="Profile Photo" class="h-24 w-24 rounded-full object-cover border hidden">
              <label for="pf_photo" class="text-blue-600 cursor-pointer">
                Upload Photo
                <input type="file" id="pf_photo" class="hidden" accept="image/*">
              </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">Full Name</label>
                <input type="text" id="pf_name" class="w-full mt-1 p-2 border rounded">
              </div>
              <div>
                <label class="block text-sm font-medium">Email (Read-only)</label>
                <p id="pf_email" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
              <div>
                <label class="block text-sm font-medium">Address</label>
                <input type="text" id="pf_address" class="w-full mt-1 p-2 border rounded">
              </div>
              <div>
                <label class="block text-sm font-medium">Date of Birth</label>
                <input type="date" id="pf_dob" class="w-full mt-1 p-2 border rounded">
              </div>
              <div>
                <label class="block text-sm font-medium">Gender</label>
                <select id="pf_gender" class="w-full mt-1 p-2 border rounded">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">Registration No (Read-only)</label>
                <p id="pf_regNo" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
              <div>
                <label class="block text-sm font-medium">Programme (Read-only)</label>
                <p id="pf_programme" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
              <div>
                <label class="block text-sm font-medium">Year (Read-only)</label>
                <p id="pf_year" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
              <div>
                <label class="block text-sm font-medium">Semester (Read-only)</label>
                <p id="pf_semester" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
            </div>
            <div class="mt-6">
              <h3 class="font-semibold text-lg mb-2">Notification Preferences</h3>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="pf_notify_ann" class="rounded">
                <label for="pf_notify_ann">Announcements</label>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="pf_notify_fees" class="rounded">
                <label for="pf_notify_fees">Fees Reminders</label>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="pf_notify_grades" class="rounded">
                <label for="pf_notify_grades">New Grades</label>
              </div>
            </div>
            <button type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 mt-4">Save Profile</button>
          </form>
        </div>
      </section>

      <section id="section-settings" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Account Settings</h2>
        <div class="bg-white p-6 rounded-lg shadow space-y-6">
          <div>
            <h3 class="font-semibold text-lg mb-2">Update Email</h3>
            <input type="email" id="newEmail" placeholder="Enter new email" class="w-full p-2 border rounded mb-2">
            <button id="btnUpdateEmail" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Update Email</button>
          </div>
          <div>
            <h3 class="font-semibold text-lg mb-2">Change Password</h3>
            <input type="password" id="newPassword" placeholder="New Password" class="w-full p-2 border rounded mb-2">
            <input type="password" id="confirmPassword" placeholder="Confirm Password" class="w-full p-2 border rounded mb-2">
            <button id="btnUpdatePassword" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Change Password</button>
          </div>
          <div>
            <h3 class="font-semibold text-lg mb-2">Password Management</h3>
            <button id="btnResetPassword" class="bg-slate-500 text-white p-2 rounded hover:bg-slate-600">Send Password Reset</button>
            <button id="btnDeleteAccount" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 ml-4">Delete Account</button>
          </div>
        </div>
      </section>

      <section id="section-timetable" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Timetable</h2>
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="flex gap-4 items-center mb-4">
            <div>
              <label class="block text-sm font-medium">Year</label>
              <select id="timetableYear" class="p-2 border rounded">
                <option value="1">Year 1</option>
                <option value="2">Year 2</option>
                <option value="3">Year 3</option>
                <option value="4">Year 4</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Semester</label>
              <select id="timetableSemester" class="p-2 border rounded">
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
              </select>
            </div>
            <button id="btnLoadTimetable" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700 self-end">Load Timetable</button>
          </div>
          <table class="min-w-full bg-white border-collapse border">
            <thead>
              <tr>
                <th class="p-2 border bg-gray-200 text-left">Course Code</th>
                <th class="p-2 border bg-gray-200 text-left">Course Name</th>
                <th class="p-2 border bg-gray-200 text-left">Day</th>
                <th class="p-2 border bg-gray-200 text-left">Time</th>
              </tr>
            </thead>
            <tbody id="timetableBody">
              <tr><td colspan="4" class="text-center p-4">Select year and semester to view timetable.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="section-hostels" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Hostel Management</h2>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
          <h3 class="font-semibold text-xl mb-4">Hostels Overview</h3>
          <div id="hostelsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <p class="text-center p-4">Loading hostels...</p>
          </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="font-semibold text-xl mb-4">Student Bookings</h3>
          <div class="flex justify-between items-center mb-4">
            <input type="text" id="studentSearch" placeholder="Search by name or email" class="p-2 border rounded w-full md:w-1/3">
            <button onclick="openBookRoomModal()" class="bg-blue-600 text-white p-2 rounded">Book Room for a Student</button>
          </div>
          <table class="min-w-full bg-white border-collapse border">
            <thead>
              <tr>
                <th class="p-2 border bg-gray-200 text-left">Student Name</th>
                <th class="p-2 border bg-gray-200 text-left">Email</th>
                <th class="p-2 border bg-gray-200 text-left">Hostel Name</th>
                <th class="p-2 border bg-gray-200 text-left">Room Number</th>
                <th class="p-2 border bg-gray-200 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="bookingsTableBody">
              <tr><td colspan="5" class="text-center p-4">Loading student bookings...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
      
      <div id="viewRoomsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Rooms for <span id="roomsHostelName"></span></h3>
            <button onclick="closeModal('viewRoomsModal')" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <div id="roomGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
        </div>
      </div>

      <div id="bookRoomModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Book a Room for a Student</h3>
            <button onclick="closeModal('bookRoomModal')" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <form id="bookRoomForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Search Student (by name or email)</label>
              <input type="text" id="bookStudentSearch" placeholder="Start typing to search..." class="w-full mt-1 p-2 border rounded">
              <p id="selectedStudentName" class="mt-2 text-sm text-gray-700 font-semibold"></p>
              <div id="studentSearchResults" class="bg-white border rounded shadow mt-1 max-h-40 overflow-y-auto"></div>
            </div>
            <div>
              <label class="block text-sm font-medium">Select Hostel</label>
              <select id="bookHostelSelect" class="w-full p-2 border rounded" required>
                <option value="">Loading hostels...</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Select Room</label>
              <select id="bookRoomSelect" class="w-full p-2 border rounded" required>
                <option value="">Select a Hostel first...</option>
              </select>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" onclick="closeModal('bookRoomModal')" class="bg-gray-300 text-gray-800 p-2 rounded">Cancel</button>
              <button type="submit" class="bg-blue-600 text-white p-2 rounded">Book Room</button>
            </div>
          </form>
        </div>
      </div>

      <div id="cancelBookingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm text-center">
              <p class="text-lg font-semibold mb-4">Are you sure you want to cancel the booking for <span id="cancelStudentName"></span>?</p>
              <div class="flex justify-center gap-4">
                  <button onclick="closeModal('cancelBookingModal')" class="bg-gray-300 text-gray-800 p-2 rounded">No, Don't Cancel</button>
                  <button id="confirmCancelBtn" onclick="cancelStudentBooking()" class="bg-red-600 text-white p-2 rounded">Yes, Cancel Booking</button>
              </div>
          </div>
      </div>

      <section id="section-finance" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Finance Management</h2>
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="mb-4">
            <label class="block text-sm font-medium">Search Student</label>
            <input type="text" id="financeSearch" placeholder="Filter by name, reg. no, or email" class="w-full mt-1 p-2 border rounded">
          </div>
          <table class="min-w-full bg-white border-collapse border">
            <thead>
              <tr>
                <th class="p-2 border bg-gray-200 text-left">Student Name</th>
                <th class="p-2 border bg-gray-200 text-left">Email</th>
                <th class="p-2 border bg-gray-200 text-left">Current Balance</th>
                <th class="p-2 border bg-gray-200 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="financeTableBody">
              <tr><td colspan="4" class="text-center p-4">Loading finance records...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <div id="transactionsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Transactions for <span id="transactionsStudentName"></span></h3>
            <button onclick="closeTransactionsModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <button onclick="openAddTransactionModal()" class="bg-green-600 text-white p-2 rounded mb-4">Add New Transaction</button>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border-collapse border">
              <thead>
                <tr>
                  <th class="p-2 border bg-gray-100 text-left">Date</th>
                  <th class="p-2 border bg-gray-100 text-left">Type</th>
                  <th class="p-2 border bg-gray-100 text-right">Amount</th>
                  <th class="p-2 border bg-gray-100 text-left">Description</th>
                  <th class="p-2 border bg-gray-100 text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="transactionTableBody">
                <tr><td colspan="5" class="text-center p-2">Loading transactions...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="addTransactionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Add Transaction</h3>
            <button onclick="closeAddTransactionModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <form id="addTransactionForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Amount (KES)</label>
              <input type="number" name="amount" class="w-full mt-1 p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">Type</label>
              <select name="type" class="w-full mt-1 p-2 border rounded">
                <option value="bill">Bill (Adds to balance)</option>
                <option value="payment">Payment (Reduces balance)</option>
                <option value="credit">Credit (Reduces balance)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Description</label>
              <input type="text" name="description" class="w-full mt-1 p-2 border rounded">
            </div>
            <button type="submit" class="bg-green-600 text-white p-2 rounded w-full">Add Transaction</button>
          </form>
        </div>
      </div>

      <div id="editTransactionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Edit Transaction</h3>
            <button onclick="closeEditTransactionModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <form id="editTransactionForm" class="space-y-4" data-transaction-id="">
            <div>
              <label class="block text-sm font-medium">Amount (KES)</label>
              <input type="number" id="edit_amount" name="amount" class="w-full mt-1 p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">Type</label>
              <select id="edit_type" name="type" class="w-full mt-1 p-2 border rounded">
                <option value="bill">Bill (Adds to balance)</option>
                <option value="payment">Payment (Reduces balance)</option>
                <option value="credit">Credit (Reduces balance)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Description</label>
              <input type="text" id="edit_description" name="description" class="w-full mt-1 p-2 border rounded">
            </div>
            <button type="submit" class="bg-blue-600 text-white p-2 rounded w-full">Save Changes</button>
          </form>
        </div>
      </div>

      <div id="printableStatementModal" class="hidden fixed inset-0 bg-white z-50 p-4">
        <div id="printableStatementContent" class="h-full"></div>
        <div class="flex justify-end mt-4">
          <button onclick="closePrintableStatementModal()" class="bg-gray-300 text-gray-800 p-2 rounded mr-2">Close</button>
          <button id="btnPrintStatement" onclick="triggerPrint()" class="bg-blue-600 text-white p-2 rounded">Print</button>
        </div>
      </div>

      <section id="section-clearance" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Clearance Management</h2>
        <div class="bg-white p-6 rounded-lg shadow">
          <table class="min-w-full bg-white border-collapse border">
            <thead>
              <tr>
                <th class="p-2 border bg-gray-200 text-left">Student Name</th>
                <th class="p-2 border bg-gray-200 text-left">Reg No</th>
                <th class="p-2 border bg-gray-200 text-left">Reason</th>
                <th class="p-2 border bg-gray-200 text-left">Finance</th>
                <th class="p-2 border bg-gray-200 text-left">Library</th>
                <th class="p-2 border bg-gray-200 text-left">Hostel</th>
                <th class="p-2 border bg-gray-200 text-left">Dean</th>
                <th class="p-2 border bg-gray-200 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="clearanceTableBody">
              <tr><td colspan="8" class="text-center p-4">Loading clearance requests...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <div id="clearanceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Manage Clearance</h3>
            <button onclick="document.getElementById('clearanceModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <form id="clearanceForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">Student Email</label>
                <p id="c_name" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
              <div>
                <label class="block text-sm font-medium">Reason</label>
                <p id="c_reason" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium">Remarks</label>
                <p id="c_remarks" class="w-full mt-1 p-2 border rounded bg-gray-100"></p>
              </div>
              <div class="col-span-2">
                <a id="c_evidenceLink" href="#" target="_blank" class="text-blue-600 hover:underline hidden">View Evidence Document</a>
              </div>
              <div>
                <label class="block text-sm font-medium">Finance Status</label>
                <select id="c_finance" class="w-full mt-1 p-2 border rounded">
                  <option>Pending</option>
                  <option>Cleared</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Library Status</label>
                <select id="c_library" class="w-full mt-1 p-2 border rounded">
                  <option>Pending</option>
                  <option>Cleared</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Hostel Status</label>
                <select id="c_hostel" class="w-full mt-1 p-2 border rounded">
                  <option>Pending</option>
                  <option>Cleared</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Dean Status</label>
                <select id="c_dean" class="w-full mt-1 p-2 border rounded">
                  <option>Pending</option>
                  <option>Cleared</option>
                </select>
              </div>
            </div>
            <button type="submit" class="bg-blue-600 text-white p-2 rounded w-full">Update Clearance</button>
          </form>
        </div>
      </div>

      <section id="section-admins" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Admins Management</h2>
        <div class="bg-white p-6 rounded-lg shadow mb-6">
          <h3 class="font-semibold text-xl mb-2">Add New Admin</h3>
          <form id="addAdminForm" class="flex gap-4 items-center">
            <input type="email" name="adminEmail" placeholder="Student email to add" class="flex-1 p-2 border rounded" required>
            <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Add Admin</button>
          </form>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="font-semibold text-xl mb-2">Current Admins</h3>
          <ul id="adminsList" class="space-y-4">
            <li class="p-4 text-center text-gray-500">Loading...</li>
          </ul>
        </div>
      </section>

      <section id="section-students" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Students Management</h2>
        <div class="bg-white p-6 rounded-lg shadow mb-6">
          <h3 class="font-semibold text-xl mb-2">Add New Student</h3>
          <form id="addStudentForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">Full Name</label>
                <input type="text" name="name" class="w-full mt-1 p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">Admission No</label>
                <input type="text" name="regNo" class="w-full mt-1 p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">Email</label>
                <input type="email" name="email" class="w-full mt-1 p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">Password</label>
                <input type="password" name="password" class="w-full mt-1 p-2 border rounded" required>
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium">Programme</label>
                <input type="text" name="programme" class="w-full mt-1 p-2 border rounded" required>
              </div>
            </div>
            <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Add Student</button>
          </form>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="font-semibold text-xl mb-2">Current Students</h3>
          <table class="min-w-full bg-white border-collapse border">
            <thead>
              <tr>
                <th class="p-2 border bg-gray-200 text-left">Name</th>
                <th class="p-2 border bg-gray-200 text-left">Admission No</th>
                <th class="p-2 border bg-gray-200 text-left">Email</th>
                <th class="p-2 border bg-gray-200 text-left">Programme</th>
                <th class="p-2 border bg-gray-200 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="studentsBody">
              <tr><td colspan="5" class="text-center p-4">Loading students...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
</body>
</html>
