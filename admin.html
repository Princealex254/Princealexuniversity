<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Student Portal</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfTLZyH6ONeV8Su2V9Y77Z3V0N219X2V1Q+qF2F6G1OZQ7aXwIM5x5xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      collection, query, where, onSnapshot, getDocs, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ----------------------
    // FIREBASE CONFIG (from index.html)
    // ----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Simple helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const currencyFormatter = new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES' });

    const sections = ["dashboard", "students", "student-profile", "announcements", "courses", "timetables", "hostels", "graduation-requests", "clearance-requests", "explorer"];
    const state = {
      currentUser: null,
      isAdmin: false,
      selectedStudentId: null,
      selectedStudent: null,
      unsubscribers: {},
      counts: { students: 0, courses: 0, announcements: 0, timetables: 0, hostels: 0, graduationRequests: 0, clearanceRequests: 0 },
      gradesCache: [],
      feesCache: [],
      gradesUnsub: null,
      feesUnsub: null,
      registrationsUnsub: null,
      registrationsCache: [],
      coursesUnsub: null,
      coursesCache: [],
      timetablesUnsub: null,
      timetablesCache: [],
      hostelsUnsub: null,
      hostelsCache: [],
      graduationRequestsUnsub: null,
      graduationRequestsCache: [],
      clearanceRequestsUnsub: null,
      clearanceRequestsCache: []
    };

    function showToast(kind, msg) {
      const el = document.createElement("div");
      el.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded shadow text-white ${kind==="error"?"bg-red-600":"bg-green-600"}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    function setLoading(show, text="Working...") {
      const overlay = $("#loadingOverlay");
      const t = $("#loadingText");
      if (show) {
        t.textContent = text;
        overlay.classList.remove("hidden");
      } else {
        overlay.classList.add("hidden");
      }
    }

    function guard(signOutIfDenied = false) {
      if (!state.currentUser || !state.isAdmin) {
        $("#authScreen").classList.remove("hidden");
        $("#appScreen").classList.add("hidden");
        if (signOutIfDenied) signOut(auth);
      } else {
        $("#authScreen").classList.add("hidden");
        $("#appScreen").classList.remove("hidden");
      }
    }

    function activateNav(id) {
      sections.forEach(s => {
        const sec = document.getElementById(`sec-${s}`);
        if (sec) sec.classList.add("hidden");
      });
      const target = document.getElementById(`sec-${id}`);
      if (target) target.classList.remove("hidden");

      $$(".nav-item").forEach(i => i.classList.remove("bg-blue-100", "text-blue-800"));
      const active = document.querySelector(`[data-target="${id}"]`);
      if (active) active.classList.add("bg-blue-100", "text-blue-800");

      if (id === "student-profile") {
        $("#sec-student-profile-tabs").style.display = 'block';
      } else {
        $("#sec-student-profile-tabs").style.display = 'none';
      }
    }

    function activateStudentProfileTab(tabId) {
      $$(".student-profile-tab-btn").forEach(btn => btn.classList.remove("border-b-2", "border-blue-500", "text-blue-600"));
      $$(".student-profile-tab-content").forEach(content => content.classList.add("hidden"));
      $(`#tab-${tabId}`).classList.add("border-b-2", "border-blue-500", "text-blue-600");
      $(`#content-${tabId}`).classList.remove("hidden");
    }

    // ------------------------------------
    // AUTH
    // ------------------------------------
    async function loginEmailPassword(e) {
      e.preventDefault();
      const email = $("#loginEmail").value.trim();
      const password = $("#loginPassword").value;
      try {
        setLoading(true, "Signing in...");
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        const adminDoc = await getDoc(doc(db, "admins", user.uid));
        if (!adminDoc.exists() || adminDoc.data().isAdmin !== true) {
          showToast("error", "Access denied. Not an admin.");
          state.currentUser = null;
          state.isAdmin = false;
          setLoading(false);
          guard(true);
          return;
        }
        state.currentUser = user;
        state.isAdmin = true;
        setLoading(false);
        guard();
        initDashboardListeners();
        initStudentsListeners();
        initCoursesListeners();
        initTimetablesListeners();
        initHostelsListeners();
        initGraduationRequestsListeners();
        initClearanceRequestsListeners();
        showToast("ok", "Welcome, admin!");
        activateNav("dashboard");
      } catch (err) {
        console.error(err);
        setLoading(false);
        showToast("error", err.message || "Login failed");
      }
    }

    function initAuthWatcher() {
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          state.currentUser = null;
          state.isAdmin = false;
          guard();
          return;
        }
        const adminDoc = await getDoc(doc(db, "admins", user.uid));
        if (!adminDoc.exists() || adminDoc.data().isAdmin !== true) {
          state.currentUser = null;
          state.isAdmin = false;
          guard(true);
          return;
        }
        state.currentUser = user;
        state.isAdmin = true;
        guard();
        initDashboardListeners();
        initStudentsListeners();
        initCoursesListeners();
        initTimetablesListeners();
        initHostelsListeners();
        initGraduationRequestsListeners();
        initClearanceRequestsListeners();
      });
    }

    function logout() {
      Object.values(state.unsubscribers).forEach(fn => { try { fn(); } catch {} });
      state.unsubscribers = {};
      signOut(auth);
    }

    // ------------------------------------
    // DASHBOARD
    // ------------------------------------
    async function initDashboardListeners() {
      if (!state.unsubscribers.studentsCount) {
        state.unsubscribers.studentsCount = onSnapshot(collection(db, "students"), (snap) => {
          state.counts.students = snap.size;
          $("#countStudents").textContent = snap.size;
        });
      }
      if (!state.unsubscribers.coursesCount) {
        state.unsubscribers.coursesCount = onSnapshot(collection(db, "courses"), (snap) => {
          state.counts.courses = snap.size;
          $("#countCourses").textContent = snap.size;
        });
      }
      if (!state.unsubscribers.annCount) {
        state.unsubscribers.annCount = onSnapshot(collection(db, "announcements"), (snap) => {
          state.counts.announcements = snap.size;
          $("#countAnnouncements").textContent = snap.size;
        });
      }
      if (!state.unsubscribers.ttCount) {
        state.unsubscribers.ttCount = onSnapshot(collection(db, "timetables"), (snap) => {
          state.counts.timetables = snap.size;
          $("#countTimetables").textContent = snap.size;
        });
      }
      if (!state.unsubscribers.hostelsCount) {
        state.unsubscribers.hostelsCount = onSnapshot(collection(db, "hostels"), (snap) => {
          state.counts.hostels = snap.size;
          $("#countHostels").textContent = snap.size;
        });
      }
      if (!state.unsubscribers.gradRequestsCount) {
        state.unsubscribers.gradRequestsCount = onSnapshot(collection(db, "graduationRequests"), (snap) => {
          state.counts.graduationRequests = snap.size;
          $("#countGraduationRequests").textContent = snap.size;
        });
      }
      if (!state.unsubscribers.clearRequestsCount) {
        state.unsubscribers.clearRequestsCount = onSnapshot(collection(db, "clearanceRequests"), (snap) => {
          state.counts.clearanceRequests = snap.size;
          $("#countClearanceRequests").textContent = snap.size;
        });
      }
    }

    async function exportStudentsCSV() {
      try {
        setLoading(true, "Exporting CSV...");
        const snap = await getDocs(collection(db, "students"));
        const rows = [["id", "name", "email", "regNo", "programme", "department", "campus", "semester", "yearOfStudy", "address", "gender", "dob", "photoURL"]];
        snap.forEach(d => {
          const x = d.data();
          rows.push([
            d.id, x.name || "", x.email || "", x.regNo || "", x.programme || "", x.department || "",
            x.campus || "", x.semester || "", x.yearOfStudy || "", x.address || "", x.gender || "", x.dob || "", x.photoURL || ""
          ]);
        });
        const csv = rows.map(r => r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "students_export.csv"; a.click();
        URL.revokeObjectURL(url);
        setLoading(false);
        showToast("ok", "CSV exported");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "CSV export failed");
      }
    }

    async function exportStudentsPDF() {
      try {
        setLoading(true, "Exporting PDF...");
        const snap = await getDocs(collection(db, "students"));
        const rows = [];
        snap.forEach(d => {
          const x = d.data();
          rows.push([d.id, x.name || "", x.email || "", x.regNo || "", x.programme || "", x.department || ""]);
        });
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF({ orientation: "landscape" });
        docPDF.text("Students Export", 14, 12);
        docPDF.autoTable({
          head: [["ID", "Name", "Email", "Reg No", "Programme", "Department"]],
          body: rows,
          startY: 18
        });
        docPDF.save("students_export.pdf");
        setLoading(false);
        showToast("ok", "PDF exported");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "PDF export failed");
      }
    }

    // ------------------------------------
    // STUDENTS (CRUD + search + photo upload + subcollections)
    // ------------------------------------
    let studentsUnsub = null;
    let studentsCache = [];
    function initStudentsListeners() {
      if (studentsUnsub) return;
      const qRef = collection(db, "students");
      studentsUnsub = onSnapshot(qRef, (snap) => {
        studentsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderStudentsTable(studentsCache);
        $("#studentsTotal").textContent = studentsCache.length;
      });
    }

    function renderStudentsTable(data) {
      const tbody = $("#studentsTableBody");
      tbody.innerHTML = "";
      const term = $("#studentSearch").value.toLowerCase().trim();
      const sortBy = $("#studentSortBy").value;
      let arr = data;
      if (term) {
        arr = data.filter(s =>
          (s.name || "").toLowerCase().includes(term) ||
          (s.regNo || "").toLowerCase().includes(term) ||
          (s.email || "").toLowerCase().includes(term)
        );
      }
      if (sortBy === "name") arr.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
      if (sortBy === "newest") arr.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      if (sortBy === "oldest") arr.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

      for (const s of arr) {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3 text-sm">
            <div class="flex items-center gap-3">
              <img src="${s.photoURL || 'https://ui-avatars.com/api/?name=' + (encodeURIComponent(s.name || 'S'))}" class="h-10 w-10 rounded-full object-cover" alt="photo">
              <div>
                <div class="font-semibold">${s.name || '-'}</div>
                <div class="text-xs text-gray-500">${s.email || ''}</div>
              </div>
            </div>
          </td>
          <td class="p-3 text-sm">${s.regNo || '-'}</td>
          <td class="p-3 text-sm">${s.programme || '-'}</td>
          <td class="p-3 text-sm">${s.department || '-'}</td>
          <td class="p-3 text-sm">${s.yearOfStudy || '-'}</td>
          <td class="p-3 text-sm">
            <button class="px-3 py-1 text-xs bg-gray-600 text-white rounded mr-2" data-view="${s.id}"><i class="fa fa-eye"></i></button>
            <button class="px-3 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${s.id}"><i class="fa fa-pen"></i></button>
            <button class="px-3 py-1 text-xs bg-red-600 text-white rounded" data-del="${s.id}"><i class="fa fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      $$("#studentsTableBody [data-view]").forEach(btn => btn.addEventListener("click", () => openStudentProfile(btn.getAttribute("data-view"))));
      $$("#studentsTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openStudentModal(btn.getAttribute("data-edit"))));
      $$("#studentsTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteStudent(btn.getAttribute("data-del"))));
    }

    $("#studentSearch").addEventListener("input", () => renderStudentsTable(studentsCache));
    $("#studentSortBy").addEventListener("change", () => renderStudentsTable(studentsCache));

    function openStudentModal(id = null) {
      $("#studentForm").reset();
      $("#studentId").value = id || "";
      $("#studentPhoto").value = "";
      $("#studentPhotoPreview").src = "https://placehold.co/80x80";
      if (id) {
        const s = studentsCache.find(x => x.id === id);
        if (s) {
          $("#studentName").value = s.name || "";
          $("#studentEmail").value = s.email || "";
          $("#studentRegNo").value = s.regNo || "";
          $("#studentProgramme").value = s.programme || "";
          $("#studentDepartment").value = s.department || "";
          $("#studentCampus").value = s.campus || "";
          $("#studentSemester").value = s.semester || "";
          $("#studentYear").value = s.yearOfStudy || "";
          $("#studentAddress").value = s.address || "";
          $("#studentGender").value = s.gender || "";
          $("#studentDOB").value = s.dob || "";
          $("#studentPhotoPreview").src = s.photoURL || "https://placehold.co/80x80";
        }
        $("#studentModalTitle").textContent = "Edit Student";
      } else {
        $("#studentModalTitle").textContent = "Add Student";
      }
      $("#studentModal").classList.remove("hidden");
    }

    $("#studentPhoto").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      $("#studentPhotoPreview").src = url;
    });

    async function upsertStudent(e) {
      e.preventDefault();
      const id = $("#studentId").value || null;
      const payload = {
        name: $("#studentName").value.trim(),
        email: $("#studentEmail").value.trim(),
        regNo: $("#studentRegNo").value.trim(),
        programme: $("#studentProgramme").value.trim(),
        department: $("#studentDepartment").value.trim(),
        campus: $("#studentCampus").value.trim(),
        semester: $("#studentSemester").value.trim(),
        yearOfStudy: $("#studentYear").value.trim(),
        address: $("#studentAddress").value.trim(),
        gender: $("#studentGender").value.trim(),
        dob: $("#studentDOB").value.trim(),
        updatedAt: serverTimestamp(),
      };
      try {
        setLoading(true, id ? "Updating student..." : "Adding student...");
        let docRefId = id;
        if (id) {
          await updateDoc(doc(db, "students", id), payload);
        } else {
          payload.createdAt = serverTimestamp();
          const ref = await addDoc(collection(db, "students"), payload);
          docRefId = ref.id;
        }
        const file = $("#studentPhoto").files?.[0];
        if (file) {
          const path = `students/${docRefId}/profile.jpg`;
          const sRef = storageRef(storage, path);
          await uploadBytes(sRef, file);
          const url = await getDownloadURL(sRef);
          await updateDoc(doc(db, "students", docRefId), { photoURL: url, updatedAt: serverTimestamp() });
        }

        $("#studentModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", id ? "Student updated" : "Student added");
      } catch (err) {
        console.error(err);
        setLoading(false);
        showToast("error", err.message || "Failed to save student");
      }
    }

    function confirmDeleteStudent(id) {
      $("#confirmDeleteBtn").setAttribute("data-id", id);
      $("#confirmDeleteModal").classList.remove("hidden");
    }
    async function deleteStudentNow() {
      const id = $("#confirmDeleteBtn").getAttribute("data-id");
      if (!id) return;
      try {
        setLoading(true, "Deleting student...");
        try {
          const docSnap = await getDoc(doc(db, "students", id));
          if (docSnap.exists()) {
            const d = docSnap.data();
            if (d.photoURL) {
              const url = new URL(d.photoURL);
              const parts = decodeURIComponent(url.pathname).split("/");
              const idx = parts.indexOf("o");
              const path = parts[idx + 1];
              if (path) {
                const sRef = storageRef(storage, path);
                await deleteObject(sRef).catch(() => {});
              }
            }
          }
        } catch {}
        await deleteDoc(doc(db, "students", id));
        $("#confirmDeleteModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Student deleted");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed");
      }
    }

    // ------------------------------------
    // STUDENT PROFILE VIEW
    // ------------------------------------
    async function openStudentProfile(studentId) {
      const s = studentsCache.find(x => x.id === studentId);
      if (!s) {
        showToast("error", "Student not found.");
        return;
      }
      state.selectedStudentId = studentId;
      state.selectedStudent = s;

      if (state.gradesUnsub) state.gradesUnsub();
      if (state.feesUnsub) state.feesUnsub();
      if (state.registrationsUnsub) state.registrationsUnsub();

      $("#profilePhoto").src = s.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(s.name || 'S')}`;
      $("#profileName").textContent = s.name || "-";
      $("#profileRegNo").textContent = s.regNo || "-";
      $("#profileProgramme").textContent = s.programme || "-";
      $("#profileDepartment").textContent = s.department || "-";

      loadGrades();
      activateStudentProfileTab("grades");
      activateNav("student-profile");
    }

    // ------------------------------------
    // SUBCOLLECTIONS (Grades, Fees, Registrations)
    // ------------------------------------
    // GRADES
    const gradePoints = { "A": 5, "B+": 4.5, "B": 4, "C+": 3.5, "C": 3, "D+": 2.5, "D": 2, "E": 1, "F": 0 };
    function calculateGPA(grades) {
      if (grades.length === 0) return { gpa: 0, remarks: "" };
      let totalPoints = 0;
      let totalUnits = 0;
      grades.forEach(g => {
        const points = gradePoints[g.grade] || 0;
        const units = parseFloat(g.courseUnit) || 0;
        totalPoints += points * units;
        totalUnits += units;
      });
      const gpa = totalUnits > 0 ? (totalPoints / totalUnits) : 0;
      let remarks = "";
      if (gpa >= 4.5) remarks = "First Class Honours";
      else if (gpa >= 3.5) remarks = "Second Class Honours (Upper Division)";
      else if (gpa >= 2.5) remarks = "Second Class Honours (Lower Division)";
      else if (gpa >= 1.5) remarks = "Pass";
      else remarks = "Fail";
      return { gpa: gpa.toFixed(2), remarks };
    }

    async function loadGrades() {
      if (!state.selectedStudentId) return;
      if (state.gradesUnsub) state.gradesUnsub();
      const tbody = $("#gradesTableBody");
      const qRef = collection(db, `students/${state.selectedStudentId}/grades`);
      state.gradesUnsub = onSnapshot(qRef, (snap) => {
        state.gradesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const arr = state.gradesCache.filter(g =>
          (g.courseName || "").toLowerCase().includes($("#gradesSearch").value.toLowerCase()) ||
          (g.courseCode || "").toLowerCase().includes($("#gradesSearch").value.toLowerCase())
        );
        tbody.innerHTML = "";
        arr.forEach(g => {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          tr.innerHTML = `
            <td class="p-3 text-sm">${g.courseCode || '-'}</td>
            <td class="p-3 text-sm">${g.courseName || '-'}</td>
            <td class="p-3 text-sm">${g.courseUnit || '-'}</td>
            <td class="p-3 text-sm">${g.grade || '-'}</td>
            <td class="p-3 text-sm">${g.semester || '-'}</td>
            <td class="p-3 text-sm">${g.yearOfStudy || '-'}</td>
            <td class="p-3 text-sm text-right">
              <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${g.id}"><i class="fa fa-pen"></i></button>
              <button class="px-2 py-1 text-xs bg-red-600 text-white rounded" data-del="${g.id}"><i class="fa fa-trash"></i></button>
            </td>`;
          tbody.appendChild(tr);
        });
        const { gpa, remarks } = calculateGPA(state.gradesCache);
        $("#gpaValue").textContent = `GPA: ${gpa}`;
        $("#gpaRemarks").textContent = `Remarks: ${remarks}`;
        $$("#gradesTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openGradeModal(btn.getAttribute("data-edit"))));
        $$("#gradesTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteGrade(btn.getAttribute("data-del"))));
      });
    }

    $("#gradesSearch").addEventListener("input", () => {
      loadGrades();
    });

    $("#gradesAddBtn").addEventListener("click", () => openGradeModal());
    $("#gradesExportPDFBtn").addEventListener("click", () => generateTranscriptPDF());

    function openGradeModal(id = null) {
      $("#gradeForm").reset();
      $("#gradeId").value = id || "";
      $("#gradeModalTitle").textContent = id ? "Edit Grade" : "Add Grade";
      if (id) {
        const grade = state.gradesCache.find(g => g.id === id);
        if (grade) {
          $("#gCourseCode").value = grade.courseCode || "";
          $("#gCourseName").value = grade.courseName || "";
          $("#gCourseUnit").value = grade.courseUnit || "";
          $("#gGrade").value = grade.grade || "";
          $("#gSemester").value = grade.semester || "";
          $("#gYear").value = grade.yearOfStudy || "";
        }
      }
      $("#gradeModal").classList.remove("hidden");
    }

    async function upsertGrade(e) {
      e.preventDefault();
      const sid = state.selectedStudentId;
      if (!sid) return;
      const id = $("#gradeId").value || null;
      const payload = {
        courseCode: $("#gCourseCode").value.trim(),
        courseName: $("#gCourseName").value.trim(),
        courseUnit: parseFloat($("#gCourseUnit").value) || 0,
        grade: $("#gGrade").value.trim(),
        semester: $("#gSemester").value.trim(),
        yearOfStudy: $("#gYear").value.trim(),
        updatedAt: serverTimestamp()
      };
      if (!payload.courseCode || !payload.courseName || !payload.grade || payload.courseUnit === 0) {
        showToast("error", "Please fill all required fields.");
        return;
      }
      try {
        setLoading(true, id ? "Updating grade..." : "Adding grade...");
        if (id) {
          await updateDoc(doc(db, `students/${sid}/grades`, id), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, `students/${sid}/grades`), payload);
        }
        $("#gradeModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", id ? "Grade updated" : "Grade added");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Save failed");
      }
    }

    function confirmDeleteGrade(id) {
      $("#confirmDeleteBtn-grade").setAttribute("data-id", id);
      $("#confirmDeleteModal-grade").classList.remove("hidden");
    }

    async function deleteGradeNow() {
      const id = $("#confirmDeleteBtn-grade").getAttribute("data-id");
      const sid = state.selectedStudentId;
      if (!sid || !id) return;
      try {
        setLoading(true, "Deleting grade...");
        await deleteDoc(doc(db, `students/${sid}/grades`, id));
        $("#confirmDeleteModal-grade").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Grade deleted");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed");
      }
    }

    async function generateTranscriptPDF() {
      if (!state.selectedStudent) {
        showToast("error", "No student selected.");
        return;
      }
      if (state.gradesCache.length === 0) {
        showToast("error", "No grades to generate transcript.");
        return;
      }
      setLoading(true, "Generating PDF transcript...");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();
      const student = state.selectedStudent;
      docPDF.setFontSize(22);
      docPDF.text("University Name", 105, 20, null, null, "center");
      docPDF.setFontSize(16);
      docPDF.text("Official Academic Transcript", 105, 28, null, null, "center");
      docPDF.setFontSize(10);
      docPDF.text("P.O Box 123-4567, City", 105, 35, null, null, "center");
      docPDF.setFontSize(12);
      docPDF.text(`Student Name: ${student.name || "-"}`, 15, 50);
      docPDF.text(`Registration No: ${student.regNo || "-"}`, 15, 57);
      docPDF.text(`Programme: ${student.programme || "-"}`, 15, 64);
      docPDF.text(`Department: ${student.department || "-"}`, 15, 71);
      const rows = state.gradesCache.map(g => [g.courseCode, g.courseName, g.courseUnit, g.grade]);
      docPDF.autoTable({
        startY: 85,
        head: [["Course Code", "Course Name", "Units", "Grade"]],
        body: rows,
        headStyles: { fillColor: [24, 116, 205] },
        theme: 'striped',
        styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 'auto' },
          2: { cellWidth: 20, halign: 'center' },
          3: { cellWidth: 20, halign: 'center' },
        }
      });
      const { gpa, remarks } = calculateGPA(state.gradesCache);
      const finalY = docPDF.lastAutoTable.finalY + 10;
      docPDF.text(`Overall GPA: ${gpa}`, 15, finalY);
      docPDF.text(`Remarks: ${remarks}`, 15, finalY + 7);
      docPDF.save(`${student.regNo || 'transcript'}_Transcript.pdf`);
      setLoading(false);
      showToast("ok", "Transcript generated");
    }

    // FEES
    async function loadFeesStatement() {
      if (!state.selectedStudentId) return;
      if (state.feesUnsub) state.feesUnsub();
      const tbody = $("#feesTableBody");
      const qRef = query(collection(db, `students/${state.selectedStudentId}/feesStatement`), orderBy("date", "asc"));
      state.feesUnsub = onSnapshot(qRef, (snap) => {
        state.feesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const arr = state.feesCache.filter(f => (f.description || "").toLowerCase().includes($("#feesSearch").value.toLowerCase()) || (f.date || "").toLowerCase().includes($("#feesSearch").value.toLowerCase()) );
        tbody.innerHTML = "";
        let runningBalance = 0;
        let totalDebit = 0;
        let totalCredit = 0;
        arr.forEach(f => {
          const debit = parseFloat(f.debit) || 0;
          const credit = parseFloat(f.credit) || 0;
          runningBalance += debit - credit;
          totalDebit += debit;
          totalCredit += credit;
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          tr.innerHTML = `
            <td class="p-3 text-sm">${f.date || '-'}</td>
            <td class="p-3 text-sm">${f.description || '-'}</td>
            <td class="p-3 text-sm">${currencyFormatter.format(debit)}</td>
            <td class="p-3 text-sm">${currencyFormatter.format(credit)}</td>
            <td class="p-3 text-sm">${currencyFormatter.format(runningBalance)}</td>
            <td class="p-3 text-sm text-right">
              <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${f.id}"><i class="fa fa-pen"></i></button>
              <button class="px-2 py-1 text-xs bg-red-600 text-white rounded" data-del="${f.id}"><i class="fa fa-trash"></i></button>
            </td>`;
          tbody.appendChild(tr);
        });
        $("#runningBalance").textContent = `Running Balance: ${currencyFormatter.format(runningBalance)}`;
        $$("#feesTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openFeeModal(btn.getAttribute("data-edit"))));
        $$("#feesTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteFee(btn.getAttribute("data-id"))));
      });
    }

    $("#feesSearch").addEventListener("input", () => loadFeesStatement());
    $("#feesAddBtn").addEventListener("click", () => openFeeModal());

    function openFeeModal(id = null) {
      $("#feeForm").reset();
      $("#feeId").value = id || "";
      $("#feeModalTitle").textContent = id ? "Edit Fee Entry" : "Add Fee Entry";
      if (id) {
        const fee = state.feesCache.find(f => f.id === id);
        if (fee) {
          $("#fDate").value = fee.date || "";
          $("#fDescription").value = fee.description || "";
          $("#fDebit").value = fee.debit || "";
          $("#fCredit").value = fee.credit || "";
        }
      }
      $("#feeModal").classList.remove("hidden");
    }

    async function upsertFee(e) {
      e.preventDefault();
      const sid = state.selectedStudentId;
      if (!sid) return;
      const id = $("#feeId").value || null;
      const payload = {
        date: $("#fDate").value.trim(),
        description: $("#fDescription").value.trim(),
        debit: parseFloat($("#fDebit").value) || 0,
        credit: parseFloat($("#fCredit").value) || 0,
        updatedAt: serverTimestamp()
      };
      if (!payload.date || !payload.description || (payload.debit === 0 && payload.credit === 0)) {
        showToast("error", "Date and Description required, and at least one of Debit or Credit must be > 0.");
        return;
      }
      try {
        setLoading(true, id ? "Updating entry..." : "Adding entry...");
        if (id) {
          await updateDoc(doc(db, `students/${sid}/feesStatement`, id), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, `students/${sid}/feesStatement`), payload);
        }
        $("#feeModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", id ? "Fees updated" : "Fees added");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Save failed");
      }
    }

    function confirmDeleteFee(id) {
      $("#confirmDeleteBtn-fee").setAttribute("data-id", id);
      $("#confirmDeleteModal-fee").classList.remove("hidden");
    }

    async function deleteFeeNow() {
      const id = $("#confirmDeleteBtn-fee").getAttribute("data-id");
      const sid = state.selectedStudentId;
      if (!sid || !id) return;
      try {
        setLoading(true, "Deleting...");
        await deleteDoc(doc(db, `students/${sid}/feesStatement`, id));
        $("#confirmDeleteModal-fee").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Entry deleted");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed");
      }
    }

    // REGISTRATIONS
    async function loadRegistrations() {
      if (!state.selectedStudentId) return;
      if (state.registrationsUnsub) state.registrationsUnsub();
      const tbody = $("#regsTableBody");
      const qRef = collection(db, `students/${state.selectedStudentId}/registrations`);
      state.registrationsUnsub = onSnapshot(qRef, (snap) => {
        state.registrationsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderRegistrationsTable(state.registrationsCache);
      });
    }

    function renderRegistrationsTable(data) {
      const tbody = $("#regsTableBody");
      tbody.innerHTML = "";
      const term = $("#regSearch").value.toLowerCase().trim();
      const arr = data.filter(r =>
        (r.courseCode || "").toLowerCase().includes(term) ||
        (r.courseName || "").toLowerCase().includes(term) ||
        (r.department || "").toLowerCase().includes(term)
      );

      arr.forEach(r => {
        const statusColors = {
          "Registered": "bg-green-100 text-green-800",
          "Dropped": "bg-red-100 text-red-800",
          "Completed": "bg-blue-100 text-blue-800"
        };
        const statusClass = statusColors[r.status] || "bg-gray-100 text-gray-800";
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3 text-sm">${r.courseCode || '-'}</td>
          <td class="p-3 text-sm">${r.courseName || '-'}</td>
          <td class="p-3 text-sm">${r.department || '-'}</td>
          <td class="p-3 text-sm">${r.yearOfStudy || '-'}</td>
          <td class="p-3 text-sm">${r.semester || '-'}</td>
          <td class="p-3 text-sm"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${r.status || '-'}</span></td>
          <td class="p-3 text-sm text-right">
            <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${r.id}"><i class="fa fa-pen"></i></button>
            <button class="px-2 py-1 text-xs bg-red-600 text-white rounded" data-del="${r.id}"><i class="fa fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
      $$("#regsTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openRegModal(btn.getAttribute("data-edit"))));
      $$("#regsTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteRegistration(btn.getAttribute("data-del"))));
    }

    $("#regSearch").addEventListener("input", () => renderRegistrationsTable(state.registrationsCache));
    $("#regsAddBtn").addEventListener("click", () => openRegModal());
    $("#regsExportPDFBtn").addEventListener("click", () => exportRegistrationsPDF());
    $("#regsExportCSVBtn").addEventListener("click", () => exportRegistrationsCSV());

    function openRegModal(id = null) {
      $("#regForm").reset();
      $("#regId").value = id || "";
      $("#regModalTitle").textContent = id ? "Edit Registration" : "Add Registration";
      if (id) {
        const reg = state.registrationsCache.find(r => r.id === id);
        if (reg) {
          $("#rCourseCode").value = reg.courseCode || "";
          $("#rCourseName").value = reg.courseName || "";
          $("#rDepartment").value = reg.department || "";
          $("#rYear").value = reg.yearOfStudy || "";
          $("#rSemester").value = reg.semester || "";
          $("#rStatus").value = reg.status || "";
        }
      } else {
        $("#rStatus").value = "Registered";
      }
      $("#regModal").classList.remove("hidden");
    }

    async function upsertRegistration(e) {
      e.preventDefault();
      const sid = state.selectedStudentId;
      if (!sid) return;
      const id = $("#regId").value || null;
      const payload = {
        courseCode: $("#rCourseCode").value.trim(),
        courseName: $("#rCourseName").value.trim(),
        department: $("#rDepartment").value.trim(),
        yearOfStudy: parseFloat($("#rYear").value) || 0,
        semester: parseFloat($("#rSemester").value) || 0,
        status: $("#rStatus").value,
        updatedAt: serverTimestamp()
      };
      if (!payload.courseCode || !payload.courseName || !payload.department || payload.yearOfStudy === 0 || payload.semester === 0) {
        showToast("error", "Please fill all required fields.");
        return;
      }
      try {
        setLoading(true, id ? "Updating registration..." : "Adding registration...");
        if (id) {
          await updateDoc(doc(db, `students/${sid}/registrations`, id), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, `students/${sid}/registrations`), payload);
        }
        $("#regModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", id ? "Registration updated" : "Registration added");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Save failed");
      }
    }

    function confirmDeleteRegistration(id) {
      $("#confirmDeleteBtn-reg").setAttribute("data-id", id);
      $("#confirmDeleteModal-reg").classList.remove("hidden");
    }

    async function deleteRegistrationNow() {
      const id = $("#confirmDeleteBtn-reg").getAttribute("data-id");
      const sid = state.selectedStudentId;
      if (!sid || !id) return;
      try {
        setLoading(true, "Deleting...");
        await deleteDoc(doc(db, `students/${sid}/registrations`, id));
        $("#confirmDeleteModal-reg").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Registration deleted");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed");
      }
    }

    async function exportRegistrationsPDF() {
      if (!state.selectedStudent) {
        showToast("error", "No student selected.");
        return;
      }
      setLoading(true, "Generating PDF...");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();
      const student = state.selectedStudent;
      docPDF.setFontSize(16);
      docPDF.text(`Course Registrations for ${student.name}`, 15, 20);
      const rows = state.registrationsCache.map(r => [r.courseCode, r.courseName, r.department, r.yearOfStudy, r.semester, r.status]);
      docPDF.autoTable({
        startY: 30,
        head: [["Course Code", "Course Name", "Department", "Year", "Semester", "Status"]],
        body: rows,
        headStyles: { fillColor: [24, 116, 205] }
      });
      docPDF.save(`${student.regNo || 'registrations'}_Registrations.pdf`);
      setLoading(false);
      showToast("ok", "PDF exported");
    }

    async function exportRegistrationsCSV() {
      setLoading(true, "Exporting CSV...");
      const rows = [["courseCode", "courseName", "department", "yearOfStudy", "semester", "status"]];
      state.registrationsCache.forEach(r => {
        rows.push([r.courseCode || "", r.courseName || "", r.department || "", r.yearOfStudy || "", r.semester || "", r.status || ""]);
      });
      const csv = rows.map(r => r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `${state.selectedStudent.regNo || 'registrations'}_Registrations.csv`; a.click();
      URL.revokeObjectURL(url);
      setLoading(false);
      showToast("ok", "CSV exported");
    }

    // ------------------------------------
    // COURSES
    // ------------------------------------
    function initCoursesListeners() {
      if (state.coursesUnsub) return;
      const qRef = collection(db, "courses");
      state.coursesUnsub = onSnapshot(qRef, (snap) => {
        state.coursesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderCoursesTable(state.coursesCache);
      });
    }

    function renderCoursesTable(data) {
      const tbody = $("#coursesTableBody");
      tbody.innerHTML = "";
      const term = $("#courseSearch").value.toLowerCase().trim();
      const arr = data.filter(c =>
        (c.courseCode || "").toLowerCase().includes(term) ||
        (c.courseName || "").toLowerCase().includes(term) ||
        (c.department || "").toLowerCase().includes(term)
      );

      arr.forEach(c => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3 text-sm">${c.courseCode || '-'}</td>
          <td class="p-3 text-sm">${c.courseName || '-'}</td>
          <td class="p-3 text-sm">${c.department || '-'}</td>
          <td class="p-3 text-sm">${c.yearOfStudy || '-'}</td>
          <td class="p-3 text-sm">${c.semester || '-'}</td>
          <td class="p-3 text-sm">${c.courseUnit || '-'}</td>
          <td class="p-3 text-sm text-right">
            <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${c.id}"><i class="fa fa-pen"></i></button>
            <button class="px-2 py-1 text-xs bg-red-600 text-white rounded" data-del="${c.id}"><i class="fa fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
      $$("#coursesTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openCourseModal(btn.getAttribute("data-edit"))));
      $$("#coursesTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteCourse(btn.getAttribute("data-del"))));
    }

    $("#courseSearch").addEventListener("input", () => renderCoursesTable(state.coursesCache));
    $("#coursesAddBtn").addEventListener("click", () => openCourseModal());
    $("#coursesExportPDFBtn").addEventListener("click", () => exportCoursesPDF());
    $("#coursesExportCSVBtn").addEventListener("click", () => exportCoursesCSV());

    function openCourseModal(id = null) {
      $("#courseForm").reset();
      $("#courseId").value = id || "";
      $("#courseModalTitle").textContent = id ? "Edit Course" : "Add Course";
      if (id) {
        const course = state.coursesCache.find(c => c.id === id);
        if (course) {
          $("#cCourseCode").value = course.courseCode || "";
          $("#cCourseName").value = course.courseName || "";
          $("#cDepartment").value = course.department || "";
          $("#cYear").value = course.yearOfStudy || "";
          $("#cSemester").value = course.semester || "";
          $("#cCourseUnit").value = course.courseUnit || "";
        }
      }
      $("#courseModal").classList.remove("hidden");
    }

    async function upsertCourse(e) {
      e.preventDefault();
      const id = $("#courseId").value || null;
      const payload = {
        courseCode: $("#cCourseCode").value.trim(),
        courseName: $("#cCourseName").value.trim(),
        department: $("#cDepartment").value.trim(),
        yearOfStudy: parseFloat($("#cYear").value) || 0,
        semester: parseFloat($("#cSemester").value) || 0,
        courseUnit: parseFloat($("#cCourseUnit").value) || 0,
        updatedAt: serverTimestamp()
      };
      if (!payload.courseCode || !payload.courseName || !payload.department || payload.yearOfStudy === 0 || payload.semester === 0 || payload.courseUnit === 0) {
        showToast("error", "Please fill all required fields.");
        return;
      }
      try {
        setLoading(true, id ? "Updating course..." : "Adding course...");
        if (id) {
          await updateDoc(doc(db, `courses`, id), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, `courses`), payload);
        }
        $("#courseModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", id ? "Course updated" : "Course added");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Save failed");
      }
    }

    function confirmDeleteCourse(id) {
      $("#confirmDeleteBtn-course").setAttribute("data-id", id);
      $("#confirmDeleteModal-course").classList.remove("hidden");
    }

    async function deleteCourseNow() {
      const id = $("#confirmDeleteBtn-course").getAttribute("data-id");
      if (!id) return;
      try {
        setLoading(true, "Deleting...");
        await deleteDoc(doc(db, "courses", id));
        $("#confirmDeleteModal-course").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Course deleted");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed");
      }
    }

    async function exportCoursesPDF() {
      setLoading(true, "Generating PDF...");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();
      docPDF.setFontSize(16);
      docPDF.text(`Courses List`, 15, 20);
      const rows = state.coursesCache.map(c => [c.courseCode, c.courseName, c.department, c.yearOfStudy, c.semester, c.courseUnit]);
      docPDF.autoTable({
        startY: 30,
        head: [["Code", "Name", "Department", "Year", "Semester", "Units"]],
        body: rows,
        headStyles: { fillColor: [24, 116, 205] }
      });
      docPDF.save(`courses_list.pdf`);
      setLoading(false);
      showToast("ok", "PDF exported");
    }

    async function exportCoursesCSV() {
      setLoading(true, "Exporting CSV...");
      const rows = [["courseCode", "courseName", "department", "yearOfStudy", "semester", "courseUnit"]];
      state.coursesCache.forEach(c => {
        rows.push([c.courseCode || "", c.courseName || "", c.department || "", c.yearOfStudy || "", c.semester || "", c.courseUnit || ""]);
      });
      const csv = rows.map(r => r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `courses_list.csv`; a.click();
      URL.revokeObjectURL(url);
      setLoading(false);
      showToast("ok", "CSV exported");
    }

    // ------------------------------------
    // TIMETABLES
    // ------------------------------------
    function initTimetablesListeners() {
      if (state.timetablesUnsub) return;
      const qRef = collection(db, "timetables");
      state.timetablesUnsub = onSnapshot(qRef, (snap) => {
        state.timetablesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTimetablesTable(state.timetablesCache);
      });
    }

    function renderTimetablesTable(data) {
      const tbody = $("#timetablesTableBody");
      tbody.innerHTML = "";
      const term = $("#timetableSearch").value.toLowerCase().trim();
      const filterDept = $("#timetableFilterDept").value;
      const filterYear = $("#timetableFilterYear").value;

      let arr = data.filter(t =>
        (t.department || "").toLowerCase().includes(term) ||
        (t.courseCode || "").toLowerCase().includes(term) ||
        (t.day || "").toLowerCase().includes(term)
      );

      if (filterDept) {
        arr = arr.filter(t => t.department === filterDept);
      }
      if (filterYear) {
        arr = arr.filter(t => t.yearOfStudy === parseFloat(filterYear));
      }

      const uniqueDepartments = [...new Set(data.map(t => t.department))];
      const uniqueYears = [...new Set(data.map(t => t.yearOfStudy))];
      populateFilterDropdown("timetableFilterDept", uniqueDepartments);
      populateFilterDropdown("timetableFilterYear", uniqueYears);

      arr.forEach(t => {
        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3 text-sm">${t.department || '-'}</td>
          <td class="p-3 text-sm">${t.yearOfStudy || '-'}</td>
          <td class="p-3 text-sm">${t.semester || '-'}</td>
          <td class="p-3 text-sm">${t.day || '-'}</td>
          <td class="p-3 text-sm">${t.startTime || '-'}</td>
          <td class="p-3 text-sm">${t.endTime || '-'}</td>
          <td class="p-3 text-sm">${t.venue || '-'}</td>
          <td class="p-3 text-sm">${t.courseCode || '-'}</td>
          <td class="p-3 text-sm text-right">
            <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${t.id}"><i class="fa fa-pen"></i></button>
            <button class="px-2 py-1 text-xs bg-red-600 text-white rounded" data-del="${t.id}"><i class="fa fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
      $$("#timetablesTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openTimetableModal(btn.getAttribute("data-edit"))));
      $$("#timetablesTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteTimetable(btn.getAttribute("data-del"))));
    }

    function populateFilterDropdown(id, options) {
      const select = $(`#${id}`);
      const currentValue = select.value;
      select.innerHTML = `<option value="">All</option>`;
      options.sort().forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
      select.value = currentValue;
    }

    $("#timetableSearch").addEventListener("input", () => renderTimetablesTable(state.timetablesCache));
    $("#timetableFilterDept").addEventListener("change", () => renderTimetablesTable(state.timetablesCache));
    $("#timetableFilterYear").addEventListener("change", () => renderTimetablesTable(state.timetablesCache));
    $("#timetablesAddBtn").addEventListener("click", () => openTimetableModal());
    $("#timetablesExportPDFBtn").addEventListener("click", () => exportTimetablesPDF());
    $("#timetablesExportCSVBtn").addEventListener("click", () => exportTimetablesCSV());

    function openTimetableModal(id = null) {
      $("#timetableForm").reset();
      $("#timetableId").value = id || "";
      $("#timetableModalTitle").textContent = id ? "Edit Timetable Entry" : "Add Timetable Entry";
      if (id) {
        const entry = state.timetablesCache.find(t => t.id === id);
        if (entry) {
          $("#tDepartment").value = entry.department || "";
          $("#tYear").value = entry.yearOfStudy || "";
          $("#tSemester").value = entry.semester || "";
          $("#tDay").value = entry.day || "";
          $("#tStartTime").value = entry.startTime || "";
          $("#tEndTime").value = entry.endTime || "";
          $("#tVenue").value = entry.venue || "";
          $("#tCourseCode").value = entry.courseCode || "";
        }
      }
      $("#timetableModal").classList.remove("hidden");
    }

    async function upsertTimetable(e) {
      e.preventDefault();
      const id = $("#timetableId").value || null;
      const payload = {
        department: $("#tDepartment").value.trim(),
        yearOfStudy: parseFloat($("#tYear").value) || 0,
        semester: parseFloat($("#tSemester").value) || 0,
        day: $("#tDay").value.trim(),
        startTime: $("#tStartTime").value.trim(),
        endTime: $("#tEndTime").value.trim(),
        venue: $("#tVenue").value.trim(),
        courseCode: $("#tCourseCode").value.trim(),
        updatedAt: serverTimestamp()
      };
      if (Object.values(payload).some(v => !v && v !== 0)) {
        showToast("error", "Please fill all required fields.");
        return;
      }
      try {
        setLoading(true, id ? "Updating timetable..." : "Adding timetable...");
        if (id) {
          await updateDoc(doc(db, "timetables", id), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, "timetables"), payload);
        }
        $("#timetableModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", id ? "Timetable updated" : "Timetable added");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Save failed");
      }
    }

    function confirmDeleteTimetable(id) {
      $("#confirmDeleteBtn-timetable").setAttribute("data-id", id);
      $("#confirmDeleteModal-timetable").classList.remove("hidden");
    }

    async function deleteTimetableNow() {
      const id = $("#confirmDeleteBtn-timetable").getAttribute("data-id");
      if (!id) return;
      try {
        setLoading(true, "Deleting...");
        await deleteDoc(doc(db, "timetables", id));
        $("#confirmDeleteModal-timetable").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Timetable entry deleted");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed");
      }
    }

    async function exportTimetablesPDF() {
      setLoading(true, "Generating PDF...");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF({ orientation: "landscape" });
      docPDF.setFontSize(16);
      docPDF.text(`Timetables`, 15, 20);
      const rows = state.timetablesCache.map(t => [t.department, t.yearOfStudy, t.semester, t.day, t.startTime, t.endTime, t.venue, t.courseCode]);
      docPDF.autoTable({
        startY: 30,
        head: [["Department", "Year", "Semester", "Day", "Start", "End", "Venue", "Course Code"]],
        body: rows,
        headStyles: { fillColor: [24, 116, 205] }
      });
      docPDF.save(`timetables.pdf`);
      setLoading(false);
      showToast("ok", "PDF exported");
    }

    async function exportTimetablesCSV() {
      setLoading(true, "Exporting CSV...");
      const rows = [["department", "yearOfStudy", "semester", "day", "startTime", "endTime", "venue", "courseCode"]];
      state.timetablesCache.forEach(t => {
        rows.push([t.department || "", t.yearOfStudy || "", t.semester || "", t.day || "", t.startTime || "", t.endTime || "", t.venue || "", t.courseCode || ""]);
      });
      const csv = rows.map(r => r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `timetables.csv`; a.click();
      URL.revokeObjectURL(url);
      setLoading(false);
      showToast("ok", "CSV exported");
    }

    // ------------------------------------
    // HOSTELS
    // ------------------------------------
    function initHostelsListeners() {
      if (state.hostelsUnsub) return;
      const qRef = collection(db, "hostels");
      state.hostelsUnsub = onSnapshot(qRef, (snap) => {
        state.hostelsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderHostelsTable(state.hostelsCache);
      });
    }

    function renderHostelsTable(data) {
      const tbody = $("#hostelsTableBody");
      tbody.innerHTML = "";
      const term = $("#hostelSearch").value.toLowerCase().trim();
      const arr = data.filter(h =>
        (h.name || "").toLowerCase().includes(term) ||
        (h.status || "").toLowerCase().includes(term)
      );

      arr.forEach(h => {
        let statusClass = "bg-gray-100 text-gray-800";
        if (h.status === "Available") statusClass = "bg-green-100 text-green-800";
        if (h.status === "Full") statusClass = "bg-red-100 text-red-800";
        if (h.status === "Under Maintenance") statusClass = "bg-yellow-100 text-yellow-800";

        const availableSlots = (h.capacity || 0) - (h.currentOccupancy || 0);
        const occupancyText = h.currentOccupancy !== undefined && h.currentOccupancy !== null
          ? `${h.currentOccupancy}/${h.capacity} (${availableSlots} available)`
          : "-";

        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3 text-sm">${h.name || '-'}</td>
          <td class="p-3 text-sm">${h.capacity || '-'}</td>
          <td class="p-3 text-sm">${currencyFormatter.format(h.price || 0)}</td>
          <td class="p-3 text-sm"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${h.status || '-'}</span></td>
          <td class="p-3 text-sm">${occupancyText}</td>
          <td class="p-3 text-sm text-right">
            <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${h.id}"><i class="fa fa-pen"></i></button>
            <button class="px-2 py-1 text-xs bg-red-600 text-white rounded" data-del="${h.id}"><i class="fa fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
      $$("#hostelsTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openHostelModal(btn.getAttribute("data-edit"))));
      $$("#hostelsTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteHostel(btn.getAttribute("data-del"))));
    }

    $("#hostelSearch").addEventListener("input", () => renderHostelsTable(state.hostelsCache));
    $("#hostelsAddBtn").addEventListener("click", () => openHostelModal());
    $("#hostelsExportPDFBtn").addEventListener("click", () => exportHostelsPDF());
    $("#hostelsExportCSVBtn").addEventListener("click", () => exportHostelsCSV());

    function openHostelModal(id = null) {
      $("#hostelForm").reset();
      $("#hostelId").value = id || "";
      $("#hostelModalTitle").textContent = id ? "Edit Hostel" : "Add Hostel";
      if (id) {
        const hostel = state.hostelsCache.find(h => h.id === id);
        if (hostel) {
          $("#hName").value = hostel.name || "";
          $("#hCapacity").value = hostel.capacity || "";
          $("#hPrice").value = hostel.price || "";
          $("#hStatus").value = hostel.status || "";
          $("#hOccupancy").value = hostel.currentOccupancy || "";
        }
      }
      $("#hostelModal").classList.remove("hidden");
    }

    async function upsertHostel(e) {
      e.preventDefault();
      const id = $("#hostelId").value || null;
      const capacity = parseFloat($("#hCapacity").value) || 0;
      const occupancy = parseFloat($("#hOccupancy").value) || 0;
      let status = $("#hStatus").value;

      if (occupancy >= capacity) {
        status = "Full";
      }

      const payload = {
        name: $("#hName").value.trim(),
        capacity: capacity,
        price: parseFloat($("#hPrice").value) || 0,
        status: status,
        currentOccupancy: occupancy,
        updatedAt: serverTimestamp()
      };

      if (!payload.name || !payload.capacity || !payload.price) {
        showToast("error", "Please fill all required fields: Name, Capacity, and Price.");
        return;
      }
      try {
        setLoading(true, id ? "Updating hostel..." : "Adding hostel...");
        if (id) {
          await updateDoc(doc(db, "hostels", id), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, "hostels"), payload);
        }
        $("#hostelModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", id ? "Hostel updated" : "Hostel added");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Save failed");
      }
    }

    function confirmDeleteHostel(id) {
      $("#confirmDeleteBtn-hostel").setAttribute("data-id", id);
      $("#confirmDeleteModal-hostel").classList.remove("hidden");
    }

    async function deleteHostelNow() {
      const id = $("#confirmDeleteBtn-hostel").getAttribute("data-id");
      if (!id) return;
      try {
        setLoading(true, "Deleting...");
        await deleteDoc(doc(db, "hostels", id));
        $("#confirmDeleteModal-hostel").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Hostel deleted");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed");
      }
    }

    async function exportHostelsPDF() {
      setLoading(true, "Generating PDF...");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF();
      docPDF.setFontSize(16);
      docPDF.text(`Hostels List`, 15, 20);
      const rows = state.hostelsCache.map(h => [h.name, h.capacity, h.price, h.status, h.currentOccupancy || '-']);
      docPDF.autoTable({
        startY: 30,
        head: [["Name", "Capacity", "Price", "Status", "Occupancy"]],
        body: rows,
        headStyles: { fillColor: [24, 116, 205] }
      });
      docPDF.save(`hostels_list.pdf`);
      setLoading(false);
      showToast("ok", "PDF exported");
    }

    async function exportHostelsCSV() {
      setLoading(true, "Exporting CSV...");
      const rows = [["name", "capacity", "price", "status", "currentOccupancy"]];
      state.hostelsCache.forEach(h => {
        rows.push([h.name || "", h.capacity || "", h.price || "", h.status || "", h.currentOccupancy || ""]);
      });
      const csv = rows.map(r => r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `hostels_list.csv`; a.click();
      URL.revokeObjectURL(url);
      setLoading(false);
      showToast("ok", "CSV exported");
    }

    // ------------------------------------
    // GRADUATION REQUESTS
    // ------------------------------------
    function initGraduationRequestsListeners() {
      if (state.graduationRequestsUnsub) return;
      const qRef = query(collection(db, "graduationRequests"), orderBy("submittedAt", "desc"));
      state.graduationRequestsUnsub = onSnapshot(qRef, (snap) => {
        state.graduationRequestsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderGraduationRequestsTable(state.graduationRequestsCache);
        $("#countGraduationRequests").textContent = state.graduationRequestsCache.length;
      });
    }

    function renderGraduationRequestsTable(data) {
      const tbody = $("#gradReqsTableBody");
      tbody.innerHTML = "";
      const term = $("#gradReqSearch").value.toLowerCase().trim();
      const arr = data.filter(r =>
        (r.name || "").toLowerCase().includes(term) ||
        (r.regNo || "").toLowerCase().includes(term) ||
        (r.status || "").toLowerCase().includes(term)
      );

      arr.forEach(r => {
        const statusColors = {
          "Pending": "bg-yellow-100 text-yellow-800",
          "Approved": "bg-green-100 text-green-800",
          "Rejected": "bg-red-100 text-red-800"
        };
        const statusClass = statusColors[r.status] || "bg-gray-100 text-gray-800";
        const submittedDate = r.submittedAt ? new Date(r.submittedAt.seconds * 1000).toLocaleDateString() : '-';

        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3 text-sm"><a href="#" class="text-blue-600 hover:underline" data-student-id="${r.studentId}">${r.name || '-'}</a></td>
          <td class="p-3 text-sm">${r.regNo || '-'}</td>
          <td class="p-3 text-sm">${r.programme || '-'}</td>
          <td class="p-3 text-sm">${r.department || '-'}</td>
          <td class="p-3 text-sm">${r.yearOfStudy || '-'}</td>
          <td class="p-3 text-sm">${r.gpa || '-'}</td>
          <td class="p-3 text-sm"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${r.status || '-'}</span></td>
          <td class="p-3 text-sm">${submittedDate}</td>
          <td class="p-3 text-sm text-right">
            <button class="px-2 py-1 text-xs bg-gray-600 text-white rounded mr-2" data-view="${r.id}"><i class="fa fa-eye"></i></button>
            <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${r.id}"><i class="fa fa-pen"></i></button>
            <button class="px-2 py-1 text-xs bg-green-600 text-white rounded mr-2" data-approve="${r.id}"><i class="fa fa-check"></i></button>
            <button class="px-2 py-1 text-xs bg-red-600 text-white rounded mr-2" data-reject="${r.id}"><i class="fa fa-times"></i></button>
            <button class="px-2 py-1 text-xs bg-red-800 text-white rounded" data-del="${r.id}"><i class="fa fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
      $$("#gradReqsTableBody [data-student-id]").forEach(btn => btn.addEventListener("click", (e) => {
        e.preventDefault();
        openStudentProfile(btn.getAttribute("data-student-id"));
      }));
      $$("#gradReqsTableBody [data-view]").forEach(btn => btn.addEventListener("click", () => openGradReqModal(btn.getAttribute("data-view"), true))); // True for readOnly
      $$("#gradReqsTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openGradReqModal(btn.getAttribute("data-edit"))));
      $$("#gradReqsTableBody [data-approve]").forEach(btn => btn.addEventListener("click", () => updateGradReqStatus(btn.getAttribute("data-approve"), "Approved")));
      $$("#gradReqsTableBody [data-reject]").forEach(btn => btn.addEventListener("click", () => updateGradReqStatus(btn.getAttribute("data-reject"), "Rejected")));
      $$("#gradReqsTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteGradReq(btn.getAttribute("data-del"))));
    }

    $("#gradReqSearch").addEventListener("input", () => renderGraduationRequestsTable(state.graduationRequestsCache));
    $("#gradReqsExportPDFBtn").addEventListener("click", () => exportGradReqsPDF());
    $("#gradReqsExportCSVBtn").addEventListener("click", () => exportGradReqsCSV());

    function openGradReqModal(id = null, readOnly = false) {
      $("#gradReqForm").reset();
      $("#gradReqId").value = id || "";
      $("#gradReqModalTitle").textContent = id ? (readOnly ? "View Graduation Request" : "Edit Graduation Request") : "Add Graduation Request";
      $("#gradReqSaveBtn").classList.toggle("hidden", readOnly);
      $("#grStatus").disabled = readOnly;
      $("#grRemarks").readOnly = readOnly;

      if (id) {
        const req = state.graduationRequestsCache.find(r => r.id === id);
        if (req) {
          $("#grName").value = req.name || "";
          $("#grRegNo").value = req.regNo || "";
          $("#grProgramme").value = req.programme || "";
          $("#grDepartment").value = req.department || "";
          $("#grYear").value = req.yearOfStudy || "";
          $("#grGpa").value = req.gpa || "";
          $("#grStatus").value = req.status || "";
          $("#grRemarks").value = req.remarks || "";
        }
      }
      $("#gradReqModal").classList.remove("hidden");
    }

    async function updateGradReqStatus(id, newStatus) {
      const req = state.graduationRequestsCache.find(r => r.id === id);
      if (!req) { showToast("error", "Request not found."); return; }
      $("#gradReqId").value = id;
      $("#grName").value = req.name || "";
      $("#grRegNo").value = req.regNo || "";
      $("#grProgramme").value = req.programme || "";
      $("#grDepartment").value = req.department || "";
      $("#grYear").value = req.yearOfStudy || "";
      $("#grGpa").value = req.gpa || "";
      $("#grStatus").value = newStatus;
      $("#grRemarks").value = req.remarks || ""; // Keep existing remarks
      openGradReqModal(id); // Open modal for editing
    }

    async function upsertGradReq(e) {
      e.preventDefault();
      const id = $("#gradReqId").value;
      if (!id) { showToast("error", "No request selected for saving."); return; }

      const payload = {
        status: $("#grStatus").value,
        remarks: $("#grRemarks").value.trim(),
        updatedAt: serverTimestamp()
      };
      if (!payload.status) {
        showToast("error", "Please select a status.");
        return;
      }
      try {
        setLoading(true, "Updating graduation request...");
        await updateDoc(doc(db, "graduationRequests", id), payload);
        $("#gradReqModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Graduation request updated.");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Failed to save request.");
      }
    }

    function confirmDeleteGradReq(id) {
      $("#confirmDeleteBtn-gradReq").setAttribute("data-id", id);
      $("#confirmDeleteModal-gradReq").classList.remove("hidden");
    }

    async function deleteGradReqNow() {
      const id = $("#confirmDeleteBtn-gradReq").getAttribute("data-id");
      if (!id) return;
      try {
        setLoading(true, "Deleting graduation request...");
        await deleteDoc(doc(db, "graduationRequests", id));
        $("#confirmDeleteModal-gradReq").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Graduation request deleted.");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed.");
      }
    }

    async function exportGradReqsPDF() {
      setLoading(true, "Generating PDF...");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF({ orientation: "landscape" });
      docPDF.setFontSize(16);
      docPDF.text(`Graduation Requests`, 15, 20);
      const rows = state.graduationRequestsCache.map(r => [
        r.name, r.regNo, r.programme, r.department, r.yearOfStudy, r.gpa, r.status,
        r.submittedAt ? new Date(r.submittedAt.seconds * 1000).toLocaleDateString() : '-'
      ]);
      docPDF.autoTable({
        startY: 30,
        head: [["Name", "Reg No", "Programme", "Department", "Year", "GPA", "Status", "Submitted Date"]],
        body: rows,
        headStyles: { fillColor: [24, 116, 205] }
      });
      docPDF.save(`graduation_requests.pdf`);
      setLoading(false);
      showToast("ok", "PDF exported");
    }

    async function exportGradReqsCSV() {
      setLoading(true, "Exporting CSV...");
      const rows = [["studentId", "name", "regNo", "programme", "department", "yearOfStudy", "gpa", "status", "submittedAt", "remarks"]];
      state.graduationRequestsCache.forEach(r => {
        rows.push([
          r.studentId || "", r.name || "", r.regNo || "", r.programme || "", r.department || "",
          r.yearOfStudy || "", r.gpa || "", r.status || "",
          r.submittedAt ? new Date(r.submittedAt.seconds * 1000).toISOString() : "", r.remarks || ""
        ]);
      });
      const csv = rows.map(r => r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `graduation_requests.csv`; a.click();
      URL.revokeObjectURL(url);
      setLoading(false);
      showToast("ok", "CSV exported");
    }

    // ------------------------------------
    // CLEARANCE REQUESTS
    // ------------------------------------
    function initClearanceRequestsListeners() {
      if (state.clearanceRequestsUnsub) return;
      const qRef = query(collection(db, "clearanceRequests"), orderBy("submittedAt", "desc"));
      state.clearanceRequestsUnsub = onSnapshot(qRef, (snap) => {
        state.clearanceRequestsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderClearanceRequestsTable(state.clearanceRequestsCache);
        $("#countClearanceRequests").textContent = state.clearanceRequestsCache.length;
      });
    }

    function renderClearanceRequestsTable(data) {
      const tbody = $("#clearReqsTableBody");
      tbody.innerHTML = "";
      const term = $("#clearReqSearch").value.toLowerCase().trim();
      const arr = data.filter(r =>
        (r.name || "").toLowerCase().includes(term) ||
        (r.regNo || "").toLowerCase().includes(term) ||
        (r.status || "").toLowerCase().includes(term)
      );

      arr.forEach(r => {
        const statusColors = {
          "Pending": "bg-yellow-100 text-yellow-800",
          "Cleared": "bg-green-100 text-green-800",
          "Rejected": "bg-red-100 text-red-800"
        };
        const statusClass = statusColors[r.status] || "bg-gray-100 text-gray-800";
        const submittedDate = r.submittedAt ? new Date(r.submittedAt.seconds * 1000).toLocaleDateString() : '-';

        let sectionsProgress = '';
        if (r.sections && typeof r.sections === 'object') {
          const totalSections = Object.keys(r.sections).length;
          const clearedSections = Object.values(r.sections).filter(s => s === 'Cleared').length;
          sectionsProgress = `<div class="text-xs text-gray-500 mt-1">${clearedSections}/${totalSections} sections cleared</div>`;
        }

        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-gray-50";
        tr.innerHTML = `
          <td class="p-3 text-sm"><a href="#" class="text-blue-600 hover:underline" data-student-id="${r.studentId}">${r.name || '-'}</a></td>
          <td class="p-3 text-sm">${r.regNo || '-'}</td>
          <td class="p-3 text-sm">${r.programme || '-'}</td>
          <td class="p-3 text-sm">${r.department || '-'}</td>
          <td class="p-3 text-sm"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${r.status || '-'}</span>${sectionsProgress}</td>
          <td class="p-3 text-sm">${submittedDate}</td>
          <td class="p-3 text-sm text-right">
            <button class="px-2 py-1 text-xs bg-gray-600 text-white rounded mr-2" data-view="${r.id}"><i class="fa fa-eye"></i></button>
            <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded mr-2" data-edit="${r.id}"><i class="fa fa-pen"></i></button>
            <button class="px-2 py-1 text-xs bg-green-600 text-white rounded mr-2" data-approve="${r.id}"><i class="fa fa-check"></i></button>
            <button class="px-2 py-1 text-xs bg-red-600 text-white rounded mr-2" data-reject="${r.id}"><i class="fa fa-times"></i></button>
            <button class="px-2 py-1 text-xs bg-red-800 text-white rounded" data-del="${r.id}"><i class="fa fa-trash"></i></button>
          </td>`;
        tbody.appendChild(tr);
      });
      $$("#clearReqsTableBody [data-student-id]").forEach(btn => btn.addEventListener("click", (e) => {
        e.preventDefault();
        openStudentProfile(btn.getAttribute("data-student-id"));
      }));
      $$("#clearReqsTableBody [data-view]").forEach(btn => btn.addEventListener("click", () => openClearReqModal(btn.getAttribute("data-view"), true))); // True for readOnly
      $$("#clearReqsTableBody [data-edit]").forEach(btn => btn.addEventListener("click", () => openClearReqModal(btn.getAttribute("data-edit"))));
      $$("#clearReqsTableBody [data-approve]").forEach(btn => btn.addEventListener("click", () => updateClearReqStatus(btn.getAttribute("data-approve"), "Cleared")));
      $$("#clearReqsTableBody [data-reject]").forEach(btn => btn.addEventListener("click", () => updateClearReqStatus(btn.getAttribute("data-reject"), "Rejected")));
      $$("#clearReqsTableBody [data-del]").forEach(btn => btn.addEventListener("click", () => confirmDeleteClearReq(btn.getAttribute("data-del"))));
    }

    $("#clearReqSearch").addEventListener("input", () => renderClearanceRequestsTable(state.clearanceRequestsCache));
    $("#clearReqsExportPDFBtn").addEventListener("click", () => exportClearReqsPDF());
    $("#clearReqsExportCSVBtn").addEventListener("click", () => exportClearReqsCSV());

    function openClearReqModal(id = null, readOnly = false) {
      $("#clearReqForm").reset();
      $("#clearReqId").value = id || "";
      $("#clearReqModalTitle").textContent = id ? (readOnly ? "View Clearance Request" : "Edit Clearance Request") : "Add Clearance Request";
      $("#clearReqSaveBtn").classList.toggle("hidden", readOnly);
      $("#cStatus").disabled = readOnly;
      $("#cRemarks").readOnly = readOnly;
      $("#clearanceSectionsContainer").innerHTML = ''; // Clear previous sections

      if (id) {
        const req = state.clearanceRequestsCache.find(r => r.id === id);
        if (req) {
          $("#cName").value = req.name || "";
          $("#cRegNo").value = req.regNo || "";
          $("#cProgramme").value = req.programme || "";
          $("#cDepartment").value = req.department || "";
          $("#cStatus").value = req.status || "";
          $("#cRemarks").value = req.remarks || "";

          if (req.sections && typeof req.sections === 'object') {
            for (const sectionKey in req.sections) {
              if (Object.hasOwnProperty.call(req.sections, sectionKey)) {
                const sectionStatus = req.sections[sectionKey];
                const sectionHtml = `
                  <div class="mb-2">
                    <label for="section-${sectionKey}" class="block text-sm font-medium text-gray-700 capitalize">${sectionKey}</label>
                    <select id="section-${sectionKey}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" ${readOnly ? 'disabled' : ''}>
                      <option value="Pending">Pending</option>
                      <option value="Cleared">Cleared</option>
                      <option value="Rejected">Rejected</option>
                    </select>
                  </div>
                `;
                $("#clearanceSectionsContainer").insertAdjacentHTML('beforeend', sectionHtml);
                $(`#section-${sectionKey}`).value = sectionStatus;
              }
            }
          }
        }
      }
      $("#clearReqModal").classList.remove("hidden");
    }

    async function updateClearReqStatus(id, newStatus) {
      const req = state.clearanceRequestsCache.find(r => r.id === id);
      if (!req) { showToast("error", "Request not found."); return; }
      $("#clearReqId").value = id;
      $("#cName").value = req.name || "";
      $("#cRegNo").value = req.regNo || "";
      $("#cProgramme").value = req.programme || "";
      $("#cDepartment").value = req.department || "";
      $("#cStatus").value = newStatus;
      $("#cRemarks").value = req.remarks || "";

      $("#clearanceSectionsContainer").innerHTML = ''; // Clear previous sections
      if (req.sections && typeof req.sections === 'object') {
        for (const sectionKey in req.sections) {
          if (Object.hasOwnProperty.call(req.sections, sectionKey)) {
            const sectionStatus = req.sections[sectionKey];
            const sectionHtml = `
              <div class="mb-2">
                <label for="section-${sectionKey}" class="block text-sm font-medium text-gray-700 capitalize">${sectionKey}</label>
                <select id="section-${sectionKey}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2">
                  <option value="Pending">Pending</option>
                  <option value="Cleared">Cleared</option>
                  <option value="Rejected">Rejected</option>
                </select>
              </div>
            `;
            $("#clearanceSectionsContainer").insertAdjacentHTML('beforeend', sectionHtml);
            $(`#section-${sectionKey}`).value = sectionStatus;
          }
        }
      }

      openClearReqModal(id); // Open modal for editing
    }

    async function upsertClearReq(e) {
      e.preventDefault();
      const id = $("#clearReqId").value;
      if (!id) { showToast("error", "No request selected for saving."); return; }

      const payload = {
        status: $("#cStatus").value,
        remarks: $("#cRemarks").value.trim(),
        updatedAt: serverTimestamp()
      };

      const currentReq = state.clearanceRequestsCache.find(r => r.id === id);
      if (currentReq && currentReq.sections && typeof currentReq.sections === 'object') {
        const updatedSections = {};
        let allCleared = true;
        for (const sectionKey in currentReq.sections) {
          const sectionSelect = $(`#section-${sectionKey}`);
          if (sectionSelect) {
            updatedSections[sectionKey] = sectionSelect.value;
            if (sectionSelect.value !== "Cleared") {
              allCleared = false;
            }
          } else {
            updatedSections[sectionKey] = currentReq.sections[sectionKey]; // Preserve if no select found
            if (currentReq.sections[sectionKey] !== "Cleared") {
              allCleared = false;
            }
          }
        }
        payload.sections = updatedSections;
        if (allCleared) {
          payload.status = "Cleared"; // Auto-set main status if all sub-sections are cleared
        }
      }

      if (!payload.status) {
        showToast("error", "Please select a status.");
        return;
      }
      try {
        setLoading(true, "Updating clearance request...");
        await updateDoc(doc(db, "clearanceRequests", id), payload);
        $("#clearReqModal").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Clearance request updated.");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Failed to save request.");
      }
    }

    function confirmDeleteClearReq(id) {
      $("#confirmDeleteBtn-clearReq").setAttribute("data-id", id);
      $("#confirmDeleteModal-clearReq").classList.remove("hidden");
    }

    async function deleteClearReqNow() {
      const id = $("#confirmDeleteBtn-clearReq").getAttribute("data-id");
      if (!id) return;
      try {
        setLoading(true, "Deleting clearance request...");
        await deleteDoc(doc(db, "clearanceRequests", id));
        $("#confirmDeleteModal-clearReq").classList.add("hidden");
        setLoading(false);
        showToast("ok", "Clearance request deleted.");
      } catch (err) {
        setLoading(false);
        showToast("error", err.message || "Delete failed.");
      }
    }

    async function exportClearReqsPDF() {
      setLoading(true, "Generating PDF...");
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF({ orientation: "landscape" });
      docPDF.setFontSize(16);
      docPDF.text(`Clearance Requests`, 15, 20);
      const rows = state.clearanceRequestsCache.map(r => {
        let sectionsSummary = '';
        if (r.sections && typeof r.sections === 'object') {
          const totalSections = Object.keys(r.sections).length;
          const clearedSections = Object.values(r.sections).filter(s => s === 'Cleared').length;
          sectionsSummary = `${clearedSections}/${totalSections} sections cleared`;
        }
        return [
          r.name, r.regNo, r.programme, r.department, r.status,
          r.submittedAt ? new Date(r.submittedAt.seconds * 1000).toLocaleDateString() : '-',
          sectionsSummary
        ];
      });
      docPDF.autoTable({
        startY: 30,
        head: [["Name", "Reg No", "Programme", "Department", "Status", "Submitted Date", "Sections"]],
        body: rows,
        headStyles: { fillColor: [24, 116, 205] }
      });
      docPDF.save(`clearance_requests.pdf`);
      setLoading(false);
      showToast("ok", "PDF exported");
    }

    async function exportClearReqsCSV() {
      setLoading(true, "Exporting CSV...");
      const rows = [["studentId", "name", "regNo", "programme", "department", "status", "submittedAt", "remarks", "sections"]];
      state.clearanceRequestsCache.forEach(r => {
        rows.push([
          r.studentId || "", r.name || "", r.regNo || "", r.programme || "", r.department || "",
          r.status || "", r.submittedAt ? new Date(r.submittedAt.seconds * 1000).toISOString() : "", r.remarks || "",
          JSON.stringify(r.sections || {})
        ]);
      });
      const csv = rows.map(r => r.map(v => `"${(v ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `clearance_requests.csv`; a.click();
      URL.revokeObjectURL(url);
      setLoading(false);
      showToast("ok", "CSV exported");
    }

    // ------------------------------------
    // INITIALIZATION & EVENT LISTENERS
    // ------------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      initAuthWatcher();
      $("#loginForm").addEventListener("submit", loginEmailPassword);
      $("#logoutBtn").addEventListener("click", logout);
      $("#studentForm").addEventListener("submit", upsertStudent);
      $("#addStudentBtn").addEventListener("click", () => openStudentModal());
      $("#confirmDeleteBtn").addEventListener("click", deleteStudentNow);
      $("#gradesAddBtn").addEventListener("click", () => openGradeModal());
      $("#gradeForm").addEventListener("submit", upsertGrade);
      $("#confirmDeleteBtn-grade").addEventListener("click", deleteGradeNow);
      $("#feesAddBtn").addEventListener("click", () => openFeeModal());
      $("#feeForm").addEventListener("submit", upsertFee);
      $("#confirmDeleteBtn-fee").addEventListener("click", deleteFeeNow);
      $("#regsAddBtn").addEventListener("click", () => openRegModal());
      $("#regForm").addEventListener("submit", upsertRegistration);
      $("#confirmDeleteBtn-reg").addEventListener("click", deleteRegistrationNow);
      $("#coursesAddBtn").addEventListener("click", () => openCourseModal());
      $("#courseForm").addEventListener("submit", upsertCourse);
      $("#confirmDeleteBtn-course").addEventListener("click", deleteCourseNow);
      $("#timetablesAddBtn").addEventListener("click", () => openTimetableModal());
      $("#timetableForm").addEventListener("submit", upsertTimetable);
      $("#confirmDeleteBtn-timetable").addEventListener("click", deleteTimetableNow);
      $("#hostelsAddBtn").addEventListener("click", () => openHostelModal());
      $("#hostelForm").addEventListener("submit", upsertHostel);
      $("#confirmDeleteBtn-hostel").addEventListener("click", deleteHostelNow);
      $("#gradReqForm").addEventListener("submit", upsertGradReq);
      $("#confirmDeleteBtn-gradReq").addEventListener("click", deleteGradReqNow);
      $("#clearReqForm").addEventListener("submit", upsertClearReq);
      $("#confirmDeleteBtn-clearReq").addEventListener("click", deleteClearReqNow);


      $$(".nav-item").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const target = btn.getAttribute("data-target");
          activateNav(target);
        });
      });

      $$(".student-profile-tab-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const tab = btn.getAttribute("data-tab");
          activateStudentProfileTab(tab);
          if (tab === "grades") loadGrades();
          if (tab === "fees") loadFeesStatement();
          if (tab === "registrations") loadRegistrations();
        });
      });
    });

  </script>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[100] hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
      <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mr-4"></div>
      <p id="loadingText" class="text-lg text-gray-700">Working...</p>
    </div>
  </div>

  <!-- Auth Screen -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center bg-gray-200">
    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Admin Login</h2>
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="loginEmail" name="loginEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
        </div>
        <div>
          <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="loginPassword" name="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
        </div>
        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Sign In
        </button>
      </form>
    </div>
  </div>

  <!-- Main App Screen -->
  <div id="appScreen" class="min-h-screen hidden">
    <div class="flex">
      <!-- Sidebar -->
      <aside class="w-64 bg-white shadow-lg h-screen fixed top-0 left-0 overflow-y-auto">
        <div class="p-6 border-b">
          <h1 class="text-xl font-bold text-gray-800">Admin Panel</h1>
        </div>
        <nav class="mt-6">
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="dashboard">
            <i class="fa fa-tachometer-alt mr-3"></i> Dashboard
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="students">
            <i class="fa fa-users mr-3"></i> Students
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="courses">
            <i class="fa fa-book mr-3"></i> Courses
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="timetables">
            <i class="fa fa-calendar mr-3"></i> Timetables
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="hostels">
            <i class="fa fa-bed mr-3"></i> Hostels
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="graduation-requests">
            <i class="fa fa-user-graduate mr-3"></i> Grad Requests
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="clearance-requests">
            <i class="fa fa-file-signature mr-3"></i> Clearance Requests
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="announcements">
            <i class="fa fa-bullhorn mr-3"></i> Announcements
          </a>
          <a href="#" class="nav-item flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors" data-target="explorer">
            <i class="fa fa-database mr-3"></i> Firestore Explorer
          </a>
          <button id="logoutBtn" class="w-full flex items-center py-2 px-6 text-gray-700 hover:bg-gray-100 hover:text-blue-600 transition-colors mt-4">
            <i class="fa fa-sign-out-alt mr-3"></i> Logout
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="ml-64 flex-1 p-8">

        <!-- DASHBOARD Section -->
        <section id="sec-dashboard" class="hidden">
          <h2 class="text-3xl font-semibold text-gray-800 mb-6">Dashboard</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-600">Total Students</h3>
                  <p id="countStudents" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="text-4xl text-blue-500"><i class="fa fa-users"></i></div>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-600">Total Courses</h3>
                  <p id="countCourses" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="text-4xl text-green-500"><i class="fa fa-book"></i></div>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-600">Announcements</h3>
                  <p id="countAnnouncements" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="text-4xl text-yellow-500"><i class="fa fa-bullhorn"></i></div>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-600">Timetable Entries</h3>
                  <p id="countTimetables" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="text-4xl text-purple-500"><i class="fa fa-calendar"></i></div>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-600">Hostels</h3>
                  <p id="countHostels" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="text-4xl text-pink-500"><i class="fa fa-bed"></i></div>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-600">Graduation Requests</h3>
                  <p id="countGraduationRequests" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="text-4xl text-indigo-500"><i class="fa fa-user-graduate"></i></div>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-lg font-semibold text-gray-600">Clearance Requests</h3>
                  <p id="countClearanceRequests" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="text-4xl text-orange-500"><i class="fa fa-file-signature"></i></div>
              </div>
            </div>
          </div>
          <div class="mt-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Actions</h3>
            <div class="flex flex-wrap gap-4">
              <button onclick="activateNav('students')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Student</button>
              <button onclick="activateNav('announcements')" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 flex items-center"><i class="fa fa-plus-circle mr-2"></i> New Announcement</button>
              <button id="exportStudentsPDFBtn" onclick="exportStudentsPDF()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export Students PDF</button>
              <button id="exportStudentsCSVBtn" onclick="exportStudentsCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export Students CSV</button>
            </div>
          </div>
        </section>

        <!-- STUDENTS Section -->
        <section id="sec-students" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-800">Students</h2>
            <div class="flex space-x-2">
              <button id="addStudentBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Student</button>
              <button id="studentsExportPDFBtn" onclick="exportStudentsPDF()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
              <button id="studentsExportCSVBtn" onclick="exportStudentsCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
            </div>
          </div>
          <div class="flex justify-between items-center mb-4">
            <div>
              <input type="text" id="studentSearch" placeholder="Search by name, email, or reg. no." class="border rounded-md px-3 py-2 w-72" />
            </div>
            <div>
              <span class="text-sm font-medium text-gray-700">Sort by:</span>
              <select id="studentSortBy" class="border rounded-md px-2 py-2 ml-2">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="name">Name A-Z</option>
              </select>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 bg-gray-50 flex justify-between items-center">
              <h3 class="text-lg font-medium text-gray-700">Student List</h3>
              <span class="text-sm text-gray-500">Total: <span id="studentsTotal">0</span></span>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Reg. No</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Programme</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Department</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Year</th>
                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                  <!-- Student rows will be injected here -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- STUDENT PROFILE Section -->
        <section id="sec-student-profile" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-800">Student Profile</h2>
            <button onclick="activateNav('students')" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-arrow-left mr-2"></i> Back to Students</button>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">
              <img id="profilePhoto" class="h-24 w-24 rounded-full object-cover border-4 border-white shadow-md" src="https://placehold.co/96x96" alt="Profile Photo" />
              <div>
                <h3 id="profileName" class="text-2xl font-bold text-gray-900">-</h3>
                <p id="profileRegNo" class="text-md text-gray-600">-</p>
                <p id="profileProgramme" class="text-sm text-gray-500">-</p>
                <p id="profileDepartment" class="text-sm text-gray-500">-</p>
              </div>
            </div>
          </div>

          <!-- Tabs for subcollections -->
          <div id="sec-student-profile-tabs" class="bg-white rounded-lg shadow-lg mb-6 hidden">
            <div class="border-b border-gray-200">
              <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button id="tab-grades" data-tab="grades" class="student-profile-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                  <i class="fa fa-graduation-cap mr-2"></i> Grades
                </button>
                <button id="tab-fees" data-tab="fees" class="student-profile-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                  <i class="fa fa-dollar-sign mr-2"></i> Fees Statement
                </button>
                <button id="tab-registrations" data-tab="registrations" class="student-profile-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                  <i class="fa fa-clipboard-list mr-2"></i> Course Registrations
                </button>
              </nav>
            </div>
            <div class="p-6">
              <!-- Grades Tab Content -->
              <div id="content-grades" class="student-profile-tab-content">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-gray-800">Grades</h3>
                  <div class="flex space-x-2">
                    <button id="gradesAddBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Grade</button>
                    <button id="gradesExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export Transcript</button>
                  </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                  <input type="text" id="gradesSearch" placeholder="Search by course..." class="border rounded-md px-3 py-2 w-full max-w-sm" />
                  <div class="flex items-center space-x-4 text-sm font-semibold text-gray-700">
                    <span id="gpaValue">GPA: -</span>
                    <span id="gpaRemarks">Remarks: -</span>
                  </div>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Code</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Units</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Grade</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Semester</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Year</th>
                          <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="gradesTableBody" class="bg-white divide-y divide-gray-200">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <!-- Fees Tab Content -->
              <div id="content-fees" class="student-profile-tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-gray-800">Fees Statement</h3>
                  <div class="flex space-x-2">
                    <button id="feesAddBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Entry</button>
                    <button id="feesExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
                    <button id="feesExportCSVBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
                  </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                  <input type="text" id="feesSearch" placeholder="Search by description or date" class="border rounded-md px-3 py-2 w-full max-w-sm" />
                  <span id="runningBalance" class="text-md font-semibold text-gray-700">Running Balance: -</span>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Description</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Debit (KES)</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Credit (KES)</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Balance (KES)</th>
                          <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="feesTableBody" class="bg-white divide-y divide-gray-200">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <!-- Registrations Tab Content -->
              <div id="content-registrations" class="student-profile-tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold text-gray-800">Course Registrations</h3>
                  <div class="flex space-x-2">
                    <button id="regsAddBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Registration</button>
                    <button id="regsExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
                    <button id="regsExportCSVBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
                  </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                  <input type="text" id="regSearch" placeholder="Search by course code, name, or department" class="border rounded-md px-3 py-2 w-full max-w-sm" />
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Course Code</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Course Name</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Department</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Year</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Semester</th>
                          <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                          <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="regsTableBody" class="bg-white divide-y divide-gray-200">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- COURSES Section -->
        <section id="sec-courses" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-800">Courses</h2>
            <div class="flex space-x-2">
              <button id="coursesAddBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Course</button>
              <button id="coursesExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
              <button id="coursesExportCSVBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
            </div>
          </div>
          <div class="flex justify-between items-center mb-4">
            <input type="text" id="courseSearch" placeholder="Search by course code, name, or department" class="border rounded-md px-3 py-2 w-full max-w-sm" />
          </div>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Course Code</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Course Name</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Department</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Year of Study</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Semester</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Course Unit</th>
                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="coursesTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- TIMETABLES Section -->
        <section id="sec-timetables" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-800">Timetables</h2>
            <div class="flex space-x-2">
              <button id="timetablesAddBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Entry</button>
              <button id="timetablesExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
              <button id="timetablesExportCSVBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <input type="text" id="timetableSearch" placeholder="Search by department, code, or day" class="border rounded-md px-3 py-2 flex-1" />
            <select id="timetableFilterDept" class="border rounded-md px-3 py-2">
              <option value="">Filter by Department</option>
            </select>
            <select id="timetableFilterYear" class="border rounded-md px-3 py-2">
              <option value="">Filter by Year</option>
            </select>
          </div>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Department</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Year</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Semester</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Day</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Start Time</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">End Time</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Venue</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Course Code</th>
                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="timetablesTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- HOSTELS Section -->
        <section id="sec-hostels" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-800">Hostels</h2>
            <div class="flex space-x-2">
              <button id="hostelsAddBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center"><i class="fa fa-plus-circle mr-2"></i> Add Hostel</button>
              <button id="hostelsExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
              <button id="hostelsExportCSVBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
            </div>
          </div>
          <div class="flex justify-between items-center mb-4">
            <input type="text" id="hostelSearch" placeholder="Search by name or status" class="border rounded-md px-3 py-2 w-full max-w-sm" />
          </div>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Hostel Name</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Capacity</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Price (KES)</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Current Occupancy</th>
                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="hostelsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- GRADUATION REQUESTS Section -->
        <section id="sec-graduation-requests" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-800">Graduation Requests</h2>
            <div class="flex space-x-2">
              <button id="gradReqsExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
              <button id="gradReqsExportCSVBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
            </div>
          </div>
          <div class="flex justify-between items-center mb-4">
            <input type="text" id="gradReqSearch" placeholder="Search by name, reg. no., or status" class="border rounded-md px-3 py-2 w-full max-w-sm" />
          </div>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Reg No</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Programme</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Department</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Year</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">GPA</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Submitted Date</th>
                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="gradReqsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CLEARANCE REQUESTS Section -->
        <section id="sec-clearance-requests" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-800">Clearance Requests</h2>
            <div class="flex space-x-2">
              <button id="clearReqsExportPDFBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-pdf mr-2"></i> Export PDF</button>
              <button id="clearReqsExportCSVBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center"><i class="fa fa-file-csv mr-2"></i> Export CSV</button>
            </div>
          </div>
          <div class="flex justify-between items-center mb-4">
            <input type="text" id="clearReqSearch" placeholder="Search by name, reg. no., or status" class="border rounded-md px-3 py-2 w-full max-w-sm" />
          </div>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Reg No</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Programme</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Department</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Submitted Date</th>
                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody id="clearReqsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ANNOUNCEMENTS Section -->
        <section id="sec-announcements" class="hidden">
          <h2 class="text-3xl font-semibold text-gray-800">Announcements</h2>
          <p>Announcements management is not yet implemented. This section is a placeholder.</p>
        </section>

        <!-- FIRESTORE EXPLORER Section -->
        <section id="sec-explorer" class="hidden">
          <h2 class="text-3xl font-semibold text-gray-800">Firestore Explorer</h2>
          <p>The Firestore Explorer is a placeholder for a future feature.</p>
        </section>

      </main>
    </div>
  </div>

  <!-- Student Add/Edit Modal -->
  <div id="studentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="studentModalTitle" class="text-2xl font-semibold">Add Student</h3>
        <button onclick="document.getElementById('studentModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="studentForm" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input type="hidden" id="studentId" />
        <div class="col-span-1">
          <label for="studentName" class="block text-sm font-medium text-gray-700">Full Name</label>
          <input type="text" id="studentName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="studentEmail" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentRegNo" class="block text-sm font-medium text-gray-700">Reg. No</label>
          <input type="text" id="studentRegNo" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentProgramme" class="block text-sm font-medium text-gray-700">Programme</label>
          <input type="text" id="studentProgramme" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentDepartment" class="block text-sm font-medium text-gray-700">Department</label>
          <input type="text" id="studentDepartment" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentCampus" class="block text-sm font-medium text-gray-700">Campus</label>
          <input type="text" id="studentCampus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentSemester" class="block text-sm font-medium text-gray-700">Semester</label>
          <input type="text" id="studentSemester" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentYear" class="block text-sm font-medium text-gray-700">Year of Study</label>
          <input type="number" id="studentYear" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2">
          <label for="studentAddress" class="block text-sm font-medium text-gray-700">Address</label>
          <textarea id="studentAddress" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2"></textarea>
        </div>
        <div class="col-span-1">
          <label for="studentGender" class="block text-sm font-medium text-gray-700">Gender</label>
          <input type="text" id="studentGender" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-1">
          <label for="studentDOB" class="block text-sm font-medium text-gray-700">Date of Birth</label>
          <input type="date" id="studentDOB" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium text-gray-700">Profile Photo</label>
          <div class="mt-1 flex items-center">
            <img id="studentPhotoPreview" class="h-20 w-20 rounded-full object-cover mr-4" src="https://placehold.co/80x80" alt="photo" />
            <input type="file" id="studentPhoto" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
          </div>
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('studentModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Student</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Student Delete Confirmation Modal -->
  <div id="confirmDeleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Student?</h3>
        <p class="text-sm text-gray-600">This action cannot be undone. Are you sure you want to delete this student and all their associated data?</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Grade Add/Edit Modal -->
  <div id="gradeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="gradeModalTitle" class="text-xl font-semibold">Add Grade</h3>
        <button onclick="document.getElementById('gradeModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="gradeForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="gradeId" />
        <div>
          <label for="gCourseCode" class="block text-sm font-medium text-gray-700">Course Code</label>
          <input type="text" id="gCourseCode" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="gCourseName" class="block text-sm font-medium text-gray-700">Course Name</label>
          <input type="text" id="gCourseName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="gCourseUnit" class="block text-sm font-medium text-gray-700">Course Unit</label>
          <input type="number" step="0.5" id="gCourseUnit" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="gGrade" class="block text-sm font-medium text-gray-700">Grade</label>
          <input type="text" id="gGrade" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="gSemester" class="block text-sm font-medium text-gray-700">Semester</label>
          <input type="text" id="gSemester" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="gYear" class="block text-sm font-medium text-gray-700">Year</label>
          <input type="number" id="gYear" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('gradeModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Grade</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Grade Delete Confirmation Modal -->
  <div id="confirmDeleteModal-grade" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Grade?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the grade entry.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-grade').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-grade" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Fee Add/Edit Modal -->
  <div id="feeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="feeModalTitle" class="text-xl font-semibold">Add Fee Entry</h3>
        <button onclick="document.getElementById('feeModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="feeForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="feeId" />
        <div>
          <label for="fDate" class="block text-sm font-medium text-gray-700">Date</label>
          <input type="date" id="fDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2">
          <label for="fDescription" class="block text-sm font-medium text-gray-700">Description</label>
          <input type="text" id="fDescription" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="fDebit" class="block text-sm font-medium text-gray-700">Debit (KES)</label>
          <input type="number" step="0.01" id="fDebit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" value="0" />
        </div>
        <div>
          <label for="fCredit" class="block text-sm font-medium text-gray-700">Credit (KES)</label>
          <input type="number" step="0.01" id="fCredit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" value="0" />
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('feeModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Entry</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Fee Delete Confirmation Modal -->
  <div id="confirmDeleteModal-fee" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Fee Entry?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the fee entry.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-fee').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-fee" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Registration Add/Edit Modal -->
  <div id="regModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="regModalTitle" class="text-xl font-semibold">Add Registration</h3>
        <button onclick="document.getElementById('regModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="regForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="regId" />
        <div>
          <label for="rCourseCode" class="block text-sm font-medium text-gray-700">Course Code</label>
          <input type="text" id="rCourseCode" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="rCourseName" class="block text-sm font-medium text-gray-700">Course Name</label>
          <input type="text" id="rCourseName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="rDepartment" class="block text-sm font-medium text-gray-700">Department</label>
          <input type="text" id="rDepartment" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="rYear" class="block text-sm font-medium text-gray-700">Year of Study</label>
          <input type="number" id="rYear" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="rSemester" class="block text-sm font-medium text-gray-700">Semester</label>
          <input type="number" id="rSemester" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="rStatus" class="block text-sm font-medium text-gray-700">Status</label>
          <select id="rStatus" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2">
            <option value="Registered">Registered</option>
            <option value="Dropped">Dropped</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('regModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Registration</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Registration Delete Confirmation Modal -->
  <div id="confirmDeleteModal-reg" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Registration?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the course registration.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-reg').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-reg" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Course Add/Edit Modal -->
  <div id="courseModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="courseModalTitle" class="text-xl font-semibold">Add Course</h3>
        <button onclick="document.getElementById('courseModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="courseForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="courseId" />
        <div>
          <label for="cCourseCode" class="block text-sm font-medium text-gray-700">Course Code</label>
          <input type="text" id="cCourseCode" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cCourseName" class="block text-sm font-medium text-gray-700">Course Name</label>
          <input type="text" id="cCourseName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cDepartment" class="block text-sm font-medium text-gray-700">Department</label>
          <input type="text" id="cDepartment" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cYear" class="block text-sm font-medium text-gray-700">Year of Study</label>
          <input type="number" id="cYear" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cSemester" class="block text-sm font-medium text-gray-700">Semester</label>
          <input type="number" id="cSemester" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cCourseUnit" class="block text-sm font-medium text-gray-700">Course Unit</label>
          <input type="number" step="0.5" id="cCourseUnit" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('courseModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Course</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Course Delete Confirmation Modal -->
  <div id="confirmDeleteModal-course" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Course?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the course.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-course').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-course" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Timetable Add/Edit Modal -->
  <div id="timetableModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="timetableModalTitle" class="text-xl font-semibold">Add Timetable Entry</h3>
        <button onclick="document.getElementById('timetableModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="timetableForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="timetableId" />
        <div>
          <label for="tDepartment" class="block text-sm font-medium text-gray-700">Department</label>
          <input type="text" id="tDepartment" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="tYear" class="block text-sm font-medium text-gray-700">Year of Study</label>
          <input type="number" id="tYear" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="tSemester" class="block text-sm font-medium text-gray-700">Semester</label>
          <input type="number" id="tSemester" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="tDay" class="block text-sm font-medium text-gray-700">Day</label>
          <select id="tDay" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2">
            <option value="">Select Day</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
        </div>
        <div>
          <label for="tStartTime" class="block text-sm font-medium text-gray-700">Start Time</label>
          <input type="time" id="tStartTime" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="tEndTime" class="block text-sm font-medium text-gray-700">End Time</label>
          <input type="time" id="tEndTime" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="tVenue" class="block text-sm font-medium text-gray-700">Venue</label>
          <input type="text" id="tVenue" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="tCourseCode" class="block text-sm font-medium text-gray-700">Course Code</label>
          <input type="text" id="tCourseCode" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('timetableModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Entry</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Timetable Delete Confirmation Modal -->
  <div id="confirmDeleteModal-timetable" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Timetable Entry?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the timetable entry.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-timetable').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-timetable" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Hostel Add/Edit Modal -->
  <div id="hostelModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="hostelModalTitle" class="text-xl font-semibold">Add Hostel</h3>
        <button onclick="document.getElementById('hostelModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="hostelForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="hostelId" />
        <div>
          <label for="hName" class="block text-sm font-medium text-gray-700">Hostel Name</label>
          <input type="text" id="hName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="hCapacity" class="block text-sm font-medium text-gray-700">Capacity</label>
          <input type="number" id="hCapacity" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="hPrice" class="block text-sm font-medium text-gray-700">Price (KES)</label>
          <input type="number" step="0.01" id="hPrice" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="hStatus" class="block text-sm font-medium text-gray-700">Status</label>
          <select id="hStatus" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2">
            <option value="Available">Available</option>
            <option value="Full">Full</option>
            <option value="Under Maintenance">Under Maintenance</option>
          </select>
        </div>
        <div class="col-span-2">
          <label for="hOccupancy" class="block text-sm font-medium text-gray-700">Current Occupancy</label>
          <input type="number" id="hOccupancy" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2" value="0" />
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('hostelModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Hostel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Hostel Delete Confirmation Modal -->
  <div id="confirmDeleteModal-hostel" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Hostel?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the hostel entry.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-hostel').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-hostel" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Graduation Request Add/Edit Modal -->
  <div id="gradReqModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="gradReqModalTitle" class="text-xl font-semibold">Graduation Request</h3>
        <button onclick="document.getElementById('gradReqModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="gradReqForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="gradReqId" />
        <div class="col-span-2">
          <label for="grName" class="block text-sm font-medium text-gray-700">Student Name</label>
          <input type="text" id="grName" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="grRegNo" class="block text-sm font-medium text-gray-700">Reg. No</label>
          <input type="text" id="grRegNo" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="grProgramme" class="block text-sm font-medium text-gray-700">Programme</label>
          <input type="text" id="grProgramme" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="grDepartment" class="block text-sm font-medium text-gray-700">Department</label>
          <input type="text" id="grDepartment" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="grYear" class="block text-sm font-medium text-gray-700">Year of Study</label>
          <input type="number" id="grYear" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="grGpa" class="block text-sm font-medium text-gray-700">GPA</label>
          <input type="number" step="0.01" id="grGpa" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2">
          <label for="grStatus" class="block text-sm font-medium text-gray-700">Status</label>
          <select id="grStatus" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2">
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
        <div class="col-span-2">
          <label for="grRemarks" class="block text-sm font-medium text-gray-700">Remarks (Optional)</label>
          <textarea id="grRemarks" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2"></textarea>
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('gradReqModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" id="gradReqSaveBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Graduation Request Delete Confirmation Modal -->
  <div id="confirmDeleteModal-gradReq" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Graduation Request?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the graduation request.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-gradReq').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-gradReq" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Clearance Request Add/Edit Modal -->
  <div id="clearReqModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 m-4">
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 id="clearReqModalTitle" class="text-xl font-semibold">Clearance Request</h3>
        <button onclick="document.getElementById('clearReqModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa fa-times"></i></button>
      </div>
      <form id="clearReqForm" class="mt-4 grid grid-cols-2 gap-4">
        <input type="hidden" id="clearReqId" />
        <div class="col-span-2">
          <label for="cName" class="block text-sm font-medium text-gray-700">Student Name</label>
          <input type="text" id="cName" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cRegNo" class="block text-sm font-medium text-gray-700">Reg. No</label>
          <input type="text" id="cRegNo" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cProgramme" class="block text-sm font-medium text-gray-700">Programme</label>
          <input type="text" id="cProgramme" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div>
          <label for="cDepartment" class="block text-sm font-medium text-gray-700">Department</label>
          <input type="text" id="cDepartment" readonly class="mt-1 block w-full border border-gray-300 bg-gray-50 rounded-md shadow-sm px-3 py-2" />
        </div>
        <div class="col-span-2">
          <label for="cStatus" class="block text-sm font-medium text-gray-700">Overall Status</label>
          <select id="cStatus" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2">
            <option value="Pending">Pending</option>
            <option value="Cleared">Cleared</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
        <div id="clearanceSectionsContainer" class="col-span-2 grid grid-cols-2 gap-4">
          <!-- Clearance sections will be dynamically loaded here -->
        </div>
        <div class="col-span-2">
          <label for="cRemarks" class="block text-sm font-medium text-gray-700">Remarks (Optional)</label>
          <textarea id="cRemarks" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2"></textarea>
        </div>
        <div class="col-span-2 flex justify-end gap-2 mt-4">
          <button type="button" onclick="document.getElementById('clearReqModal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
          <button type="submit" id="clearReqSaveBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Clearance Request Delete Confirmation Modal -->
  <div id="confirmDeleteModal-clearReq" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 m-4">
      <div class="text-center">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Delete Clearance Request?</h3>
        <p class="text-sm text-gray-600">This will permanently remove the clearance request.</p>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('confirmDeleteModal-clearReq').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button type="button" id="confirmDeleteBtn-clearReq" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

</body>
</html>
