<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard | Prince Alex Design University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f7f6; }
        .btn-primary { background: #0d6efd; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
        .btn-primary:hover { background: #0b5ed7; }
        .btn-red { background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
        .btn-red:hover { background: #bb2d3b; }
        .btn-green { background: #28a745; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
        .btn-green:hover { background: #218838; }
        
        #sidebar a { padding: 0.75rem; border-radius: 4px; display: block; margin-bottom: 0.5rem; transition: background-color 0.2s; }
        #sidebar a:hover { background-color: #e2e8f0; }
        #sidebar a.active { background-color: #d1e7ff; color: #0d6efd; font-weight: 600; }

        .admin-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .section-title { font-size: 1.75rem; font-weight: bold; color: #1a202c; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.75rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #e2e8f0; padding: 0.75rem; text-align: left; }
        th { background-color: #f1f5f9; font-weight: 600; color: #334155; }
        tr:nth-child(even) { background-color: #f8fafc; }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #334155; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-badge.pending { background-color: #fefcbf; color: #8a6d3b; }
        .status-badge.approved { background-color: #d1fae5; color: #065f46; }
        .status-badge.rejected { background-color: #fee2e2; color: #991b1b; }
        .status-badge.active { background-color: #d1fae5; color: #065f46; } /* Hostel status */
        .status-badge.full { background-color: #fee2e2; color: #991b1b; } /* Hostel status */
        .status-badge.available { background-color: #d1fae5; color: #065f46; } /* Hostel status */
        .status-badge.cleared { background-color: #d1fae5; color: #065f46; } /* Finance status */
        .status-badge.inactive { background-color: #e0e0e0; color: #757575; } /* Student status */

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #0d6efd; /* Theme blue spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 10px;
            font-weight: 500;
            color: #0d6efd;
        }
        /* Custom Alert/Confirm Modal Styles */
        .custom-alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than other modals */
        }
        .custom-alert-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .custom-alert-content p {
            margin-bottom: 0; /* Remove default paragraph margin */
            font-size: 1.1em;
            color: #1a1a1a; /* Default text color */
        }
        .custom-alert-content button {
            background-color: #0d6efd; /* Primary blue for OK button */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color .3s ease;
        }
        .custom-alert-content button:hover {
            background-color: #0a58ca;
        }
        /* Specific styles for alert types */
        .custom-alert-content.error {
            background-color: #dc3545; /* Red for error */
            color: white;
        }
        .custom-alert-content.success {
            background-color: #28a745; /* Green for success */
            color: white;
        }
        .custom-alert-content.info {
            background-color: #002d6b; /* Dark Blue for info */
            color: white;
        }
        .admin-stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease-in-out;
            min-height: 150px;
            justify-content: center;
        }
        .admin-stat-card:hover {
            transform: translateY(-5px);
        }
        .admin-stat-card .icon {
            font-size: 2.5rem;
            color: #0d6efd;
            margin-bottom: 0.5rem;
        }
        .admin-stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1a1a1a;
        }
        .admin-stat-card .label {
            font-size: 0.9rem;
            color: #555;
            margin-top: 0.2rem;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text">Loading admin dashboard...</div>
    </div>

    <!-- Header -->
    <header class="p-4 flex justify-between items-center shadow-md bg-white sticky top-0 z-50">
        <img src="myschoollogo.png" alt="Logo" class="h-12">
        <div class="flex items-center space-x-4">
            <span id="adminEmail" class="text-blue-600 font-bold"></span>
            <button id="logoutBtn" class="btn-red"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </header>

    <div class="flex flex-grow">
        <!-- Sidebar -->
        <nav id="sidebar" class="w-64 bg-white border-r p-4 hidden md:block overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-blue-800">Admin Menu</h3>
            <a href="#" class="active" onclick="showSection('adminDashboard')"><i class="fas fa-chart-line mr-2"></i> Dashboard</a>
            <a href="#" onclick="showSection('createStudent')"><i class="fas fa-user-plus mr-2"></i> Create Student</a>
            <a href="#" onclick="showSection('manageStudents')"><i class="fas fa-users mr-2"></i> Students</a>
            <a href="#" onclick="showSection('manageCourses')"><i class="fas fa-book-open mr-2"></i> Courses</a>
            <a href="#" onclick="showSection('manageTimetable')"><i class="fas fa-calendar-alt mr-2"></i> Timetable</a>
            <a href="#" onclick="showSection('manageGrades')"><i class="fas fa-award mr-2"></i> Grades</a>
            <a href="#" onclick="showSection('manageExamSchedule')"><i class="fas fa-clipboard-list mr-2"></i> Exam Cards</a>
            <a href="#" onclick="showSection('manageAnnouncements')"><i class="fas fa-bullhorn mr-2"></i> Announcements</a>
            <a href="#" onclick="showSection('manageHostels')"><i class="fas fa-hotel mr-2"></i> Hostels</a>
            <a href="#" onclick="showSection('manageGraduation')"><i class="fas fa-graduation-cap mr-2"></i> Graduation Requests</a>
            <a href="#" onclick="showSection('manageClearance')"><i class="fas fa-check-double mr-2"></i> Clearance Requests</a>
            <a href="#" onclick="showSection('manageFinance')"><i class="fas fa-wallet mr-2"></i> Finance</a>
            <a href="#" onclick="showSection('manageAdmins')"><i class="fas fa-user-shield mr-2"></i> Admins & Roles</a>
        </nav>

        <!-- Main Content -->
        <main id="adminMainContent" class="flex-grow p-6 overflow-y-auto">

            <!-- Admin Dashboard Overview -->
            <div id="adminDashboard" class="admin-card">
                <h2 class="section-title">Admin Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="admin-stat-card">
                        <i class="fas fa-users icon"></i>
                        <div id="totalStudents" class="value">0</div>
                        <div class="label">Total Students</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-book-open icon"></i>
                        <div id="totalCourses" class="value">0</div>
                        <div class="label">Active Courses</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-money-bill-wave icon"></i>
                        <div id="totalOutstandingFees" class="value">KES 0</div>
                        <div class="label">Total Outstanding Fees</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-hourglass-half icon"></i>
                        <div id="pendingGraduations" class="value">0</div>
                        <div class="label">Pending Grad Requests</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-clipboard-check icon"></i>
                        <div id="pendingClearances" class="value">0</div>
                        <div class="label">Pending Clearance</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-hotel icon"></i>
                        <div id="availableHostelRooms" class="value">0</div>
                        <div class="label">Available Hostel Rooms</div>
                    </div>
                </div>
            </div>

            <!-- Create Student Section -->
            <div id="createStudent" class="admin-card hidden">
                <h2 class="section-title">Create New Student Account</h2>
                <form id="createStudentForm" class="space-y-4">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newStudentName">Full Name</label>
                            <input type="text" id="newStudentName" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentEmail">Email</label>
                            <input type="email" id="newStudentEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentAdmissionNo">Admission Number</label>
                            <input type="text" id="newStudentAdmissionNo" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentPassword">Password</label>
                            <input type="password" id="newStudentPassword" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Create Student Account</button>
                </form>
            </div>

            <!-- Manage Students Section -->
            <div id="manageStudents" class="admin-card hidden">
                <h2 class="section-title">Manage Students</h2>
                <div class="mb-4 flex flex-col sm:flex-row gap-2 items-center">
                    <input type="text" id="studentSearchInput" placeholder="Search by name, email, or admission no." class="p-2 border rounded-md flex-grow">
                    <button onclick="searchStudents()" class="btn-primary">Search</button>
                    <button onclick="loadStudents()" class="btn-primary">Clear Search</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Admission No</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Program</th>
                                <th>Year/Sem</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading students...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Student Detail Modal -->
                <div id="studentDetailModal" class="custom-alert-modal hidden">
                    <div class="custom-alert-content" style="max-width: 700px; text-align: left; background: white; color: #1a1a1a;">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">Student Details</h3>
                        <form id="editStudentForm" class="space-y-4">
                            <input type="hidden" id="editStudentUid">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editAdmissionNo">Admission No</label>
                                    <input type="text" id="editAdmissionNo" required>
                                </div>
                                <div class="form-group">
                                    <label for="editName">Full Name</label>
                                    <input type="text" id="editName" required>
                                </div>
                                <div class="form-group">
                                    <label for="editEmail">Email</label>
                                    <input type="email" id="editEmail" readonly class="bg-gray-100">
                                </div>
                                <div class="form-group">
                                    <label for="editPhone">Phone Number</label>
                                    <input type="text" id="editPhone">
                                </div>
                                <div class="form-group">
                                    <label for="editDob">Date of Birth</label>
                                    <input type="date" id="editDob">
                                </div>
                                <div class="form-group">
                                    <label for="editGender">Gender</label>
                                    <select id="editGender">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editAddress">Address</label>
                                    <textarea id="editAddress" rows="2"></textarea>
                                </div>
                                <!-- Guardian Info -->
                                <div class="col-span-full">
                                    <h4 class="text-lg font-semibold text-blue-600 mt-4 mb-2">Guardian Information</h4>
                                </div>
                                <div class="form-group">
                                    <label for="editGuardianName">Guardian Name</label>
                                    <input type="text" id="editGuardianName">
                                </div>
                                <div class="form-group">
                                    <label for="editGuardianPhone">Guardian Phone</label>
                                    <input type="text" id="editGuardianPhone">
                                </div>
                                <div class="form-group">
                                    <label for="editGuardianRelation">Relationship</label>
                                    <input type="text" id="editGuardianRelation">
                                </div>
                                <!-- Academic Info -->
                                <div class="col-span-full">
                                    <h4 class="text-lg font-semibold text-blue-600 mt-4 mb-2">Academic Information</h4>
                                </div>
                                <div class="form-group">
                                    <label for="editProgram">Program</label>
                                    <input type="text" id="editProgram">
                                </div>
                                <div class="form-group">
                                    <label for="editYear">Year</label>
                                    <select id="editYear">
                                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editSemester">Semester</label>
                                    <select id="editSemester">
                                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editEnrollmentDate">Enrollment Date</label>
                                    <input type="text" id="editEnrollmentDate" readonly class="bg-gray-100">
                                </div>
                                <div class="form-group flex items-center gap-2 mt-4 col-span-full">
                                    <input type="checkbox" id="editIsActive" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="editIsActive" class="mb-0">Account Active</label>
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeModal('studentDetailModal')" class="btn-red">Cancel</button>
                                <button type="submit" class="btn-primary">Save Changes</button>
                            </div>
                        </form>
                        <div class="flex justify-start gap-2 mt-4 pt-4 border-t border-gray-200">
                            <button onclick="resetStudentPassword(document.getElementById('editStudentUid').value, document.getElementById('editEmail').value)" class="btn-primary"><i class="fas fa-redo mr-2"></i> Reset Password</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Courses Section -->
            <div id="manageCourses" class="admin-card hidden">
                <h2 class="section-title">Manage Courses</h2>
                <form id="courseForm" class="space-y-4 mb-6">
                    <input type="hidden" id="courseId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="courseCode">Course Code</label>
                            <input type="text" id="courseCode" required>
                        </div>
                        <div class="form-group">
                            <label for="courseTitle">Course Title</label>
                            <input type="text" id="courseTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="courseCredits">Credits</label>
                            <input type="number" id="courseCredits" required>
                        </div>
                        <div class="form-group">
                            <label for="courseLecturer">Lecturer</label>
                            <input type="text" id="courseLecturer" required>
                        </div>
                        <div class="form-group">
                            <label for="courseYear">Year</label>
                            <select id="courseYear" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="courseSemester">Semester</label>
                            <select id="courseSemester" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveCourseBtn">Add Course</button>
                    <button type="button" class="btn-red hidden" id="cancelEditCourseBtn" onclick="resetCourseForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="coursesTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Title</th>
                                <th>Credits</th>
                                <th>Lecturer</th>
                                <th>Year</th>
                                <th>Semester</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading courses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Timetable Section -->
            <div id="manageTimetable" class="admin-card hidden">
                <h2 class="section-title">Manage Timetable</h2>
                <form id="timetableForm" class="space-y-4 mb-6">
                    <input type="hidden" id="timetableId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="timetableCourseCode">Course Code</label>
                            <input type="text" id="timetableCourseCode" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableDay">Day</label>
                            <select id="timetableDay" required>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timetableStartTime">Start Time</label>
                            <input type="time" id="timetableStartTime" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableEndTime">End Time</label>
                            <input type="time" id="timetableEndTime" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableVenue">Venue</label>
                            <input type="text" id="timetableVenue" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableLecturer">Lecturer</label>
                            <input type="text" id="timetableLecturer" required>
                        </div>
                        <div class="form-group">
                            <label for="timetableYear">Year</label>
                            <select id="timetableYear" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timetableSemester">Semester</label>
                            <select id="timetableSemester" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveTimetableBtn">Add Timetable Entry</button>
                    <button type="button" class="btn-red hidden" id="cancelEditTimetableBtn" onclick="resetTimetableForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="timetableTable">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Venue</th>
                                <th>Lecturer</th>
                                <th>Year/Sem</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading timetable entries...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Grades Section -->
            <div id="manageGrades" class="admin-card hidden">
                <h2 class="section-title">Manage Grades</h2>
                <div class="mb-4 form-grid">
                    <div class="form-group">
                        <label for="gradeStudentId">Student (UID)</label>
                        <input type="text" id="gradeStudentId" placeholder="Enter Student UID" list="studentUids">
                        <datalist id="studentUids"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="gradeYear">Year</label>
                        <select id="gradeYear">
                            <option value="">Select Year</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gradeSemester">Semester</label>
                        <select id="gradeSemester">
                            <option value="">Select Semester</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        </select>
                    </div>
                </div>
                <button onclick="loadStudentGrades()" class="btn-primary mb-6">Load Student Grades</button>

                <form id="gradeEntryForm" class="space-y-4 mb-6 hidden">
                    <input type="hidden" id="gradeEntryId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="gradeCourseCode">Course Code</label>
                            <input type="text" id="gradeCourseCode" placeholder="Enter Course Code" list="courseCodes" required>
                            <datalist id="courseCodes"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="gradeCourseTitle">Course Title</label>
                            <input type="text" id="gradeCourseTitle" readonly class="bg-gray-100">
                        </div>
                        <div class="form-group">
                            <label for="gradeCredits">Credits</label>
                            <input type="number" id="gradeCredits" readonly class="bg-gray-100">
                        </div>
                        <div class="form-group">
                            <label for="gradeGrade">Grade (A-F)</label>
                            <input type="text" id="gradeGrade" pattern="[A-Fa-f]" maxlength="1" required>
                        </div>
                        <div class="form-group">
                            <label for="gradePoints">GPA Points</label>
                            <input type="number" id="gradePoints" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="gradeLecturer">Lecturer</label>
                            <input type="text" id="gradeLecturer" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveGradeBtn">Save Grade</button>
                    <button type="button" class="btn-red hidden" id="cancelEditGradeBtn" onclick="resetGradeForm()">Cancel Edit</button>
                </form>

                <h3 class="text-xl font-bold text-blue-700 mt-8 mb-4">Grades for Selected Student/Semester</h3>
                <div class="overflow-x-auto">
                    <table id="gradesTable">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Title</th>
                                <th>Credits</th>
                                <th>Grade</th>
                                <th>GPA Points</th>
                                <th>Lecturer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">No grades loaded. Select student, year, and semester.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Exam Schedule Section -->
            <div id="manageExamSchedule" class="admin-card hidden">
                <h2 class="section-title">Manage Exam Schedule</h2>
                <form id="examScheduleForm" class="space-y-4 mb-6">
                    <input type="hidden" id="examScheduleId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="examScheduleCourseCode">Course Code</label>
                            <input type="text" id="examScheduleCourseCode" required list="courseCodesExam">
                            <datalist id="courseCodesExam"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleDate">Exam Date</label>
                            <input type="date" id="examScheduleDate" required>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleTime">Exam Time</label>
                            <input type="time" id="examScheduleTime" required>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleVenue">Venue</label>
                            <input type="text" id="examScheduleVenue" required>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleLecturer">Lecturer</label>
                            <input type="text" id="examScheduleLecturer">
                        </div>
                        <div class="form-group">
                            <label for="examScheduleYear">Year</label>
                            <select id="examScheduleYear" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="examScheduleSemester">Semester</label>
                            <select id="examScheduleSemester" required>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveExamScheduleBtn">Add Exam Schedule</button>
                    <button type="button" class="btn-red hidden" id="cancelEditExamScheduleBtn" onclick="resetExamScheduleForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="examScheduleTable">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Venue</th>
                                <th>Lecturer</th>
                                <th>Year/Sem</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="text-center text-gray-500 p-4">Loading exam schedules...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Announcements Section -->
            <div id="manageAnnouncements" class="admin-card hidden">
                <h2 class="section-title">Manage Announcements</h2>
                <form id="announcementForm" class="space-y-4 mb-6">
                    <input type="hidden" id="announcementId">
                    <div class="form-group">
                        <label for="announcementTitle">Title</label>
                        <input type="text" id="announcementTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="announcementMessage">Message</label>
                        <textarea id="announcementMessage" rows="5" required></textarea>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="announcementAuthor">Author</label>
                            <input type="text" id="announcementAuthor" required>
                        </div>
                        <div class="form-group">
                            <label for="announcementCategory">Category</label>
                            <select id="announcementCategory" required>
                                <option value="General">General</option>
                                <option value="Academics">Academics</option>
                                <option value="Finance">Finance</option>
                                <option value="Hostel">Hostel</option>
                                <option value="Events">Events</option>
                            </select>
                        </div>
                        <div class="form-group flex items-center gap-2">
                            <input type="checkbox" id="announcementPinned" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="announcementPinned" class="mb-0">Pin to Top</label>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveAnnouncementBtn">Publish Announcement</button>
                    <button type="button" class="btn-red hidden" id="cancelEditAnnouncementBtn" onclick="resetAnnouncementForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="announcementsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Author</th>
                                <th>Date</th>
                                <th>Pinned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" class="text-center text-gray-500 p-4">Loading announcements...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Hostels Section -->
            <div id="manageHostels" class="admin-card hidden">
                <h2 class="section-title">Manage Hostels</h2>
                <form id="hostelForm" class="space-y-4 mb-6">
                    <input type="hidden" id="hostelId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="hostelName">Hostel Name</label>
                            <input type="text" id="hostelName" required>
                        </div>
                        <div class="form-group">
                            <label for="hostelType">Type (e.g., Male, Female)</label>
                            <input type="text" id="hostelType" required>
                        </div>
                        <div class="form-group">
                            <label for="hostelCapacity">Total Capacity</label>
                            <input type="number" id="hostelCapacity" required>
                        </div>
                        <div class="form-group">
                            <label for="hostelLocation">Location</label>
                            <input type="text" id="hostelLocation">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveHostelBtn">Add Hostel</button>
                    <button type="button" class="btn-red hidden" id="cancelEditHostelBtn" onclick="resetHostelForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="hostelsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Capacity</th>
                                <th>Location</th>
                                <th>Available Rooms</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" class="text-center text-gray-500 p-4">Loading hostels...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Rooms Management Area -->
                <div id="roomsManagementArea" class="mt-8 pt-6 border-t border-gray-200 hidden">
                    <h3 class="text-xl font-bold text-blue-700 mb-4" id="roomsOfHostelTitle">Rooms in [Hostel Name]</h3>
                    <button type="button" class="btn-primary mb-4" onclick="showHostelsList()"><i class="fas fa-arrow-left mr-2"></i> Back to Hostels</button>

                    <form id="roomForm" class="space-y-4 mb-6">
                        <input type="hidden" id="roomHostelId">
                        <input type="hidden" id="roomId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="roomNo">Room Number</label>
                                <input type="text" id="roomNo" required>
                            </div>
                            <div class="form-group">
                                <label for="roomCapacity">Capacity (beds)</label>
                                <input type="number" id="roomCapacity" required>
                            </div>
                            <div class="form-group">
                                <label for="availableSlots">Available Slots</label>
                                <input type="number" id="availableSlots" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" id="saveRoomBtn">Add Room</button>
                        <button type="button" class="btn-red hidden" id="cancelEditRoomBtn" onclick="resetRoomForm()">Cancel Edit</button>
                    </form>

                    <div class="overflow-x-auto">
                        <table id="roomsTable">
                            <thead>
                                <tr>
                                    <th>Room No</th>
                                    <th>Capacity</th>
                                    <th>Available Slots</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="text-center text-gray-500 p-4">Loading rooms...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Manage Graduation Requests Section -->
            <div id="manageGraduation" class="admin-card hidden">
                <h2 class="section-title">Manage Graduation Requests</h2>
                <div class="overflow-x-auto">
                    <table id="graduationRequestsTable">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Admission No</th>
                                <th>Program</th>
                                <th>Date Submitted</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" class="text-center text-gray-500 p-4">Loading graduation requests...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Graduation Request Detail Modal -->
                <div id="graduationDetailModal" class="custom-alert-modal hidden">
                    <div class="custom-alert-content" style="max-width: 700px; text-align: left; background: white; color: #1a1a1a;">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">Graduation Request Details</h3>
                        <p><strong>Student Name:</strong> <span id="gradModalStudentName"></span></p>
                        <p><strong>Admission No:</strong> <span id="gradModalAdmNo"></span></p>
                        <p><strong>Program:</strong> <span id="gradModalProgram"></span></p>
                        <p><strong>Date Submitted:</strong> <span id="gradModalDateSubmitted"></span></p>
                        <p class="mb-4"><strong>Current Status:</strong> <span id="gradModalCurrentStatus" class="status-badge"></span></p>
                        
                        <h4 class="font-bold text-blue-600 mt-4 mb-2">Uploaded Documents:</h4>
                        <ul id="gradModalDocuments" class="list-disc ml-5 mb-4">
                            <!-- Docs loaded here -->
                        </ul>

                        <form id="updateGradStatusForm" class="space-y-4">
                            <input type="hidden" id="gradModalUid">
                            <div class="form-group">
                                <label for="gradModalStatus">Update Status</label>
                                <select id="gradModalStatus" required>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gradModalComments">Admin Comments</label>
                                <textarea id="gradModalComments" rows="3"></textarea>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeModal('graduationDetailModal')" class="btn-red">Cancel</button>
                                <button type="submit" class="btn-primary">Update Status</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Manage Clearance Requests Section -->
            <div id="manageClearance" class="admin-card hidden">
                <h2 class="section-title">Manage Clearance Requests</h2>
                <div class="overflow-x-auto">
                    <table id="clearanceRequestsTable">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Admission No</th>
                                <th>Date Submitted</th>
                                <th>Overall Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center text-gray-500 p-4">Loading clearance requests...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Clearance Request Detail Modal -->
                <div id="clearanceDetailModal" class="custom-alert-modal hidden">
                    <div class="custom-alert-content" style="max-width: 800px; text-align: left; background: white; color: #1a1a1a;">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">Clearance Request Details</h3>
                        <p><strong>Student Name:</strong> <span id="clearanceModalStudentName"></span></p>
                        <p><strong>Admission No:</strong> <span id="clearanceModalAdmNo"></span></p>
                        <p class="mb-4"><strong>Date Submitted:</strong> <span id="clearanceModalDateSubmitted"></span></p>
                        <p class="mb-4"><strong>Overall Status:</strong> <span id="clearanceModalOverallStatus" class="status-badge"></span></p>

                        <h4 class="font-bold text-blue-600 mt-4 mb-2">Departmental Approvals:</h4>
                        <form id="updateClearanceStatusForm" class="space-y-4">
                            <input type="hidden" id="clearanceModalUid">
                            <div id="departmentApprovalForms" class="space-y-3">
                                <!-- Department forms loaded here -->
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeModal('clearanceDetailModal')" class="btn-red">Cancel</button>
                                <button type="submit" class="btn-primary">Update Approvals</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Manage Finance Section -->
            <div id="manageFinance" class="admin-card hidden">
                <h2 class="section-title">Manage Finance</h2>
                <div class="mb-4 form-grid">
                    <div class="form-group">
                        <label for="financeStudentId">Student (UID)</label>
                        <input type="text" id="financeStudentId" placeholder="Enter Student UID" list="financeStudentUids">
                        <datalist id="financeStudentUids"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="financeAction">Action</label>
                        <select id="financeAction" onchange="toggleFinanceActionFields()">
                            <option value="view">View Statement</option>
                            <option value="addFees">Add Fees</option>
                            <option value="recordPayment">Record Payment</option>
                            <option value="adjustBalance">Adjust Balance</option>
                        </select>
                    </div>
                </div>
                <button onclick="performFinanceAction()" class="btn-primary mb-6">Execute Action</button>

                <div id="financeActionFields" class="space-y-4 mb-6 border p-4 rounded-md hidden">
                    <h3 class="text-lg font-bold text-blue-700">Action Details</h3>
                    <form id="financeForm">
                        <input type="hidden" id="financeFormUid">
                        <div class="form-group">
                            <label for="financeAmount">Amount (KES)</label>
                            <input type="number" id="financeAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="financeDescription">Description</label>
                            <textarea id="financeDescription" rows="2" required></textarea>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button type="submit" class="btn-primary" id="submitFinanceAction">Submit</button>
                        </div>
                    </form>
                </div>

                <h3 class="text-xl font-bold text-blue-700 mt-8 mb-4">Student Finance Statement</h3>
                <div id="financeSummaryOverview" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="admin-stat-card">
                        <i class="fas fa-file-invoice icon"></i>
                        <div id="financeTotalFees" class="value">KES 0</div>
                        <div class="label">Total Fees Charged</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-money-check-alt icon"></i>
                        <div id="financeTotalPaid" class="value">KES 0</div>
                        <div class="label">Total Payments Made</div>
                    </div>
                    <div class="admin-stat-card">
                        <i class="fas fa-money-bill-alt icon"></i>
                        <div id="financeBalance" class="value">KES 0</div>
                        <div class="label">Outstanding Balance</div>
                    </div>
                </div>
                 <div id="financeStudentStatusMessage" class="finance-status-message mt-4">
                    Select a student to view finance status...
                </div>
                <div class="overflow-x-auto mt-6">
                    <table id="financeTransactionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Amount (KES)</th>
                                <th>Running Balance (KES)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center text-gray-500 p-4">Select a student to view transactions.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Admins & Roles Section -->
            <div id="manageAdmins" class="admin-card hidden">
                <h2 class="section-title">Manage Admins & Roles</h2>
                <form id="adminForm" class="space-y-4 mb-6">
                    <input type="hidden" id="editAdminUid">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="adminUserUid">User UID</label>
                            <input type="text" id="adminUserUid" placeholder="Enter Firebase User UID" required>
                        </div>
                        <div class="form-group">
                            <label for="adminRole">Role</label>
                            <select id="adminRole" required>
                                <option value="Superadmin">Superadmin</option>
                                <option value="Registrar">Registrar</option>
                                <option value="Finance Officer">Finance Officer</option>
                                <option value="Hostel Manager">Hostel Manager</option>
                                <option value="Academics Officer">Academics Officer</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="saveAdminBtn">Add Admin</button>
                    <button type="button" class="btn-red hidden" id="cancelEditAdminBtn" onclick="resetAdminForm()">Cancel Edit</button>
                </form>

                <div class="overflow-x-auto">
                    <table id="adminsTable">
                        <thead>
                            <tr>
                                <th>User UID</th>
                                <th>Email (from Auth)</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" class="text-center text-gray-500 p-4">Loading admins...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <footer class="bg-white p-4 text-center border-t text-sm">
        © 2025 Prince Alex Design University. Admin Panel. All rights reserved.
    </footer>

    <!-- Firebase & Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail, fetchSignInMethodsForEmail, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc, orderBy, limit, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Firebase Configuration (from dashboard.html)
        const firebaseConfig = {
            apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
            authDomain: "universityweb-19e1e.firebaseapp.com",
            projectId: "universityweb-19e1e",
            storageBucket: "universityweb-19e1e.appspot.com",
            messagingSenderId: "401942926589",
            appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const loadingOverlay = document.getElementById('loadingOverlay');

        const adminEmailSpan = document.getElementById("adminEmail");
        const adminMainContent = document.getElementById("adminMainContent");

        // Helper for displaying custom alerts (replaces native alert/prompt)
        function showCustomAlert(message, type = 'info', callback = null) {
            const modal = document.createElement('div');
            modal.classList.add('custom-alert-modal');
            let bgColor = '#0d6efd';
            if (type === 'error') { bgColor = '#dc3545'; }
            else if (type === 'success') { bgColor = '#28a745'; }

            modal.innerHTML = `
                <div class="custom-alert-content" style="background:${bgColor}; color:white;">
                    <p>${message}</p>
                    <button style="background-color:white; color:${bgColor};"
                            onclick="this.parentNode.parentNode.remove(); if(typeof window.alertCallback === 'function') window.alertCallback();">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
            window.alertCallback = callback;
        }

        // Custom Prompt function
        function showCustomPrompt(message, callback, inputType = 'text', placeholder = '', initialValue = '') {
            const modal = document.createElement('div');
            modal.classList.add('custom-alert-modal');
            modal.innerHTML = `
                <div class="custom-alert-content" style="background:white; color:#1a1a1a;">
                    <p>${message}</p>
                    <input type="${inputType}" id="promptInput" placeholder="${placeholder}" value="${initialValue}" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px;">
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button style="background-color:#0d6efd; color:white;" id="promptOk">OK</button>
                        <button style="background-color:#6c757d; color:white;" id="promptCancel">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const input = modal.querySelector('#promptInput');
            const okBtn = modal.querySelector('#promptOk');
            const cancelBtn = modal.querySelector('#promptCancel');

            okBtn.onclick = () => {
                modal.remove();
                callback(input.value);
            };
            cancelBtn.onclick = () => {
                modal.remove();
                callback(null);
            };
            input.focus();
        }

        // Custom Confirm function
        function showCustomConfirm(message, type = 'confirm', callback = null) {
            const modal = document.createElement('div');
            modal.classList.add('custom-alert-modal');
            let confirmColor = '#0d6efd';
            if (type === 'delete') confirmColor = '#dc3545';

            modal.innerHTML = `
                <div class="custom-alert-content" style="background:white; color:#1a1a1a;">
                    <p style="color:${confirmColor};">${message}</p>
                    <div style="display:flex; justify-content:center; gap:15px;">
                        <button style="background-color:${confirmColor}; color:white;" id="confirmYes">Yes</button>
                        <button style="background-color:#6c757d; color:white;" id="confirmNo">No</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#confirmYes').onclick = () => {
                modal.remove();
                if(callback) callback(true);
            };
            modal.querySelector('#confirmNo').onclick = () => {
                modal.remove();
                if(callback) callback(false);
            };
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Function to process Firebase error messages into user-friendly ones
        function getFriendlyErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                case 'auth/wrong-password':
                case 'auth/user-not-found':
                case 'auth/invalid-credential':
                    return 'Invalid email or password.';
                case 'auth/email-already-in-use':
                    return 'This email address is already in use.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/network-request-failed':
                    return 'Network error. Please check your connection.';
                case 'auth/requires-recent-login':
                    return 'This action requires recent authentication. Please log out and log in again, then try.';
                case 'auth/too-many-requests':
                    return 'Too many attempts. Please try again later.';
                case 'auth/operation-not-allowed':
                    return 'This operation is not allowed. Please contact support.';
                case 'auth/user-disabled':
                    return 'This user account has been disabled.';
                default:
                    return 'An unexpected error occurred. Please try again.';
            }
        }

        // --- Admin Authentication Check ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // If not logged in, redirect to login page (assuming login.html exists)
                window.location.href = "login.html";
            } else {
                loadingOverlay.classList.remove('hidden');
                try {
                    const adminDocRef = doc(db, "admins", user.uid);
                    const adminSnap = await getDoc(adminDocRef);

                    if (adminSnap.exists() && adminSnap.data().isAdmin) {
                        adminEmailSpan.textContent = user.email;
                        // Load initial dashboard data for admin
                        await loadAdminDashboardOverview();
                        showSection('adminDashboard'); // Show default admin dashboard section
                    } else {
                        // User is logged in but not an admin
                        showCustomAlert("Access Denied: You are not authorized to view this page.", 'error', () => {
                            signOut(auth); // Log out non-admin user
                            window.location.href = "login.html";
                        });
                    }
                } catch (error) {
                    console.error("Error during admin authentication:", error);
                    showCustomAlert("Authentication error. Please try again.", 'error', () => {
                        signOut(auth);
                        window.location.href = "login.html";
                    });
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }
        });

        // Logout
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            loadingOverlay.classList.remove('hidden');
            await signOut(auth);
            window.location.href = "login.html";
        });

        // --- Section Navigation ---
        window.showSection = async (id) => {
            document.querySelectorAll("#adminMainContent > div").forEach(div => div.classList.add("hidden"));
            document.getElementById(id).classList.remove("hidden");

            // Update active state in sidebar
            document.querySelectorAll("#sidebar a").forEach(link => link.classList.remove("active"));
            document.querySelector(`#sidebar a[onclick*="${id}"]`).classList.add("active");
            
            loadingOverlay.classList.remove('hidden');
            try {
                // Call specific load functions for each section
                if (id === 'adminDashboard') {
                    await loadAdminDashboardOverview();
                } else if (id === 'createStudent') {
                    document.getElementById('createStudentForm').reset(); // Clear form on navigation
                }
                else if (id === 'manageStudents') {
                    await loadStudents();
                } else if (id === 'manageCourses') {
                    await loadCourses();
                } else if (id === 'manageTimetable') {
                    await loadTimetableEntries();
                } else if (id === 'manageGrades') {
                    await loadAllStudentsAndCoursesForGrades(); // Pre-load datalists
                    document.getElementById('gradesTable').innerHTML = `<tbody><tr><td colspan="7" class="text-center text-gray-500 p-4">Select student, year, and semester to load grades.</td></tr></tbody>`;
                    document.getElementById('gradeEntryForm').classList.add('hidden'); // Hide grade entry form initially
                } else if (id === 'manageExamSchedule') {
                    await loadAllCoursesForExamSchedule(); // Pre-load datalist
                    await loadExamSchedules();
                } else if (id === 'manageAnnouncements') {
                    await loadAnnouncements();
                } else if (id === 'manageHostels') {
                    await loadHostels();
                    document.getElementById('roomsManagementArea').classList.add('hidden'); // Ensure rooms are hidden
                } else if (id === 'manageGraduation') {
                    await loadGraduationRequests();
                } else if (id === 'manageClearance') {
                    await loadClearanceRequests();
                } else if (id === 'manageFinance') {
                    await loadAllStudentsForFinance(); // Pre-load datalists
                    document.getElementById('financeTransactionsTable').innerHTML = `<tbody><tr><td colspan="5" class="text-center text-gray-500 p-4">Select a student to view transactions.</td></tr></tbody>`;
                    // Clear previous finance summary
                    document.getElementById('financeTotalFees').textContent = 'KES 0';
                    document.getElementById('financeTotalPaid').textContent = 'KES 0';
                    document.getElementById('financeBalance').textContent = 'KES 0';
                    document.getElementById('financeStudentStatusMessage').textContent = 'Select a student to view finance status...';
                    document.getElementById('financeStudentStatusMessage').className = 'finance-status-message mt-4'; // Reset classes
                    document.getElementById('financeActionFields').classList.add('hidden');
                } else if (id === 'manageAdmins') {
                    await loadAdmins();
                }
            } catch (error) {
                console.error(`Error loading section ${id}:`, error);
                showCustomAlert(`Failed to load data for ${id}. Please try again.`, 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        };

        // --- Admin Dashboard Overview Functions ---
        async function loadAdminDashboardOverview() {
            loadingOverlay.classList.remove('hidden');
            try {
                // Total Students
                const studentsSnap = await getDocs(collection(db, "students"));
                document.getElementById('totalStudents').textContent = studentsSnap.size;

                // Total Courses
                const coursesSnap = await getDocs(collection(db, "courses"));
                document.getElementById('totalCourses').textContent = coursesSnap.size;

                // Pending Graduation Requests
                const pendingGradsQuery = query(collection(db, "graduations"), where("status", "==", "Pending"));
                const pendingGradsSnap = await getDocs(pendingGradsQuery);
                document.getElementById('pendingGraduations').textContent = pendingGradsSnap.size;

                // Pending Clearance Requests
                const pendingClearancesQuery = query(collection(db, "clearances"), where("overallStatus", "==", "Pending"));
                const pendingClearancesSnap = await getDocs(pendingClearancesQuery);
                document.getElementById('pendingClearances').textContent = pendingClearancesSnap.size;

                // Total Outstanding Fees
                let totalOutstandingFees = 0;
                const financeBalancesSnap = await getDocs(collection(db, "finance"));
                financeBalancesSnap.forEach(docSnap => {
                    // Check if the document ID is not 'transactions' (which would be a subcollection name if accessed incorrectly as a document)
                    if (docSnap.id !== 'transactions') { 
                        const balanceData = docSnap.data();
                        // Assuming 'balance' document for each user directly stores 'amount' as the outstanding balance
                        // Or, we might need to query a subcollection for balance if structured differently.
                        // For now, assuming finance document ID is student UID and it has an 'amount' field.
                        totalOutstandingFees += (balanceData.amount || 0);
                    }
                });
                document.getElementById('totalOutstandingFees').textContent = `KES ${totalOutstandingFees.toLocaleString()}`;

                // Available Hostel Rooms
                let totalAvailableHostelRooms = 0;
                const hostelsSnap = await getDocs(collection(db, "hostels"));
                for (const docSnap of hostelsSnap.docs) {
                    const roomsSnap = await getDocs(collection(db, `hostels/${docSnap.id}/rooms`));
                    roomsSnap.forEach(roomDoc => {
                        totalAvailableHostelRooms += (roomDoc.data().availableSlots || 0);
                    });
                }
                document.getElementById('availableHostelRooms').textContent = totalAvailableHostelRooms;

            } catch (error) {
                console.error("Error loading admin dashboard overview:", error);
                showCustomAlert("Failed to load dashboard overview. Some data might be missing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // --- Create Student Functions ---
        document.getElementById('createStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            try {
                const name = document.getElementById('newStudentName').value.trim();
                const email = document.getElementById('newStudentEmail').value.trim();
                const admissionNo = document.getElementById('newStudentAdmissionNo').value.trim();
                const password = document.getElementById('newStudentPassword').value;

                if (!name || !email || !admissionNo || !password) {
                    showCustomAlert("Please fill in all fields.", 'error');
                    return;
                }

                // 1. Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. Save student details to Firestore 'students' collection
                await setDoc(doc(db, "students", user.uid), {
                    name: name,
                    email: email,
                    admissionNo: admissionNo,
                    createdAt: serverTimestamp(),
                    isActive: true, // New students are active by default
                    // Other fields like program, year, semester, phone, dob, etc. can be updated by student later
                });

                // 3. Initialize an empty finance record for the new student
                // The balance document will be created/updated with transactions later.
                // For now, ensure a base document exists for the student's finance.
                await setDoc(doc(db, "finance", user.uid), {
                    totalFees: 0,
                    totalPaid: 0,
                    amount: 0, // Outstanding balance
                });

                showCustomAlert(`Student ${name} created successfully! Admission No: ${admissionNo}`, 'success', () => {
                    document.getElementById('createStudentForm').reset();
                    showSection('manageStudents'); // Navigate to manage students to see the new entry
                });
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error creating student account:", error);
                showCustomAlert(getFriendlyErrorMessage(error.code), 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });


        // --- Manage Students Functions ---
        let allStudents = []; // Cache for student search

        async function loadStudents() {
            loadingOverlay.classList.remove('hidden');
            const studentsTableBody = document.querySelector('#studentsTable tbody');
            studentsTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading students...</td></tr>`;
            try {
                const studentsSnap = await getDocs(collection(db, "students"));
                allStudents = []; // Clear cache
                if (studentsSnap.empty) {
                    studentsTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">No students registered.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                studentsSnap.forEach(docSnap => {
                    const student = docSnap.data();
                    allStudents.push({ uid: docSnap.id, ...student }); // Add to cache
                    const yearSem = (student.year && student.semester) ? `Y${student.year} S${student.semester}` : 'N/A';
                    const isActive = student.isActive !== false; // Default to true if not set
                    const statusClass = isActive ? 'active' : 'inactive';
                    const statusText = isActive ? 'Active' : 'Inactive';

                    tableHtml += `
                        <tr>
                            <td>${student.admissionNo || 'N/A'}</td>
                            <td>${student.name || 'N/A'}</td>
                            <td>${student.email || 'N/A'}</td>
                            <td>${student.program || 'N/A'}</td>
                            <td>${yearSem}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td class="flex gap-2">
                                <button onclick="editStudent('${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteStudent('${docSnap.id}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                });
                studentsTableBody.innerHTML = tableHtml;
            } catch (error) {
                console.error("Error loading students:", error);
                studentsTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 p-4">Error loading students.</td></tr>`;
                showCustomAlert("Failed to load students. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function searchStudents() {
            const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
            const studentsTableBody = document.querySelector('#studentsTable tbody');
            studentsTableBody.innerHTML = '';

            if (searchTerm === '') {
                loadStudents(); // Reload all if search is empty
                return;
            }

            const filteredStudents = allStudents.filter(student =>
                (student.name && student.name.toLowerCase().includes(searchTerm)) ||
                (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                (student.admissionNo && student.admissionNo.toLowerCase().includes(searchTerm))
            );

            if (filteredStudents.length === 0) {
                studentsTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">No matching students found.</td></tr>`;
                return;
            }

            let tableHtml = '';
            filteredStudents.forEach(student => {
                const yearSem = (student.year && student.semester) ? `Y${student.year} S${student.semester}` : 'N/A';
                const isActive = student.isActive !== false;
                const statusClass = isActive ? 'active' : 'inactive';
                const statusText = isActive ? 'Active' : 'Inactive';
                tableHtml += `
                    <tr>
                        <td>${student.admissionNo || 'N/A'}</td>
                        <td>${student.name || 'N/A'}</td>
                        <td>${student.email || 'N/A'}</td>
                        <td>${student.program || 'N/A'}</td>
                        <td>${yearSem}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="flex gap-2">
                            <button onclick="editStudent('${student.uid}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                            <button onclick="deleteStudent('${student.uid}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    </tr>
                `;
            });
            studentsTableBody.innerHTML = tableHtml;
        }


        async function editStudent(uid) {
            loadingOverlay.classList.remove('hidden');
            try {
                const studentDocRef = doc(db, "students", uid);
                const studentSnap = await getDoc(studentDocRef);
                if (!studentSnap.exists()) {
                    showCustomAlert("Student not found.", 'error');
                    return;
                }
                const studentData = studentSnap.data();
                
                document.getElementById('editStudentUid').value = uid;
                document.getElementById('editAdmissionNo').value = studentData.admissionNo || '';
                document.getElementById('editName').value = studentData.name || '';
                document.getElementById('editEmail').value = studentData.email || '';
                document.getElementById('editPhone').value = studentData.phone || '';
                document.getElementById('editDob').value = studentData.dob || '';
                document.getElementById('editGender').value = studentData.gender || '';
                document.getElementById('editAddress').value = studentData.address || '';
                document.getElementById('editGuardianName').value = studentData.guardian?.name || '';
                document.getElementById('editGuardianPhone').value = studentData.guardian?.phone || '';
                document.getElementById('editGuardianRelation').value = studentData.guardian?.relation || '';
                document.getElementById('editProgram').value = studentData.program || '';
                document.getElementById('editYear').value = studentData.year || '';
                document.getElementById('editSemester').value = studentData.semester || '';
                document.getElementById('editEnrollmentDate').value = studentData.enrollmentDate || '';
                document.getElementById('editIsActive').checked = studentData.isActive !== false; // Default to true

                document.getElementById('studentDetailModal').classList.remove('hidden');

            } catch (error) {
                console.error("Error editing student:", error);
                showCustomAlert("Failed to load student details for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('editStudentUid').value;
            loadingOverlay.classList.remove('hidden');
            try {
                const studentData = {
                    admissionNo: document.getElementById('editAdmissionNo').value.trim(),
                    name: document.getElementById('editName').value.trim(),
                    phone: document.getElementById('editPhone').value.trim(),
                    dob: document.getElementById('editDob').value,
                    gender: document.getElementById('editGender').value,
                    address: document.getElementById('editAddress').value.trim(),
                    guardian: {
                        name: document.getElementById('editGuardianName').value.trim(),
                        phone: document.getElementById('editGuardianPhone').value.trim(),
                        relation: document.getElementById('editGuardianRelation').value.trim(),
                    },
                    program: document.getElementById('editProgram').value.trim(),
                    year: parseInt(document.getElementById('editYear').value),
                    semester: parseInt(document.getElementById('editSemester').value),
                    isActive: document.getElementById('editIsActive').checked, // New field for active status
                };

                // Preserve enrollmentDate if not explicitly editable
                const existingStudentSnap = await getDoc(doc(db, "students", uid));
                if (existingStudentSnap.exists()) {
                    studentData.enrollmentDate = existingStudentSnap.data().enrollmentDate || studentData.enrollmentDate;
                }

                await updateDoc(doc(db, "students", uid), studentData);
                showCustomAlert("Student updated successfully!", 'success');
                closeModal('studentDetailModal');
                await loadStudents();
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error updating student:", error);
                showCustomAlert("Failed to update student. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function resetStudentPassword(uid, email) {
            showCustomConfirm(`Send password reset email to ${email}?`, 'confirm', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        // Check if the email is registered with Firebase Auth
                        const signInMethods = await fetchSignInMethodsForEmail(auth, email);
                        if (signInMethods.length === 0) {
                            showCustomAlert(`No Firebase account found for email: ${email}. Cannot send password reset.`, 'error');
                            return;
                        }

                        await sendPasswordResetEmail(auth, email);
                        showCustomAlert(`Password reset email sent to ${email}.`, 'success');
                    } catch (error) {
                        console.error("Error sending password reset email:", error);
                        showCustomAlert(getFriendlyErrorMessage(error.code), 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        async function deleteStudent(uid) {
            showCustomConfirm("Are you sure you want to delete this student and all their associated data (grades, finance, etc.)? This action is irreversible.", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        const studentDocRef = doc(db, "students", uid);
                        
                        // Delete associated subcollections (grades, finance, etc.)
                        // For a real app, you'd implement server-side deletion or cloud functions.
                        // Here, we'll explicitly delete some known subcollections.
                        
                        // 1. Delete Grades subcollection
                        const gradesSnap = await getDocs(collection(db, `grades/${uid}/results`));
                        const deleteGradePromises = gradesSnap.docs.map(gDoc => deleteDoc(gDoc.ref));
                        await Promise.all(deleteGradePromises);
                        await deleteDoc(doc(db, "grades", uid)); // Delete parent grades doc if it exists

                        // 2. Delete Finance subcollection and balance document
                        const financeTxnSnap = await getDocs(collection(db, `finance/${uid}/transactions`));
                        const deleteFinanceTxnPromises = financeTxnSnap.docs.map(txnDoc => deleteDoc(txnDoc.ref));
                        await Promise.all(deleteFinanceTxnPromises);
                        await deleteDoc(doc(db, "finance", uid)); // Delete parent finance doc (balance)

                        // 3. Delete Graduation request
                        await deleteDoc(doc(db, "graduations", uid));

                        // 4. Delete Clearance request
                        await deleteDoc(doc(db, "clearances", uid));

                        // 5. Update hostel room availability if they had a booking
                        const studentSnap = await getDoc(studentDocRef);
                        if (studentSnap.exists() && studentSnap.data().hostelBooking) {
                            const { hostelId, roomNo } = studentSnap.data().hostelBooking;
                            if (hostelId && roomNo) {
                                const roomsQuery = query(collection(db, `hostels/${hostelId}/rooms`), where("roomNo", "==", roomNo));
                                const roomsSnap = await getDocs(roomsQuery);
                                if (!roomsSnap.empty) {
                                    const roomDocRef = roomsSnap.docs[0].ref;
                                    await updateDoc(roomDocRef, { availableSlots: increment(1) });
                                }
                            }
                        }

                        // 6. Delete student document
                        await deleteDoc(studentDocRef);
                        
                        // Note on Firebase Auth user deletion:
                        // Deleting the Firebase Auth user requires the Admin SDK (server-side)
                        // or for the user themselves to be re-authenticated client-side.
                        // For this frontend-only app, you'd need to manually delete the user
                        // from the Firebase Authentication console, or implement a Cloud Function.

                        showCustomAlert("Student and their associated data deleted successfully.", 'success');
                        await loadStudents();
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error deleting student:", error);
                        showCustomAlert("Failed to delete student. Please try again. Ensure security rules allow deletion.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Courses Functions ---
        const courseForm = document.getElementById('courseForm');
        const courseIdField = document.getElementById('courseId');
        const saveCourseBtn = document.getElementById('saveCourseBtn');
        const cancelEditCourseBtn = document.getElementById('cancelEditCourseBtn');

        async function loadCourses() {
            loadingOverlay.classList.remove('hidden');
            const coursesTableBody = document.querySelector('#coursesTable tbody');
            coursesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading courses...</td></tr>`;
            try {
                const coursesSnap = await getDocs(collection(db, "courses"));
                if (coursesSnap.empty) {
                    coursesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">No courses available.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                coursesSnap.forEach(docSnap => {
                    const course = docSnap.data();
                    tableHtml += `
                        <tr>
                            <td>${course.code}</td>
                            <td>${course.title}</td>
                            <td>${course.credits}</td>
                            <td>${course.lecturer}</td>
                            <td>${course.year}</td>
                            <td>${course.semester}</td>
                            <td class="flex gap-2">
                                <button onclick="editCourse('${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteCourse('${docSnap.id}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                });
                coursesTableBody.innerHTML = tableHtml;
                resetCourseForm(); // Clear form after loading
            } catch (error) {
                console.error("Error loading courses:", error);
                coursesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 p-4">Error loading courses.</td></tr>`;
                showCustomAlert("Failed to load courses. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function resetCourseForm() {
            courseForm.reset();
            courseIdField.value = '';
            saveCourseBtn.textContent = 'Add Course';
            cancelEditCourseBtn.classList.add('hidden');
        }

        courseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            try {
                const courseData = {
                    code: document.getElementById('courseCode').value.trim(),
                    title: document.getElementById('courseTitle').value.trim(),
                    credits: parseInt(document.getElementById('courseCredits').value),
                    lecturer: document.getElementById('courseLecturer').value.trim(),
                    year: parseInt(document.getElementById('courseYear').value),
                    semester: parseInt(document.getElementById('courseSemester').value),
                };

                const courseId = courseIdField.value;
                if (courseId) {
                    // Update existing course
                    await updateDoc(doc(db, "courses", courseId), courseData);
                    showCustomAlert("Course updated successfully!", 'success');
                } else {
                    // Add new course
                    await addDoc(collection(db, "courses"), courseData);
                    showCustomAlert("Course added successfully!", 'success');
                }
                await loadCourses();
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error saving course:", error);
                showCustomAlert("Failed to save course. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function editCourse(id) {
            loadingOverlay.classList.remove('hidden');
            try {
                const courseDoc = await getDoc(doc(db, "courses", id));
                if (!courseDoc.exists()) {
                    showCustomAlert("Course not found.", 'error');
                    return;
                }
                const courseData = courseDoc.data();
                courseIdField.value = id;
                document.getElementById('courseCode').value = courseData.code;
                document.getElementById('courseTitle').value = courseData.title;
                document.getElementById('courseCredits').value = courseData.credits;
                document.getElementById('courseLecturer').value = courseData.lecturer;
                document.getElementById('courseYear').value = courseData.year;
                document.getElementById('courseSemester').value = courseData.semester;

                saveCourseBtn.textContent = 'Update Course';
                cancelEditCourseBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error editing course:", error);
                showCustomAlert("Failed to load course for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function deleteCourse(id) {
            showCustomConfirm("Are you sure you want to delete this course? This will also remove it from any student's registered courses.", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await deleteDoc(doc(db, "courses", id));

                        // Also remove this course from any student's registeredCourses array
                        // Fetch all students and filter their registeredCourses
                        const studentsSnap = await getDocs(collection(db, "students"));
                        const batch = db.batch(); // Use a batch for multiple updates
                        studentsSnap.forEach(studentDoc => {
                            const studentData = studentDoc.data();
                            const registeredCourses = studentData.registeredCourses || [];
                            const updatedCourses = registeredCourses.filter(course => course.id !== id);
                            if (updatedCourses.length !== registeredCourses.length) { // Only update if course was found
                                batch.update(studentDoc.ref, { registeredCourses: updatedCourses });
                            }
                        });
                        await batch.commit();

                        // Also delete any grade entries for this course for all students
                        const allStudentsSnap = await getDocs(collection(db, "students"));
                        for (const studentDoc of allStudentsSnap.docs) {
                            // Assuming grade entries store the course ID, not just the code
                            const gradesQuery = query(collection(db, `grades/${studentDoc.id}/results`), where("courseId", "==", id)); 
                            const gradesSnap = await getDocs(gradesQuery);
                            const gradeBatch = db.batch();
                            gradesSnap.forEach(gradeDoc => {
                                gradeBatch.delete(gradeDoc.ref);
                            });
                            await gradeBatch.commit();
                        }

                        // Also delete any timetable entries for this course
                        const timetableQuery = query(collection(db, "timetable"), where("courseCode", "==", document.getElementById('courseCode').value)); // Use current course code from form, assuming it's correctly set during editCourse
                        const timetableSnap = await getDocs(timetableQuery);
                        const timetableBatch = db.batch();
                        timetableSnap.forEach(tDoc => {
                            timetableBatch.delete(tDoc.ref);
                        });
                        await timetableBatch.commit();

                        // Also delete any exam schedules for this course
                        const examScheduleQuery = query(collection(db, "examSchedule"), where("courseCode", "==", document.getElementById('courseCode').value)); // Use current course code from form
                        const examScheduleSnap = await getDocs(examScheduleQuery);
                        const examScheduleBatch = db.batch();
                        examScheduleSnap.forEach(eDoc => {
                            examScheduleBatch.delete(eDoc.ref);
                        });
                        await examScheduleBatch.commit();


                        showCustomAlert("Course and all associated data deleted successfully!", 'success');
                        await loadCourses();
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error deleting course:", error);
                        showCustomAlert("Failed to delete course. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Timetable Functions ---
        const timetableForm = document.getElementById('timetableForm');
        const timetableIdField = document.getElementById('timetableId');
        const saveTimetableBtn = document.getElementById('saveTimetableBtn');
        const cancelEditTimetableBtn = document.getElementById('cancelEditTimetableBtn');

        async function loadTimetableEntries() {
            loadingOverlay.classList.remove('hidden');
            const timetableTableBody = document.querySelector('#timetableTable tbody');
            timetableTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading timetable entries...</td></tr>`;
            try {
                const timetableSnap = await getDocs(collection(db, "timetable"));
                if (timetableSnap.empty) {
                    timetableTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">No timetable entries available.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                timetableSnap.forEach(docSnap => {
                    const entry = docSnap.data();
                    tableHtml += `
                        <tr>
                            <td>${entry.courseCode}</td>
                            <td>${entry.day}</td>
                            <td>${entry.startTime}-${entry.endTime}</td>
                            <td>${entry.venue}</td>
                            <td>${entry.lecturer}</td>
                            <td>Y${entry.year} S${entry.semester}</td>
                            <td class="flex gap-2">
                                <button onclick="editTimetableEntry('${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteTimetableEntry('${docSnap.id}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                });
                timetableTableBody.innerHTML = tableHtml;
                resetTimetableForm();
            } catch (error) {
                console.error("Error loading timetable entries:", error);
                timetableTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 p-4">Error loading timetable entries.</td></tr>`;
                showCustomAlert("Failed to load timetable entries. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function resetTimetableForm() {
            timetableForm.reset();
            timetableIdField.value = '';
            saveTimetableBtn.textContent = 'Add Timetable Entry';
            cancelEditTimetableBtn.classList.add('hidden');
        }

        timetableForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            try {
                const entryData = {
                    courseCode: document.getElementById('timetableCourseCode').value.trim(),
                    day: document.getElementById('timetableDay').value,
                    startTime: document.getElementById('timetableStartTime').value,
                    endTime: document.getElementById('timetableEndTime').value,
                    venue: document.getElementById('timetableVenue').value.trim(),
                    lecturer: document.getElementById('timetableLecturer').value.trim(),
                    year: parseInt(document.getElementById('timetableYear').value),
                    semester: parseInt(document.getElementById('timetableSemester').value),
                };

                const timetableId = timetableIdField.value;
                if (timetableId) {
                    await updateDoc(doc(db, "timetable", timetableId), entryData);
                    showCustomAlert("Timetable entry updated successfully!", 'success');
                } else {
                    await addDoc(collection(db, "timetable"), entryData);
                    showCustomAlert("Timetable entry added successfully!", 'success');
                }
                await loadTimetableEntries();
            } catch (error) {
                console.error("Error saving timetable entry:", error);
                showCustomAlert("Failed to save timetable entry. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function editTimetableEntry(id) {
            loadingOverlay.classList.remove('hidden');
            try {
                const entryDoc = await getDoc(doc(db, "timetable", id));
                if (!entryDoc.exists()) {
                    showCustomAlert("Timetable entry not found.", 'error');
                    return;
                }
                const entryData = entryDoc.data();
                timetableIdField.value = id;
                document.getElementById('timetableCourseCode').value = entryData.courseCode;
                document.getElementById('timetableDay').value = entryData.day;
                document.getElementById('timetableStartTime').value = entryData.startTime;
                document.getElementById('timetableEndTime').value = entryData.endTime;
                document.getElementById('timetableVenue').value = entryData.venue;
                document.getElementById('timetableLecturer').value = entryData.lecturer;
                document.getElementById('timetableYear').value = entryData.year;
                document.getElementById('timetableSemester').value = entryData.semester;

                saveTimetableBtn.textContent = 'Update Entry';
                cancelEditTimetableBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error editing timetable entry:", error);
                showCustomAlert("Failed to load timetable entry for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function deleteTimetableEntry(id) {
            showCustomConfirm("Are you sure you want to delete this timetable entry?", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await deleteDoc(doc(db, "timetable", id));
                        showCustomAlert("Timetable entry deleted successfully!", 'success');
                        await loadTimetableEntries();
                    } catch (error) {
                        console.error("Error deleting timetable entry:", error);
                        showCustomAlert("Failed to delete timetable entry. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Grades Functions ---
        let gradeFormCurrentStudentUid = null;
        let allStudentsForGrades = [];
        let allCoursesForGrades = [];

        async function loadAllStudentsAndCoursesForGrades() {
            try {
                // Load students for datalist
                const studentsSnap = await getDocs(collection(db, "students"));
                const studentUidsDatalist = document.getElementById('studentUids');
                studentUidsDatalist.innerHTML = '';
                allStudentsForGrades = [];
                studentsSnap.forEach(docSnap => {
                    const studentData = docSnap.data();
                    allStudentsForGrades.push({ uid: docSnap.id, ...studentData });
                    const option = document.createElement('option');
                    option.value = docSnap.id;
                    option.textContent = `${studentData.name || 'N/A'} (${docSnap.id})`;
                    studentUidsDatalist.appendChild(option);
                });

                // Load courses for datalist
                const coursesSnap = await getDocs(collection(db, "courses"));
                const courseCodesDatalist = document.getElementById('courseCodes');
                courseCodesDatalist.innerHTML = '';
                allCoursesForGrades = [];
                coursesSnap.forEach(docSnap => {
                    const courseData = docSnap.data();
                    allCoursesForGrades.push({ id: docSnap.id, ...courseData });
                    const option = document.createElement('option');
                    option.value = courseData.code;
                    option.textContent = `${courseData.code} - ${courseData.title}`;
                    courseCodesDatalist.appendChild(option);
                });

            } catch (error) {
                console.error("Error loading students/courses for grades:", error);
                showCustomAlert("Failed to load student/course data for grade management.", 'error');
            }
        }

        async function loadStudentGrades() {
            const studentUid = document.getElementById('gradeStudentId').value;
            const year = document.getElementById('gradeYear').value;
            const semester = document.getElementById('gradeSemester').value;
            const gradesTableBody = document.querySelector('#manageGrades #gradesTable tbody');
            const gradeEntryForm = document.getElementById('gradeEntryForm');
            gradesTableBody.innerHTML = '';
            resetGradeForm(); // Reset form first
            gradeEntryForm.classList.add('hidden'); // Hide form by default

            if (!studentUid || !year || !semester) {
                gradesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">Select student, year, and semester to load grades.</td></tr>`;
                return;
            }

            gradeFormCurrentStudentUid = studentUid; // Set current student UID for form submission
            loadingOverlay.classList.remove('hidden');
            try {
                const gradesQuery = query(
                    collection(db, `grades/${studentUid}/results`),
                    where("year", "==", parseInt(year)),
                    where("semester", "==", parseInt(semester))
                );
                const gradesSnap = await getDocs(gradesQuery);

                if (gradesSnap.empty) {
                    gradesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">No grades found for this student in Year ${year}, Semester ${semester}.</td></tr>`;
                } else {
                    let tableHtml = '';
                    gradesSnap.forEach(docSnap => {
                        const grade = docSnap.data();
                        tableHtml += `
                            <tr>
                                <td>${grade.courseCode || 'N/A'}</td>
                                <td>${grade.courseTitle || 'N/A'}</td>
                                <td>${grade.credits || 'N/A'}</td>
                                <td>${grade.grade || 'N/A'}</td>
                                <td>${grade.gpaPoints || 'N/A'}</td>
                                <td>${grade.lecturer || 'N/A'}</td>
                                <td class="flex gap-2">
                                    <button onclick="editGrade('${studentUid}', '${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                    <button onclick="deleteGrade('${studentUid}', '${docSnap.id}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    gradesTableBody.innerHTML = tableHtml;
                }
                gradeEntryForm.classList.remove('hidden'); // Show form for adding/editing

            } catch (error) {
                console.error("Error loading student grades:", error);
                gradesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 p-4">Error loading grades.</td></tr>`;
                showCustomAlert("Failed to load student grades. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Auto-fill course details when course code is entered for adding grades
        document.getElementById('gradeCourseCode').addEventListener('change', (e) => {
            const courseCode = e.target.value;
            const course = allCoursesForGrades.find(c => c.code === courseCode);
            if (course) {
                document.getElementById('gradeCourseTitle').value = course.title;
                document.getElementById('gradeCredits').value = course.credits;
                document.getElementById('gradeLecturer').value = course.lecturer;
            } else {
                document.getElementById('gradeCourseTitle').value = '';
                document.getElementById('gradeCredits').value = '';
                document.getElementById('gradeLecturer').value = '';
                showCustomAlert("Course code not found. Please ensure it's a valid course.", 'info');
            }
        });

        async function editGrade(studentUid, gradeId) {
            loadingOverlay.classList.remove('hidden');
            try {
                const gradeDoc = await getDoc(doc(db, `grades/${studentUid}/results`, gradeId));
                if (!gradeDoc.exists()) {
                    showCustomAlert("Grade entry not found.", 'error');
                    return;
                }
                const gradeData = gradeDoc.data();
                document.getElementById('gradeEntryId').value = gradeId;
                document.getElementById('gradeCourseCode').value = gradeData.courseCode;
                document.getElementById('gradeCourseTitle').value = gradeData.courseTitle;
                document.getElementById('gradeCredits').value = gradeData.credits;
                document.getElementById('gradeGrade').value = gradeData.grade;
                document.getElementById('gradePoints').value = gradeData.gpaPoints;
                document.getElementById('gradeLecturer').value = gradeData.lecturer;
                // Year and Semester are from the overall grade filter, not individual grade entry.
                // Keep the current selection in the main filter.
                // document.getElementById('gradeYear').value = gradeData.year; 
                // document.getElementById('gradeSemester').value = gradeData.semester;

                document.getElementById('saveGradeBtn').textContent = 'Update Grade';
                document.getElementById('cancelEditGradeBtn').classList.remove('hidden');

            } catch (error) {
                console.error("Error editing grade:", error);
                showCustomAlert("Failed to load grade for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        document.getElementById('gradeEntryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentUid = gradeFormCurrentStudentUid;
            if (!studentUid) {
                showCustomAlert("No student selected for grade entry.", 'error');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            try {
                const gradeData = {
                    courseCode: document.getElementById('gradeCourseCode').value.trim(),
                    courseTitle: document.getElementById('gradeCourseTitle').value.trim(),
                    credits: parseInt(document.getElementById('gradeCredits').value),
                    grade: document.getElementById('gradeGrade').value.trim().toUpperCase(),
                    gpaPoints: parseFloat(document.getElementById('gradePoints').value),
                    lecturer: document.getElementById('gradeLecturer').value.trim(),
                    year: parseInt(document.getElementById('gradeYear').value), // Use selected filter year
                    semester: parseInt(document.getElementById('gradeSemester').value), // Use selected filter semester
                };

                const gradeId = document.getElementById('gradeEntryId').value;
                if (gradeId) {
                    await updateDoc(doc(db, `grades/${studentUid}/results`, gradeId), gradeData);
                    showCustomAlert("Grade updated successfully!", 'success');
                } else {
                    await addDoc(collection(db, `grades/${studentUid}/results`), gradeData);
                    showCustomAlert("Grade added successfully!", 'success');
                }
                await loadStudentGrades(); // Reload grades for the current student/semester
                resetGradeForm();
            } catch (error) {
                console.error("Error saving grade:", error);
                showCustomAlert("Failed to save grade. Please check inputs and try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        function resetGradeForm() {
            document.getElementById('gradeEntryForm').reset();
            document.getElementById('gradeEntryId').value = '';
            document.getElementById('saveGradeBtn').textContent = 'Save Grade';
            document.getElementById('cancelEditGradeBtn').classList.add('hidden');
            // Retain selection of student, year, semester in filter dropdowns
            document.getElementById('gradeStudentId').value = gradeFormCurrentStudentUid || '';
            document.getElementById('gradeYear').value = document.getElementById('gradeYear').value;
            document.getElementById('gradeSemester').value = document.getElementById('gradeSemester').value;
        }

        async function deleteGrade(studentUid, gradeId) {
            showCustomConfirm("Are you sure you want to delete this grade entry?", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await deleteDoc(doc(db, `grades/${studentUid}/results`, gradeId));
                        showCustomAlert("Grade deleted successfully!", 'success');
                        await loadStudentGrades(); // Reload grades for the current student/semester
                    } catch (error) {
                        console.error("Error deleting grade:", error);
                        showCustomAlert("Failed to delete grade. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Exam Schedule Functions ---
        const examScheduleForm = document.getElementById('examScheduleForm');
        const examScheduleIdField = document.getElementById('examScheduleId');
        const saveExamScheduleBtn = document.getElementById('saveExamScheduleBtn');
        const cancelEditExamScheduleBtn = document.getElementById('cancelEditExamScheduleBtn');
        let allCoursesForExam = [];

        async function loadAllCoursesForExamSchedule() {
            try {
                const coursesSnap = await getDocs(collection(db, "courses"));
                const courseCodesDatalist = document.getElementById('courseCodesExam');
                courseCodesDatalist.innerHTML = '';
                allCoursesForExam = [];
                coursesSnap.forEach(docSnap => {
                    const courseData = docSnap.data();
                    allCoursesForExam.push({ id: docSnap.id, ...courseData });
                    const option = document.createElement('option');
                    option.value = courseData.code;
                    option.textContent = `${courseData.code} - ${courseData.title}`;
                    courseCodesDatalist.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading courses for exam schedule datalist:", error);
            }
        }


        async function loadExamSchedules() {
            loadingOverlay.classList.remove('hidden');
            const examScheduleTableBody = document.querySelector('#examScheduleTable tbody');
            examScheduleTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">Loading exam schedules...</td></tr>`;
            try {
                const examSnap = await getDocs(collection(db, "examSchedule"));
                if (examSnap.empty) {
                    examScheduleTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">No exam schedules available.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                examSnap.forEach(docSnap => {
                    const exam = docSnap.data();
                    const formattedDate = exam.date ? new Date(exam.date).toLocaleDateString() : 'N/A';
                    tableHtml += `
                        <tr>
                            <td>${exam.courseCode || 'N/A'}</td>
                            <td>${formattedDate}</td>
                            <td>${exam.time || 'N/A'}</td>
                            <td>${exam.venue || 'N/A'}</td>
                            <td>${exam.lecturer || 'N/A'}</td>
                            <td>Y${exam.year || 'N/A'} S${exam.semester || 'N/A'}</td>
                            <td class="flex gap-2">
                                <button onclick="editExamSchedule('${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteExamSchedule('${docSnap.id}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                });
                examScheduleTableBody.innerHTML = tableHtml;
                resetExamScheduleForm();
            } catch (error) {
                console.error("Error loading exam schedules:", error);
                examScheduleTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 p-4">Error loading exam schedules.</td></tr>`;
                showCustomAlert("Failed to load exam schedules. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function resetExamScheduleForm() {
            examScheduleForm.reset();
            examScheduleIdField.value = '';
            saveExamScheduleBtn.textContent = 'Add Exam Schedule';
            cancelEditExamScheduleBtn.classList.add('hidden');
        }

        examScheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            try {
                const examData = {
                    courseCode: document.getElementById('examScheduleCourseCode').value.trim(),
                    date: document.getElementById('examScheduleDate').value,
                    time: document.getElementById('examScheduleTime').value,
                    venue: document.getElementById('examScheduleVenue').value.trim(),
                    lecturer: document.getElementById('examScheduleLecturer').value.trim(),
                    year: parseInt(document.getElementById('examScheduleYear').value),
                    semester: parseInt(document.getElementById('examScheduleSemester').value),
                };

                const examScheduleId = examScheduleIdField.value;
                if (examScheduleId) {
                    await updateDoc(doc(db, "examSchedule", examScheduleId), examData);
                    showCustomAlert("Exam schedule updated successfully!", 'success');
                } else {
                    await addDoc(collection(db, "examSchedule"), examData);
                    showCustomAlert("Exam schedule added successfully!", 'success');
                }
                await loadExamSchedules();
            } catch (error) {
                console.error("Error saving exam schedule:", error);
                showCustomAlert("Failed to save exam schedule. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function editExamSchedule(id) {
            loadingOverlay.classList.remove('hidden');
            try {
                const examDoc = await getDoc(doc(db, "examSchedule", id));
                if (!examDoc.exists()) {
                    showCustomAlert("Exam schedule entry not found.", 'error');
                    return;
                }
                const examData = examDoc.data();
                examScheduleIdField.value = id;
                document.getElementById('examScheduleCourseCode').value = examData.courseCode;
                document.getElementById('examScheduleDate').value = examData.date; // Date input type handles string
                document.getElementById('examScheduleTime').value = examData.time;
                document.getElementById('examScheduleVenue').value = examData.venue;
                document.getElementById('examScheduleLecturer').value = examData.lecturer;
                document.getElementById('examScheduleYear').value = examData.year;
                document.getElementById('examScheduleSemester').value = examData.semester;

                saveExamScheduleBtn.textContent = 'Update Exam Schedule';
                cancelEditExamScheduleBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error editing exam schedule:", error);
                showCustomAlert("Failed to load exam schedule for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function deleteExamSchedule(id) {
            showCustomConfirm("Are you sure you want to delete this exam schedule entry?", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await deleteDoc(doc(db, "examSchedule", id));
                        showCustomAlert("Exam schedule entry deleted successfully!", 'success');
                        await loadExamSchedules();
                    } catch (error) {
                        console.error("Error deleting exam schedule entry:", error);
                        showCustomAlert("Failed to delete exam schedule entry. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }


        // --- Manage Announcements Functions ---
        const announcementForm = document.getElementById('announcementForm');
        const announcementIdField = document.getElementById('announcementId');
        const saveAnnouncementBtn = document.getElementById('saveAnnouncementBtn');
        const cancelEditAnnouncementBtn = document.getElementById('cancelEditAnnouncementBtn');

        async function loadAnnouncements() {
            loadingOverlay.classList.remove('hidden');
            const announcementsTableBody = document.querySelector('#announcementsTable tbody');
            announcementsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading announcements...</td></tr>`;
            try {
                const announcementsSnap = await getDocs(query(collection(db, "announcements"), orderBy("date", "desc")));
                if (announcementsSnap.empty) {
                    announcementsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">No announcements published.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                announcementsSnap.forEach(docSnap => {
                    const a = docSnap.data();
                    const formattedDate = a.date ? new Date(a.date.seconds * 1000).toLocaleDateString() : 'N/A';
                    const categoryClass = a.category ? a.category.toLowerCase() : 'general';
                    tableHtml += `
                        <tr>
                            <td>${a.title}</td>
                            <td><span class="status-badge ${categoryClass}">${a.category}</span></td>
                            <td>${a.author}</td>
                            <td>${formattedDate}</td>
                            <td>${a.pinned ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
                            <td class="flex gap-2">
                                <button onclick="editAnnouncement('${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteAnnouncement('${docSnap.id}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                });
                announcementsTableBody.innerHTML = tableHtml;
                resetAnnouncementForm();
            } catch (error) {
                console.error("Error loading announcements:", error);
                announcementsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-4">Error loading announcements.</td></tr>`;
                showCustomAlert("Failed to load announcements. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function resetAnnouncementForm() {
            announcementForm.reset();
            announcementIdField.value = '';
            saveAnnouncementBtn.textContent = 'Publish Announcement';
            cancelEditAnnouncementBtn.classList.add('hidden');
            document.getElementById('announcementPinned').checked = false; // Reset checkbox
        }

        announcementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            try {
                const announcementData = {
                    title: document.getElementById('announcementTitle').value.trim(),
                    message: document.getElementById('announcementMessage').value.trim(),
                    author: document.getElementById('announcementAuthor').value.trim(),
                    category: document.getElementById('announcementCategory').value,
                    pinned: document.getElementById('announcementPinned').checked,
                    date: serverTimestamp() // Set timestamp on creation/update
                };

                const announcementId = announcementIdField.value;
                if (announcementId) {
                    await updateDoc(doc(db, "announcements", announcementId), announcementData);
                    showCustomAlert("Announcement updated successfully!", 'success');
                } else {
                    await addDoc(collection(db, "announcements"), announcementData);
                    showCustomAlert("Announcement published successfully!", 'success');
                }
                await loadAnnouncements();
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error saving announcement:", error);
                showCustomAlert("Failed to save announcement. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function editAnnouncement(id) {
            loadingOverlay.classList.remove('hidden');
            try {
                const announcementDoc = await getDoc(doc(db, "announcements", id));
                if (!announcementDoc.exists()) {
                    showCustomAlert("Announcement not found.", 'error');
                    return;
                }
                const a = announcementDoc.data();
                announcementIdField.value = id;
                document.getElementById('announcementTitle').value = a.title;
                document.getElementById('announcementMessage').value = a.message;
                document.getElementById('announcementAuthor').value = a.author;
                document.getElementById('announcementCategory').value = a.category;
                document.getElementById('announcementPinned').checked = a.pinned;

                saveAnnouncementBtn.textContent = 'Update Announcement';
                cancelEditAnnouncementBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error editing announcement:", error);
                showCustomAlert("Failed to load announcement for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function deleteAnnouncement(id) {
            showCustomConfirm("Are you sure you want to delete this announcement?", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await deleteDoc(doc(db, "announcements", id));
                        showCustomAlert("Announcement deleted successfully!", 'success');
                        await loadAnnouncements();
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error deleting announcement:", error);
                        showCustomAlert("Failed to delete announcement. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Hostels Functions ---
        let currentManagingHostelId = null;
        const hostelForm = document.getElementById('hostelForm');
        const hostelIdField = document.getElementById('hostelId');
        const saveHostelBtn = document.getElementById('saveHostelBtn');
        const cancelEditHostelBtn = document.getElementById('cancelEditHostelBtn');
        const roomsManagementArea = document.getElementById('roomsManagementArea');

        const roomForm = document.getElementById('roomForm');
        const roomIdField = document.getElementById('roomId');
        const roomHostelIdField = document.getElementById('roomHostelId');
        const saveRoomBtn = document.getElementById('saveRoomBtn');
        const cancelEditRoomBtn = document.getElementById('cancelEditRoomBtn');

        async function loadHostels() {
            loadingOverlay.classList.remove('hidden');
            const hostelsTableBody = document.querySelector('#hostelsTable tbody');
            hostelsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading hostels...</td></tr>`;
            try {
                const hostelsSnap = await getDocs(collection(db, "hostels"));
                if (hostelsSnap.empty) {
                    hostelsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">No hostels available.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                for (const docSnap of hostelsSnap.docs) {
                    const hostel = docSnap.data();
                    let availableRoomsCount = 0;
                    const roomsSnap = await getDocs(collection(db, `hostels/${docSnap.id}/rooms`));
                    roomsSnap.forEach(roomDoc => {
                        availableRoomsCount += (roomDoc.data().availableSlots || 0);
                    });

                    tableHtml += `
                        <tr>
                            <td>${hostel.name}</td>
                            <td>${hostel.type}</td>
                            <td>${hostel.capacity}</td>
                            <td>${hostel.location || 'N/A'}</td>
                            <td>${availableRoomsCount}</td>
                            <td class="flex gap-2">
                                <button onclick="editHostel('${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteHostel('${docSnap.id}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i></button>
                                <button onclick="manageRooms('${docSnap.id}', '${hostel.name}')" class="btn-green text-xs px-2 py-1"><i class="fas fa-door-open"></i> Rooms</button>
                            </td>
                        </tr>
                    `;
                }
                hostelsTableBody.innerHTML = tableHtml;
                resetHostelForm();
                roomsManagementArea.classList.add('hidden'); // Hide room management when viewing main hostels list
                await loadAdminDashboardOverview(); // Update overall hostel stats
            } catch (error) {
                console.error("Error loading hostels:", error);
                hostelsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-4">Error loading hostels.</td></tr>`;
                showCustomAlert("Failed to load hostels. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function resetHostelForm() {
            hostelForm.reset();
            hostelIdField.value = '';
            saveHostelBtn.textContent = 'Add Hostel';
            cancelEditHostelBtn.classList.add('hidden');
        }

        hostelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            try {
                const hostelData = {
                    name: document.getElementById('hostelName').value.trim(),
                    type: document.getElementById('hostelType').value.trim(),
                    capacity: parseInt(document.getElementById('hostelCapacity').value),
                    location: document.getElementById('hostelLocation').value.trim(),
                };

                const hostelId = hostelIdField.value;
                if (hostelId) {
                    await updateDoc(doc(db, "hostels", hostelId), hostelData);
                    showCustomAlert("Hostel updated successfully!", 'success');
                } else {
                    await addDoc(collection(db, "hostels"), hostelData);
                    showCustomAlert("Hostel added successfully!", 'success');
                }
                await loadHostels();
            } catch (error) {
                console.error("Error saving hostel:", error);
                showCustomAlert("Failed to save hostel. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function editHostel(id) {
            loadingOverlay.classList.remove('hidden');
            try {
                const hostelDoc = await getDoc(doc(db, "hostels", id));
                if (!hostelDoc.exists()) {
                    showCustomAlert("Hostel not found.", 'error');
                    return;
                }
                const hostelData = hostelDoc.data();
                hostelIdField.value = id;
                document.getElementById('hostelName').value = hostelData.name;
                document.getElementById('hostelType').value = hostelData.type;
                document.getElementById('hostelCapacity').value = hostelData.capacity;
                document.getElementById('hostelLocation').value = hostelData.location;

                saveHostelBtn.textContent = 'Update Hostel';
                cancelEditHostelBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error editing hostel:", error);
                showCustomAlert("Failed to load hostel for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function deleteHostel(id) {
            showCustomConfirm("Are you sure you want to delete this hostel and all its rooms and associated bookings? This action is irreversible.", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        // Delete hostel document
                        await deleteDoc(doc(db, "hostels", id));

                        // Cascade delete rooms (Firestore subcollections not auto-deleted, needs manual or cloud function)
                        const roomsSnap = await getDocs(collection(db, `hostels/${id}/rooms`));
                        const deleteRoomPromises = roomsSnap.docs.map(roomDoc => deleteDoc(roomDoc.ref));
                        await Promise.all(deleteRoomPromises);
                        
                        // Also clear student bookings for this hostel
                        const studentsQuery = query(collection(db, "students"), where("hostelBooking.hostelId", "==", id));
                        const studentsSnap = await getDocs(studentsQuery);
                        const batch = db.batch();
                        studentsSnap.forEach(studentDoc => {
                            batch.update(studentDoc.ref, { hostelBooking: null });
                        });
                        await batch.commit();

                        showCustomAlert("Hostel, its rooms, and associated student bookings deleted successfully!", 'success');
                        await loadHostels();
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error deleting hostel:", error);
                        showCustomAlert("Failed to delete hostel. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Room Management Functions ---
        async function manageRooms(hostelId, hostelName) {
            currentManagingHostelId = hostelId;
            document.getElementById('hostelForm').classList.add('hidden'); // Hide hostel form
            document.getElementById('hostelsTable').parentElement.classList.add('hidden'); // Hide hostels table

            roomsManagementArea.classList.remove('hidden');
            document.getElementById('roomsOfHostelTitle').textContent = `Rooms in ${hostelName}`;
            
            await loadRooms(hostelId);
            resetRoomForm();
        }

        async function loadRooms(hostelId) {
            loadingOverlay.classList.remove('hidden');
            const roomsTableBody = document.querySelector('#roomsTable tbody');
            roomsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 p-4">Loading rooms...</td></tr>`;
            try {
                const roomsSnap = await getDocs(collection(db, `hostels/${hostelId}/rooms`));
                if (roomsSnap.empty) {
                    roomsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 p-4">No rooms in this hostel.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                roomsSnap.forEach(docSnap => {
                    const room = docSnap.data();
                    tableHtml += `
                        <tr>
                            <td>${room.roomNo}</td>
                            <td>${room.capacity}-bed</td>
                            <td>${room.availableSlots}</td>
                            <td class="flex gap-2">
                                <button onclick="editRoom('${hostelId}', '${docSnap.id}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteRoom('${hostelId}', '${docSnap.id}', '${room.roomNo}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                });
                roomsTableBody.innerHTML = tableHtml;
            } catch (error) {
                console.error("Error loading rooms:", error);
                roomsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 p-4">Error loading rooms.</td></tr>`;
                showCustomAlert("Failed to load rooms. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function showHostelsList() {
            currentManagingHostelId = null;
            roomsManagementArea.classList.add('hidden');
            document.getElementById('hostelForm').classList.remove('hidden');
            document.getElementById('hostelsTable').parentElement.classList.remove('hidden');
            loadHostels();
        }

        function resetRoomForm() {
            roomForm.reset();
            roomIdField.value = '';
            roomHostelIdField.value = currentManagingHostelId;
            saveRoomBtn.textContent = 'Add Room';
            cancelEditRoomBtn.classList.add('hidden');
        }

        roomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const hostelId = roomHostelIdField.value;
            if (!hostelId) {
                showCustomAlert("No hostel selected for room management.", 'error');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            try {
                const roomData = {
                    roomNo: document.getElementById('roomNo').value.trim(),
                    capacity: parseInt(document.getElementById('roomCapacity').value),
                    availableSlots: parseInt(document.getElementById('availableSlots').value),
                };

                const roomId = roomIdField.value;
                if (roomId) {
                    await updateDoc(doc(db, `hostels/${hostelId}/rooms`, roomId), roomData);
                    showCustomAlert("Room updated successfully!", 'success');
                } else {
                    await addDoc(collection(db, `hostels/${hostelId}/rooms`), roomData);
                    showCustomAlert("Room added successfully!", 'success');
                }
                await loadRooms(hostelId);
                resetRoomForm();
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error saving room:", error);
                showCustomAlert("Failed to save room. Please check inputs and try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function editRoom(hostelId, roomId) {
            loadingOverlay.classList.remove('hidden');
            try {
                const roomDoc = await getDoc(doc(db, `hostels/${hostelId}/rooms`, roomId));
                if (!roomDoc.exists()) {
                    showCustomAlert("Room not found.", 'error');
                    return;
                }
                const roomData = roomDoc.data();
                roomIdField.value = roomId;
                roomHostelIdField.value = hostelId;
                document.getElementById('roomNo').value = roomData.roomNo;
                document.getElementById('roomCapacity').value = roomData.capacity;
                document.getElementById('availableSlots').value = roomData.availableSlots;

                saveRoomBtn.textContent = 'Update Room';
                cancelEditRoomBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error editing room:", error);
                showCustomAlert("Failed to load room for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function deleteRoom(hostelId, roomId, roomNo) {
            showCustomConfirm(`Are you sure you want to delete Room ${roomNo}? This will also remove any student bookings in this specific room.`, 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await deleteDoc(doc(db, `hostels/${hostelId}/rooms`, roomId));

                        // Clear student bookings specific to this room
                        const studentsQuery = query(collection(db, "students"), 
                            where("hostelBooking.hostelId", "==", hostelId),
                            where("hostelBooking.roomNo", "==", roomNo));
                        const studentsSnap = await getDocs(studentsQuery);
                        const batch = db.batch();
                        studentsSnap.forEach(studentDoc => {
                            batch.update(studentDoc.ref, { hostelBooking: null });
                        });
                        await batch.commit();

                        showCustomAlert("Room and associated student bookings deleted successfully!", 'success');
                        await loadRooms(hostelId);
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error deleting room:", error);
                        showCustomAlert("Failed to delete room. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Graduation Requests Functions ---
        const graduationDetailModal = document.getElementById('graduationDetailModal');
        const updateGradStatusForm = document.getElementById('updateGradStatusForm');

        async function loadGraduationRequests() {
            loadingOverlay.classList.remove('hidden');
            const graduationRequestsTableBody = document.querySelector('#graduationRequestsTable tbody');
            graduationRequestsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading graduation requests...</td></tr>`;
            try {
                const requestsSnap = await getDocs(query(collection(db, "graduations"), orderBy("dateSubmitted", "desc")));
                if (requestsSnap.empty) {
                    graduationRequestsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 p-4">No graduation requests received.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                for (const docSnap of requestsSnap.docs) {
                    const req = docSnap.data();
                    const studentUid = docSnap.id; // UID is the document ID for graduation requests
                    const studentDoc = await getDoc(doc(db, "students", studentUid));
                    const studentName = studentDoc.exists() ? studentDoc.data().name : 'N/A';
                    const formattedDate = req.dateSubmitted ? new Date(req.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                    const statusClass = req.status ? req.status.toLowerCase() : 'pending';

                    tableHtml += `
                        <tr>
                            <td>${studentName}</td>
                            <td>${req.admissionNo || 'N/A'}</td>
                            <td>${req.program || 'N/A'}</td>
                            <td>${formattedDate}</td>
                            <td><span class="status-badge ${statusClass}">${req.status}</span></td>
                            <td class="flex gap-2">
                                <button onclick="viewGraduationRequest('${studentUid}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-eye"></i> View</button>
                                <button onclick="deleteGraduationRequest('${studentUid}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                }
                graduationRequestsTableBody.innerHTML = tableHtml;
            } catch (error) {
                console.error("Error loading graduation requests:", error);
                graduationRequestsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-4">Error loading requests.</td></tr>`;
                showCustomAlert("Failed to load graduation requests. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function viewGraduationRequest(uid) {
            loadingOverlay.classList.remove('hidden');
            try {
                const requestDoc = await getDoc(doc(db, "graduations", uid));
                if (!requestDoc.exists()) {
                    showCustomAlert("Graduation request not found.", 'error');
                    return;
                }
                const req = requestDoc.data();
                const studentDoc = await getDoc(doc(db, "students", uid));
                const studentName = studentDoc.exists() ? studentDoc.data().name : 'N/A';

                document.getElementById('gradModalUid').value = uid;
                document.getElementById('gradModalStudentName').textContent = studentName;
                document.getElementById('gradModalAdmNo').textContent = req.admissionNo || 'N/A';
                document.getElementById('gradModalProgram').textContent = req.program || 'N/A';
                document.getElementById('gradModalDateSubmitted').textContent = req.dateSubmitted ? new Date(req.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                
                const currentStatusBadge = document.getElementById('gradModalCurrentStatus');
                currentStatusBadge.textContent = req.status;
                currentStatusBadge.className = `status-badge ${req.status ? req.status.toLowerCase() : 'pending'}`;

                document.getElementById('gradModalStatus').value = req.status || 'Pending';
                document.getElementById('gradModalComments').value = req.comments || '';

                const docsList = document.getElementById('gradModalDocuments');
                docsList.innerHTML = '';
                if (req.clearanceFormUrl) {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-file-pdf mr-2 text-red-500"></i> <a href="${req.clearanceFormUrl}" target="_blank" class="text-blue-600 hover:underline">Clearance Form (PDF)</a>`;
                    docsList.appendChild(li);
                }
                if (req.feeClearanceProofUrl) {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-receipt mr-2 text-green-500"></i> <a href="${req.feeClearanceProofUrl}" target="_blank" class="text-blue-600 hover:underline">Fee Clearance Proof</a>`;
                    docsList.appendChild(li);
                }
                if (!req.clearanceFormUrl && !req.feeClearanceProofUrl) {
                    const li = document.createElement('li');
                    li.textContent = 'No documents uploaded.';
                    docsList.appendChild(li);
                }

                graduationDetailModal.classList.remove('hidden');
            } catch (error) {
                console.error("Error viewing graduation request:", error);
                showCustomAlert("Failed to load graduation request details. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        updateGradStatusForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('gradModalUid').value;
            loadingOverlay.classList.remove('hidden');
            try {
                const newStatus = document.getElementById('gradModalStatus').value;
                const comments = document.getElementById('gradModalComments').value.trim();

                await updateDoc(doc(db, "graduations", uid), {
                    status: newStatus,
                    comments: comments,
                    lastUpdated: serverTimestamp()
                });
                showCustomAlert("Graduation request status updated!", 'success');
                closeModal('graduationDetailModal');
                await loadGraduationRequests();
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error updating graduation status:", error);
                showCustomAlert("Failed to update status. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function deleteGraduationRequest(uid) {
            showCustomConfirm("Are you sure you want to delete this graduation request? This action is irreversible.", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        const requestDoc = await getDoc(doc(db, "graduations", uid));
                        if (requestDoc.exists()) {
                            const req = requestDoc.data();
                            // Delete files from storage if they exist
                            const deletePromises = [];
                            if (req.clearanceFormUrl) {
                                deletePromises.push(deleteObject(ref(storage, req.clearanceFormUrl)));
                            }
                            if (req.feeClearanceProofUrl) {
                                deletePromises.push(deleteObject(ref(storage, req.feeClearanceProofUrl)));
                            }
                            await Promise.all(deletePromises);
                        }
                        await deleteDoc(doc(db, "graduations", uid));
                        showCustomAlert("Graduation request deleted successfully!", 'success');
                        await loadGraduationRequests();
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error deleting graduation request:", error);
                        showCustomAlert("Failed to delete request. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Clearance Requests Functions ---
        const clearanceDepartments = [
            { id: 'finance', name: 'Finance Department' },
            { id: 'library', name: 'Library Services' },
            { id: 'hostel', name: 'Hostel Administration' },
            { id: 'dean', name: 'Dean\'s Office' }
        ];
        const clearanceDetailModal = document.getElementById('clearanceDetailModal');
        const updateClearanceStatusForm = document.getElementById('updateClearanceStatusForm');

        async function loadClearanceRequests() {
            loadingOverlay.classList.remove('hidden');
            const clearanceRequestsTableBody = document.querySelector('#clearanceRequestsTable tbody');
            clearanceRequestsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-4">Loading clearance requests...</td></tr>`;
            try {
                const requestsSnap = await getDocs(query(collection(db, "clearances"), orderBy("dateSubmitted", "desc")));
                if (requestsSnap.empty) {
                    clearanceRequestsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-4">No clearance requests received.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                for (const docSnap of requestsSnap.docs) {
                    const req = docSnap.data();
                    const studentUid = docSnap.id;
                    const studentDoc = await getDoc(doc(db, "students", studentUid));
                    const studentName = studentDoc.exists() ? studentDoc.data().name : 'N/A';
                    const formattedDate = req.dateSubmitted ? new Date(req.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                    const overallStatusClass = req.overallStatus ? req.overallStatus.toLowerCase() : 'pending';

                    tableHtml += `
                        <tr>
                            <td>${studentName}</td>
                            <td>${req.admissionNo || 'N/A'}</td>
                            <td>${formattedDate}</td>
                            <td><span class="status-badge ${overallStatusClass}">${req.overallStatus}</span></td>
                            <td class="flex gap-2">
                                <button onclick="viewClearanceRequest('${studentUid}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-eye"></i> View</button>
                                <button onclick="deleteClearanceRequest('${studentUid}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-trash"></i> Delete</button>
                            </td>
                        </tr>
                    `;
                }
                clearanceRequestsTableBody.innerHTML = tableHtml;
            } catch (error) {
                console.error("Error loading clearance requests:", error);
                clearanceRequestsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 p-4">Error loading requests.</td></tr>`;
                showCustomAlert("Failed to load clearance requests. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function viewClearanceRequest(uid) {
            loadingOverlay.classList.remove('hidden');
            try {
                const requestDoc = await getDoc(doc(db, "clearances", uid));
                if (!requestDoc.exists()) {
                    showCustomAlert("Clearance request not found.", 'error');
                    return;
                }
                const req = requestDoc.data();
                const studentDoc = await getDoc(doc(db, "students", uid));
                const studentName = studentDoc.exists() ? studentDoc.data().name : 'N/A';

                document.getElementById('clearanceModalUid').value = uid;
                document.getElementById('clearanceModalStudentName').textContent = studentName;
                document.getElementById('clearanceModalAdmNo').textContent = req.admissionNo || 'N/A';
                document.getElementById('clearanceModalDateSubmitted').textContent = req.dateSubmitted ? new Date(req.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';
                
                const overallStatusBadge = document.getElementById('clearanceModalOverallStatus');
                overallStatusBadge.textContent = req.overallStatus;
                overallStatusBadge.className = `status-badge ${req.overallStatus ? req.overallStatus.toLowerCase() : 'pending'}`;

                const departmentApprovalForms = document.getElementById('departmentApprovalForms');
                departmentApprovalForms.innerHTML = ''; // Clear previous forms

                clearanceDepartments.forEach(dept => {
                    const approval = req.approvals[dept.id] || { status: "Pending", comments: "" };
                    const div = document.createElement('div');
                    div.className = 'border p-3 rounded-md mb-3 bg-gray-50';
                    div.innerHTML = `
                        <h5 class="font-semibold text-blue-700 mb-2">${dept.name}</h5>
                        <div class="form-group">
                            <label for="status-${dept.id}">Status</label>
                            <select id="status-${dept.id}" class="w-full p-2 border rounded-md">
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="comments-${dept.id}">Comments</label>
                            <textarea id="comments-${dept.id}" rows="2" class="w-full p-2 border rounded-md"></textarea>
                        </div>
                    `;
                    departmentApprovalForms.appendChild(div);
                    document.getElementById(`status-${dept.id}`).value = approval.status;
                    document.getElementById(`comments-${dept.id}`).value = approval.comments;
                });

                clearanceDetailModal.classList.remove('hidden');
            } catch (error) {
                console.error("Error viewing clearance request:", error);
                showCustomAlert("Failed to load clearance request details. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        updateClearanceStatusForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('clearanceModalUid').value;
            loadingOverlay.classList.remove('hidden');
            try {
                const updatedApprovals = {};
                let allApproved = true;
                let anyRejected = false;

                clearanceDepartments.forEach(dept => {
                    const status = document.getElementById(`status-${dept.id}`).value;
                    const comments = document.getElementById(`comments-${dept.id}`).value.trim();
                    updatedApprovals[dept.id] = { status, comments };

                    if (status !== "Approved") allApproved = false;
                    if (status === "Rejected") anyRejected = true;
                });

                let overallStatus = "Pending";
                if (anyRejected) {
                    overallStatus = "Rejected";
                } else if (allApproved) {
                    overallStatus = "Approved";
                }

                await updateDoc(doc(db, "clearances", uid), {
                    approvals: updatedApprovals,
                    overallStatus: overallStatus,
                    lastUpdated: serverTimestamp()
                });
                showCustomAlert("Clearance request approvals updated!", 'success');
                closeModal('clearanceDetailModal');
                await loadClearanceRequests();
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error updating clearance approvals:", error);
                showCustomAlert("Failed to update approvals. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function deleteClearanceRequest(uid) {
            showCustomConfirm("Are you sure you want to delete this clearance request? This action is irreversible.", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await deleteDoc(doc(db, "clearances", uid));
                        showCustomAlert("Clearance request deleted successfully!", 'success');
                        await loadClearanceRequests();
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error deleting clearance request:", error);
                        showCustomAlert("Failed to delete request. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

        // --- Manage Finance Functions ---
        let allStudentsForFinance = [];

        async function loadAllStudentsForFinance() {
            try {
                const studentsSnap = await getDocs(collection(db, "students"));
                const studentUidsDatalist = document.getElementById('financeStudentUids');
                studentUidsDatalist.innerHTML = '';
                allStudentsForFinance = [];
                studentsSnap.forEach(docSnap => {
                    const studentData = docSnap.data();
                    allStudentsForFinance.push({ uid: docSnap.id, ...studentData });
                    const option = document.createElement('option');
                    option.value = docSnap.id;
                    option.textContent = `${studentData.name || 'N/A'} (${docSnap.id})`;
                    studentUidsDatalist.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading students for finance datalist:", error);
                showCustomAlert("Failed to load student data for finance management.", 'error');
            }
        }

        function toggleFinanceActionFields() {
            const action = document.getElementById('financeAction').value;
            const actionFieldsDiv = document.getElementById('financeActionFields');
            const financeForm = document.getElementById('financeForm');

            if (action === 'view') {
                actionFieldsDiv.classList.add('hidden');
            } else {
                actionFieldsDiv.classList.remove('hidden');
                financeForm.reset();
                document.getElementById('submitFinanceAction').textContent = action.replace(/([A-Z])/g, ' $1').trim(); // Pretty button text
            }
        }
        
        document.getElementById('financeStudentId').addEventListener('change', async (e) => {
            const studentUid = e.target.value;
            if (studentUid) {
                await loadFinanceStatementForStudent(studentUid);
            } else {
                // Clear previous finance summary
                document.getElementById('financeTotalFees').textContent = 'KES 0';
                document.getElementById('financeTotalPaid').textContent = 'KES 0';
                document.getElementById('financeBalance').textContent = 'KES 0';
                document.getElementById('financeStudentStatusMessage').textContent = 'Select a student to view finance status...';
                document.getElementById('financeStudentStatusMessage').className = 'finance-status-message mt-4'; // Reset classes
                document.getElementById('financeTransactionsTable').innerHTML = `<tbody><tr><td colspan="5" class="text-center text-gray-500 p-4">Select a student to view transactions.</td></tr></tbody>`;
            }
        });


        window.performFinanceAction = async () => {
            const studentUid = document.getElementById('financeStudentId').value;
            const action = document.getElementById('financeAction').value;

            if (!studentUid) {
                showCustomAlert("Please select a student first.", 'error');
                return;
            }

            document.getElementById('financeFormUid').value = studentUid;

            if (action === 'view') {
                await loadFinanceStatementForStudent(studentUid);
            } else {
                document.getElementById('financeActionFields').classList.remove('hidden');
            }
        };

        document.getElementById('financeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentUid = document.getElementById('financeFormUid').value;
            const action = document.getElementById('financeAction').value;
            const amount = parseFloat(document.getElementById('financeAmount').value);
            const description = document.getElementById('financeDescription').value.trim();

            if (isNaN(amount) || amount <= 0) {
                showCustomAlert("Please enter a valid amount.", 'error');
                return;
            }

            if (!description) {
                showCustomAlert("Please enter a description.", 'error');
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            try {
                // Reference to the main finance document for the student
                const financeDocRef = doc(db, "finance", studentUid);
                const transactionsCollectionRef = collection(db, `finance/${studentUid}/transactions`);

                // Get current finance data to update totals and calculate new balance
                let currentFinanceData = (await getDoc(financeDocRef)).data() || { totalFees: 0, totalPaid: 0, amount: 0 };
                let newOutstandingBalance = currentFinanceData.amount;
                let transactionType = "";

                if (action === 'addFees') {
                    newOutstandingBalance += amount;
                    currentFinanceData.totalFees = (currentFinanceData.totalFees || 0) + amount;
                    transactionType = "Fees Charged";
                } else if (action === 'recordPayment') {
                    newOutstandingBalance -= amount;
                    currentFinanceData.totalPaid = (currentFinanceData.totalPaid || 0) + amount;
                    transactionType = "Payment";
                } else if (action === 'adjustBalance') {
                    newOutstandingBalance += amount;
                    transactionType = amount > 0 ? "Balance Adjustment (+)" : "Balance Adjustment (-)";
                }

                // Update the main finance document (totalFees, totalPaid, outstanding balance)
                await setDoc(financeDocRef, {
                    totalFees: currentFinanceData.totalFees,
                    totalPaid: currentFinanceData.totalPaid,
                    amount: newOutstandingBalance,
                }, { merge: true });

                // Add a transaction record
                await addDoc(transactionsCollectionRef, {
                    date: serverTimestamp(),
                    description: description,
                    type: transactionType,
                    amount: amount,
                    runningBalance: newOutstandingBalance // Store the balance after this transaction
                });

                showCustomAlert(`Finance action "${action.replace(/([A-Z])/g, ' $1').trim()}" completed successfully!`, 'success');
                document.getElementById('financeActionFields').classList.add('hidden'); // Hide form
                document.getElementById('financeForm').reset(); // Reset form fields
                await loadFinanceStatementForStudent(studentUid); // Reload student's finance data
                await loadAdminDashboardOverview(); // Update overview stats
            } catch (error) {
                console.error("Error performing finance action:", error);
                showCustomAlert("Failed to perform finance action. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function loadFinanceStatementForStudent(uid) {
            loadingOverlay.classList.remove('hidden');
            const financeTotalFeesEl = document.getElementById('financeTotalFees');
            const financeTotalPaidEl = document.getElementById('financeTotalPaid');
            const financeBalanceEl = document.getElementById('financeBalance');
            const financeStudentStatusMessageDiv = document.getElementById('financeStudentStatusMessage');
            const financeTransactionsTableBody = document.querySelector('#financeTransactionsTable tbody');

            financeTotalFeesEl.textContent = 'KES Loading...';
            financeTotalPaidEl.textContent = 'KES Loading...';
            financeBalanceEl.textContent = 'KES Loading...';
            financeStudentStatusMessageDiv.textContent = 'Loading finance status...';
            financeStudentStatusMessageDiv.classList.remove('cleared', 'pending');
            financeTransactionsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-4">Loading transactions...</td></tr>`;

            try {
                // Fetch the main finance document for the student
                const financeDocRef = doc(db, "finance", uid);
                const financeSnap = await getDoc(financeDocRef);

                let totalFees = 0;
                let totalPaid = 0;
                let outstandingBalance = 0;

                if (financeSnap.exists()) {
                    const data = financeSnap.data();
                    totalFees = data.totalFees || 0;
                    totalPaid = data.totalPaid || 0;
                    outstandingBalance = data.amount || (totalFees - totalPaid); // Recalculate if 'amount' is missing
                }

                financeTotalFeesEl.textContent = `KES ${totalFees.toLocaleString()}`;
                financeTotalPaidEl.textContent = `KES ${totalPaid.toLocaleString()}`;
                financeBalanceEl.textContent = `KES ${outstandingBalance.toLocaleString()}`;

                if (outstandingBalance <= 0) {
                    financeStudentStatusMessageDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Student has cleared all their fees. ✅`;
                    financeStudentStatusMessageDiv.classList.remove('pending');
                    financeStudentStatusMessageDiv.classList.add('cleared');
                } else {
                    financeStudentStatusMessageDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> Student has an outstanding balance. ⚠️`;
                    financeStudentStatusMessageDiv.classList.remove('cleared');
                    financeStudentStatusMessageDiv.classList.add('pending');
                }

                // Fetch transactions for the student
                const transactionsCollectionRef = collection(db, `finance/${uid}/transactions`);
                const transactionsQuery = query(transactionsCollectionRef, orderBy("date", "desc"));
                const transactionsSnap = await getDocs(transactionsQuery);

                if (transactionsSnap.empty) {
                    financeTransactionsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-4">No transactions recorded for this student.</td></tr>`;
                } else {
                    let tableHtml = '';
                    transactionsSnap.forEach(docSnap => {
                        const txn = docSnap.data();
                        const txnDate = txn.date ? new Date(txn.date.seconds * 1000).toLocaleDateString() : 'N/A';
                        const amount = `KES ${Number(txn.amount || 0).toLocaleString()}`;
                        const runningBalance = `KES ${Number(txn.runningBalance || 0).toLocaleString()}`;

                        tableHtml += `
                            <tr>
                                <td>${txnDate}</td>
                                <td>${txn.description || 'N/A'}</td>
                                <td>${txn.type || 'N/A'}</td>
                                <td class="text-right">${amount}</td>
                                <td class="text-right">${runningBalance}</td>
                            </tr>
                        `;
                    });
                    financeTransactionsTableBody.innerHTML = tableHtml;
                }

            } catch (error) {
                console.error("Error loading finance statement for student:", error);
                showCustomAlert("Failed to load student's finance data. Please try again.", 'error');
                financeTotalFeesEl.textContent = 'KES Error';
                financeTotalPaidEl.textContent = 'KES Error';
                financeBalanceEl.textContent = 'KES Error';
                financeStudentStatusMessageDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> Error loading finance data.`;
                financeStudentStatusMessageDiv.classList.add('pending');
                financeTransactionsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 p-4">Error loading transactions.</td></tr>`;
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // --- Manage Admins & Roles Functions ---
        const adminForm = document.getElementById('adminForm');
        const editAdminUidField = document.getElementById('editAdminUid');
        const saveAdminBtn = document.getElementById('saveAdminBtn');
        const cancelEditAdminBtn = document.getElementById('cancelEditAdminBtn');

        async function loadAdmins() {
            loadingOverlay.classList.remove('hidden');
            const adminsTableBody = document.querySelector('#adminsTable tbody');
            adminsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 p-4">Loading admins...</td></tr>`;
            try {
                const adminsSnap = await getDocs(collection(db, "admins"));
                if (adminsSnap.empty) {
                    adminsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 p-4">No admin accounts configured.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                for (const docSnap of adminsSnap.docs) {
                    const admin = docSnap.data();
                    const adminUid = docSnap.id;
                    if (admin.isAdmin) { // Only show active admins
                        let email = admin.email || 'N/A';
                        
                        // Try to get email from Firebase Auth for the UID if not in Firestore doc
                        if (email === 'N/A') {
                            try {
                                // IMPORTANT: This is a client-side workaround. A real admin panel
                                // would use Firebase Admin SDK on a backend to fetch user data by UID.
                                // Client-side cannot directly fetch other users' emails by UID without Admin SDK.
                                // For this demo, we'll assume the email is stored in the admin doc or display UID.
                                // As a fallback, try to match with students collection for email if it's a student UID.
                                const studentDoc = await getDoc(doc(db, "students", adminUid));
                                if (studentDoc.exists()) {
                                    email = studentDoc.data().email || 'N/A';
                                }
                            } catch (e) {
                                console.warn(`Could not fetch email for UID ${adminUid} from Auth/Students:`, e);
                            }
                        }

                        tableHtml += `
                            <tr>
                                <td>${adminUid}</td>
                                <td>${email}</td>
                                <td>${admin.role || 'Not Assigned'}</td>
                                <td class="flex gap-2">
                                    <button onclick="editAdmin('${adminUid}')" class="btn-primary text-xs px-2 py-1"><i class="fas fa-edit"></i> Edit</button>
                                    <button onclick="removeAdmin('${adminUid}')" class="btn-red text-xs px-2 py-1"><i class="fas fa-user-times"></i> Remove Admin</button>
                                </td>
                            </tr>
                        `;
                    }
                }
                adminsTableBody.innerHTML = tableHtml;
                resetAdminForm();
            } catch (error) {
                console.error("Error loading admins:", error);
                adminsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 p-4">Error loading admins.</td></tr>`;
                showCustomAlert("Failed to load admin accounts. Please try again.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function resetAdminForm() {
            adminForm.reset();
            editAdminUidField.value = '';
            document.getElementById('adminUserUid').readOnly = false;
            saveAdminBtn.textContent = 'Add Admin';
            cancelEditAdminBtn.classList.add('hidden');
        }

        adminForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');
            try {
                const userUid = document.getElementById('adminUserUid').value.trim();
                const role = document.getElementById('adminRole').value;

                if (!userUid) {
                    showCustomAlert("Please enter a User UID.", 'error');
                    return;
                }

                // Check if this UID corresponds to a valid Firebase Auth user (optional, but good practice)
                // This is difficult client-side. A server-side solution would be better.
                // For this demo, we'll assume the UID is valid.

                const adminData = {
                    isAdmin: true,
                    role: role,
                    // You might want to store the email here if it's not the UID,
                    // but for simplicity, the UID is the primary identifier.
                };

                const editAdminId = editAdminUidField.value;
                if (editAdminId) {
                    // Update existing admin
                    await updateDoc(doc(db, "admins", editAdminId), adminData);
                    showCustomAlert("Admin role updated successfully!", 'success');
                } else {
                    // Add new admin
                    // Ensure a student profile exists for this UID, if not, create a basic one
                    const studentDocRef = doc(db, "students", userUid);
                    const studentSnap = await getDoc(studentDocRef);
                    if (!studentSnap.exists()) {
                         await setDoc(studentDocRef, { 
                             email: userUid + "@unknown.com", // Placeholder email if Auth email not available
                             name: "Admin User",
                             createdAt: serverTimestamp(),
                             isActive: true
                         }, { merge: true });
                         console.warn(`Created basic student profile for new admin UID: ${userUid}`);
                    }


                    await setDoc(doc(db, "admins", userUid), adminData, { merge: true }); // Use setDoc with merge to create or update
                    showCustomAlert("User granted admin privileges successfully!", 'success');
                }
                await loadAdmins();
                await loadAdminDashboardOverview(); // Update stats
            } catch (error) {
                console.error("Error saving admin:", error);
                showCustomAlert("Failed to save admin. Please ensure the UID is correct.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function editAdmin(uid) {
            loadingOverlay.classList.remove('hidden');
            try {
                const adminDoc = await getDoc(doc(db, "admins", uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomAlert("Admin not found.", 'error');
                    return;
                }
                const adminData = adminDoc.data();
                editAdminUidField.value = uid;
                document.getElementById('adminUserUid').value = uid;
                document.getElementById('adminUserUid').readOnly = true; // UID should not be changed for an existing admin
                document.getElementById('adminRole').value = adminData.role || 'Superadmin';

                saveAdminBtn.textContent = 'Update Admin Role';
                cancelEditAdminBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error editing admin:", error);
                showCustomAlert("Failed to load admin for editing.", 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function removeAdmin(uid) {
            showCustomConfirm("Are you sure you want to remove admin privileges for this user? They will no longer be able to access the admin panel.", 'delete', async (confirmed) => {
                if (confirmed) {
                    loadingOverlay.classList.remove('hidden');
                    try {
                        await updateDoc(doc(db, "admins", uid), { isAdmin: false, role: null }); // Set isAdmin to false
                        showCustomAlert("Admin privileges removed successfully!", 'success');
                        await loadAdmins();
                        await loadAdminDashboardOverview(); // Update stats
                    } catch (error) {
                        console.error("Error removing admin privileges:", error);
                        showCustomAlert("Failed to remove admin privileges. Please try again.", 'error');
                    } finally {
                        loadingOverlay.classList.add('hidden');
                    }
                }
            });
        }

    </script>
</body>
</html>
