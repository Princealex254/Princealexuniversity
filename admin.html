<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Full Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small visual nicety */
    .side-link.active { background: rgba(255,255,255,0.08); }
    
    /* Loading Spinner Styles */
    #loadingSpinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      transition: opacity 0.3s ease;
      opacity: 0;
      visibility: hidden;
    }
    
    #loadingSpinner.show {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div id="loadingSpinner">
    <div class="spinner"></div>
  </div>

  <div id="popup" class="fixed top-4 left-1/2 -translate-x-1/2 hidden z-50 max-w-xl w-full px-4">
    <div id="popupInner" class="p-3 rounded shadow text-white flex justify-between items-center"></div>
  </div>

  <header class="bg-gradient-to-r from-sky-600 to-indigo-600 text-white p-4 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <button id="hamburger" class="md:hidden p-2 bg-white/10 rounded">☰</button>
      <div class="text-lg font-bold">University Admin Dashboard</div>
    </div>
    <div class="text-sm">Connected Project: <span id="projectLabel" class="font-medium">universityweb</span></div>
  </header>

  <div class="flex">
    <aside id="sidebar" class="hidden md:block w-64 bg-white border-r min-h-screen p-4 space-y-3">
      <nav>
        <button class="side-link block w-full text-left p-2 rounded" data-view="dashboard">🏠 Dashboard</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="students">👨‍🎓 Students</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="admins">🛡️ Admins</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="clearance">✅ Clearance</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="courseReg">📚 Courses</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="registrations">📝 Registrations</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="examCard">📄 Exam Cards</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="finance">💳 Finance</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="grades">🧮 Grades</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="graduation">🎓 Graduation</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="hostels">🏨 Hostels</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="timetable">📅 Timetable</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="profile">🔎 Profile</button>
        <button class="side-link block w-full text-left p-2 rounded" data-view="settings">⚙️ Settings</button>
      </nav>
    </aside>

    <main class="flex-1 p-6 overflow-y-auto">
      <section id="view-dashboard" class="view">
        <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Total students</div>
            <div id="stat_total_students" class="text-2xl font-semibold">—</div>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Active students</div>
            <div id="stat_active_students" class="text-2xl font-semibold">—</div>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Admins</div>
            <div id="stat_admins" class="text-2xl font-semibold">—</div>
          </div>
          <div class="p-4 bg-white rounded shadow">
            <div class="text-sm text-gray-500">Pending clearance</div>
            <div id="stat_pending_clearance" class="text-2xl font-semibold">—</div>
          </div>
        </div>
      </section>

      <section id="view-students" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Students</h2>
          <div class="flex gap-2">
            <input id="students_search" placeholder="Search name / admissionNo / email" class="border p-2 rounded" />
            <button id="students_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
            <button id="students_new" class="bg-gray-200 px-3 py-2 rounded">New</button>
          </div>
        </div>

        <div class="overflow-x-auto bg-white rounded shadow">
          <table class="w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 border">Name</th>
                <th class="p-2 border">Admission No</th>
                <th class="p-2 border">Email</th>
                <th class="p-2 border">Programme</th>
                <th class="p-2 border">Year</th>
                <th class="p-2 border">Active</th>
                <th class="p-2 border">Actions</th>
              </tr>
            </thead>
            <tbody id="students_tbody">
              <tr><td colspan="7" class="p-4 text-center text-gray-500">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mt-6 bg-white rounded shadow p-4">
          <h3 class="font-semibold mb-2">Add / Edit Student</h3>
          <form id="studentForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="stu_id" type="hidden" />
            <input id="stu_name" placeholder="name" class="border p-2 rounded" />
            <input id="stu_admissionNo" placeholder="admissionNo (LMC/94/16)" class="border p-2 rounded" />
            <input id="stu_email" placeholder="email" class="border p-2 rounded" />
            <input id="stu_regNo" placeholder="regNo" class="border p-2 rounded" />
            <input id="stu_programme" placeholder="programme" class="border p-2 rounded" />
            <input id="stu_yearOfStudy" type="number" placeholder="yearOfStudy (2025)" class="border p-2 rounded" />
            <input id="stu_campus" placeholder="campus (Main)" class="border p-2 rounded" />
            <input id="stu_address" placeholder="address" class="border p-2 rounded" />
            <label class="flex items-center gap-2"><input id="stu_isActive" type="checkbox" /> isActive</label>
            <div class="md:col-span-3 flex gap-2">
              <button id="stu_save" type="button" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
              <button id="stu_clear" type="button" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
            </div>
          </form>
        </div>
      </section>

      <section id="view-admins" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Admins</h2>
          <button id="admins_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
        </div>

        <div class="bg-white p-4 rounded shadow mb-4">
          <form id="adminForm" class="flex gap-2">
            <input id="admin_email" placeholder="admin email" class="border p-2 rounded flex-1" />
            <button id="admin_add" type="button" class="bg-green-600 text-white px-4 py-2 rounded">Add Admin</button>
          </form>
        </div>

        <div id="admins_list" class="bg-white p-4 rounded shadow">
          Loading admins…
        </div>
      </section>

      <section id="view-clearance" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Clearance Requests</h2>
          <button id="clearance_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
        </div>
        <div class="bg-white rounded shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100"><tr>
              <th class="p-2 border">Student Email</th>
              <th class="p-2 border">Reason</th>
              <th class="p-2 border">Status</th>
              <th class="p-2 border">Departments</th>
              <th class="p-2 border">Actions</th>
            </tr></thead>
            <tbody id="clearance_tbody"></tbody>
          </table>
        </div>
      </section>

      <section id="view-courseReg" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Courses (courses collection)</h2>
          <div class="flex gap-2">
            <button id="courses_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
          </div>
        </div>

        <div class="bg-white rounded shadow p-4 mb-4">
          <form id="courseForm" class="grid md:grid-cols-4 gap-3">
            <input id="course_id" type="hidden"/>
            <input id="course_courseCode" placeholder="courseCode" class="border p-2 rounded" />
            <input id="course_courseName" placeholder="courseName" class="border p-2 rounded" />
            <input id="course_department" placeholder="department" class="border p-2 rounded" />
            <input id="course_semester" placeholder="semester" class="border p-2 rounded" />
            <input id="course_yearOfStudy" placeholder="yearOfStudy" class="border p-2 rounded" />
            <div class="md:col-span-4 flex gap-2">
              <button id="course_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Course</button>
              <button id="course_clear" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
            </div>
          </form>
        </div>

        <div class="bg-white rounded shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100"><tr><th class="p-2 border">Code</th><th class="p-2 border">Name</th><th class="p-2 border">Dept</th><th class="p-2 border">Sem</th><th class="p-2 border">Year</th><th class="p-2 border">Actions</th></tr></thead>
            <tbody id="courses_tbody"></tbody>
          </table>
        </div>
      </section>

      <section id="view-registrations" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Registrations (registrations/{uid}/courses)</h2>
          <div class="flex gap-2">
            <input id="reg_search" placeholder="Search email / admissionNo" class="border p-2 rounded" />
            <button id="reg_search_btn" class="bg-sky-600 text-white px-3 py-2 rounded">Search</button>
          </div>
        </div>

        <div id="reg_panel" class="hidden bg-white rounded shadow p-4">
          <h3 class="font-semibold">Registered Courses</h3>
          <div id="reg_list" class="mt-3"></div>
          <h4 class="mt-4 font-semibold">Add by course ID</h4>
          <div class="flex gap-2 mt-2">
            <input id="reg_courseId" placeholder="course doc id" class="border p-2 rounded flex-1" />
            <button id="reg_add" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
          </div>
        </div>
      </section>

      <section id="view-examCard" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Exam Card</h2>
          <div class="flex gap-2">
            <input id="exam_search" placeholder="Search email / admissionNo" class="border p-2 rounded" />
            <button id="exam_search_btn" class="bg-sky-600 text-white px-3 py-2 rounded">Search</button>
          </div>
        </div>

        <div id="exam_panel" class="hidden bg-white rounded shadow p-4">
          <div id="exam_table" class="overflow-x-auto"></div>
          <div class="mt-4">
            <button id="exam_download" class="bg-indigo-600 text-white px-4 py-2 rounded">Download (simple table export)</button>
          </div>
        </div>
      </section>

      <section id="view-finance" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Finance</h2>
          <div class="flex gap-2">
            <input id="fin_uid" placeholder="Student UID" class="border p-2 rounded" />
            <button id="fin_load" class="bg-sky-600 text-white px-3 py-2 rounded">Load</button>
          </div>
        </div>

        <div id="fin_panel" class="hidden bg-white rounded shadow p-4">
          <div class="grid md:grid-cols-3 gap-4">
            <div>Total Fees: <div id="fin_total">KES 0</div></div>
            <div>Total Paid: <div id="fin_paid">KES 0</div></div>
            <div>Balance: <div id="fin_balance">KES 0</div></div>
          </div>

          <div class="mt-4">
            <h4 class="font-semibold">Add Transaction</h4>
            <div class="grid md:grid-cols-4 gap-2 mt-2">
              <input id="txn_method" placeholder="method" class="border p-2 rounded" />
              <input id="txn_reference" placeholder="reference" class="border p-2 rounded" />
              <input id="txn_amount" type="number" placeholder="amount" class="border p-2 rounded" />
              <select id="txn_status" class="border p-2 rounded">
                <option>Confirmed</option>
                <option>Pending</option>
                <option>Failed</option>
              </select>
              <div class="md:col-span-4 mt-2">
                <button id="txn_add" class="bg-green-600 text-white px-4 py-2 rounded">Add Transaction</button>
              </div>
            </div>
          </div>

          <div id="txn_list" class="mt-4"></div>
        </div>
      </section>

      <section id="view-grades" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Grades</h2>
          <div class="flex gap-2">
            <input id="grades_search" placeholder="Search email / admissionNo" class="border p-2 rounded" />
            <button id="grades_search_btn" class="bg-sky-600 text-white px-3 py-2 rounded">Search</button>
          </div>
        </div>

        <div id="grades_panel" class="hidden bg-white rounded shadow p-4">
          <h4 class="font-semibold">Add / Update Result</h4>
          <div class="grid md:grid-cols-6 gap-2 mt-2">
            <input id="gr_code" placeholder="code" class="border p-2 rounded" />
            <input id="gr_title" placeholder="title" class="border p-2 rounded" />
            <input id="gr_credits" type="number" placeholder="credits" class="border p-2 rounded" />
            <input id="gr_grade" placeholder="grade" class="border p-2 rounded" />
            <input id="gr_points" type="number" step="0.01" placeholder="gpaPoints" class="border p-2 rounded" />
            <div class="flex gap-2">
              <input id="gr_year" type="number" placeholder="year" class="border p-2 rounded" />
              <input id="gr_sem" type="number" placeholder="semester" class="border p-2 rounded" />
            </div>
            <div class="md:col-span-6 mt-2">
              <button id="gr_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Result</button>
            </div>
          </div>

          <div id="grades_list" class="mt-4"></div>
        </div>
      </section>

      <section id="view-graduation" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Graduation Requests</h2>
          <button id="grad_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
        </div>
        <div class="bg-white rounded shadow overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100"><tr><th class="p-2 border">Student</th><th class="p-2 border">Status</th><th class="p-2 border">Requested</th><th class="p-2 border">Actions</th></tr></thead>
            <tbody id="graduation_tbody"></tbody>
          </table>
        </div>
      </section>

      <section id="view-hostels" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Hostels & Rooms</h2>
          <div class="flex gap-2">
            <button id="hostels_refresh" class="bg-sky-600 text-white px-3 py-2 rounded">Refresh</button>
            <button id="hostels_recalc" class="bg-indigo-600 text-white px-3 py-2 rounded">Recalc Availability</button>
          </div>
        </div>

        <div class="bg-white rounded shadow p-4 mb-4">
          <h4 class="font-semibold">Add / Edit Hostel</h4>
          <div class="grid md:grid-cols-4 gap-2 mt-2">
            <input id="hostel_id" type="hidden"/>
            <input id="hostel_name" placeholder="name" class="border p-2 rounded" />
            <input id="hostel_gender" placeholder="gender" class="border p-2 rounded" />
            <input id="hostel_capacity" type="number" placeholder="capacity" class="border p-2 rounded" />
            <input id="hostel_available" type="number" placeholder="available" class="border p-2 rounded" />
            <div class="md:col-span-4 mt-2">
              <button id="hostel_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Hostel</button>
            </div>
          </div>
        </div>

        <div id="hostels_list" class="bg-white rounded shadow p-4"></div>

        <div class="bg-white rounded shadow p-4 mt-4">
          <h4 class="font-semibold">Rooms (select hostel to manage rooms below)</h4>
          <div class="grid md:grid-cols-4 gap-2 mt-2">
            <input id="room_hostelId" placeholder="hostelId" class="border p-2 rounded" />
            <input id="room_id" type="hidden" />
            <input id="room_number" placeholder="number" class="border p-2 rounded" />
            <input id="room_capacity" type="number" placeholder="capacity" class="border p-2 rounded" />
            <input id="room_occupants" type="number" placeholder="occupants" class="border p-2 rounded" />
            <div class="md:col-span-4 mt-2">
              <button id="room_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Room</button>
              <button id="room_load" class="bg-gray-200 px-4 py-2 rounded ml-2">Load Rooms</button>
            </div>
          </div>

          <div id="rooms_list" class="mt-4"></div>
        </div>
      </section>

      <section id="view-timetable" class="view hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-semibold">Timetable</h2>
          <div class="flex gap-2">
            <input id="timetable_search" placeholder="Search email / admissionNo" class="border p-2 rounded" />
            <button id="timetable_search_btn" class="bg-sky-600 text-white px-3 py-2 rounded">Search</button>
          </div>
        </div>

        <div id="timetable_panel" class="hidden bg-white rounded shadow p-4">
          <h4 class="font-semibold">Schedule JSON (array of {day,time,courseCode,venue})</h4>
          <textarea id="timetable_json" rows="6" class="w-full border p-2 rounded"></textarea>
          <div class="mt-2">
            <button id="timetable_save" class="bg-green-600 text-white px-4 py-2 rounded">Save Timetable</button>
          </div>
        </div>
      </section>

      <section id="view-profile" class="view hidden">
        <h2 class="text-2xl font-semibold mb-4">Profile Management</h2>
        <div class="flex gap-2 mb-4">
          <input id="profile_search" placeholder="Search by admissionNo / regNo / email" class="border p-2 rounded flex-1"/>
          <button id="profile_search_btn" class="bg-sky-600 text-white px-3 py-2 rounded">Search</button>
        </div>
        <div id="profile_result" class="bg-white rounded shadow p-4 hidden"></div>
      </section>

      <section id="view-settings" class="view hidden">
        <h2 class="text-2xl font-semibold mb-4">Settings</h2>
        <div class="bg-white p-4 rounded shadow">
          <h4 class="font-semibold">Password Reset</h4>
          <div class="flex gap-2 mt-2">
            <input id="reset_email" placeholder="student email" class="border p-2 rounded flex-1"/>
            <button id="reset_send" class="bg-red-600 text-white px-4 py-2 rounded">Send Reset Email</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Note: Client can trigger password reset email; changing Auth email/password fully requires Admin SDK.</p>
        </div>
      </section>

    </main>
  </div>

  <script type="module">
    // Firebase imports (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, getDoc, doc, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /* ---------- popup helper (6s) ---------- */
    let popupTimeout = null;
    function showPopup(message, type="info") {
      clearTimeout(popupTimeout);
      const container = document.getElementById('popup');
      const inner = document.getElementById('popupInner');
      inner.textContent = message;
      inner.className = 'p-3 rounded shadow text-white flex justify-between items-center';
      if (type === 'success') inner.classList.add('bg-green-600'); 
      else if (type === 'error') inner.classList.add('bg-red-600');
      else inner.classList.add('bg-sky-600');
      container.classList.remove('hidden');
      popupTimeout = setTimeout(()=> container.classList.add('hidden'), 6000);
      document.getElementById('popupClose').onclick = ()=> container.classList.add('hidden');
    }

    /* ---------- Loading Spinner Functions ---------- */
    function showLoading() {
      document.getElementById('loadingSpinner').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingSpinner').classList.remove('show');
    }

    /* ---------- view switch ---------- */
    const views = Array.from(document.querySelectorAll('.view'));
    function showView(viewId) {
      views.forEach(v=>v.classList.add('hidden'));
      const el = document.getElementById('view-' + viewId.replace('view-','').replace('view-','') )
      // we used id naming like view-students; but side uses data-view -> map:
      const map = {
        dashboard: 'view-dashboard',
        students: 'view-students',
        admins: 'view-admins',
        clearance: 'view-clearance',
        courseReg: 'view-courseReg',
        registrations: 'view-registrations',
        examCard: 'view-examCard',
        finance: 'view-finance',
        grades: 'view-grades',
        graduation: 'view-graduation',
        hostels: 'view-hostels',
        timetable: 'view-timetable',
        profile: 'view-profile',
        settings: 'view-settings'
      };
      const id = map[viewId] || 'view-dashboard';
      document.getElementById(id).classList.remove('hidden');
      // highlight sidebar
      document.querySelectorAll('.side-link').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.side-link[data-view]').forEach(b=>{
        if (b.dataset.view === viewId) b.classList.add('active');
      });
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Sidebar button wiring (desktop)
    document.querySelectorAll('.side-link').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const v = btn.dataset.view;
        showView(v);
      });
    });
    // Hamburger
    document.getElementById('hamburger').addEventListener('click', ()=>{
      document.getElementById('sidebar').classList.toggle('hidden');
    });

    /* ---------- DASHBOARD stats ---------- */
    async function refreshDashboardStats(){
      showLoading();
      try {
        const sSnap = await getDocs(collection(db,'students'));
        document.getElementById('stat_total_students').textContent = sSnap.size;
        let active = 0;
        sSnap.forEach(d=> { if (d.data().isActive) active++; });
        document.getElementById('stat_active_students').textContent = active;

        const aSnap = await getDocs(collection(db,'admins'));
        document.getElementById('stat_admins').textContent = aSnap.size;

        const cSnap = await getDocs(collection(db,'clearanceRequests'));
        let pending = 0;
        cSnap.forEach(d=> { if ((d.data().status||'').toLowerCase() === 'pending') pending++; });
        document.getElementById('stat_pending_clearance').textContent = pending;
      } catch (e) {
        console.error(e);
        showPopup('Error loading stats: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }

    /* ========== STUDENTS CRUD (exact fields) ========== */
    const studentsTbody = document.getElementById('students_tbody');
    const studentsSearch = document.getElementById('students_search');
    async function loadStudents(){
      showLoading();
      studentsTbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Loading…</td></tr>';
      try {
        const snap = await getDocs(collection(db,'students'));
        studentsTbody.innerHTML = '';
        const rows = [];
        snap.forEach(d=> rows.push({ id: d.id, ...d.data() }));
        // simple render
        rows.forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border">${escapeHtml(s.name||'')}</td>
            <td class="p-2 border">${escapeHtml(s.admissionNo||'')}</td>
            <td class="p-2 border">${escapeHtml(s.email||'')}</td>
            <td class="p-2 border">${escapeHtml(s.programme||'')}</td>
            <td class="p-2 border">${escapeHtml(s.yearOfStudy||'')}</td>
            <td class="p-2 border">${s.isActive ? '✅' : '❌'}</td>
            <td class="p-2 border">
              <button data-id="${s.id}" class="stu_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
              <button data-id="${s.id}" class="stu_delete ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
            </td>
          `;
          studentsTbody.appendChild(tr);
        });
        // wire edit/delete
        document.querySelectorAll('.stu_edit').forEach(btn=>{
          btn.addEventListener('click', async ()=> {
            showLoading();
            try {
              const id = btn.dataset.id;
              const snap = await getDoc(doc(db,'students',id));
              if (!snap.exists()) return showPopup('Student not found','error');
              const s = snap.data();
              document.getElementById('stu_id').value = id;
              document.getElementById('stu_name').value = s.name || '';
              document.getElementById('stu_admissionNo').value = s.admissionNo || '';
              document.getElementById('stu_email').value = s.email || '';
              document.getElementById('stu_regNo').value = s.regNo || '';
              document.getElementById('stu_programme').value = s.programme || '';
              document.getElementById('stu_yearOfStudy').value = s.yearOfStudy || '';
              document.getElementById('stu_campus').value = s.campus || '';
              document.getElementById('stu_address').value = s.address || '';
              document.getElementById('stu_isActive').checked = !!s.isActive;
              showPopup('Loaded student into form','info');
              showView('students');
            } finally {
              hideLoading();
            }
          });
        });
        document.querySelectorAll('.stu_delete').forEach(btn=>{
          btn.addEventListener('click', async ()=> {
            if (!confirm('Delete student record?')) return;
            showLoading();
            try {
              await deleteDoc(doc(db,'students',btn.dataset.id));
              showPopup('Student deleted','success');
              await loadStudents();
              await refreshDashboardStats();
            } finally {
              hideLoading();
            }
          });
        });
      } catch (e) {
        console.error(e);
        studentsTbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-600">Error loading students</td></tr>`;
        showPopup('Error loading students: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // student form save
    document.getElementById('stu_save').addEventListener('click', async ()=>{
      showLoading();
      const id = document.getElementById('stu_id').value.trim();
      const payload = {
        name: document.getElementById('stu_name').value.trim(),
        admissionNo: document.getElementById('stu_admissionNo').value.trim(),
        email: document.getElementById('stu_email').value.trim(),
        regNo: document.getElementById('stu_regNo').value.trim(),
        programme: document.getElementById('stu_programme').value.trim(),
        yearOfStudy: Number(document.getElementById('stu_yearOfStudy').value) || null,
        campus: document.getElementById('stu_campus').value.trim(),
        address: document.getElementById('stu_address').value.trim(),
        isActive: !!document.getElementById('stu_isActive').checked,
        // keep createdAt if exists; if creating set serverTimestamp
      };
      try {
        if (id) {
          await updateDoc(doc(db,'students',id), { ...payload, updatedAt: serverTimestamp() });
          showPopup('Student updated','success');
        } else {
          payload.createdAt = serverTimestamp();
          const ref = await addDoc(collection(db,'students'), payload);
          showPopup('Student created (id: '+ref.id+')','success');
        }
        document.getElementById('studentForm').reset();
        document.getElementById('stu_id').value = '';
        await loadStudents();
        await refreshDashboardStats();
      } catch (e) {
        console.error(e);
        showPopup('Error saving student: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    });

    document.getElementById('stu_clear').addEventListener('click', ()=>{
      document.getElementById('studentForm').reset();
      document.getElementById('stu_id').value = '';
    });

    document.getElementById('students_refresh').addEventListener('click', loadStudents);
    document.getElementById('students_new').addEventListener('click', ()=>{
      document.getElementById('studentForm').reset();
      document.getElementById('stu_id').value = '';
      showPopup('Ready for new student','info');
    });

    studentsSearch.addEventListener('input', ()=>{
      const q = studentsSearch.value.trim().toLowerCase();
      document.querySelectorAll('#students_tbody tr').forEach(tr=>{
        tr.style.display = q === '' ? '' : (tr.textContent.toLowerCase().includes(q) ? '' : 'none');
      });
    });

    /* ========== ADMINS ========== */
    async function loadAdmins(){
      showLoading();
      const container = document.getElementById('admins_list');
      try {
        const snap = await getDocs(collection(db,'admins'));
        container.innerHTML = '';
        if (snap.empty) container.textContent = 'No admins';
        else {
          snap.forEach(d=>{
            const item = d.data();
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 border-b';
            div.innerHTML = `<div class="text-sm">${escapeHtml(item.email||d.id)}</div> <div><button data-id="${d.id}" class="admin_remove bg-red-600 text-white px-2 py-1 rounded text-xs">Remove</button></div>`;
            container.appendChild(div);
          });
          document.querySelectorAll('.admin_remove').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              if (!confirm('Remove this admin?')) return;
              showLoading();
              try {
                await deleteDoc(doc(db,'admins',btn.dataset.id));
                showPopup('Admin removed','success');
                loadAdmins();
                refreshDashboardStats();
              } finally {
                hideLoading();
              }
            });
          });
        }
      } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="text-red-600">Error loading admins</div>';
        showPopup('Error loading admins: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }

    document.getElementById('admin_add').addEventListener('click', async ()=>{
      showLoading();
      const email = document.getElementById('admin_email').value.trim();
      if (!email) return showPopup('Enter admin email','error');
      try {
        await addDoc(collection(db,'admins'), { email, createdAt: serverTimestamp() });
        showPopup('Admin added','success');
        document.getElementById('admin_email').value = '';
        loadAdmins();
        refreshDashboardStats();
      } catch (e) {
        console.error(e);
        showPopup('Error adding admin: ' + e.message,'error');
      } finally {
        hideLoading();
      }
    });

    document.getElementById('admins_refresh').addEventListener('click', loadAdmins);

    /* ========== CLEARANCE ========== */
    async function loadClearance(){
      showLoading();
      const tbody = document.getElementById('clearance_tbody');
      tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading…</td></tr>';
      try {
        const snap = await getDocs(collection(db,'clearanceRequests'));
        tbody.innerHTML = '';
        snap.forEach(d=>{
          const c = d.data();
          const deps = c.departments || { Finance:'Pending', Library:'Pending', Hostel:'Pending', Dean:'Pending' };
          const depHtml = Object.entries(deps).map(([k,v])=>`<div class="inline-block mr-2 px-2 py-0.5 rounded text-xs ${v==='Cleared'?'bg-green-100 text-green-800':v==='Rejected'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}">${k}: ${v}</div>`).join('');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border">${escapeHtml(c.email||d.id)}</td>
            <td class="p-2 border">${escapeHtml(c.reason||'')}</td>
            <td class="p-2 border">${escapeHtml(c.status||'')}</td>
            <td class="p-2 border">${depHtml}</td>
            <td class="p-2 border">
              <select data-id="${d.id}" class="dep_select border p-1 rounded text-sm">
                <option>Finance</option><option>Library</option><option>Hostel</option><option>Dean</option>
              </select>
              <select data-val="${d.id}" class="dep_val border p-1 rounded text-sm">
                <option>Pending</option><option>Cleared</option><option>Rejected</option>
              </select>
              <button data-apply="${d.id}" class="ml-1 bg-blue-600 text-white px-2 py-1 rounded text-xs">Apply</button>
              <button data-clear="${d.id}" class="ml-1 bg-green-600 text-white px-2 py-1 rounded text-xs">Mark All Cleared</button>
              <button data-rej="${d.id}" class="ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        // wire apply
        document.querySelectorAll('[data-apply]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            showLoading();
            try {
              const id = btn.dataset.apply;
              const dep = document.querySelector(`.dep_select[data-id='${id}']`).value;
              const val = document.querySelector(`.dep_val[data-val='${id}']`).value;
              const ref = doc(db,'clearanceRequests',id);
              const snap = await getDoc(ref);
              if (!snap.exists()) return showPopup('Request not found','error');
              const data = snap.data();
              const departments = data.departments || { Finance:'Pending', Library:'Pending', Hostel:'Pending', Dean:'Pending' };
              departments[dep] = val;
              await updateDoc(ref, { departments, updatedAt: serverTimestamp() });
              showPopup(`Set ${dep} → ${val}`,'success');
              loadClearance();
            } finally {
              hideLoading();
            }
          });
        });
        document.querySelectorAll('[data-clear]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Mark request as Cleared?')) return;
            showLoading();
            try {
              await updateDoc(doc(db,'clearanceRequests',btn.dataset.clear), { status: 'Cleared', updatedAt: serverTimestamp() });
              showPopup('Request marked Cleared','success');
              loadClearance();
              refreshDashboardStats();
            } finally {
              hideLoading();
            }
          });
        });
        document.querySelectorAll('[data-rej]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Reject this request?')) return;
            showLoading();
            try {
              await updateDoc(doc(db,'clearanceRequests',btn.dataset.rej), { status: 'Rejected', updatedAt: serverTimestamp() });
              showPopup('Request rejected','success');
              loadClearance();
              refreshDashboardStats();
            } finally {
              hideLoading();
            }
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-red-600">Error loading</td></tr>`;
        showPopup('Error loading clearance: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('clearance_refresh').addEventListener('click', loadClearance);

    /* ========== COURSES (courses collection) ========== */
    async function loadCourses(){
      showLoading();
      const tbody = document.getElementById('courses_tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Loading…</td></tr>';
      try {
        const snap = await getDocs(collection(db,'courses'));
        tbody.innerHTML = '';
        snap.forEach(d=>{
          const c = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2 border">${escapeHtml(c.courseCode||'')}</td> <td class="p-2 border">${escapeHtml(c.courseName||'')}</td> <td class="p-2 border">${escapeHtml(c.department||'')}</td> <td class="p-2 border">${escapeHtml(c.semester||'')}</td> <td class="p-2 border">${escapeHtml(c.yearOfStudy||'')}</td> <td class="p-2 border"> <button data-id="${d.id}" class="course_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button> <button data-id="${d.id}" class="course_del ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button> </td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.course_edit').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            showLoading();
            try {
              const id = btn.dataset.id;
              const snap = await getDoc(doc(db,'courses',id));
              if (!snap.exists()) return showPopup('Course not found','error');
              const c = snap.data();
              document.getElementById('course_id').value = id;
              document.getElementById('course_courseCode').value = c.courseCode || '';
              document.getElementById('course_courseName').value = c.courseName || '';
              document.getElementById('course_department').value = c.department || '';
              document.getElementById('course_semester').value = c.semester || '';
              document.getElementById('course_yearOfStudy').value = c.yearOfStudy || '';
              showPopup('Loaded course into form','info');
            } finally {
              hideLoading();
            }
          });
        });
        document.querySelectorAll('.course_del').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Delete this course?')) return;
            showLoading();
            try {
              await deleteDoc(doc(db,'courses',btn.dataset.id));
              showPopup('Course deleted','success');
              loadCourses();
            } finally {
              hideLoading();
            }
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-red-600">Error loading courses</td></tr>`;
        showPopup('Error loading courses: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }

    // course form save
    document.getElementById('course_save').addEventListener('click', async ()=>{
      showLoading();
      const id = document.getElementById('course_id').value.trim();
      const payload = {
        courseCode: document.getElementById('course_courseCode').value.trim(),
        courseName: document.getElementById('course_courseName').value.trim(),
        department: document.getElementById('course_department').value.trim(),
        semester: document.getElementById('course_semester').value.trim(),
        yearOfStudy: document.getElementById('course_yearOfStudy').value.trim(),
        updatedAt: serverTimestamp()
      };
      try {
        if (id) {
          await updateDoc(doc(db,'courses',id), payload);
          showPopup('Course updated','success');
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db,'courses'), payload);
          showPopup('Course added','success');
        }
        document.getElementById('courseForm').reset();
        document.getElementById('course_id').value = '';
        await loadCourses();
      } catch (e) {
        console.error(e);
        showPopup('Error saving course: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    document.getElementById('courses_refresh').addEventListener('click', loadCourses);
    document.getElementById('course_clear').addEventListener('click', ()=>{
      document.getElementById('courseForm').reset();
      document.getElementById('course_id').value = '';
    });

    /* ========== REGISTRATIONS ========== */
    async function searchRegistrations(){
      showLoading();
      const queryStr = document.getElementById('reg_search').value.trim();
      if (!queryStr) return showPopup('Enter student email or admissionNo','error');
      const panel = document.getElementById('reg_panel');
      panel.classList.add('hidden');
      const list = document.getElementById('reg_list');
      list.innerHTML = '';
      try {
        const student = await findStudentByQuery(queryStr);
        if (!student) return showPopup('Student not found','error');
        const uid = student.id;
        document.getElementById('reg_panel').dataset.uid = uid;

        const snap = await getDocs(collection(db, 'registrations', uid, 'courses'));
        if (snap.empty) list.textContent = 'No courses registered.';
        else {
          snap.forEach(d=>{
            const course = d.data();
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 border-b';
            div.innerHTML = `<div class="text-sm">${escapeHtml(course.courseCode||'')} - ${escapeHtml(course.courseName||'')}</div> <div><button data-id="${d.id}" class="reg_del bg-red-600 text-white px-2 py-1 rounded text-xs">Remove</button></div>`;
            list.appendChild(div);
          });
          document.querySelectorAll('.reg_del').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              if (!confirm('Remove this course?')) return;
              showLoading();
              try {
                await deleteDoc(doc(db, 'registrations', uid, 'courses', btn.dataset.id));
                showPopup('Course removed','success');
                searchRegistrations();
              } finally {
                hideLoading();
              }
            });
          });
        }
        panel.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showPopup('Error searching registrations: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('reg_search_btn').addEventListener('click', searchRegistrations);

    document.getElementById('reg_add').addEventListener('click', async ()=>{
      showLoading();
      const uid = document.getElementById('reg_panel').dataset.uid;
      const courseId = document.getElementById('reg_courseId').value.trim();
      if (!uid) return showPopup('Search for a student first','error');
      if (!courseId) return showPopup('Enter a course ID','error');
      try {
        const courseSnap = await getDoc(doc(db,'courses',courseId));
        if (!courseSnap.exists()) return showPopup('Course not found','error');
        const courseData = courseSnap.data();
        await setDoc(doc(db, 'registrations', uid, 'courses', courseId), courseData);
        showPopup('Course added','success');
        document.getElementById('reg_courseId').value = '';
        searchRegistrations();
      } catch (e) {
        console.error(e);
        showPopup('Error adding course: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    /* ========== EXAM CARD ========== */
    async function generateExamCard(){
      showLoading();
      const queryStr = document.getElementById('exam_search').value.trim();
      if (!queryStr) return showPopup('Enter student email or admissionNo','error');
      const panel = document.getElementById('exam_panel');
      panel.classList.add('hidden');
      const tableDiv = document.getElementById('exam_table');
      tableDiv.innerHTML = '';
      try {
        const student = await findStudentByQuery(queryStr);
        if (!student) return showPopup('Student not found','error');
        const uid = student.id;
        const studentData = student.data();
        const courseSnap = await getDocs(collection(db, 'registrations', uid, 'courses'));
        if (courseSnap.empty) return showPopup('No courses registered for this student','info');
        
        const table = document.createElement('table');
        table.className = 'w-full text-sm border-collapse';
        table.innerHTML = `
          <thead>
            <tr><th class="border p-2" colspan="4">Exam Card for ${escapeHtml(studentData.name||'')}</th></tr>
            <tr><th class="border p-2">Course Code</th><th class="border p-2">Course Name</th><th class="border p-2">Semester</th><th class="border p-2">Year</th></tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        courseSnap.forEach(d=>{
          const course = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border p-2">${escapeHtml(course.courseCode||'')}</td>
            <td class="border p-2">${escapeHtml(course.courseName||'')}</td>
            <td class="border p-2">${escapeHtml(course.semester||'')}</td>
            <td class="border p-2">${escapeHtml(course.yearOfStudy||'')}</td>
          `;
          tbody.appendChild(tr);
        });
        tableDiv.appendChild(table);
        panel.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showPopup('Error generating exam card: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('exam_search_btn').addEventListener('click', generateExamCard);

    document.getElementById('exam_download').addEventListener('click', ()=>{
      const table = document.getElementById('exam_table').querySelector('table');
      if (!table) return;
      const html = table.outerHTML;
      const blob = new Blob([html], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'exam_card.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    /* ========== FINANCE ========== */
    async function loadFinance(){
      showLoading();
      const uid = document.getElementById('fin_uid').value.trim();
      const panel = document.getElementById('fin_panel');
      const totalFeesEl = document.getElementById('fin_total');
      const totalPaidEl = document.getElementById('fin_paid');
      const balanceEl = document.getElementById('fin_balance');
      const txnListEl = document.getElementById('txn_list');
      panel.classList.add('hidden');
      txnListEl.innerHTML = 'Loading transactions...';

      if (!uid) return showPopup('Enter a student UID','error');

      try {
        const feesDoc = await getDoc(doc(db,'fees',uid));
        const txnsSnap = await getDocs(collection(db,'fees',uid,'transactions'));
        
        const feesData = feesDoc.exists() ? feesDoc.data() : { totalFees: 0 };
        totalFeesEl.textContent = `KES ${feesData.totalFees || 0}`;

        let totalPaid = 0;
        const txns = [];
        txnsSnap.forEach(d=>{
          const txn = d.data();
          txns.push(txn);
          if (txn.status === 'Confirmed') totalPaid += txn.amount || 0;
        });

        totalPaidEl.textContent = `KES ${totalPaid}`;
        balanceEl.textContent = `KES ${(feesData.totalFees || 0) - totalPaid}`;

        txnListEl.innerHTML = '';
        if (txns.length === 0) {
          txnListEl.textContent = 'No transactions found.';
        } else {
          const list = document.createElement('ul');
          list.className = 'space-y-2';
          txns.forEach(txn=>{
            const li = document.createElement('li');
            li.className = 'p-2 border rounded shadow-sm';
            li.innerHTML = `
              Method: ${escapeHtml(txn.method||'')} |
              Reference: ${escapeHtml(txn.reference||'')} |
              Amount: KES ${txn.amount||0} |
              Status: ${escapeHtml(txn.status||'')}
            `;
            list.appendChild(li);
          });
          txnListEl.appendChild(list);
        }

        panel.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showPopup('Error loading finance data: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('fin_load').addEventListener('click', loadFinance);

    document.getElementById('txn_add').addEventListener('click', async ()=>{
      showLoading();
      const uid = document.getElementById('fin_uid').value.trim();
      const method = document.getElementById('txn_method').value.trim();
      const reference = document.getElementById('txn_reference').value.trim();
      const amount = Number(document.getElementById('txn_amount').value);
      const status = document.getElementById('txn_status').value.trim();

      if (!uid) return showPopup('Load a student UID first','error');
      if (!method || !reference || !amount || !status) return showPopup('Fill all transaction fields','error');

      try {
        await addDoc(collection(db,'fees',uid,'transactions'), {
          method, reference, amount, status,
          createdAt: serverTimestamp()
        });
        showPopup('Transaction added','success');
        document.getElementById('txn_method').value = '';
        document.getElementById('txn_reference').value = '';
        document.getElementById('txn_amount').value = '';
        loadFinance();
      } catch (e) {
        console.error(e);
        showPopup('Error adding transaction: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    /* ========== GRADES ========== */
    async function searchGrades(){
      showLoading();
      const queryStr = document.getElementById('grades_search').value.trim();
      const panel = document.getElementById('grades_panel');
      panel.classList.add('hidden');
      if (!queryStr) return showPopup('Enter student email or admissionNo','error');

      try {
        const student = await findStudentByQuery(queryStr);
        if (!student) return showPopup('Student not found','error');
        const uid = student.id;
        document.getElementById('grades_panel').dataset.uid = uid;

        const snap = await getDocs(collection(db, 'grades', uid, 'results'));
        const gradesListEl = document.getElementById('grades_list');
        gradesListEl.innerHTML = '';
        if (snap.empty) {
          gradesListEl.textContent = 'No grades found.';
        } else {
          const list = document.createElement('ul');
          list.className = 'space-y-2';
          snap.forEach(d=>{
            const result = d.data();
            const li = document.createElement('li');
            li.className = 'p-2 border rounded shadow-sm flex justify-between items-center';
            li.innerHTML = `
              <div class="text-sm">
                ${escapeHtml(result.code||'')} - ${escapeHtml(result.title||'')}
                (Grade: ${escapeHtml(result.grade||'')}, Points: ${result.gpaPoints||0})
              </div>
              <div>
                <button data-id="${d.id}" class="grade_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
                <button data-id="${d.id}" class="grade_del ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
              </div>
            `;
            list.appendChild(li);
          });
          gradesListEl.appendChild(list);
          document.querySelectorAll('.grade_edit').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              showLoading();
              try {
                const id = btn.dataset.id;
                const snap = await getDoc(doc(db, 'grades', uid, 'results', id));
                if (!snap.exists()) return showPopup('Grade not found','error');
                const g = snap.data();
                document.getElementById('gr_id').value = id;
                document.getElementById('gr_code').value = g.code || '';
                document.getElementById('gr_title').value = g.title || '';
                document.getElementById('gr_credits').value = g.credits || '';
                document.getElementById('gr_grade').value = g.grade || '';
                document.getElementById('gr_points').value = g.gpaPoints || '';
                document.getElementById('gr_year').value = g.year || '';
                document.getElementById('gr_sem').value = g.semester || '';
                showPopup('Loaded grade for editing','info');
              } finally {
                hideLoading();
              }
            });
          });
          document.querySelectorAll('.grade_del').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              if (!confirm('Delete this grade?')) return;
              showLoading();
              try {
                await deleteDoc(doc(db, 'grades', uid, 'results', btn.dataset.id));
                showPopup('Grade deleted','success');
                searchGrades();
              } finally {
                hideLoading();
              }
            });
          });
        }
        panel.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showPopup('Error searching grades: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('grades_search_btn').addEventListener('click', searchGrades);

    document.getElementById('gr_save').addEventListener('click', async ()=>{
      showLoading();
      const uid = document.getElementById('grades_panel').dataset.uid;
      const payload = {
        code: document.getElementById('gr_code').value.trim(),
        title: document.getElementById('gr_title').value.trim(),
        credits: Number(document.getElementById('gr_credits').value) || null,
        grade: document.getElementById('gr_grade').value.trim(),
        gpaPoints: Number(document.getElementById('gr_points').value) || null,
        year: Number(document.getElementById('gr_year').value) || null,
        semester: Number(document.getElementById('gr_sem').value) || null,
        updatedAt: serverTimestamp()
      };
      if (!uid) return showPopup('Search for a student first','error');
      try {
        if (document.getElementById('gr_id').value) {
          await updateDoc(doc(db,'grades',uid,'results',document.getElementById('gr_id').value), payload);
          showPopup('Grade updated','success');
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db,'grades',uid,'results'), payload);
          showPopup('Grade added','success');
        }
        document.getElementById('gradesForm').reset();
        document.getElementById('gr_id').value = '';
        searchGrades();
      } catch (e) {
        console.error(e);
        showPopup('Error saving grade: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    /* ========== GRADUATION ========== */
    async function loadGraduation(){
      showLoading();
      const tbody = document.getElementById('graduation_tbody');
      tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Loading…</td></tr>';
      try {
        const snap = await getDocs(collection(db,'graduationRequests'));
        tbody.innerHTML = '';
        snap.forEach(d=>{
          const r = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2 border">${escapeHtml(r.studentEmail||'')}</td>
            <td class="p-2 border">${escapeHtml(r.status||'')}</td>
            <td class="p-2 border">${r.requestedAt?.toDate().toLocaleString()||'—'}</td>
            <td class="p-2 border">
              <button data-id="${d.id}" class="grad_approve bg-green-600 text-white px-2 py-1 rounded text-xs">Approve</button>
              <button data-id="${d.id}" class="grad_reject ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.grad_approve').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Approve this graduation request?')) return;
            showLoading();
            try {
              await updateDoc(doc(db,'graduationRequests',btn.dataset.id), { status: 'Approved', updatedAt: serverTimestamp() });
              showPopup('Request approved','success');
              loadGraduation();
            } finally {
              hideLoading();
            }
          });
        });
        document.querySelectorAll('.grad_reject').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Reject this graduation request?')) return;
            showLoading();
            try {
              await updateDoc(doc(db,'graduationRequests',btn.dataset.id), { status: 'Rejected', updatedAt: serverTimestamp() });
              showPopup('Request rejected','success');
              loadGraduation();
            } finally {
              hideLoading();
            }
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-red-600">Error loading</td></tr>`;
        showPopup('Error loading graduation requests: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('grad_refresh').addEventListener('click', loadGraduation);

    /* ========== HOSTELS ========== */
    async function loadHostels(){
      showLoading();
      const list = document.getElementById('hostels_list');
      list.innerHTML = 'Loading hostels…';
      try {
        const snap = await getDocs(collection(db,'hostels'));
        list.innerHTML = '';
        snap.forEach(d=>{
          const h = d.data();
          const div = document.createElement('div');
          div.className = 'p-3 border rounded shadow-sm mb-2';
          div.innerHTML = `
            <div class="font-semibold">${escapeHtml(h.name||'')} (${escapeHtml(h.gender||'')})</div>
            <div class="text-sm">Capacity: ${h.capacity||0} | Available: ${h.available||0}</div>
            <div class="mt-2">
              <button data-id="${d.id}" class="hostel_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
              <button data-id="${d.id}" class="hostel_del ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
              <button data-id="${d.id}" class="hostel_manage_rooms ml-1 bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs">Manage Rooms</button>
            </div>
          `;
          list.appendChild(div);
        });
        document.querySelectorAll('.hostel_edit').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            showLoading();
            try {
              const id = btn.dataset.id;
              const snap = await getDoc(doc(db,'hostels',id));
              if (!snap.exists()) return showPopup('Hostel not found','error');
              const h = snap.data();
              document.getElementById('hostel_id').value = id;
              document.getElementById('hostel_name').value = h.name || '';
              document.getElementById('hostel_gender').value = h.gender || '';
              document.getElementById('hostel_capacity').value = h.capacity || '';
              document.getElementById('hostel_available').value = h.available || '';
              showPopup('Loaded hostel for editing','info');
            } finally {
              hideLoading();
            }
          });
        });
        document.querySelectorAll('.hostel_del').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if (!confirm('Delete this hostel?')) return;
            showLoading();
            try {
              await deleteDoc(doc(db,'hostels',btn.dataset.id));
              showPopup('Hostel deleted','success');
              loadHostels();
            } finally {
              hideLoading();
            }
          });
        });
        document.querySelectorAll('.hostel_manage_rooms').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            document.getElementById('room_hostelId').value = btn.dataset.id;
            loadRooms();
          });
        });
      } catch (e) {
        console.error(e);
        list.innerHTML = '<div class="text-red-600">Error loading hostels</div>';
        showPopup('Error loading hostels: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('hostel_save').addEventListener('click', async ()=>{
      showLoading();
      const id = document.getElementById('hostel_id').value.trim();
      const payload = {
        name: document.getElementById('hostel_name').value.trim(),
        gender: document.getElementById('hostel_gender').value.trim(),
        capacity: Number(document.getElementById('hostel_capacity').value),
        available: Number(document.getElementById('hostel_available').value)
      };
      try {
        if (id) {
          await updateDoc(doc(db,'hostels',id), { ...payload, updatedAt: serverTimestamp() });
          showPopup('Hostel updated','success');
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db,'hostels'), payload);
          showPopup('Hostel added','success');
        }
        document.getElementById('hostelForm').reset();
        document.getElementById('hostel_id').value = '';
        loadHostels();
      } catch (e) {
        console.error(e);
        showPopup('Error saving hostel: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });
    document.getElementById('hostels_refresh').addEventListener('click', loadHostels);
    document.getElementById('hostels_recalc').addEventListener('click', async ()=>{
      showLoading();
      try {
        const snap = await getDocs(collection(db,'hostels'));
        for (const h of snap.docs) {
          const roomsSnap = await getDocs(collection(db,'hostels',h.id,'rooms'));
          let totalOccupants = 0;
          let totalCapacity = 0;
          roomsSnap.forEach(d=>{
            const r = d.data();
            totalOccupants += r.occupants || 0;
            totalCapacity += r.capacity || 0;
          });
          const available = totalCapacity - totalOccupants;
          await updateDoc(doc(db,'hostels',h.id), { capacity: totalCapacity, available, updatedAt: serverTimestamp() });
        }
        showPopup('Hostel availability recalculated','success');
        loadHostels();
      } catch (e) {
        console.error(e);
        showPopup('Error recalculating availability: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    async function loadRooms(){
      showLoading();
      const hostelId = document.getElementById('room_hostelId').value.trim();
      const list = document.getElementById('rooms_list');
      list.innerHTML = 'Loading rooms…';
      if (!hostelId) return;
      try {
        const snap = await getDocs(collection(db,'hostels',hostelId,'rooms'));
        list.innerHTML = '';
        if (snap.empty) list.textContent = 'No rooms found.';
        else {
          snap.forEach(d=>{
            const r = d.data();
            const div = document.createElement('div');
            div.className = 'p-2 border rounded shadow-sm mb-1 flex justify-between items-center';
            div.innerHTML = `
              <div>Room #${escapeHtml(r.number||'')} (${r.occupants||0}/${r.capacity||0})</div>
              <div>
                <button data-id="${d.id}" class="room_edit bg-blue-600 text-white px-2 py-1 rounded text-xs">Edit</button>
                <button data-id="${d.id}" class="room_del ml-1 bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
              </div>
            `;
            list.appendChild(div);
          });
          document.querySelectorAll('.room_edit').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              showLoading();
              try {
                const id = btn.dataset.id;
                const snap = await getDoc(doc(db,'hostels',hostelId,'rooms',id));
                if (!snap.exists()) return showPopup('Room not found','error');
                const r = snap.data();
                document.getElementById('room_id').value = id;
                document.getElementById('room_number').value = r.number || '';
                document.getElementById('room_capacity').value = r.capacity || '';
                document.getElementById('room_occupants').value = r.occupants || '';
                showPopup('Loaded room for editing','info');
              } finally {
                hideLoading();
              }
            });
          });
          document.querySelectorAll('.room_del').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              if (!confirm('Delete this room?')) return;
              showLoading();
              try {
                await deleteDoc(doc(db,'hostels',hostelId,'rooms',btn.dataset.id));
                showPopup('Room deleted','success');
                loadRooms();
                document.getElementById('hostels_recalc').click();
              } finally {
                hideLoading();
              }
            });
          });
        }
      } catch (e) {
        console.error(e);
        list.innerHTML = '<div class="text-red-600">Error loading rooms</div>';
        showPopup('Error loading rooms: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }

    document.getElementById('room_save').addEventListener('click', async ()=>{
      showLoading();
      const hostelId = document.getElementById('room_hostelId').value.trim();
      if (!hostelId) return showPopup('Select a hostel first','error');
      const id = document.getElementById('room_id').value.trim();
      const payload = {
        number: document.getElementById('room_number').value.trim(),
        capacity: Number(document.getElementById('room_capacity').value),
        occupants: Number(document.getElementById('room_occupants').value)
      };
      try {
        if (id) {
          await updateDoc(doc(db,'hostels',hostelId,'rooms',id), { ...payload, updatedAt: serverTimestamp() });
          showPopup('Room updated','success');
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db,'hostels',hostelId,'rooms'), payload);
          showPopup('Room added','success');
        }
        document.getElementById('roomForm').reset();
        document.getElementById('room_id').value = '';
        loadRooms();
        document.getElementById('hostels_recalc').click();
      } catch (e) {
        console.error(e);
        showPopup('Error saving room: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    document.getElementById('room_load').addEventListener('click', loadRooms);

    /* ========== TIMETABLE ========== */
    async function searchTimetable(){
      showLoading();
      const queryStr = document.getElementById('timetable_search').value.trim();
      const panel = document.getElementById('timetable_panel');
      panel.classList.add('hidden');
      const jsonTextarea = document.getElementById('timetable_json');
      jsonTextarea.value = '';
      if (!queryStr) return showPopup('Enter student email or admissionNo','error');

      try {
        const student = await findStudentByQuery(queryStr);
        if (!student) return showPopup('Student not found','error');
        const uid = student.id;
        document.getElementById('timetable_panel').dataset.uid = uid;
        const snap = await getDoc(doc(db,'timetables',uid));
        if (snap.exists() && snap.data().schedule) {
          jsonTextarea.value = JSON.stringify(snap.data().schedule, null, 2);
        } else {
          jsonTextarea.value = '[]';
        }
        panel.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showPopup('Error searching timetable: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('timetable_search_btn').addEventListener('click', searchTimetable);

    document.getElementById('timetable_save').addEventListener('click', async ()=>{
      showLoading();
      const uid = document.getElementById('timetable_panel').dataset.uid;
      if (!uid) return showPopup('Search for a student first','error');
      try {
        const schedule = JSON.parse(document.getElementById('timetable_json').value);
        if (!Array.isArray(schedule)) throw new Error('Schedule must be a JSON array');
        await setDoc(doc(db,'timetables',uid), { schedule, updatedAt: serverTimestamp() });
        showPopup('Timetable saved','success');
      } catch (e) {
        console.error(e);
        showPopup('Error saving timetable: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    /* ========== PROFILE MANAGEMENT ========== */
    async function searchProfile(){
      showLoading();
      const queryStr = document.getElementById('profile_search').value.trim();
      const resultDiv = document.getElementById('profile_result');
      resultDiv.classList.add('hidden');
      if (!queryStr) return showPopup('Enter search query','error');
      try {
        const student = await findStudentByQuery(queryStr);
        if (!student) return showPopup('Student not found','error');
        const studentData = student.data();
        resultDiv.innerHTML = `
          <h4 class="font-semibold">Student Profile</h4>
          <div><b>Name:</b> ${escapeHtml(studentData.name||'—')}</div>
          <div><b>Admission No:</b> ${escapeHtml(studentData.admissionNo||'—')}</div>
          <div><b>Email:</b> ${escapeHtml(studentData.email||'—')}</div>
          <div><b>Programme:</b> ${escapeHtml(studentData.programme||'—')}</div>
          <div><b>Year of Study:</b> ${escapeHtml(studentData.yearOfStudy||'—')}</div>
          <div><b>Reg No:</b> ${escapeHtml(studentData.regNo||'—')}</div>
          <div><b>Campus:</b> ${escapeHtml(studentData.campus||'—')}</div>
          <div><b>Address:</b> ${escapeHtml(studentData.address||'—')}</div>
        `;
        resultDiv.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showPopup('Error searching profile: '+e.message,'error');
      } finally {
        hideLoading();
      }
    }
    document.getElementById('profile_search_btn').addEventListener('click', searchProfile);

    /* ========== SETTINGS (password reset) ========== */
    document.getElementById('reset_send').addEventListener('click', async ()=>{
      showLoading();
      const email = document.getElementById('reset_email').value.trim();
      if (!email) return showPopup('Enter email','error');
      try {
        await sendPasswordResetEmail(auth, email);
        showPopup('Password reset email sent','success');
      } catch (e) {
        console.error(e);
        showPopup('Error sending reset: '+e.message,'error');
      } finally {
        hideLoading();
      }
    });

    /* ========== Utilities & initial load ========== */
    function escapeHtml(s='') {
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    
    async function findStudentByQuery(queryStr) {
      showLoading();
      try {
        const q = queryStr.trim();
        if (!q) return null;
        let snapshot = await getDocs(query(collection(db, 'students'), where('email', '==', q)));
        if (snapshot.empty) {
          snapshot = await getDocs(query(collection(db, 'students'), where('admissionNo', '==', q)));
        }
        if (snapshot.empty) {
          snapshot = await getDocs(query(collection(db, 'students'), where('regNo', '==', q)));
        }
        return snapshot.empty ? null : snapshot.docs[0];
      } finally {
        hideLoading();
      }
    }

    // initial
    (async function init(){
      showView('dashboard');
      showLoading();
      try {
        await refreshDashboardStats();
        await loadStudents();
        await loadAdmins();
        await loadCourses();
        await loadClearance();
        await loadGraduation();
        await loadHostels();
      } finally {
        hideLoading();
      }
    })();
  </script>
</body>
</html>
