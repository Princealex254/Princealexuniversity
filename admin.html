<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel — Prince Alex Design University</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGJK5bR7C8e6jG1LMlC/j/cXuw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --bg:#f6f8fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --primary:#065f46; --primary-600:#047857; --ring:rgba(0,0,0,.06);
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text);}    
    /* Topbar */
    header { position: sticky; top:0; z-index:50; display:flex; align-items:center; justify-content:space-between; padding:12px 18px; background:var(--card); box-shadow: 0 2px 12px var(--ring);}    
    header .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
    header img.logo { width:36px; height:36px; object-fit:cover; border-radius:8px; }
    header .actions { display:flex; align-items:center; gap:10px; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .btn.primary { background: var(--primary); border-color: var(--primary); color:#fff; }
    .btn.primary:hover { background: var(--primary-600);} 

    /* Layout */
    .layout { display:flex; min-height: calc(100vh - 60px);}    
    .sidebar { width: 230px; background: var(--card); border-right:1px solid #e5e7eb; padding:14px; position:sticky; top:60px; height: calc(100vh - 60px); overflow:auto; }
    .menu { display:flex; flex-direction:column; gap:6px; }
    .menu .item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color: var(--text); cursor:pointer; }
    .menu .item:hover { background:#f3f4f6; }
    .menu .item.active { background:#ecfdf5; color: var(--primary); font-weight:600; }

    .main { flex:1; padding:24px; }

    /* Section header */
    .section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .section-title { display:flex; align-items:center; gap:10px; font-size:1.25rem; font-weight:700; }

    /* Cards grid */
    .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:18px; }
    .card { background: var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:16px; box-shadow: 0 6px 14px var(--ring); }
    .card h4 { margin:0 0 8px; font-size:1rem; }
    .card .value { font-size:1.6rem; font-weight:800; }
    .card .muted { color: var(--muted); font-size:.85rem; }

    /* Tables */
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { padding:12px; border-bottom:1px solid #ececec; text-align:left; }
    .table th { font-size:.85rem; color: var(--muted); font-weight:600; }

    /* Empty state */
    .empty { background: #f9fafb; border:1px dashed #e5e7eb; border-radius:14px; padding:32px; text-align:center; color:var(--muted);}    
    .empty i { font-size:28px; margin-bottom:8px; color:#c7cdd6; }

    /* Forms */
    .form { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:.9rem; color: var(--muted);} 
    .field input, .field select { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }

    /* Loader & toast */
    #overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.8); z-index:100; }
    .spinner { width:36px; height:36px; border:4px solid #e5e7eb; border-top-color: var(--primary); border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }

    .toast { position: fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:12px 14px; border-radius:12px; display:none; z-index:99; box-shadow:0 8px 20px rgba(0,0,0,.25); }

    /* Auth view */
    #login { display:none; max-width:380px; margin:48px auto; background: var(--card); padding:24px; border-radius:16px; box-shadow:0 10px 24px var(--ring); border:1px solid #e5e7eb; }
    #login h2 { margin:0 0 12px; }
    #login .field { margin-bottom:10px; }

    /* Responsive tweaks */
    @media (max-width: 920px) {
      .sidebar { position: fixed; left:-260px; transition: left .2s ease; }
      .sidebar.open { left:0; }
      .main { padding:18px; }
      header .hide-mobile { display:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img class="logo" src="myschoollogo.png" alt="Logo" />
      <span>Admin Panel</span>
    </div>
    <div class="actions">
      <button id="toggleSidebar" class="btn" title="Menu"><i class="fa-solid fa-bars"></i></button>
      <span class="hide-mobile" id="whoami">—</span>
      <button id="logoutBtn" class="btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <nav class="menu" id="menu">
        <div class="item active" data-view="dashboard"><i class="fa-solid fa-gauge"></i> Dashboard</div>
        <div class="item" data-view="students"><i class="fa-solid fa-user-graduate"></i> Students</div>
        <div class="item" data-view="courses"><i class="fa-solid fa-book"></i> Courses</div>
        <div class="item" data-view="registrations"><i class="fa-solid fa-clipboard-list"></i> Registrations</div>
        <div class="item" data-view="announcements"><i class="fa-solid fa-bullhorn"></i> Announcements</div>
        <div class="item" data-view="settings"><i class="fa-solid fa-gear"></i> Settings</div>
      </nav>
    </aside>

    <main class="main" id="main">
      <!-- Views render here -->
    </main>
  </div>

  <div id="overlay"><div class="spinner"></div></div>
  <div class="toast" id="toast"></div>

  <!-- Login View -->
  <section id="login">
    <h2>Admin Login</h2>
    <div class="field"><label>Email</label><input id="email" type="email" placeholder="admin@example.com" /></div>
    <div class="field"><label>Password</label><input id="password" type="password" placeholder="••••••••" /></div>
    <button class="btn primary" id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> Sign In</button>
    <div id="loginHint" class="muted" style="margin-top:10px; font-size:.9rem; color:var(--muted);">Use a Firebase Auth user whose UID exists in <code>admins/{uid}</code> with <code>isAdmin: true</code>.</div>
  </section>

  <script type="module">
    /********************
     * Firebase (v11.6.1)
     ********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // === Replace with your project's config (left here as working sample from your previous snippet) ===
    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /********************
     * UI Utilities
     ********************/
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const overlay = qs('#overlay');
    const toastEl = qs('#toast');
    function loading(on) { overlay.style.display = on ? 'flex' : 'none'; }
    function toast(msg, ms=2600) { toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=> toastEl.style.display='none', ms); }

    // Simple view router
    const main = qs('#main');
    const views = {
      dashboard: renderDashboard,
      students: renderStudents,
      courses: renderCourses,
      registrations: renderRegistrations,
      announcements: renderAnnouncements,
      settings: renderSettings,
    };

    // Menu interactions
    const menu = qs('#menu');
    menu.addEventListener('click', (e) => {
      const item = e.target.closest('.item');
      if (!item) return;
      qsa('.menu .item').forEach(i=> i.classList.remove('active'));
      item.classList.add('active');
      const view = item.dataset.view;
      if (views[view]) views[view]();
    });

    qs('#toggleSidebar').addEventListener('click', () => {
      qs('#sidebar').classList.toggle('open');
    });

    /********************
     * Auth Flow — UID-based admins
     ********************/
    const loginView = qs('#login');
    const whoami = qs('#whoami');
    const logoutBtn = qs('#logoutBtn');

    onAuthStateChanged(auth, async (user) => {
      loading(true);
      if (!user) {
        showLogin();
        loading(false);
        return;
      }

      whoami.textContent = user.email || '—';

      try {
        // Admin check: admins/{uid} must exist and have isAdmin == true
        const adminRef = doc(db, 'admins', user.uid);
        const adminSnap = await getDoc(adminRef);
        if (!adminSnap.exists()) {
          showLogin();
          loading(false);
          toast('No admin record found for this user.');
          await signOut(auth);
          return;
        }
        if (adminSnap.data().isAdmin !== true) {
          showLogin();
          loading(false);
          toast('User is not authorized as admin.');
          await signOut(auth);
          return;
        }

        // Authorized → render default view
        renderDashboard();
        loading(false);
      } catch (err) {
        console.error('Admin check error:', err);
        toast('Login error: ' + err.message);
        showLogin();
        loading(false);
      }
    });

    function showLogin() {
      loginView.style.display = 'block';
      qs('.layout').style.display = 'none';
    }
    function showApp() {
      loginView.style.display = 'none';
      qs('.layout').style.display = 'flex';
    }

    // Login button
    qs('#loginBtn').addEventListener('click', async () => {
      const email = qs('#email').value.trim();
      const password = qs('#password').value;
      if (!email || !password) { toast('Enter email and password'); return; }
      try {
        loading(true);
        await signInWithEmailAndPassword(auth, email, password);
        showApp();
        // onAuthStateChanged will continue the admin check
      } catch (err) {
        console.error('Sign-in error', err);
        toast(err.message);
      } finally { loading(false); }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      toast('Signed out');
      showLogin();
    });

    /********************
     * Views
     ********************/
    async function renderDashboard() {
      showApp();
      main.innerHTML = `
        <div class="section-header">
          <div class="section-title"><i class="fa-solid fa-gauge"></i> Dashboard</div>
          <div>
            <button class="btn" id="refreshDash"><i class="fa-solid fa-rotate"></i> Refresh</button>
          </div>
        </div>
        <div class="cards" id="dashCards">
          <div class="card"><h4>Total Students</h4><div class="value" id="statStudents">0</div><div class="muted">All-time</div></div>
          <div class="card"><h4>Courses</h4><div class="value" id="statCourses">0</div><div class="muted">Active</div></div>
          <div class="card"><h4>Registrations</h4><div class="value" id="statRegs">0</div><div class="muted">Current term</div></div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h4>Recent Registrations</h4>
          <table class="table" id="recentRegs">
            <thead><tr><th>Student</th><th>Course</th><th>Date</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="recentRegsEmpty" style="display:none;">
            <i class="fa-solid fa-database"></i>
            <div>No registrations yet.</div>
            <small>When students register, they will show up here.</small>
          </div>
        </div>
      `;

      // Load stats (with empty-state safety)
      try {
        const [studentsSnap, coursesSnap, regsSnap] = await Promise.all([
          getDocs(collection(db, 'students')),
          getDocs(collection(db, 'courses')),
          getDocs(collection(db, 'registrations')),
        ]);
        qs('#statStudents').textContent = studentsSnap.size;
        qs('#statCourses').textContent = coursesSnap.size;
        qs('#statRegs').textContent = regsSnap.size;

        const tbody = qs('#recentRegs tbody');
        tbody.innerHTML = '';
        if (regsSnap.empty) {
          qs('#recentRegsEmpty').style.display = 'block';
        } else {
          qs('#recentRegsEmpty').style.display = 'none';
          // Render up to 5 rows (client-side simple)
          let i=0;
          for (const docSnap of regsSnap.docs) {
            if (i++ >= 5) break;
            const data = docSnap.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${escapeHtml(data.studentName || data.studentId || '—')}</td>
                            <td>${escapeHtml(data.courseName || data.courseId || '—')}</td>
                            <td>${fmtDate(data.createdAt)}</td>`;
            tbody.appendChild(tr);
          }
        }
      } catch (err) {
        console.error('Dashboard load error', err);
        toast('Failed to load dashboard: ' + err.message);
      }

      qs('#refreshDash').addEventListener('click', renderDashboard);
    }

    async function renderStudents() {
      showApp();
      main.innerHTML = `
        <div class="section-header">
          <div class="section-title"><i class="fa-solid fa-user-graduate"></i> Students</div>
          <div>
            <button class="btn primary" id="addStudent"><i class="fa-solid fa-plus"></i> Add Student</button>
          </div>
        </div>
        <div class="card">
          <table class="table" id="studentsTable">
            <thead><tr><th>Name</th><th>Email</th><th>Program</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="studentsEmpty" style="display:none;">
            <i class="fa-solid fa-database"></i>
            <div>No students yet.</div>
            <small>Use “Add Student” to create one for testing.</small>
          </div>
        </div>
      `;

      await loadStudents();
      qs('#addStudent').addEventListener('click', addStudentDialog);
    }

    async function loadStudents() {
      try {
        const snap = await getDocs(collection(db, 'students'));
        const tbody = qs('#studentsTable tbody');
        tbody.innerHTML = '';
        if (snap.empty) {
          qs('#studentsEmpty').style.display = 'block';
          return;
        }
        qs('#studentsEmpty').style.display = 'none';
        snap.forEach(docSnap => {
          const s = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(s.name || '—')}</td>
                          <td>${escapeHtml(s.email || '—')}</td>
                          <td>${escapeHtml(s.program || '—')}</td>
                          <td style="text-align:right;">
                            <button class="btn" data-id="${docSnap.id}" data-action="edit"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn" data-id="${docSnap.id}" data-action="del"><i class="fa-solid fa-trash"></i></button>
                          </td>`;
          tbody.appendChild(tr);
        });

        // Row actions
        tbody.addEventListener('click', async (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'del') {
            await deleteDoc(doc(db, 'students', id));
            toast('Student deleted');
            loadStudents();
          } else if (action === 'edit') {
            editStudentDialog(id);
          }
        });
      } catch (err) {
        console.error('Load students error', err);
        toast('Failed to load students: ' + err.message);
      }
    }

    function addStudentDialog() {
      const name = prompt('Student name');
      if (name == null) return;
      const email = prompt('Student email (optional)') || '';
      const program = prompt('Program (optional)') || '';
      addStudent({ name, email, program });
    }
    async function addStudent(s) {
      try {
        await addDoc(collection(db, 'students'), { ...s, createdAt: serverTimestamp() });
        toast('Student added');
        loadStudents();
      } catch (err) { toast('Add failed: ' + err.message); }
    }

    async function editStudentDialog(id) {
      try {
        const ref = doc(db, 'students', id);
        const snap = await getDoc(ref);
        const s = snap.data();
        const name = prompt('Student name', s.name || '');
        if (name == null) return;
        const email = prompt('Email', s.email || '');
        if (email == null) return;
        const program = prompt('Program', s.program || '');
        if (program == null) return;
        await updateDoc(ref, { name, email, program });
        toast('Student updated');
        loadStudents();
      } catch (err) { toast('Update failed: ' + err.message); }
    }

    async function renderCourses() {
      showApp();
      main.innerHTML = `
        <div class="section-header">
          <div class="section-title"><i class="fa-solid fa-book"></i> Courses</div>
          <div>
            <button class="btn primary" id="addCourse"><i class="fa-solid fa-plus"></i> Add Course</button>
          </div>
        </div>
        <div class="card">
          <table class="table" id="coursesTable">
            <thead><tr><th>Code</th><th>Title</th><th>Credits</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="coursesEmpty" style="display:none;">
            <i class="fa-solid fa-database"></i>
            <div>No courses yet.</div>
            <small>Use “Add Course” to create one for testing.</small>
          </div>
        </div>
      `;

      await loadCourses();
      qs('#addCourse').addEventListener('click', addCourseDialog);
    }

    async function loadCourses() {
      try {
        const snap = await getDocs(collection(db, 'courses'));
        const tbody = qs('#coursesTable tbody');
        tbody.innerHTML = '';
        if (snap.empty) { qs('#coursesEmpty').style.display='block'; return; }
        qs('#coursesEmpty').style.display='none';
        snap.forEach(docSnap => {
          const c = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(c.code || '—')}</td>
                          <td>${escapeHtml(c.title || '—')}</td>
                          <td>${escapeHtml(String(c.credits ?? '—'))}</td>
                          <td style="text-align:right;">
                            <button class="btn" data-id="${docSnap.id}" data-action="edit"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn" data-id="${docSnap.id}" data-action="del"><i class="fa-solid fa-trash"></i></button>
                          </td>`;
          tbody.appendChild(tr);
        });

        tbody.addEventListener('click', async (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'del') { await deleteDoc(doc(db, 'courses', id)); toast('Course deleted'); loadCourses(); }
          if (action === 'edit') { editCourseDialog(id); }
        });
      } catch (err) { console.error(err); toast('Failed to load courses: ' + err.message); }
    }

    function addCourseDialog() {
      const code = prompt('Course code'); if (code==null) return;
      const title = prompt('Title'); if (title==null) return;
      const credits = Number(prompt('Credits (number)') || 0);
      addCourse({ code, title, credits });
    }
    async function addCourse(c) {
      try { await addDoc(collection(db, 'courses'), { ...c, createdAt: serverTimestamp() }); toast('Course added'); loadCourses(); }
      catch (err) { toast('Add failed: ' + err.message); }
    }
    async function editCourseDialog(id) {
      try {
        const ref = doc(db, 'courses', id); const snap = await getDoc(ref); const c=snap.data();
        const code = prompt('Course code', c.code||''); if (code==null) return;
        const title = prompt('Title', c.title||''); if (title==null) return;
        const credits = Number(prompt('Credits', c.credits||0));
        await updateDoc(ref, { code, title, credits }); toast('Course updated'); loadCourses();
      } catch (err) { toast('Update failed: ' + err.message); }
    }

    async function renderRegistrations() {
      showApp();
      main.innerHTML = `
        <div class="section-header">
          <div class="section-title"><i class="fa-solid fa-clipboard-list"></i> Registrations</div>
          <div>
            <button class="btn primary" id="addReg"><i class="fa-solid fa-plus"></i> Add Registration</button>
          </div>
        </div>
        <div class="card">
          <table class="table" id="regsTable">
            <thead><tr><th>Student</th><th>Course</th><th>Created</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="regsEmpty" style="display:none;">
            <i class="fa-solid fa-database"></i>
            <div>No registrations yet.</div>
          </div>
        </div>
      `;

      await loadRegistrations();
      qs('#addReg').addEventListener('click', addRegDialog);
    }

    async function loadRegistrations() {
      try {
        const snap = await getDocs(collection(db, 'registrations'));
        const tbody = qs('#regsTable tbody');
        tbody.innerHTML = '';
        if (snap.empty) { qs('#regsEmpty').style.display='block'; return; }
        qs('#regsEmpty').style.display='none';
        snap.forEach(docSnap => {
          const r = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(r.studentName || r.studentId || '—')}</td>
                          <td>${escapeHtml(r.courseName || r.courseId || '—')}</td>
                          <td>${fmtDate(r.createdAt)}</td>
                          <td style="text-align:right;">
                            <button class="btn" data-id="${docSnap.id}" data-action="del"><i class="fa-solid fa-trash"></i></button>
                          </td>`;
          tbody.appendChild(tr);
        });
        tbody.addEventListener('click', async (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action==='del') { await deleteDoc(doc(db, 'registrations', id)); toast('Registration deleted'); loadRegistrations(); }
        });
      } catch (err) { toast('Failed to load registrations: ' + err.message); }
    }

    async function addRegDialog() {
      const studentName = prompt('Student name or ID'); if (studentName==null) return;
      const courseName = prompt('Course name or ID'); if (courseName==null) return;
      try { await addDoc(collection(db, 'registrations'), { studentName, courseName, createdAt: serverTimestamp() }); toast('Registration added'); loadRegistrations(); }
      catch (err) { toast('Add failed: ' + err.message); }
    }

    async function renderAnnouncements() {
      showApp();
      main.innerHTML = `
        <div class="section-header">
          <div class="section-title"><i class="fa-solid fa-bullhorn"></i> Announcements</div>
          <div>
            <button class="btn primary" id="addAnn"><i class="fa-solid fa-plus"></i> New</button>
          </div>
        </div>
        <div class="card">
          <table class="table" id="annTable">
            <thead><tr><th>Title</th><th>Published</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="empty" id="annEmpty" style="display:none;">
            <i class="fa-solid fa-database"></i>
            <div>No announcements yet.</div>
          </div>
        </div>
      `;

      await loadAnnouncements();
      qs('#addAnn').addEventListener('click', addAnnouncementDialog);
    }

    async function loadAnnouncements() {
      try {
        const snap = await getDocs(collection(db, 'announcements'));
        const tbody = qs('#annTable tbody');
        tbody.innerHTML = '';
        if (snap.empty) { qs('#annEmpty').style.display='block'; return; }
        qs('#annEmpty').style.display='none';
        snap.forEach(docSnap => {
          const a = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(a.title || '—')}</td>
                          <td>${fmtDate(a.createdAt)}</td>
                          <td style="text-align:right;">
                            <button class="btn" data-id="${docSnap.id}" data-action="del"><i class="fa-solid fa-trash"></i></button>
                          </td>`;
          tbody.appendChild(tr);
        });
        tbody.addEventListener('click', async (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action==='del') { await deleteDoc(doc(db, 'announcements', id)); toast('Announcement deleted'); loadAnnouncements(); }
        });
      } catch (err) { toast('Failed to load announcements: ' + err.message); }
    }

    async function addAnnouncementDialog() {
      const title = prompt('Title'); if (title==null) return;
      const body = prompt('Body (optional)') || '';
      try { await addDoc(collection(db, 'announcements'), { title, body, createdAt: serverTimestamp() }); toast('Announcement published'); loadAnnouncements(); }
      catch (err) { toast('Publish failed: ' + err.message); }
    }

    function renderSettings() {
      showApp();
      main.innerHTML = `
        <div class="section-header">
          <div class="section-title"><i class="fa-solid fa-gear"></i> Settings</div>
        </div>
        <div class="cards">
          <div class="card">
            <h4>Seed Demo Data</h4>
            <p class="muted">Add a few sample items so the UI looks alive.</p>
            <button class="btn" id="seedBtn"><i class="fa-solid fa-seedling"></i> Seed now</button>
          </div>
          <div class="card">
            <h4>About</h4>
            <p class="muted">Admin is gated by Firestore document <code>admins/{uid}</code> with <code>isAdmin: true</code>.</p>
          </div>
        </div>
      `;
      qs('#seedBtn').addEventListener('click', seedDemo);
    }

    async function seedDemo() {
      try {
        loading(true);
        // Only add if collections are empty
        const studentsSnap = await getDocs(collection(db, 'students'));
        if (studentsSnap.empty) {
          await addDoc(collection(db, 'students'), { name:'John Doe', email:'john@example.com', program:'Design', createdAt: serverTimestamp() });
          await addDoc(collection(db, 'students'), { name:'Jane Smith', email:'jane@example.com', program:'Computer Science', createdAt: serverTimestamp() });
        }
        const coursesSnap = await getDocs(collection(db, 'courses'));
        if (coursesSnap.empty) {
          await addDoc(collection(db, 'courses'), { code:'DES101', title:'Intro to Design', credits:3, createdAt: serverTimestamp() });
          await addDoc(collection(db, 'courses'), { code:'CSC201', title:'Data Structures', credits:4, createdAt: serverTimestamp() });
        }
        const regsSnap = await getDocs(collection(db, 'registrations'));
        if (regsSnap.empty) {
          await addDoc(collection(db, 'registrations'), { studentName:'John Doe', courseName:'Intro to Design', createdAt: serverTimestamp() });
        }
        const annSnap = await getDocs(collection(db, 'announcements'));
        if (annSnap.empty) {
          await addDoc(collection(db, 'announcements'), { title:'Welcome to the new term!', body:'Classes start Monday.', createdAt: serverTimestamp() });
        }
        toast('Demo data seeded');
      } catch (err) { toast('Seed failed: ' + err.message); }
      finally { loading(false); }
    }

    /********************
     * Helpers
     ********************/
    function escapeHtml(str) {
      return String(str).replace(/[&<>"] /g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',' ':' ' }[s]));
    }
    function fmtDate(ts) {
      if (!ts) return '—';
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString();
      } catch { return '—'; }
    }

    // Default view on first load
    views.dashboard();
  </script>
</body>
</html>
