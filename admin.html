<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard - Prince Alex Design University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
    <!-- SheetJS for Excel/CSV export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Variables from admin (1).html for consistency */
        :root {
            --bg:#f6f8fb; 
            --card:#ffffff; 
            --text:#1f2937; 
            --muted:#6b7280; 
            --primary:#065f46; 
            --primary-600:#047857; 
            --ring:rgba(0,0,0,.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: url('myschoolgate.png') no-repeat center center fixed;
            background-size: cover;
            margin: 0; /* Ensure no default body margin */
            color: var(--text); /* Use text color from variables */
        }

        /* Styles for the new login section from admin (1).html */
        #login { 
            display:none; 
            max-width:380px; 
            margin:48px auto; 
            background: var(--card); 
            padding:24px; 
            border-radius:16px; 
            box-shadow:0 10px 24px var(--ring); 
            border:1px solid #e5e7eb; 
        }
        #login h2 { 
            margin:0 0 12px; 
        }
        #login .field { 
            display:flex; /* Use flex for label and input arrangement */
            flex-direction:column; /* Stack label above input */
            gap:6px; /* Space between label and input */
            margin-bottom:10px; 
        }
        #login .field label {
            font-size:.9rem; 
            color: var(--muted);
        }
        #login .field input {
            padding:10px 12px; 
            border:1px solid #e5e7eb; 
            border-radius:10px; 
            background:#fff;
            width: 100%; /* Ensure inputs take full width */
        }
        /* Buttons from admin (1).html */
        .btn { 
            display:inline-flex; 
            align-items:center; 
            gap:8px; 
            padding:10px 14px; 
            border-radius:10px; 
            border:1px solid #e5e7eb; 
            background:#fff; 
            cursor:pointer; 
        }
        .btn.primary { 
            background: var(--primary); 
            border-color: var(--primary); 
            color:#fff; 
        }
        .btn.primary:hover { 
            background: var(--primary-600);
        }

        /* Original admin.html styles for dashboard */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar: Default for mobile is hidden, but can be shown with .active */
        .sidebar {
            width: 250px;
            background-color: #0c431b; /* Darker green for a stronger admin feel */
            color: white;
            padding: 1.5rem;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 50;
            transform: translateX(-100%); /* Hidden by default on small screens */
            transition: transform 0.3s ease-in-out;
        }

        .sidebar.active {
            transform: translateX(0); /* Shown when 'active' class is added (mobile toggle) */
        }

        /* Main content area: Default for mobile is full width */
        .content-area {
            margin-left: 0;
            padding: 2rem;
            flex-grow: 1;
            background-color: #f3f4f6;
        }
        
        .main-content {
            padding: 2rem;
        }

        /* Styles for large screens (desktop) */
        @media (min-width: 1024px) { /* Equivalent to Tailwind's lg breakpoint */
            .sidebar {
                transform: translateX(0) !important; /* Override and always show on desktop */
            }

            .content-area {
                margin-left: 250px; /* Push content to the right to make space for sidebar */
            }

            /* Hide the mobile menu toggle button on desktop */
            #menuToggle {
                display: none;
            }

            /* The mobile header itself has lg:hidden already in HTML, ensuring it's not displayed */
            header.lg\:hidden {
                display: none;
            }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        thead th {
            background-color: #1a4f32;
            color: white;
            text-transform: uppercase;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay and Modals -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
        <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-300">
            <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
            <p id="modalMessage" class="mb-6 text-gray-700"></p>
            <div class="flex justify-center gap-4">
                <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
                <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Login View from admin (1).html -->
    <section id="login">
        <h2 class="text-center">Admin Login</h2>
        <div class="field"><label>Email</label><input id="email" type="email" placeholder="admin@example.com" /></div>
        <div class="field"><label>Password</label><input id="password" type="password" placeholder="••••••••" /></div>
        <button class="btn primary w-full" id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> Sign In</button>
        <div id="loginHint" class="muted text-center" style="margin-top:10px; font-size:.9rem; color:var(--muted);">Use a Firebase Auth user whose UID exists in <code>admins/{uid}</code> with <code>isAdmin: true</code>.</div>
    </section>

    <!-- Admin Dashboard -->
    <div id="dashboardContainer" class="hidden dashboard-container">
        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="sidebar">
            <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Admin Panel</h3>
            <ul class="space-y-2">
                <li><a href="#" onclick="showAdminSection('dashboard')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i>Dashboard</a></li>
                <li><a href="#" onclick="showAdminSection('students')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-users mr-3"></i>Manage Students</a></li>
                <li><a href="#" onclick="showAdminSection('courses')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-book mr-3"></i>Manage Courses</a></li>
                <li><a href="#" onclick="showAdminSection('fees')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-money-bill-wave mr-3"></i>Manage Fees</a></li>
                <li><a href="#" onclick="showAdminSection('grades')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-award mr-3"></i>Manage Grades</a></li>
                <li><a href="#" onclick="showAdminSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-building mr-3"></i>Hostel Management</a></li>
                <li><a href="#" onclick="showAdminSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i>Announcements</a></li>
                <li><a href="#" onclick="showAdminSection('graduation')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-graduation-cap mr-3"></i>Graduation Requests</a></li>
                <li><a href="#" onclick="showAdminSection('clearance')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-check-circle mr-3"></i>Clearance Requests</a></li>
                <li><a href="#" onclick="showAdminSection('admins')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user-shield mr-3"></i>Admin Management</a></li>
            </ul>
            <div class="mt-auto pt-6 border-t border-green-700">
                <!-- Logout button for dashboard -->
                <button id="logoutBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Mobile Header and Toggler -->
            <header class="bg-white p-4 flex justify-between items-center shadow-md sticky top-0 z-40 lg:hidden">
                <button id="menuToggle" class="text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="text-lg font-semibold text-green-700">Admin Portal</span>
                <img src="myschoollogo.png" alt="University Logo" class="h-10 w-auto">
            </header>

            <div class="main-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 pb-2 border-b-2 border-green-700">Admin Dashboard</h1>

                <!-- Dashboard Section -->
                <div id="dashboardSection" class="dashboard-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-users text-4xl text-green-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Total Students</h3>
                            <p id="student-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-book-open text-4xl text-green-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Total Courses</h3>
                            <p id="course-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-hourglass-half text-4xl text-yellow-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Pending Graduation</h3>
                            <p id="graduation-pending-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-hourglass-end text-4xl text-yellow-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Pending Clearance</h3>
                            <p id="clearance-pending-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Outstanding Fees</h3>
                            <p id="outstanding-fees-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                    </div>
                </div>

                <!-- Manage Students Section -->
                <div id="studentsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Students</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <input type="text" id="studentSearch" placeholder="Search students..." class="px-4 py-2 border rounded-lg mb-2 md:mb-0 w-full md:w-auto">
                            <div class="flex space-x-2">
                                <button onclick="addStudentModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Student</button>
                                <button onclick="exportTable('studentsTable', 'Students')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('studentsTable', 'Students')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="studentsTable" class="min-w-full bg-white border-collapse">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Program</th>
                                        <th>Year</th>
                                        <th>Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="text-center py-4 text-gray-500">No data available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Courses Section -->
                <div id="coursesSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Courses</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <input type="text" id="courseSearch" placeholder="Search courses..." class="px-4 py-2 border rounded-lg mb-2 md:mb-0 w-full md:w-auto">
                            <div class="flex space-x-2">
                                <button onclick="addCourseModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Course</button>
                                <button onclick="exportTable('coursesTable', 'Courses')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('coursesTable', 'Courses')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="coursesTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Credits</th>
                                        <th>Lecturer</th>
                                        <th>Schedule</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="text-center py-4 text-gray-500">No data available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Fees Section -->
                <div id="feesSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Fees</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="feesSearch" placeholder="Search student by email..." class="px-4 py-2 border rounded-lg w-full md:w-auto">
                            <button onclick="searchStudentForFees()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 ml-2">Search</button>
                        </div>
                        <div id="feesContent" class="hidden mt-4">
                            <h3 class="text-xl font-bold text-green-800 mb-2">Fee Statement for <span id="studentNameFees"></span></h3>
                            <div class="flex space-x-2 mb-4">
                                <button onclick="addFeeTransactionModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Transaction</button>
                                <button onclick="exportTable('feesTable', 'Fee Statement')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('feesTable', 'Fee Statement')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                            <div class="table-container">
                                <table id="feesTable" class="min-w-full bg-white">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="4" class="text-center py-4 text-gray-500">No fee records found.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Grades Section -->
                <div id="gradesSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Grades</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="gradesSearch" placeholder="Search student by email..." class="px-4 py-2 border rounded-lg w-full md:w-auto">
                            <button onclick="searchStudentForGrades()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 ml-2">Search</button>
                        </div>
                        <div id="gradesContent" class="hidden mt-4">
                            <h3 class="text-xl font-bold text-green-800 mb-2">Grades for <span id="studentNameGrades"></span></h3>
                            <div class="flex space-x-2 mb-4">
                                <button onclick="editGradesModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Edit Grades</button>
                                <button onclick="exportTable('gradesTable', 'Grades Report')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('gradesTable', 'Grades Report')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                            <div class="table-container">
                                <table id="gradesTable" class="min-w-full bg-white">
                                    <thead>
                                        <tr>
                                            <th>Course Code</th>
                                            <th>Course Name</th>
                                            <th>Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="3" class="text-center py-4 text-gray-500">No grades found.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hostel Management Section -->
                <div id="hostelsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Hostel Management</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <div class="flex space-x-2">
                                <button onclick="addHostelModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Hostel</button>
                                <button onclick="toggleHostelApplications()" id="toggleHostelAppBtn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">Toggle Applications</button>
                            </div>
                            <div class="flex space-x-2 mt-2 md:mt-0">
                                <button onclick="exportTable('hostelsTable', 'Hostel List')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('hostelsTable', 'Hostel List')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="hostelsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Capacity</th>
                                        <th>Availability</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="text-center py-4 text-gray-500">No hostel data available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div id="announcementsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Announcements</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                             <button onclick="addAnnouncementModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Announcement</button>
                         </div>
                        <div class="table-container">
                            <table id="announcementsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Title</th>
                                        <th>Content</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="text-center py-4 text-gray-500">No announcements available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Graduation Requests Section -->
                <div id="graduationSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Graduation Requests</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                            <div class="flex space-x-2">
                                <button onclick="exportTable('graduationRequestsTable', 'Graduation Requests')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('graduationRequestsTable', 'Graduation Requests')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="graduationRequestsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Email</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="text-center py-4 text-gray-500">No graduation requests available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Clearance Requests Section -->
                <div id="clearanceSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Clearance Requests</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                            <div class="flex space-x-2">
                                <button onclick="exportTable('clearanceRequestsTable', 'Clearance Requests')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('clearanceRequestsTable', 'Clearance Requests')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="clearanceRequestsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Email</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="text-center py-4 text-gray-500">No clearance requests available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin Management Section -->
                <div id="adminsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Management</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                             <button onclick="addAdminModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add New Admin</button>
                        </div>
                        <div class="table-container">
                            <table id="adminsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="3" class="text-center py-4 text-gray-500">No other admins.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and custom script -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (kept from admin.html)
        const firebaseConfig = {
          apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
          authDomain: "universityweb-19e1e.firebaseapp.com",
          projectId: "universityweb-19e1e",
          storageBucket: "universityweb-19e1e.firebaseostorage.app",
          messagingSenderId: "401942926589",
          appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const loginView = document.getElementById('login');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn'); // Used by new logout logic
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');


        // General UI functions
        function showLoading(text = 'Loading...') {
            loadingText.innerText = text;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showCustomModal(title, message, isConfirmation = false, onConfirm, onCancel) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerText = message;
            document.getElementById('customModal').classList.remove('hidden');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            
            confirmBtn.onclick = () => {
                document.getElementById('customModal').classList.add('hidden');
                if (onConfirm) onConfirm();
            };
            cancelBtn.onclick = () => {
                document.getElementById('customModal').classList.add('hidden');
                if (onCancel) onCancel();
            };

            if (isConfirmation) {
                cancelBtn.classList.remove('hidden');
            } else {
                cancelBtn.classList.add('hidden');
            }
        }

        // New functions for showing/hiding login/app views
        function showLogin() {
            loginView.style.display = 'block';
            dashboardContainer.classList.add('hidden'); // Ensure dashboard is hidden
        }

        function showApp() {
            loginView.style.display = 'none';
            dashboardContainer.classList.remove('hidden'); // Ensure dashboard is shown
        }

        // Authentication Logic
        onAuthStateChanged(auth, async (user) => {
            showLoading(); // Show loading overlay initially
            if (!user) {
                showLogin();
                hideLoading();
                return;
            }

            try {
                // Admin check: admins/{uid} must exist and have isAdmin == true
                const adminRef = doc(db, 'admins', user.uid);
                const adminSnap = await getDoc(adminRef);

                if (!adminSnap.exists() || adminSnap.data().isAdmin !== true) {
                    showLogin(); // Show login if not admin or no record
                    hideLoading();
                    showCustomModal('Authorization Failed', 'Your account is not authorized as an administrator.', false);
                    await signOut(auth); // Sign out unauthorized user
                    return;
                }

                // Authorized -> render default view
                showApp(); // Show the main application content
                showAdminSection('dashboard'); // Render the dashboard after successful login
                hideLoading();
            } catch (err) {
                console.error('Admin check error:', err);
                showCustomModal('Login Error', 'An error occurred during login verification: ' + err.message, false);
                showLogin();
                hideLoading();
                await signOut(auth); // Ensure user is signed out on error
            }
        });

        // Login button click handler
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!email || !password) { 
                showCustomModal('Input Required', 'Please enter both email and password.', false); 
                return; 
            }
            try {
                showLoading('Signing in...');
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle showing the app or re-showing login after this
            } catch (error) {
                let errorMessage = 'An unknown error occurred during sign-in.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'The email address is not valid.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many login attempts. Please try again later.';
                }
                console.error("Sign-in error", error);
                showCustomModal('Login Failed', errorMessage, false);
            } finally { 
                hideLoading(); 
            }
        });

        // Logout button click handler
        logoutBtn.addEventListener('click', async () => {
            showCustomModal('Confirm Logout', 'Are you sure you want to log out?', true, async () => {
                showLoading('Logging out...');
                try {
                    await signOut(auth);
                    showCustomModal('Logged Out', 'You have been logged out successfully.', false);
                } catch (error) {
                    showCustomModal('Error', 'Failed to log out: ' + error.message, false);
                    console.error("Logout error:", error);
                } finally {
                    hideLoading();
                }
            });
        });

        // Mobile menu toggle
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Dashboard Navigation
        let currentSection = 'dashboardSection'; // Initialize with dashboard
        async function showAdminSection(sectionId) {
            showLoading('Loading section...');
            
            const currentUser = auth.currentUser;
            if (!currentUser) {
                showCustomModal('Session Expired', 'Your session has expired. Please log in again.', false);
                hideLoading();
                return;
            }
            
            try {
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have administrative privileges to access this section.', false);
                    hideLoading();
                    return;
                }

                // Hide previous section
                document.getElementById(currentSection).classList.add('hidden');
                const newSection = document.getElementById(sectionId + 'Section');
                if (newSection) {
                    newSection.classList.remove('hidden');
                    currentSection = sectionId + 'Section';
                    // Close sidebar on mobile after navigating
                    sidebar.classList.remove('active');
                    
                    // Call specific data fetching functions for each section
                    switch(sectionId) {
                        case 'dashboard':
                            await fetchDashboardCounts();
                            break;
                        case 'students':
                            await fetchStudents();
                            break;
                        case 'courses':
                            await fetchCourses();
                            break;
                        case 'fees':
                            // Clear previous fees search result and hide content on section change
                            document.getElementById('feesContent').classList.add('hidden');
                            document.getElementById('feesSearch').value = '';
                            hideLoading(); // Hide loading if no immediate fetch needed
                            break;
                        case 'grades':
                            // Clear previous grades search result and hide content on section change
                            document.getElementById('gradesContent').classList.add('hidden');
                            document.getElementById('gradesSearch').value = '';
                            hideLoading(); // Hide loading if no immediate fetch needed
                            break;
                        case 'hostels':
                            await fetchHostels();
                            break;
                        case 'announcements':
                            await fetchAnnouncements();
                            break;
                        case 'graduation':
                            await fetchGraduationRequests();
                            break;
                        case 'clearance':
                            await fetchClearanceRequests();
                            break;
                        case 'admins':
                            await fetchAdmins();
                            break;
                        default:
                            hideLoading(); // Default hide for undefined sections
                            break;
                    }
                } else {
                    hideLoading(); // Hide loading if section not found
                    console.error(`Section with ID ${sectionId}Section not found.`);
                }
            } catch (error) {
                showCustomModal('Error', 'Failed to verify admin access for section: ' + error.message, false);
                console.error("Error showing admin section:", error);
                hideLoading();
            }
        }

        // Data Management Functions (CRUD & Fetching)
        async function fetchDashboardCounts() {
            showLoading('Loading dashboard data...');
            try {
                const studentsRef = collection(db, 'students');
                const coursesRef = collection(db, 'courses');
                const gradRequestsRef = collection(db, 'graduationRequests');
                const clearanceRequestsRef = collection(db, 'clearanceRequests');
                const feesRef = collection(db, 'fees');

                const [
                    studentsSnapshot, 
                    coursesSnapshot, 
                    gradPendingSnapshot, 
                    clearancePendingSnapshot,
                    feesSnapshot
                ] = await Promise.all([
                    getDocs(studentsRef),
                    getDocs(coursesRef),
                    getDocs(query(gradRequestsRef, where('status', '==', 'Pending'))),
                    getDocs(query(clearanceRequestsRef, where('status', '==', 'Pending'))),
                    getDocs(feesRef)
                ]);

                document.getElementById('student-count').innerText = studentsSnapshot.size;
                document.getElementById('course-count').innerText = coursesSnapshot.size;
                document.getElementById('graduation-pending-count').innerText = gradPendingSnapshot.size;
                document.getElementById('clearance-pending-count').innerText = clearancePendingSnapshot.size;
                
                let totalOutstandingFees = 0;
                feesSnapshot.docs.forEach(d => {
                    const balance = d.data().balance || 0;
                    if (balance > 0) {
                        totalOutstandingFees += balance;
                    }
                });
                document.getElementById('outstanding-fees-count').innerText = `GHS ${totalOutstandingFees.toFixed(2)}`;
            } catch (error) {
                showCustomModal('Error', 'Failed to load dashboard data: ' + error.message, false);
                console.error("Error fetching dashboard counts:", error);
            } finally {
                hideLoading();
            }
        }

        // Generic table render function
        function renderTable(tableId, data, columns, actions) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = ''; // Clear existing data
            if (!tableBody) {
                console.error(`Table body for ID ${tableId} not found.`);
                return;
            }

            if (data.length === 0) {
                const colCount = document.querySelectorAll(`#${tableId} thead th`).length;
                tableBody.innerHTML = `<tr><td colspan="${colCount}" class="text-center py-4 text-gray-500">No data available.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                columns.forEach(col => {
                    const cell = document.createElement('td');
                    if (col === 'balance') {
                        cell.innerText = `GHS ${item[col].toFixed(2)}`;
                        cell.classList.add(item[col] > 0 ? 'text-red-600' : 'text-green-600');
                    } else if (['date', 'createdAt', 'updatedAt'].includes(col) && item[col]) { 
                        try {
                             // Assuming ISO string or Firebase Timestamp
                             let date;
                             if (item[col].toDate) { // Firebase Timestamp
                                date = item[col].toDate();
                             } else if (typeof item[col] === 'string') { // ISO string
                                date = new Date(item[col]);
                             } else { // Fallback for other formats
                                date = new Date(item[col]);
                             }
                             cell.innerText = date.toLocaleDateString();
                        } catch (e) {
                            cell.innerText = item[col]; // Fallback if date is invalid
                            console.warn(`Invalid date format for ${col}: ${item[col]}`);
                        }
                    }
                    else if (col === 'isAdmin') {
                        cell.innerText = item[col] ? 'Yes' : 'No';
                    }
                    else {
                        cell.innerText = item[col] || 'N/A';
                    }
                    row.appendChild(cell);
                });

                if (actions) {
                    const actionsCell = document.createElement('td');
                    actionsCell.className = "flex space-x-2";
                    actions.forEach(action => {
                        // Only render action buttons if the item meets specific conditions
                        if (!action.condition || action.condition(item)) {
                            const button = document.createElement('button');
                            button.innerText = action.text;
                            button.className = action.class;
                            button.onclick = () => action.handler(item);
                            actionsCell.appendChild(button);
                        }
                    });
                    row.appendChild(actionsCell);
                }
                tableBody.appendChild(row);
            });
        }
        
        // --- Manage Students ---
        async function fetchStudents() {
            showLoading('Fetching student records...');
            try {
                // Permission check handled by showAdminSection, but a final check here
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#studentsTable tbody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">You do not have permission to view student data.</td></tr>`;
                    hideLoading();
                    return;
                }

                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(studentsRef);
                const students = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));

                const columns = ['name', 'email', 'programme', 'year', 'contact']; // Updated column names
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (student) => editStudentModal(student) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (student) => deleteStudent(student.uid) }
                ];

                renderTable('studentsTable', students, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch student records: ' + error.message, false);
                console.error("Error fetching students:", error);
            } finally {
                hideLoading();
            }
        }

        function addStudentModal() {
            showCustomModal('Add New Student', `
                <input type="text" id="addStudentName" placeholder="Full Name" class="w-full p-2 mb-2 border rounded-md" />
                <input type="email" id="addStudentEmail" placeholder="Email" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addStudentProgram" placeholder="Program" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addStudentYear" placeholder="Year" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addStudentContact" placeholder="Contact" class="w-full p-2 mb-2 border rounded-md" />
            `, true, async () => {
                const name = document.getElementById('addStudentName').value;
                const email = document.getElementById('addStudentEmail').value;
                const program = document.getElementById('addStudentProgram').value;
                const year = document.getElementById('addStudentYear').value;
                const contact = document.getElementById('addStudentContact').value;

                if (!name || !email || !program || !year || !contact) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                await addStudent({ name, email: email.toLowerCase(), programme: program, year: parseInt(year), contact, createdAt: serverTimestamp() });
            });
        }
        
        async function addStudent(studentData) {
            showLoading('Adding student...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to add student data.', false);
                    hideLoading();
                    return;
                }
                await setDoc(doc(db, 'students', studentData.email), studentData);
                showCustomModal('Success', 'Student added successfully.', false);
                fetchStudents();
            } catch (error) {
                showCustomModal('Error', 'Failed to add student: ' + error.message, false);
                console.error("Error adding student:", error);
            } finally {
                hideLoading();
            }
        }

        function editStudentModal(student) {
            showCustomModal('Edit Student', `
                <input type="text" id="editStudentName" placeholder="Full Name" class="w-full p-2 mb-2 border rounded-md" value="${student.name}" />
                <input type="email" id="editStudentEmail" placeholder="Email" class="w-full p-2 mb-2 border rounded-md" value="${student.email}" disabled />
                <input type="text" id="editStudentProgram" placeholder="Program" class="w-full p-2 mb-2 border rounded-md" value="${student.programme}" />
                <input type="number" id="editStudentYear" placeholder="Year" class="w-full p-2 mb-2 border rounded-md" value="${student.year}" />
                <input type="text" id="editStudentContact" placeholder="Contact" class="w-full p-2 mb-2 border rounded-md" value="${student.contact}" />
            `, true, async () => {
                const name = document.getElementById('editStudentName').value;
                const program = document.getElementById('editStudentProgram').value;
                const year = document.getElementById('editStudentYear').value;
                const contact = document.getElementById('editStudentContact').value;

                if (!name || !program || !year || !contact) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                await updateStudent(student.uid, { name, programme: program, year: parseInt(year), contact });
            });
        }
        
        async function updateStudent(uid, studentData) {
            showLoading('Updating student...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to update student data.', false);
                    hideLoading();
                    return;
                }
                await updateDoc(doc(db, 'students', uid), studentData);
                showCustomModal('Success', 'Student updated successfully.', false);
                fetchStudents();
            } catch (error) {
                showCustomModal('Error', 'Failed to update student: ' + error.message, false);
                console.error("Error updating student:", error);
            } finally {
                hideLoading();
            }
        }
        
        async function deleteStudent(uid) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this student record? This action cannot be undone.', true, async () => {
                showLoading('Deleting student...');
                try {
                    const currentUser = auth.currentUser;
                    const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                    if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                        showCustomModal('Permission Denied', 'You do not have permission to delete student data.', false);
                        hideLoading();
                        return;
                    }
                    await deleteDoc(doc(db, 'students', uid));
                    showCustomModal('Success', 'Student deleted successfully.', false);
                    fetchStudents();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete student: ' + error.message, false);
                    console.error("Error deleting student:", error);
                } finally {
                    hideLoading();
                }
            });
        }

        document.getElementById('studentSearch').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            showLoading('Searching students...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#studentsTable tbody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">You do not have permission to search student data.</td></tr>`;
                    hideLoading();
                    return;
                }

                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(studentsRef);
                const allStudents = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
                const filteredStudents = allStudents.filter(student => 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm) ||
                    (student.programme && student.programme.toLowerCase().includes(searchTerm)) ||
                    (student.contact && student.contact.toLowerCase().includes(searchTerm))
                );
                const columns = ['name', 'email', 'programme', 'year', 'contact'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (student) => editStudentModal(student) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (student) => deleteStudent(student.uid) }
                ];
                renderTable('studentsTable', filteredStudents, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Error during student search: ' + error.message, false);
                console.error("Error during student search:", error);
            } finally {
                hideLoading();
            }
        });


        // --- Manage Courses ---
        async function fetchCourses() {
            showLoading('Fetching course records...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#coursesTable tbody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">You do not have permission to view course data.</td></tr>`;
                    hideLoading();
                    return;
                }

                const coursesRef = collection(db, 'courses');
                const snapshot = await getDocs(coursesRef);
                const courses = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                // Corrected column names to match Firestore seeding
                const columns = ['code', 'title', 'credits', 'lecturer', 'schedule']; 
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (course) => editCourseModal(course) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (course) => deleteCourse(course.id) }
                ];

                renderTable('coursesTable', courses, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch course records: ' + error.message, false);
                console.error("Error fetching courses:", error);
            } finally {
                hideLoading();
            }
        }

        function addCourseModal() {
            showCustomModal('Add New Course', `
                <input type="text" id="addCourseCode" placeholder="Course Code (e.g., CSC101)" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addCourseName" placeholder="Course Name" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addCourseCredits" placeholder="Credits" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addCourseLecturer" placeholder="Lecturer" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addCourseSchedule" placeholder="Schedule (e.g., Mon 10-12)" class="w-full p-2 mb-2 border rounded-md" />
            `, true, async () => {
                const courseCode = document.getElementById('addCourseCode').value;
                const courseName = document.getElementById('addCourseName').value;
                const credits = document.getElementById('addCourseCredits').value;
                const lecturer = document.getElementById('addCourseLecturer').value;
                const schedule = document.getElementById('addCourseSchedule').value;

                if (!courseCode || !courseName || !credits || !lecturer || !schedule) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                // When adding, ensure we use the 'code' and 'title' properties for consistency with rendering
                await addCourse({ code: courseCode, title: courseName, credits: parseInt(credits), lecturer, schedule, createdAt: serverTimestamp() });
            });
        }

        async function addCourse(courseData) {
            showLoading('Adding course...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to add course data.', false);
                    hideLoading();
                    return;
                }
                // Use courseCode (which is 'code') as the document ID for courses
                await setDoc(doc(db, 'courses', courseData.code), courseData);
                showCustomModal('Success', 'Course added successfully.', false);
                fetchCourses();
            } catch (error) {
                showCustomModal('Error', 'Failed to add course: ' + error.message, false);
                console.error("Error adding course:", error);
            } finally {
                hideLoading();
            }
        }

        function editCourseModal(course) {
            showCustomModal('Edit Course', `
                <input type="text" id="editCourseCode" placeholder="Course Code" class="w-full p-2 mb-2 border rounded-md" value="${course.code}" disabled />
                <input type="text" id="editCourseName" placeholder="Course Name" class="w-full p-2 mb-2 border rounded-md" value="${course.title}" />
                <input type="number" id="editCourseCredits" placeholder="Credits" class="w-full p-2 mb-2 border rounded-md" value="${course.credits}" />
                <input type="text" id="editCourseLecturer" placeholder="Lecturer" class="w-full p-2 mb-2 border rounded-md" value="${course.lecturer}" />
                <input type="text" id="editCourseSchedule" placeholder="Schedule" class="w-full p-2 mb-2 border rounded-md" value="${course.schedule}" />
            `, true, async () => {
                const courseName = document.getElementById('editCourseName').value;
                const credits = document.getElementById('editCourseCredits').value;
                const lecturer = document.getElementById('editCourseLecturer').value;
                const schedule = document.getElementById('editCourseSchedule').value;

                if (!courseName || !credits || !lecturer || !schedule) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                // Update using 'title' instead of 'courseName'
                await updateCourse(course.id, { title: courseName, credits: parseInt(credits), lecturer, schedule });
            });
        }

        async function updateCourse(id, courseData) {
            showLoading('Updating course...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to update course data.', false);
                    hideLoading();
                    return;
                }
                await updateDoc(doc(db, 'courses', id), courseData);
                showCustomModal('Success', 'Course updated successfully.', false);
                fetchCourses();
            } catch (error) {
                showCustomModal('Error', 'Failed to update course: ' + error.message, false);
                console.error("Error updating course:", error);
            } finally {
                hideLoading();
            }
        }

        async function deleteCourse(id) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this course record? This action cannot be undone.', true, async () => {
                showLoading('Deleting course...');
                try {
                    const currentUser = auth.currentUser;
                    const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                    if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                        showCustomModal('Permission Denied', 'You do not have permission to delete course data.', false);
                        hideLoading();
                        return;
                    }
                    await deleteDoc(doc(db, 'courses', id));
                    showCustomModal('Success', 'Course deleted successfully.', false);
                    fetchCourses();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete course: ' + error.message, false);
                    console.error("Error deleting course:", error);
                } finally {
                    hideLoading();
                }
            });
        }

        document.getElementById('courseSearch').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            showLoading('Searching courses...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#coursesTable tbody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">You do not have permission to search course data.</td></tr>`;
                    hideLoading();
                    return;
                }

                const coursesRef = collection(db, 'courses');
                const snapshot = await getDocs(coursesRef);
                const allCourses = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const filteredCourses = allCourses.filter(course => 
                    (course.code && course.code.toLowerCase().includes(searchTerm)) || // Search by 'code'
                    (course.title && course.title.toLowerCase().includes(searchTerm)) || // Search by 'title'
                    (course.lecturer && course.lecturer.toLowerCase().includes(searchTerm))
                );
                // Corrected column names for rendering search results
                const columns = ['code', 'title', 'credits', 'lecturer', 'schedule'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (course) => editCourseModal(course) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (course) => deleteCourse(course.id) }
                ];
                renderTable('coursesTable', filteredCourses, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Error during course search: ' + error.message, false);
                console.error("Error during course search:", error);
            } finally {
                hideLoading();
            }
        });

        // --- Manage Fees ---
        let currentFeesStudentUid = null;

        async function searchStudentForFees() {
            const email = document.getElementById('feesSearch').value.toLowerCase();
            if (!email) {
                showCustomModal('Error', 'Please enter a student email to search.', false);
                return;
            }
            showLoading(`Searching for ${email}'s fees...`);
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.getElementById('feesContent').classList.add('hidden');
                    document.querySelector('#feesTable tbody').innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">You do not have permission to view fees data.</td></tr>`;
                    hideLoading();
                    return;
                }

                const studentsRef = collection(db, 'students');
                const studentQuerySnapshot = await getDocs(query(studentsRef, where('email', '==', email)));

                if (studentQuerySnapshot.empty) {
                    showCustomModal('Not Found', `No student found with email: ${email}`, false);
                    document.getElementById('feesContent').classList.add('hidden');
                    return;
                }

                const studentDoc = studentQuerySnapshot.docs[0];
                const studentData = studentDoc.data();
                currentFeesStudentUid = studentDoc.id; // Store UID for later operations
                document.getElementById('studentNameFees').innerText = studentData.name || email;

                // Fetch fees for this student
                const feesDoc = await getDoc(doc(db, 'fees', currentFeesStudentUid));
                let feesHistory = [];
                let totalFeesCharged = 0; 

                if (feesDoc.exists()) {
                    const data = feesDoc.data();
                    feesHistory = data.payments || [];
                    totalFeesCharged = data.totalFees || 0;
                } else {
                    // Initialize fee record if not exists
                    await setDoc(doc(db, 'fees', currentFeesStudentUid), {
                        studentId: currentFeesStudentUid,
                        totalFees: 0,
                        balance: 0,
                        payments: []
                    });
                }
                
                // Prepare data for display with running balance
                const displayWithBalance = [];
                // Sort payments by date to calculate running balance correctly
                feesHistory.sort((a,b) => new Date(a.date) - new Date(b.date));

                let runningBalance = totalFeesCharged; // Start with the total fees charged as the initial balance

                // Add an initial entry for total fees if it's not zero and there are no previous transactions representing it
                if (totalFeesCharged > 0 && feesHistory.length === 0) {
                    displayWithBalance.push({ date: new Date().toISOString(), description: "Initial Total Fees Due", amount: totalFeesCharged, balance: totalFeesCharged, type: 'charge' });
                }
                
                // Add sorted transactions and update running balance
                feesHistory.forEach(payment => {
                    // For display, charges increase balance, payments decrease.
                    if (payment.type === 'charge') {
                        runningBalance += payment.amount;
                    } else if (payment.type === 'payment') {
                        runningBalance -= payment.amount;
                    }
                    displayWithBalance.push({
                        date: payment.date,
                        description: payment.description,
                        amount: payment.amount,
                        balance: runningBalance // This is the balance *after* this transaction
                    });
                });

                const columns = ['date', 'description', 'amount', 'balance'];
                renderTable('feesTable', displayWithBalance, columns);
                document.getElementById('feesContent').classList.remove('hidden');

            } catch (error) {
                showCustomModal('Error', 'Failed to search fees: ' + error.message, false);
                console.error("Error searching fees:", error);
            } finally {
                hideLoading();
            }
        }

        function addFeeTransactionModal() {
            if (!currentFeesStudentUid) {
                showCustomModal('Error', 'Please search for a student first.', false);
                return;
            }
            showCustomModal('Add Fee Transaction', `
                <input type="number" id="transactionAmount" placeholder="Amount (GHS)" class="w-full p-2 mb-2 border rounded-md" step="0.01" />
                <input type="text" id="transactionDescription" placeholder="Description (e.g., Tuition Payment)" class="w-full p-2 mb-2 border rounded-md" />
                <select type="text" id="transactionType" class="w-full p-2 mb-2 border rounded-md">
                    <option value="payment">Payment</option>
                    <option value="charge">Charge</option>
                </select>
            `, true, async () => {
                const amount = parseFloat(document.getElementById('transactionAmount').value);
                const description = document.getElementById('transactionDescription').value;
                const type = document.getElementById('transactionType').value;

                if (isNaN(amount) || amount <= 0 || !description) {
                    showCustomModal('Error', 'Please enter a valid amount and description.', false);
                    return;
                }
                await addFeeTransaction(currentFeesStudentUid, amount, description, type);
            });
        }

        async function addFeeTransaction(uid, amount, description, type) {
            showLoading('Updating fee record...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to modify fee records.', false);
                    hideLoading();
                    return;
                }

                const feesDocRef = doc(db, 'fees', uid);
                const feesSnap = await getDoc(feesDocRef);
                let currentFees = feesSnap.exists() ? feesSnap.data() : { studentId: uid, totalFees: 0, balance: 0, payments: [] };

                const newTransaction = {
                    date: new Date().toISOString(),
                    description: description,
                    amount: amount,
                    type: type
                };

                currentFees.payments.push(newTransaction);
                
                // Recalculate balance and totalFees based on all payments and charges
                let calculatedTotalFees = 0;
                let calculatedBalance = 0;
                currentFees.payments.forEach(p => {
                    if (p.type === 'charge') {
                        calculatedTotalFees += p.amount;
                    }
                    calculatedBalance += (p.type === 'charge' ? p.amount : -p.amount);
                });
                currentFees.totalFees = calculatedTotalFees;
                currentFees.balance = calculatedBalance;
                
                await setDoc(feesDocRef, currentFees, { merge: true });
                showCustomModal('Success', 'Fee record updated successfully.', false);
                searchStudentForFees(); // Reload data for the current student
            } catch (error) {
                showCustomModal('Error', 'Failed to update fee record: ' + error.message, false);
                console.error("Error adding fee transaction:", error);
            } finally {
                hideLoading();
            }
        }

        // --- Manage Grades ---
        let currentGradesStudentUid = null;

        async function searchStudentForGrades() {
            const email = document.getElementById('gradesSearch').value.toLowerCase();
            if (!email) {
                showCustomModal('Error', 'Please enter a student email to search.', false);
                return;
            }
            showLoading(`Searching for ${email}'s grades...`);
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.getElementById('gradesContent').classList.add('hidden');
                    document.querySelector('#gradesTable tbody').innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">You do not have permission to view grades data.</td></tr>`;
                    hideLoading();
                    return;
                }

                const studentsRef = collection(db, 'students');
                const studentQuerySnapshot = await getDocs(query(studentsRef, where('email', '==', email)));

                if (studentQuerySnapshot.empty) {
                    showCustomModal('Not Found', `No student found with email: ${email}`, false);
                    document.getElementById('gradesContent').classList.add('hidden');
                    return;
                }

                const studentDoc = studentQuerySnapshot.docs[0];
                const studentData = studentDoc.data();
                currentGradesStudentUid = studentDoc.id;
                document.getElementById('studentNameGrades').innerText = studentData.name || email;

                const gradesQuerySnapshot = await getDocs(query(collection(db, 'grades'), where('studentId', '==', currentGradesStudentUid)));
                const grades = gradesQuerySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const columns = ['courseCode', 'courseName', 'grade'];
                renderTable('gradesTable', grades, columns);
                document.getElementById('gradesContent').classList.remove('hidden');

            } catch (error) {
                showCustomModal('Error', 'Failed to search grades: ' + error.message, false);
                console.error("Error searching grades:", error);
            } finally {
                hideLoading();
            }
        }

        async function editGradesModal() {
            if (!currentGradesStudentUid) {
                showCustomModal('Error', 'Please search for a student first.', false);
                return;
            }
            showLoading('Fetching current grades for editing...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to edit grades.', false);
                    hideLoading();
                    return;
                }

                const gradesQuerySnapshot = await getDocs(query(collection(db, 'grades'), where('studentId', '==', currentGradesStudentUid)));
                const grades = gradesQuerySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                let gradeInputsHtml = grades.map(grade => `
                    <div class="flex items-center mb-2">
                        <label class="w-1/3">${grade.courseCode} - ${grade.courseName}:</label>
                        <input type="text" id="grade-${grade.id}" class="w-2/3 p-2 border rounded-md" value="${grade.grade}" placeholder="Enter Grade (A, B, C, D, F)" />
                    </div>
                `).join('');

                if (grades.length === 0) {
                    gradeInputsHtml = '<p class="text-center text-gray-500">No grades to edit for this student.</p>';
                }

                showCustomModal('Edit Grades', `
                    <div id="grade-edit-form-content" class="max-h-60 overflow-y-auto p-2">
                        ${gradeInputsHtml}
                    </div>
                `, true, async () => {
                    const updatedGrades = [];
                    grades.forEach(grade => {
                        const inputElement = document.getElementById(`grade-${grade.id}`);
                        if (inputElement) {
                            updatedGrades.push({
                                id: grade.id,
                                grade: inputElement.value.toUpperCase().trim()
                            });
                        }
                    });
                    await updateStudentGrades(updatedGrades);
                });
            } catch (error) {
                showCustomModal('Error', 'Failed to load grades for editing: ' + error.message, false);
                console.error("Error editing grades modal:", error);
            } finally {
                hideLoading();
            }
        }

        async function updateStudentGrades(gradesToUpdate) {
            showLoading('Updating grades...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to update grades.', false);
                    hideLoading();
                    return;
                }

                const batch = writeBatch(db);
                gradesToUpdate.forEach(grade => {
                    const gradeRef = doc(db, 'grades', grade.id);
                    batch.update(gradeRef, { grade: grade.grade });
                });
                await batch.commit();
                showCustomModal('Success', 'Grades updated successfully.', false);
                searchStudentForGrades(); // Reload for current student
            } catch (error) {
                showCustomModal('Error', 'Failed to update grades: ' + error.message, false);
                console.error("Error updating student grades:", error);
            } finally {
                hideLoading();
            }
        }

        // --- Hostel Management ---
        async function fetchHostels() {
            showLoading('Fetching hostel records...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#hostelsTable tbody').innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">You do not have permission to view hostel data.</td></tr>`;
                    hideLoading();
                    return;
                }

                const hostelsRef = collection(db, 'hostels');
                const snapshot = await getDocs(hostelsRef);
                const hostels = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const columns = ['name', 'capacity', 'availableRooms'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (hostel) => editHostelModal(hostel) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (hostel) => deleteHostel(hostel.id) }
                ];

                renderTable('hostelsTable', hostels, columns, actions);
                updateToggleHostelAppButton();
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch hostel records: ' + error.message, false);
                console.error("Error fetching hostels:", error);
            } finally {
                hideLoading();
            }
        }

        function addHostelModal() {
            showCustomModal('Add New Hostel', `
                <input type="text" id="addHostelName" placeholder="Hostel Name" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addHostelCapacity" placeholder="Total Capacity" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addHostelAvailable" placeholder="Available Rooms" class="w-full p-2 mb-2 border rounded-md" />
            `, true, async () => {
                const name = document.getElementById('addHostelName').value;
                const capacity = parseInt(document.getElementById('addHostelCapacity').value);
                const available = parseInt(document.getElementById('addHostelAvailable').value);

                if (!name || isNaN(capacity) || isNaN(available) || capacity < 0 || available < 0) {
                    showCustomModal('Error', 'Please enter valid hostel details.', false);
                    return;
                }
                await addHostel({ name, capacity, availableRooms: available, createdAt: serverTimestamp() });
            });
        }

        async function addHostel(hostelData) {
            showLoading('Adding hostel...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to add hostel data.', false);
                    hideLoading();
                    return;
                }
                await setDoc(doc(db, 'hostels', hostelData.name), hostelData); // Using name as ID for simplicity
                showCustomModal('Success', 'Hostel added successfully.', false);
                fetchHostels();
            } catch (error) {
                showCustomModal('Error', 'Failed to add hostel: ' + error.message, false);
                console.error("Error adding hostel:", error);
            } finally {
                hideLoading();
            }
        }

        function editHostelModal(hostel) {
            showCustomModal('Edit Hostel', `
                <input type="text" id="editHostelName" placeholder="Hostel Name" class="w-full p-2 mb-2 border rounded-md" value="${hostel.name}" />
                <input type="number" id="editHostelCapacity" placeholder="Total Capacity" class="w-full p-2 mb-2 border rounded-md" value="${hostel.capacity}" />
                <input type="number" id="editHostelAvailable" placeholder="Available Rooms" class="w-full p-2 mb-2 border rounded-md" value="${hostel.availableRooms}" />
            `, true, async () => {
                const name = document.getElementById('editHostelName').value;
                const capacity = parseInt(document.getElementById('editHostelCapacity').value);
                const available = parseInt(document.getElementById('editHostelAvailable').value);

                if (!name || isNaN(capacity) || isNaN(available) || capacity < 0 || available < 0) {
                    showCustomModal('Error', 'Please enter valid hostel details.', false);
                    return;
                }
                await updateHostel(hostel.id, { name, capacity, availableRooms: available });
            });
        }

        async function updateHostel(id, hostelData) {
            showLoading('Updating hostel...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to update hostel data.', false);
                    hideLoading();
                    return;
                }
                await updateDoc(doc(db, 'hostels', id), hostelData);
                showCustomModal('Success', 'Hostel updated successfully.', false);
                fetchHostels();
            } catch (error) {
                showCustomModal('Error', 'Failed to update hostel: ' + error.message, false);
                console.error("Error updating hostel:", error);
            } finally {
                hideLoading();
            }
        }

        async function deleteHostel(id) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this hostel record? This action cannot be undone.', true, async () => {
                showLoading('Deleting hostel...');
                try {
                    const currentUser = auth.currentUser;
                    const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                    if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                        showCustomModal('Permission Denied', 'You do not have permission to delete hostel data.', false);
                        hideLoading();
                        return;
                    }
                    await deleteDoc(doc(db, 'hostels', id));
                    showCustomModal('Success', 'Hostel deleted successfully.', false);
                    fetchHostels();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete hostel: ' + error.message, false);
                    console.error("Error deleting hostel:", error);
                } finally {
                    hideLoading();
                }
            });
        }

        async function toggleHostelApplications() {
            showLoading('Toggling hostel applications...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to toggle hostel applications.', false);
                    hideLoading();
                    return;
                }

                const settingsDocRef = doc(db, 'settings', 'hostelApplications');
                const settingsSnap = await getDoc(settingsDocRef);
                let currentStatus = true; // Default to open if not set
                if (settingsSnap.exists()) {
                    currentStatus = settingsSnap.data().isOpen;
                }

                const newStatus = !currentStatus;
                await setDoc(settingsDocRef, { isOpen: newStatus }, { merge: true });
                showCustomModal('Success', `Hostel applications are now ${newStatus ? 'OPEN' : 'CLOSED'}.`, false);
                updateToggleHostelAppButton();
            } catch (error) {
                showCustomModal('Error', 'Failed to toggle hostel applications: ' + error.message, false);
                console.error("Error toggling hostel applications:", error);
            } finally {
                hideLoading();
            }
        }

        async function updateToggleHostelAppButton() {
            const btn = document.getElementById('toggleHostelAppBtn');
            if (btn) {
                try {
                    const settingsDocRef = doc(db, 'settings', 'hostelApplications');
                    const settingsSnap = await getDoc(settingsDocRef);
                    let isOpen = false;
                    if (settingsSnap.exists()) {
                        isOpen = settingsSnap.data().isOpen;
                    }
                    btn.innerText = `Toggle Applications (${isOpen ? 'OPEN' : 'CLOSED'})`;
                    btn.classList.remove('bg-yellow-600', 'bg-green-600', 'bg-red-600');
                    btn.classList.add(isOpen ? 'bg-green-600' : 'bg-red-600');
                } catch (error) {
                    console.error("Error updating toggle button status:", error);
                }
            }
        }


        // --- Announcements ---
        async function fetchAnnouncements() {
            showLoading('Fetching announcements...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#announcementsTable tbody').innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">You do not have permission to view announcements.</td></tr>`;
                    hideLoading();
                    return;
                }

                const announcementsRef = collection(db, 'announcements');
                const snapshot = await getDocs(query(announcementsRef, orderBy('createdAt', 'desc'))); // Use createdAt for ordering
                const announcements = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                // Map 'message' to 'content' for consistency with renderTable column expected
                const mappedAnnouncements = announcements.map(ann => ({
                    ...ann,
                    content: ann.body || ann.message || 'No content' // Use 'body' if present, else 'message'
                }));

                const columns = ['createdAt', 'title', 'content']; // Use createdAt
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (ann) => editAnnouncementModal(ann) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (ann) => deleteAnnouncement(ann.id) }
                ];

                renderTable('announcementsTable', mappedAnnouncements, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch announcements: ' + error.message, false);
                console.error("Error fetching announcements:", error);
            } finally {
                hideLoading();
            }
        }

        function addAnnouncementModal() {
            showCustomModal('Add New Announcement', `
                <input type="text" id="addAnnounceTitle" placeholder="Title" class="w-full p-2 mb-2 border rounded-md" />
                <textarea id="addAnnounceMessage" placeholder="Announcement Content" class="w-full p-2 mb-2 border rounded-md h-24"></textarea>
            `, true, async () => {
                const title = document.getElementById('addAnnounceTitle').value;
                const message = document.getElementById('addAnnounceMessage').value;

                if (!title || !message) {
                    showCustomModal('Error', 'Title and message are required.', false);
                    return;
                }
                await addAnnouncement({ title, body: message, createdAt: serverTimestamp() }); // Use 'body' to match original structure
            });
        }

        async function addAnnouncement(announcementData) {
            showLoading('Adding announcement...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to add announcements.', false);
                    hideLoading();
                    return;
                }
                await addDoc(collection(db, 'announcements'), announcementData); // Use addDoc for auto-ID
                showCustomModal('Success', 'Announcement added successfully.', false);
                fetchAnnouncements();
            } catch (error) {
                showCustomModal('Error', 'Failed to add announcement: ' + error.message, false);
                console.error("Error adding announcement:", error);
            } finally {
                hideLoading();
            }
        }

        function editAnnouncementModal(announcement) {
            showCustomModal('Edit Announcement', `
                <input type="text" id="editAnnounceTitle" placeholder="Title" class="w-full p-2 mb-2 border rounded-md" value="${announcement.title}" />
                <textarea id="editAnnounceMessage" placeholder="Announcement Content" class="w-full p-2 mb-2 border rounded-md h-24">${announcement.body || announcement.content || ''}</textarea>
            `, true, async () => { // Use 'body' or 'content'
                const title = document.getElementById('editAnnounceTitle').value;
                const message = document.getElementById('editAnnounceMessage').value;

                if (!title || !message) {
                    showCustomModal('Error', 'Title and message are required.', false);
                    return;
                }
                await updateAnnouncement(announcement.id, { title, body: message }); // Update 'body'
            });
        }

        async function updateAnnouncement(id, announcementData) {
            showLoading('Updating announcement...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to update announcements.', false);
                    hideLoading();
                    return;
                }
                await updateDoc(doc(db, 'announcements', id), announcementData);
                showCustomModal('Success', 'Announcement updated successfully.', false);
                fetchAnnouncements();
            } catch (error) {
                showCustomModal('Error', 'Failed to update announcement: ' + error.message, false);
                console.error("Error updating announcement:", error);
            } finally {
                hideLoading();
            }
        }

        async function deleteAnnouncement(id) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this announcement? This action cannot be undone.', true, async () => {
                showLoading('Deleting announcement...');
                try {
                    const currentUser = auth.currentUser;
                    const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                    if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                        showCustomModal('Permission Denied', 'You do not have permission to delete announcements.', false);
                        hideLoading();
                        return;
                    }
                    await deleteDoc(doc(db, 'announcements', id));
                    showCustomModal('Success', 'Announcement deleted successfully.', false);
                    fetchAnnouncements();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete announcement: ' + error.message, false);
                    console.error("Error deleting announcement:", error);
                } finally {
                    hideLoading();
                }
            });
        }


        // --- Graduation Requests ---
        async function fetchGraduationRequests() {
            showLoading('Fetching graduation requests...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#graduationRequestsTable tbody').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">You do not have permission to view graduation requests.</td></tr>`;
                    hideLoading();
                    return;
                }

                const requestsRef = collection(db, 'graduationRequests');
                const snapshot = await getDocs(requestsRef);
                const requests = [];

                for (const d of snapshot.docs) {
                    const data = d.data();
                    if (data.studentId) {
                        const studentDoc = await getDoc(doc(db, 'students', data.studentId));
                        const studentName = studentDoc.exists() ? studentDoc.data().name : 'Unknown Student';
                        const studentEmail = studentDoc.exists() ? studentDoc.data().email : 'N/A';
                        requests.push({ id: d.id, studentName, studentEmail, ...data });
                    } else {
                        requests.push({ id: d.id, studentName: 'Missing Student ID', studentEmail: 'N/A', ...data });
                    }
                }

                const columns = ['studentName', 'studentEmail', 'date', 'status'];
                const actions = [
                    { text: 'Approve', class: 'bg-green-500 text-white px-2 py-1 rounded-lg mr-1', handler: (req) => updateGraduationRequestStatus(req.id, 'Approved'), condition: (req) => req.status !== 'Approved' },
                    { text: 'Reject', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (req) => updateGraduationRequestStatus(req.id, 'Denied'), condition: (req) => req.status !== 'Denied' }
                ];

                renderTable('graduationRequestsTable', requests, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch graduation requests: ' + error.message, false);
                console.error("Error fetching graduation requests:", error);
            } finally {
                hideLoading();
            }
        }

        async function updateGraduationRequestStatus(id, status) {
            showLoading(`Updating request to ${status}...`);
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to update graduation requests.', false);
                    hideLoading();
                    return;
                }
                await updateDoc(doc(db, 'graduationRequests', id), { status: status });
                showCustomModal('Success', `Graduation request ${status} successfully.`, false);
                fetchGraduationRequests();
            } catch (error) {
                showCustomModal('Error', 'Failed to update request: ' + error.message, false);
                console.error("Error updating graduation request status:", error);
            } finally {
                hideLoading();
            }
        }

        // --- Clearance Requests ---
        async function fetchClearanceRequests() {
            showLoading('Fetching clearance requests...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#clearanceRequestsTable tbody').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">You do not have permission to view clearance requests.</td></tr>`;
                    hideLoading();
                    return;
                }

                const requestsRef = collection(db, 'clearanceRequests');
                const snapshot = await getDocs(requestsRef);
                const requests = [];

                for (const d of snapshot.docs) {
                    const data = d.data();
                    if (data.studentId) {
                        const studentDoc = await getDoc(doc(db, 'students', data.studentId));
                        const studentName = studentDoc.exists() ? studentDoc.data().name : 'Unknown Student';
                        const studentEmail = studentDoc.exists() ? studentDoc.data().email : 'N/A';
                        requests.push({ id: d.id, studentName, studentEmail, ...data });
                    } else {
                        requests.push({ id: d.id, studentName: 'Missing Student ID', studentEmail: 'N/A', ...data });
                    }
                }

                const columns = ['studentName', 'studentEmail', 'date', 'status'];
                const actions = [
                    { text: 'Approve', class: 'bg-green-500 text-white px-2 py-1 rounded-lg mr-1', handler: (req) => updateClearanceRequestStatus(req.id, 'Approved'), condition: (req) => req.status !== 'Approved' },
                    { text: 'Reject', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (req) => updateClearanceRequestStatus(req.id, 'Denied'), condition: (req) => req.status !== 'Denied' }
                ];

                renderTable('clearanceRequestsTable', requests, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch clearance requests: ' + error.message, false);
                console.error("Error fetching clearance requests:", error);
            } finally {
                hideLoading();
            }
        }

        async function updateClearanceRequestStatus(id, status) {
            showLoading(`Updating request to ${status}...`);
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to update clearance requests.', false);
                    hideLoading();
                    return;
                }
                await updateDoc(doc(db, 'clearanceRequests', id), { status: status });
                showCustomModal('Success', `Clearance request ${status} successfully.`, false);
                fetchClearanceRequests();
            } catch (error) {
                showCustomModal('Error', 'Failed to update request: ' + error.message, false);
                console.error("Error updating clearance request status:", error);
            } finally {
                hideLoading();
            }
        }

        // --- Admin Management ---
        async function fetchAdmins() {
            showLoading('Fetching admin users...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    document.querySelector('#adminsTable tbody').innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">You do not have permission to view admin users.</td></tr>`;
                    hideLoading();
                    return;
                }

                const adminsRef = collection(db, 'admins');
                const snapshot = await getDocs(adminsRef);
                // Map to include id (which is UID) and email field
                const admins = snapshot.docs.map(d => ({ id: d.id, email: d.data().email, isAdmin: d.data().isAdmin }));

                // Filter out the current logged-in admin from the list to prevent self-deletion
                const filteredAdmins = admins.filter(admin => currentUser && admin.id !== currentUser.uid);

                const columns = ['email', 'isAdmin'];
                const actions = [
                    { text: 'Remove', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (admin) => removeAdmin(admin.id), condition: (admin) => currentUser && admin.id !== currentUser.uid }
                ];

                renderTable('adminsTable', filteredAdmins, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch admin users: ' + error.message, false);
                console.error("Error fetching admin users:", error);
            } finally {
                hideLoading();
            }
        }

        function addAdminModal() {
            showCustomModal('Add New Admin', `
                <input type="email" id="newAdminEmail" placeholder="Admin Email" class="w-full p-2 mb-2 border rounded-md" required />
                <input type="password" id="newAdminPassword" placeholder="Temporary Password" class="w-full p-2 mb-2 border rounded-md" required />
                <p class="text-sm text-gray-600">The new admin will use this temporary password to log in and should change it immediately.</p>
            `, true, async () => {
                const email = document.getElementById('newAdminEmail').value;
                const password = document.getElementById('newAdminPassword').value;

                if (!email || !password) {
                    showCustomModal('Error', 'Please enter both email and a temporary password.', false);
                    return;
                }
                if (password.length < 6) {
                    showCustomModal('Error', 'Password must be at least 6 characters long.', false);
                    return;
                }
                await addNewAdmin(email.toLowerCase(), password);
            });
        }

        async function addNewAdmin(email, password) {
            showLoading('Adding new admin...');
            try {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to add new admins.', false);
                    hideLoading();
                    return;
                }
                
                // 1. Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                // 2. Add admin role to Firestore using UID as document ID
                await setDoc(doc(db, 'admins', uid), {
                    email: email, // Store email as a field
                    isAdmin: true,
                    createdAt: serverTimestamp() // Add timestamp for consistency
                });
                showCustomModal('Success', `${email} added as admin successfully. Their UID is: ${uid}`, false);
                fetchAdmins();
            } catch (error) {
                let errorMessage = 'Failed to add admin: ' + error.message;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'The email address is already in use by another account. You can log in with that account and mark it as admin.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'The password is too weak. Please use a stronger password.';
                }
                showCustomModal('Error', errorMessage, false);
                console.error("Error adding new admin:", error);
            } finally {
                hideLoading();
            }
        }

        async function removeAdmin(uid) {
            showCustomModal('Confirm Removal', `Are you sure you want to remove this admin? This action cannot be undone.`, true, async () => {
                const currentUser = auth.currentUser;
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
                    showCustomModal('Permission Denied', 'You do not have permission to remove admins.', false);
                    hideLoading();
                    return;
                }

                if (currentUser && uid === currentUser.uid) {
                    showCustomModal('Error', 'You cannot remove yourself as an admin.', false);
                    return;
                }
                showLoading('Removing admin...');
                try {
                    await deleteDoc(doc(db, 'admins', uid));
                    showCustomModal('Success', `Admin removed successfully.`, false);
                    fetchAdmins();
                }
                catch (error) {
                    showCustomModal('Error', 'Failed to remove admin: ' + error.message, false);
                    console.error("Error removing admin:", error);
                } finally {
                    hideLoading();
                }
            });
        }

        // Export and Print Functions
        function exportTable(tableId, filename) {
            showLoading('Exporting data...');
            try {
                const table = document.getElementById(tableId);
                if (!table) {
                    showCustomModal('Error', 'Table not found for export.', false);
                    return;
                }

                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
                const allRows = Array.from(table.querySelectorAll('tbody tr'));
                
                const hasData = allRows.length > 0 && allRows[0].cells.length > 1 && !allRows[0].innerText.includes('No data available');

                let data = [];
                if (hasData || headers.length > 0) {
                    data.push(headers.filter(header => header !== 'Actions')); // Exclude "Actions" header
                }
                
                if (hasData) {
                    allRows.forEach(tr => {
                        const rowData = Array.from(tr.querySelectorAll('td'))
                                         .map(td => td.innerText)
                                         .filter((_, index, arr) => index !== arr.length - 1); // Exclude last column (Actions)
                        data.push(rowData);
                    });
                }

                if (data.length <= 1 && hasData === false) {
                    showCustomModal('Info', 'No data to export.', false);
                    return;
                }

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, filename);

                XLSX.writeFile(wb, `${filename}.xlsx`);
                showCustomModal('Success', 'Data exported successfully as Excel/CSV.', false);
            } catch (error) {
                showCustomModal('Error', 'Failed to export data: ' + error.message, false);
                console.error("Error exporting table:", error);
            } finally {
                hideLoading();
            }
        }
        
        function printTable(tableId, title) {
            showLoading('Preparing to print...');
            try {
                const table = document.getElementById(tableId);
                if (!table) {
                    showCustomModal('Error', 'Table not found for printing.', false);
                    return;
                }
                
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
                const allRows = Array.from(table.querySelectorAll('tbody tr'));
                const hasData = allRows.length > 0 && allRows[0].cells.length > 1 && !allRows[0].innerText.includes('No data available');

                if (!hasData) {
                    showCustomModal('Info', 'No data to print.', false);
                    return;
                }

                const rows = allRows.map(tr => 
                    Array.from(tr.querySelectorAll('td'))
                         .map(td => td.innerText)
                         .filter((_, index, arr) => index !== arr.length - 1) // Exclude last column (Actions)
                );
                
                const doc = new jspdf.jsPDF();
                doc.text(title, 14, 20);
                doc.autoTable({
                    startY: 25,
                    head: [headers.filter(header => header !== 'Actions')], // Exclude "Actions"
                    body: rows, 
                    theme: 'striped',
                    headStyles: { fillColor: [26, 79, 50] }
                });
                doc.save(`${title}.pdf`);
                showCustomModal('Success', 'Document generated for printing (PDF).', false);
            } catch (error) {
                showCustomModal('Error', 'Failed to generate printable document: ' + error.message, false);
                console.error("Error printing table:", error);
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>
