<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard — University Portal (Upgraded)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #0b1020;
      --card: #0f172a;
      --muted: #8b98a5;
      --ring: rgba(0,0,0,.08);
      --pri: #10b981; /* emerald */
      --pri-700: #047857;
    }
    html, body { height: 100%; }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: #e5e7eb; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.08); }
    .sidebar { width: 280px; }
    .navlink { @apply flex items-center gap-3 rounded-xl px-4 py-3 transition-all duration-200; }
    .navlink:hover { background: rgba(255,255,255,.06); transform: translateY(-2px); }
    .navlink.active { background: rgba(16,185,129,.15); color: #fff; border: 1px solid rgba(16,185,129,.25); transform: translateY(0); }
    .skeleton { position: relative; overflow: hidden; background: rgba(255,255,255,.06); border-radius: .75rem; }
    .skeleton:after { content: ""; position: absolute; inset: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent); animation: shimmer 1.4s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
    .no-data { background: rgba(16,185,129,.08); border: 1px dashed rgba(16,185,129,.4); color: #c7f8e7; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-4 py-2 border transition-all duration-200; border-color: rgba(255,255,255,.14); }
    .btn-primary { background: var(--pri); color: #08130f; border-color: transparent; }
    .btn-primary:hover { background: #34d399; transform: translateY(-2px); }
    .btn-muted { background: rgba(255,255,255,.06); }
    .table-wrap { overflow-x: auto; }
    table.data { width: 100%; min-width: 880px; border-collapse: separate; border-spacing: 0; }
    table.data th, table.data td { text-align: left; padding: 1.25rem 1rem; }
    table.data thead th { position: sticky; top: 0; background: #0f172a; z-index: 1; text-transform: uppercase; font-size: .75rem; letter-spacing: .05em; color: #9ca3af; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    table.data tbody tr { background: rgba(255,255,255,.02); transition: background .2s; }
    table.data tbody tr:nth-child(even) { background: rgba(255,255,255,.04); }
    table.data tbody tr:hover { background: rgba(16,185,129,.08); }
    table.data tbody tr:last-child td { border-bottom: none; }
    .chip { @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-medium; background: rgba(16,185,129,.15); color: #c7f8e7; }
    /* Mobile tweaks */
    @media (min-width: 1024px){ #burger { display:none; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .login-fade-in { animation: fadeIn 1s ease-out; }
    .stat-card-gradient { background: linear-gradient(45deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
  </style>
</head>
<body>
  <div id="loading" class="fixed inset-0 hidden place-items-center z-[100] bg-slate-900/60 backdrop-blur-sm">
    <div class="w-72 glass p-6 rounded-2xl shadow-2xl text-center">
      <div class="mx-auto mb-4 h-12 w-12 rounded-full border-4 border-emerald-500 border-t-transparent animate-spin"></div>
      <div id="loadingText" class="text-emerald-300 font-semibold">Loading…</div>
    </div>
  </div>

  <div id="loginView" class="min-h-screen grid place-items-center p-6 bg-cover bg-center">
    <div class="w-full max-w-lg glass rounded-3xl p-8 shadow-2xl relative overflow-hidden login-fade-in">
      <div class="flex items-center justify-center gap-4 mb-8 relative z-10">
        <div class="h-14 w-14 rounded-2xl bg-emerald-500 grid place-items-center text-slate-900 text-2xl shadow-xl"><i class="fa-solid fa-graduation-cap"></i></div>
        <h1 class="text-4xl font-extrabold text-white tracking-wide">Admin Login</h1>
      </div>
      <p class="text-sm text-slate-400 mb-6 text-center relative z-10">Sign in with an account that has administrator privileges.</p>
      <div class="space-y-4 relative z-10">
        <div>
          <label class="block text-sm text-slate-400 mb-2">Email</label>
          <div class="relative">
            <input id="email" type="email" class="w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 pl-12 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all" placeholder="admin@example.com" />
            <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
          </div>
        </div>
        <div>
          <label class="block text-sm text-slate-400 mb-2">Password</label>
          <div class="relative">
            <input id="password" type="password" class="w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 pl-12 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all" placeholder="••••••••" />
            <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
          </div>
        </div>
        <button id="loginBtn" class="btn btn-primary w-full justify-center text-lg font-semibold mt-6 transition-all transform hover:scale-105"><i class="fa-solid fa-right-to-bracket"></i> Sign In</button>
      </div>
    </div>
  </div>

  <div id="app" class="hidden min-h-screen">
    <header class="lg:hidden sticky top-0 z-40 px-4 py-3 flex items-center justify-between glass">
      <button id="burger" class="btn btn-muted px-3 py-2"><i class="fa-solid fa-bars"></i></button>
      <div class="flex items-center gap-2 font-semibold"><i class="fa-solid fa-graduation-cap text-emerald-400"></i> Admin Portal</div>
      <button id="logoutBtn" class="btn btn-muted"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
    </header>

    <div class="flex">
      <aside id="sidebar" class="sidebar fixed lg:sticky top-0 left-0 h-[100dvh] lg:h-[calc(100vh)] glass p-4 flex flex-col gap-4 -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50">
        <div class="hidden lg:flex items-center gap-3 px-2">
          <div class="h-10 w-10 rounded-xl bg-emerald-500 grid place-items-center text-slate-900 shadow-xl"><i class="fa-solid fa-graduation-cap"></i></div>
          <div>
            <div class="font-bold text-xl leading-tight text-white">University Portal</div>
            <div class="text-sm text-emerald-300">Admin Control</div>
          </div>
        </div>
        <nav class="mt-4 space-y-2">
          <div class="text-xs font-semibold uppercase text-slate-500 px-2 pt-2 pb-1">Main Menu</div>
          <a data-section="dashboard" class="navlink active group" href="#"><i class="fa-solid fa-chart-line group-hover:text-emerald-300 transition-colors"></i><span>Dashboard</span></a>
          <a data-section="students" class="navlink group" href="#"><i class="fa-solid fa-users group-hover:text-emerald-300 transition-colors"></i><span>Students</span></a>
          <a data-section="courses" class="navlink group" href="#"><i class="fa-solid fa-book group-hover:text-emerald-300 transition-colors"></i><span>Courses</span></a>
          <a data-section="fees" class="navlink group" href="#"><i class="fa-solid fa-money-bill-wave group-hover:text-emerald-300 transition-colors"></i><span>Fees</span></a>
          <div class="text-xs font-semibold uppercase text-slate-500 px-2 pt-4 pb-1">Management</div>
          <a data-section="grades" class="navlink group" href="#"><i class="fa-solid fa-award group-hover:text-emerald-300 transition-colors"></i><span>Grades</span></a>
          <a data-section="hostels" class="navlink group" href="#"><i class="fa-solid fa-building group-hover:text-emerald-300 transition-colors"></i><span>Hostels</span></a>
          <a data-section="announcements" class="navlink group" href="#"><i class="fa-solid fa-bullhorn group-hover:text-emerald-300 transition-colors"></i><span>Announcements</span></a>
          <a data-section="graduation" class="navlink group" href="#"><i class="fa-solid fa-graduation-cap group-hover:text-emerald-300 transition-colors"></i><span>Graduation</span></a>
          <a data-section="clearance" class="navlink group" href="#"><i class="fa-solid fa-check-circle group-hover:text-emerald-300 transition-colors"></i><span>Clearance</span></a>
          <a data-section="admins" class="navlink group" href="#"><i class="fa-solid fa-user-shield group-hover:text-emerald-300 transition-colors"></i><span>Admins</span></a>
        </nav>
        <div class="mt-auto">
          <button id="logoutBtn2" class="btn w-full justify-center"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button>
        </div>
      </aside>

      <main class="flex-1 min-h-[100dvh] lg:ml-[280px] p-4 lg:p-8 space-y-6">
        <div class="hidden lg:flex items-center justify-between">
          <h1 class="text-2xl lg:text-3xl font-bold">Admin Dashboard</h1>
          <div class="text-sm text-slate-400" id="adminBadge"><span class="chip">Not verified</span></div>
        </div>

        <section id="dashboardSection" class="space-y-6"></section>
        <section id="studentsSection" class="hidden space-y-4"></section>
        <section id="coursesSection" class="hidden space-y-4"></section>
        <section id="feesSection" class="hidden space-y-4"></section>
        <section id="gradesSection" class="hidden space-y-4"></section>
        <section id="hostelsSection" class="hidden space-y-4"></section>
        <section id="announcementsSection" class="hidden space-y-4"></section>
        <section id="graduationSection" class="hidden space-y-4"></section>
        <section id="clearanceSection" class="hidden space-y-4"></section>
        <section id="adminsSection" class="hidden space-y-4"></section>
      </main>
    </div>
  </div>

  <script type="module">
    /* =========================
       Firebase Setup
    ==========================*/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.firebaseostorage.app",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Single admin check flag (set ONCE after login)
    let isAdminUser = false;

    /* =========================
       DOM helpers
    ==========================*/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    const setLoading = (on, text='Loading…') => {
      const overlay = $('#loading');
      $('#loadingText').textContent = text;
      on ? overlay.classList.remove('hidden') : overlay.classList.add('hidden');
    };

    const renderPlaceholder = (container, { title, icon, lines = [], note }) => {
      container.innerHTML = `
        <div class="no-data rounded-2xl p-4">
          <h3 class="text-lg font-semibold mb-1"><i class="${icon} mr-2 text-emerald-400"></i>${title}</h3>
          ${lines.map(l => `<p class="text-sm text-emerald-200/90">${l}</p>`).join('')}
          ${note ? `<p class="text-xs mt-2 text-emerald-200/70">${note}</p>`: ''}
        </div>`;
    };

    const renderSkeletonCards = (container, n=4) => {
      container.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">${
        Array.from({length:n}).map(() => `<div class="skeleton h-28"></div>`).join('')
      }</div>`;
    };

    const table = (headers, rows) => `
      <div class="table-wrap glass rounded-2xl">
        <table class="data">
          <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
          <tbody>
            ${rows.length ? rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="${headers.length}" class="py-6 text-center text-slate-400">No data available.</td></tr>`}
          </tbody>
        </table>
      </div>`;

    const exportTable = (tableId, filename) => {
      const tbl = document.getElementById(tableId);
      if(!tbl) return;
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(tbl);
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, `${filename}.xlsx`);
    };

    /* =========================
       Auth flow (single admin check)
    ==========================*/
    const loginView = $('#loginView');
    const appShell = $('#app');

    const showApp = () => { hide(loginView); show(appShell); };
    const showLogin = () => { show(loginView); hide(appShell); };

    onAuthStateChanged(auth, async (user) => {
      if(!user){ isAdminUser=false; showLogin(); return; }
      setLoading(true, 'Verifying administrator…');
      try {
        const adminDoc = await getDoc(doc(db, 'admins', user.uid));
        if(adminDoc.exists() && adminDoc.data().isAdmin === true){
          isAdminUser = true; // ✅ set once
          $('#adminBadge').innerHTML = '<span class="chip bg-emerald-600/30">Admin verified</span>';
          showApp();
          // default section
          activateSection('dashboard');
        } else {
          await signOut(auth);
          alert('Your account is not authorized as an administrator.');
        }
      } catch(err){
        console.error(err);
        alert('Login verification failed: '+err.message);
      } finally { setLoading(false); }
    });

    $('#loginBtn').addEventListener('click', async() => {
      const email = $('#email').value.trim();
      const password = $('#password').value;
      if(!email || !password){ alert('Enter email and password.'); return; }
      setLoading(true, 'Signing in…');
      try{ await signInWithEmailAndPassword(auth, email, password); } catch(e){ alert(e.message); } finally{ setLoading(false); }
    });

    const doLogout = async () => { try{ await signOut(auth); } catch(e){ alert('Logout failed: '+e.message);} };
    $('#logoutBtn').addEventListener('click', doLogout);
    $('#logoutBtn2').addEventListener('click', doLogout);

    // Mobile sidebar toggle
    $('#burger').addEventListener('click', ()=> {
      const sb = $('#sidebar');
      const open = !sb.classList.contains('-translate-x-full');
      if(open) sb.classList.add('-translate-x-full'); else sb.classList.remove('-translate-x-full');
    });

    /* =========================
       Navigation + sections
    ==========================*/
    const activateSection = (key) => {
      // links
      $$(".navlink").forEach(a=>{
        if(a.dataset.section===key) a.classList.add('active'); else a.classList.remove('active');
      });
      // sections
      const ids = ['dashboard','students','courses','fees','grades','hostels','announcements','graduation','clearance','admins'];
      ids.forEach(id => { const sec = document.getElementById(id+"Section"); id===key ? show(sec) : hide(sec); });
      // render immediate placeholders (never blocked by Firestore)
      preloadSection(key);
      // then fetch
      fetchSection(key);
      // close mobile sidebar
      $('#sidebar').classList.add('-translate-x-full');
    };

    $$(".navlink").forEach(a => a.addEventListener('click', e => { e.preventDefault(); activateSection(a.dataset.section); }));

    const preloadSection = (key) => {
      const sec = document.getElementById(key+"Section");
      if(!sec) return;
      sec.innerHTML = '';
      // Always show an informative header + skeletons or default tips
      if(key==='dashboard'){
        const wrap = document.createElement('div');
        wrap.className = 'space-y-4';
        wrap.innerHTML = `
          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
            <div class="glass p-6 rounded-2xl relative overflow-hidden group">
                <i class="fa-solid fa-users absolute top-4 right-4 text-slate-600/50 text-5xl transition-transform group-hover:scale-110"></i>
                <div class="text-sm text-slate-400 mb-1">Total Students</div>
                <div id="statStudents" class="text-4xl font-extrabold mt-1 text-white">0</div>
            </div>
            <div class="glass p-6 rounded-2xl relative overflow-hidden group">
                <i class="fa-solid fa-book absolute top-4 right-4 text-slate-600/50 text-5xl transition-transform group-hover:scale-110"></i>
                <div class="text-sm text-slate-400 mb-1">Total Courses</div>
                <div id="statCourses" class="text-4xl font-extrabold mt-1 text-white">0</div>
            </div>
            <div class="glass p-6 rounded-2xl relative overflow-hidden group">
                <i class="fa-solid fa-graduation-cap absolute top-4 right-4 text-slate-600/50 text-5xl transition-transform group-hover:scale-110"></i>
                <div class="text-sm text-slate-400 mb-1">Pending Graduation</div>
                <div id="statGrad" class="text-4xl font-extrabold mt-1 text-white">0</div>
            </div>
            <div class="glass p-6 rounded-2xl relative overflow-hidden group">
                <i class="fa-solid fa-check-circle absolute top-4 right-4 text-slate-600/50 text-5xl transition-transform group-hover:scale-110"></i>
                <div class="text-sm text-slate-400 mb-1">Pending Clearance</div>
                <div id="statClear" class="text-4xl font-extrabold mt-1 text-white">0</div>
            </div>
          </div>
          <div id="dashTips"></div>`;
        sec.appendChild(wrap);
        renderPlaceholder($('#dashTips'), { title: 'Dashboard Overview', icon: 'fa-solid fa-chart-line', lines:[
          'This overview will auto-populate when connected to Firestore.',
          'Use the sidebar to manage students, courses, finances, and more.'
        ], note: 'Tip: Click Students or Courses to begin.' });
      } else {
        const tips = document.createElement('div');
        sec.appendChild(tips);
        const map = {
          students: ['Manage and view registered students.', 'Search, edit, export, and print lists.'],
          courses: ['Manage available courses.', 'Add, edit, or remove courses.'],
          fees: ['Search a student to view their statement.', 'Record charges/payments and export.'],
          grades: ['View and record student grades.', 'Generate transcripts as needed.'],
          hostels: ['Manage hostel capacity and settings.', 'Toggle applications open/closed.'],
          announcements: ['Create announcements for all users.', 'Edit or remove outdated notices.'],
          graduation: ['Track graduation requests and status.'],
          clearance: ['Track clearance requests and status.'],
          admins: ['Manage admin accounts and roles.']
        };
        renderPlaceholder(tips, { title: key.charAt(0).toUpperCase()+key.slice(1), icon:'fa-solid fa-circle-info', lines: map[key]||[], note: 'This appears even without Firestore data.'});
        // quick skeleton where tables usually go
        const sk = document.createElement('div'); sk.className='grid grid-cols-1 gap-3';
        sk.innerHTML = `<div class="skeleton h-12"></div><div class="skeleton h-12"></div><div class="skeleton h-12"></div>`;
        sec.appendChild(sk);
      }
    };

    /* =========================
       Fetchers (execute after UI shows)
       Note: they rely on isAdminUser; UI never blocks
    ==========================*/
    const fetchSection = async (key) => {
      try{
        if(!isAdminUser) return; // respect single admin verification; do not re-check
        if(key==='dashboard') return fetchDashboard();
        if(key==='students') return fetchStudents();
        if(key==='courses') return fetchCourses();
        if(key==='fees') return renderFeesSearch();
        if(key==='grades') return renderGradesSearch();
        if(key==='hostels') return fetchHostels();
        if(key==='announcements') return fetchAnnouncements();
        if(key==='graduation') return fetchGraduation();
        if(key==='clearance') return fetchClearance();
        if(key==='admins') return fetchAdmins();
      } catch(e){ console.error(e); }
    };

    /* ============= Dashboard ============= */
    const fetchDashboard = async () => {
      const [studentsSnap, coursesSnap, gradSnap, clearSnap] = await Promise.all([
        getDocs(collection(db,'students')),
        getDocs(collection(db,'courses')),
        getDocs(query(collection(db,'graduationRequests'), where('status','==','Pending'))),
        getDocs(query(collection(db,'clearanceRequests'), where('status','==','Pending')))
      ]);
      $('#statStudents').textContent = studentsSnap.size;
      $('#statCourses').textContent = coursesSnap.size;
      $('#statGrad').textContent = gradSnap.size;
      $('#statClear').textContent = clearSnap.size;
    };

    /* ============= Students ============= */
    const fetchStudents = async () => {
      const sec = $('#studentsSection');
      const snap = await getDocs(collection(db,'students'));
      const rows = snap.docs.map(d => ({ uid:d.id, ...d.data() }));
      const hdrs = ['Name','Email','Program','Year','Contact','Actions'];
      const html = table(hdrs, rows.map(r => [
        r.name||'—', r.email||'—', r.programme||'—', r.year||'—', r.contact||'—',
        `<div class="flex gap-2"><button class="btn btn-muted" onclick="window.editStudent('${r.uid}')">Edit</button><button class="btn btn-muted" onclick="window.deleteStudent('${r.uid}')">Delete</button></div>`
      ]));
      const box = document.createElement('div');
      box.className = 'space-y-3';
      box.innerHTML = `
        <div class="flex flex-col sm:flex-row gap-2 sm:items-center justify-between">
          <input id="studentSearch" class="w-full sm:w-72 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" placeholder="Search students…"/>
          <div class="flex gap-2">
            <button class="btn btn-primary" onclick="window.addStudent()"><i class="fa-solid fa-user-plus"></i> Add</button>
            <button class="btn" onclick="window.exportById('studentsTbl','Students')"><i class="fa-solid fa-file-export"></i> Export</button>
          </div>
        </div>
        <div class="glass rounded-2xl p-2">
          <div class="table-wrap">
            <table id="studentsTbl" class="data"><thead><tr>${hdrs.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>
              ${rows.length? rows.map(r=>`<tr>
                <td>${r.name||'—'}</td><td>${r.email||'—'}</td><td>${r.programme||'—'}</td><td>${r.year||'—'}</td><td>${r.contact||'—'}</td>
                <td><div class="flex gap-2"><button class="btn btn-muted" onclick="window.editStudent('${r.uid}')">Edit</button><button class="btn btn-muted" onclick="window.deleteStudent('${r.uid}')">Delete</button></div></td>
              </tr>`).join('') : `<tr><td colspan="6" class="py-6 text-center text-slate-400">No students yet.</td></tr>`}
            </tbody></table>
          </div>
        </div>`;
      sec.innerHTML = '';
      sec.appendChild(box);
      // simple client filter
      const input = $('#studentSearch');
      input?.addEventListener('input', () => {
        const v = input.value.toLowerCase();
        $$('#studentsTbl tbody tr').forEach(tr => {
          tr.style.display = tr.textContent.toLowerCase().includes(v) ? '' : 'none';
        });
      });
    };

    // Basic CRUD exposed globally for inline handlers
    window.addStudent = () => {
      const name = prompt('Full name'); if(!name) return;
      const email = prompt('Email (document id)'); if(!email) return;
      setDoc(doc(db,'students', email.toLowerCase()), { name, email: email.toLowerCase(), createdAt: serverTimestamp() });
    };
    window.editStudent = async(uid) => {
      const snap = await getDoc(doc(db,'students', uid)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const name = prompt('Full name', cur.name||''); if(!name) return;
      await updateDoc(doc(db,'students', uid), { name });
      activateSection('students');
    };
    window.deleteStudent = async(uid) => { if(!confirm('Delete this student?')) return; await deleteDoc(doc(db,'students', uid)); activateSection('students'); };

    /* ============= Courses ============= */
    const fetchCourses = async () => {
      const sec = $('#coursesSection');
      const snap = await getDocs(collection(db,'courses'));
      const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      const hdrs = ['Code','Name','Credits','Lecturer','Schedule','Actions'];
      sec.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm text-slate-400">Manage courses</div>
          <div class="flex gap-2">
            <button class="btn btn-primary" onclick="window.addCourse()"><i class="fa-solid fa-plus"></i> Add</button>
            <button class="btn" onclick="window.exportById('coursesTbl','Courses')"><i class="fa-solid fa-file-export"></i> Export</button>
          </div>
        </div>
        <div class="glass rounded-2xl p-2 table-wrap">
          <table id="coursesTbl" class="data"><thead><tr>${hdrs.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>
            ${rows.length? rows.map(r=>`<tr>
              <td>${r.code||r.id}</td><td>${r.title||'—'}</td><td>${r.credits||'—'}</td><td>${r.lecturer||'—'}</td><td>${r.schedule||'—'}</td>
              <td><div class="flex gap-2"><button class="btn btn-muted" onclick="window.editCourse('${r.id}')">Edit</button><button class="btn btn-muted" onclick="window.deleteCourse('${r.id}')">Delete</button></div></td>
            </tr>`).join('') : `<tr><td colspan="6" class="py-6 text-center text-slate-400">No courses yet.</td></tr>`}
          </tbody></table>
        </div>`;
    };
    window.addCourse = async () => {
      const code = prompt('Course code (doc id)'); if(!code) return;
      const title = prompt('Course name'); if(!title) return;
      await setDoc(doc(db,'courses', code), { code, title, createdAt: serverTimestamp() });
      activateSection('courses');
    };
    window.editCourse = async (id) => {
      const snap = await getDoc(doc(db,'courses', id)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const title = prompt('Course name', cur.title||''); if(!title) return;
      await updateDoc(doc(db,'courses', id), { title });
      activateSection('courses');
    };
    window.deleteCourse = async(id) => { if(!confirm('Delete this course?')) return; await deleteDoc(doc(db,'courses', id)); activateSection('courses'); };

    /* ============= Fees ============= */
    const renderFeesSearch = () => {
      const sec = $('#feesSection');
      sec.innerHTML = `
        <div class="glass rounded-2xl p-4 space-y-3">
          <div class="flex flex-col sm:flex-row gap-2 sm:items-center justify-between">
            <input id="feesEmail" class="w-full sm:w-80 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" placeholder="Search student by email…"/>
            <button class="btn btn-primary" id="btnFeesSearch"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
          </div>
          <div id="feesInfo"></div>
          <div id="feesTableWrap"></div>
        </div>`;
      $('#btnFeesSearch').addEventListener('click', doFeesSearch);
      renderPlaceholder($('#feesInfo'), { title:'Fees Management', icon:'fa-solid fa-money-bill-wave', lines:['Look up a student to view their statement.']});
    };

    const doFeesSearch = async () => {
      const email = ($('#feesEmail').value||'').toLowerCase();
      if(!email) return alert('Enter a student email.');
      const q = query(collection(db,'students'), where('email','==', email));
      const res = await getDocs(q);
      if(res.empty) { $('#feesTableWrap').innerHTML = '<div class="no-data rounded-2xl p-3">Student not found.</div>'; return; }
      const stu = { uid: res.docs[0].id, ...res.docs[0].data() };
      $('#feesInfo').innerHTML = `<div class="text-sm text-slate-300">Statement for <span class="font-semibold">${stu.name||email}</span></div>`;
      // simple demo table — adapt to your structure
      const hdrs = ['Date','Description','Amount','Balance'];
      const rows = [];
      $('#feesTableWrap').innerHTML = table(hdrs, rows);
    };

    /* ============= Grades ============= */
    const renderGradesSearch = () => {
      const sec = $('#gradesSection');
      sec.innerHTML = `
        <div class="glass rounded-2xl p-4 space-y-3">
          <div class="flex flex-col sm:flex-row gap-2 sm:items-center justify-between">
            <input id="gradesEmail" class="w-full sm:w-80 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" placeholder="Search student by email…"/>
            <button class="btn btn-primary" id="btnGradesSearch"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
          </div>
          <div id="gradesInfo"></div>
          <div id="gradesTableWrap"></div>
        </div>`;
      $('#btnGradesSearch').addEventListener('click', doGradesSearch);
      renderPlaceholder($('#gradesInfo'), { title:'Grades Management', icon:'fa-solid fa-award', lines:['Look up a student to view their grades.']});
    };
    const doGradesSearch = async () => {
      const email = ($('#gradesEmail').value||'').toLowerCase();
      if(!email) return alert('Enter a student email.');
      const q = query(collection(db,'students'), where('email','==', email));
      const res = await getDocs(q);
      if(res.empty) { $('#gradesTableWrap').innerHTML = '<div class="no-data rounded-2xl p-3">Student not found.</div>'; return; }
      const stu = { uid: res.docs[0].id, ...res.docs[0].data() };
      $('#gradesInfo').innerHTML = `<div class="text-sm text-slate-300">Grades for <span class="font-semibold">${stu.name||email}</span></div>`;
      const hdrs = ['Course Code','Course Name','Grade'];
      const rows = [];
      $('#gradesTableWrap').innerHTML = table(hdrs, rows);
    };

    /* ============= Hostels ============= */
    const fetchHostels = async () => {
      const sec = $('#hostelsSection');
      const snap = await getDocs(collection(db,'hostels'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const hdrs = ['Hostel','Capacity','Occupied','Status','Actions'];
      sec.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm text-slate-400">Manage hostels</div>
          <button class="btn btn-primary" onclick="window.addHostel()"><i class="fa-solid fa-plus"></i> Add</button>
        </div>
        <div class="glass rounded-2xl p-2 table-wrap">
          <table id="hostelsTbl" class="data"><thead><tr>${hdrs.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>
            ${rows.length? rows.map(r=>`<tr>
              <td>${r.name||r.id}</td><td>${r.capacity||'—'}</td><td>${r.occupied||0}</td>
              <td>${r.open===false?'<span class="chip">Closed</span>':'<span class="chip">Open</span>'}</td>
              <td><div class="flex gap-2"><button class="btn btn-muted" onclick="window.editHostel('${r.id}')">Edit</button><button class="btn btn-muted" onclick="window.deleteHostel('${r.id}')">Delete</button></div></td>
            </tr>`).join('') : `<tr><td colspan="5" class="py-6 text-center text-slate-400">No hostels yet.</td></tr>`}
          </tbody></table>
        </div>`;
    };
    window.addHostel = async () => {
      const id = prompt('Hostel id'); if(!id) return;
      const name = prompt('Hostel name'); if(!name) return;
      await setDoc(doc(db,'hostels', id), { name, capacity: 0, occupied: 0, open: true, createdAt: serverTimestamp() });
      activateSection('hostels');
    };
    window.editHostel = async (id) => {
      const snap = await getDoc(doc(db,'hostels', id)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const capacity = parseInt(prompt('Capacity', cur.capacity||0));
      await updateDoc(doc(db,'hostels', id), { capacity });
      activateSection('hostels');
    };
    window.deleteHostel = async (id) => { if(!confirm('Delete hostel?')) return; await deleteDoc(doc(db,'hostels', id)); activateSection('hostels'); };

    /* ============= Announcements ============= */
    const fetchAnnouncements = async () => {
      const sec = $('#announcementsSection');
      const snap = await getDocs(collection(db,'announcements'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const hdrs = ['Title','Body','Created','Actions'];
      sec.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm text-slate-400">Post updates for students</div>
          <button class="btn btn-primary" onclick="window.addAnnouncement()"><i class="fa-solid fa-plus"></i> Add</button>
        </div>
        <div class="glass rounded-2xl p-2 table-wrap">
          <table id="annTbl" class="data"><thead><tr>${hdrs.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>
            ${rows.length? rows.map(r=>`<tr>
              <td>${r.title||'—'}</td><td>${r.body||'—'}</td><td>${(r.createdAt && r.createdAt.toDate)? r.createdAt.toDate().toLocaleString():'—'}</td>
              <td><div class="flex gap-2"><button class="btn btn-muted" onclick="window.editAnnouncement('${r.id}')">Edit</button><button class="btn btn-muted" onclick="window.deleteAnnouncement('${r.id}')">Delete</button></div></td>
            </tr>`).join('') : `<tr><td colspan="4" class="py-6 text-center text-slate-400">No announcements yet.</td></tr>`}
          </tbody></table>
        </div>`;
    };
    window.addAnnouncement = async () => {
      const id = crypto.randomUUID();
      const title = prompt('Title'); if(!title) return;
      const body = prompt('Body'); if(!body) return;
      await setDoc(doc(db,'announcements', id), { title, body, createdAt: serverTimestamp() });
      activateSection('announcements');
    };
    window.editAnnouncement = async (id) => {
      const snap = await getDoc(doc(db,'announcements', id)); if(!snap.exists()) return alert('Not found');
      const cur = snap.data();
      const title = prompt('Title', cur.title||''); if(!title) return;
      const body = prompt('Body', cur.body||''); if(!body) return;
      await updateDoc(doc(db,'announcements', id), { title, body });
      activateSection('announcements');
    };
    window.deleteAnnouncement = async (id) => { if(!confirm('Delete announcement?')) return; await deleteDoc(doc(db,'announcements', id)); activateSection('announcements'); };

    /* ============= Graduation & Clearance ============= */
    const fetchGraduation = async () => {
      const sec = $('#graduationSection');
      const snap = await getDocs(collection(db,'graduationRequests'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      sec.innerHTML = table(['Student','Status','Requested'], rows.map(r=>[
        r.studentEmail||r.id, r.status||'—', (r.createdAt&&r.createdAt.toDate)? r.createdAt.toDate().toLocaleString():'—'
      ]));
    };
    const fetchClearance = async () => {
      const sec = $('#clearanceSection');
      const snap = await getDocs(collection(db,'clearanceRequests'));
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      sec.innerHTML = table(['Student','Status','Requested'], rows.map(r=>[
        r.studentEmail||r.id, r.status||'—', (r.createdAt&&r.createdAt.toDate)? r.createdAt.toDate().toLocaleString():'—'
      ]));
    };

    /* ============= Admins ============= */
    const fetchAdmins = async () => {
      const sec = $('#adminsSection');
      const snap = await getDocs(collection(db,'admins'));
      const rows = snap.docs.map(d=>({ uid:d.id, ...d.data() }));
      const hdrs = ['UID','Email','isAdmin','Actions'];
      sec.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm text-slate-400">Manage administrator accounts</div>
          <button class="btn btn-primary" onclick="window.addAdmin()"><i class="fa-solid fa-user-plus"></i> Add</button>
        </div>
        <div class="glass rounded-2xl p-2 table-wrap">
          <table id="adminsTbl" class="data"><thead><tr>${hdrs.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>
            ${rows.length? rows.map(r=>`<tr>
              <td>${r.uid}</td><td>${r.email||'—'}</td><td>${r.isAdmin? 'Yes':'No'}</td>
              <td><div class="flex gap-2"><button class="btn btn-muted" onclick="window.toggleAdmin('${r.uid}', ${!!r.isAdmin})">Toggle</button><button class="btn btn-muted" onclick="window.deleteAdmin('${r.uid}')">Delete</button></div></td>
            </tr>`).join('') : `<tr><td colspan="4" class="py-6 text-center text-slate-400">No admins yet.</td></tr>`}
          </tbody></table>
        </div>`;
    };
    window.addAdmin = async () => {
      const uid = prompt('Auth UID'); if(!uid) return;
      const email = prompt('Email');
      await setDoc(doc(db,'admins', uid), { email: email||null, isAdmin:true, createdAt: serverTimestamp()});
      activateSection('admins');
    };
    window.toggleAdmin = async (uid, cur) => { await updateDoc(doc(db,'admins', uid), { isAdmin: !cur }); activateSection('admins'); };
    window.deleteAdmin = async (uid) => { if(!confirm('Delete admin doc?')) return; await deleteDoc(doc(db,'admins', uid)); activateSection('admins'); };

    // Utility export by DOM id
    window.exportById = (id, name) => exportTable(id, name);

    // Start on dashboard placeholders if html opens already authenticated
    // (onAuthStateChanged will re-render)
    preloadSection('dashboard');
  </script>
</body>
</html>
