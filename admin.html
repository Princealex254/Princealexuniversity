<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard - Prince Alex Design University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
    <!-- SheetJS for Excel/CSV export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('myschoolgate.png') no-repeat center center fixed;
            background-size: cover;
        }

        .auth-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #0c431b; /* Darker green for a stronger admin feel */
            color: white;
            padding: 1.5rem;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .content-area {
            margin-left: 250px;
            padding: 2rem;
            flex-grow: 1;
            background-color: #f3f4f6;
        }
        
        .main-content {
            padding: 2rem;
        }

        @media (max-width: 1024px) {
            .content-area {
                margin-left: 0;
            }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        thead th {
            background-color: #1a4f32;
            color: white;
            text-transform: uppercase;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay and Modals -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-[2000] hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-700"></div>
        <div id="loadingText" class="mt-4 text-xl text-green-700">Loading...</div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-[10000] hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border border-gray-300">
            <h3 id="modalTitle" class="text-2xl font-semibold mb-4 text-green-800"></h3>
            <p id="modalMessage" class="mb-6 text-gray-700"></p>
            <div class="flex justify-center gap-4">
                <button id="modalConfirmBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out">OK</button>
                <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out hidden">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main Auth Wrapper -->
    <div id="authWrapper" class="auth-wrapper">
        <div id="authForm" class="auth-form">
            <h2 class="text-4xl font-extrabold text-green-800 mb-8 text-center">Admin Login</h2>
            <form id="admin-login-form">
                <div class="mb-6">
                    <label for="email-login" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="email-login" placeholder="Enter your admin email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200"/>
                    <p id="email-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>
                <div class="mb-6">
                    <label for="password-login" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password-login" placeholder="Enter your password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors duration-200"/>
                    <p id="password-login-error" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>
                <button type="submit" id="login-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboardContainer" class="hidden dashboard-container">
        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="sidebar">
            <h3 class="text-2xl font-bold mb-6 pb-3 border-b border-green-700">Admin Panel</h3>
            <ul class="space-y-2">
                <li><a href="#" onclick="showAdminSection('dashboard')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-home mr-3"></i>Dashboard</a></li>
                <li><a href="#" onclick="showAdminSection('students')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-users mr-3"></i>Manage Students</a></li>
                <li><a href="#" onclick="showAdminSection('courses')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-book mr-3"></i>Manage Courses</a></li>
                <li><a href="#" onclick="showAdminSection('fees')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-money-bill-wave mr-3"></i>Manage Fees</a></li>
                <li><a href="#" onclick="showAdminSection('grades')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-award mr-3"></i>Manage Grades</a></li>
                <li><a href="#" onclick="showAdminSection('hostels')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-building mr-3"></i>Hostel Management</a></li>
                <li><a href="#" onclick="showAdminSection('announcements')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-bullhorn mr-3"></i>Announcements</a></li>
                <li><a href="#" onclick="showAdminSection('graduation')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-graduation-cap mr-3"></i>Graduation Requests</a></li>
                <li><a href="#" onclick="showAdminSection('clearance')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-check-circle mr-3"></i>Clearance Requests</a></li>
                <li><a href="#" onclick="showAdminSection('admins')" class="flex items-center p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 text-lg"><i class="fas fa-user-shield mr-3"></i>Admin Management</a></li>
            </ul>
            <div class="mt-auto pt-6 border-t border-green-700">
                <button onclick="confirmLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Mobile Header and Toggler -->
            <header class="bg-white p-4 flex justify-between items-center shadow-md sticky top-0 z-40 lg:hidden">
                <button id="menuToggle" class="text-2xl p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="text-lg font-semibold text-green-700">Admin Portal</span>
                <img src="myschoollogo.png" alt="University Logo" class="h-10 w-auto">
            </header>

            <div class="main-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 pb-2 border-b-2 border-green-700">Admin Dashboard</h1>

                <!-- Dashboard Section -->
                <div id="dashboardSection" class="dashboard-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-users text-4xl text-green-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Total Students</h3>
                            <p id="student-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-book-open text-4xl text-green-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Total Courses</h3>
                            <p id="course-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-hourglass-half text-4xl text-yellow-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Pending Graduation</h3>
                            <p id="graduation-pending-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-hourglass-end text-4xl text-yellow-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Pending Clearance</h3>
                            <p id="clearance-pending-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-600 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700">Outstanding Fees</h3>
                            <p id="outstanding-fees-count" class="text-3xl font-extrabold text-green-800 mt-2">0</p>
                        </div>
                    </div>
                </div>

                <!-- Manage Students Section -->
                <div id="studentsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Students</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <input type="text" id="studentSearch" placeholder="Search students..." class="px-4 py-2 border rounded-lg mb-2 md:mb-0 w-full md:w-auto">
                            <div class="flex space-x-2">
                                <button onclick="addStudentModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Student</button>
                                <button onclick="exportTable('studentsTable', 'Students')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('studentsTable', 'Students')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="studentsTable" class="min-w-full bg-white border-collapse">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Program</th>
                                        <th>Year</th>
                                        <th>Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="text-center py-4 text-gray-500">No data available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Courses Section -->
                <div id="coursesSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Courses</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <input type="text" id="courseSearch" placeholder="Search courses..." class="px-4 py-2 border rounded-lg mb-2 md:mb-0 w-full md:w-auto">
                            <div class="flex space-x-2">
                                <button onclick="addCourseModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Course</button>
                                <button onclick="exportTable('coursesTable', 'Courses')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('coursesTable', 'Courses')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="coursesTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Credits</th>
                                        <th>Lecturer</th>
                                        <th>Schedule</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="text-center py-4 text-gray-500">No data available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Fees Section -->
                <div id="feesSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Fees</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="feesSearch" placeholder="Search student by email..." class="px-4 py-2 border rounded-lg w-full md:w-auto">
                            <button onclick="searchStudentForFees()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 ml-2">Search</button>
                        </div>
                        <div id="feesContent" class="hidden mt-4">
                            <h3 class="text-xl font-bold text-green-800 mb-2">Fee Statement for <span id="studentNameFees"></span></h3>
                            <div class="flex space-x-2 mb-4">
                                <button onclick="addFeeTransactionModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Transaction</button>
                                <button onclick="exportTable('feesTable', 'Fee Statement')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('feesTable', 'Fee Statement')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                            <div class="table-container">
                                <table id="feesTable" class="min-w-full bg-white">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="4" class="text-center py-4 text-gray-500">No fee records found.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Grades Section -->
                <div id="gradesSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Grades</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="gradesSearch" placeholder="Search student by email..." class="px-4 py-2 border rounded-lg w-full md:w-auto">
                            <button onclick="searchStudentForGrades()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 ml-2">Search</button>
                        </div>
                        <div id="gradesContent" class="hidden mt-4">
                            <h3 class="text-xl font-bold text-green-800 mb-2">Grades for <span id="studentNameGrades"></span></h3>
                            <div class="flex space-x-2 mb-4">
                                <button onclick="editGradesModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Edit Grades</button>
                                <button onclick="exportTable('gradesTable', 'Grades Report')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('gradesTable', 'Grades Report')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                            <div class="table-container">
                                <table id="gradesTable" class="min-w-full bg-white">
                                    <thead>
                                        <tr>
                                            <th>Course Code</th>
                                            <th>Course Name</th>
                                            <th>Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="3" class="text-center py-4 text-gray-500">No grades found.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hostel Management Section -->
                <div id="hostelsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Hostel Management</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <div class="flex space-x-2">
                                <button onclick="addHostelModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Hostel</button>
                                <button onclick="toggleHostelApplications()" id="toggleHostelAppBtn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">Toggle Applications</button>
                            </div>
                            <div class="flex space-x-2 mt-2 md:mt-0">
                                <button onclick="exportTable('hostelsTable', 'Hostel List')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('hostelsTable', 'Hostel List')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="hostelsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Capacity</th>
                                        <th>Availability</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="text-center py-4 text-gray-500">No hostel data available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div id="announcementsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Announcements</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                             <button onclick="addAnnouncementModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Announcement</button>
                         </div>
                        <div class="table-container">
                            <table id="announcementsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Title</th>
                                        <th>Content</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="text-center py-4 text-gray-500">No announcements available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Graduation Requests Section -->
                <div id="graduationSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Graduation Requests</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                            <div class="flex space-x-2">
                                <button onclick="exportTable('graduationRequestsTable', 'Graduation Requests')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('graduationRequestsTable', 'Graduation Requests')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="graduationRequestsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Email</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="text-center py-4 text-gray-500">No graduation requests available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Clearance Requests Section -->
                <div id="clearanceSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Clearance Requests</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                            <div class="flex space-x-2">
                                <button onclick="exportTable('clearanceRequestsTable', 'Clearance Requests')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Export</button>
                                <button onclick="printTable('clearanceRequestsTable', 'Clearance Requests')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Print</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="clearanceRequestsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Email</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="text-center py-4 text-gray-500">No clearance requests available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin Management Section -->
                <div id="adminsSection" class="dashboard-section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Management</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-end items-center mb-4">
                             <button onclick="addAdminModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add New Admin</button>
                        </div>
                        <div class="table-container">
                            <table id="adminsTable" class="min-w-full bg-white">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="3" class="text-center py-4 text-gray-500">No other admins.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and custom script -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"; // Added signInWithEmailAndPassword, onAuthStateChanged, signOut
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"; // Added query, where, orderBy, writeBatch

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
          authDomain: "universityweb-19e1e.firebaseapp.com",
          projectId: "universityweb-19e1e",
          storageBucket: "universityweb-19e1e.firebasestorage.app",
          messagingSenderId: "401942926589",
          appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authWrapper = document.getElementById('authWrapper');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const loginForm = document.getElementById('admin-login-form');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');

        // General UI functions from index.html
        function showLoading(text = 'Loading...') {
            loadingText.innerText = text;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showCustomModal(title, message, isConfirmation = false, onConfirm, onCancel) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerText = message;
            document.getElementById('customModal').classList.remove('hidden');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            
            confirmBtn.onclick = () => {
                document.getElementById('customModal').classList.add('hidden');
                if (onConfirm) onConfirm();
            };
            cancelBtn.onclick = () => {
                document.getElementById('customModal').classList.add('hidden');
                if (onCancel) onCancel();
            };

            if (isConfirmation) {
                cancelBtn.classList.remove('hidden');
            } else {
                cancelBtn.classList.add('hidden');
            }
        }

        // Authentication Logic
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['email-login'].value;
            const password = loginForm['password-login'].value;

            try {
                showLoading('Authenticating...');
                const res = await signInWithEmailAndPassword(auth, email, password); // Use signInWithEmailAndPassword with auth instance
                const user = res.user;

                // Check if the user is an admin
                const adminDoc = await getDoc(doc(db, 'admins', user.email));
                if (adminDoc.exists() && adminDoc.data().isAdmin) {
                    showCustomModal('Success', 'Admin login successful!', false);
                } else {
                    // Not authorized, sign out
                    await signOut(auth); // Use signOut with auth instance
                    showCustomModal('Authorization Failed', 'You are not authorized to access this dashboard. Please log in with a valid admin account.', false);
                }

            } catch (error) {
                showCustomModal('Login Failed', error.message, false);
            } finally {
                hideLoading();
            }
        });

        onAuthStateChanged(auth, async (user) => { // Use onAuthStateChanged with auth instance
            if (user) {
                showLoading('Verifying admin access...');
                // Check for admin status on every state change
                const adminDoc = await getDoc(doc(db, 'admins', user.email));
                if (adminDoc.exists() && adminDoc.data().isAdmin) {
                    authWrapper.classList.add('hidden');
                    dashboardContainer.classList.remove('hidden');
                    showAdminSection('dashboard'); // Default to dashboard view
                } else {
                    await signOut(auth); // Force sign out if not an admin
                    authWrapper.classList.remove('hidden');
                    dashboardContainer.classList.add('hidden');
                    showCustomModal('Authorization Failed', 'You are not authorized to access this dashboard. Logging you out.', false);
                }
            } else {
                authWrapper.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
            }
            hideLoading();
        });

        function confirmLogout() {
            showCustomModal('Confirm Logout', 'Are you sure you want to log out?', true, () => {
                showLoading('Logging out...');
                signOut(auth).then(() => { // Use signOut with auth instance
                    showCustomModal('Logged Out', 'You have been logged out successfully.', false);
                }).catch((error) => {
                    showCustomModal('Error', error.message, false);
                }).finally(() => {
                    hideLoading();
                });
            });
        }

        // Mobile menu toggle
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Dashboard Navigation
        let currentSection = 'dashboardSection';
        function showAdminSection(sectionId) {
            showLoading('Loading section...'); // Added loading indicator for section changes
            document.getElementById(currentSection).classList.add('hidden');
            const newSection = document.getElementById(sectionId + 'Section');
            if (newSection) {
                newSection.classList.remove('hidden');
                currentSection = sectionId + 'Section';
                // Close sidebar on mobile
                sidebar.classList.remove('active');
                
                // Call specific data fetching functions for each section
                switch(sectionId) {
                    case 'dashboard':
                        fetchDashboardCounts();
                        break;
                    case 'students':
                        fetchStudents();
                        break;
                    case 'courses':
                        fetchCourses();
                        break;
                    case 'fees':
                        // Search functionality handled separately
                        document.getElementById('feesContent').classList.add('hidden');
                        document.getElementById('feesSearch').value = '';
                        hideLoading(); // Hide loading if no immediate fetch
                        break;
                    case 'grades':
                        // Search functionality handled separately
                        document.getElementById('gradesContent').classList.add('hidden');
                        document.getElementById('gradesSearch').value = '';
                        hideLoading(); // Hide loading if no immediate fetch
                        break;
                    case 'hostels':
                        fetchHostels();
                        break;
                    case 'announcements':
                        fetchAnnouncements();
                        break;
                    case 'graduation':
                        fetchGraduationRequests();
                        break;
                    case 'clearance':
                        fetchClearanceRequests();
                        break;
                    case 'admins':
                        fetchAdmins();
                        break;
                    default:
                        hideLoading(); // Default hide for undefined sections
                        break;
                }
            } else {
                hideLoading(); // Hide loading if section not found
            }
        }

        // Data Management Functions (CRUD & Fetching)
        async function fetchDashboardCounts() {
            showLoading('Loading dashboard data...');
            try {
                const studentsRef = collection(db, 'students');
                const coursesRef = collection(db, 'courses');
                const gradRequestsRef = collection(db, 'graduationRequests');
                const clearanceRequestsRef = collection(db, 'clearanceRequests');
                const feesRef = collection(db, 'fees');

                const [
                    studentsSnapshot, 
                    coursesSnapshot, 
                    gradPendingSnapshot, 
                    clearancePendingSnapshot,
                    feesSnapshot
                ] = await Promise.all([
                    getDocs(studentsRef),
                    getDocs(coursesRef),
                    getDocs(query(gradRequestsRef, where('status', '==', 'Pending'))), // Use query and where
                    getDocs(query(clearanceRequestsRef, where('status', '==', 'Pending'))), // Use query and where
                    getDocs(feesRef)
                ]);

                document.getElementById('student-count').innerText = studentsSnapshot.size;
                document.getElementById('course-count').innerText = coursesSnapshot.size;
                document.getElementById('graduation-pending-count').innerText = gradPendingSnapshot.size;
                document.getElementById('clearance-pending-count').innerText = clearancePendingSnapshot.size;
                
                let totalOutstandingFees = 0;
                feesSnapshot.docs.forEach(d => {
                    const balance = d.data().balance || 0;
                    if (balance > 0) {
                        totalOutstandingFees += balance;
                    }
                });
                document.getElementById('outstanding-fees-count').innerText = `GHS ${totalOutstandingFees.toFixed(2)}`;
            } catch (error) {
                showCustomModal('Error', 'Failed to load dashboard data: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        // Generic table render function
        function renderTable(tableId, data, columns, actions) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = ''; // Clear existing data
            if (data.length === 0) {
                const colCount = document.querySelectorAll(`#${tableId} thead th`).length;
                tableBody.innerHTML = `<tr><td colspan="${colCount}" class="text-center py-4 text-gray-500">No data available.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                columns.forEach(col => {
                    const cell = document.createElement('td');
                    if (col === 'balance') {
                        cell.innerText = `GHS ${item[col].toFixed(2)}`;
                        cell.classList.add(item[col] > 0 ? 'text-red-600' : 'text-green-600');
                    } else if (col.includes('Date') && item[col]) { // Assuming date fields
                        cell.innerText = new Date(item[col]).toLocaleDateString();
                    }
                    else if (col === 'isAdmin') {
                        cell.innerText = item[col] ? 'Yes' : 'No';
                    }
                    else {
                        cell.innerText = item[col] || 'N/A';
                    }
                    row.appendChild(cell);
                });

                if (actions) {
                    const actionsCell = document.createElement('td');
                    actionsCell.className = "flex space-x-2";
                    actions.forEach(action => {
                        // Only render action buttons if the item meets specific conditions (e.g., not current admin for remove)
                        if (!action.condition || action.condition(item)) {
                            const button = document.createElement('button');
                            button.innerText = action.text;
                            button.className = action.class;
                            button.onclick = () => action.handler(item);
                            actionsCell.appendChild(button);
                        }
                    });
                    row.appendChild(actionsCell);
                }
                tableBody.appendChild(row);
            });
        }
        
        // --- Manage Students ---
        async function fetchStudents() {
            showLoading('Fetching student records...');
            try {
                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(studentsRef);
                const students = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));

                const columns = ['name', 'email', 'programme', 'year', 'contact']; // Updated column names
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (student) => editStudentModal(student) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (student) => deleteStudent(student.uid) }
                ];

                renderTable('studentsTable', students, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch student records: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function addStudentModal() {
            showCustomModal('Add New Student', `
                <input type="text" id="addStudentName" placeholder="Full Name" class="w-full p-2 mb-2 border rounded-md" />
                <input type="email" id="addStudentEmail" placeholder="Email" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addStudentProgram" placeholder="Program" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addStudentYear" placeholder="Year" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addStudentContact" placeholder="Contact" class="w-full p-2 mb-2 border rounded-md" />
            `, true, async () => {
                const name = document.getElementById('addStudentName').value;
                const email = document.getElementById('addStudentEmail').value;
                const program = document.getElementById('addStudentProgram').value;
                const year = document.getElementById('addStudentYear').value;
                const contact = document.getElementById('addStudentContact').value;

                if (!name || !email || !program || !year || !contact) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                await addStudent({ name, email, programme: program, year: parseInt(year), contact, createdAt: new Date().toISOString() });
            });
        }
        
        async function addStudent(studentData) {
            showLoading('Adding student...');
            try {
                await setDoc(doc(db, 'students', studentData.email), studentData);
                showCustomModal('Success', 'Student added successfully.', false);
                fetchStudents();
            } catch (error) {
                showCustomModal('Error', 'Failed to add student: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function editStudentModal(student) {
            showCustomModal('Edit Student', `
                <input type="text" id="editStudentName" placeholder="Full Name" class="w-full p-2 mb-2 border rounded-md" value="${student.name}" />
                <input type="email" id="editStudentEmail" placeholder="Email" class="w-full p-2 mb-2 border rounded-md" value="${student.email}" disabled />
                <input type="text" id="editStudentProgram" placeholder="Program" class="w-full p-2 mb-2 border rounded-md" value="${student.programme}" />
                <input type="number" id="editStudentYear" placeholder="Year" class="w-full p-2 mb-2 border rounded-md" value="${student.year}" />
                <input type="text" id="editStudentContact" placeholder="Contact" class="w-full p-2 mb-2 border rounded-md" value="${student.contact}" />
            `, true, async () => {
                const name = document.getElementById('editStudentName').value;
                const program = document.getElementById('editStudentProgram').value;
                const year = document.getElementById('editStudentYear').value;
                const contact = document.getElementById('editStudentContact').value;

                if (!name || !program || !year || !contact) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                await updateStudent(student.uid, { name, programme: program, year: parseInt(year), contact });
            });
        }
        
        async function updateStudent(uid, studentData) {
            showLoading('Updating student...');
            try {
                await updateDoc(doc(db, 'students', uid), studentData);
                showCustomModal('Success', 'Student updated successfully.', false);
                fetchStudents();
            } catch (error) {
                showCustomModal('Error', 'Failed to update student: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }
        
        async function deleteStudent(uid) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this student record? This action cannot be undone.', true, async () => {
                showLoading('Deleting student...');
                try {
                    await deleteDoc(doc(db, 'students', uid));
                    showCustomModal('Success', 'Student deleted successfully.', false);
                    fetchStudents();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete student: ' + error.message, false);
                } finally {
                    hideLoading();
                }
            });
        }

        document.getElementById('studentSearch').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            showLoading('Searching students...');
            try {
                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(studentsRef);
                const allStudents = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
                const filteredStudents = allStudents.filter(student => 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm) ||
                    (student.programme && student.programme.toLowerCase().includes(searchTerm)) || // Added null check
                    (student.contact && student.contact.toLowerCase().includes(searchTerm))
                );
                const columns = ['name', 'email', 'programme', 'year', 'contact'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (student) => editStudentModal(student) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (student) => deleteStudent(student.uid) }
                ];
                renderTable('studentsTable', filteredStudents, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Error during student search: ' + error.message, false);
            } finally {
                hideLoading();
            }
        });


        // --- Manage Courses ---
        async function fetchCourses() {
            showLoading('Fetching course records...');
            try {
                const coursesRef = collection(db, 'courses');
                const snapshot = await getDocs(coursesRef);
                const courses = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const columns = ['courseCode', 'courseName', 'credits', 'lecturer', 'schedule'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (course) => editCourseModal(course) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (course) => deleteCourse(course.id) }
                ];

                renderTable('coursesTable', courses, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch course records: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function addCourseModal() {
            showCustomModal('Add New Course', `
                <input type="text" id="addCourseCode" placeholder="Course Code (e.g., CSC101)" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addCourseName" placeholder="Course Name" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addCourseCredits" placeholder="Credits" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addCourseLecturer" placeholder="Lecturer" class="w-full p-2 mb-2 border rounded-md" />
                <input type="text" id="addCourseSchedule" placeholder="Schedule (e.g., Mon 10-12)" class="w-full p-2 mb-2 border rounded-md" />
            `, true, async () => {
                const courseCode = document.getElementById('addCourseCode').value;
                const courseName = document.getElementById('addCourseName').value;
                const credits = document.getElementById('addCourseCredits').value;
                const lecturer = document.getElementById('addCourseLecturer').value;
                const schedule = document.getElementById('addCourseSchedule').value;

                if (!courseCode || !courseName || !credits || !lecturer || !schedule) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                await addCourse({ courseCode, courseName, credits: parseInt(credits), lecturer, schedule });
            });
        }

        async function addCourse(courseData) {
            showLoading('Adding course...');
            try {
                await setDoc(doc(db, 'courses', courseData.courseCode), courseData);
                showCustomModal('Success', 'Course added successfully.', false);
                fetchCourses();
            } catch (error) {
                showCustomModal('Error', 'Failed to add course: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function editCourseModal(course) {
            showCustomModal('Edit Course', `
                <input type="text" id="editCourseCode" placeholder="Course Code" class="w-full p-2 mb-2 border rounded-md" value="${course.courseCode}" disabled />
                <input type="text" id="editCourseName" placeholder="Course Name" class="w-full p-2 mb-2 border rounded-md" value="${course.courseName}" />
                <input type="number" id="editCourseCredits" placeholder="Credits" class="w-full p-2 mb-2 border rounded-md" value="${course.credits}" />
                <input type="text" id="editCourseLecturer" placeholder="Lecturer" class="w-full p-2 mb-2 border rounded-md" value="${course.lecturer}" />
                <input type="text" id="editCourseSchedule" placeholder="Schedule" class="w-full p-2 mb-2 border rounded-md" value="${course.schedule}" />
            `, true, async () => {
                const courseName = document.getElementById('editCourseName').value;
                const credits = document.getElementById('editCourseCredits').value;
                const lecturer = document.getElementById('editCourseLecturer').value;
                const schedule = document.getElementById('editCourseSchedule').value;

                if (!courseName || !credits || !lecturer || !schedule) {
                    showCustomModal('Error', 'All fields are required.', false);
                    return;
                }
                await updateCourse(course.id, { courseName, credits: parseInt(credits), lecturer, schedule });
            });
        }

        async function updateCourse(id, courseData) {
            showLoading('Updating course...');
            try {
                await updateDoc(doc(db, 'courses', id), courseData);
                showCustomModal('Success', 'Course updated successfully.', false);
                fetchCourses();
            } catch (error) {
                showCustomModal('Error', 'Failed to update course: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function deleteCourse(id) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this course record? This action cannot be undone.', true, async () => {
                showLoading('Deleting course...');
                try {
                    await deleteDoc(doc(db, 'courses', id));
                    showCustomModal('Success', 'Course deleted successfully.', false);
                    fetchCourses();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete course: ' + error.message, false);
                } finally {
                    hideLoading();
                }
            });
        }

        document.getElementById('courseSearch').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            showLoading('Searching courses...');
            try {
                const coursesRef = collection(db, 'courses');
                const snapshot = await getDocs(coursesRef);
                const allCourses = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const filteredCourses = allCourses.filter(course => 
                    course.courseCode.toLowerCase().includes(searchTerm) ||
                    course.courseName.toLowerCase().includes(searchTerm) ||
                    (course.lecturer && course.lecturer.toLowerCase().includes(searchTerm))
                );
                const columns = ['courseCode', 'courseName', 'credits', 'lecturer', 'schedule'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (course) => editCourseModal(course) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (course) => deleteCourse(course.id) }
                ];
                renderTable('coursesTable', filteredCourses, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Error during course search: ' + error.message, false);
            } finally {
                hideLoading();
            }
        });

        // --- Manage Fees ---
        let currentFeesStudentUid = null;

        async function searchStudentForFees() {
            const email = document.getElementById('feesSearch').value.toLowerCase();
            if (!email) {
                showCustomModal('Error', 'Please enter a student email to search.', false);
                return;
            }
            showLoading(`Searching for ${email}'s fees...`);
            try {
                const studentsRef = collection(db, 'students');
                const studentQuery = await getDocs(query(studentsRef, where('email', '==', email))); // Use query and where

                if (studentQuery.empty) {
                    showCustomModal('Not Found', `No student found with email: ${email}`, false);
                    document.getElementById('feesContent').classList.add('hidden');
                    return;
                }

                const studentDoc = studentQuery.docs[0];
                const studentData = studentDoc.data();
                currentFeesStudentUid = studentDoc.id; // Store UID for later operations
                document.getElementById('studentNameFees').innerText = studentData.name || email;

                // Fetch fees for this student
                const feesDoc = await getDoc(doc(db, 'fees', currentFeesStudentUid));
                let feesHistory = [];
                let totalFeesCharged = 0; // Track total charges
                let totalPaymentsMade = 0; // Track total payments made

                if (feesDoc.exists()) {
                    const data = feesDoc.data();
                    feesHistory = data.payments || [];
                    totalFeesCharged = data.totalFees || 0;
                } else {
                    // Initialize fee record if not exists
                    await setDoc(doc(db, 'fees', currentFeesStudentUid), {
                        studentId: currentFeesStudentUid,
                        totalFees: 0,
                        balance: 0,
                        payments: []
                    });
                }
                
                // Prepare data for display with running balance
                const displayWithBalance = [];
                // Sort payments by date to calculate running balance correctly
                feesHistory.sort((a,b) => new Date(a.date) - new Date(b.date));

                // Start with the initial total fees charged (if any) as the beginning balance
                let runningBalance = totalFeesCharged;

                // Add an initial entry for total fees if it's not zero and there are no previous transactions representing it
                if (totalFeesCharged > 0 && feesHistory.length === 0) {
                    displayWithBalance.push({ date: new Date().toISOString(), description: "Initial Total Fees Due", amount: totalFeesCharged, balance: totalFeesCharged });
                } else if (totalFeesCharged > 0) { // If there are payments, ensure initial fees are represented
                    // Find the last "charge" type entry or assume totalFeesCharged is part of the initial state
                    // This logic might need refinement based on how you track charges vs. payments in Firestore.
                    // For now, we'll ensure the current balance reflects totalFeesCharged - sum of payments.
                    const sumPayments = feesHistory.reduce((sum, p) => sum + p.amount, 0);
                    runningBalance = totalFeesCharged - sumPayments; // Recalculate based on total fees and all payments

                     // Add a summary of total fees charged if there are payments
                    if (totalFeesCharged > 0 && feesHistory.length > 0 && displayWithBalance.length === 0) {
                        displayWithBalance.push({ date: 'Start', description: 'Initial Fees Charged', amount: totalFeesCharged, balance: totalFeesCharged });
                    }
                }
                
                // Add sorted transactions and update running balance
                feesHistory.forEach(payment => {
                    if (payment.description === "Initial Total Fees Due" && displayWithBalance[0] && displayWithBalance[0].description === "Initial Total Fees Due") {
                        // Skip if already added as initial entry
                    } else {
                        runningBalance += (payment.type === 'charge' ? payment.amount : -payment.amount); // Account for charges vs payments
                        displayWithBalance.push({
                            date: payment.date,
                            description: payment.description,
                            amount: payment.amount,
                            balance: runningBalance // This is the balance *after* this transaction
                        });
                    }
                });

                const columns = ['date', 'description', 'amount', 'balance'];
                renderTable('feesTable', displayWithBalance, columns);
                document.getElementById('feesContent').classList.remove('hidden');

            } catch (error) {
                showCustomModal('Error', 'Failed to search fees: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function addFeeTransactionModal() {
            if (!currentFeesStudentUid) {
                showCustomModal('Error', 'Please search for a student first.', false);
                return;
            }
            showCustomModal('Add Fee Transaction', `
                <input type="number" id="transactionAmount" placeholder="Amount (GHS)" class="w-full p-2 mb-2 border rounded-md" step="0.01" />
                <input type="text" id="transactionDescription" placeholder="Description (e.g., Tuition Payment)" class="w-full p-2 mb-2 border rounded-md" />
                <select id="transactionType" class="w-full p-2 mb-2 border rounded-md">
                    <option value="payment">Payment</option>
                    <option value="charge">Charge</option>
                </select>
            `, true, async () => {
                const amount = parseFloat(document.getElementById('transactionAmount').value);
                const description = document.getElementById('transactionDescription').value;
                const type = document.getElementById('transactionType').value;

                if (isNaN(amount) || amount <= 0 || !description) {
                    showCustomModal('Error', 'Please enter a valid amount and description.', false);
                    return;
                }
                await addFeeTransaction(currentFeesStudentUid, amount, description, type);
            });
        }

        async function addFeeTransaction(uid, amount, description, type) {
            showLoading('Updating fee record...');
            try {
                const feesDocRef = doc(db, 'fees', uid);
                const feesSnap = await getDoc(feesDocRef);
                let currentFees = feesSnap.exists() ? feesSnap.data() : { totalFees: 0, balance: 0, payments: [] };

                const newTransaction = {
                    date: new Date().toISOString(),
                    description: description,
                    amount: amount,
                    type: type // Added type to transaction
                };

                currentFees.payments.push(newTransaction);
                
                // Recalculate balance and totalFees based on all payments and charges
                let calculatedTotalFees = 0;
                let calculatedBalance = 0;
                currentFees.payments.forEach(p => {
                    if (p.type === 'charge') {
                        calculatedTotalFees += p.amount;
                        calculatedBalance += p.amount;
                    } else if (p.type === 'payment') {
                        calculatedBalance -= p.amount;
                    }
                });
                currentFees.totalFees = calculatedTotalFees;
                currentFees.balance = calculatedBalance;
                
                await setDoc(feesDocRef, currentFees, { merge: true });
                showCustomModal('Success', 'Fee record updated successfully.', false);
                searchStudentForFees(); // Reload data for the current student
            } catch (error) {
                showCustomModal('Error', 'Failed to update fee record: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        // --- Manage Grades ---
        let currentGradesStudentUid = null;

        async function searchStudentForGrades() {
            const email = document.getElementById('gradesSearch').value.toLowerCase();
            if (!email) {
                showCustomModal('Error', 'Please enter a student email to search.', false);
                return;
            }
            showLoading(`Searching for ${email}'s grades...`);
            try {
                const studentsRef = collection(db, 'students');
                const studentQuery = await getDocs(query(studentsRef, where('email', '==', email))); // Use query and where

                if (studentQuery.empty) {
                    showCustomModal('Not Found', `No student found with email: ${email}`, false);
                    document.getElementById('gradesContent').classList.add('hidden');
                    return;
                }

                const studentDoc = studentQuery.docs[0];
                const studentData = studentDoc.data();
                currentGradesStudentUid = studentDoc.id;
                document.getElementById('studentNameGrades').innerText = studentData.name || email;

                const gradesQuery = await getDocs(query(collection(db, 'grades'), where('studentId', '==', currentGradesStudentUid))); // Use query and where
                const grades = gradesQuery.docs.map(d => ({ id: d.id, ...d.data() }));

                const columns = ['courseCode', 'courseName', 'grade'];
                renderTable('gradesTable', grades, columns);
                document.getElementById('gradesContent').classList.remove('hidden');

            } catch (error) {
                showCustomModal('Error', 'Failed to search grades: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function editGradesModal() {
            if (!currentGradesStudentUid) {
                showCustomModal('Error', 'Please search for a student first.', false);
                return;
            }
            showLoading('Fetching current grades for editing...');
            try {
                const gradesQuery = await getDocs(query(collection(db, 'grades'), where('studentId', '==', currentGradesStudentUid))); // Use query and where
                const grades = gradesQuery.docs.map(d => ({ id: d.id, ...d.data() }));

                let gradeInputsHtml = grades.map(grade => `
                    <div class="flex items-center mb-2">
                        <label class="w-1/3">${grade.courseCode} - ${grade.courseName}:</label>
                        <input type="text" id="grade-${grade.id}" class="w-2/3 p-2 border rounded-md" value="${grade.grade}" placeholder="Enter Grade (A, B, C, D, F)" />
                    </div>
                `).join('');

                if (grades.length === 0) {
                    gradeInputsHtml = '<p class="text-center text-gray-500">No grades to edit for this student.</p>';
                }

                showCustomModal('Edit Grades', `
                    <div id="grade-edit-form-content" class="max-h-60 overflow-y-auto p-2">
                        ${gradeInputsHtml}
                    </div>
                `, true, async () => {
                    const updatedGrades = [];
                    grades.forEach(grade => {
                        const inputElement = document.getElementById(`grade-${grade.id}`);
                        if (inputElement) {
                            updatedGrades.push({
                                id: grade.id,
                                grade: inputElement.value.toUpperCase().trim()
                            });
                        }
                    });
                    await updateStudentGrades(updatedGrades);
                });
            } catch (error) {
                showCustomModal('Error', 'Failed to load grades for editing: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function updateStudentGrades(gradesToUpdate) {
            showLoading('Updating grades...');
            try {
                const batch = writeBatch(db); // Use writeBatch
                gradesToUpdate.forEach(grade => {
                    const gradeRef = doc(db, 'grades', grade.id);
                    batch.update(gradeRef, { grade: grade.grade });
                });
                await batch.commit();
                showCustomModal('Success', 'Grades updated successfully.', false);
                searchStudentForGrades(); // Reload for current student
            } catch (error) {
                showCustomModal('Error', 'Failed to update grades: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        // --- Hostel Management ---
        async function fetchHostels() {
            showLoading('Fetching hostel records...');
            try {
                const hostelsRef = collection(db, 'hostels');
                const snapshot = await getDocs(hostelsRef);
                const hostels = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const columns = ['name', 'capacity', 'availableRooms'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (hostel) => editHostelModal(hostel) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (hostel) => deleteHostel(hostel.id) }
                ];

                renderTable('hostelsTable', hostels, columns, actions);
                updateToggleHostelAppButton();
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch hostel records: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function addHostelModal() {
            showCustomModal('Add New Hostel', `
                <input type="text" id="addHostelName" placeholder="Hostel Name" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addHostelCapacity" placeholder="Total Capacity" class="w-full p-2 mb-2 border rounded-md" />
                <input type="number" id="addHostelAvailable" placeholder="Available Rooms" class="w-full p-2 mb-2 border rounded-md" />
            `, true, async () => {
                const name = document.getElementById('addHostelName').value;
                const capacity = parseInt(document.getElementById('addHostelCapacity').value);
                const available = parseInt(document.getElementById('addHostelAvailable').value);

                if (!name || isNaN(capacity) || isNaN(available) || capacity < 0 || available < 0) {
                    showCustomModal('Error', 'Please enter valid hostel details.', false);
                    return;
                }
                await addHostel({ name, capacity, availableRooms: available });
            });
        }

        async function addHostel(hostelData) {
            showLoading('Adding hostel...');
            try {
                await setDoc(doc(db, 'hostels', hostelData.name), hostelData); // Using name as ID for simplicity
                showCustomModal('Success', 'Hostel added successfully.', false);
                fetchHostels();
            } catch (error) {
                showCustomModal('Error', 'Failed to add hostel: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function editHostelModal(hostel) {
            showCustomModal('Edit Hostel', `
                <input type="text" id="editHostelName" placeholder="Hostel Name" class="w-full p-2 mb-2 border rounded-md" value="${hostel.name}" />
                <input type="number" id="editHostelCapacity" placeholder="Total Capacity" class="w-full p-2 mb-2 border rounded-md" value="${hostel.capacity}" />
                <input type="number" id="editHostelAvailable" placeholder="Available Rooms" class="w-full p-2 mb-2 border rounded-md" value="${hostel.availableRooms}" />
            `, true, async () => {
                const name = document.getElementById('editHostelName').value;
                const capacity = parseInt(document.getElementById('editHostelCapacity').value);
                const available = parseInt(document.getElementById('editHostelAvailable').value);

                if (!name || isNaN(capacity) || isNaN(available) || capacity < 0 || available < 0) {
                    showCustomModal('Error', 'Please enter valid hostel details.', false);
                    return;
                }
                await updateHostel(hostel.id, { name, capacity, availableRooms: available });
            });
        }

        async function updateHostel(id, hostelData) {
            showLoading('Updating hostel...');
            try {
                await updateDoc(doc(db, 'hostels', id), hostelData);
                showCustomModal('Success', 'Hostel updated successfully.', false);
                fetchHostels();
            } catch (error) {
                showCustomModal('Error', 'Failed to update hostel: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function deleteHostel(id) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this hostel record? This action cannot be undone.', true, async () => {
                showLoading('Deleting hostel...');
                try {
                    await deleteDoc(doc(db, 'hostels', id));
                    showCustomModal('Success', 'Hostel deleted successfully.', false);
                    fetchHostels();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete hostel: ' + error.message, false);
                } finally {
                    hideLoading();
                }
            });
        }

        async function toggleHostelApplications() {
            showLoading('Toggling hostel applications...');
            try {
                const settingsDocRef = doc(db, 'settings', 'hostelApplications');
                const settingsSnap = await getDoc(settingsDocRef);
                let currentStatus = true; // Default to open if not set
                if (settingsSnap.exists()) {
                    currentStatus = settingsSnap.data().isOpen;
                }

                const newStatus = !currentStatus;
                await setDoc(settingsDocRef, { isOpen: newStatus }, { merge: true });
                showCustomModal('Success', `Hostel applications are now ${newStatus ? 'OPEN' : 'CLOSED'}.`, false);
                updateToggleHostelAppButton();
            } catch (error) {
                showCustomModal('Error', 'Failed to toggle hostel applications: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function updateToggleHostelAppButton() {
            const btn = document.getElementById('toggleHostelAppBtn');
            if (btn) {
                const settingsDocRef = doc(db, 'settings', 'hostelApplications');
                const settingsSnap = await getDoc(settingsDocRef);
                let isOpen = false;
                if (settingsSnap.exists()) {
                    isOpen = settingsSnap.data().isOpen;
                }
                btn.innerText = `Toggle Applications (${isOpen ? 'OPEN' : 'CLOSED'})`;
                btn.classList.remove('bg-yellow-600', 'bg-green-600', 'bg-red-600');
                btn.classList.add(isOpen ? 'bg-green-600' : 'bg-red-600');
            }
        }


        // --- Announcements ---
        async function fetchAnnouncements() {
            showLoading('Fetching announcements...');
            try {
                const announcementsRef = collection(db, 'announcements');
                const snapshot = await getDocs(query(announcementsRef, orderBy('date', 'desc'))); // Use query and orderBy
                const announcements = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const columns = ['date', 'title', 'message'];
                const actions = [
                    { text: 'Edit', class: 'bg-yellow-500 text-white px-2 py-1 rounded-lg mr-1', handler: (ann) => editAnnouncementModal(ann) },
                    { text: 'Delete', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (ann) => deleteAnnouncement(ann.id) }
                ];

                renderTable('announcementsTable', announcements, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch announcements: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function addAnnouncementModal() {
            showCustomModal('Add New Announcement', `
                <input type="text" id="addAnnounceTitle" placeholder="Title" class="w-full p-2 mb-2 border rounded-md" />
                <textarea id="addAnnounceMessage" placeholder="Announcement Content" class="w-full p-2 mb-2 border rounded-md h-24"></textarea>
            `, true, async () => {
                const title = document.getElementById('addAnnounceTitle').value;
                const message = document.getElementById('addAnnounceMessage').value;

                if (!title || !message) {
                    showCustomModal('Error', 'Title and message are required.', false);
                    return;
                }
                await addAnnouncement({ title, message, date: new Date().toISOString() });
            });
        }

        async function addAnnouncement(announcementData) {
            showLoading('Adding announcement...');
            try {
                await setDoc(doc(db, 'announcements', new Date().getTime().toString()), announcementData); // Use timestamp as ID
                showCustomModal('Success', 'Announcement added successfully.', false);
                fetchAnnouncements();
            } catch (error) {
                showCustomModal('Error', 'Failed to add announcement: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function editAnnouncementModal(announcement) {
            showCustomModal('Edit Announcement', `
                <input type="text" id="editAnnounceTitle" placeholder="Title" class="w-full p-2 mb-2 border rounded-md" value="${announcement.title}" />
                <textarea id="editAnnounceMessage" placeholder="Announcement Content" class="w-full p-2 mb-2 border rounded-md h-24">${announcement.message}</textarea>
            `, true, async () => {
                const title = document.getElementById('editAnnounceTitle').value;
                const message = document.getElementById('editAnnounceMessage').value;

                if (!title || !message) {
                    showCustomModal('Error', 'Title and message are required.', false);
                    return;
                }
                await updateAnnouncement(announcement.id, { title, message });
            });
        }

        async function updateAnnouncement(id, announcementData) {
            showLoading('Updating announcement...');
            try {
                await updateDoc(doc(db, 'announcements', id), announcementData);
                showCustomModal('Success', 'Announcement updated successfully.', false);
                fetchAnnouncements();
            } catch (error) {
                showCustomModal('Error', 'Failed to update announcement: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function deleteAnnouncement(id) {
            showCustomModal('Confirm Deletion', 'Are you sure you want to delete this announcement? This action cannot be undone.', true, async () => {
                showLoading('Deleting announcement...');
                try {
                    await deleteDoc(doc(db, 'announcements', id));
                    showCustomModal('Success', 'Announcement deleted successfully.', false);
                    fetchAnnouncements();
                } catch (error) {
                    showCustomModal('Error', 'Failed to delete announcement: ' + error.message, false);
                } finally {
                    hideLoading();
                }
            });
        }


        // --- Graduation Requests ---
        async function fetchGraduationRequests() {
            showLoading('Fetching graduation requests...');
            try {
                const requestsRef = collection(db, 'graduationRequests');
                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(requestsRef);
                const requests = [];

                for (const d of snapshot.docs) {
                    const data = d.data();
                    // Ensure studentId exists before fetching student details
                    if (data.studentId) {
                        const studentDoc = await getDoc(doc(db, 'students', data.studentId));
                        const studentName = studentDoc.exists() ? studentDoc.data().name : 'Unknown Student';
                        const studentEmail = studentDoc.exists() ? studentDoc.data().email : 'N/A';
                        requests.push({ id: d.id, studentName, studentEmail, ...data });
                    } else {
                        // Handle cases where studentId might be missing or malformed
                        requests.push({ id: d.id, studentName: 'Missing Student ID', studentEmail: 'N/A', ...data });
                    }
                }

                const columns = ['studentName', 'studentEmail', 'date', 'status'];
                const actions = [
                    { text: 'Approve', class: 'bg-green-500 text-white px-2 py-1 rounded-lg mr-1', handler: (req) => updateGraduationRequestStatus(req.id, 'Approved'), condition: (req) => req.status !== 'Approved' }, // Only show if not already approved
                    { text: 'Reject', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (req) => updateGraduationRequestStatus(req.id, 'Denied'), condition: (req) => req.status !== 'Denied' } // Only show if not already denied
                ];

                renderTable('graduationRequestsTable', requests, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch graduation requests: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function updateGraduationRequestStatus(id, status) {
            showLoading(`Updating request to ${status}...`);
            try {
                await updateDoc(doc(db, 'graduationRequests', id), { status: status });
                showCustomModal('Success', `Graduation request ${status} successfully.`, false);
                fetchGraduationRequests();
            } catch (error) {
                showCustomModal('Error', 'Failed to update request: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        // --- Clearance Requests ---
        async function fetchClearanceRequests() {
            showLoading('Fetching clearance requests...');
            try {
                const requestsRef = collection(db, 'clearanceRequests');
                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(requestsRef);
                const requests = [];

                for (const d of snapshot.docs) {
                    const data = d.data();
                     // Ensure studentId exists before fetching student details
                    if (data.studentId) {
                        const studentDoc = await getDoc(doc(db, 'students', data.studentId));
                        const studentName = studentDoc.exists() ? studentDoc.data().name : 'Unknown Student';
                        const studentEmail = studentDoc.exists() ? studentDoc.data().email : 'N/A';
                        requests.push({ id: d.id, studentName, studentEmail, ...data });
                    } else {
                        // Handle cases where studentId might be missing or malformed
                        requests.push({ id: d.id, studentName: 'Missing Student ID', studentEmail: 'N/A', ...data });
                    }
                }

                const columns = ['studentName', 'studentEmail', 'date', 'status'];
                const actions = [
                    { text: 'Approve', class: 'bg-green-500 text-white px-2 py-1 rounded-lg mr-1', handler: (req) => updateClearanceRequestStatus(req.id, 'Approved'), condition: (req) => req.status !== 'Approved' },
                    { text: 'Reject', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (req) => updateClearanceRequestStatus(req.id, 'Denied'), condition: (req) => req.status !== 'Denied' }
                ];

                renderTable('clearanceRequestsTable', requests, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch clearance requests: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function updateClearanceRequestStatus(id, status) {
            showLoading(`Updating request to ${status}...`);
            try {
                await updateDoc(doc(db, 'clearanceRequests', id), { status: status });
                showCustomModal('Success', `Clearance request ${status} successfully.`, false);
                fetchClearanceRequests();
            } catch (error) {
                showCustomModal('Error', 'Failed to update request: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        // --- Admin Management ---
        async function fetchAdmins() {
            showLoading('Fetching admin users...');
            try {
                const adminsRef = collection(db, 'admins');
                const snapshot = await getDocs(adminsRef);
                const admins = snapshot.docs.map(d => ({ id: d.id, email: d.id, isAdmin: d.data().isAdmin }));

                // Filter out the current logged-in admin from the list to prevent self-deletion
                const filteredAdmins = admins.filter(admin => auth.currentUser && admin.email !== auth.currentUser.email);

                const columns = ['email', 'isAdmin'];
                const actions = [
                    { text: 'Remove', class: 'bg-red-500 text-white px-2 py-1 rounded-lg', handler: (admin) => removeAdmin(admin.id), condition: (admin) => admin.email !== auth.currentUser.email } // Condition to prevent removing self
                ];

                renderTable('adminsTable', filteredAdmins, columns, actions);
            } catch (error) {
                showCustomModal('Error', 'Failed to fetch admin users: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        function addAdminModal() {
            showCustomModal('Add New Admin', `
                <input type="email" id="newAdminEmail" placeholder="Admin Email" class="w-full p-2 mb-2 border rounded-md" />
            `, true, async () => {
                const email = document.getElementById('newAdminEmail').value;
                if (!email) {
                    showCustomModal('Error', 'Please enter an email address.', false);
                    return;
                }
                await addNewAdmin(email);
            });
        }

        async function addNewAdmin(email) {
            showLoading('Adding new admin...');
            try {
                await setDoc(doc(db, 'admins', email), { isAdmin: true });
                showCustomModal('Success', `${email} added as admin successfully.`, false);
                fetchAdmins();
            } catch (error) {
                showCustomModal('Error', 'Failed to add admin: ' + error.message, false);
            } finally {
                hideLoading();
            }
        }

        async function removeAdmin(email) {
            showCustomModal('Confirm Removal', `Are you sure you want to remove ${email} as an admin?`, true, async () => {
                if (auth.currentUser && email === auth.currentUser.email) {
                    showCustomModal('Error', 'You cannot remove yourself as an admin.', false);
                    return;
                }
                showLoading('Removing admin...');
                try {
                    await deleteDoc(doc(db, 'admins', email));
                    showCustomModal('Success', `${email} removed as admin successfully.`, false);
                    fetchAdmins();
                } catch (error) {
                    showCustomModal('Error', 'Failed to remove admin: ' + error.message, false);
                } finally {
                    hideLoading();
                }
            });
        }

        // Export and Print Functions
        function exportTable(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                showCustomModal('Error', 'Table not found for export.', false);
                return;
            }

            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
            // Get all rows, including 'No data available' row if present
            const allRows = Array.from(table.querySelectorAll('tbody tr'));
            
            // Check if the table contains actual data or just the "No data available" message
            const hasData = allRows.length > 0 && allRows[0].cells.length > 1;

            let data = [];
            // Only add headers if there's actual data to export, or if we want headers even for empty tables
            if (hasData || headers.length > 0) {
                data.push(headers.filter(header => header !== 'Actions')); // Exclude "Actions" header
            }
            
            if (hasData) {
                allRows.forEach(tr => {
                    const rowData = Array.from(tr.querySelectorAll('td'))
                                     .map(td => td.innerText)
                                     .filter((_, index, arr) => index !== arr.length - 1); // Exclude last column (Actions)
                    data.push(rowData);
                });
            }

            if (data.length <= 1 && hasData === false) { // No data and only headers or empty array
                showCustomModal('Info', 'No data to export.', false);
                return;
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, filename);

            XLSX.writeFile(wb, `${filename}.xlsx`);
        }
        
        function printTable(tableId, title) {
            const table = document.getElementById(tableId);
            if (!table) {
                showCustomModal('Error', 'Table not found for printing.', false);
                return;
            }
            
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
            const allRows = Array.from(table.querySelectorAll('tbody tr'));
            const hasData = allRows.length > 0 && allRows[0].cells.length > 1; // Check if it's not the "No data" row

            if (!hasData) {
                showCustomModal('Info', 'No data to print.', false);
                return;
            }

            const rows = allRows.map(tr => 
                Array.from(tr.querySelectorAll('td'))
                     .map(td => td.innerText)
                     .filter((_, index, arr) => index !== arr.length - 1) // Exclude last column (Actions)
            );
            
            const doc = new jspdf.jsPDF();
            doc.text(title, 14, 20);
            doc.autoTable({
                startY: 25,
                head: [headers.filter(header => header !== 'Actions')], // Exclude "Actions"
                body: rows, 
                theme: 'striped',
                headStyles: { fillColor: [26, 79, 50] }
            });
            doc.save(`${title}.pdf`);
        }
    </script>
</body>
</html>
