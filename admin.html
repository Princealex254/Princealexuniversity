<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>University Admin Portal</title>

<!-- Fonts: Montserrat (headings) & Lato (body) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
<!-- Tailwind + Font Awesome -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
  body { font-family: 'Lato', sans-serif; background:#f7f9fc; }
  h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
  .card { background:white; border-radius:12px; box-shadow:0 8px 28px rgba(2,6,23,0.06); }
  .small { font-size:.85rem; }
  .msg { padding:.75rem 1.5rem; border-radius:8px; margin-bottom: 1rem; }
  .msg.error { background:#fbe8e8; color:#c0392b; }
  .msg.success { background:#e8f8f2; color:#27ae60; }
  .msg.info { background:#e8f4fb; color:#3498db; }
  .navBtn.active { background:#e8f4fb; color:#0A6EBD; font-weight: 700; }
  input:focus, textarea:focus, select:focus { outline: none; border-color: #0A6EBD; box-shadow: 0 0 0 2px rgba(10, 110, 189, 0.2); }
</style>
</head>
<body class="min-h-screen">

<!-- Login / Global messages -->
<div id="loginView" class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold mb-3 text-center text-gray-800">Admin Sign In</h1>
    <p class="text-sm text-slate-500 mb-6 text-center">You must have a Firestore doc at <code>admins/{uid}</code> with <code>isAdmin: true</code>.</p>

    <div id="loginMsg" class="msg hidden text-center"></div>

    <label class="block mb-4"><span class="text-sm font-semibold text-gray-600">Email</span>
      <input id="loginEmail" type="email" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="admin@example.com" />
    </label>
    <label class="block mb-6"><span class="text-sm font-semibold text-gray-600">Password</span>
      <input id="loginPassword" type="password" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="password" />
    </label>

    <div class="flex flex-col gap-3">
      <button id="btnSignIn" class="bg-[#0A6EBD] text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-300">Sign in</button>
      <button id="btnSeed" class="bg-slate-200 text-gray-700 py-3 rounded-lg font-bold hover:bg-slate-300 transition duration-300">Seed demo</button>
    </div>

    <p class="text-xs text-slate-400 mt-6 text-center">Note: creating auth users from the browser will sign you in as that user—you'll be signed out and must sign back in as admin. For production, use server-side Admin SDK.</p>
  </div>
</div>

<!-- App -->
<div id="appView" class="hidden">
  <!-- Header -->
  <header class="bg-white border-b-2 border-gray-200 sticky top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-4">
      <div class="flex items-center gap-3">
        <button id="hamburger" class="md:hidden p-2 rounded hover:bg-gray-100 transition duration-200"><i class="fa-solid fa-bars text-gray-600"></i></button>
        <div class="font-bold text-xl text-[#0A6EBD]">University Admin Portal</div>
      </div>
      <div class="flex items-center gap-4">
        <div id="adminEmail" class="text-sm font-semibold text-slate-700 hidden sm:block"></div>
        <button id="btnSignOut" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition duration-300">Sign out</button>
      </div>
    </div>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-white border-r border-gray-200 p-4 hidden md:block shadow-sm">
      <nav class="space-y-2 text-sm">
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-overview"><i class="fa-solid fa-tachometer-alt mr-3 w-4"></i>Overview</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-students"><i class="fa-solid fa-user-graduate mr-3 w-4"></i>Students</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-courses"><i class="fa-solid fa-book mr-3 w-4"></i>Courses</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-timetable"><i class="fa-solid fa-calendar-alt mr-3 w-4"></i>Timetable</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-grades"><i class="fa-solid fa-award mr-3 w-4"></i>Grades</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-finance"><i class="fa-solid fa-wallet mr-3 w-4"></i>Finance</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-hostels"><i class="fa-solid fa-bed mr-3 w-4"></i>Hostels</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-announcements"><i class="fa-solid fa-bullhorn mr-3 w-4"></i>Announcements</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-clearance"><i class="fa-solid fa-clipboard-check mr-3 w-4"></i>Clearance</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-graduation"><i class="fa-solid fa-graduation-cap mr-3 w-4"></i>Graduation</button>
        <button class="navBtn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition duration-200" data-panel="panel-admins"><i class="fa-solid fa-shield-alt mr-3 w-4"></i>Admins</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">
      <div id="globalMsg" class="msg hidden"></div>

      <!-- Overview -->
      <section id="panel-overview" class="card p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="p-5 card text-center"><div class="text-md text-slate-500">Students</div><div id="statStudents" class="text-3xl font-bold mt-1 text-[#0A6EBD]">—</div></div>
          <div class="p-5 card text-center"><div class="text-md text-slate-500">Courses</div><div id="statCourses" class="text-3xl font-bold mt-1 text-[#0A6EBD]">—</div></div>
          <div class="p-5 card text-center"><div class="text-md text-slate-500">Hostels</div><div id="statHostels" class="text-3xl font-bold mt-1 text-[#0A6EBD]">—</div></div>
        </div>
      </section>

      <!-- Students -->
      <section id="panel-students" class="card p-6 mb-6 hidden">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
          <h2 class="text-2xl font-bold">Students</h2>
          <div class="flex gap-2 w-full sm:w-auto">
            <input id="studentSearch" class="border p-2 rounded-lg w-full" placeholder="Search name / regNo"/>
            <button id="btnReloadStudents" class="px-3 py-2 bg-slate-200 text-gray-700 rounded-lg hover:bg-slate-300"><i class="fa-solid fa-sync"></i></button>
            <button id="btnAddStudentModal" class="px-3 py-2 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300"><i class="fa-solid fa-plus mr-1"></i> Add</button>
          </div>
        </div>
        <div id="studentsList" class="space-y-3"></div>
      </section>

      <!-- Courses -->
      <section id="panel-courses" class="card p-6 mb-6 hidden">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
          <h2 class="text-2xl font-bold">Courses</h2>
          <div class="flex gap-2 w-full sm:w-auto">
            <input id="courseSearch" placeholder="Search code/title" class="border p-3 rounded-lg w-full" />
            <button id="btnReloadCourses" class="px-3 py-2 bg-slate-200 text-gray-700 rounded-lg hover:bg-slate-300"><i class="fa-solid fa-sync"></i></button>
            <button id="btnAddCourseModal" class="px-3 py-2 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300"><i class="fa-solid fa-plus mr-1"></i> Add</button>
          </div>
        </div>
        <div id="coursesList" class="space-y-3"></div>
      </section>

      <!-- Timetable -->
      <section id="panel-timetable" class="card p-6 mb-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Timetable</h2>
        <div class="flex gap-3 flex-wrap sm:flex-nowrap w-full sm:w-auto">
          <select id="tt_student_select" class="border p-3 rounded-lg flex-1"></select>
          <button id="btnLoadTT" class="px-4 py-3 bg-[#0A6EBD] text-white rounded-lg hover:bg-blue-700 transition duration-300">Load</button>
          <button id="btnSaveTT" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300">Save</button>
        </div>
        <div id="ttMsg" class="msg hidden mt-4"></div>
        <textarea id="tt_editor" class="w-full h-64 border p-4 rounded-lg mt-4" placeholder='JSON array: [{"day":"Monday","time":"09:00","courseCode":"CSC101","venue":"RM1"}]'></textarea>
        <p class="text-xs text-slate-500 mt-3">Timetable stored at <code>timetable/{studentUid}</code> as <code>{ schedule: [...] }</code>.</p>
      </section>

      <!-- Grades -->
      <section id="panel-grades" class="card p-6 mb-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Grades</h2>
        <div class="flex gap-3 flex-wrap sm:flex-nowrap w-full sm:w-auto">
          <select id="grades_student_select" class="border p-3 rounded-lg flex-1"></select>
          <button id="btnAddGradeModal" class="px-3 py-2 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300"><i class="fa-solid fa-plus mr-1"></i> Add Grade</button>
        </div>
        <div id="gradesMsg" class="msg hidden mt-4"></div>
        <div id="gradesList" class="space-y-3 mt-4"></div>
      </section>

      <!-- Finance -->
      <section id="panel-finance" class="card p-6 mb-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Finance</h2>
        <div class="flex gap-3 flex-wrap sm:flex-nowrap w-full sm:w-auto">
          <select id="finance_student_select" class="border p-3 rounded-lg flex-1"></select>
          <button id="btnAddTransactionModal" class="px-3 py-2 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300"><i class="fa-solid fa-plus mr-1"></i> Add Transaction</button>
        </div>
        <div id="financeMsg" class="msg hidden mt-4"></div>
        <div id="financeList" class="space-y-3 mt-4"></div>
      </section>

      <!-- Hostels -->
      <section id="panel-hostels" class="card p-6 mb-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Hostels & Rooms</h2>
        <div class="flex gap-3 w-full sm:w-auto mb-4">
          <button id="btnAddHostelModal" class="px-3 py-2 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300"><i class="fa-solid fa-plus mr-1"></i> Add Hostel</button>
          <button id="btnAddRoomModal" class="px-3 py-2 bg-[#0A6EBD] text-white rounded-lg hover:bg-blue-700 transition duration-300"><i class="fa-solid fa-plus mr-1"></i> Add Room</button>
        </div>
        <div id="hostelsMsg" class="msg hidden"></div>
        <div id="hostelsList" class="space-y-3 mt-4"></div>
      </section>

      <!-- Announcements -->
      <section id="panel-announcements" class="card p-6 mb-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Announcements</h2>
        <button id="btnAddAnnModal" class="px-3 py-2 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300 mb-4"><i class="fa-solid fa-plus mr-1"></i> Post Announcement</button>
        <div id="announcementsList" class="space-y-3"></div>
      </section>

      <!-- Clearance -->
      <section id="panel-clearance" class="card p-6 mb-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Clearance</h2>
        <div class="flex gap-3 w-full sm:w-auto">
          <select id="clearance_student_select" class="border p-3 rounded-lg flex-1"></select>
          <button id="btnLoadClearanceModal" class="px-3 py-2 bg-[#0A6EBD] text-white rounded-lg hover:bg-blue-700 transition duration-300"><i class="fa-solid fa-edit mr-1"></i> Edit Clearance</button>
        </div>
        <div id="clearanceMsg" class="msg hidden mt-4"></div>
      </section>

      <!-- Graduation -->
      <section id="panel-graduation" class="card p-6 mb-6 hidden">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
          <h2 class="text-2xl font-bold">Graduation Requests</h2>
          <button id="btnReloadGrad" class="px-4 py-3 bg-slate-200 text-gray-700 rounded-lg font-bold hover:bg-slate-300 transition duration-300"><i class="fa-solid fa-sync mr-2"></i>Reload</button>
        </div>
        <div id="graduationList" class="space-y-4"></div>
      </section>

      <!-- Admins management -->
      <section id="panel-admins" class="card p-6 mb-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Admins</h2>
        <button id="btnAddAdminModal" class="px-3 py-2 bg-[#2ecc71] text-white rounded-lg hover:bg-green-600 transition duration-300 mb-4"><i class="fa-solid fa-plus mr-1"></i> Add Admin</button>
        <div id="adminsMsg" class="msg hidden mt-4"></div>
        <div id="adminsList" class="space-y-3"></div>
      </section>

    </main>
  </div>

  <footer class="text-center text-sm text-slate-500 p-4 mt-8 border-t border-gray-200">© 2025 University</footer>
</div>

<!-- Modal containers -->
<div id="modalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div id="modalContent" class="bg-white p-8 rounded-xl shadow-lg max-h-[90vh] overflow-y-auto w-full max-w-2xl transform transition-transform duration-300 scale-95">
        <!-- Forms will be dynamically loaded here -->
    </div>
</div>

<!-- Firebase modular SDK and app logic (remains unchanged) -->
<script type="module">
/* All original JavaScript code from the user's file goes here */
/* ... (The entire script block from the original file is placed here) ... */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
  createUserWithEmailAndPassword
} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, collection,
  query, where, orderBy, serverTimestamp, limit, runTransaction
} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';
const firebaseConfig = {
  apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
  authDomain: "universityweb-19e1e.firebaseapp.com",
  projectId: "universityweb-19e1e",
  storageBucket: "universityweb-19e1e.appspot.com",
  messagingSenderId: "401942926589",
  appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
function showMsg(elSelector, text, type='info'){ const el = $(elSelector); if(!el) return; el.className = `msg ${type}`; el.textContent = text; el.classList.remove('hidden'); setTimeout(()=>{ if(el) el.classList.add('hidden'); }, 8000); }
function setGlobalMsg(text,type='info'){ const gm = $('#globalMsg'); gm.className = `msg ${type}`; gm.textContent = text; gm.classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); setTimeout(()=> gm.classList.add('hidden'),8000); }
function clearMsg(elSelector){ const el = $(elSelector); if(el) { el.classList.add('hidden'); el.textContent=''; } }
const loginView = $('#loginView'), appView = $('#appView');
$('#btnSignIn').addEventListener('click', async ()=>{
  clearMsg('#loginMsg');
  const email = $('#loginEmail').value.trim();
  const pw = $('#loginPassword').value;
  if(!email || !pw){ showMsg('#loginMsg','Enter email and password','error'); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pw);
  }catch(err){
    showMsg('#loginMsg', err.message || err.code, 'error');
  }
});
$('#btnSeed').addEventListener('click', async ()=>{
  if(!confirm('Seed small demo?')) return;
  try{
    await addDoc(collection(db,'courses'), { code:'CSC101', title:'Intro to Computing', credits:3, createdAt: serverTimestamp() });
    await addDoc(collection(db,'announcements'), { title:'Welcome', body:'Demo announcement', createdAt: serverTimestamp() });
    const s = await addDoc(collection(db,'students'), { name:'Demo Student', email:'demo@student.com', regNo:'DEM/001/25', createdAt: new Date().toISOString(), initialized:true });
    setGlobalMsg('Demo seeded (courses, announcement, one student)', 'success');
    await loadAllLists();
  }catch(e){ setGlobalMsg('Demo seed failed: '+e.message,'error'); }
});
onAuthStateChanged(auth, async (user) => {
  if(!user){
    loginView.classList.remove('hidden'); appView.classList.add('hidden');
    return;
  }
  try{
    const adminDoc = await getDoc(doc(db,'admins', user.uid));
    if(!adminDoc.exists() || adminDoc.data().isAdmin !== true){
      showMsg('#loginMsg','Access denied — this account is not an admin (check admins collection).','error');
      await signOut(auth);
      return;
    }
  }catch(e){
    showMsg('#loginMsg','Failed admin check: '+(e.message||e.code),'error');
    await signOut(auth);
    return;
  }
  loginView.classList.add('hidden'); appView.classList.remove('hidden');
  $('#adminEmail').textContent = user.email || user.uid;
  setGlobalMsg('Welcome, admin: '+(user.email || user.uid),'success');
  activateNav();
  await loadOverview();
  await loadAllLists();
});
$('#btnSignOut').addEventListener('click', async ()=> {
  try{ await signOut(auth); setGlobalMsg('Signed out','info'); }catch(e){ setGlobalMsg('Sign out failed: '+e.message,'error'); }
});
$('#hamburger').addEventListener('click', ()=> $('#sidebar').classList.toggle('hidden'));
function activateNav(){
  $$('.navBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const panel = btn.dataset.panel;
      $$('main section').forEach(s => s.classList.add('hidden'));
      const target = document.getElementById(panel);
      if(target) target.classList.remove('hidden');
      $$('.navBtn').forEach(navBtn => navBtn.classList.remove('active'));
      btn.classList.add('active');
    });
  });
}
async function loadOverview(){
  try{
    const sSnap = await getDocs(collection(db,'students'));
    const cSnap = await getDocs(collection(db,'courses'));
    const hSnap = await getDocs(collection(db,'hostels'));
    $('#statStudents').textContent = sSnap.size;
    $('#statCourses').textContent = cSnap.size;
    $('#statHostels').textContent = hSnap.size;
  }catch(e){ setGlobalMsg('Overview load failed: '+e.message,'error'); }
}
async function loadAllLists(){
  await loadStudentsList();
  await loadCoursesList();
  await loadAnnouncementsList();
  await loadHostelsList();
  await populateStudentSelects();
  await populateCourseSelects();
  await populateHostelSelects();
  await loadAdminsList();
  await loadGraduationRequests();
}

// Modal handling logic
const modalContainer = $('#modalContainer');
const modalContent = $('#modalContent');

function showModal(html) {
    modalContent.innerHTML = html;
    modalContainer.classList.remove('hidden');
    // Scale up from 95% to 100% for a nice effect
    modalContent.classList.remove('scale-95');
    modalContent.classList.add('scale-100');
}

function hideModal() {
    modalContent.classList.remove('scale-100');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modalContainer.classList.add('hidden');
        modalContent.innerHTML = '';
    }, 300); // Wait for transition to finish
}

modalContainer.addEventListener('click', (e) => {
    if (e.target.id === 'modalContainer') {
        hideModal();
    }
});

// Student Form Modal
$('#btnAddStudentModal').addEventListener('click', () => {
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Create New Student</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formAddStudent" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Full name</span>
            <input id="new_name" placeholder="Full name" class="w-full mt-2 p-3 border rounded-lg" required/>
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Email</span>
            <input id="new_email" placeholder="Email" class="w-full mt-2 p-3 border rounded-lg" required/>
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Registration No.</span>
            <input id="new_regNo" placeholder="Reg No" class="w-full mt-2 p-3 border rounded-lg" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Temporary Password</span>
            <input id="new_tempPassword" placeholder="Temporary password" class="w-full mt-2 p-3 border rounded-lg" value="changeme123" />
        </label>
        <div class="md:col-span-2 flex flex-col sm:flex-row gap-3 mt-4">
          <button type="submit" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg font-bold hover:bg-green-600 transition duration-300"><i class="fa-solid fa-plus mr-2"></i>Create student account</button>
          <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
      </form>
      <p class="text-xs text-slate-500 mt-4">Client-side account creation will sign you out — you must sign back in.</p>
    `;
    showModal(formHtml);

    $('#formAddStudent').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const name = $('#new_name').value.trim();
        const email = $('#new_email').value.trim();
        const regNo = $('#new_regNo').value.trim();
        const pw = $('#new_tempPassword').value || 'changeme123';
        if (!name || !email) { showMsg('#modalMsg', 'Name & email required', 'error'); return; }
        try {
            const cred = await createUserWithEmailAndPassword(auth, email, pw);
            const uid = cred.user.uid;
            await setDoc(doc(db, 'students', uid), { name, email, regNo, createdAt: new Date().toISOString(), initialized: true });
            setGlobalMsg('Student account created: ' + email + '. You will be signed out. Sign back in as admin.', 'success');
            hideModal();
            await signOut(auth);
        } catch (err) {
            showMsg('#modalMsg', 'Failed to create student: ' + (err.message || err.code), 'error');
        }
    });
});

let editingStudentUid = null;
async function openEditStudent(uid) {
    const snap = await getDoc(doc(db, 'students', uid));
    if (!snap.exists()) { setGlobalMsg('Student not found', 'error'); return; }
    const d = snap.data();
    editingStudentUid = uid;

    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Edit Student Details</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <div id="studentEditor" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Name</span>
            <input id="edit_name" class="w-full mt-2 p-3 border rounded-lg" placeholder="Name" value="${d.name || ''}" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Email</span>
            <input id="edit_email" class="w-full mt-2 p-3 border rounded-lg bg-gray-100" placeholder="Email" value="${d.email || ''}" readonly />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Registration No.</span>
            <input id="edit_regNo" class="w-full mt-2 p-3 border rounded-lg" placeholder="Registration No." value="${d.regNo || ''}" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Programme</span>
            <input id="edit_programme" class="w-full mt-2 p-3 border rounded-lg" placeholder="Programme" value="${d.programme || ''}" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Campus</span>
            <input id="edit_campus" class="w-full mt-2 p-3 border rounded-lg" placeholder="Campus" value="${d.campus || ''}" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Year of Study</span>
            <input id="edit_year" type="number" class="w-full mt-2 p-3 border rounded-lg" placeholder="Year" value="${d.yearOfStudy || ''}" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Address</span>
            <textarea id="edit_address" class="w-full h-24 mt-2 p-3 border rounded-lg" placeholder="Address">${d.address || ''}</textarea>
        </label>
        <div class="flex flex-col sm:flex-row gap-3 mt-4">
          <button id="btnSaveStudent" class="px-4 py-3 bg-[#0A6EBD] text-white rounded-lg font-bold hover:bg-blue-700 transition duration-300">Save changes</button>
          <button id="btnCancelEditStudent" class="px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-300">Cancel</button>
          <button id="btnDeleteStudent" class="px-4 py-3 bg-red-600 text-white rounded-lg font-bold ml-auto hover:bg-red-700 transition duration-300">Delete student doc</button>
        </div>
      </div>
    `;
    showModal(formHtml);

    $('#btnSaveStudent').addEventListener('click', async () => {
        try {
            const upd = {
                name: $('#edit_name').value.trim(),
                regNo: $('#edit_regNo').value.trim(),
                programme: $('#edit_programme').value.trim(),
                campus: $('#edit_campus').value.trim(),
                yearOfStudy: Number($('#edit_year').value || 0),
                address: $('#edit_address').value.trim()
            };
            await updateDoc(doc(db, 'students', editingStudentUid), upd);
            showMsg('#modalMsg', 'Saved', 'success');
            await loadStudentsList();
            await populateStudentSelects();
            setTimeout(hideModal, 1000);
        } catch (e) {
            showMsg('#modalMsg', 'Save failed: ' + e.message, 'error');
        }
    });

    $('#btnCancelEditStudent').addEventListener('click', () => { hideModal(); editingStudentUid = null; });
    $('#btnDeleteStudent').addEventListener('click', async () => {
        if (!confirm('Delete student doc?')) return;
        await deleteDoc(doc(db, 'students', editingStudentUid));
        setGlobalMsg('Student doc deleted', 'success');
        hideModal();
        editingStudentUid = null;
        await loadStudentsList();
        await populateStudentSelects();
    });
}

async function loadStudentsList() {
    const container = $('#studentsList');
    container.innerHTML = '<div class="text-slate-500 p-2 text-center">Loading students...</div>';
    try {
        const snaps = await getDocs(collection(db, 'students'));
        container.innerHTML = '';
        if (snaps.empty) { container.innerHTML = '<div class="text-slate-500 p-2 text-center">No students found.</div>'; return; }
        snaps.forEach(docSnap => {
            const d = docSnap.data();
            const el = document.createElement('div');
            el.className = 'p-3 border rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white shadow-sm hover:shadow-md transition duration-200';
            el.innerHTML = `<div><div class="font-bold text-gray-800">${d.name || '—'}</div><div class="text-xs text-slate-600">${d.regNo || ''} • ${d.email || ''}</div></div>
        <div class="flex gap-2 mt-2 sm:mt-0">
          <button data-uid="${docSnap.id}" class="btnEditStudent px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm font-semibold hover:bg-blue-200"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
          <button data-uid="${docSnap.id}" class="btnDeleteStudent px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200"><i class="fa-solid fa-trash-can"></i> Delete</button>
        </div>`;
            container.appendChild(el);
        });
        $$('.btnEditStudent').forEach(b => b.addEventListener('click', async (e) => {
            const uid = e.currentTarget.dataset.uid;
            openEditStudent(uid);
        }));
        $$('.btnDeleteStudent').forEach(b => b.addEventListener('click', async (e) => {
            const uid = e.currentTarget.dataset.uid;
            if (!confirm('Delete student Firestore doc? This will NOT delete auth user.')) return;
            await deleteDoc(doc(db, 'students', uid));
            setGlobalMsg('Student doc deleted', 'success');
            await loadStudentsList();
            await populateStudentSelects();
        }));
    } catch (e) { setGlobalMsg('Load students failed: ' + e.message, 'error'); }
}

// Course Form Modal
$('#btnAddCourseModal').addEventListener('click', () => {
    openCourseModal();
});
async function openCourseModal(id = null, data = {}) {
    const isEdit = id !== null;
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">${isEdit ? 'Edit Course' : 'Add New Course'}</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formCourse" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Course Code</span>
            <input id="c_code" placeholder="Code (CSC101)" class="w-full mt-2 p-3 border rounded-lg" value="${data.code || ''}" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Course Title</span>
            <input id="c_title" placeholder="Title" class="w-full mt-2 p-3 border rounded-lg" value="${data.title || ''}" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Credits</span>
            <input id="c_credits" type="number" placeholder="Credits" class="w-full mt-2 p-3 border rounded-lg" value="${data.credits || ''}" />
        </label>
        <div class="flex gap-3">
            <button id="btnSaveCourse" type="submit" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg font-bold hover:bg-green-600 transition duration-300"><i class="fa-solid fa-save mr-2"></i>${isEdit ? 'Update Course' : 'Add Course'}</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
      </form>
    `;
    showModal(formHtml);

    $('#formCourse').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const code = $('#c_code').value.trim();
        const title = $('#c_title').value.trim();
        const credits = Number($('#c_credits').value || 0);
        if (!code || !title) { showMsg('#modalMsg', 'Code & title required', 'error'); return; }
        try {
            if (isEdit) {
                await updateDoc(doc(db, 'courses', id), { code, title, credits });
                setGlobalMsg('Course updated', 'success');
            } else {
                await addDoc(collection(db, 'courses'), { code, title, credits, createdAt: serverTimestamp() });
                setGlobalMsg('Course added', 'success');
            }
            hideModal();
            await loadCoursesList();
            await populateCourseSelects();
        } catch (e) {
            showMsg('#modalMsg', 'Save failed: ' + e.message, 'error');
        }
    });
}
async function loadCoursesList() {
    const container = $('#coursesList');
    container.innerHTML = '<div class="text-slate-500 p-2 text-center">Loading courses...</div>';
    try {
        const snaps = await getDocs(collection(db, 'courses'));
        container.innerHTML = '';
        if (snaps.empty) { container.innerHTML = '<div class="text-slate-500 p-2 text-center">No courses.</div>'; return; }
        snaps.forEach(snap => {
            const d = snap.data();
            const el = document.createElement('div');
            el.className = 'p-3 border rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white shadow-sm hover:shadow-md transition duration-200';
            el.innerHTML = `<div><div class="font-bold text-gray-800">${d.code} — ${d.title}</div><div class="text-xs text-slate-600">${d.credits || 0} credits</div></div>
        <div class="flex gap-2 mt-2 sm:mt-0">
          <button data-id="${snap.id}" class="editCourse px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm font-semibold hover:bg-blue-200"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
          <button data-id="${snap.id}" class="delCourse px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200"><i class="fa-solid fa-trash-can"></i> Delete</button>
        </div>`;
            container.appendChild(el);
        });
        $$('.delCourse').forEach(b => b.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            if (!confirm('Delete course?')) return;
            await deleteDoc(doc(db, 'courses', id));
            setGlobalMsg('Course deleted', 'success');
            await loadCoursesList();
            await populateCourseSelects();
        }));
        $$('.editCourse').forEach(b => b.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            const sSnap = await getDoc(doc(db, 'courses', id));
            const data = sSnap.data();
            openCourseModal(id, data);
        }));
    } catch (e) { setGlobalMsg('Load failed: ' + e.message, 'error'); }
}
$('#btnLoadTT').addEventListener('click', async () => {
    clearMsg('#ttMsg');
    const uid = $('#tt_student_select').value;
    if (!uid) { showMsg('#ttMsg', 'Pick a student', 'error'); return; }
    try {
        const snap = await getDoc(doc(db, 'timetable', uid));
        $('#tt_editor').value = JSON.stringify(snap.exists() ? snap.data().schedule || [] : [], null, 2);
        showMsg('#ttMsg', 'Timetable loaded (edit JSON then Save)', 'success');
    } catch (e) { showMsg('#ttMsg', 'Load failed: ' + e.message, 'error'); }
});
$('#btnSaveTT').addEventListener('click', async () => {
    clearMsg('#ttMsg');
    const uid = $('#tt_student_select').value;
    if (!uid) { showMsg('#ttMsg', 'Pick a student', 'error'); return; }
    try {
        const parsed = JSON.parse($('#tt_editor').value || '[]');
        if (!Array.isArray(parsed)) { showMsg('#ttMsg', 'JSON must be an array', 'error'); return; }
        await setDoc(doc(db, 'timetable', uid), { schedule: parsed, updatedAt: serverTimestamp() });
        showMsg('#ttMsg', 'Saved timetable', 'success');
    } catch (e) { showMsg('#ttMsg', 'Save failed: ' + e.message, 'error'); }
});

// Grades Modal
$('#btnAddGradeModal').addEventListener('click', () => {
    const sid = $('#grades_student_select').value;
    if (!sid) { setGlobalMsg('Please select a student first.', 'error'); return; }
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Add Grade</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formAddGrade" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Course</span>
            <select id="grades_course_select_modal" class="w-full mt-2 p-3 border rounded-lg"></select>
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Grade</span>
            <input id="grades_grade_input_modal" placeholder="Grade (A, B+...)" class="w-full mt-2 p-3 border rounded-lg" />
        </label>
        <div class="flex gap-3">
            <button id="btnSaveGrade" type="submit" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg font-bold hover:bg-green-600 transition duration-300">Save Grade</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
      </form>
    `;
    showModal(formHtml);
    populateCourseSelects('#grades_course_select_modal');

    $('#formAddGrade').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const sid = $('#grades_student_select').value;
        const cid = $('#grades_course_select_modal').value;
        const grade = $('#grades_grade_input_modal').value.trim();
        if (!sid || !cid || !grade) { showMsg('#modalMsg', 'Select student, course, and enter grade', 'error'); return; }
        try {
            const courseSnap = await getDoc(doc(db, 'courses', cid));
            const title = courseSnap.exists() ? courseSnap.data().title : '';
            const gpaMap = { 'A+': 4.0, 'A': 4.0, 'A-': 3.7, 'B+': 3.3, 'B': 3.0, 'B-': 2.7, 'C+': 2.3, 'C': 2.0, 'D': 1.0, 'E': 0.7, 'F': 0.0 };
            const points = gpaMap[grade] ?? 0;
            await setDoc(doc(db, 'grades', sid, 'results', cid), { code: cid, title, grade, gpaPoints: points, savedAt: serverTimestamp() });
            setGlobalMsg('Grade saved', 'success');
            hideModal();
            await loadGradesForStudent(sid);
        } catch (e) { showMsg('#modalMsg', 'Save failed: ' + e.message, 'error'); }
    });
});
async function loadGradesForStudent(sid) {
    const out = $('#gradesList');
    out.innerHTML = '';
    if (!sid) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">Select student</div>'; return; }
    try {
        const snaps = await getDocs(collection(db, 'grades', sid, 'results'));
        if (snaps.empty) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">No grades</div>'; return; }
        snaps.forEach(s => {
            const r = s.data();
            out.innerHTML += `<div class="p-3 border rounded-lg bg-white shadow-sm flex justify-between items-center"><div><div class="font-bold">${r.code} • ${r.title || ''}</div><div class="text-sm text-gray-600">Grade: <span class="font-semibold">${r.grade}</span></div></div><div><button class="delGrade px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200" data-id="${s.id}" data-sid="${sid}"><i class="fa-solid fa-trash-can"></i> Delete</button></div></div>`;
        });
        $$('.delGrade').forEach(b => b.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id,
                sid = e.currentTarget.dataset.sid;
            if (!confirm('Delete grade?')) return;
            await deleteDoc(doc(db, 'grades', sid, 'results', id));
            showMsg('#gradesMsg', 'Deleted', 'success');
            await loadGradesForStudent(sid);
        }));
    } catch (e) { showMsg('#gradesMsg', 'Load failed: ' + e.message, 'error'); }
}
$('#grades_student_select').addEventListener('change', () => loadGradesForStudent($('#grades_student_select').value));

// Finance Modal
$('#btnAddTransactionModal').addEventListener('click', () => {
    const sid = $('#finance_student_select').value;
    if (!sid) { setGlobalMsg('Please select a student first.', 'error'); return; }
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Add Transaction</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formAddTransaction" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Amount (KES)</span>
            <input id="finance_amount_modal" type="number" placeholder="KES amount" class="w-full mt-2 p-3 border rounded-lg" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Transaction Type</span>
            <select id="finance_type_modal" class="w-full mt-2 p-3 border rounded-lg"><option value="charge">Charge</option><option value="payment">Payment</option></select>
        </label>
        <div class="flex gap-3">
            <button id="btnSaveTransaction" type="submit" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg font-bold hover:bg-green-600 transition duration-300">Save Transaction</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
      </form>
    `;
    showModal(formHtml);

    $('#formAddTransaction').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const sid = $('#finance_student_select').value;
        const amount = Number($('#finance_amount_modal').value || 0);
        const type = $('#finance_type_modal').value;
        if (!sid || !amount) { showMsg('#modalMsg', 'Select student and amount', 'error'); return; }
        try {
            await addDoc(collection(db, 'finance', sid, 'transactions'), { amount, type, createdAt: serverTimestamp(), createdBy: $('#adminEmail').textContent });
            const sumRef = doc(db, 'finance', sid, 'balance', 'summary');
            await runTransaction(db, async tx => {
                const s = await tx.get(sumRef);
                const cur = s.exists() ? s.data() : { amount: 0, paid: 0 };
                if (type === 'payment') tx.set(sumRef, { amount: cur.amount || 0, paid: (cur.paid || 0) + amount }, { merge: true });
                else tx.set(sumRef, { amount: (cur.amount || 0) + amount, paid: cur.paid || 0 }, { merge: true });
            });
            setGlobalMsg('Transaction recorded', 'success');
            hideModal();
            await loadFinanceForStudent(sid);
        } catch (e) { showMsg('#modalMsg', 'Transaction failed: ' + e.message, 'error'); }
    });
});
async function loadFinanceForStudent(sid) {
    const out = $('#financeList');
    out.innerHTML = '';
    if (!sid) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">Select student</div>'; return; }
    try {
        const txs = await getDocs(collection(db, 'finance', sid, 'transactions'));
        if (txs.empty) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">No transactions</div>'; return; }
        txs.forEach(t => {
            const d = t.data();
            out.innerHTML += `<div class="p-3 border rounded-lg bg-white shadow-sm flex justify-between items-center"><div class="font-semibold">${d.type === 'charge' ? 'Charge' : 'Payment'}</div><div>KES ${Number(d.amount).toLocaleString()}</div><div class="text-sm text-slate-500">${d.createdAt?.toDate? d.createdAt.toDate().toLocaleDateString() : ''}</div></div>`;
        });
    } catch (e) { showMsg('#financeMsg', 'Load failed: ' + e.message, 'error'); }
}
$('#finance_student_select').addEventListener('change', () => loadFinanceForStudent($('#finance_student_select').value));

// Hostels Modal
$('#btnAddHostelModal').addEventListener('click', () => {
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Add New Hostel</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formAddHostel" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Hostel Name</span>
            <input id="hostel_name_modal" placeholder="Hostel name" class="w-full mt-2 p-3 border rounded-lg" required/>
        </label>
        <div class="flex gap-3">
            <button id="btnSaveHostel" type="submit" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg font-bold hover:bg-green-600 transition duration-300">Add Hostel</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
      </form>
    `;
    showModal(formHtml);

    $('#formAddHostel').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const name = $('#hostel_name_modal').value.trim();
        if (!name) { showMsg('#modalMsg', 'Provide hostel name', 'error'); return; }
        try {
            await addDoc(collection(db, 'hostels'), { name, description: '', availableCount: 0, createdAt: serverTimestamp() });
            setGlobalMsg('Hostel added', 'success');
            hideModal();
            await loadHostelsList();
            await populateHostelSelects();
        } catch (e) { showMsg('#modalMsg', 'Failed: ' + e.message, 'error'); }
    });
});
$('#btnAddRoomModal').addEventListener('click', () => {
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Add New Room</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formAddRoom" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Select Hostel</span>
            <select id="hostel_select_for_room_modal" class="w-full mt-2 p-3 border rounded-lg"></select>
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Room No.</span>
            <input id="room_no_modal" placeholder="Room no" class="w-full mt-2 p-3 border rounded-lg"/>
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Capacity</span>
            <input id="room_capacity_modal" type="number" placeholder="Capacity" class="w-full mt-2 p-3 border rounded-lg"/>
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Price</span>
            <input id="room_price_modal" type="number" placeholder="Price" class="w-full mt-2 p-3 border rounded-lg"/>
        </label>
        <div class="flex gap-3">
            <button id="btnSaveRoom" type="submit" class="px-4 py-3 bg-[#0A6EBD] text-white rounded-lg font-bold hover:bg-blue-700 transition duration-300">Add Room</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
      </form>
    `;
    showModal(formHtml);
    populateHostelSelects('#hostel_select_for_room_modal');

    $('#formAddRoom').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const hid = $('#hostel_select_for_room_modal').value;
        const roomNo = $('#room_no_modal').value.trim();
        const cap = Number($('#room_capacity_modal').value || 1);
        const price = Number($('#room_price_modal').value || 0);
        if (!hid || !roomNo) { showMsg('#modalMsg', 'Pick hostel and room no', 'error'); return; }
        try {
            await addDoc(collection(db, 'hostels', hid, 'rooms'), { roomNo, capacity: cap, price, status: 'available', createdAt: serverTimestamp() });
            await runTransaction(db, async tx => {
                const hRef = doc(db, 'hostels', hid);
                const hSnap = await tx.get(hRef);
                tx.update(hRef, { availableCount: (hSnap.data().availableCount || 0) + 1 });
            });
            setGlobalMsg('Room added', 'success');
            hideModal();
            await loadHostelsList();
            await populateHostelSelects();
        } catch (e) { showMsg('#modalMsg', 'Add room failed: ' + e.message, 'error'); }
    });
});
async function loadHostelsList() {
    const out = $('#hostelsList');
    out.innerHTML = '<div class="text-slate-500 p-2 text-center">Loading hostels...</div>';
    try {
        const snap = await getDocs(collection(db, 'hostels'));
        out.innerHTML = '';
        if (snap.empty) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">No hostels</div>'; return; }
        snap.forEach(h => {
            const d = h.data();
            const el = document.createElement('div');
            el.className = 'p-4 border rounded-lg bg-white shadow-sm hover:shadow-md transition duration-200';
            el.innerHTML = `<div class="flex justify-between items-start"><div><div class="font-bold text-lg">${d.name}</div><div class="text-sm text-slate-600">Available: ${d.availableCount || 0}</div></div><div class="flex gap-2"><button data-id="${h.id}" class="viewRooms px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm font-semibold hover:bg-blue-200"><i class="fa-solid fa-bed mr-1"></i> Rooms</button><button data-id="${h.id}" class="delHostel px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200"><i class="fa-solid fa-trash-can"></i> Delete</button></div></div><div id="rooms-${h.id}" class="mt-4"></div>`;
            out.appendChild(el);
        });
        $$('.delHostel').forEach(b => b.addEventListener('click', async (e) => {
            const hid = e.currentTarget.dataset.id;
            if (!confirm('Delete hostel doc? Rooms subcollection will remain unless deleted separately.')) return;
            await deleteDoc(doc(db, 'hostels', hid));
            setGlobalMsg('Hostel removed', 'success');
            await loadHostelsList();
            await populateHostelSelects();
        }));
        $$('.viewRooms').forEach(b => b.addEventListener('click', async (e) => {
            const hid = e.currentTarget.dataset.id;
            const roomsOut = $('#rooms-' + hid);
            roomsOut.innerHTML = '<div class="text-slate-500 p-2">Loading rooms...</div>';
            const rSnap = await getDocs(collection(db, 'hostels', hid, 'rooms'));
            roomsOut.innerHTML = '';
            if (rSnap.empty) { roomsOut.innerHTML = '<div class="text-slate-500 p-2">No rooms</div>'; return; }
            rSnap.forEach(r => {
                const rr = r.data();
                const statusClass = rr.status === 'available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const statusText = rr.status === 'available' ? 'Mark booked' : 'Mark available';
                roomsOut.innerHTML += `<div class="p-3 border rounded-lg bg-gray-50 mb-2 flex justify-between items-center"><div><strong>Room ${rr.roomNo}</strong><div class="text-xs text-slate-600">Cap ${rr.capacity} • KES ${rr.price}</div></div><div class="flex gap-2"><button data-h="${hid}" data-r="${r.id}" class="toggleRoom px-3 py-1 ${statusClass} rounded-lg text-xs font-semibold hover:opacity-80">${statusText}</button><button data-h="${hid}" data-r="${r.id}" class="delRoom px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-xs font-semibold hover:bg-gray-300"><i class="fa-solid fa-trash-can"></i> Delete</button></div></div>`;
            });
            $$('.toggleRoom').forEach(btn => btn.addEventListener('click', async (ev) => {
                const hid = ev.currentTarget.dataset.h;
                const rid = ev.currentTarget.dataset.r;
                const rRef = doc(db, 'hostels', hid, 'rooms', rid);
                const rSnap = await getDoc(rRef);
                const newStatus = rSnap.data().status === 'available' ? 'booked' : 'available';
                await updateDoc(rRef, { status: newStatus });
                const hRef = doc(db, 'hostels', hid);
                await runTransaction(db, async tx => {
                    const hS = await tx.get(hRef);
                    const cur = hS.data().availableCount || 0;
                    tx.update(hRef, { availableCount: newStatus === 'available' ? cur + 1 : Math.max(0, cur - 1) });
                });
                setGlobalMsg('Room status toggled', 'success');
                await loadHostelsList();
                await populateHostelSelects();
            }));
            $$('.delRoom').forEach(btn => btn.addEventListener('click', async (ev) => {
                const hid = ev.currentTarget.dataset.h;
                const rid = ev.currentTarget.dataset.r;
                if (!confirm('Delete room?')) return;
                await deleteDoc(doc(db, 'hostels', hid, 'rooms', rid));
                setGlobalMsg('Room deleted', 'success');
                await loadHostelsList();
                await populateHostelSelects();
            }));
        }));
    } catch (e) { showMsg('#hostelsMsg', 'Load failed: ' + e.message, 'error'); }
}

// Announcements Modal
$('#btnAddAnnModal').addEventListener('click', () => {
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Post New Announcement</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formAddAnn" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">Title</span>
            <input id="ann_title_modal" placeholder="Title" class="w-full mt-2 p-3 border rounded-lg" required/>
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Message</span>
            <textarea id="ann_body_modal" placeholder="Message" class="w-full h-32 mt-2 p-3 border rounded-lg" required></textarea>
        </label>
        <div class="flex gap-3">
            <button id="btnSaveAnn" type="submit" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg font-bold hover:bg-green-600 transition duration-300"><i class="fa-solid fa-paper-plane mr-2"></i>Post</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
      </form>
    `;
    showModal(formHtml);
    $('#formAddAnn').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const title = $('#ann_title_modal').value.trim();
        const body = $('#ann_body_modal').value.trim();
        if (!title || !body) { showMsg('#modalMsg', 'Title and message required', 'error'); return; }
        try {
            await addDoc(collection(db, 'announcements'), { title, body, createdAt: serverTimestamp(), author: $('#adminEmail').textContent });
            setGlobalMsg('Announcement posted', 'success');
            hideModal();
            await loadAnnouncementsList();
        } catch (e) { showMsg('#modalMsg', 'Post failed: ' + e.message, 'error'); }
    });
});
async function loadAnnouncementsList() {
    const out = $('#announcementsList');
    out.innerHTML = '<div class="text-slate-500 p-2 text-center">Loading announcements...</div>';
    try {
        const snaps = await getDocs(query(collection(db, 'announcements'), orderBy('createdAt', 'desc')));
        out.innerHTML = '';
        if (snaps.empty) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">No announcements</div>'; return; }
        snaps.forEach(snap => {
            const d = snap.data();
            const el = document.createElement('div');
            el.className = 'p-4 border rounded-lg bg-white shadow-sm hover:shadow-md transition duration-200';
            el.innerHTML = `<div class="flex justify-between items-start"><div><div class="font-bold text-lg">${d.title}</div><div class="text-xs text-slate-500">${d.author||''} • ${d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : ''}</div></div><div><button data-id="${snap.id}" class="delAnn px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200"><i class="fa-solid fa-trash-can"></i> Delete</button></div></div><div class="mt-2 text-sm text-gray-700">${d.body}</div>`;
            out.appendChild(el);
        });
        $$('.delAnn').forEach(b => b.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            if (!confirm('Delete announcement?')) return;
            await deleteDoc(doc(db, 'announcements', id));
            setGlobalMsg('Announcement deleted', 'success');
            await loadAnnouncementsList();
        }));
    } catch (e) { setGlobalMsg('Load announcements failed: ' + e.message, 'error'); }
}
$('#btnLoadClearanceModal').addEventListener('click', async () => {
    const sid = $('#clearance_student_select').value;
    if (!sid) { setGlobalMsg('Pick student', 'error'); return; }
    try {
        const snap = await getDoc(doc(db, 'clearance', sid));
        const d = snap.exists() ? snap.data() : { library: 'pending', finance: 'pending', hostel: 'pending', department: 'pending' };
        const formHtml = `
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Edit Clearance</h3>
            <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div id="modalMsg" class="msg hidden"></div>
          <div class="space-y-4">
            <div><label class="text-sm font-semibold text-gray-600">Library</label><input id="clear_lib" value="${d.library||'pending'}" class="w-full mt-2 p-3 border rounded-lg"/></div>
            <div><label class="text-sm font-semibold text-gray-600">Finance</label><input id="clear_fin" value="${d.finance||'pending'}" class="w-full mt-2 p-3 border rounded-lg"/></div>
            <div><label class="text-sm font-semibold text-gray-600">Hostel</label><input id="clear_hos" value="${d.hostel||'pending'}" class="w-full mt-2 p-3 border rounded-lg"/></div>
            <div><label class="text-sm font-semibold text-gray-600">Department</label><input id="clear_dept" value="${d.department||'pending'}" class="w-full mt-2 p-3 border rounded-lg"/></div>
          </div>
          <div class="mt-6 flex gap-3">
            <button id="btnSaveClearance" class="px-4 py-3 bg-[#0A6EBD] text-white rounded-lg font-bold hover:bg-blue-700 transition duration-300"><i class="fa-solid fa-floppy-disk mr-2"></i>Save clearance</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
          </div>
        `;
        showModal(formHtml);
        $('#btnSaveClearance').onclick = async () => {
            await setDoc(doc(db, 'clearance', sid), { library: $('#clear_lib').value, finance: $('#clear_fin').value, hostel: $('#clear_hos').value, department: $('#clear_dept').value }, { merge: true });
            setGlobalMsg('Clearance saved', 'success');
            hideModal();
        };
    } catch (e) { setGlobalMsg('Load clearance failed: ' + e.message, 'error'); }
});
$('#btnReloadGrad').addEventListener('click', () => loadGraduationRequests());
async function loadGraduationRequests() {
    const out = $('#graduationList');
    out.innerHTML = '<div class="text-slate-500 p-2 text-center">Loading requests...</div>';
    try {
        const snaps = await getDocs(collection(db, 'graduationRequests'));
        out.innerHTML = '';
        if (snaps.empty) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">No requests</div>'; return; }
        snaps.forEach(snap => {
            const d = snap.data();
            const el = document.createElement('div');
            el.className = 'p-4 border rounded-lg bg-white shadow-sm hover:shadow-md transition duration-200';
            el.innerHTML = `<div class="flex justify-between items-start"><div><div class="font-bold text-lg">Request from: ${snap.id}</div><div class="text-sm text-slate-600">Status: <span class="font-semibold">${d.status||'pending'}</span> • ${d.requestedAt?.toDate? d.requestedAt.toDate().toLocaleString() : ''}</div><div class="mt-2 text-sm text-gray-700">${d.reason||''}</div></div>
        <div class="flex gap-2"><button data-id="${snap.id}" data-act="approve" class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700"><i class="fa-solid fa-check"></i> Approve</button><button data-id="${snap.id}" data-act="reject" class="px-3 py-1 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700"><i class="fa-solid fa-xmark"></i> Reject</button></div>`;
            out.appendChild(el);
        });
        $$('[data-act="approve"]').forEach(b => b.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            await updateDoc(doc(db, 'graduationRequests', id), { status: 'approved', decidedAt: serverTimestamp() });
            setGlobalMsg('Approved', 'success');
            loadGraduationRequests();
        }));
        $$('[data-act="reject"]').forEach(b => b.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            await updateDoc(doc(db, 'graduationRequests', id), { status: 'rejected', decidedAt: serverTimestamp() });
            setGlobalMsg('Rejected', 'info');
            loadGraduationRequests();
        }));
    } catch (e) { setGlobalMsg('Load grad requests failed: ' + e.message, 'error'); }
}

// Admins Modal
$('#btnAddAdminModal').addEventListener('click', () => {
    const formHtml = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">Add New Admin</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modalMsg" class="msg hidden"></div>
      <form id="formAddAdmin" class="space-y-4">
        <label class="block"><span class="text-sm font-semibold text-gray-600">User UID</span>
            <input id="admin_uid_modal" placeholder="User UID (preferred)" class="w-full mt-2 p-3 border rounded-lg" />
        </label>
        <label class="block"><span class="text-sm font-semibold text-gray-600">Or Email (optional)</span>
            <input id="admin_email_modal" placeholder="Or email (optional)" class="w-full mt-2 p-3 border rounded-lg" />
        </label>
        <div class="flex gap-3">
            <button type="submit" class="px-4 py-3 bg-[#2ecc71] text-white rounded-lg font-bold hover:bg-green-600 transition duration-300"><i class="fa-solid fa-user-plus mr-2"></i>Add Admin</button>
            <button type="button" onclick="hideModal()" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">Cancel</button>
        </div>
        <div class="text-xs text-slate-500 mt-4">Manage admin users in Firestore (<code>admins/{uid}</code>).</div>
      </form>
    `;
    showModal(formHtml);
    $('#formAddAdmin').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg('#modalMsg');
        const uid = $('#admin_uid_modal').value.trim();
        const email = $('#admin_email_modal').value.trim();
        if (!uid && !email) { showMsg('#modalMsg', 'Provide UID or email', 'error'); return; }
        try {
            let adminUid = uid;
            if (!adminUid && email) {
                const snaps = await getDocs(query(collection(db, 'students'), where('email', '==', email), limit(1)));
                if (!snaps.empty) adminUid = snaps.docs[0].id;
                else {
                    const docRef = await addDoc(collection(db, 'admins'), { isAdmin: true, email });
                    showMsg('#modalMsg', 'Added admin record (no uid) with id: ' + docRef.id, 'success');
                    await loadAdminsList();
                    setTimeout(hideModal, 1000);
                    return;
                }
            }
            if (adminUid) {
                await setDoc(doc(db, 'admins', adminUid), { isAdmin: true, email: email || null }, { merge: true });
                showMsg('#modalMsg', 'Admin granted for UID: ' + adminUid, 'success');
                $('#admin_uid_modal').value = '';
                $('#admin_email_modal').value = '';
                await loadAdminsList();
                setTimeout(hideModal, 1000);
            }
        } catch (e) { showMsg('#modalMsg', 'Failed to add admin: ' + e.message, 'error'); }
    });
});
$('#btnReloadAdmins').addEventListener('click', () => loadAdminsList());
async function loadAdminsList() {
    const out = $('#adminsList');
    out.innerHTML = '<div class="text-slate-500 p-2 text-center">Loading admins...</div>';
    try {
        const snaps = await getDocs(collection(db, 'admins'));
        out.innerHTML = '';
        if (snaps.empty) { out.innerHTML = '<div class="text-slate-500 p-2 text-center">No admins.</div>'; return; }
        snaps.forEach(snap => {
            const d = snap.data();
            const el = document.createElement('div');
            el.className = 'p-3 border rounded-lg bg-white shadow-sm flex justify-between items-center';
            el.innerHTML = `<div><div class="font-bold">${snap.id}</div><div class="text-xs text-slate-600">${d.email || ''}</div></div><div><button data-id="${snap.id}" class="revokeAdmin px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200"><i class="fa-solid fa-user-slash"></i> Revoke</button></div>`;
            out.appendChild(el);
        });
        $$('.revokeAdmin').forEach(b => b.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            if (!confirm('Remove admin rights for UID ' + id + '?')) return;
            await deleteDoc(doc(db, 'admins', id));
            setGlobalMsg('Admin removed: ' + id, 'success');
            await loadAdminsList();
        }));
    } catch (e) { showMsg('#adminsMsg', 'Admins load failed: ' + e.message, 'error'); }
}
async function populateStudentSelects() {
    const selectors = ['#tt_student_select', '#grades_student_select', '#finance_student_select', '#clearance_student_select'];
    try {
        const snaps = await getDocs(collection(db, 'students'));
        selectors.forEach(sel => {
            const el = $(sel);
            if (!el) return;
            el.innerHTML = '<option value="">Select student</option>';
            snaps.forEach(snap => {
                const d = snap.data();
                el.insertAdjacentHTML('beforeend', `<option value="${snap.id}">${(d.name||snap.id)} ${(d.regNo ? ' • '+d.regNo : '')}</option>`);
            });
        });
    } catch (e) { setGlobalMsg('Populate students failed: ' + e.message, 'error'); }
}
async function populateCourseSelects(elSelector = '#grades_course_select') {
    const el = $(elSelector);
    if (!el) return;
    try {
        const snaps = await getDocs(collection(db, 'courses'));
        el.innerHTML = '<option value="">Select course</option>';
        snaps.forEach(s => el.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.data().code||s.id} — ${s.data().title||''}</option>`));
    } catch (e) { setGlobalMsg('Populate courses failed: ' + e.message, 'error'); }
}
async function populateHostelSelects(elSelector = '#hostel_select_for_room') {
    const el = $(elSelector);
    if (!el) return;
    try {
        const snaps = await getDocs(collection(db, 'hostels'));
        el.innerHTML = '<option value="">Select hostel</option>';
        snaps.forEach(s => el.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.data().name || s.id}</option>`));
    } catch (e) { setGlobalMsg('Populate hostels failed: ' + e.message, 'error'); }
}
$('#btnReloadStudents').addEventListener('click', () => loadStudentsList());
$('#btnReloadCourses').addEventListener('click', () => loadCoursesList());
$('#btnReloadGrad').addEventListener('click', () => loadGraduationRequests());
onAuthStateChanged(auth, async (user) => {
    if (user) {
        await populateStudentSelects();
        await populateCourseSelects();
        await populateHostelSelects();
    }
});
</script>
</body>
</html>
