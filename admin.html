<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — University Dashboard (Full CRUD)</title>

<!-- Tailwind + FontAwesome -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<!-- jsPDF for exports -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f4f6; }
  .card { background:white; border-radius:12px; box-shadow:0 8px 28px rgba(2,6,23,0.06); }
  .small { font-size:.85rem; }
</style>
</head>
<body class="min-h-screen">

<!-- Login Screen -->
<div id="loginView" class="min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-3">Admin Sign In</h1>
    <p class="text-sm text-slate-500 mb-4">Sign in with an admin account (must exist in <code>admins/{uid}.isAdmin</code>).</p>
    <div class="space-y-3">
      <input id="loginEmail" type="email" placeholder="admin@example.com" class="w-full p-2 border rounded" />
      <input id="loginPassword" type="password" placeholder="Password" class="w-full p-2 border rounded" />
      <div class="flex gap-2">
        <button id="btnSignIn" class="flex-1 bg-blue-600 text-white py-2 rounded">Sign in</button>
        <button id="btnDemo" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded">Demo data</button>
      </div>
      <div id="loginMsg" class="text-sm text-red-600"></div>
    </div>
    <p class="text-xs text-slate-400 mt-4">Note: Admin must have Firestore doc at <code>admins/{uid}</code> with <code>isAdmin: true</code>.</p>
  </div>
</div>

<!-- Dashboard -->
<div id="appView" class="hidden">
  <header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-4">
      <div class="flex items-center gap-3">
        <button id="hamburger" class="md:hidden p-2 rounded hover:bg-gray-100"><i class="fa-solid fa-bars"></i></button>
        <div class="font-bold text-lg text-blue-700">University Admin</div>
      </div>
      <div class="flex items-center gap-3">
        <div id="adminEmail" class="text-sm font-semibold text-slate-700"></div>
        <button id="btnSignOut" class="px-3 py-1 bg-red-600 text-white rounded">Sign out</button>
      </div>
    </div>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-white border-r p-4 hidden md:block">
      <nav class="space-y-2 text-sm">
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-overview"><i class="fa-solid fa-chart-pie mr-2 text-blue-600"></i> Overview</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-students"><i class="fa-solid fa-users mr-2 text-blue-600"></i> Students</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-courses"><i class="fa-solid fa-book mr-2 text-blue-600"></i> Courses</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-timetable"><i class="fa-solid fa-calendar-days mr-2 text-blue-600"></i> Timetable</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-grades"><i class="fa-solid fa-graduation-cap mr-2 text-blue-600"></i> Grades</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-finance"><i class="fa-solid fa-money-bill-wave mr-2 text-blue-600"></i> Finance</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-hostels"><i class="fa-solid fa-hotel mr-2 text-blue-600"></i> Hostels</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-announcements"><i class="fa-solid fa-bullhorn mr-2 text-blue-600"></i> Announcements</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-clearance"><i class="fa-solid fa-check-circle mr-2 text-blue-600"></i> Clearance</button>
        <button class="navBtn w-full text-left px-3 py-2 rounded hover:bg-slate-50" data-panel="panel-graduation"><i class="fa-solid fa-certificate mr-2 text-blue-600"></i> Graduation</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">
      <!-- Overview -->
      <section id="panel-overview" class="card p-6 mb-6">
        <h2 class="text-xl font-bold mb-2">Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 card text-center"><div class="text-sm text-slate-500">Students</div><div id="statStudents" class="text-2xl font-bold">—</div></div>
          <div class="p-4 card text-center"><div class="text-sm text-slate-500">Courses</div><div id="statCourses" class="text-2xl font-bold">—</div></div>
          <div class="p-4 card text-center"><div class="text-sm text-slate-500">Hostels</div><div id="statHostels" class="text-2xl font-bold">—</div></div>
        </div>
      </section>

      <!-- Students -->
      <section id="panel-students" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Students</h2>
          <div class="flex gap-2">
            <input id="studentSearch" class="border p-2 rounded" placeholder="Search name / regNo"/>
            <button id="btnReloadStudents" class="px-3 py-2 bg-slate-200 rounded">Reload</button>
          </div>
        </div>

        <!-- Add student form -->
        <form id="formAddStudent" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
          <input id="new_name" placeholder="Full name" class="border p-2 rounded"/>
          <input id="new_email" placeholder="Email" class="border p-2 rounded"/>
          <input id="new_regNo" placeholder="Reg No" class="border p-2 rounded"/>
          <input id="new_tempPassword" placeholder="Temporary password" class="border p-2 rounded" value="changeme123"/>
          <div class="md:col-span-4 flex gap-2">
            <button class="px-3 py-2 bg-green-600 text-white rounded">Create student account</button>
            <button id="btnClearStudentForm" type="button" class="px-3 py-2 bg-gray-100 rounded">Clear</button>
          </div>
        </form>

        <div id="studentsList" class="space-y-2"></div>

        <!-- Edit modal (simple) -->
        <div id="studentEditor" class="hidden mt-4 p-4 border rounded card">
          <h3 class="font-semibold">Edit Student</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
            <input id="edit_name" class="border p-2 rounded" />
            <input id="edit_email" class="border p-2 rounded" readonly />
            <input id="edit_regNo" class="border p-2 rounded" />
            <input id="edit_programme" class="border p-2 rounded" placeholder="Programme" />
            <input id="edit_campus" class="border p-2 rounded" placeholder="Campus" />
            <input id="edit_year" type="number" class="border p-2 rounded" placeholder="Year" />
            <textarea id="edit_address" class="border p-2 rounded md:col-span-3" placeholder="Address"></textarea>
          </div>
          <div class="flex gap-2 mt-3">
            <button id="btnSaveStudent" class="px-3 py-2 bg-blue-600 text-white rounded">Save changes</button>
            <button id="btnCancelEditStudent" class="px-3 py-2 border rounded">Cancel</button>
            <button id="btnDeleteStudent" class="px-3 py-2 bg-red-600 text-white rounded ml-auto">Delete student doc</button>
          </div>
        </div>
      </section>

      <!-- Courses -->
      <section id="panel-courses" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Courses</h2>
          <div class="flex gap-2">
            <input id="courseSearch" placeholder="Search code/title" class="border p-2 rounded" />
            <button id="btnReloadCourses" class="px-3 py-2 bg-slate-200 rounded">Reload</button>
          </div>
        </div>

        <form id="formCourse" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
          <input id="c_code" placeholder="Code (e.g. CSC101)" class="border p-2 rounded" />
          <input id="c_title" placeholder="Title" class="border p-2 rounded" />
          <input id="c_credits" type="number" placeholder="Credits" class="border p-2 rounded" />
          <div class="flex gap-2">
            <button id="btnAddCourse" class="px-3 py-2 bg-green-600 text-white rounded">Add course</button>
            <button id="btnClearCourse" class="px-3 py-2 bg-gray-100 rounded">Clear</button>
          </div>
        </form>

        <div id="coursesList" class="space-y-2"></div>
      </section>

      <!-- Timetable -->
      <section id="panel-timetable" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Timetable</h2>
          <div class="flex gap-2">
            <select id="tt_student_select" class="border p-2 rounded"></select>
            <button id="btnLoadTT" class="px-3 py-2 bg-blue-600 text-white rounded">Load</button>
            <button id="btnSaveTT" class="px-3 py-2 bg-green-600 text-white rounded">Save</button>
          </div>
        </div>

        <div class="mb-3">
          <textarea id="tt_editor" class="w-full h-40 border p-2 rounded" placeholder='Paste JSON array: [{"day":"Monday","time":"09:00","courseCode":"CSC101","venue":"RM1"}]'></textarea>
          <p class="text-xs text-slate-500 mt-2">Timetable stored at <code>timetable/{studentUid}</code> as { schedule: [...] }.</p>
        </div>

        <div id="timetablePreview" class="mt-3 text-sm"></div>
      </section>

      <!-- Grades -->
      <section id="panel-grades" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Grades</h2>
          <div class="flex gap-2">
            <select id="grades_student_select" class="border p-2 rounded"></select>
            <select id="grades_course_select" class="border p-2 rounded"></select>
            <input id="grades_grade_input" placeholder="Grade e.g. A" class="border p-2 rounded" />
            <button id="btnAddGrade" class="px-3 py-2 bg-green-600 text-white rounded">Save Grade</button>
          </div>
        </div>

        <div id="gradesList" class="space-y-2"></div>
      </section>

      <!-- Finance -->
      <section id="panel-finance" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Finance</h2>
          <div class="flex gap-2">
            <select id="finance_student_select" class="border p-2 rounded"></select>
            <input id="finance_amount" type="number" placeholder="KES amount" class="border p-2 rounded" />
            <select id="finance_type" class="border p-2 rounded"><option value="charge">Charge</option><option value="payment">Payment</option></select>
            <button id="btnAddTransaction" class="px-3 py-2 bg-green-600 text-white rounded">Add</button>
          </div>
        </div>

        <div id="financeList" class="space-y-2"></div>
      </section>

      <!-- Hostels -->
      <section id="panel-hostels" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Hostels & Rooms</h2>
          <div class="flex gap-2">
            <input id="hostel_name" placeholder="Hostel name" class="border p-2 rounded" />
            <button id="btnAddHostel" class="px-3 py-2 bg-green-600 text-white rounded">Add Hostel</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
          <div>
            <h4 class="font-semibold">Add Room</h4>
            <select id="hostel_select_for_room" class="border p-2 rounded w-full mb-2"></select>
            <input id="room_no" placeholder="Room no" class="border p-2 rounded w-full mb-2"/>
            <input id="room_capacity" type="number" placeholder="Capacity" class="border p-2 rounded w-full mb-2"/>
            <input id="room_price" type="number" placeholder="Price" class="border p-2 rounded w-full mb-2"/>
            <button id="btnAddRoom" class="px-3 py-2 bg-blue-600 text-white rounded w-full">Add Room</button>
          </div>
          <div class="md:col-span-2">
            <h4 class="font-semibold">Hostels List</h4>
            <div id="hostelsList" class="space-y-2 mt-2"></div>
          </div>
        </div>
      </section>

      <!-- Announcements -->
      <section id="panel-announcements" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Announcements</h2>
          <div class="flex gap-2">
            <input id="ann_title" placeholder="Title" class="border p-2 rounded" />
            <button id="btnPostAnnouncement" class="px-3 py-2 bg-green-600 text-white rounded">Post</button>
          </div>
        </div>
        <textarea id="ann_body" class="w-full h-24 border p-2 rounded mb-3" placeholder="Message"></textarea>
        <div id="announcementsList" class="space-y-2"></div>
      </section>

      <!-- Clearance -->
      <section id="panel-clearance" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Clearance</h2>
          <div>
            <select id="clearance_student_select" class="border p-2 rounded"></select>
            <button id="btnLoadClearance" class="px-3 py-2 bg-blue-600 text-white rounded">Load</button>
          </div>
        </div>

        <div id="clearanceEditor" class="space-y-2"></div>
      </section>

      <!-- Graduation -->
      <section id="panel-graduation" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Graduation Requests</h2>
          <button id="btnReloadGrad" class="px-3 py-2 bg-slate-200 rounded">Reload</button>
        </div>
        <div id="graduationList" class="space-y-3"></div>
      </section>
    </main>
  </div>

  <footer class="text-center text-sm text-slate-500 p-4">© 2025 Prince Alex University</footer>
</div>

<!-- Firebase modular imports (v11) and app logic -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
  createUserWithEmailAndPassword, updatePassword
} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, collection,
  query, where, orderBy, serverTimestamp, limit, runTransaction
} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';
const { jsPDF } = window.jspdf;

/* ---------- Firebase config (same as student dashboard) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
  authDomain: "universityweb-19e1e.firebaseapp.com",
  projectId: "universityweb-19e1e",
  storageBucket: "universityweb-19e1e.appspot.com",
  messagingSenderId: "401942926589",
  appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------- Small helpers ---------- */
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
function toast(msg, type='info'){ const el = document.createElement('div'); el.textContent = msg; el.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded ${type==='error'?'bg-red-600 text-white':'bg-slate-800 text-white'}`; document.body.appendChild(el); setTimeout(()=>el.remove(),2200); }

/* ---------- UI wiring ---------- */
const loginView = $('#loginView');
const appView = $('#appView');
const adminEmailEl = $('#adminEmail');

$('#btnSignIn').addEventListener('click', async ()=> {
  $('#loginMsg').textContent = '';
  const email = $('#loginEmail').value.trim();
  const pw = $('#loginPassword').value;
  if(!email || !pw){ $('#loginMsg').textContent = 'Enter email & password'; return; }
  try{
    await signInWithEmailAndPassword(auth, email, pw);
    // onAuthStateChanged checks admin doc and will show dashboard
  }catch(e){ $('#loginMsg').textContent = e.message || e.code; }
});

// Demo data loader (optional quick seed)
$('#btnDemo').addEventListener('click', async ()=> {
  if(!confirm('Create small demo seed (courses + one student + one announcement)?')) return;
  try{
    await addDoc(collection(db,'courses'), { code:'CSC101', title:'Intro to Computing', credits:3, year:1, semester:1 });
    const s = await addDoc(collection(db,'students'), { name:'Demo Student', email:'demo@student.com', regNo:'DEM/001/25', createdAt:new Date().toISOString(), initialized:true });
    await addDoc(collection(db,'announcements'), { title:'Welcome', body:'Demo announcement', createdAt: serverTimestamp() });
    toast('Demo data seeded');
  }catch(e){ toast('Demo seed failed: '+e.message,'error'); }
});

/* ---------- Auth state + admin check ---------- */
onAuthStateChanged(auth, async (user) => {
  if(!user){ // show login
    loginView.classList.remove('hidden');
    appView.classList.add('hidden');
    return;
  }
  // ensure admin doc
  try{
    const admSnap = await getDoc(doc(db,'admins', user.uid));
    if(!admSnap.exists() || admSnap.data().isAdmin !== true){
      toast('Access denied — not an admin','error');
      await signOut(auth);
      return;
    }
  }catch(e){ toast('Admin check failed: '+e.message,'error'); await signOut(auth); return; }

  // show dashboard
  loginView.classList.add('hidden');
  appView.classList.remove('hidden');
  adminEmailEl.textContent = user.email || user.uid;
  // initial loads
  activateNavigation();
  await loadOverview();
  await loadAllLists(); // loads students, courses, announcements, hostels, selects
});

/* sign out */
$('#btnSignOut').addEventListener('click', async ()=> { await signOut(auth); });

/* hamburger for mobile */
$('#hamburger').addEventListener('click', ()=> $('#sidebar').classList.toggle('hidden'));

/* navigation */
function activateNavigation(){
  $$('.navBtn').forEach(btn => {
    btn.addEventListener('click', (e)=>{
      const panel = btn.dataset.panel;
      $$('main section').forEach(s => s.classList.add('hidden'));
      $('#' + panel).classList.remove('hidden');
    });
  });
}

/* ---------- Load overview ---------- */
async function loadOverview(){
  const sSnap = await getDocs(collection(db,'students'));
  const cSnap = await getDocs(collection(db,'courses'));
  const hSnap = await getDocs(collection(db,'hostels'));
  $('#statStudents').textContent = sSnap.size;
  $('#statCourses').textContent = cSnap.size;
  $('#statHostels').textContent = hSnap.size;
}

/* ---------- Load many lists (students, courses, announcements, hostels) ---------- */
async function loadAllLists(){
  await loadStudentsList();
  await loadCoursesList();
  await loadAnnouncementsList();
  await loadHostelsList();
  await populateStudentSelects();
  await populateCourseSelects();
}

/* =========================
   STUDENTS: create / read / update / delete
   collection: students/{uid}
   + create auth user (client-side) — see note
   ========================= */
async function loadStudentsList(){
  const container = $('#studentsList');
  container.innerHTML = '<div class="text-slate-500 p-2">Loading students...</div>';
  const snaps = await getDocs(collection(db,'students'));
  container.innerHTML = '';
  if(snaps.empty){ container.innerHTML = '<div class="text-slate-500 p-2">No students found.</div>'; return; }
  snaps.forEach(docSnap=>{
    const d = docSnap.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded flex justify-between items-center';
    el.innerHTML = `<div><div class="font-semibold">${d.name || '—'}</div><div class="text-xs text-slate-600">${d.regNo || ''} • ${d.email || ''}</div></div>
      <div class="flex gap-2">
        <button data-uid="${docSnap.id}" class="btnEditStudent px-2 py-1 border rounded text-sm">Edit</button>
        <button data-uid="${docSnap.id}" class="btnDeleteStudent px-2 py-1 border rounded text-sm">Delete</button>
      </div>`;
    container.appendChild(el);
  });
  // attach handlers
  $$('.btnEditStudent').forEach(b => b.addEventListener('click', async (e)=>{
    const uid = e.currentTarget.dataset.uid;
    openEditStudent(uid);
  }));
  $$('.btnDeleteStudent').forEach(b => b.addEventListener('click', async (e)=>{
    const uid = e.currentTarget.dataset.uid;
    if(!confirm('Delete student Firestore document? This will NOT delete the Firebase Auth user.')) return;
    await deleteDoc(doc(db,'students',uid));
    toast('Student doc deleted');
    await loadStudentsList();
    await populateStudentSelects();
  }));
}

/* Add student form submit (create Auth user client-side) */
$('#formAddStudent').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = $('#new_name').value.trim();
  const email = $('#new_email').value.trim();
  const regNo = $('#new_regNo').value.trim();
  let tempPass = $('#new_tempPassword').value || 'changeme123';
  if(!name || !email){ toast('Name and email required','error'); return; }
  try{
    // Create user client-side (this will sign the browser in as the new user)
    const cred = await createUserWithEmailAndPassword(auth, email, tempPass);
    const newUid = cred.user.uid;
    // Create students/{uid} doc
    await setDoc(doc(db,'students', newUid), {
      name, email, regNo, createdAt: new Date().toISOString(), initialized: true
    });
    toast('Student created. You will be signed out and must sign-in again as admin.');
    // SIGNED IN as new user now. Sign out and prompt admin to re-login.
    await signOut(auth);
    // Optional: show login view again and present instructions
    loginView.classList.remove('hidden'); appView.classList.add('hidden');
    alert('Created user '+email+'. Please sign back in as admin.');
  }catch(err){
    toast('Failed to create student: '+(err.message||err.code),'error');
  }
});

/* Student edit flow */
let editingStudentUid = null;
async function openEditStudent(uid){
  const snap = await getDoc(doc(db,'students',uid));
  if(!snap.exists()){ toast('Student not found','error'); return; }
  const data = snap.data();
  editingStudentUid = uid;
  $('#studentEditor').classList.remove('hidden');
  $('#edit_name').value = data.name || '';
  $('#edit_email').value = data.email || '';
  $('#edit_regNo').value = data.regNo || '';
  $('#edit_programme').value = data.programme || '';
  $('#edit_campus').value = data.campus || '';
  $('#edit_year').value = data.yearOfStudy || '';
  $('#edit_address').value = data.address || '';
  // handlers
  $('#btnSaveStudent').onclick = async ()=>{
    const upd = {
      name: $('#edit_name').value.trim(),
      regNo: $('#edit_regNo').value.trim(),
      programme: $('#edit_programme').value.trim(),
      campus: $('#edit_campus').value.trim(),
      yearOfStudy: Number($('#edit_year').value||0),
      address: $('#edit_address').value.trim()
    };
    await updateDoc(doc(db,'students', editingStudentUid), upd);
    toast('Student updated');
    $('#studentEditor').classList.add('hidden');
    await loadStudentsList();
    await populateStudentSelects();
  };
  $('#btnCancelEditStudent').onclick = ()=> { $('#studentEditor').classList.add('hidden'); editingStudentUid = null; };
  $('#btnDeleteStudent').onclick = async ()=>{
    if(!confirm('Delete student doc?')) return;
    await deleteDoc(doc(db,'students', editingStudentUid));
    toast('Student deleted (doc)');
    $('#studentEditor').classList.add('hidden'); editingStudentUid = null;
    await loadStudentsList(); await populateStudentSelects();
  };
}

$('#btnClearStudentForm').addEventListener('click', ()=> {
  $('#new_name').value=''; $('#new_email').value=''; $('#new_regNo').value=''; $('#new_tempPassword').value='changeme123';
});

/* =========================
   COURSES CRUD
   collection: courses
   ========================= */
$('#btnAddCourse').addEventListener('click', async (e)=>{
  e.preventDefault();
  const code = $('#c_code').value.trim(); const title = $('#c_title').value.trim(); const credits = Number($('#c_credits').value||0);
  if(!code || !title){ toast('Code & title required','error'); return; }
  await addDoc(collection(db,'courses'), { code, title, credits, createdAt: serverTimestamp() });
  toast('Course added');
  $('#c_code').value=''; $('#c_title').value=''; $('#c_credits').value='';
  await loadCoursesList();
  await populateCourseSelects();
});

async function loadCoursesList(){
  const container = $('#coursesList'); container.innerHTML = '<div class="text-slate-500 p-2">Loading courses...</div>';
  const snaps = await getDocs(collection(db,'courses'));
  container.innerHTML = '';
  if(snaps.empty){ container.innerHTML = '<div class="text-slate-500 p-2">No courses.</div>'; return; }
  snaps.forEach(snap=>{
    const d = snap.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded flex justify-between items-center';
    el.innerHTML = `<div><div class="font-semibold">${d.code} — ${d.title}</div><div class="text-xs text-slate-600">${d.credits||0} credits</div></div>
      <div class="flex gap-2">
        <button data-id="${snap.id}" class="editCourse px-2 py-1 border rounded text-sm">Edit</button>
        <button data-id="${snap.id}" class="delCourse px-2 py-1 border rounded text-sm">Delete</button>
      </div>`;
    container.appendChild(el);
  });
  // attach handlers
  $$('.delCourse').forEach(b => b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    if(!confirm('Delete course?')) return;
    await deleteDoc(doc(db,'courses',id));
    toast('Course deleted');
    await loadCoursesList();
    await populateCourseSelects();
  }));
  $$('.editCourse').forEach(b => b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    const sSnap = await getDoc(doc(db,'courses',id));
    const data = sSnap.data();
    $('#c_code').value = data.code || ''; $('#c_title').value = data.title || ''; $('#c_credits').value = data.credits || '';
    $('#btnAddCourse').textContent = 'Update Course';
    $('#btnAddCourse').onclick = async (ev)=>{
      ev.preventDefault();
      await updateDoc(doc(db,'courses',id), { code: $('#c_code').value.trim(), title: $('#c_title').value.trim(), credits: Number($('#c_credits').value||0) });
      toast('Course updated');
      $('#btnAddCourse').textContent = 'Add course';
      $('#c_code').value=''; $('#c_title').value=''; $('#c_credits').value='';
      await loadCoursesList(); await populateCourseSelects();
      // restore handler
      $('#btnAddCourse').onclick = async (ev2) => { ev2.preventDefault(); /* handled earlier */ };
    };
  }));
}

/* =========================
   TIMETABLE (per student)
   doc: timetable/{uid} => { schedule: [...] }
   ========================= */
$('#btnLoadTT').addEventListener('click', async ()=>{
  const uid = $('#tt_student_select').value;
  if(!uid){ toast('Pick a student','error'); return; }
  const snap = await getDoc(doc(db,'timetable',uid));
  $('#tt_editor').value = JSON.stringify(snap.exists()? snap.data().schedule || [] : [], null, 2);
  $('#timetablePreview').innerHTML = '<div class="text-slate-500 p-2">Loaded timetable (edit JSON to change)</div>';
});
$('#btnSaveTT').addEventListener('click', async ()=>{
  const uid = $('#tt_student_select').value;
  if(!uid){ toast('Pick a student','error'); return; }
  let parsed;
  try{ parsed = JSON.parse($('#tt_editor').value); if(!Array.isArray(parsed)) throw new Error('Must be array'); }catch(e){ toast('Invalid JSON: '+e.message,'error'); return; }
  await setDoc(doc(db,'timetable',uid), { schedule: parsed, updatedAt: serverTimestamp() });
  toast('Timetable saved');
});

/* =========================
   GRADES
   structure: grades/{studentUid}/results/{courseId}
   ========================= */
$('#btnAddGrade').addEventListener('click', async ()=>{
  const sid = $('#grades_student_select').value; const cid = $('#grades_course_select').value; const grade = $('#grades_grade_input').value.trim();
  if(!sid || !cid || !grade){ toast('Select student, course and grade','error'); return; }
  const courseSnap = await getDoc(doc(db,'courses',cid));
  const title = courseSnap.exists() ? courseSnap.data().title : '';
  // mapping simple grade=>points
  const gpaMap = { 'A+':4.0,'A':4.0,'A-':3.7,'B+':3.3,'B':3.0,'B-':2.7,'C+':2.3,'C':2.0,'D':1.0,'E':0.7,'F':0.0 };
  const points = gpaMap[grade] ?? 0;
  await setDoc(doc(db,'grades',sid,'results',cid), { code: cid, title, grade, gpaPoints: points, savedAt: serverTimestamp() });
  toast('Grade saved');
  await loadGradesForStudent(sid);
});

async function loadGradesForStudent(sid){
  const out = $('#gradesList'); out.innerHTML = '';
  if(!sid){ out.innerHTML = '<div class="text-slate-500 p-2">Select student</div>'; return; }
  const snaps = await getDocs(collection(db,'grades',sid,'results'));
  if(snaps.empty){ out.innerHTML = '<div class="text-slate-500 p-2">No grades</div>'; return; }
  snaps.forEach(s=>{
    const r = s.data();
    out.innerHTML += `<div class="p-2 border rounded flex justify-between items-center"><div>${r.code} • ${r.title || ''} • ${r.grade}</div><div><button class="delGrade px-2 py-1 border rounded text-sm" data-id="${s.id}" data-sid="${sid}">Delete</button></div></div>`;
  });
  $$('.delGrade').forEach(b => b.addEventListener('click', async (e)=> {
    const id = e.currentTarget.dataset.id, sid = e.currentTarget.dataset.sid;
    if(!confirm('Delete grade?')) return;
    await deleteDoc(doc(db,'grades',sid,'results',id));
    toast('Grade deleted');
    loadGradesForStudent(sid);
  }));
}

/* reload grades when student selection changes */
$('#grades_student_select').addEventListener('change', ()=> {
  const sid = $('#grades_student_select').value;
  loadGradesForStudent(sid);
});

/* =========================
   FINANCE
   structure: finance/{studentUid}/transactions/{txId}
              finance/{studentUid}/balance/summary (doc id 'summary')
   ========================= */
$('#btnAddTransaction').addEventListener('click', async ()=>{
  const sid = $('#finance_student_select').value; const amount = Number($('#finance_amount').value||0); const type = $('#finance_type').value;
  if(!sid || !amount){ toast('Pick student and amount','error'); return; }
  await addDoc(collection(db,'finance', sid, 'transactions'), { amount, type, createdAt: serverTimestamp(), createdBy: adminEmailEl.textContent });
  // update summary
  const sumRef = doc(db,'finance', sid, 'balance', 'summary');
  await runTransaction(db, async tx => {
    const snap = await tx.get(sumRef);
    const cur = snap.exists() ? snap.data() : { amount:0, paid:0 };
    if(type === 'payment') tx.set(sumRef, { amount: cur.amount || 0, paid: (cur.paid || 0) + amount }, { merge:true });
    else tx.set(sumRef, { amount: (cur.amount || 0) + amount, paid: cur.paid || 0 }, { merge:true });
  });
  toast('Transaction recorded');
  await loadFinanceForStudent(sid);
});

/* load finance list */
async function loadFinanceForStudent(sid){
  const out = $('#financeList'); out.innerHTML = '';
  if(!sid){ out.innerHTML = '<div class="text-slate-500 p-2">Select student</div>'; return; }
  const txs = await getDocs(collection(db,'finance',sid,'transactions'));
  if(txs.empty){ out.innerHTML = '<div class="text-slate-500 p-2">No transactions</div>'; return; }
  txs.forEach(t=>{
    const d = t.data();
    out.innerHTML += `<div class="p-2 border rounded">${d.type} • KES ${Number(d.amount).toLocaleString()} • ${d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString() : ''}</div>`;
  });
}

/* when student select changes in finance */
$('#finance_student_select').addEventListener('change', ()=> {
  loadFinanceForStudent($('#finance_student_select').value);
});

/* =========================
   HOSTELS & ROOMS
   hostels/{hid}, hostels/{hid}/rooms/{rid}
   ========================= */
$('#btnAddHostel').addEventListener('click', async ()=>{
  const name = $('#hostel_name').value.trim();
  if(!name){ toast('Provide hostel name','error'); return; }
  await addDoc(collection(db,'hostels'), { name, description:'', availableCount:0, createdAt: serverTimestamp() });
  $('#hostel_name').value='';
  toast('Hostel added');
  await loadHostelsList();
  await populateHostelSelects();
});

$('#btnAddRoom').addEventListener('click', async ()=>{
  const hid = $('#hostel_select_for_room').value;
  const roomNo = $('#room_no').value.trim(); const cap = Number($('#room_capacity').value||1); const price = Number($('#room_price').value||0);
  if(!hid || !roomNo){ toast('Pick hostel and room no','error'); return; }
  await addDoc(collection(db,'hostels', hid, 'rooms'), { roomNo, capacity: cap, price, status:'available', createdAt: serverTimestamp() });
  // increment availableCount
  await runTransaction(db, async tx => {
    const hRef = doc(db,'hostels', hid);
    const hSnap = await tx.get(hRef);
    tx.update(hRef, { availableCount: (hSnap.data().availableCount || 0) + 1 });
  });
  toast('Room added');
  $('#room_no').value=''; $('#room_capacity').value=''; $('#room_price').value='';
  await loadHostelsList(); await populateHostelSelects();
});

async function loadHostelsList(){
  const out = $('#hostelsList'); out.innerHTML = '<div class="text-slate-500 p-2">Loading hostels...</div>';
  const snap = await getDocs(collection(db,'hostels'));
  out.innerHTML = '';
  if(snap.empty){ out.innerHTML = '<div class="text-slate-500 p-2">No hostels</div>'; return; }
  snap.forEach(h=>{
    const d = h.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded';
    el.innerHTML = `<div class="flex justify-between items-start"><div><div class="font-semibold">${d.name}</div><div class="text-xs text-slate-600">Available: ${d.availableCount||0}</div></div><div class="flex gap-2"><button data-id="${h.id}" class="viewRooms px-2 py-1 border rounded">Rooms</button><button data-id="${h.id}" class="delHostel px-2 py-1 border rounded">Delete</button></div></div><div id="rooms-${h.id}" class="mt-2"></div>`;
    out.appendChild(el);
  });
  // handlers
  $$('.delHostel').forEach(b => b.addEventListener('click', async (e)=>{
    const hid = e.currentTarget.dataset.id;
    if(!confirm('Delete hostel doc? This will not delete rooms subcollection automatically.')) return;
    await deleteDoc(doc(db,'hostels',hid));
    toast('Hostel removed');
    await loadHostelsList(); await populateHostelSelects();
  }));
  $$('.viewRooms').forEach(b => b.addEventListener('click', async (e)=>{
    const hid = e.currentTarget.dataset.id;
    const roomsOut = $('#rooms-'+hid); roomsOut.innerHTML = '<div class="text-slate-500 p-2">Loading rooms...</div>';
    const rSnap = await getDocs(collection(db,'hostels',hid,'rooms'));
    roomsOut.innerHTML = '';
    if(rSnap.empty){ roomsOut.innerHTML = '<div class="text-slate-500 p-2">No rooms</div>'; return; }
    rSnap.forEach(r=>{
      const rr = r.data();
      roomsOut.innerHTML += `<div class="p-2 border rounded mb-2 flex justify-between items-center"><div><strong>Room ${rr.roomNo}</strong><div class="text-xs text-slate-600">Cap ${rr.capacity} • KES ${rr.price}</div></div><div class="flex gap-2"><button data-h="${hid}" data-r="${r.id}" class="toggleRoom px-2 py-1 border rounded">${rr.status==='available'?'Mark booked':'Mark available'}</button><button data-h="${hid}" data-r="${r.id}" class="delRoom px-2 py-1 border rounded">Delete</button></div></div>`;
    });
    // attach inside handlers
    $$('.toggleRoom').forEach(btn => btn.addEventListener('click', async (ev)=>{
      const hid = ev.currentTarget.dataset.h; const rid = ev.currentTarget.dataset.r;
      const rRef = doc(db,'hostels',hid,'rooms',rid); const rSnap = await getDoc(rRef);
      const newStatus = rSnap.data().status === 'available' ? 'booked' : 'available';
      await updateDoc(rRef, { status: newStatus });
      // update availableCount
      const hRef = doc(db,'hostels',hid);
      await runTransaction(db, async tx=>{
        const hS = await tx.get(hRef);
        const cur = hS.data().availableCount || 0;
        await tx.update(hRef, { availableCount: newStatus==='available' ? cur+1 : Math.max(0, cur-1) });
      });
      toast('Room status toggled');
      await loadHostelsList(); await populateHostelSelects();
    }));
    $$('.delRoom').forEach(btn => btn.addEventListener('click', async (ev)=>{
      const hid = ev.currentTarget.dataset.h; const rid = ev.currentTarget.dataset.r;
      if(!confirm('Delete room?')) return;
      await deleteDoc(doc(db,'hostels',hid,'rooms',rid));
      toast('Room deleted');
      await loadHostelsList(); await populateHostelSelects();
    }));
  }));
}

/* =========================
   ANNOUNCEMENTS
   collection: announcements
   ========================= */
$('#btnPostAnnouncement').addEventListener('click', async ()=>{
  const title = $('#ann_title').value.trim(); const body = $('#ann_body').value.trim();
  if(!title || !body){ toast('Title and message required','error'); return; }
  await addDoc(collection(db,'announcements'), { title, body, createdAt: serverTimestamp(), author: adminEmailEl.textContent });
  $('#ann_title').value=''; $('#ann_body').value='';
  toast('Announcement posted');
  await loadAnnouncementsList();
});

async function loadAnnouncementsList(){
  const out = $('#announcementsList'); out.innerHTML = '<div class="text-slate-500 p-2">Loading announcements...</div>';
  const snaps = await getDocs(query(collection(db,'announcements'), orderBy('createdAt','desc')));
  out.innerHTML = '';
  if(snaps.empty){ out.innerHTML = '<div class="text-slate-500 p-2">No announcements</div>'; return; }
  snaps.forEach(snap=>{
    const d = snap.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded';
    el.innerHTML = `<div class="flex justify-between items-start"><div><strong>${d.title}</strong><div class="text-xs text-slate-500">${d.author||''} • ${d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : ''}</div></div><div><button data-id="${snap.id}" class="delAnn px-2 py-1 border rounded">Delete</button></div></div><div class="mt-2 text-sm">${d.body}</div>`;
    out.appendChild(el);
  });
  $$('.delAnn').forEach(b => b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    if(!confirm('Delete announcement?')) return;
    await deleteDoc(doc(db,'announcements',id));
    toast('Deleted');
    await loadAnnouncementsList();
  }));
}

/* =========================
   CLEARANCE
   doc: clearance/{studentUid} => { library, finance, hostel, department }
   ========================= */
$('#btnLoadClearance').addEventListener('click', async ()=>{
  const sid = $('#clearance_student_select').value;
  if(!sid){ toast('Pick student','error'); return; }
  const snap = await getDoc(doc(db,'clearance',sid));
  const out = $('#clearanceEditor'); out.innerHTML = '';
  const data = snap.exists() ? snap.data() : { library:'pending', finance:'pending', hostel:'pending', department:'pending' };
  out.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-2">
    <label class="small">Library <input id="clear_lib" value="${data.library||'pending'}" class="border p-2 rounded"/></label>
    <label class="small">Finance <input id="clear_fin" value="${data.finance||'pending'}" class="border p-2 rounded"/></label>
    <label class="small">Hostel <input id="clear_hos" value="${data.hostel||'pending'}" class="border p-2 rounded"/></label>
    <label class="small">Department <input id="clear_dept" value="${data.department||'pending'}" class="border p-2 rounded"/></label>
  </div>
  <div class="mt-3"><button id="btnSaveClearance" class="px-3 py-2 bg-blue-600 text-white rounded">Save clearance</button></div>`;
  $('#btnSaveClearance').onclick = async ()=> {
    await setDoc(doc(db,'clearance',sid), { library: $('#clear_lib').value, finance: $('#clear_fin').value, hostel: $('#clear_hos').value, department: $('#clear_dept').value }, { merge:true });
    toast('Clearance saved'); loadClearanceSelectIfNeeded();
  };
});

/* =========================
   GRADUATION REQUESTS
   collection: graduationRequests (doc id = studentUid or auto id)
   ========================= */
$('#btnReloadGrad').addEventListener('click', async ()=> loadGraduationRequests());
async function loadGraduationRequests(){
  const out = $('#graduationList'); out.innerHTML = '<div class="text-slate-500 p-2">Loading requests...</div>';
  const snaps = await getDocs(collection(db,'graduationRequests'));
  out.innerHTML = '';
  if(snaps.empty){ out.innerHTML = '<div class="text-slate-500 p-2">No requests</div>'; return; }
  snaps.forEach(snap=>{
    const d = snap.data();
    out.innerHTML += `<div class="p-3 border rounded flex justify-between items-start"><div><div class="font-semibold">${snap.id}</div><div class="text-xs text-slate-600">${d.status||'pending'} • ${d.requestedAt?.toDate? d.requestedAt.toDate().toLocaleString() : ''}</div><div class="mt-2">${d.reason||''}</div></div><div class="flex gap-2"><button data-id="${snap.id}" data-act="approve" class="px-2 py-1 bg-green-600 text-white rounded">Approve</button><button data-id="${snap.id}" data-act="reject" class="px-2 py-1 bg-red-600 text-white rounded">Reject</button></div></div>`;
  });
  $$('[data-act="approve"]').forEach(b=> b.addEventListener('click', async (e)=> { const id=e.currentTarget.dataset.id; await updateDoc(doc(db,'graduationRequests',id), { status:'approved', decidedAt: serverTimestamp() }); toast('Approved'); loadGraduationRequests(); }));
  $$('[data-act="reject"]').forEach(b=> b.addEventListener('click', async (e)=> { const id=e.currentTarget.dataset.id; await updateDoc(doc(db,'graduationRequests',id), { status:'rejected', decidedAt: serverTimestamp() }); toast('Rejected'); loadGraduationRequests(); }));
}

/* =========================
   Utilities: populate selects
   ========================= */
async function populateStudentSelects(){
  const sels = ['#tt_student_select', '#grades_student_select', '#finance_student_select', '#clearance_student_select'];
  const lists = await getDocs(collection(db,'students'));
  sels.forEach(sel => { const el = $(sel); el.innerHTML = '<option value=\"\">Select student</option>'; lists.forEach(snap => { const d = snap.data(); el.insertAdjacentHTML('beforeend', `<option value=\"${snap.id}\">${d.name || snap.id} (${d.regNo || ''})</option>`); }); });
}
async function populateCourseSelects(){
  const sel = $('#grades_course_select'); sel.innerHTML = '<option value=\"\">Select course</option>';
  const snap = await getDocs(collection(db,'courses'));
  snap.forEach(s => sel.insertAdjacentHTML('beforeend', `<option value=\"${s.id}\">${s.data().code || s.id} — ${s.data().title||''}</option>`));
}
async function populateHostelSelects(){
  const el = $('#hostel_select_for_room'); el.innerHTML = '<option value=\"\">Select hostel</option>';
  const snap = await getDocs(collection(db,'hostels'));
  snap.forEach(s => el.insertAdjacentHTML('beforeend', `<option value=\"${s.id}\">${s.data().name || s.id}</option>`));
}

/* small wrappers for convenience */
async function loadCoursesList(){ await loadCoursesListInner(); }
async function loadCoursesListInner(){ /* already implemented above by same name, but ensure call works */ 
  // previous function defined earlier; nothing to do
}
async function loadHostelsList(){ await loadHostelsListInner(); }
async function loadHostelsListInner(){ /* implemented above */ }

/* wrapper to call all populate routines */
async function loadHostelsListAndSelects(){
  await loadHostelsList();
  await populateHostelSelects();
}

/* initial load helper used in onAuthStateChanged */
async function loadAllLists(){
  await loadStudentsList();
  await loadCoursesList();
  await loadAnnouncementsList();
  await loadHostelsList();
  await populateStudentSelects();
  await populateCourseSelects();
  await populateHostelSelects();
}

/* Because of function hoisting issues, ensure these functions exist for calls above */
async function loadCoursesList(){ 
  // implement a simple call to update courses list area by reusing earlier logic
  const container = $('#coursesList'); container.innerHTML = '<div class=\"text-slate-500 p-2\">Loading courses...</div>';
  const snaps = await getDocs(collection(db,'courses'));
  container.innerHTML = '';
  if(snaps.empty){ container.innerHTML = '<div class=\"text-slate-500 p-2\">No courses.</div>'; return; }
  snaps.forEach(snap=>{
    const d = snap.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded flex justify-between items-center';
    el.innerHTML = `<div><div class=\"font-semibold\">${d.code} — ${d.title}</div><div class=\"text-xs text-slate-600\">${d.credits||0} credits</div></div>
      <div class=\"flex gap-2\">
        <button data-id=\"${snap.id}\" class=\"editCourse px-2 py-1 border rounded text-sm\">Edit</button>
        <button data-id=\"${snap.id}\" class=\"delCourse px-2 py-1 border rounded text-sm\">Delete</button>
      </div>`;
    container.appendChild(el);
  });
  $$('.delCourse').forEach(b => b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    if(!confirm('Delete course?')) return;
    await deleteDoc(doc(db,'courses',id));
    toast('Course deleted'); await loadCoursesList(); await populateCourseSelects();
  }));
  $$('.editCourse').forEach(b => b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    const sSnap = await getDoc(doc(db,'courses',id));
    const data = sSnap.data();
    $('#c_code').value = data.code || ''; $('#c_title').value = data.title || ''; $('#c_credits').value = data.credits || '';
    $('#btnAddCourse').textContent = 'Update Course';
    $('#btnAddCourse').onclick = async (ev)=>{
      ev.preventDefault();
      await updateDoc(doc(db,'courses',id), { code: $('#c_code').value.trim(), title: $('#c_title').value.trim(), credits: Number($('#c_credits').value||0) });
      toast('Course updated'); $('#btnAddCourse').textContent = 'Add course'; $('#c_code').value=''; $('#c_title').value=''; $('#c_credits').value=''; await loadCoursesList(); await populateCourseSelects();
      $('#btnAddCourse').onclick = null;
    };
  }));
}

/* hostels load inner implementation */
async function loadHostelsListInner(){
  const out = $('#hostelsList'); out.innerHTML = '<div class="text-slate-500 p-2">Loading hostels...</div>';
  const snap = await getDocs(collection(db,'hostels'));
  out.innerHTML = '';
  if(snap.empty){ out.innerHTML = '<div class="text-slate-500 p-2">No hostels</div>'; return; }
  snap.forEach(h=>{
    const d = h.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded';
    el.innerHTML = `<div class="flex justify-between items-start"><div><div class="font-semibold">${d.name}</div><div class="text-xs text-slate-600">Available: ${d.availableCount||0}</div></div><div class="flex gap-2"><button data-id="${h.id}" class="viewRooms px-2 py-1 border rounded">Rooms</button><button data-id="${h.id}" class="delHostel px-2 py-1 border rounded">Delete</button></div></div><div id="rooms-${h.id}" class="mt-2"></div>`;
    out.appendChild(el);
  });
  // re-attach handlers as earlier...
  $$('.delHostel').forEach(b => b.addEventListener('click', async (e)=>{
    const hid = e.currentTarget.dataset.id;
    if(!confirm('Delete hostel doc?')) return;
    await deleteDoc(doc(db,'hostels',hid));
    toast('Hostel removed'); await loadHostelsListInner(); await populateHostelSelects();
  }));
  $$('.viewRooms').forEach(b => b.addEventListener('click', async (e)=>{
    const hid = e.currentTarget.dataset.id;
    const roomsOut = $('#rooms-'+hid); roomsOut.innerHTML = '<div class="text-slate-500 p-2">Loading rooms...</div>';
    const rSnap = await getDocs(collection(db,'hostels',hid,'rooms'));
    roomsOut.innerHTML = '';
    if(rSnap.empty){ roomsOut.innerHTML = '<div class="text-slate-500 p-2">No rooms</div>'; return; }
    rSnap.forEach(r=>{
      const rr = r.data();
      roomsOut.innerHTML += `<div class="p-2 border rounded mb-2 flex justify-between items-center"><div><strong>Room ${rr.roomNo}</strong><div class="text-xs text-slate-600">Cap ${rr.capacity} • KES ${rr.price}</div></div><div class="flex gap-2"><button data-h="${hid}" data-r="${r.id}" class="toggleRoom px-2 py-1 border rounded">${rr.status==='available'?'Mark booked':'Mark available'}</button><button data-h="${hid}" data-r="${r.id}" class="delRoom px-2 py-1 border rounded">Delete</button></div></div>`;
    });
    $$('.toggleRoom').forEach(btn => btn.addEventListener('click', async (ev)=>{
      const hid = ev.currentTarget.dataset.h; const rid = ev.currentTarget.dataset.r;
      const rRef = doc(db,'hostels',hid,'rooms',rid); const rSnap = await getDoc(rRef);
      const newStatus = rSnap.data().status === 'available' ? 'booked' : 'available';
      await updateDoc(rRef, { status: newStatus });
      // adjust count
      const hRef = doc(db,'hostels',hid);
      await runTransaction(db, async tx => {
        const hS = await tx.get(hRef);
        const cur = hS.data().availableCount || 0;
        tx.update(hRef, { availableCount: newStatus==='available' ? cur+1 : Math.max(0, cur-1) });
      });
      toast('Room toggled'); await loadHostelsListInner(); await populateHostelSelects();
    }));
    $$('.delRoom').forEach(btn => btn.addEventListener('click', async (ev)=>{
      const hid = ev.currentTarget.dataset.h; const rid = ev.currentTarget.dataset.r;
      if(!confirm('Delete room?')) return;
      await deleteDoc(doc(db,'hostels',hid,'rooms',rid));
      toast('Room deleted'); await loadHostelsListInner(); await populateHostelSelects();
    }));
  }));
}

/* ensure announcements load exists */
async function loadAnnouncementsList(){
  const out = $('#announcementsList'); out.innerHTML = '<div class="text-slate-500 p-2">Loading announcements...</div>';
  const snaps = await getDocs(collection(db,'announcements'));
  out.innerHTML = '';
  if(snaps.empty){ out.innerHTML = '<div class="text-slate-500 p-2">No announcements</div>'; return; }
  snaps.forEach(snap=>{
    const d = snap.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded flex justify-between items-start';
    el.innerHTML = `<div><strong>${d.title}</strong><div class="text-xs text-slate-500">${d.author || ''}</div><div class="mt-2">${d.body}</div></div><div><button data-id="${snap.id}" class="delAnn px-2 py-1 border rounded">Delete</button></div>`;
    out.appendChild(el);
  });
  $$('.delAnn').forEach(b => b.addEventListener('click', async (e)=>{
    const id = e.currentTarget.dataset.id;
    if(!confirm('Delete announcement?')) return;
    await deleteDoc(doc(db,'announcements',id));
    toast('Deleted'); await loadAnnouncementsList();
  }));
}

/* =========================
   Utility: quick reload buttons
   ========================= */
$('#btnReloadStudents').addEventListener('click', ()=> loadStudentsList());
$('#btnReloadCourses').addEventListener('click', ()=> loadCoursesList());
$('#btnReloadGrad').addEventListener('click', ()=> loadGraduationRequests());

/* populate selects at start (if user already authenticated) */
onAuthStateChanged(auth, async (u)=>{
  if(u){
    await populateStudentSelects(); await populateCourseSelects(); await populateHostelSelects();
  }
});

</script>
</body>
</html>
