<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- jsPDF for Transcript Download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable plugin for easy table generation in PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; }
    .btn-red { background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
    .btn-red:hover { background: #bb2d3b; }
    #sidebar a { padding: 0.75rem; border-radius: 4px; display: block; }
    #sidebar a:hover { background-color: #e9ecef; }
    .dashboard-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 1rem; }

    /* Fixed Header */
    #mainHeader {
        position: sticky;
        top: 0;
        width: 100%;
        z-index: 50; /* Ensure it stays above other content but below modals */
    }
    /* Adjust main content for fixed header */
    .flex-grow { /* This element handles the remaining space, no direct padding needed here */ }


    /* New styles for dashboard overview */
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: transform 0.2s ease-in-out;
        min-height: 150px; /* Ensure consistent height */
        justify-content: center;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card .icon {
        font-size: 2.5rem;
        color: #0d6efd; /* Theme blue */
        margin-bottom: 0.5rem;
    }
    .stat-card .value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1a1a1a;
    }
    .stat-card .label {
        font-size: 0.9rem;
        color: #555;
        margin-top: 0.2rem;
    }

    /* Upcoming Classes and Announcements sections */
    .section-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1f2937; /* Dark gray */
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e2e8f0;
    }
    .class-item, .announcement-item {
        background: #ffffff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
    }
    .class-item strong, .announcement-item strong {
        color: #0d6efd; /* Theme blue */
    }
    .announcement-item .date {
        font-size: 0.8em;
        color: #777;
        margin-top: 0.5em;
    }
    .empty-state {
        text-align: center;
        color: #6b7280;
        padding: 1.5rem;
        background-color: #f3f4f6;
        border-radius: 8px;
        margin-top: 1rem;
    }
    .full-width {
        grid-column: 1 / -1; /* Span all columns in the grid */
    }
    /* Loading overlay styles */
    .loading-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        transition: opacity 0.3s ease-in-out;
    }
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid #0d6efd; /* Theme blue spinner */
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loading-text {
        margin-top: 10px;
        font-weight: 500;
        color: #0d6efd;
    }
     /* Custom Alert/Confirm Modal Styles */
    .custom-alert-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000; /* Higher than other modals */
    }
    .custom-alert-content {
        background: white;
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .custom-alert-content p {
        margin-bottom: 0; /* Remove default paragraph margin */
        font-size: 1.1em;
        color: #1a1a1a; /* Default text color */
    }
    .custom-alert-content button {
        background-color: #0d6efd; /* Primary blue for OK button */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color .3s ease;
    }
    .custom-alert-content button:hover {
        background-color: #0a58ca;
    }
    /* Specific styles for alert types */
    .custom-alert-content.error {
        background-color: #dc3545; /* Red for error */
        color: white;
    }
    .custom-alert-content.success {
        background-color: #28a745; /* Green for success */
        color: white;
    }
    .custom-alert-content.info {
        background-color: #002d6b; /* Dark Blue for info */
        color: white;
    }

    /* Hostel Specific Styles */
    .hostel-card {
        background-color: #f0f9ff; /* Light blue background */
        border: 1px solid #bfdbfe; /* Light blue border */
        border-radius: 8px;
        padding: 1.2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .hostel-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .hostel-card h5 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e40af; /* Darker blue for titles */
        margin-bottom: 0.5rem;
    }
    .hostel-card p {
        font-size: 0.95rem;
        color: #374151; /* Dark gray for text */
        margin-bottom: 0.3rem;
    }
    .hostel-card .status-tag {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 9999px; /* Fully rounded */
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    .hostel-card .status-tag.available {
        background-color: #d1fae5; /* Green light */
        color: #065f46; /* Green dark */
    }
    .hostel-card .status-tag.full {
        background-color: #fee2e2; /* Red light */
        color: #991b1b; /* Red dark */
    }
    .hostel-card button {
        margin-top: 1rem;
        width: 100%;
        background-color: #0d6efd;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }
    .hostel-card button:hover {
        background-color: #0a58ca;
    }

    /* Room Card Styles */
    .room-card {
        background-color: #ecfdf5; /* Even lighter green background */
        border: 1px solid #a7f3d0; /* Light green border */
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 6px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    .room-card h6 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #047857; /* Dark green for room number */
        margin-bottom: 0.3rem;
    }
    .room-card p {
        font-size: 0.9rem;
        color: #14532d; /* Darker green for room details */
    }
    .room-card button {
        margin-top: 0.8rem;
        background-color: #059669; /* Teal green */
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }
    .room-card button:hover {
        background-color: #047857;
    }
    .room-card button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* Current Booking Card */
    .current-booking-card {
        background-color: #e0f2fe; /* Very light blue */
        border: 1px solid #90cdf4;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
        text-align: left;
    }
    .current-booking-card h4 {
        color: #1e40af;
        margin-bottom: 1rem;
    }
    .current-booking-card p {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    .current-booking-card p strong {
        color: #0d6efd;
    }
    .current-booking-card .booking-status {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.8rem;
    }
    .current-booking-card .booking-status.active {
        background-color: #d1fae5;
        color: #065f46;
    }
    .current-booking-card .booking-status.pending {
        background-color: #fefcbf;
        color: #8a6d3b;
    }
    .current-booking-card .booking-status.cancelled {
        background-color: #fee2e2;
        color: #991b1b;
    }
    .current-booking-card button {
        background-color: #dc3545; /* Red for cancel */
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        font-weight: 500;
        margin-top: 1.2rem;
        transition: background-color 0.2s ease;
    }
    .current-booking-card button:hover {
        background-color: #bb2d3b;
    }

    /* Hostel Rules & Notices */
    .hostel-rules-card {
        background-color: #fef3c7; /* Light yellow */
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-top: 2rem;
        text-align: left;
    }
    .hostel-rules-card h4 {
        color: #b45309; /* Darker yellow/orange */
        margin-bottom: 1rem;
        border-bottom: 1px solid #fcd34d;
        padding-bottom: 0.5rem;
    }
    .hostel-rules-card ul {
        list-style-type: disc;
        margin-left: 20px;
        margin-bottom: 1rem;
    }
    .hostel-rules-card li {
        margin-bottom: 0.5rem;
        color: #78350f; /* Brownish text */
    }
    .hostel-rules-card .notice-item {
        background-color: #fff9e6;
        border-left: 4px solid #fcd34d;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    .hostel-rules-card .notice-item strong {
        color: #b45309;
    }

    /* Finance Specific Styles */
    .finance-summary-card {
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    .finance-summary-card p.label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 0.2rem;
    }
    .finance-summary-card p.value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .finance-status-message {
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-weight: bold;
        text-align: center;
    }
    .finance-status-message.cleared {
        background-color: #d1fae5; /* Green light */
        color: #065f46; /* Green dark */
        border: 1px solid #a7f3d0;
    }
    .finance-status-message.pending {
        background-color: #fef3c7; /* Yellow light */
        color: #b45309; /* Yellow dark */
        border: 1px solid #fcd34d;
    }

    .finance-upcoming-deadlines {
        background-color: #e0f2fe; /* Light blue */
        border: 1px solid #90cdf4;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .finance-upcoming-deadlines h4 {
        color: #1e40af;
        margin-bottom: 1rem;
        border-bottom: 1px solid #90cdf4;
        padding-bottom: 0.5rem;
    }
    .finance-upcoming-deadlines ul {
        list-style: none;
        padding: 0;
    }
    .finance-upcoming-deadlines li {
        background-color: #f8fafd;
        border-left: 4px solid #0d6efd;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        font-size: 0.95rem;
        color: #374151;
    }
    .finance-upcoming-deadlines li strong {
        color: #0d6efd;
    }

    /* Graduation Specific Styles */
    .graduation-status-card {
        background-color: #e0f7fa; /* Light cyan */
        border: 1px solid #b2ebf2;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        text-align: left;
    }
    .graduation-status-card h4 {
        color: #006064; /* Dark teal */
        margin-bottom: 1rem;
    }
    .graduation-status-card p {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        color: #263238;
    }
    .graduation-status-card p strong {
        color: #0097a7; /* Cyan */
    }
    .graduation-status-card .status-badge {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    .graduation-status-card .status-badge.pending {
        background-color: #fff9c4; /* Light yellow */
        color: #fbc02d; /* Amber */
    }
    .graduation-status-card .status-badge.approved {
        background-color: #c8e6c9; /* Light green */
        color: #388e3c; /* Green */
    }
    .graduation-status-card .status-badge.rejected {
        background-color: #ffcdd2; /* Light red */
        color: #d32f2f; /* Red */
    }
    .graduation-status-card .admin-comments {
        background-color: #f0f0f0;
        border-left: 3px solid #757575;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 5px;
        font-style: italic;
    }
    .graduation-status-card .uploaded-docs-list {
        list-style: none;
        padding: 0;
        margin-top: 1rem;
    }
    .graduation-status-card .uploaded-docs-list li {
        margin-bottom: 0.5rem;
    }
    .graduation-status-card .uploaded-docs-list a {
        color: #0097a7;
        text-decoration: underline;
    }

    /* Clearance Specific Styles */
    .clearance-status-card {
        background-color: #e8f5e9; /* Light green */
        border: 1px solid #c8e6c9;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        text-align: left;
    }
    .clearance-status-card h4 {
        color: #2e7d32; /* Dark green */
        margin-bottom: 1rem;
    }
    .clearance-status-card p {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        color: #424242;
    }
    .clearance-status-card p strong {
        color: #4caf50; /* Green */
    }
    .clearance-status-card .status-badge {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    .clearance-status-card .status-badge.pending {
        background-color: #fffde7; /* Very light yellow */
        color: #fbc02d; /* Amber */
    }
    .clearance-status-card .status-badge.approved {
        background-color: #e8f5e9; /* Light green */
        color: #388e3c; /* Green */
    }
    .clearance-status-card .status-badge.rejected {
        background-color: #ffebee; /* Very light red */
        color: #d32f2f; /* Red */
    }
    .clearance-status-card .department-comment {
        font-style: italic;
        color: #616161;
        font-size: 0.85rem;
    }

    /* Announcements Specific Styles */
    .announcement-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.2rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: transform 0.2s ease-in-out;
    }
    .announcement-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .announcement-card .category-badge {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        vertical-align: middle;
    }
    .category-badge.academics { background-color: #e3f2fd; color: #1e88e5; } /* Blue */
    .category-badge.finance { background-color: #e8f5e9; color: #43a047; } /* Green */
    .category-badge.hostel { background-color: #fff3e0; color: #fb8c00; } /* Orange */
    .category-badge.events { background-color: #f3e5f5; color: #8e24aa; } /* Purple */
    .category-badge.general { background-color: #eceff1; color: #546e7a; } /* Gray */

    .announcement-card h4 {
        font-size: 1.15rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.4rem;
        display: flex;
        align-items: center;
    }
    .announcement-card h4 .pinned-icon {
        color: #fbc02d; /* Amber */
        margin-right: 0.5rem;
        font-size: 1.2em;
    }
    .announcement-card .meta-info {
        font-size: 0.85rem;
        color: #616161;
        margin-bottom: 0.8rem;
    }
    .announcement-card .message-excerpt {
        color: #424242;
        line-height: 1.5;
        margin-bottom: 0.8rem;
    }
    .announcement-card .read-more-btn {
        color: #0d6efd;
        text-decoration: underline;
        font-size: 0.9rem;
        cursor: pointer;
    }

    /* Announcement Modal for full view */
    .announcement-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .announcement-modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 700px;
        width: 90%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }
    .announcement-modal-content .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #757575;
    }
    .announcement-modal-content h3 {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1a202c;
        margin-bottom: 1rem;
    }
    .announcement-modal-content .meta-info {
        font-size: 0.95rem;
        color: #616161;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 1rem;
    }
    .announcement-modal-content .full-message {
        font-size: 1rem;
        color: #424242;
        line-height: 1.6;
    }

  </style>
</head>
<body>

  <!-- Header is outside the dashboardContent to always be visible -->
  <header id="mainHeader" class="p-4 flex justify-between items-center shadow-md bg-white">
    <img src="myschoollogo.png" alt="Logo" class="h-12">
    <div class="flex items-center space-x-4">
      <span id="userEmail" class="text-blue-600 font-bold"></span>
      <button id="logoutBtn" class="btn-red"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </header>

  <!-- Universal Loading Overlay -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
    <p class="text-lg font-semibold text-blue-600 flex items-center">
      <span class="spinner mr-3"></span> Loading dashboard...
    </p>
  </div>

  <!-- Critical Error Overlay -->
  <div id="errorBox" class="hidden fixed inset-0 flex items-center justify-center bg-white z-50">
    <p class="text-lg font-semibold text-red-600">‚ö† Error loading dashboard</p>
  </div>

  <!-- Main Dashboard Content (initially hidden) -->
  <div id="dashboardContent" class="hidden h-screen flex flex-col">
    <!-- Non-critical warning box (e.g., profile missing) -->
    <div id="dashboardWarningBox" class="hidden p-4 mb-4 text-center text-orange-700 bg-orange-100 border border-orange-200 rounded-md">
      <!-- Content will be inserted by JS -->
    </div>

    <div class="flex flex-grow">
      <!-- Sidebar -->
      <nav id="sidebar" class="w-64 bg-white border-r p-4 hidden md:block overflow-y-auto">
        <h3 class="text-2xl font-bold mb-4 text-blue-800">Menu</h3>
        <a href="#" onclick="showSection('home')"><i class="fas fa-home mr-2"></i> Dashboard</a>
        <a href="#" onclick="showSection('profile')"><i class="fas fa-user mr-2"></i> Profile</a>
        <a href="#" onclick="showSection('settings')"><i class="fas fa-cog mr-2"></i> Settings</a>
        <a href="#" onclick="showSection('courseReg')"><i class="fas fa-file-alt mr-2"></i> Course Registration</a>
        <a href="#" onclick="showSection('timetable')"><i class="fas fa-calendar-alt mr-2"></i> Timetable</a>
        <a href="#" onclick="showSection('grades')"><i class="fas fa-clipboard-list mr-2"></i> Grades</a>
        <a href="#" onclick="showSection('examCard')"><i class="fas fa-id-card mr-2"></i> Exam Card</a>
        <a href="#" onclick="showSection('graduation')"><i class="fas fa-graduation-cap mr-2"></i> Graduation Request</a>
        <a href="#" onclick="showSection('clearance')"><i class="fas fa-check-circle mr-2"></i> Clearance Request</a>
        <a href="#" onclick="showSection('finance')"><i class="fas fa-money-bill-wave mr-2"></i> Finance</a>
        <a href="#" onclick="showSection('hostels')"><i class="fas fa-hotel mr-2"></i> Hostels</a>
        <a href="#" onclick="showSection('announcements')"><i class="fas fa-bullhorn mr-2"></i> Announcements</a>
      </nav>

      <!-- Main Content -->
      <main id="mainContent" class="flex-grow p-6 overflow-y-auto">
        <!-- Home - Dashboard Overview -->
        <div id="home" class="dashboard-card">
          <h2 class="text-xl font-bold text-blue-700 mb-4" id="welcomeMessage">Welcome to your Dashboard</h2>
          <p class="text-gray-600 mb-6">Here‚Äôs a quick look at your university status.</p>

          <h3 class="section-title">Quick Stats</h3>
          <div id="quickStats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 mb-8">
              <!-- Stat cards will be dynamically loaded here -->
          </div>
          <hr class="my-6 border-gray-300">

          <h3 class="section-title">Upcoming Classes Today</h3>
          <div id="upcomingClasses" class="mt-4 mb-8">
              <!-- Upcoming classes will be dynamically loaded here -->
          </div>
          <hr class="my-6 border-gray-300">

          <h3 class="section-title">Recent Announcements</h3>
          <div id="recentAnnouncements" class="mt-4">
              <!-- Recent announcements will be dynamically loaded here -->
          </div>
        </div>

        <!-- Profile -->
        <div id="profile" class="dashboard-card hidden">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Your Profile</h2>
          <form id="profileForm" class="space-y-6">
            <!-- Basic Info -->
            <div class="space-y-4">
              <h3 class="text-lg font-semibold text-blue-600">Basic Information</h3>
              <div>
                <label for="profileName" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="profileName" placeholder="Full Name" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
              </div>
              <div>
                <label for="profileEmail" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="profileEmail" placeholder="Email" class="mt-1 w-full border p-2 rounded-md bg-gray-100 cursor-not-allowed shadow-sm" readonly/>
              </div>
              <div>
                <label for="profilePhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                <input type="text" id="profilePhone" placeholder="Phone Number" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
              </div>
              <div>
                <label for="profileDob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                <input type="date" id="profileDob" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
              </div>
              <div>
                <label for="profileGender" class="block text-sm font-medium text-gray-700">Gender</label>
                <select id="profileGender" class="mt-1 w-full border p-2 rounded-md shadow-sm">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label for="profileAddress" class="block text-sm font-medium text-gray-700">Address</label>
                <textarea id="profileAddress" placeholder="Your Address" rows="3" class="mt-1 w-full border p-2 rounded-md shadow-sm"></textarea>
              </div>
            </div>

            <!-- Guardian Info -->
            <div class="space-y-4 mt-6">
              <h3 class="text-lg font-semibold text-blue-600">Guardian Information</h3>
              <div>
                <label for="profileGuardianName" class="block text-sm font-medium text-gray-700">Guardian Name</label>
                <input type="text" id="profileGuardianName" placeholder="Guardian Full Name" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
              </div>
              <div>
                <label for="profileGuardianPhone" class="block text-sm font-medium text-gray-700">Guardian Phone</label>
                <input type="text" id="profileGuardianPhone" placeholder="Guardian Phone Number" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
              </div>
              <div>
                <label for="profileGuardianRelation" class="block text-sm font-medium text-gray-700">Relationship</label>
                <input type="text" id="profileGuardianRelation" placeholder="e.g., Mother, Father, Aunt" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
              </div>
            </div>

            <!-- Academic Info -->
            <div class="space-y-4 mt-6">
              <h3 class="text-lg font-semibold text-blue-600">Academic Information</h3>
              <div>
                <label for="profileAdmissionNo" class="block text-sm font-medium text-gray-700">Admission Number</label>
                <input type="text" id="profileAdmissionNo" class="mt-1 w-full border p-2 rounded-md bg-gray-100 cursor-not-allowed shadow-sm" disabled value="Not assigned yet ‚Äì contact administration."/>
              </div>
              <div>
                <label for="profileProgram" class="block text-sm font-medium text-gray-700">Program of Study</label>
                <input type="text" id="profileProgram" placeholder="e.g., BSc Computer Science" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="profileYear" class="block text-sm font-medium text-gray-700">Year</label>
                  <select id="profileYear" class="mt-1 w-full border p-2 rounded-md shadow-sm">
                    <option value="">Select Year</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                  </select>
                </div>
                <div>
                  <label for="profileSemester" class="block text-sm font-medium text-gray-700">Semester</label>
                  <select id="profileSemester" class="mt-1 w-full border p-2 rounded-md shadow-sm">
                    <option value="">Select Semester</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
              </div>
              <div>
                <label for="profileEnrollmentDate" class="block text-sm font-medium text-gray-700">Enrollment Date</label>
                <input type="text" id="profileEnrollmentDate" class="mt-1 w-full border p-2 rounded-md bg-gray-100 cursor-not-allowed shadow-sm" disabled value="Not set yet"/>
              </div>
            </div>

            <!-- Profile Picture -->
            <div class="space-y-4 mt-6">
              <h3 class="text-lg font-semibold text-blue-600">Profile Picture</h3>
              <div class="flex items-center space-x-4">
                <img id="profilePicturePreview" class="h-24 w-24 rounded-full object-cover border-2 border-blue-300" src="https://placehold.co/96x96/e2e8f0/6b7280?text=No+Image" alt="Profile Picture"/>
                <div>
                  <input type="file" id="profilePictureUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                  <p class="mt-1 text-xs text-gray-500">JPG, PNG, GIF up to 2MB</p>
                </div>
              </div>
            </div>

            <button type="submit" class="btn-red mt-6">Update Profile</button>
          </form>
        </div>

        <!-- Settings -->
        <div id="settings" class="dashboard-card hidden">
            <h2 class="text-xl font-bold text-blue-700 mb-4">Settings</h2>
            <form id="settingsForm" class="space-y-6">
                <!-- Account Security -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-blue-600">Account Security üîí</h3>
                    <div>
                        <button type="button" onclick="changePassword()" class="btn-red">Change Password</button>
                    </div>
                    <div>
                        <button type="button" id="changeEmailBtn" class="btn-red">Change Email</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="twoFactorEnabled" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="twoFactorEnabled" class="ml-2 block text-sm text-gray-900">Enable Two-Step Verification</label>
                    </div>
                </div>

                <!-- Notification Preferences -->
                <div class="space-y-4 mt-6">
                    <h3 class="text-lg font-semibold text-blue-600">Notification Preferences üîî</h3>
                    <div class="flex items-center">
                        <input type="checkbox" id="notifyEmail" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="notifyEmail" class="ml-2 block text-sm text-gray-900">Email Notifications (Announcements, Fees Alerts)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="notifyInApp" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="notifyInApp" class="ml-2 block text-sm text-gray-900">In-app Notifications</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="notifySms" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="notifySms" class="ml-2 block text-sm text-gray-900">SMS Alerts</label>
                    </div>
                </div>

                <!-- Privacy & Data -->
                <div class="space-y-4 mt-6">
                    <h3 class="text-lg font-semibold text-blue-600">Privacy & Data üïµÔ∏è</h3>
                    <div class="flex items-center">
                        <input type="checkbox" id="showProfileToClassmates" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="showProfileToClassmates" class="ml-2 block text-sm text-gray-900">Show profile to classmates</label>
                    </div>
                    <div>
                        <button type="button" class="btn-red">Download Personal Data (Future Feature)</button>
                    </div>
                </div>

                <button type="submit" class="btn-red mt-6">Save Settings</button>
            </form>

            <!-- Danger Zone -->
            <div class="space-y-4 mt-8 pt-8 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-red-600">Danger Zone ‚ö†Ô∏è</h3>
                <p class="text-sm text-gray-600">This action cannot be undone. Please proceed with caution.</p>
                <div>
                    <button type="button" id="deleteAccountBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">Delete Account</button>
                </div>
            </div>
        </div>

        <!-- Course Registration -->
        <div id="courseReg" class="dashboard-card hidden">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Course Registration</h2>
          <div class="space-y-4">
            <h3 class="text-lg font-bold text-blue-600 mb-3">Filter Courses</h3>
            
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
              <select id="yearSelect" class="border p-2 rounded-md flex-grow">
                <option value="">Select Year</option>
                <option value="1">Year 1</option>
                <option value="2">Year 2</option>
                <option value="3">Year 3</option>
                <option value="4">Year 4</option>
              </select>
              <select id="semesterSelect" class="border p-2 rounded-md flex-grow">
                <option value="">Select Semester</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
                <option value="3">Semester 3</option>
              </select>
              <button onclick="filterAndLoadCourses()" class="btn-red">Load Courses</button>
            </div>

            <h4 class="text-md font-semibold text-blue-600 mt-6 mb-3">Available Courses</h4>
            <div id="availableCoursesList" class="mb-6 space-y-2">
              <!-- Available courses will be dynamically loaded here -->
              <div class="empty-state">Select year and semester to load available courses.</div>
            </div>
            <button onclick="registerSelectedCourses()" class="btn-red w-full sm:w-auto">Register Selected Courses</button>
          </div>

          <h4 class="text-md font-semibold text-blue-600 mt-8 mb-3 border-t pt-6">Currently Registered Courses</h4>
          <div id="registeredCoursesDisplay" class="overflow-x-auto">
              <table class="w-full border-collapse border mt-2">
                  <thead class="bg-gray-100">
                      <tr>
                          <th class="p-2 border text-left">Code</th>
                          <th class="p-2 border text-left">Title</th>
                          <th class="p-2 border text-left">Credits</th>
                          <th class="p-2 border text-left">Lecturer</th>
                          <th class="p-2 border text-left">Action</th>
                      </tr>
                  </thead>
                  <tbody id="registeredCoursesTable">
                      <!-- Registered courses will be dynamically loaded here -->
                      <tr><td colspan="5" class="p-4 text-center text-gray-500">You haven‚Äôt registered for any courses yet.</td></tr>
                  </tbody>
              </table>
          </div>
        </div>

        <!-- Timetable -->
        <div id="timetable" class="dashboard-card hidden">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Timetable</h2>
          <div class="space-y-4">
              <h3 class="text-lg font-bold text-blue-600 mb-3">Weekly Timetable Overview</h3>
              
              <!-- Optional Filters -->
              <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                  <select id="timetableYear" class="border p-2 rounded-md flex-grow">
                      <option value="">Select Year</option>
                      <option value="1">Year 1</option>
                      <option value="2">Year 2</option>
                      <option value="3">Year 3</option>
                      <option value="4">Year 4</option>
                  </select>
                  <select id="timetableSemester" class="border p-2 rounded-md flex-grow">
                      <option value="">Select Semester</option>
                      <option value="1">Semester 1</option>
                      <option value="2">Semester 2</option>
                      <option value="3">Semester 3</option>
                  </select>
                  <button onclick="handleLoadTimetable()" class="btn-red">Load Timetable</button>
              </div>

              <!-- Timetable Grid -->
              <div class="overflow-x-auto">
                  <table class="w-full border-collapse border mt-2">
                      <thead class="bg-gray-100">
                          <tr>
                              <th class="p-2 border text-left">Time</th>
                              <th class="p-2 border text-left">Monday</th>
                              <th class="p-2 border text-left">Tuesday</th>
                              <th class="p-2 border text-left">Wednesday</th>
                              <th class="p-2 border text-left">Thursday</th>
                              <th class="p-2 border text-left">Friday</th>
                          </tr>
                      </thead>
                      <tbody id="timetableTable">
                          <tr><td colspan="6" class="p-4 text-center text-gray-500">Select year and semester and click "Load Timetable" to view your schedule.</td></tr>
                      </tbody>
                  </table>
              </div>
          </div>
        </div>

        <!-- Grades -->
        <div id="grades" class="dashboard-card hidden">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Grades & Transcript</h2>

          <!-- Filters -->
          <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
            <select id="gradesYear" class="border p-2 rounded-md flex-grow">
              <option value="">Select Year</option>
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
              <option value="4">Year 4</option>
            </select>
            <select id="gradesSemester" class="border p-2 rounded-md flex-grow">
              <option value="">Select Semester</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
            </select>
            <button onclick="handleLoadGrades()" class="btn-red">Load Grades</button>
          </div>

          <!-- Grades Table -->
          <div class="overflow-x-auto mb-4">
              <table class="w-full border-collapse border mt-2">
                  <thead class="bg-gray-100">
                      <tr>
                          <th class="p-2 border text-left">Code</th>
                          <th class="p-2 border text-left">Title</th>
                          <th class="p-2 border text-left">Credits</th>
                          <th class="p-2 border text-left">Grade</th>
                          <th class="p-2 border text-left">Points</th>
                          <th class="p-2 border text-left">Lecturer</th>
                      </tr>
                  </thead>
                  <tbody id="gradesTable">
                      <tr><td colspan="6" class="p-4 text-center text-gray-500">Select year and semester and click "Load Grades" to view.</td></tr>
                  </tbody>
              </table>
          </div>

          <!-- GPA Section -->
          <div class="mt-4 space-y-2">
            <p id="semesterGpa" class="font-semibold text-blue-700">Semester GPA: N/A</p>
            <p id="cumulativeGpa" class="font-semibold text-blue-700">Cumulative GPA: N/A</p>
          </div>

          <!-- Transcript -->
          <button onclick="downloadTranscript()" class="btn-red mt-4">Download Transcript (PDF)</button>
        </div>

        <!-- Exam Card -->
        <div id="examCard" class="dashboard-card hidden">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Exam Card</h2>

          <!-- Info Section -->
          <div id="examCardInfo" class="mb-4 text-sm text-gray-700 p-4 border rounded-md bg-blue-50">
            <p><strong>Name:</strong> <span id="examName">Loading...</span></p>
            <p><strong>Admission No:</strong> <span id="examAdmNo">Loading...</span></p>
            <p><strong>Program:</strong> <span id="examProgram">Loading...</span></p>
            <p><strong>Year / Semester:</strong> <span id="examYearSem">Loading...</span></p>
          </div>

          <!-- Courses Table -->
          <div class="overflow-x-auto mb-4">
              <table class="w-full border-collapse border mt-2">
                  <thead class="bg-gray-100">
                      <tr>
                          <th class="p-2 border text-left">Code</th>
                          <th class="p-2 border text-left">Title</th>
                          <th class="p-2 border text-left">Credits</th>
                          <th class="p-2 border text-left">Lecturer</th>
                          <th class="p-2 border text-left">Venue</th>
                          <th class="p-2 border text-left">Date</th>
                      </tr>
                  </thead>
                  <tbody id="examCoursesTable">
                      <tr><td colspan="6" class="p-4 text-center text-gray-500">Loading registered courses and exam schedule...</td></tr>
                  </tbody>
              </table>
          </div>

          <!-- Status -->
          <div id="examStatus" class="mb-4 p-3 rounded-md text-center text-lg font-semibold bg-gray-100 border border-gray-300">
              Checking finance clearance...
          </div>

          <!-- Download -->
          <button onclick="downloadExamCard()" class="btn-red w-full sm:w-auto">Download Exam Card (PDF)</button>
        </div>

        <!-- Graduation -->
        <div id="graduation" class="dashboard-card hidden">
          <h3 class="text-lg font-bold text-blue-600 mb-3">Graduation Request</h3>

          <div id="graduationContent">
            <!-- Content (form or status) will be loaded dynamically here by JavaScript -->
            <div class="empty-state">Loading graduation status...</div>
          </div>
        </div>

        <!-- Clearance -->
        <div id="clearance" class="dashboard-card hidden">
          <h3 class="text-lg font-bold text-blue-600 mb-3">Clearance Request</h3>

          <div id="clearanceContent">
              <!-- Dynamic content: form or status card -->
              <div class="empty-state">Loading clearance status...</div>
          </div>
        </div>

        <!-- Finance -->
        <div id="finance" class="dashboard-card hidden">
          <h3 class="text-lg font-bold text-blue-600 mb-3">Finance</h3>

          <!-- Fees Summary -->
          <div id="financeSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div class="finance-summary-card bg-blue-50">
                  <p class="label">Total Fees Charged</p>
                  <p id="totalFees" class="value text-blue-700">KES 0</p>
              </div>
              <div class="finance-summary-card bg-green-50">
                  <p class="label">Total Payments Made</p>
                  <p id="totalPaid" class="value text-green-700">KES 0</p>
              </div>
              <div class="finance-summary-card bg-red-50">
                  <p class="label">Outstanding Balance</p>
                  <p id="balance" class="value text-red-700">KES 0</p>
              </div>
          </div>
          <div id="financeStatusMessage" class="finance-status-message">
              Loading finance status...
          </div>

          <h4 class="font-semibold text-blue-500 mb-2 mt-6">Transactions History</h4>
          <div class="overflow-x-auto mb-4">
              <table class="w-full border-collapse border mt-2">
                  <thead class="bg-gray-100">
                      <tr>
                          <th class="p-2 border text-left">Date</th>
                          <th class="p-2 border text-left">Description</th>
                          <th class="p-2 border text-left">Type</th>
                          <th class="p-2 border text-right">Amount (KES)</th>
                          <th class="p-2 border text-right">Running Balance (KES)</th>
                      </tr>
                  </thead>
                  <tbody id="financeTable">
                      <tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions recorded.</td></tr>
                  </tbody>
              </table>
          </div>

          <!-- Statement -->
          <button onclick="downloadStatement()" class="btn-red w-full sm:w-auto mt-4"><i class="fas fa-download mr-2"></i> Download Fee Statement (PDF)</button>

          <!-- Upcoming Fee Deadlines (Optional) -->
          <div id="upcomingFeeDeadlines" class="finance-upcoming-deadlines hidden">
              <h4 class="font-semibold text-blue-700 mb-3">Upcoming Fee Deadlines</h4>
              <ul id="feeDeadlinesList">
                  <div class="empty-state">No upcoming fee deadlines.</div>
              </ul>
          </div>

        </div>

        <!-- Hostels -->
        <div id="hostels" class="dashboard-card hidden">
          <h3 class="text-lg font-bold text-blue-600 mb-3">Hostel Accommodation</h3>

          <!-- Student Booking Status -->
          <div id="currentBooking" class="mb-6">
            <h4 class="font-semibold text-blue-500">Your Current Booking</h4>
            <div id="bookingDetails" class="empty-state">No booking yet.</div>
          </div>

          <!-- Available Hostels -->
          <h4 class="font-semibold text-blue-500 mb-2">Available Hostels</h4>
          <div id="hostelList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="empty-state full-width">No hostels available at the moment.</div>
          </div>

          <!-- Room List (Shown when hostel clicked) -->
          <div id="roomList" class="mt-6 hidden">
            <h4 class="font-semibold text-blue-500 mb-2" id="roomsForHostelTitle">Rooms for [Hostel Name]</h4>
            <button onclick="backToHostels()" class="btn-red text-xs mb-4"><i class="fas fa-arrow-left mr-2"></i> Back to Hostels</button>
            <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="empty-state full-width">Loading rooms...</div>
            </div>
          </div>

          <!-- Hostel Rules & Notices -->
          <div id="hostelRulesNotices" class="hostel-rules-card hidden">
              <h4 class="font-semibold text-orange-700 mb-3">Hostel Rules & Important Notices</h4>
              <div id="rulesContent">
                  <ul>
                      <li>Curfew is at 10:00 PM on weekdays and 11:00 PM on weekends.</li>
                      <li>No guests are allowed after 9:00 PM.</li>
                      <li>Keep your room and common areas clean.</li>
                      <li>Report any maintenance issues immediately to the hostel warden.</li>
                      <li>Silence hours are from 10:00 PM to 6:00 AM.</li>
                      <li>No cooking is allowed inside rooms. Use designated common kitchens.</li>
                  </ul>
              </div>
              <h5 class="font-semibold text-orange-700 mt-4 mb-2">Important Notices:</h5>
              <div id="hostelNoticesList">
                  <div class="empty-state">No special notices for hostels at this time.</div>
              </div>
          </div>

        </div>

        <!-- Announcements -->
        <div id="announcements" class="dashboard-card hidden">
          <h3 class="text-lg font-bold text-blue-600 mb-3">Announcements</h3>

          <!-- Filter -->
          <div class="flex space-x-2 mb-4">
            <select id="announcementFilter" class="border p-2 rounded">
              <option value="all">All</option>
              <option value="Academics">Academics</option>
              <option value="Finance">Finance</option>
              <option value="Hostel">Hostel</option>
              <option value="Events">Events</option>
              <option value="General">General</option>
            </select>
            <button onclick="loadAnnouncements(document.getElementById('announcementFilter').value)" class="btn-red">Filter</button>
          </div>

          <!-- List -->
          <div id="announcementList" class="space-y-4">
              <div class="empty-state">Loading announcements...</div>
          </div>
        </div>
      </main>
    </div>

    <footer class="bg-white p-4 text-center border-t text-sm">
      ¬© 2025 Prince Alex Design University. All rights reserved.
    </footer>
  </div>

    <!-- Announcement Read More Modal -->
    <div id="announcementReadMoreModal" class="announcement-modal hidden">
        <div class="announcement-modal-content">
            <span class="close-btn" onclick="document.getElementById('announcementReadMoreModal').classList.add('hidden');">&times;</span>
            <h3 id="modalTitle"></h3>
            <p class="meta-info"><span id="modalDate"></span> | <span id="modalAuthor"></span> <span id="modalCategoryBadge" class="category-badge"></span></p>
            <div id="modalMessage" class="full-message"></div>
        </div>
    </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updatePassword, updateEmail, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc, orderBy, limit, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app); // Initialize Firebase Storage

    // Reassigning loadingOverlay to the new #loading div for universal control
    const loadingOverlay = document.getElementById('loading');

    const userEmailSpan = document.getElementById("userEmail");
    const profileForm = document.getElementById("profileForm");
    const settingsForm = document.getElementById("settingsForm"); // Get settings form


    // Helper for displaying custom alerts (replaces native alert/prompt)
    function showCustomAlert(message, type = 'info', callback = null) {
        const modal = document.createElement('div');
        modal.classList.add('custom-alert-modal'); // Assuming you have custom-alert-modal CSS
        let bgColor = '#0d6efd'; // Primary blue
        if (type === 'error') { bgColor = '#dc3545'; }
        else if (type === 'success') { bgColor = '#28a745'; }

        modal.innerHTML = `
            <div style="background:${bgColor}; color:white; padding:25px; border-radius:8px; text-align:center; max-width:400px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                <p style="margin-bottom:20px; font-size:1.1em;">${message}</p>
                <button style="background-color:white; color:${bgColor}; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;"
                        onclick="this.parentNode.parentNode.remove(); if(typeof window.alertCallback === 'function') window.alertCallback();">OK</button>
            </div>
        `;
        document.body.appendChild(modal);
        window.alertCallback = callback; // Store callback globally
    }

    // Custom Prompt function
    function showCustomPrompt(message, callback, inputType = 'password', placeholder = '') {
        const modal = document.createElement('div');
        modal.classList.add('custom-alert-modal');
        modal.innerHTML = `
            <div style="background:white; padding:25px; border-radius:8px; text-align:center; max-width:400px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                <p style="margin-bottom:15px; font-size:1.1em; color:#1a1a1a;">${message}</p>
                <input type="${inputType}" id="promptInput" placeholder="${placeholder || `Enter ${inputType === 'password' ? 'new password' : 'new email'}`}" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px;">
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button style="background-color:#0d6efd; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="promptOk">OK</button>
                    <button style="background-color:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="promptCancel">Cancel</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const input = modal.querySelector('#promptInput');
        const okBtn = modal.querySelector('#promptOk');
        const cancelBtn = modal.querySelector('#promptCancel');

        okBtn.onclick = () => {
            modal.remove();
            callback(input.value);
        };
        cancelBtn.onclick = () => {
            modal.remove();
            callback(null);
        };
        input.focus();
    }

    // Custom Confirm function
    function showCustomConfirm(message, type = 'confirm', callback = null) {
        const modal = document.createElement('div');
        modal.classList.add('custom-alert-modal');
        let confirmColor = '#0d6efd';
        if (type === 'delete') confirmColor = '#dc3545';

        modal.innerHTML = `
            <div style="background:white; padding:25px; border-radius:8px; text-align:center; max-width:400px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                <p style="margin-bottom:20px; font-size:1.1em; color:${confirmColor};">${message}</p>
                <div style="display:flex; justify-content:center; gap:15px;">
                    <button style="background-color:${confirmColor}; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="confirmYes">Yes</button>
                    <button style="background-color:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="confirmNo">No</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        modal.querySelector('#confirmYes').onclick = () => {
            modal.remove();
            if(callback) callback(true);
        };
        modal.querySelector('#confirmNo').onclick = () => {
            modal.remove();
            if(callback) callback(false);
        };
    }

    // Function to process Firebase error messages into user-friendly ones
    function getFriendlyErrorMessage(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email':
            case 'auth/wrong-password':
            case 'auth/user-not-found':
            case 'auth/invalid-credential':
                return 'Invalid email or password.';
            case 'auth/email-already-in-use':
                return 'This email address is already in use.';
            case 'auth/weak-password':
                return 'Password should be at least 6 characters.';
            case 'auth/network-request-failed':
                return 'Network error. Please check your connection.';
            case 'auth/requires-recent-login':
                return 'This action requires recent authentication. Please log out and log in again, then try.';
            case 'auth/too-many-requests':
                return 'Too many attempts. Please try again later.';
            case 'auth/operation-not-allowed':
                return 'This operation is not allowed. Please contact support.';
            default:
                return 'An unexpected error occurred. Please try again.';
        }
    }


    // Switch sections
    window.showSection = (id) => {
      document.querySelectorAll("#mainContent > div").forEach(div => div.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    };

    // Auth check - Universal Loader with Error Handling
    onAuthStateChanged(auth, async (user) => {
        const loadingDiv = document.getElementById("loading");
        const errorDiv = document.getElementById("errorBox"); // For critical, dashboard-blocking errors
        const dashboardContentDiv = document.getElementById("dashboardContent");
        const dashboardWarningBox = document.getElementById("dashboardWarningBox"); // For non-critical warnings within dashboard

        // Ensure initial states
        loadingDiv.classList.remove("hidden"); // Show loading spinner
        errorDiv.classList.add("hidden");
        dashboardContentDiv.classList.add("hidden");
        dashboardWarningBox.classList.add("hidden");

        if (!user) {
            // Not logged in ‚Üí redirect
            window.location.href = "login.html";
        } else {
            try {
                const studentDocRef = doc(db, "students", user.uid);
                const studentSnap = await getDoc(studentDocRef);

                userEmailSpan.textContent = user.email; // Always set email if user exists

                // Load initial data (even if profile is missing, for the warning case)
                // These functions now internally use `loadingOverlay` which points to `#loading`
                await loadDashboardOverview(user.uid);
                await loadProfile(user.uid);
                await loadSettings(user.uid);

                loadingDiv.classList.add("hidden"); // Hide the main loader now that data is loaded/attempted
                dashboardContentDiv.classList.remove("hidden"); // Show the dashboard content

                if (!studentSnap.exists()) {
                    // ‚ö† Profile missing but still show dashboard with warning
                    dashboardWarningBox.innerHTML = `<p class="font-semibold">‚ö† Profile not found. Please complete your profile under the 'Profile' section to ensure full functionality.</p>`;
                    dashboardWarningBox.classList.remove("hidden");
                } else {
                    dashboardWarningBox.classList.add("hidden"); // Hide warning if profile is found
                }

            } catch (err) {
                // ‚ùå Critical error fetching initial data ‚Üí show full-screen error, hide dashboard
                console.error("Critical error loading dashboard:", err);
                loadingDiv.classList.add("hidden"); // Hide any lingering loader
                errorDiv.innerHTML = `<p class="text-lg font-semibold text-red-600">‚ùå Error loading dashboard: ${getFriendlyErrorMessage(err.code || err.message)}</p>`;
                errorDiv.classList.remove("hidden"); // Show the critical error overlay
                dashboardContentDiv.classList.add("hidden"); // Keep dashboard hidden
                dashboardWarningBox.classList.add("hidden"); // Ensure no warning is shown
            }
        }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      loadingOverlay.classList.remove('hidden'); // Show loading
      await signOut(auth);
      window.location.href = "login.html";
    });

    /**
     * Dashboard Overview Functions
     */
    async function loadDashboardOverview(uid) {
        // Individual loading calls within sections will now use the shared 'loadingOverlay'
        // which references the main #loading div.
        // For sub-section specific loaders, a more localized approach would be needed.
        // For now, these functions are called after the initial #loading is hidden,
        // so if they take time, the #loading overlay will reappear.
        // This implicitly handles loading for these sections through the universal loader.

        // Ensure we handle current user for dashboard overview
        const user = auth.currentUser;
        if (!user) return; // Should not happen if onAuthStateChanged works correctly

        const studentDocRef = doc(db, "students", user.uid);
        const studentSnap = await getDoc(studentDocRef);
        let studentData = {};
        if (studentSnap.exists()) {
            studentData = studentSnap.data();
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${studentData.name || userEmailSpan.textContent.split('@')[0]}!`;
        } else {
             document.getElementById('welcomeMessage').textContent = `Welcome back, ${userEmailSpan.textContent.split('@')[0]}!`;
        }

        await loadQuickStats(user.uid, studentData);
        await loadUpcomingClasses(user.uid, studentData);
        await loadRecentAnnouncements();
    }

    async function loadQuickStats(uid, studentData) {
        const quickStatsDiv = document.getElementById('quickStats');
        quickStatsDiv.innerHTML = ''; // Clear previous stats

        // 1. Registered Courses
        const registeredCoursesCount = studentData.registeredCourses ? studentData.registeredCourses.length : 0;
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-book icon"></i>
                <div class="value">${registeredCoursesCount}</div>
                <div class="label">Registered Courses</div>
            </div>
        `;

        // 2. GPA
        let gpa = 'N/A';
        const gradesCollectionRef = collection(db, `grades/${uid}/results`);
        const gradesSnap = await getDocs(gradesCollectionRef);
        if (!gradesSnap.empty) {
            let totalGpaPoints = 0;
            let courseCount = 0;
            gradesSnap.forEach(gDoc => {
                const gradeData = gDoc.data();
                if (gradeData.gpaPoints !== undefined) {
                    totalGpaPoints += gradeData.gpaPoints;
                    courseCount++;
                }
            });
            gpa = courseCount > 0 ? (totalGpaPoints / courseCount).toFixed(2) : 'N/A';
        }
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-graduation-cap icon"></i>
                <div class="value">${gpa}</div>
                <div class="label">Current GPA</div>
            </div>
        `;

        // 3. Fees Balance
        let feesBalance = 'N/A';
        const financeDocRef = doc(db, `finance/${uid}/balance`); // Assuming balance is a doc
        const financeSnap = await getDoc(financeDocRef);
        if (financeSnap.exists()) {
            feesBalance = `KES ${Number(financeSnap.data().amount || 0).toLocaleString()}`;
        }
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-money-bill-wave icon"></i>
                <div class="value">${feesBalance}</div>
                <div class="label">Fees Balance</div>
            </div>
        `;

        // 4. Hostel Status
        let hostelStatus = 'Not booked yet';
        let hostelRoom = 'N/A';
        if (studentData.hostelBooking && studentData.hostelBooking.hostelId) {
             const hostelRef = doc(db, "hostels", studentData.hostelBooking.hostelId);
             const hostelSnap = await getDoc(hostelRef);
             if(hostelSnap.exists()){
                hostelStatus = `Booked at ${hostelSnap.data().name || 'Hostel X'}`;
                hostelRoom = studentData.hostelBooking.roomNo ? `, Room ${studentData.hostelBooking.roomNo}` : '';
             } else {
                hostelStatus = 'Booked (details not found)';
             }
        }
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-hotel icon"></i>
                <div class="value">${hostelStatus}${hostelRoom}</div>
                <div class="label">Hostel Status</div>
            </div>
        `;
    }

    async function loadUpcomingClasses(uid, studentData) {
        const upcomingClassesDiv = document.getElementById('upcomingClasses');
        upcomingClassesDiv.innerHTML = ''; // Clear previous classes

        if (!studentData.registeredCourses || studentData.registeredCourses.length === 0) {
            upcomingClassesDiv.innerHTML = `<div class="empty-state">You haven‚Äôt registered for courses yet.</div>`;
            return;
        }

        const today = new Date();
        const dayOfWeek = today.toLocaleDateString('en-US', { weekday: 'long' }); // e.g., "Monday"
        
        // Filter timetable by current day and courses the student is registered for
        const timetableQuery = query(
            collection(db, "timetable"),
            where("day", "==", dayOfWeek)
        );
        const timetableSnap = await getDocs(timetableQuery);

        const registeredCourseCodes = new Set(studentData.registeredCourses.map(course => course.code)); // Assuming 'code' field

        let classesToday = [];
        timetableSnap.forEach(docSnap => {
            const classData = docSnap.data();
            if (registeredCourseCodes.has(classData.courseCode)) {
                classesToday.push(classData);
            }
        });

        if (classesToday.length > 0) {
            classesToday.sort((a, b) => a.time.localeCompare(b.time)); // Sort by time
            let classesHtml = '';
            classesToday.forEach(classItem => {
                classesHtml += `
                    <div class="class-item">
                        <strong>${classItem.courseCode}</strong> - ${classItem.time} - ${classItem.venue}
                    </div>
                `;
            });
            upcomingClassesDiv.innerHTML = classesHtml;
        } else {
            upcomingClassesDiv.innerHTML = `<div class="empty-state">Enjoy your free day! No classes scheduled today.</div>`;
        }
    }

    async function loadRecentAnnouncements() {
        const recentAnnouncementsDiv = document.getElementById('recentAnnouncements');
        recentAnnouncementsDiv.innerHTML = ''; // Clear previous announcements

        const announcementsQuery = query(
            collection(db, "announcements"),
            orderBy("date", "desc"),
            limit(3)
        );
        const announcementsSnap = await getDocs(announcementsQuery);

        if (!announcementsSnap.empty) {
            let announcementsHtml = '';
            announcementsSnap.forEach(docSnap => {
                const announcementData = docSnap.data();
                const announceDate = announcementData.date ? new Date(announcementData.date.seconds * 1000).toLocaleDateString() : 'N/A';
                const messageExcerpt = announcementData.message.length > 100 ? announcementData.message.substring(0, 100) + "..." : announcementData.message;

                announcementsHtml += `
                    <div class="announcement-item">
                        <strong>${announcementData.title}</strong>
                        <p>${messageExcerpt}</p>
                        <span class="date">Posted: ${announceDate}</span>
                    </div>
                `;
            });
            recentAnnouncementsDiv.innerHTML = announcementsHtml;
            // Add a link to the full announcements page
            recentAnnouncementsDiv.innerHTML += `
                <div class="text-right mt-4">
                    <a href="#" onclick="showSection('announcements')" class="text-blue-600 hover:underline">View All Announcements <i class="fas fa-arrow-right"></i></a>
                </div>
            `;
        } else {
            recentAnnouncementsDiv.innerHTML = `<div class="empty-state">No announcements yet.</div>`;
        }
    }

    /**
     * Profile section functions
     */
    async function loadProfile(uid) {
      const studentDocRef = doc(db, "students", uid);
      const snap = await getDoc(studentDocRef);
      const defaultProfilePic = "https://placehold.co/96x96/e2e8f0/6b7280?text=No+Image";

      document.getElementById("profileEmail").value = auth.currentUser.email || ""; // Email from auth

      if (snap.exists()) {
        const data = snap.data();
        document.getElementById("profileName").value = data.name || "";
        document.getElementById("profilePhone").value = data.phone || "";
        document.getElementById("profileDob").value = data.dob || "";
        document.getElementById("profileGender").value = data.gender || "";
        document.getElementById("profileAddress").value = data.address || "";

        // Guardian Info
        document.getElementById("profileGuardianName").value = data.guardian?.name || "";
        document.getElementById("profileGuardianPhone").value = data.guardian?.phone || "";
        document.getElementById("profileGuardianRelation").value = data.guardian?.relation || "";

        // Academic Info
        document.getElementById("profileAdmissionNo").value = data.admissionNo || "Not assigned yet ‚Äì contact administration.";
        document.getElementById("profileProgram").value = data.program || "";
        document.getElementById("profileYear").value = data.year || "";
        document.getElementById("profileSemester").value = data.semester || "";
        document.getElementById("profileEnrollmentDate").value = data.enrollmentDate || "Not set yet";

        // Profile Picture
        document.getElementById("profilePicturePreview").src = data.photoUrl || defaultProfilePic;

      } else {
        // Clear fields if no student document exists
        document.getElementById("profileName").value = "";
        document.getElementById("profilePhone").value = "";
        document.getElementById("profileDob").value = "";
        document.getElementById("profileGender").value = "";
        document.getElementById("profileAddress").value = "";
        document.getElementById("profileGuardianName").value = "";
        document.getElementById("profileGuardianPhone").value = "";
        document.getElementById("profileGuardianRelation").value = "";
        document.getElementById("profileAdmissionNo").value = "Not assigned yet ‚Äì contact administration.";
        document.getElementById("profileProgram").value = "";
        document.getElementById("profileYear").value = "";
        document.getElementById("profileSemester").value = "";
        document.getElementById("profileEnrollmentDate").value = "Not set yet";
        document.getElementById("profilePicturePreview").src = defaultProfilePic;
      }
    }

    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      loadingOverlay.classList.remove('hidden');
      try {
        const studentData = {
          name: document.getElementById("profileName").value.trim(),
          phone: document.getElementById("profilePhone").value.trim(),
          dob: document.getElementById("profileDob").value,
          gender: document.getElementById("profileGender").value,
          address: document.getElementById("profileAddress").value.trim(),
          
          guardian: {
            name: document.getElementById("profileGuardianName").value.trim(),
            phone: document.getElementById("profileGuardianPhone").value.trim(),
            relation: document.getElementById("profileGuardianRelation").value.trim(),
          },
          
          program: document.getElementById("profileProgram").value.trim(),
          year: document.getElementById("profileYear").value ? parseInt(document.getElementById("profileYear").value) : null,
          semester: document.getElementById("profileSemester").value ? parseInt(document.getElementById("profileSemester").value) : null,
          
          email: user.email // Ensure email is saved/updated in student profile too
        };

        // Preserve read-only fields if they exist in Firestore but are not editable by the student
        const studentDocRef = doc(db, "students", user.uid);
        const existingSnap = await getDoc(studentDocRef);
        if (existingSnap.exists()) {
            const existingData = existingSnap.data();
            studentData.admissionNo = existingData.admissionNo || studentData.admissionNo; // Keep existing admissionNo
            studentData.enrollmentDate = existingData.enrollmentDate || studentData.enrollmentDate; // Keep existing enrollmentDate
            studentData.photoUrl = existingData.photoUrl || studentData.photoUrl; // Keep existing photoUrl if not updated
        }
        
        await setDoc(studentDocRef, studentData, { merge: true });
        showCustomAlert("Profile updated successfully!", 'success');
        // Reload dashboard overview as name might have changed
        await loadDashboardOverview(user.uid);

      } catch (error) {
        console.error("Error updating profile:", error);
        showCustomAlert("Failed to update profile. Please try again.", 'error');
      } finally {
        loadingOverlay.classList.add('hidden');
      }
    });

    document.getElementById("profilePictureUpload").addEventListener("change", async (e) => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to upload a profile picture.", 'error');
            e.target.value = ''; // Clear file input
            return;
        }

        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 2 * 1024 * 1024) { // 2MB limit
            showCustomAlert("File size exceeds 2MB limit.", 'error');
            e.target.value = ''; // Clear file input
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const storageRef = ref(storage, `students/${user.uid}/profile.jpg`);
            await uploadBytes(storageRef, file);
            const photoUrl = await getDownloadURL(storageRef);

            // Update photoUrl in Firestore
            const studentDocRef = doc(db, "students", user.uid);
            await updateDoc(studentDocRef, { photoUrl: photoUrl });

            // Update preview
            document.getElementById("profilePicturePreview").src = photoUrl;
            showCustomAlert("Profile picture updated!", 'success');
        } catch (error) {
            console.error("Error uploading profile picture:", error);
            showCustomAlert("Failed to upload profile picture. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
            e.target.value = ''; // Clear file input after upload
        }
    });

    /**
     * Settings section functions
     */
    async function loadSettings(uid) {
        const studentDocRef = doc(db, "students", uid);
        const snap = await getDoc(studentDocRef);
        
        // Default values for settings
        let twoFactorEnabled = false;
        let notifyEmail = true;
        let notifyInApp = true;
        let notifySms = false;
        let showProfileToClassmates = true;

        if (snap.exists()) {
            const data = snap.data();
            twoFactorEnabled = data.twoFactorEnabled ?? false;
            notifyEmail = data.notificationPrefs?.email ?? true;
            notifyInApp = data.notificationPrefs?.inApp ?? true;
            notifySms = data.notificationPrefs?.sms ?? false;
            showProfileToClassmates = data.privacy?.showProfileToClassmates ?? true;
        }

        document.getElementById("twoFactorEnabled").checked = twoFactorEnabled;
        document.getElementById("notifyEmail").checked = notifyEmail;
        document.getElementById("notifyInApp").checked = notifyInApp;
        document.getElementById("notifySms").checked = notifySms;
        document.getElementById("showProfileToClassmates").checked = showProfileToClassmates;
    }

    settingsForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) return;

        loadingOverlay.classList.remove('hidden');
        try {
            const settingsData = {
                twoFactorEnabled: document.getElementById("twoFactorEnabled").checked,
                notificationPrefs: {
                    email: document.getElementById("notifyEmail").checked,
                    inApp: document.getElementById("notifyInApp").checked,
                    sms: document.getElementById("notifySms").checked,
                },
                privacy: {
                    showProfileToClassmates: document.getElementById("showProfileToClassmates").checked,
                }
            };

            const studentDocRef = doc(db, "students", user.uid);
            await updateDoc(studentDocRef, settingsData);
            showCustomAlert("Settings updated successfully!", 'success');

        } catch (error) {
            console.error("Error updating settings:", error);
            showCustomAlert("Failed to update settings. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    });

    // Change password
    window.changePassword = async () => {
        showCustomPrompt("Enter your new password:", async (newPass) => {
            if (newPass && auth.currentUser) {
                loadingOverlay.classList.remove('hidden');
                try {
                    await updatePassword(auth.currentUser, newPass);
                    showCustomAlert("Password updated successfully!", 'success');
                } catch (error) {
                    console.error("Error updating password:", error);
                    showCustomAlert(getFriendlyErrorMessage(error.code), 'error'); // Use friendly message
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            } else if (newPass === null) {
                showCustomAlert("Password change cancelled.", 'info');
            } else if (newPass === '') {
                showCustomAlert("Password cannot be empty.", 'error');
            }
        });
    };

    // Change Email
    document.getElementById("changeEmailBtn").addEventListener("click", async () => {
        showCustomPrompt("Enter your new email address:", async (newEmail) => {
            if (newEmail && auth.currentUser) {
                if (!/\S+@\S+\.\S+/.test(newEmail)) { // Basic email format validation
                    showCustomAlert("Please enter a valid email address.", 'error');
                    return;
                }

                loadingOverlay.classList.remove('hidden');
                try {
                    await updateEmail(auth.currentUser, newEmail);
                    // Update email in Firestore as well
                    const studentDocRef = doc(db, "students", auth.currentUser.uid);
                    await updateDoc(studentDocRef, { email: newEmail });
                    showCustomAlert(`Email updated to ${newEmail} successfully! Please verify your new email.`, 'success');
                    userEmailSpan.textContent = newEmail; // Update header email
                } catch (error) {
                    console.error("Error updating email:", error);
                    showCustomAlert(getFriendlyErrorMessage(error.code), 'error'); // Use friendly message
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            } else if (newEmail === null) {
                showCustomAlert("Email change cancelled.", 'info');
            } else if (newEmail === '') {
                showCustomAlert("Email cannot be empty.", 'error');
            }
        }, 'email', 'new_email@example.com'); // inputType 'email' and placeholder
    });


    // Delete Account
    document.getElementById("deleteAccountBtn").addEventListener("click", async () => {
        showCustomConfirm("Are you sure you want to delete your account? This action is irreversible and will remove all your data.", 'delete', async (confirmed) => {
            if (confirmed) {
                const user = auth.currentUser;
                if (!user) return;

                loadingOverlay.classList.remove('hidden');
                try {
                    // Delete student document from Firestore
                    const studentDocRef = doc(db, "students", user.uid);
                    await deleteDoc(studentDocRef);

                    // Delete user from Firebase Auth
                    await deleteUser(user);

                    showCustomAlert("Your account has been successfully deleted.", 'success', () => {
                        window.location.href = "login.html"; // Redirect after successful deletion
                    });
                } catch (error) {
                    console.error("Error deleting account:", error);
                    showCustomAlert(getFriendlyErrorMessage(error.code), 'error'); // Use friendly message
                    // If re-authentication is required for deletion, prompt user to re-login
                    if (error.code === 'auth/requires-recent-login') {
                        showCustomAlert('To delete your account, please log out and log in again, then try this action.', 'error');
                    }
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }
        });
    });

    /**
     * Course Registration section functions
     */
    async function initCourseRegistration(uid) {
        // Set default filter values
        document.getElementById('yearSelect').value = "1"; // Default to Year 1
        document.getElementById('semesterSelect').value = "1"; // Default to Semester 1
        await filterAndLoadCourses(); // Load courses based on defaults
        await displayRegisteredCoursesTable(uid); // Display currently registered courses
    }

    async function filterAndLoadCourses() {
        const user = auth.currentUser;
        if (!user) return;

        const year = document.getElementById('yearSelect').value;
        const semester = document.getElementById('semesterSelect').value;
        const availableCoursesList = document.getElementById('availableCoursesList');
        availableCoursesList.innerHTML = ''; // Clear previous list

        if (!year || !semester) {
            availableCoursesList.innerHTML = `<div class="empty-state">Please select both Year and Semester to load available courses.</div>`;
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const coursesQuery = query(
                collection(db, "courses"),
                where("year", "==", parseInt(year)),
                where("semester", "==", parseInt(semester))
            );
            const coursesSnap = await getDocs(coursesQuery);

            const studentDocRef = doc(db, "students", user.uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};
            const registeredCourseIds = new Set((studentData.registeredCourses || []).map(c => c.id));

            if (coursesSnap.empty) {
                availableCoursesList.innerHTML = `<div class="empty-state">No courses available for Year ${year}, Semester ${semester}.</div>`;
                return;
            }

            let coursesHtml = '';
            coursesSnap.forEach(docSnap => {
                const course = docSnap.data();
                const isChecked = registeredCourseIds.has(docSnap.id) ? 'checked' : '';
                coursesHtml += `
                    <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded-md shadow-sm">
                        <input type="checkbox" id="course-${docSnap.id}" data-id="${docSnap.id}" data-code="${course.code}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${isChecked}>
                        <label for="course-${docSnap.id}" class="text-sm font-medium text-gray-900">${course.code} ‚Äì ${course.title} (${course.credits} Credits)</label>
                    </div>
                `;
            });
            availableCoursesList.innerHTML = coursesHtml;

        } catch (error) {
            console.error("Error loading available courses:", error);
            showCustomAlert("Failed to load available courses. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function registerSelectedCourses() {
        const user = auth.currentUser;
        if (!user) return;

        loadingOverlay.classList.remove('hidden');
        try {
            const availableCoursesList = document.getElementById('availableCoursesList');
            const checkboxes = availableCoursesList.querySelectorAll('input[type="checkbox"]');
            const selectedCourses = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedCourses.push({
                        id: checkbox.dataset.id,
                        code: checkbox.dataset.code
                    });
                }
            });

            const studentDocRef = doc(db, "students", user.uid);
            await updateDoc(studentDocRef, { registeredCourses: selectedCourses });

            showCustomAlert("Course registration updated successfully!", 'success');
            await loadDashboardOverview(user.uid); // Update dashboard quick stats
            await displayRegisteredCoursesTable(user.uid); // Refresh registered courses table
            // Optionally, reload available courses to reflect new state
            await filterAndLoadCourses();

        } catch (error) {
            console.error("Error registering courses:", error);
            showCustomAlert("Failed to register courses. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function displayRegisteredCoursesTable(uid) {
        const registeredCoursesTableBody = document.getElementById('registeredCoursesTable');
        registeredCoursesTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading registered courses...</td></tr>`;

        loadingOverlay.classList.remove('hidden');
        try {
            const studentDocRef = doc(db, "students", uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};
            const registeredCourses = studentData.registeredCourses || [];

            if (registeredCourses.length === 0) {
                registeredCoursesTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">You haven‚Äôt registered for any courses yet.</td></tr>`;
                return;
            }

            let tableHtml = '';
            for (const registeredCourse of registeredCourses) {
                const courseDocRef = doc(db, "courses", registeredCourse.id);
                const courseSnap = await getDoc(courseDocRef);
                if (courseSnap.exists()) {
                    const courseData = courseSnap.data();
                    tableHtml += `
                        <tr>
                            <td class="p-2 border">${courseData.code}</td>
                            <td class="p-2 border">${courseData.title}</td>
                            <td class="p-2 border">${courseData.credits}</td>
                            <td class="p-2 border">${courseData.lecturer || 'N/A'}</td>
                            <td class="p-2 border">
                                <button data-id="${registeredCourse.id}" class="btn-red text-xs px-2 py-1" onclick="unregisterCourse(this)">Unregister</button>
                            </td>
                        </tr>
                    `;
                } else {
                    tableHtml += `
                        <tr>
                            <td class="p-2 border">${registeredCourse.code || 'N/A'}</td>
                            <td class="p-2 border" colspan="3">Course details not found.</td>
                            <td class="p-2 border">
                                <button data-id="${registeredCourse.id}" class="btn-red text-xs px-2 py-1" onclick="unregisterCourse(this)">Unregister</button>
                            </td>
                        </tr>
                    `;
                }
            }
            registeredCoursesTableBody.innerHTML = tableHtml;

        } catch (error) {
            console.error("Error displaying registered courses:", error);
            registeredCoursesTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading registered courses.</td></tr>`;
            showCustomAlert("Failed to load registered courses. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function unregisterCourse(buttonElement) {
        const user = auth.currentUser;
        if (!user) return;

        const courseIdToRemove = buttonElement.dataset.id;

        showCustomConfirm("Are you sure you want to unregister from this course?", 'delete', async (confirmed) => {
            if (confirmed) {
                loadingOverlay.classList.remove('hidden');
                try {
                    const studentDocRef = doc(db, "students", user.uid);
                    const studentSnap = await getDoc(studentDocRef);
                    const studentData = studentSnap.exists() ? studentSnap.data() : {};
                    let registeredCourses = studentData.registeredCourses || [];

                    // Filter out the course to unregister
                    registeredCourses = registeredCourses.filter(course => course.id !== courseIdToRemove);

                    await updateDoc(studentDocRef, { registeredCourses: registeredCourses });
                    showCustomAlert("Course unregistered successfully!", 'success');
                    await loadDashboardOverview(user.uid); // Update dashboard quick stats
                    await displayRegisteredCoursesTable(user.uid); // Refresh registered courses table
                    await filterAndLoadCourses(); // Refresh available courses as well
                } catch (error) {
                    console.error("Error unregistering course:", error);
                    showCustomAlert("Failed to unregister course. Please try again.", 'error');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }
        });
    }

    /**
     * Timetable section functions
     */

    async function initTimetableView(uid) {
        const studentDocRef = doc(db, "students", uid);
        const studentSnap = await getDoc(studentDocRef);
        const studentData = studentSnap.exists() ? studentSnap.data() : {};

        const yearSelect = document.getElementById('timetableYear');
        const semesterSelect = document.getElementById('timetableSemester');

        // Attempt to set filter to student's current year/semester from profile
        yearSelect.value = studentData.year ? String(studentData.year) : "1";
        semesterSelect.value = studentData.semester ? String(studentData.semester) : "1";

        // Now call the function to render the grid with initial filters
        await renderTimetableGrid(uid, yearSelect.value, semesterSelect.value);
    }

    // Handler for the "Load Timetable" button
    window.handleLoadTimetable = async () => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to view your timetable.", 'error');
            return;
        }
        const year = document.getElementById('timetableYear').value;
        const semester = document.getElementById('timetableSemester').value;
        await renderTimetableGrid(user.uid, year, semester);
    };

    async function renderTimetableGrid(uid, year, semester) {
        loadingOverlay.classList.remove('hidden');
        const timetableTableBody = document.getElementById('timetableTable');
        timetableTableBody.innerHTML = ''; // Clear existing timetable

        try {
            const user = auth.currentUser;
            if (!user) {
                showCustomAlert("Please log in to view your timetable.", 'error');
                return;
            }

            const studentDocRef = doc(db, "students", uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};
            const registeredCourseCodes = new Set((studentData.registeredCourses || []).map(c => c.code));

            if (registeredCourseCodes.size === 0) {
                timetableTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">Please register courses to view your timetable.</td></tr>`;
                return;
            }

            if (!year || !semester) {
                timetableTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">Select year and semester to load timetable.</td></tr>`;
                return;
            }

            const timetableQuery = query(
                collection(db, "timetable"),
                where("year", "==", parseInt(year)),
                where("semester", "==", parseInt(semester))
            );
            const timetableSnap = await getDocs(timetableQuery);

            if (timetableSnap.empty) {
                timetableTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No timetable published yet for Year ${year}, Semester ${semester}.</td></tr>`;
                return;
            }

            const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            const timeSlots = [
                "08:00-10:00", "10:00-12:00", "12:00-14:00",
                "14:00-16:00", "16:00-18:00"
            ];

            // Create a map to easily place courses into the grid
            const grid = {};
            timeSlots.forEach(slot => {
                grid[slot] = {};
                daysOfWeek.forEach(day => {
                    grid[slot][day] = []; // Array to handle multiple courses in one slot/day
                });
            });

            timetableSnap.forEach(docSnap => {
                const classData = docSnap.data();
                // Check if student is registered for this course
                if (registeredCourseCodes.has(classData.courseCode)) {
                    const classDay = classData.day;
                    const classStartTime = classData.startTime;
                    const classEndTime = classData.endTime;
                    const classSlot = `${classStartTime}-${classEndTime}`;

                    if (daysOfWeek.includes(classDay) && timeSlots.includes(classSlot)) {
                        const courseInfo = `${classData.courseCode} (${classData.venue}, ${classData.lecturer || 'N/A'})`;
                        grid[classSlot][classDay].push(courseInfo);
                    }
                }
            });

            let tableHtml = '';
            timeSlots.forEach(slot => {
                tableHtml += `<tr><td class="p-2 border font-semibold">${slot}</td>`;
                daysOfWeek.forEach(day => {
                    const classesInSlot = grid[slot][day];
                    if (classesInSlot.length > 0) {
                        tableHtml += `<td class="p-2 border text-sm">${classesInSlot.join('<br>')}</td>`;
                    } else {
                        tableHtml += `<td class="p-2 border text-gray-400 text-sm"></td>`; // Empty slot
                    }
                });
                tableHtml += `</tr>`;
            });
            timetableTableBody.innerHTML = tableHtml;

        } catch (error) {
            console.error("Error rendering timetable:", error);
            showCustomAlert("Failed to load timetable. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }


    /**
     * Grades section functions
     */

    let allGrades = []; // Store all grades for CGPA and transcript generation

    async function initGradesView(uid) {
        const studentDocRef = doc(db, "students", uid);
        const studentSnap = await getDoc(studentDocRef);
        const studentData = studentSnap.exists() ? studentSnap.data() : {};

        const yearSelect = document.getElementById('gradesYear');
        const semesterSelect = document.getElementById('gradesSemester');

        // Attempt to set filter to student's current year/semester from profile
        yearSelect.value = studentData.year ? String(studentData.year) : "1"; // Default to Year 1
        semesterSelect.value = studentData.semester ? String(studentData.semester) : "1"; // Default to Semester 1

        await handleLoadGrades(); // Load grades based on defaults
    }

    window.handleLoadGrades = async () => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to view your grades.", 'error');
            return;
        }

        const year = document.getElementById('gradesYear').value;
        const semester = document.getElementById('gradesSemester').value;

        await loadGradesTable(user.uid, year, semester);
    };

    async function loadGradesTable(uid, year, semester) {
        loadingOverlay.classList.remove('hidden');
        const gradesTableBody = document.getElementById('gradesTable');
        gradesTableBody.innerHTML = ''; // Clear existing grades

        const semesterGpaElement = document.getElementById('semesterGpa');
        const cumulativeGpaElement = document.getElementById('cumulativeGpa');
        semesterGpaElement.textContent = 'Semester GPA: N/A';
        cumulativeGpaElement.textContent = 'Cumulative GPA: N/A';

        try {
            if (!year || !semester) {
                gradesTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">Select year and semester to load grades.</td></tr>`;
                return;
            }

            const gradesQuery = query(
                collection(db, `grades/${uid}/results`),
                where("year", "==", parseInt(year)),
                where("semester", "==", parseInt(semester))
            );
            const gradesSnap = await getDocs(gradesQuery);

            let semesterTotalPoints = 0;
            let semesterTotalCredits = 0;
            const currentSemesterGrades = [];

            if (gradesSnap.empty) {
                gradesTableBody.innerHTML = `<div class="empty-state">No grades available for Year ${year}, Semester ${semester}.</div>`;
            } else {
                let tableHtml = '';
                gradesSnap.forEach(docSnap => {
                    const grade = docSnap.data();
                    currentSemesterGrades.push(grade); // Store for semester GPA calculation
                    semesterTotalPoints += grade.gpaPoints || 0;
                    semesterTotalCredits += grade.credits || 0;

                    tableHtml += `
                        <tr>
                            <td class="p-2 border">${grade.courseCode || 'N/A'}</td>
                            <td class="p-2 border">${grade.courseTitle || 'N/A'}</td>
                            <td class="p-2 border">${grade.credits || 'N/A'}</td>
                            <td class="p-2 border">${grade.grade || 'N/A'}</td>
                            <td class="p-2 border">${grade.gpaPoints || 'N/A'}</td>
                            <td class="p-2 border">${grade.lecturer || 'N/A'}</td>
                        </tr>
                    `;
                });
                gradesTableBody.innerHTML = tableHtml;

                const semesterGPA = semesterTotalCredits > 0 ? (semesterTotalPoints / semesterTotalCredits).toFixed(2) : '0.00';
                semesterGpaElement.textContent = `Semester GPA: ${semesterGPA}`;
            }

            // Calculate and display Cumulative GPA
            await calculateCumulativeGPA(uid);

        } catch (error) {
            console.error("Error loading grades:", error);
            gradesTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error loading grades.</td></tr>`;
            showCustomAlert("Failed to load grades. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function calculateCumulativeGPA(uid) {
        let totalPoints = 0;
        let totalCredits = 0;

        // Fetch ALL grades for the student
        const allGradesQuery = query(collection(db, `grades/${uid}/results`));
        const allGradesSnap = await getDocs(allGradesQuery);

        allGrades = []; // Reset global array
        if (!allGradesSnap.empty) {
            allGradesSnap.forEach(docSnap => {
                const grade = docSnap.data();
                allGrades.push(grade); // Store all grades globally for transcript
                totalPoints += grade.gpaPoints || 0;
                totalCredits += grade.credits || 0;
            });
        }

        const cumulativeGPA = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : '0.00';
        document.getElementById('cumulativeGpa').textContent = `Cumulative GPA: ${cumulativeGPA}`;
    }

    window.downloadTranscript = async () => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to download your transcript.", 'error');
            return;
        }

        if (allGrades.length === 0) {
            showCustomAlert("No grades available to generate a transcript.", 'info');
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Fetch student profile for transcript header
            const studentDocRef = doc(db, "students", user.uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};

            const studentName = studentData.name || user.email;
            const admissionNo = studentData.admissionNo || 'N/A';
            const program = studentData.program || 'N/A';
            const cumulativeGpaText = document.getElementById('cumulativeGpa').textContent.replace('Cumulative GPA: ', '');


            // Header
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Academic Transcript", 105, 20, { align: "center" });

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Student Name: ${studentName}`, 20, 35);
            doc.text(`Admission No: ${admissionNo}`, 20, 42);
            doc.text(`Program: ${program}`, 20, 49);
            doc.text(`Date Printed: ${new Date().toLocaleDateString()}`, 170, 49, { align: "right" });

            // Grades Table
            const headers = [["Course Code", "Course Title", "Credits", "Grade", "Points", "Lecturer"]];
            const data = allGrades.map(grade => [
                grade.courseCode || '',
                grade.courseTitle || '',
                grade.credits || '',
                grade.grade || '',
                grade.gpaPoints || '',
                grade.lecturer || ''
            ]);

            doc.autoTable({
                startY: 60,
                head: headers,
                body: data,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold' },
                theme: 'grid'
            });

            // Summary
            let finalY = doc.lastAutoTable.finalY || 60; // Get final Y position of table
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text(`Overall Cumulative GPA: ${cumulativeGpaText}`, 20, finalY + 15);

            doc.save(`${studentName}_Transcript.pdf`);
            showCustomAlert("Transcript downloaded successfully!", 'success');

        } catch (error) {
            console.error("Error generating transcript:", error);
            showCustomAlert("Failed to generate transcript. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };


    /**
     * Exam Card section functions
     */

    let currentStudentData = null; // Store student data for PDF generation

    async function initExamCardView(uid) {
        loadingOverlay.classList.remove('hidden');
        try {
            await loadExamCardInfo(uid);
            await loadExamCoursesTable(uid);
            await checkFinanceClearance(uid);
        } catch (error) {
            console.error("Error initializing Exam Card view:", error);
            showCustomAlert("Failed to load Exam Card details. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function loadExamCardInfo(uid) {
        const studentDocRef = doc(db, "students", uid);
        const studentSnap = await getDoc(studentDocRef);
        
        if (studentSnap.exists()) {
            currentStudentData = studentSnap.data(); // Store for later PDF generation
            document.getElementById('examName').textContent = currentStudentData.name || 'N/A';
            document.getElementById('examAdmNo').textContent = currentStudentData.admissionNo || 'N/A';
            document.getElementById('examProgram').textContent = currentStudentData.program || 'N/A';
            const yearSem = (currentStudentData.year && currentStudentData.semester) ? `Year ${currentStudentData.year}, Semester ${currentStudentData.semester}` : 'N/A';
            document.getElementById('examYearSem').textContent = yearSem;
        } else {
            document.getElementById('examCardInfo').innerHTML = `<p class="text-red-600">Student profile not found. Please update your profile.</p>`;
            currentStudentData = null;
        }
    }

    async function loadExamCoursesTable(uid) {
        const examCoursesTableBody = document.getElementById('examCoursesTable');
        examCoursesTableBody.innerHTML = ''; // Clear existing content

        if (!currentStudentData || !currentStudentData.registeredCourses || currentStudentData.registeredCourses.length === 0) {
            examCoursesTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">You must register for courses before generating an exam card.</td></tr>`;
            return;
        }

        let tableHtml = '';
        let hasExamSchedule = false;

        for (const registeredCourse of currentStudentData.registeredCourses) {
            const courseDocRef = doc(db, "courses", registeredCourse.id);
            const courseSnap = await getDoc(courseDocRef);
            
            let courseData = { code: registeredCourse.code || 'N/A', title: 'Course not found', credits: 'N/A', lecturer: 'N/A' };
            if (courseSnap.exists()) {
                courseData = courseSnap.data();
            }

            // Fetch exam schedule based on courseCode
            const examScheduleQuery = query(
                collection(db, "examSchedule"),
                where("courseCode", "==", courseData.code)
            );
            const examScheduleSnap = await getDocs(examScheduleQuery);

            let examVenue = 'N/A';
            let examDate = 'N/A';

            if (!examScheduleSnap.empty) {
                const examData = examScheduleSnap.docs[0].data(); // Assuming one exam per courseCode
                examVenue = examData.venue || 'TBD';
                examDate = examData.date ? new Date(examData.date).toLocaleDateString() : 'TBD';
                hasExamSchedule = true;
            }

            tableHtml += `
                <tr>
                    <td class="p-2 border">${courseData.code}</td>
                    <td class="p-2 border">${courseData.title}</td>
                    <td class="p-2 border">${courseData.credits}</td>
                    <td class="p-2 border">${courseData.lecturer || 'N/A'}</td>
                    <td class="p-2 border">${examVenue}</td>
                    <td class="p-2 border">${examDate}</td>
                </tr>
            `;
        }

        examCoursesTableBody.innerHTML = tableHtml;

        if (!hasExamSchedule && currentStudentData.registeredCourses.length > 0) {
            showCustomAlert("Exam schedule not fully published yet for your registered courses. Some exam dates/venues might be missing.", 'info');
        }
    }

    async function checkFinanceClearance(uid) {
        const examStatusDiv = document.getElementById('examStatus');
        examStatusDiv.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'border-red-400', 'border-green-400');
        examStatusDiv.classList.add('bg-gray-100', 'border-gray-300', 'text-gray-700');
        examStatusDiv.textContent = 'Checking finance clearance...';

        try {
            const financeDocRef = doc(db, `finance/${uid}/balance`);
            const financeSnap = await getDoc(financeDocRef);

            if (financeSnap.exists()) {
                const balance = financeSnap.data().amount || 0;
                if (balance > 0) {
                    examStatusDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> You have an outstanding balance of KES ${Number(balance).toLocaleString()}. Exam Card may be invalid until cleared.`;
                    examStatusDiv.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-700');
                    examStatusDiv.classList.add('bg-red-100', 'text-red-700', 'border-red-400');
                } else {
                    examStatusDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Eligible for exams. Your finance is cleared.`;
                    examStatusDiv.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-700');
                    examStatusDiv.classList.add('bg-green-100', 'text-green-700', 'border-green-400');
                }
            } else {
                examStatusDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i> Finance clearance status unknown ‚Äì please contact admin.`;
                examStatusDiv.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-700');
                examStatusDiv.classList.add('bg-yellow-100', 'text-yellow-700', 'border-yellow-400');
            }
        } catch (error) {
            console.error("Error checking finance clearance:", error);
            examStatusDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> Error checking finance clearance. Please try again.`;
            examStatusDiv.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-700');
            examStatusDiv.classList.add('bg-red-100', 'text-red-700', 'border-red-400');
        }
    }

    window.downloadExamCard = async () => {
        const user = auth.currentUser;
        if (!user || !currentStudentData) {
            showCustomAlert("Student data not loaded. Please try viewing the Exam Card first.", 'error');
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // University Header (Placeholder Logo)
            const universityLogo = "https://placehold.co/50x50/0d6efd/ffffff?text=U"; // Example placeholder logo
            doc.addImage(universityLogo, 'PNG', 15, 10, 20, 20);

            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("Prince Alex Design University", 40, 18);
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("Examination Card", 40, 25);
            
            const yearSemText = (currentStudentData.year && currentStudentData.semester) ? `Semester ${currentStudentData.semester}, Year ${currentStudentData.year}` : 'Current Semester/Year';
            doc.text(`Academic Period: ${yearSemText}`, 40, 32);


            let yPos = 45; // Starting Y position for student info

            // Student Information
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("Student Information:", 15, yPos);
            yPos += 7;
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${currentStudentData.name || 'N/A'}`, 15, yPos); yPos += 5;
            doc.text(`Admission No: ${currentStudentData.admissionNo || 'N/A'}`, 15, yPos); yPos += 5;
            doc.text(`Program: ${currentStudentData.program || 'N/A'}`, 15, yPos); yPos += 5;
            doc.text(`Year / Semester: ${yearSemText}`, 15, yPos); yPos += 10;

            // Exam Courses Table
            const headers = [["Code", "Title", "Credits", "Lecturer", "Venue", "Date"]];
            const tableData = [];

            if (currentStudentData.registeredCourses && currentStudentData.registeredCourses.length > 0) {
                for (const registeredCourse of currentStudentData.registeredCourses) {
                    const courseDocRef = doc(db, "courses", registeredCourse.id);
                    const courseSnap = await getDoc(courseDocRef);
                    
                    let courseData = { code: registeredCourse.code || 'N/A', title: 'Course not found', credits: 'N/A', lecturer: 'N/A' };
                    if (courseSnap.exists()) {
                        courseData = courseSnap.data();
                    }

                    const examScheduleQuery = query(
                        collection(db, "examSchedule"),
                        where("courseCode", "==", courseData.code)
                    );
                    const examScheduleSnap = await getDocs(examScheduleQuery);

                    let examVenue = 'N/A';
                    let examDate = 'N/A';

                    if (!examScheduleSnap.empty) {
                        const examData = examScheduleSnap.docs[0].data();
                        examVenue = examData.venue || 'TBD';
                        examDate = examData.date ? new Date(examData.date).toLocaleDateString() : 'TBD';
                    }
                    tableData.push([
                        courseData.code,
                        courseData.title,
                        courseData.credits,
                        courseData.lecturer || 'N/A',
                        examVenue,
                        examDate
                    ]);
                }
            } else {
                tableData.push([{ content: "No registered courses found for this student.", colSpan: 6, styles: { fontStyle: 'italic', textColor: [150,150,150] }}]);
            }

            doc.autoTable({
                startY: yPos,
                head: headers,
                body: tableData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold' },
                theme: 'grid',
                margin: { left: 15, right: 15 }
            });

            // Finance Status
            let finalY = doc.lastAutoTable.finalY || yPos;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("Finance Clearance Status:", 15, finalY + 10);
            const financeStatus = document.getElementById('examStatus').textContent;
            doc.setFont("helvetica", "normal");
            doc.text(financeStatus, 15, finalY + 17);

            // Footer
            finalY = Math.max(finalY + 30, doc.internal.pageSize.height - 30); // Ensure footer is at bottom
            doc.setFontSize(10);
            doc.text("_________________________", 15, finalY);
            doc.setFont("helvetica", "bold");
            doc.text("Authorized Signature", 15, finalY + 7);
            doc.setFont("helvetica", "normal");
            doc.text("Registrar", 15, finalY + 12);

            doc.save(`${currentStudentData.name || 'Student'}_ExamCard.pdf`);
            showCustomAlert("Exam Card downloaded successfully!", 'success');

        } catch (error) {
            console.error("Error generating Exam Card PDF:", error);
            showCustomAlert("Failed to generate Exam Card PDF. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };


    /**
     * Graduation request functions
     */

    async function initGraduationView(uid) {
        const graduationContentDiv = document.getElementById('graduationContent');
        graduationContentDiv.innerHTML = `<div class="empty-state">Loading graduation status...</div>`; // Initial loading state

        loadingOverlay.classList.remove('hidden');
        try {
            const studentDocRef = doc(db, "students", uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};

            const graduationRequestDocRef = doc(db, "graduations", uid);
            const graduationRequestSnap = await getDoc(graduationRequestDocRef);

            if (graduationRequestSnap.exists()) {
                // If a request exists, show the status card
                const requestData = graduationRequestSnap.data();
                const statusBadgeClass = {
                    "Pending": "pending",
                    "Approved": "approved",
                    "Rejected": "rejected"
                }[requestData.status] || "pending"; // Default to pending if status is unexpected

                const dateSubmitted = requestData.dateSubmitted ? new Date(requestData.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';

                let uploadedDocsHtml = '';
                if (requestData.clearanceFormUrl) {
                    uploadedDocsHtml += `<li><i class="fas fa-file-pdf mr-2 text-red-500"></i> <a href="${requestData.clearanceFormUrl}" target="_blank">Clearance Form</a></li>`;
                }
                if (requestData.feeClearanceProofUrl) {
                    uploadedDocsHtml += `<li><i class="fas fa-receipt mr-2 text-green-500"></i> <a href="${requestData.feeClearanceProofUrl}" target="_blank">Fee Clearance Proof</a></li>`;
                }
                if (uploadedDocsHtml === '') {
                    uploadedDocsHtml = '<li>No documents uploaded.</li>';
                }

                graduationContentDiv.innerHTML = `
                    <div id="graduationStatusCard" class="graduation-status-card">
                        <h4 class="text-xl font-bold text-blue-800 flex items-center"><i class="fas fa-info-circle mr-3"></i> Your Graduation Request Status</h4>
                        
                        <p class="text-gray-700"><strong>Submission Date:</strong> <span id="statusDateSubmitted">${dateSubmitted}</span></p>
                        <p class="text-gray-700"><strong>Admission No:</strong> <span id="statusAdmNo">${requestData.admissionNo || studentData.admissionNo || 'N/A'}</span></p>
                        <p class="text-gray-700"><strong>Program:</strong> <span id="statusProgram">${requestData.program || studentData.program || 'N/A'}</span></p>
                        
                        <div class="flex items-center text-lg font-semibold">
                            <span class="mr-2">Status:</span>
                            <span id="statusBadge" class="status-badge ${statusBadgeClass}">${requestData.status}</span>
                        </div>

                        <div id="adminCommentsSection" class="admin-comments ${requestData.comments ? '' : 'hidden'}">
                            <p class="font-semibold text-gray-800">Admin Comments:</p>
                            <p id="statusComments" class="text-gray-600 italic">${requestData.comments || ''}</p>
                        </div>

                        <div id="uploadedDocumentsSection" class="space-y-2 pt-4 border-t border-blue-200 mt-4">
                            <p class="font-semibold text-gray-800">Uploaded Documents:</p>
                            <ul id="uploadedDocsList" class="uploaded-docs-list">
                                ${uploadedDocsHtml}
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                // If no request exists, show the form
                const studentName = studentData.name || 'N/A';
                const admissionNo = studentData.admissionNo || 'Not assigned yet';
                const program = studentData.program || 'N/A';
                const yearSem = (studentData.year && studentData.semester) ? `Year ${studentData.year}, Semester ${studentData.semester}` : 'N/A';

                graduationContentDiv.innerHTML = `
                    <form id="graduationForm" class="space-y-6">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-800">
                            <p class="font-semibold mb-2">Your Details (from Profile):</p>
                            <p><strong>Name:</strong> <span id="gradName">${studentName}</span></p>
                            <p><strong>Admission No:</strong> <span id="gradAdmNo">${admissionNo}</span></p>
                            <p><strong>Program:</strong> <span id="gradProgram">${program}</span></p>
                            <p><strong>Year / Semester:</strong> <span id="gradYearSem">${yearSem}</span></p>
                        </div>

                        <h4 class="font-semibold text-blue-500 mt-4 mb-2">Confirm Requirements</h4>
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="confirmGrad" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="confirmGrad" class="ml-2 block text-sm text-gray-900">I confirm I have met all graduation requirements.</label>
                        </div>

                        <h4 class="font-semibold text-blue-500 mt-4 mb-2">Upload Supporting Documents (Optional)</h4>
                        <div class="space-y-3">
                            <div>
                                <label for="clearanceFormUpload" class="block text-sm font-medium text-gray-700">Upload Clearance Form (PDF):</label>
                                <input type="file" id="clearanceFormUpload" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                <span id="clearanceFormStatus" class="text-xs text-gray-500">No file selected.</span>
                            </div>
                            <div>
                                <label for="feeClearanceProofUpload" class="block text-sm font-medium text-gray-700">Upload Proof of Fee Clearance (PDF, JPG, PNG):</label>
                                <input type="file" id="feeClearanceProofUpload" accept=".pdf,.jpg,.png" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                <span id="feeClearanceProofStatus" class="text-xs text-gray-500">No file selected.</span>
                            </div>
                        </div>

                        <button type="submit" class="btn-red mt-6 w-full sm:w-auto"><i class="fas fa-paper-plane mr-2"></i> Submit Graduation Request</button>
                    </form>
                `;
                // Add event listeners after rendering the form
                document.getElementById('graduationForm').addEventListener('submit', submitGraduationRequest);
                document.getElementById('clearanceFormUpload').addEventListener('change', (e) => {
                    document.getElementById('clearanceFormStatus').textContent = e.target.files[0] ? e.target.files[0].name : 'No file selected.';
                });
                document.getElementById('feeClearanceProofUpload').addEventListener('change', (e) => {
                    document.getElementById('feeClearanceProofStatus').textContent = e.target.files[0] ? e.target.files[0].name : 'No file selected.';
                });
            }
        } catch (error) {
            console.error("Error loading graduation view:", error);
            graduationContentDiv.innerHTML = `<div class="empty-state text-red-600">Error loading graduation details. Please try again.</div>`;
            showCustomAlert("Failed to load graduation details. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function uploadFile(file, uid, folder, fileNamePrefix) {
        if (!file) return null;
        const filePath = `students/${uid}/graduation/${folder}/${fileNamePrefix}_${Date.now()}_${file.name}`;
        const storageRef = ref(storage, filePath);
        await uploadBytes(storageRef, file);
        return await getDownloadURL(storageRef);
    }

    async function submitGraduationRequest(event) {
        event.preventDefault();
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to submit a graduation request.", 'error');
            return;
        }

        const confirmGrad = document.getElementById('confirmGrad').checked;
        if (!confirmGrad) {
            showCustomAlert("You must confirm that you have met all graduation requirements.", 'info');
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const studentDocRef = doc(db, "students", user.uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};

            const admissionNo = studentData.admissionNo || 'N/A';
            const program = studentData.program || 'N/A';

            const clearanceFormFile = document.getElementById('clearanceFormUpload').files[0];
            const feeClearanceProofFile = document.getElementById('feeClearanceProofUpload').files[0];

            let clearanceFormUrl = null;
            let feeClearanceProofUrl = null;

            if (clearanceFormFile) {
                clearanceFormUrl = await uploadFile(clearanceFormFile, user.uid, 'clearance_forms', 'clearance');
            }
            if (feeClearanceProofFile) {
                feeClearanceProofUrl = await uploadFile(feeClearanceProofFile, user.uid, 'fee_proofs', 'fee_clearance');
            }

            const graduationRequestData = {
                admissionNo: admissionNo,
                program: program,
                dateSubmitted: serverTimestamp(),
                status: "Pending", // Initial status
                comments: "", // Admin comments start empty
                clearanceFormUrl: clearanceFormUrl,
                feeClearanceProofUrl: feeClearanceProofUrl
            };

            const graduationDocRef = doc(db, "graduations", user.uid);
            await setDoc(graduationDocRef, graduationRequestData);

            showCustomAlert("Graduation request submitted successfully! You can track its status here.", 'success', () => {
                initGraduationView(user.uid); // Reload view to show status card
            });

        } catch (error) {
            console.error("Error submitting graduation request:", error);
            showCustomAlert("Failed to submit graduation request. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    /**
     * Clearance request functions
     */

    const clearanceDepartments = [
        { id: 'finance', name: 'Finance Department' },
        { id: 'library', name: 'Library Services' },
        { id: 'hostel', name: 'Hostel Administration' },
        { id: 'dean', name: 'Dean\'s Office' }
    ];

    async function initClearanceView(uid) {
        const clearanceContentDiv = document.getElementById('clearanceContent');
        clearanceContentDiv.innerHTML = `<div class="empty-state">Loading clearance status...</div>`; // Initial loading state

        loadingOverlay.classList.remove('hidden');
        try {
            const studentDocRef = doc(db, "students", uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};

            const clearanceRequestDocRef = doc(db, "clearances", uid);
            const clearanceRequestSnap = await getDoc(clearanceRequestDocRef);

            if (clearanceRequestSnap.exists()) {
                // If a request exists, show the status tracking table
                const requestData = clearanceRequestSnap.data();
                renderClearanceStatus(requestData, studentData);
            } else {
                // If no request exists, show the form
                const studentName = studentData.name || 'N/A';
                const admissionNo = studentData.admissionNo || 'Not assigned yet';
                const program = studentData.program || 'N/A';
                
                clearanceContentDiv.innerHTML = `
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-800 mb-4">
                        <p class="font-semibold mb-2">Your Details (from Profile):</p>
                        <p><strong>Name:</strong> <span id="clearanceStudentName">${studentName}</span></p>
                        <p><strong>Admission No:</strong> <span id="clearanceAdmNo">${admissionNo}</span></p>
                        <p><strong>Program:</strong> <span id="clearanceProgram">${program}</span></p>
                    </div>
                    <form id="clearanceForm" class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="confirmClear" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="confirmClear" class="ml-2 block text-sm text-gray-900">I confirm I have returned all items and cleared all dues with all departments.</label>
                        </div>
                        <button type="submit" class="btn-red w-full sm:w-auto"><i class="fas fa-paper-plane mr-2"></i> Submit Clearance Request</button>
                    </form>
                `;
                document.getElementById('clearanceForm').addEventListener('submit', submitClearanceRequest);
            }
        } catch (error) {
            console.error("Error loading clearance view:", error);
            clearanceContentDiv.innerHTML = `<div class="empty-state text-red-600">Error loading clearance details. Please try again.</div>`;
            showCustomAlert("Failed to load clearance details. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function submitClearanceRequest(event) {
        event.preventDefault();
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to submit a clearance request.", 'error');
            return;
        }

        const confirmClear = document.getElementById('confirmClear').checked;
        if (!confirmClear) {
            showCustomAlert("You must confirm that you have returned all items and cleared all dues.", 'info');
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const studentDocRef = doc(db, "students", user.uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};

            const initialApprovals = {};
            clearanceDepartments.forEach(dept => {
                initialApprovals[dept.id] = { status: "Pending", comments: "" };
            });

            const clearanceRequestData = {
                admissionNo: studentData.admissionNo || 'N/A',
                dateSubmitted: serverTimestamp(),
                approvals: initialApprovals,
                overallStatus: "Pending" // Initial overall status
            };

            const clearanceDocRef = doc(db, "clearances", user.uid);
            await setDoc(clearanceDocRef, clearanceRequestData);

            showCustomAlert("Clearance request submitted successfully! You can track its status here.", 'success', () => {
                initClearanceView(user.uid); // Reload view to show status card
            });

        } catch (error) {
            console.error("Error submitting clearance request:", error);
            showCustomAlert("Failed to submit clearance request. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    function renderClearanceStatus(clearanceData, studentData) {
        const clearanceContentDiv = document.getElementById('clearanceContent');
        const departments = clearanceDepartments; // Use the defined departments

        let allApproved = true;
        let anyRejected = false;

        let tableRowsHtml = '';
        departments.forEach(dept => {
            const approval = clearanceData.approvals[dept.id] || { status: "Pending", comments: "" };
            const status = approval.status;
            const comments = approval.comments;

            if (status !== "Approved") {
                allApproved = false;
            }
            if (status === "Rejected") {
                anyRejected = true;
            }

            const statusIcon = status === "Approved" ? '<i class="fas fa-check-circle text-green-500 mr-1"></i>' :
                               status === "Rejected" ? '<i class="fas fa-times-circle text-red-500 mr-1"></i>' :
                               '<i class="fas fa-hourglass-half text-yellow-500 mr-1"></i>';
            const statusClass = status.toLowerCase();

            tableRowsHtml += `
                <tr>
                    <td class="p-2 border">${dept.name}</td>
                    <td class="p-2 border text-center"><span class="status-badge ${statusClass}">${statusIcon} ${status}</span></td>
                    <td class="p-2 border department-comment">${comments || 'No comments'}</td>
                </tr>
            `;
        });

        let overallStatus = "Pending";
        let overallStatusClass = "pending";
        if (anyRejected) {
            overallStatus = "Rejected";
            overallStatusClass = "rejected";
        } else if (allApproved) {
            overallStatus = "Approved";
            overallStatusClass = "approved";
        }

        const dateSubmitted = clearanceData.dateSubmitted ? new Date(clearanceData.dateSubmitted.seconds * 1000).toLocaleDateString() : 'N/A';

        clearanceContentDiv.innerHTML = `
            <div id="clearanceStatusCard" class="clearance-status-card">
                <h4 class="text-xl font-bold text-green-700 flex items-center mb-3"><i class="fas fa-clipboard-check mr-3"></i> Your Clearance Request Status</h4>
                <p><strong>Admission No:</strong> ${clearanceData.admissionNo || studentData.admissionNo || 'N/A'}</p>
                <p class="mb-4"><strong>Date Submitted:</strong> ${dateSubmitted}</p>

                <h5 class="font-semibold text-green-600 mb-2">Departmental Approvals</h5>
                <div class="overflow-x-auto mb-4">
                    <table class="w-full border-collapse border mt-2">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border text-left">Department</th>
                                <th class="p-2 border text-center">Status</th>
                                <th class="p-2 border text-left">Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRowsHtml}
                        </tbody>
                    </table>
                </div>

                <p id="clearanceOverall" class="mt-3 text-lg font-bold flex items-center">
                    Overall Clearance Status: <span class="status-badge ${overallStatusClass} ml-2">${overallStatus}</span>
                </p>
                <div class="mt-4">
                  <button type="button" onclick="initClearanceView(auth.currentUser.uid)" class="btn-red w-full sm:w-auto"><i class="fas fa-sync-alt mr-2"></i> Refresh Status</button>
                </div>
            </div>
        `;
    }

    /**
     * Finance section functions
     */

    let financeTransactionsData = []; // Global variable to store transactions for PDF

    async function initFinanceView(uid) {
        loadingOverlay.classList.remove('hidden');
        try {
            await loadFinanceSummary(uid);
            await loadFinanceTransactions(uid);
            await loadUpcomingFeeDeadlines();
        } catch (error) {
            console.error("Error initializing Finance view:", error);
            showCustomAlert("Failed to load finance details. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function loadFinanceSummary(uid) {
        const totalFeesElement = document.getElementById('totalFees');
        const totalPaidElement = document.getElementById('totalPaid');
        const balanceElement = document.getElementById('balance');
        const financeStatusMessageDiv = document.getElementById('financeStatusMessage');

        totalFeesElement.textContent = 'KES Loading...';
        totalPaidElement.textContent = 'KES Loading...';
        balanceElement.textContent = 'KES Loading...';
        financeStatusMessageDiv.textContent = 'Loading finance status...';
        financeStatusMessageDiv.classList.remove('cleared', 'pending');


        try {
            const financeDocRef = doc(db, `finance/${uid}/balance`); // Assuming summary is in a 'balance' doc
            const financeSnap = await getDoc(financeDocRef);

            let totalFees = 0;
            let totalPaid = 0;
            let outstandingBalance = 0;

            if (financeSnap.exists()) {
                const data = financeSnap.data();
                totalFees = data.totalFees || 0;
                totalPaid = data.totalPaid || 0;
                outstandingBalance = data.amount || (totalFees - totalPaid); // Use 'amount' as balance, or calculate
            } else {
                financeStatusMessageDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i> No financial records found yet.`;
                financeStatusMessageDiv.classList.add('pending'); // Treat as pending if no records
            }

            totalFeesElement.textContent = `KES ${totalFees.toLocaleString()}`;
            totalPaidElement.textContent = `KES ${totalPaid.toLocaleString()}`;
            balanceElement.textContent = `KES ${outstandingBalance.toLocaleString()}`;

            if (outstandingBalance <= 0) {
                financeStatusMessageDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i> You have cleared all your fees. ‚úÖ`;
                financeStatusMessageDiv.classList.remove('pending');
                financeStatusMessageDiv.classList.add('cleared');
            } else {
                financeStatusMessageDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> You have an outstanding balance. ‚ö†Ô∏è`;
                financeStatusMessageDiv.classList.remove('cleared');
                financeStatusMessageDiv.classList.add('pending');
            }

        } catch (error) {
            console.error("Error loading finance summary:", error);
            showCustomAlert("Failed to load fees summary. Please try again.", 'error');
            totalFeesElement.textContent = 'KES Error';
            totalPaidElement.textContent = 'KES Error';
            balanceElement.textContent = 'KES Error';
            financeStatusMessageDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> Error loading finance summary.`;
            financeStatusMessageDiv.classList.add('pending');
        }
    }

    async function loadFinanceTransactions(uid) {
        const financeTableBody = document.getElementById('financeTable');
        financeTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading transactions...</td></tr>`;
        financeTransactionsData = []; // Clear previous data

        try {
            const transactionsCollectionRef = collection(db, `finance/${uid}/transactions`);
            const transactionsQuery = query(transactionsCollectionRef, orderBy("date", "desc"));
            const transactionsSnap = await getDocs(transactionsQuery);

            if (transactionsSnap.empty) {
                financeTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions recorded yet.</td></tr>`;
                return;
            }

            let tableHtml = '';
            transactionsSnap.forEach(docSnap => {
                const txn = docSnap.data();
                financeTransactionsData.push(txn); // Store for PDF
                const txnDate = txn.date ? new Date(txn.date.seconds * 1000).toLocaleDateString() : 'N/A';
                const amount = `KES ${Number(txn.amount || 0).toLocaleString()}`;
                const balance = `KES ${Number(txn.balance || 0).toLocaleString()}`; // Assuming balance is stored per transaction

                tableHtml += `
                    <tr>
                        <td class="p-2 border">${txnDate}</td>
                        <td class="p-2 border">${txn.description || 'N/A'}</td>
                        <td class="p-2 border">${txn.type || 'N/A'}</td>
                        <td class="p-2 border text-right">${amount}</td>
                        <td class="p-2 border text-right">${balance}</td>
                    </tr>
                `;
            });
            financeTableBody.innerHTML = tableHtml;

        } catch (error) {
            console.error("Error loading finance transactions:", error);
            financeTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading transactions.</td></tr>`;
            showCustomAlert("Failed to load financial transactions. Please try again.", 'error');
        }
    }

    window.downloadStatement = async () => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to download your fee statement.", 'error');
            return;
        }

        if (financeTransactionsData.length === 0) {
            showCustomAlert("No financial transactions available to generate a statement.", 'info');
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Fetch student profile for statement header
            const studentDocRef = doc(db, "students", user.uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};

            const studentName = studentData.name || user.email;
            const admissionNo = studentData.admissionNo || 'N/A';
            const program = studentData.program || 'N/A';

            // Fetch finance summary for the PDF
            const financeDocRef = doc(db, `finance/${user.uid}/balance`);
            const financeSnap = await getDoc(financeDocRef);
            let totalFees = 0;
            let totalPaid = 0;
            let outstandingBalance = 0;
            if (financeSnap.exists()) {
                const data = financeSnap.data();
                totalFees = data.totalFees || 0;
                totalPaid = data.totalPaid || 0;
                outstandingBalance = data.amount || (totalFees - totalPaid);
            }


            // Header
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Fee Statement", 105, 20, { align: "center" });

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`University: Prince Alex Design University`, 20, 35);
            doc.text(`Date Printed: ${new Date().toLocaleDateString()}`, 170, 35, { align: "right" });
            doc.text(`Student Name: ${studentName}`, 20, 42);
            doc.text(`Admission No: ${admissionNo}`, 20, 49);
            doc.text(`Program: ${program}`, 20, 56);

            let yPos = 70;

            // Fees Summary Section
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Summary:", 20, yPos);
            yPos += 8;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Total Fees Charged: KES ${totalFees.toLocaleString()}`, 20, yPos); yPos += 7;
            doc.text(`Total Payments Made: KES ${totalPaid.toLocaleString()}`, 20, yPos); yPos += 7;
            doc.text(`Outstanding Balance: KES ${outstandingBalance.toLocaleString()}`, 20, yPos); yPos += 12;

            // Transactions Table
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Transaction History:", 20, yPos);
            yPos += 8;

            const headers = [["Date", "Description", "Type", "Amount (KES)", "Running Balance (KES)"]];
            const data = financeTransactionsData.map(txn => [
                txn.date ? new Date(txn.date.seconds * 1000).toLocaleDateString() : 'N/A',
                txn.description || 'N/A',
                txn.type || 'N/A',
                Number(txn.amount || 0).toLocaleString(),
                Number(txn.balance || 0).toLocaleString()
            ]);

            doc.autoTable({
                startY: yPos,
                head: headers,
                body: data,
                styles: { fontSize: 8, cellPadding: 2, halign: 'left' },
                headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold' },
                columnStyles: {
                    3: { halign: 'right' }, // Align Amount right
                    4: { halign: 'right' }  // Align Running Balance right
                },
                theme: 'grid',
                margin: { left: 15, right: 15 }
            });

            // Footer
            let finalY = doc.lastAutoTable.finalY || yPos;
            finalY = Math.max(finalY + 20, doc.internal.pageSize.height - 30); // Ensure footer is at bottom
            doc.setFontSize(10);
            doc.text("_________________________", 15, finalY);
            doc.setFont("helvetica", "bold");
            doc.text("Authorized Signature", 15, finalY + 7);
            doc.setFont("helvetica", "normal");
            doc.text("Finance Department", 15, finalY + 12);

            doc.save(`${studentName}_FeeStatement.pdf`);
            showCustomAlert("Fee Statement downloaded successfully!", 'success');

        } catch (error) {
            console.error("Error generating Fee Statement PDF:", error);
            showCustomAlert("Failed to generate Fee Statement PDF. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };

    async function loadUpcomingFeeDeadlines() {
        const upcomingFeeDeadlinesDiv = document.getElementById('upcomingFeeDeadlines');
        const feeDeadlinesList = document.getElementById('feeDeadlinesList');
        feeDeadlinesList.innerHTML = ''; // Clear previous notices

        // Start hidden, only show if there are deadlines
        upcomingFeeDeadlinesDiv.classList.add('hidden');


        try {
            const announcementsQuery = query(
                collection(db, "announcements"),
                where("type", "==", "finance"),
                orderBy("date", "desc"), // Order by date to show most recent/relevant
                limit(5)
            );
            const announcementsSnap = await getDocs(announcementsQuery);

            if (announcementsSnap.empty) {
                feeDeadlinesList.innerHTML = `<div class="empty-state">No upcoming fee deadlines.</div>`;
                return;
            }

            let noticesHtml = '';
            announcementsSnap.forEach(docSnap => {
                const noticeData = docSnap.data();
                const noticeDate = noticeData.date ? new Date(noticeData.date.seconds * 1000).toLocaleDateString() : 'N/A';
                noticesHtml += `
                    <li>
                        <strong>${noticeData.title}</strong>: ${noticeData.message}
                        <br><span class="text-xs text-gray-600">Published: ${noticeDate}</span>
                    </li>
                `;
            });
            feeDeadlinesList.innerHTML = noticesHtml;
            upcomingFeeDeadlinesDiv.classList.remove('hidden'); // Show the section if there are deadlines

        } catch (error) {
            console.error("Error loading upcoming fee deadlines:", error);
            feeDeadlinesList.innerHTML = `<div class="empty-state text-red-600">Error loading fee deadlines.</div>`;
            upcomingFeeDeadlinesDiv.classList.remove('hidden'); // Show with error message
        }
    }


    /**
     * Hostels section functions
     */

    let currentHostelId = null; // To keep track of the currently viewed hostel for rooms

    async function initHostelsView(uid) {
        loadingOverlay.classList.remove('hidden');
        try {
            await displayCurrentBooking(uid);
            await loadAvailableHostels(uid);
            await loadHostelNotices();
        } catch (error) {
            console.error("Error initializing Hostels view:", error);
            showCustomAlert("Failed to load hostel details. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function displayCurrentBooking(uid) {
        const bookingDetailsDiv = document.getElementById('bookingDetails');
        bookingDetailsDiv.innerHTML = `<div class="empty-state">Loading your booking status...</div>`;

        try {
            const studentDocRef = doc(db, "students", uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};
            const hostelBooking = studentData.hostelBooking;

            if (hostelBooking && hostelBooking.hostelId && hostelBooking.roomNo && hostelBooking.status) {
                bookingDetailsDiv.innerHTML = `
                    <div class="current-booking-card">
                        <p><strong>Hostel:</strong> ${hostelBooking.hostelName || 'N/A'}</p>
                        <p><strong>Room Number:</strong> ${hostelBooking.roomNo}</p>
                        <p><strong>Status:</strong> <span class="booking-status ${hostelBooking.status.toLowerCase()}">${hostelBooking.status}</span></p>
                        <button onclick="cancelBooking('${hostelBooking.hostelId}', '${hostelBooking.roomNo}')"><i class="fas fa-times-circle mr-2"></i> Cancel Booking</button>
                    </div>
                `;
            } else {
                bookingDetailsDiv.innerHTML = `<div class="empty-state">You currently have no hostel booking.</div>`;
            }
        } catch (error) {
            console.error("Error displaying current booking:", error);
            bookingDetailsDiv.innerHTML = `<div class="empty-state text-red-600">Error loading booking status.</div>`;
            showCustomAlert("Failed to load your hostel booking. Please try again.", 'error');
        }
    }

    async function loadAvailableHostels(uid) {
        const hostelListDiv = document.getElementById('hostelList');
        hostelListDiv.innerHTML = ''; // Clear previous content
        document.getElementById('roomList').classList.add('hidden'); // Hide room list by default

        try {
            const hostelsSnap = await getDocs(collection(db, "hostels"));
            
            if (hostelsSnap.empty) {
                hostelListDiv.innerHTML = `<div class="empty-state full-width">No hostels available at the moment.</div>`;
                return;
            }

            let hostelsHtml = '';
            hostelsSnap.forEach(docSnap => {
                const hostel = docSnap.data();
                const hostelId = docSnap.id;
                const statusTagClass = hostel.availableRooms > 0 ? 'available' : 'full';
                const statusText = hostel.availableRooms > 0 ? `${hostel.availableRooms} rooms available` : 'Full';

                hostelsHtml += `
                    <div class="hostel-card">
                        <h5>${hostel.name || 'N/A'}</h5>
                        <p><strong>Type:</strong> ${hostel.type || 'N/A'}</p>
                        <p><strong>Capacity:</strong> ${hostel.capacity || 'N/A'}</p>
                        <p><strong>Location:</strong> ${hostel.location || 'N/A'}</p>
                        <span class="status-tag ${statusTagClass}">${statusText}</span>
                        <button onclick="viewRooms('${hostelId}', '${hostel.name || 'Hostel'}')"><i class="fas fa-door-open mr-2"></i> View Rooms</button>
                    </div>
                `;
            });
            hostelListDiv.innerHTML = hostelsHtml;

        } catch (error) {
            console.error("Error loading available hostels:", error);
            hostelListDiv.innerHTML = `<div class="empty-state full-width text-red-600">Error loading available hostels.</div>`;
            showCustomAlert("Failed to load available hostels. Please try again.", 'error');
        }
    }

    window.viewRooms = async (hostelId, hostelName) => {
        currentHostelId = hostelId;
        document.getElementById('hostelList').classList.add('hidden');
        document.getElementById('roomList').classList.remove('hidden');
        document.getElementById('roomsForHostelTitle').textContent = `Rooms for ${hostelName}`;
        const roomsContainer = document.getElementById('roomsContainer');
        roomsContainer.innerHTML = `<div class="empty-state full-width">Loading rooms...</div>`;

        loadingOverlay.classList.remove('hidden');
        try {
            const user = auth.currentUser;
            if (!user) {
                showCustomAlert("Please log in to view rooms.", 'error');
                return;
            }

            const studentDocRef = doc(db, "students", user.uid);
            const studentSnap = await getDoc(studentDocRef);
            const studentData = studentSnap.exists() ? studentSnap.data() : {};
            const studentHasBooking = studentData.hostelBooking && studentData.hostelBooking.status === 'Active';

            const roomsQuery = query(collection(db, `hostels/${hostelId}/rooms`));
            const roomsSnap = await getDocs(roomsQuery);

            if (roomsSnap.empty) {
                roomsContainer.innerHTML = `<div class="empty-state full-width">No rooms available in this hostel.</div>`;
                return;
            }

            let roomsHtml = '';
            roomsSnap.forEach(docSnap => {
                const room = docSnap.data();
                const roomId = docSnap.id;
                const availableSlots = room.availableSlots || 0;
                const bookButtonDisabled = availableSlots === 0 || studentHasBooking ? 'disabled' : '';
                const buttonText = availableSlots === 0 ? 'Full' : (studentHasBooking ? 'Already Booked' : 'Book Room');
                const buttonColorClass = availableSlots === 0 || studentHasBooking ? 'bg-gray-400' : 'bg-blue-500 hover:bg-blue-600';


                roomsHtml += `
                    <div class="room-card">
                        <h6>Room ${room.roomNo || 'N/A'}</h6>
                        <p>Capacity: ${room.capacity || 'N/A'}-bed</p>
                        <p>Available Slots: ${availableSlots}</p>
                        <button ${bookButtonDisabled} class="${buttonColorClass} text-white font-semibold py-2 px-4 rounded"
                            onclick="bookRoom('${hostelId}', '${hostelName}', '${roomId}', '${room.roomNo}')">
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            roomsContainer.innerHTML = roomsHtml;

        } catch (error) {
            console.error("Error loading rooms:", error);
            roomsContainer.innerHTML = `<div class="empty-state full-width text-red-600">Error loading rooms.</div>`;
            showCustomAlert("Failed to load rooms. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };

    window.backToHostels = async () => {
        currentHostelId = null;
        document.getElementById('roomList').classList.add('hidden');
        document.getElementById('hostelList').classList.remove('hidden');
        const user = auth.currentUser;
        if (user) await loadAvailableHostels(user.uid);
    };

    window.bookRoom = async (hostelId, hostelName, roomId, roomNo) => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to book a room.", 'error');
            return;
        }

        showCustomConfirm(`Are you sure you want to book Room ${roomNo} in ${hostelName}?`, 'confirm', async (confirmed) => {
            if (confirmed) {
                loadingOverlay.classList.remove('hidden');
                try {
                    const studentDocRef = doc(db, "students", user.uid);
                    const roomDocRef = doc(db, `hostels/${hostelId}/rooms`, roomId);

                    // Check if student already has a booking or if room is full (double-check)
                    const studentSnap = await getDoc(studentDocRef);
                    if (studentSnap.exists() && studentSnap.data().hostelBooking && studentSnap.data().hostelBooking.status === 'Active') {
                        showCustomAlert("You already have an active hostel booking. Please cancel it first.", 'error');
                        return;
                    }

                    const roomSnap = await getDoc(roomDocRef);
                    if (!roomSnap.exists() || (roomSnap.data().availableSlots || 0) <= 0) {
                        showCustomAlert("This room is no longer available. Please refresh and try another.", 'error');
                        return;
                    }

                    // Update student document
                    await updateDoc(studentDocRef, {
                        hostelBooking: {
                            hostelId: hostelId,
                            hostelName: hostelName,
                            roomNo: roomNo,
                            status: "Active"
                        }
                    });

                    // Decrement availableSlots in the room document
                    await updateDoc(roomDocRef, {
                        availableSlots: increment(-1)
                    });

                    showCustomAlert(`Successfully booked Room ${roomNo} in ${hostelName}!`, 'success');
                    await displayCurrentBooking(user.uid);
                    if (currentHostelId) { // Re-render rooms if still in room view
                        await viewRooms(currentHostelId, hostelName);
                    } else { // Else go back to hostel list
                         await loadAvailableHostels(user.uid);
                    }
                    await loadDashboardOverview(user.uid); // Update quick stats
                } catch (error) {
                    console.error("Error booking room:", error);
                    showCustomAlert("Failed to book room. Please try again.", 'error');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }
        });
    };

    window.cancelBooking = async (hostelId, roomNo) => {
        const user = auth.currentUser;
        if (!user) {
            showCustomAlert("Please log in to cancel your booking.", 'error');
            return;
        }

        showCustomConfirm(`Are you sure you want to cancel your booking for Room ${roomNo}? This action cannot be undone.`, 'delete', async (confirmed) => {
            if (confirmed) {
                loadingOverlay.classList.remove('hidden');
                try {
                    const studentDocRef = doc(db, "students", user.uid);
                    
                    // First get student's current booking to find the roomId
                    const studentSnap = await getDoc(studentDocRef);
                    const studentBooking = studentSnap.exists() ? studentSnap.data().hostelBooking : null;

                    if (!studentBooking || studentBooking.hostelId !== hostelId || studentBooking.roomNo !== roomNo) {
                        showCustomAlert("Your current booking does not match the one you are trying to cancel. Please refresh.", 'error');
                        return;
                    }

                    // Find the roomId based on hostelId and roomNo
                    const roomsQuery = query(
                        collection(db, `hostels/${hostelId}/rooms`),
                        where("roomNo", "==", roomNo)
                    );
                    const roomsSnap = await getDocs(roomsQuery);
                    
                    if (roomsSnap.empty) {
                        showCustomAlert("Original room details not found for cancellation. Please contact admin.", 'error');
                        return;
                    }

                    const roomDoc = roomsSnap.docs[0];
                    const roomId = roomDoc.id;
                    const roomDocRef = doc(db, `hostels/${hostelId}/rooms`, roomId);

                    // Reset student's hostel booking
                    await updateDoc(studentDocRef, {
                        hostelBooking: null // Or { status: "Cancelled" } if keeping a history
                    });

                    // Increment availableSlots in the room document
                    await updateDoc(roomDocRef, {
                        availableSlots: increment(1)
                    });

                    showCustomAlert(`Booking for Room ${roomNo} cancelled successfully.`, 'success');
                    await displayCurrentBooking(user.uid);
                    await loadAvailableHostels(user.uid); // Refresh hostel list
                    await loadDashboardOverview(user.uid); // Update quick stats
                } catch (error) {
                    console.error("Error cancelling booking:", error);
                    showCustomAlert("Failed to cancel booking. Please try again.", 'error');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }
        });
    };

    async function loadHostelNotices() {
        const hostelRulesNoticesDiv = document.getElementById('hostelRulesNotices');
        const hostelNoticesList = document.getElementById('hostelNoticesList');
        hostelNoticesList.innerHTML = ''; // Clear previous notices

        hostelRulesNoticesDiv.classList.remove('hidden'); // Ensure the section is visible

        try {
            const announcementsQuery = query(
                collection(db, "announcements"),
                where("type", "==", "hostel"),
                orderBy("date", "desc"),
                limit(5)
            );
            const announcementsSnap = await getDocs(announcementsQuery);

            if (announcementsSnap.empty) {
                hostelNoticesList.innerHTML = `<div class="empty-state">No special notices for hostels at this time.</div>`;
                return;
            }

            let noticesHtml = '';
            announcementsSnap.forEach(docSnap => {
                const noticeData = docSnap.data();
                const noticeDate = noticeData.date ? new Date(noticeData.date.seconds * 1000).toLocaleDateString() : 'N/A';
                noticesHtml += `
                    <div class="notice-item">
                        <strong>${noticeData.title}</strong>
                        <p>${noticeData.message}</p>
                        <span class="text-xs text-gray-600">Posted: ${noticeDate}</span>
                    </div>
                `;
            });
            hostelNoticesList.innerHTML = noticesHtml;

        } catch (error) {
            console.error("Error loading hostel notices:", error);
            hostelNoticesList.innerHTML = `<div class="empty-state text-red-600">Error loading hostel notices.</div>`;
        }
    }


    /**
     * Announcements section functions
     */
    // This function is also called from loadRecentAnnouncements on home section
    window.loadAnnouncements = async (category = 'all') => {
        const announcementListDiv = document.getElementById('announcementList');
        announcementListDiv.innerHTML = `<div class="empty-state">Loading announcements...</div>`; // Initial loading state

        loadingOverlay.classList.remove('hidden');
        try {
            let announcementsQuery;
            if (category === 'all') {
                announcementsQuery = query(
                    collection(db, "announcements"),
                    orderBy("date", "desc")
                );
            } else {
                announcementsQuery = query(
                    collection(db, "announcements"),
                    where("category", "==", category),
                    orderBy("date", "desc")
                );
            }
            
            const announcementsSnap = await getDocs(announcementsQuery);

            if (announcementsSnap.empty) {
                announcementListDiv.innerHTML = `<div class="empty-state">No announcements available in this category.</div>`;
                return;
            }

            let announcementsHtml = '';
            announcementsSnap.forEach(docSnap => {
                const a = docSnap.data();
                const announcementId = docSnap.id;
                const formattedDate = a.date ? new Date(a.date.seconds * 1000).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A';
                const truncatedMessage = a.message.length > 150 ? a.message.substring(0, 150) + "..." : a.message;
                const hasMore = a.message.length > 150;

                const categoryClass = a.category ? a.category.toLowerCase() : 'general';
                const categoryBadgeHtml = a.category ? `<span class="category-badge ${categoryClass}">${a.category}</span>` : '';
                const pinnedIcon = a.pinned ? '<i class="fas fa-thumbtack pinned-icon mr-2"></i>' : '';

                announcementsHtml += `
                    <div class="announcement-card">
                        <h4>${pinnedIcon}${a.title} ${categoryBadgeHtml}</h4>
                        <p class="meta-info">${formattedDate} | ${a.author || 'Administration'}</p>
                        <p class="message-excerpt">${truncatedMessage}</p>
                        ${hasMore ? `<a href="#" class="read-more-btn" data-id="${announcementId}">Read more...</a>` : ''}
                    </div>
                `;
            });
            announcementListDiv.innerHTML = announcementsHtml;

            // Add event listeners for "Read more..." buttons after rendering
            announcementListDiv.querySelectorAll('.read-more-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const announcementId = e.target.dataset.id;
                    openAnnouncementModal(announcementId, announcementsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            });

        } catch (error) {
            console.error("Error loading announcements:", error);
            announcementListDiv.innerHTML = `<div class="empty-state text-red-600">Error loading announcements. Please try again.</div>`;
            showCustomAlert("Failed to load announcements. Please try again.", 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };

    function openAnnouncementModal(announcementId, allAnnouncements) {
        const announcement = allAnnouncements.find(a => a.id === announcementId);
        if (!announcement) {
            showCustomAlert("Announcement details not found.", 'error');
            return;
        }

        const modal = document.getElementById('announcementReadMoreModal');
        document.getElementById('modalTitle').textContent = announcement.title;
        document.getElementById('modalDate').textContent = announcement.date ? new Date(announcement.date.seconds * 1000).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A';
        document.getElementById('modalAuthor').textContent = announcement.author || 'Administration';
        document.getElementById('modalMessage').textContent = announcement.message;

        const categoryBadgeElement = document.getElementById('modalCategoryBadge');
        categoryBadgeElement.textContent = announcement.category || 'General';
        categoryBadgeElement.className = `category-badge ${announcement.category ? announcement.category.toLowerCase() : 'general'}`;
        
        modal.classList.remove('hidden');
    }

    // Call load functions when their respective sections are shown
    const originalShowSection = window.showSection;
    window.showSection = async (id) => {
        originalShowSection(id); // Call original function to hide/show divs
        const user = auth.currentUser;
        if (!user) return; // Must be authenticated

        loadingOverlay.classList.remove('hidden');
        try {
            if (id === 'profile') {
                await loadProfile(user.uid);
            } else if (id === 'settings') {
                await loadSettings(user.uid);
            } else if (id === 'courseReg') {
                await initCourseRegistration(user.uid);
            } else if (id === 'timetable') {
                await initTimetableView(user.uid);
            } else if (id === 'grades') {
                await initGradesView(user.uid);
            } else if (id === 'examCard') {
                await initExamCardView(user.uid);
            } else if (id === 'finance') {
                await initFinanceView(user.uid);
            } else if (id === 'hostels') {
                await initHostelsView(user.uid);
            } else if (id === 'graduation') {
                await initGraduationView(user.uid);
            } else if (id === 'clearance') {
                await initClearanceView(user.uid);
            } else if (id === 'announcements') {
                await loadAnnouncements('all'); // Load all announcements by default for the full view
            }
        } catch (error) {
            console.error(`Error loading section ${id}:`, error);
            showCustomAlert(`Failed to load ${id} data. Please try again.`, 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };

  </script>
</body>
</html>
