<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prince Alex â€” Student Dashboard (Full CRUD)</title>

  <!-- Tailwind & Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <style>
    html,body { height:100%; }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f4f6; }
    .card { background:white; border-radius:12px; box-shadow:0 6px 24px rgba(15,23,42,0.06); }
    .chip { padding:.25rem .5rem; border-radius:9999px; font-size:.75rem; display:inline-block; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Header -->
<header class="sticky top-0 z-50 bg-white border-b">
  <div class="max-w-7xl mx-auto flex items-center justify-between p-4">
    <div class="flex items-center gap-3">
      <button id="hamburger" class="md:hidden p-2 rounded hover:bg-gray-100"><i class="fa-solid fa-bars"></i></button>
      <img src="myschoollogo.png" alt="logo" class="h-10 w-10 object-contain">
      <div>
        <div class="font-bold text-lg text-slate-800">Prince Alex Design University</div>
        <div class="text-xs text-slate-500">Student Portal</div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div id="userEmail" class="text-sm text-blue-600 font-semibold"></div>
      <button id="logoutBtn" class="px-3 py-1 rounded bg-red-600 text-white text-sm">Logout</button>
    </div>
  </div>
</header>

<div class="flex flex-1">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed md:static left-0 top-16 w-72 h-[calc(100vh-4rem)] overflow-y-auto bg-white border-r p-4 transform -translate-x-full md:translate-x-0 transition-transform z-40">
    <h3 class="font-bold text-xl text-blue-800 mb-4">Menu</h3>
    <nav id="nav" class="space-y-1">
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="home"><i class="fa-solid fa-house mr-3 text-blue-600"></i>Dashboard</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="profile"><i class="fa-solid fa-user mr-3 text-blue-600"></i>Profile</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="settings"><i class="fa-solid fa-gear mr-3 text-blue-600"></i>Settings</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="courseReg"><i class="fa-solid fa-book mr-3 text-blue-600"></i>Course Registration</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="timetable"><i class="fa-solid fa-calendar-days mr-3 text-blue-600"></i>Timetable</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="grades"><i class="fa-solid fa-clipboard-check mr-3 text-blue-600"></i>Grades</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="examCard"><i class="fa-regular fa-id-card mr-3 text-blue-600"></i>Exam Card</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="graduation"><i class="fa-solid fa-graduation-cap mr-3 text-blue-600"></i>Graduation</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="clearance"><i class="fa-solid fa-circle-check mr-3 text-blue-600"></i>Clearance</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="finance"><i class="fa-solid fa-money-bill-wave mr-3 text-blue-600"></i>Finance</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="hostels"><i class="fa-solid fa-hotel mr-3 text-blue-600"></i>Hostels</button>
      <button class="menu-item w-full text-left px-3 py-2 rounded hover:bg-gray-50" data-target="announcements"><i class="fa-solid fa-bullhorn mr-3 text-blue-600"></i>Announcements</button>
    </nav>
  </aside>

  <!-- Main -->
  <main id="main" class="flex-1 p-6 md:ml-72">
    <!-- HOME -->
    <section id="home" class="card p-6 mb-6">
      <h2 class="text-xl font-bold text-slate-800" id="welcomeMessage">Welcome</h2>
      <p class="text-sm text-slate-500">Snapshot of your student status.</p>

      <div id="quickStats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6"></div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
        <div class="card p-4">
          <h3 class="font-semibold text-slate-800 mb-3">Upcoming Classes Today</h3>
          <div id="upcomingClasses" class="text-sm text-slate-700">Loading...</div>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold text-slate-800 mb-3">Recent Announcements</h3>
          <div id="recentAnnouncements" class="text-sm text-slate-700">Loading...</div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Profile</h2>
      <form id="profileForm" class="space-y-4">
        <!-- Editable by student -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">Full name</label>
            <input id="pf_name" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm text-slate-600">Email (readonly)</label>
            <input id="pf_email" class="w-full border rounded p-2 bg-gray-100" readonly />
          </div>
          <div>
            <label class="text-sm text-slate-600">Address</label>
            <input id="pf_address" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm text-slate-600">Campus</label>
            <input id="pf_campus" class="w-full border rounded p-2 bg-gray-50" readonly />
          </div>

          <div>
            <label class="text-sm text-slate-600">Date of birth</label>
            <input id="pf_dob" type="date" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm text-slate-600">Gender</label>
            <select id="pf_gender" class="w-full border rounded p-2">
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-slate-600">Programme</label>
            <input id="pf_programme" class="w-full border rounded p-2 bg-gray-50" readonly />
          </div>
          <div>
            <label class="text-sm text-slate-600">Reg No</label>
            <input id="pf_regNo" class="w-full border rounded p-2 bg-gray-50" readonly />
          </div>

          <div>
            <label class="text-sm text-slate-600">Year</label>
            <input id="pf_year" type="number" class="w-full border rounded p-2 bg-gray-50" readonly />
          </div>
          <div>
            <label class="text-sm text-slate-600">Semester</label>
            <input id="pf_semester" type="number" class="w-full border rounded p-2 bg-gray-50" readonly />
          </div>
        </div>

        <!-- Notification Preferences -->
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2"><input id="pf_notify_ann" type="checkbox"> Announcements</label>
          <label class="flex items-center gap-2"><input id="pf_notify_fees" type="checkbox"> Fees</label>
          <label class="flex items-center gap-2"><input id="pf_notify_grades" type="checkbox"> Grades</label>
        </div>

        <!-- Profile photo -->
        <div>
          <label class="text-sm text-slate-600">Profile photo</label>
          <div class="flex items-center gap-3 mt-2">
            <img id="pf_photo_preview" class="h-20 w-20 rounded-full bg-gray-100 object-cover" src="https://placehold.co/96x96" alt="photo" />
            <div>
              <input id="pf_photo" type="file" accept="image/*" />
            </div>
          </div>
        </div>

        <!-- System / metadata (readonly) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm text-slate-500">
          <div>createdAt: <span id="pf_createdAt">-</span></div>
          <div>initialized: <span id="pf_initialized">-</span></div>
          <div>lastVisitedAnnouncements: <span id="pf_lastVisited">-</span></div>
        </div>

        <div class="flex gap-3">
          <button id="btnSaveProfile" class="px-4 py-2 bg-blue-600 text-white rounded">Save Profile</button>
          <button id="btnResetProfile" type="button" class="px-4 py-2 border rounded">Reset</button>
        </div>
      </form>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Settings</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-slate-600">Change Password</label>
          <button id="btnChangePassword" class="mt-2 px-3 py-2 bg-blue-600 text-white rounded">Change Password</button>
        </div>
        <div>
          <label class="block text-sm text-slate-600">Change Email</label>
          <button id="btnChangeEmail" class="mt-2 px-3 py-2 bg-blue-600 text-white rounded">Change Email</button>
        </div>
      </div>
    </section>

    <!-- COURSE REGISTRATION -->
    <section id="courseReg" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Course Registration</h2>

      <div class="flex items-center gap-3 mb-4">
        <select id="cr_year" class="border p-2 rounded">
          <option value="">Year</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
        <select id="cr_sem" class="border p-2 rounded">
          <option value="">Semester</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
        </select>
        <button id="btnLoadCourses" class="px-3 py-2 bg-blue-600 text-white rounded">Load</button>
      </div>

      <div id="availableCourses" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <!-- course cards -->
      </div>

      <div>
        <h4 class="font-semibold mb-2">Registered Courses</h4>
        <div id="registeredCourses" class="text-sm text-slate-600">Loading...</div>
      </div>
    </section>

    <!-- TIMETABLE -->
    <section id="timetable" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Timetable</h2>

      <div class="mb-3">
        <select id="tt_year" class="border p-2 rounded">
          <option value="">Year</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
        <select id="tt_sem" class="border p-2 rounded">
          <option value="">Semester</option><option value="1">1</option><option value="2">2</option>
        </select>
        <button id="btnLoadTimetable" class="px-3 py-2 bg-blue-600 text-white rounded">Load Timetable</button>
      </div>

      <div id="timetableGrid" class="overflow-x-auto">
        <!-- table generated by JS -->
      </div>
    </section>

    <!-- GRADES -->
    <section id="grades" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Grades & Transcript</h2>

      <div class="flex items-center gap-3 mb-4">
        <select id="grades_year" class="border p-2 rounded">
          <option value="">Year</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
        <select id="grades_sem" class="border p-2 rounded">
          <option value="">Semester</option><option value="1">1</option><option value="2">2</option>
        </select>
        <button id="btnLoadGrades" class="px-3 py-2 bg-blue-600 text-white rounded">Load Grades</button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full border-collapse" id="gradesTable">
          <thead class="bg-gray-100">
            <tr><th class="p-2 text-left">Code</th><th class="p-2 text-left">Title</th><th class="p-2 text-left">Credits</th><th class="p-2 text-left">Grade</th><th class="p-2 text-left">Points</th></tr>
          </thead>
          <tbody id="gradesTbody"><tr><td colspan="5" class="p-4 text-center text-slate-500">No grades to display.</td></tr></tbody>
        </table>
      </div>

      <div class="mt-4">
        <div id="semesterGpa" class="font-semibold">Semester GPA: N/A</div>
        <div id="cumulativeGpa" class="font-semibold">Cumulative GPA: N/A</div>
      </div>

      <div class="mt-4">
        <button id="btnDownloadTranscript" class="px-3 py-2 bg-blue-600 text-white rounded">Download Transcript (PDF)</button>
      </div>
    </section>

    <!-- EXAM CARD -->
    <section id="examCard" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Exam Card</h2>
      <div id="examInfo" class="mb-4 text-sm text-slate-700">Loading exam card...</div>
      <div class="overflow-x-auto mb-4">
        <table class="w-full" id="examTable"><thead class="bg-gray-100"><tr><th class="p-2">Code</th><th class="p-2">Title</th><th class="p-2">Credits</th><th class="p-2">Venue</th><th class="p-2">Date</th></tr></thead><tbody id="examTbody"><tr><td colspan="5" class="p-4 text-center text-slate-500">No exam schedule.</td></tr></tbody></table>
      </div>
      <button id="btnDownloadExamCard" class="px-3 py-2 bg-blue-600 text-white rounded">Download Exam Card (PDF)</button>
    </section>

    <!-- GRADUATION -->
    <section id="graduation" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Graduation Request</h2>
      <div id="gradContent">Loading...</div>
    </section>

    <!-- CLEARANCE -->
    <section id="clearance" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Clearance</h2>
      <div id="clearanceContent">Loading...</div>
    </section>

    <!-- FINANCE -->
    <section id="finance" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Finance</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <div class="p-3 card text-center">
          <div class="text-sm text-slate-500">Total Fees</div>
          <div id="f_total" class="text-lg font-bold text-slate-800">KES 0</div>
        </div>
        <div class="p-3 card text-center">
          <div class="text-sm text-slate-500">Total Paid</div>
          <div id="f_paid" class="text-lg font-bold text-slate-800">KES 0</div>
        </div>
        <div class="p-3 card text-center">
          <div class="text-sm text-slate-500">Balance</div>
          <div id="f_balance" class="text-lg font-bold text-red-600">KES 0</div>
        </div>
      </div>

      <div>
        <h4 class="font-semibold mb-2">Transactions</h4>
        <div id="transactionsList">No transactions.</div>
      </div>

      <div class="mt-4">
        <button id="btnDownloadStatement" class="px-3 py-2 bg-blue-600 text-white rounded">Download Statement</button>
      </div>
    </section>

    <!-- HOSTELS -->
    <section id="hostels" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Hostels</h2>

      <div id="currentBooking" class="mb-4">
        <h4 class="font-semibold">Your Current Booking</h4>
        <div id="bookingDetails" class="text-sm text-slate-600">No booking yet.</div>
      </div>

      <div>
        <h4 class="font-semibold mb-3">Available Hostels</h4>
        <div id="hostelList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          <div class="text-slate-500 p-4 card">No hostels available.</div>
        </div>
      </div>

      <div id="roomList" class="mt-6 hidden">
        <h4 id="roomsForHostelTitle" class="font-semibold mb-3">Rooms</h4>
        <button id="btnBackToHostels" class="px-2 py-1 border rounded mb-3">Back</button>
        <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
      </div>
    </section>

    <!-- ANNOUNCEMENTS -->
    <section id="announcements" class="card p-6 mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Announcements</h2>

      <div class="flex items-center gap-3 mb-4">
        <select id="annFilter" class="border p-2 rounded">
          <option value="all">All</option>
          <option value="Academics">Academics</option>
          <option value="Finance">Finance</option>
          <option value="Hostel">Hostel</option>
          <option value="Events">Events</option>
          <option value="General">General</option>
        </select>
        <button id="btnLoadAnns" class="px-3 py-2 bg-blue-600 text-white rounded">Load</button>
      </div>

      <div id="announcementList" class="space-y-3">Loading announcements...</div>
    </section>

  </main>
</div>

<footer class="text-center text-sm text-slate-500 p-4">Â© 2025 Prince Alex Design University</footer>

<!-- Firebase modular SDK -->
<script type="module">
/* ---------- Firebase imports (modular) ---------- */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut, updatePassword, updateEmail } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
  collection, getDocs, addDoc, query, where, orderBy, limit,
  serverTimestamp, onSnapshot, runTransaction
} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';

/* ---------- Firebase config (same as your project) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
  authDomain: "universityweb-19e1e.firebaseapp.com",
  projectId: "universityweb-19e1e",
  storageBucket: "universityweb-19e1e.appspot.com",
  messagingSenderId: "401942926589",
  appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------- UI helpers ---------- */
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
function toast(msg, type='info'){ const el = document.createElement('div'); el.textContent = msg; el.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded ${type==='error'?'bg-red-600 text-white':'bg-slate-800 text-white'}`; document.body.appendChild(el); setTimeout(()=>el.remove(),2500); }

/* ---------- Sidebar toggle ---------- */
const hamburger = $('#hamburger');
const sidebar = $('#sidebar');
hamburger.addEventListener('click',()=> sidebar.classList.toggle('-translate-x-full'));

/* ---------- Section navigation ---------- */
const menuButtons = $$('.menu-item');
const sections = Array.from($$('.card')).map(c=>c.closest('section') || c.parentElement).filter(Boolean); // not used; we'll simply hide by id.
menuButtons.forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const id = btn.dataset.target;
    $$('main section').forEach(s => s.classList.add('hidden'));
    $('#' + id).classList.remove('hidden');
    // optionally load the section data on show
    if (id === 'profile') loadProfileAndBind();
    if (id === 'home') loadDashboardOverview();
    if (id === 'courseReg') loadCoursesToRegister();
    if (id === 'timetable') {} // lazy load
    if (id === 'grades') {} // lazy load
    if (id === 'examCard') loadExamCard();
    if (id === 'graduation') loadGraduation();
    if (id === 'clearance') loadClearance();
    if (id === 'finance') loadFinance();
    if (id === 'hostels') initHostels();
    if (id === 'announcements') loadAnnouncements($('#annFilter').value || 'all');
  });
});

/* ---------- Auth / Initialization ---------- */
let currentUser = null;
onAuthStateChanged(auth, async user => {
  if(!user){
    // redirect to login page if needed
    // window.location.href = 'login.html';
    console.warn('Not signed in. For demo, sign in via Firebase auth or create a login page.');
    return;
  }
  currentUser = user;
  $('#userEmail').textContent = user.email || '';
  // Ensure student doc exists
  const stRef = doc(db,'students', user.uid);
  const stSnap = await getDoc(stRef);
  if(!stSnap.exists()){
    await setDoc(stRef, {
      email: user.email,
      createdAt: new Date().toISOString(),
      initialized: false,
      notificationPreferences: { announcements: true, fees: true, grades: true }
    });
  }
  // Load initial dashboard info
  loadDashboardOverview();
  // Preload some lists
  loadAnnouncements('all');
  // Bind listeners
  bindGlobalButtons();
});

/* ---------- Logout ---------- */
$('#logoutBtn').addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href = 'login.html';
});

/* -----------------------
   = PROFILE (Student editable + admin readonly)
   Path: students/{uid}
   Editable fields (student): name, dob, gender, address, profilePhotoURL, notificationPreferences
   Admin-only (readonly in student UI): regNo, campus, programme, yearOfStudy, semester, initialized, createdAt
   ----------------------- */

async function loadProfileAndBind(){
  const uid = currentUser.uid;
  const stRef = doc(db,'students',uid);
  const stSnap = await getDoc(stRef);
  if(!stSnap.exists()){
    toast('Profile not found. Creating base profile.');
    await setDoc(stRef, { email: currentUser.email, createdAt:new Date().toISOString(), initialized:false });
  }
  const data = (await getDoc(stRef)).data();

  // populate fields
  $('#pf_name').value = data.name || '';
  $('#pf_email').value = data.email || currentUser.email || '';
  $('#pf_address').value = data.address || 'P o box 6 Serem';
  $('#pf_campus').value = data.campus || 'Main Campus';
  $('#pf_dob').value = data.dob || '';
  $('#pf_gender').value = data.gender || 'Male';
  $('#pf_programme').value = data.programme || 'Journalism';
  $('#pf_regNo').value = data.regNo || 'LMC/94/16';
  $('#pf_year').value = data.yearOfStudy || 1;
  $('#pf_semester').value = data.semester || 1;
  $('#pf_notify_ann').checked = data.notificationPreferences?.announcements || false;
  $('#pf_notify_fees').checked = data.notificationPreferences?.fees || false;
  $('#pf_notify_grades').checked = data.notificationPreferences?.grades || false;
  $('#pf_createdAt').textContent = data.createdAt ? new Date(data.createdAt).toLocaleString() : '-';
  $('#pf_initialized').textContent = (data.initialized === true) ? 'true' : 'false';
  $('#pf_lastVisited').textContent = data.lastVisitedAnnouncements ? (new Date(data.lastVisitedAnnouncements.seconds ? data.lastVisitedAnnouncements.seconds*1000 : data.lastVisitedAnnouncements).toLocaleString()) : '-';
  if(data.profilePhotoURL) $('#pf_photo_preview').src = data.profilePhotoURL;

  // Save button
  $('#btnSaveProfile').onclick = async (e) => {
    e.preventDefault();
    const updated = {
      name: $('#pf_name').value || '',
      address: $('#pf_address').value || '',
      dob: $('#pf_dob').value || '',
      gender: $('#pf_gender').value || '',
      // Do not overwrite admin-only fields here
      notificationPreferences: {
        announcements: $('#pf_notify_ann').checked,
        fees: $('#pf_notify_fees').checked,
        grades: $('#pf_notify_grades').checked
      }
    };

    // handle photo upload
    const file = $('#pf_photo').files[0];
    if(file){
      const ref = storageRef(storage, `students/${currentUser.uid}/profile.jpg`);
      await uploadBytes(ref, file);
      const url = await getDownloadURL(ref);
      updated.profilePhotoURL = url;
      $('#pf_photo_preview').src = url;
    }

    await updateDoc(stRef, updated);
    toast('Profile saved', 'success');
  };

  $('#btnResetProfile').onclick = () => loadProfileAndBind();
}

/* -----------------------
   = DASHBOARD (home)
   Fetches: students/{uid}, registrations/{uid}/courses, finance/{uid}/balance, hostels booking
   ----------------------- */
async function loadDashboardOverview(){
  if(!currentUser) return;
  const uid = currentUser.uid;
  const stRef = doc(db,'students',uid);
  const stSnap = await getDoc(stRef);
  const st = stSnap.exists() ? stSnap.data() : {};

  $('#welcomeMessage').textContent = `Welcome ${st.name || (currentUser.email?.split('@')[0]) || 'student'}!`;

  // Quick stats
  const quickStats = $('#quickStats');
  quickStats.innerHTML = ''; // clear

  // Registered courses count
  let regCount = 0;
  const regSnap = await getDocs(collection(db, 'registrations', uid, 'courses'));
  regCount = regSnap.size || 0;
  quickStats.appendChild(createStatCard('fa-book', regCount, 'Registered Courses'));

  // GPA from grades collection
  let gpa = 'N/A';
  const gradesSnap = await getDocs(collection(db, 'grades', uid, 'results'));
  if(!gradesSnap.empty){
    let totalPoints=0, totalCourses=0;
    gradesSnap.forEach(d=>{ const r=d.data(); if(typeof r.gpaPoints === 'number'){ totalPoints+=r.gpaPoints; totalCourses++; }});
    gpa = totalCourses ? (totalPoints/totalCourses).toFixed(2) : 'N/A';
  }
  quickStats.appendChild(createStatCard('fa-graduation-cap', gpa, 'Current GPA'));

  // Finance balance
  let balanceStr = 'KES 0';
  const finSnap = await getDoc(doc(db, 'finance', uid, 'balance', 'summary'));
  if(finSnap.exists()) balanceStr = `KES ${Number(finSnap.data().amount||0).toLocaleString()}`;
  quickStats.appendChild(createStatCard('fa-money-bill-wave', balanceStr, 'Fees Balance'));

  // Hostel status
  let hostelStatus = 'Not booked';
  if(st.hostelBooking && st.hostelBooking.hostelId){
    const hSnap = await getDoc(doc(db, 'hostels', st.hostelBooking.hostelId));
    hostelStatus = `Booked @ ${hSnap.exists()? hSnap.data().name : 'Hostel'}${st.hostelBooking.roomNo? ' â€¢ Room '+st.hostelBooking.roomNo : ''}`;
  }
  quickStats.appendChild(createStatCard('fa-hotel', hostelStatus, 'Hostel'));

  // Upcoming classes
  await loadUpcomingClasses();

  // recent announcements
  await loadRecentAnnouncements(3);
}

function createStatCard(icon, value, label){
  const el = document.createElement('div');
  el.className = 'p-4 card text-center';
  el.innerHTML = `<div class="text-2xl text-blue-600"><i class="fa-solid ${icon}"></i></div><div class="text-lg font-bold mt-2">${value}</div><div class="text-xs text-slate-500 mt-1">${label}</div>`;
  return el;
}

/* ---------- Upcoming classes (for today) ---------- */
async function loadUpcomingClasses(){
  const out = $('#upcomingClasses');
  out.textContent = '';
  try{
    const uid = currentUser.uid;
    const stSnap = await getDoc(doc(db,'students',uid));
    const regCourses = (stSnap.exists() && stSnap.data().registeredCourses) ? stSnap.data().registeredCourses.map(c=>c.code) : [];
    if(!regCourses.length){ out.innerHTML = `<div class="text-slate-500">You havenâ€™t registered for courses yet.</div>`; return; }

    // Get today's name
    const day = new Date().toLocaleDateString('en-US',{weekday:'long'});
    const q = query(collection(db, 'timetable'), where('day','==', day));
    const snap = await getDocs(q);
    const classes = [];
    snap.forEach(d=>{
      const data = d.data();
      if(regCourses.includes(data.courseCode)) classes.push(data);
    });
    if(!classes.length){ out.innerHTML = `<div class="text-slate-500">No classes today.</div>`; return; }
    classes.sort((a,b)=> (a.time||'').localeCompare(b.time||''));
    out.innerHTML = classes.map(c=>`<div class="p-3 border rounded mb-2"><strong>${c.courseCode}</strong> â€” ${c.time} â€¢ ${c.venue || 'TBA'}</div>`).join('');
  }catch(e){ console.error(e); out.textContent = 'Failed to load classes.'; }
}

/* ---------- Recent announcements ---------- */
async function loadRecentAnnouncements(limitCount=3){
  const out = $('#recentAnnouncements');
  out.textContent = '';
  const q = query(collection(db,'announcements'), orderBy('createdAt','desc'), limit(limitCount));
  const snap = await getDocs(q);
  if(snap.empty){ out.innerHTML = `<div class="text-slate-500">No announcements yet.</div>`; return; }
  const html = [];
  snap.forEach(d=>{
    const a = d.data();
    html.push(`<div class="p-3 rounded border bg-white"><div class="font-semibold">${a.title} <span class="chip">${a.category||'General'}</span></div><div class="text-sm text-slate-600 mt-1">${(a.body||'').slice(0,140)}${(a.body||'').length>140?'...':''}</div></div>`);
  });
  out.innerHTML = html.join('');
}

/* -----------------------
   = COURSE REGISTRATION
   - courses collection: courses/{courseId} { code,title,credits,year,semester,lecturer }
   - registrations: registrations/{uid}/courses/{courseId}
   ----------------------- */
async function loadCoursesToRegister(){
  $('#availableCourses').innerHTML = `<div class="text-slate-500 p-4">Select year & semester then click Load</div>`;
  loadRegisteredCourses();
}

$('#btnLoadCourses').addEventListener('click', async ()=>{
  const year = $('#cr_year').value;
  const sem = $('#cr_sem').value;
  if(!year || !sem){ toast('Choose year and semester', 'error'); return; }
  const q = query(collection(db,'courses'), where('year','==', Number(year)), where('semester','==', Number(sem)));
  const snap = await getDocs(q);
  const container = $('#availableCourses');
  container.innerHTML = '';
  if(snap.empty){ container.innerHTML = `<div class="text-slate-500 p-4">No courses found.</div>`; return; }
  snap.forEach(docSnap=>{
    const c = docSnap.data();
    const id = docSnap.id;
    const card = document.createElement('div');
    card.className = 'p-3 border rounded';
    card.innerHTML = `<div class="font-semibold">${c.code} â€” ${c.title}</div><div class="text-sm text-slate-600">Credits: ${c.credits || '-'}</div><div class="mt-2"><button data-id="${id}" class="px-3 py-1 bg-blue-600 text-white rounded register-course">Register</button></div>`;
    container.appendChild(card);
  });
  // attach register handlers
  $$('.register-course').forEach(b=> b.addEventListener('click', async (e)=>{
    const courseId = e.currentTarget.dataset.id;
    await registerCourse(courseId);
    loadRegisteredCourses();
  }));
});

async function registerCourse(courseId){
  const uid = currentUser.uid;
  // Store registration under registrations/{uid}/courses/{courseId} with a timestamp
  await setDoc(doc(db, 'registrations', uid, 'courses', courseId), { registeredAt: serverTimestamp() });
  // Also add small reference to students/{uid}.registeredCourses array (optional)
  const stRef = doc(db,'students', uid);
  await updateDoc(stRef, { registeredCourses: (Array.isArray((await getDoc(stRef)).data()?.registeredCourses) ? (await getDoc(stRef)).data().registeredCourses : []).concat([{ courseId }]) });
  toast('Course registered', 'success');
}

async function loadRegisteredCourses(){
  const uid = currentUser.uid;
  const container = $('#registeredCourses');
  const snap = await getDocs(collection(db, 'registrations', uid, 'courses'));
  if(snap.empty){ container.innerHTML = `<div class="text-slate-500 p-2">You havenâ€™t registered for any courses yet.</div>`; return; }
  const list = [];
  for(const d of snap.docs){
    const id = d.id;
    const courseDoc = await getDoc(doc(db,'courses',id));
    const c = courseDoc.exists() ? courseDoc.data() : { code: id, title: 'Unknown' };
    list.push(`<div class="p-2 border rounded mb-2 flex justify-between items-center"><div><div class="font-semibold">${c.code} â€” ${c.title}</div><div class="text-sm text-slate-600">Credits: ${c.credits||'-'}</div></div><button data-id="${id}" class="px-2 py-1 border rounded text-sm drop-course">Drop</button></div>`);
  }
  container.innerHTML = list.join('');
  $$('.drop-course').forEach(b=> b.addEventListener('click', async (e)=>{
    const cid = e.currentTarget.dataset.id;
    const uid = currentUser.uid;
    await deleteDoc(doc(db,'registrations', uid, 'courses', cid));
    // also remove from students register array (best-effort)
    const stRef = doc(db,'students', uid);
    const stSnap = await getDoc(stRef);
    const arr = stSnap.exists() ? stSnap.data().registeredCourses || [] : [];
    const newArr = arr.filter(x => x.courseId !== cid);
    await updateDoc(stRef, { registeredCourses: newArr });
    toast('Course dropped', 'info');
    loadRegisteredCourses();
  }));
}

/* -----------------------
   = TIMETABLE
   - timetable/{uid} could be a doc with schedule array
   ----------------------- */
$('#btnLoadTimetable').addEventListener('click', async ()=>{
  const year = $('#tt_year').value;
  const sem = $('#tt_sem').value;
  if(!year || !sem){ toast('Select year and semester', 'error'); return; }
  const uid = currentUser.uid;
  const ttRef = doc(db,'timetable', uid);
  const ttSnap = await getDoc(ttRef);
  if(!ttSnap.exists()){ $('#timetableGrid').innerHTML = `<div class="p-4 text-slate-500">No timetable available for selected year/semester.</div>`; return; }
  const data = ttSnap.data();
  // Assuming data.schedule is array of {day, time, courseCode, venue}
  const days = ['Time','Monday','Tuesday','Wednesday','Thursday','Friday'];
  const table = document.createElement('table');
  table.className = 'w-full border-collapse';
  table.innerHTML = `<thead class="bg-gray-100"><tr>${days.map(d=>`<th class="p-2 border">${d}</th>`).join('')}</tr></thead><tbody id="ttbody"></tbody>`;
  const tbody = table.querySelector('#ttbody');
  // Build grid by time slots (collect times)
  const slots = Array.from(new Set((data.schedule||[]).map(x=>x.time))).sort();
  for(const time of slots){
    const row = document.createElement('tr');
    row.innerHTML = `<td class="p-2 border">${time}</td>` + ['Monday','Tuesday','Wednesday','Thursday','Friday'].map(day=>{
      const c = (data.schedule||[]).find(s=>s.time===time && s.day===day);
      return `<td class="p-2 border">${c? `${c.courseCode} <div class="text-xs text-slate-500">${c.venue||''}</div>` : ''}</td>`;
    }).join('');
    tbody.appendChild(row);
  }
  $('#timetableGrid').innerHTML = '';
  $('#timetableGrid').appendChild(table);
});

/* -----------------------
   = GRADES
   - grades/{uid}/results/{courseId} { code,title,credits,grade,gpaPoints }
   ----------------------- */
$('#btnLoadGrades').addEventListener('click', async ()=>{
  const uid = currentUser.uid;
  const year = $('#grades_year').value;
  const sem = $('#grades_sem').value;
  // We'll fetch all grades and filter client side by year/sem if those fields exist on docs
  const snap = await getDocs(collection(db, 'grades', uid, 'results'));
  const tbody = $('#gradesTbody');
  tbody.innerHTML = '';
  if(snap.empty){ tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-500">No grades yet.</td></tr>`; return; }
  let totalPoints = 0, totalCredits = 0;
  snap.forEach(d=>{
    const r = d.data();
    const points = (r.gpaPoints || 0) * (r.credits || 0);
    totalPoints += points;
    totalCredits += (r.credits || 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2 border">${r.code||''}</td><td class="p-2 border">${r.title||''}</td><td class="p-2 border">${r.credits||''}</td><td class="p-2 border">${r.grade||''}</td><td class="p-2 border">${r.gpaPoints||''}</td>`;
    tbody.appendChild(tr);
  });
  const semGpa = totalCredits ? (totalPoints/totalCredits).toFixed(2) : 'N/A';
  $('#semesterGpa').textContent = `Semester GPA: ${semGpa}`;
  // cumulative gpa can be read from student doc or computed across all grades
  $('#cumulativeGpa').textContent = `Cumulative GPA: ${semGpa}`;
});

$('#btnDownloadTranscript').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const docp = new jsPDF();
  docp.setFontSize(16);
  docp.text('Transcript', 14, 20);
  // Build body
  const rows = [];
  const uid = currentUser.uid;
  const snap = await getDocs(collection(db,'grades',uid,'results'));
  snap.forEach(d=>{
    const r = d.data();
    rows.push([r.code||'', r.title||'', r.credits||'', r.grade||'']);
  });
  // autopopulate
  docp.autoTable({ startY: 30, head:[['Code','Title','Credits','Grade']], body: rows });
  docp.save('transcript.pdf');
});

/* -----------------------
   = EXAM CARD
   Based on registrations/{uid}/courses and timetable
   ----------------------- */
async function loadExamCard(){
  const uid = currentUser.uid;
  const regSnap = await getDocs(collection(db, 'registrations', uid, 'courses'));
  const tbody = $('#examTbody'); tbody.innerHTML = '';
  if(regSnap.empty){ tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-500">No registered courses.</td></tr>`; return; }
  for(const d of regSnap.docs){
    const courseId = d.id;
    const cSnap = await getDoc(doc(db,'courses',courseId));
    const c = cSnap.exists() ? cSnap.data() : { code: courseId, title:'Unknown', credits: '-'};
    // optionally fetch exam schedule for course
    const examRow = `<tr><td class="p-2 border">${c.code}</td><td class="p-2 border">${c.title}</td><td class="p-2 border">${c.credits||''}</td><td class="p-2 border">${c.venue||'TBA'}</td><td class="p-2 border">${c.examDate||'TBA'}</td></tr>`;
    tbody.innerHTML += examRow;
  }
}

$('#btnDownloadExamCard').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const docp = new jsPDF();
  docp.setFontSize(16); docp.text('Exam Card', 14, 18);
  const rows = [];
  const uid = currentUser.uid;
  const regSnap = await getDocs(collection(db,'registrations',uid,'courses'));
  for(const d of regSnap.docs){
    const courseDoc = await getDoc(doc(db,'courses',d.id));
    const c = courseDoc.exists() ? courseDoc.data() : { code:d.id, title:'Unknown' };
    rows.push([c.code||'', c.title||'', c.credits||'', c.venue||'TBA', c.examDate||'TBA']);
  }
  docp.autoTable({ startY: 26, head:[['Code','Title','Credits','Venue','Date']], body: rows });
  docp.save('examcard.pdf');
});

/* -----------------------
   = GRADUATION
   Path: graduationRequests/{uid}
   ----------------------- */
async function loadGraduation(){
  const uid = currentUser.uid;
  const gRef = doc(db,'graduationRequests', uid);
  const snap = await getDoc(gRef);
  const container = $('#gradContent');
  if(!snap.exists()){
    container.innerHTML = `<div class="text-slate-600">No graduation request yet.</div><div class="mt-3"><button id="btnRequestGrad" class="px-3 py-2 bg-blue-600 text-white rounded">Request Graduation</button></div>`;
    $('#btnRequestGrad').onclick = async ()=>{
      await setDoc(gRef, { status:'pending', requestedAt: serverTimestamp() });
      toast('Graduation requested', 'success'); loadGraduation();
    };
    return;
  }
  const data = snap.data();
  container.innerHTML = `<div class="p-3 border rounded"><div>Status: <strong class="ml-2">${data.status}</strong></div><div class="text-sm text-slate-600 mt-2">Requested at: ${data.requestedAt?.toDate ? data.requestedAt.toDate().toLocaleString() : '-'}</div></div>`;
}

/* -----------------------
   = CLEARANCE
   Path: clearance/{uid}
   ----------------------- */
async function loadClearance(){
  const uid = currentUser.uid;
  const cRef = doc(db,'clearance', uid);
  const snap = await getDoc(cRef);
  const out = $('#clearanceContent');
  if(!snap.exists()){
    out.innerHTML = `<div class="text-slate-600">Clearance process not started.</div><div class="mt-3"><button id="btnStartClearance" class="px-3 py-2 bg-blue-600 text-white rounded">Start Clearance</button></div>`;
    $('#btnStartClearance').onclick = async ()=>{
      await setDoc(cRef, { library:'pending', finance:'pending', hostel:'pending', department:'pending', startedAt: serverTimestamp() });
      toast('Clearance initiated', 'success'); loadClearance();
    };
    return;
  }
  const d = snap.data();
  out.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    ${renderClearanceRow('Library', d.library)}
    ${renderClearanceRow('Finance', d.finance)}
    ${renderClearanceRow('Hostel', d.hostel)}
    ${renderClearanceRow('Department', d.department)}
  </div>`;
}
function renderClearanceRow(label, status){
  const cls = status === 'cleared' ? 'bg-green-100 text-green-800' : status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
  return `<div class="p-3 border rounded"><div class="font-semibold">${label}</div><div class="mt-2"><span class="px-2 py-1 ${cls} rounded">${status || 'pending'}</span></div></div>`;
}

/* -----------------------
   = FINANCE
   Path: finance/{uid}/balance (doc id: summary), finance/{uid}/transactions/{txId}
   ----------------------- */
async function loadFinance(){
  const uid = currentUser.uid;
  const summaryRef = doc(db,'finance', uid, 'balance', 'summary');
  const sumSnap = await getDoc(summaryRef);
  const total = sumSnap.exists() ? Number(sumSnap.data().amount||0) : 0;
  const paid = sumSnap.exists() ? Number(sumSnap.data().paid||0) : 0;
  $('#f_total').textContent = `KES ${total.toLocaleString()}`;
  $('#f_paid').textContent = `KES ${paid.toLocaleString()}`;
  $('#f_balance').textContent = `KES ${(total-paid).toLocaleString()}`;

  // transactions
  const txSnap = await getDocs(collection(db,'finance', uid, 'transactions'));
  const list = [];
  txSnap.forEach(t=>{
    const d = t.data();
    list.push(`<div class="p-2 border rounded mb-2"><div class="text-sm">${d.date?.toDate ? d.date.toDate().toLocaleDateString() : '-' } â€” ${d.description||''}</div><div class="font-semibold">KES ${Number(d.amount||0).toLocaleString()}</div></div>`);
  });
  $('#transactionsList').innerHTML = list.length ? list.join('') : `<div class="text-slate-500">No transactions recorded.</div>`;
}

$('#btnDownloadStatement').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const docp = new jsPDF();
  docp.text('Fee Statement', 14, 16);
  const uid = currentUser.uid;
  const txSnap = await getDocs(collection(db,'finance', uid, 'transactions'));
  const rows = [];
  txSnap.forEach(t => {
    const d = t.data();
    rows.push([ d.date?.toDate ? d.date.toDate().toLocaleDateString() : '-', d.description||'', (d.type||''), Number(d.amount||0) ]);
  });
  docp.autoTable({ startY: 22, head:[['Date','Description','Type','Amount']], body: rows });
  docp.save('fee-statement.pdf');
});

/* -----------------------
   = HOSTELS (Admin + Student)
   hostels/{hid} { name, description, availableCount }, hostels/{hid}/rooms/{rid}
   Student booking -> students/{uid}.hostelBooking
   ----------------------- */
let currentHostelForRooms = null;
async function initHostels(){
  await loadHostelsList();
  loadStudentBooking();
}

async function loadHostelsList(){
  const snap = await getDocs(collection(db,'hostels'));
  const container = $('#hostelList');
  container.innerHTML = '';
  if(snap.empty){ container.innerHTML = '<div class="text-slate-500 p-4 card">No hostels available.</div>'; return; }
  snap.forEach(h=> {
    const d = h.data();
    const el = document.createElement('div');
    el.className = 'p-3 border rounded hostel-card';
    el.innerHTML = `<h5 class="font-semibold text-blue-800">${d.name}</h5><p class="text-slate-600">${d.description || ''}</p><div class="mt-2">Available rooms: <strong>${Number(d.availableCount||0)}</strong></div><div class="mt-3"><button data-id="${h.id}" class="px-3 py-1 bg-blue-600 text-white rounded view-rooms-btn">View Rooms</button></div>`;
    container.appendChild(el);
  });
  $$('.view-rooms-btn').forEach(b=> b.addEventListener('click', async (e)=>{
    const hid = e.currentTarget.dataset.id;
    openRoomsForHostel(hid);
  }));
}

async function openRoomsForHostel(hid){
  currentHostelForRooms = hid;
  $('#hostelList').classList.add('hidden');
  $('#roomList').classList.remove('hidden');
  $('#roomsForHostelTitle').textContent = `Rooms for Hostel (${hid})`;
  const roomsSnap = await getDocs(collection(db,'hostels', hid, 'rooms'));
  const cont = $('#roomsContainer');
  cont.innerHTML = '';
  if(roomsSnap.empty){ cont.innerHTML = `<div class="text-slate-500 p-4 card">No rooms found.</div>`; return; }
  roomsSnap.forEach(r=>{
    const d = r.data();
    const card = document.createElement('div');
    card.className = 'p-3 border rounded room-card';
    card.innerHTML = `<h6 class="font-semibold">Room ${d.roomNo}</h6><p>Capacity: ${d.capacity||1}</p><p>Price: KES ${Number(d.price||0).toLocaleString()}</p><div class="mt-3"><button data-rid="${r.id}" class="px-3 py-1 bg-green-600 text-white rounded book-room-btn">Book</button></div>`;
    cont.appendChild(card);
  });
  $$('.book-room-btn').forEach(b=> b.addEventListener('click', async (e)=>{
    const rid = e.currentTarget.dataset.rid;
    await bookRoom(currentHostelForRooms, rid);
    initHostels();
  }));
}

$('#btnBackToHostels').addEventListener('click', ()=>{
  $('#roomList').classList.add('hidden');
  $('#hostelList').classList.remove('hidden');
});

async function loadStudentBooking(){
  const uid = currentUser.uid;
  const sSnap = await getDoc(doc(db,'students',uid));
  const book = sSnap.exists() ? sSnap.data().hostelBooking : null;
  if(!book || !book.hostelId){
    $('#bookingDetails').innerHTML = `<div class="text-slate-500">No booking yet.</div>`;
    return;
  }
  const hSnap = await getDoc(doc(db,'hostels', book.hostelId));
  $('#bookingDetails').innerHTML = `<div class="p-3 border rounded"><div>Hostel: <strong>${hSnap.exists()? hSnap.data().name : book.hostelId}</strong></div><div>Room: <strong>${book.roomNo||'-'}</strong></div><div class="mt-2"><button id="btnCancelBooking" class="px-3 py-1 border rounded">Cancel Booking</button></div></div>`;
  $('#btnCancelBooking').onclick = ()=> cancelBooking(uid, book.hostelId, book.roomId);
}

async function bookRoom(hostelId, roomId){
  const uid = currentUser.uid;
  // Use transaction to mark room booked and set student booking and decrement availableCount
  try{
    await runTransaction(db, async (tx) => {
      const rRef = doc(db,'hostels',hostelId,'rooms', roomId);
      const sRef = doc(db,'students', uid);
      const hRef = doc(db,'hostels', hostelId);

      const rSnap = await tx.get(rRef);
      if(!rSnap.exists()) throw new Error('Room not found');
      if(rSnap.data().status !== 'available') throw new Error('Room not available');

      tx.update(rRef, { status:'booked', bookedBy: uid, bookedAt: serverTimestamp() });
      tx.set(sRef, { hostelBooking: { hostelId, roomId, roomNo: rSnap.data().roomNo, active:true, bookedAt: serverTimestamp() } }, { merge:true });
      const hSnap = await tx.get(hRef);
      const newAvail = Math.max(0, (hSnap.data().availableCount || 0) - 1);
      tx.update(hRef, { availableCount: newAvail });
    });
    toast('Room booked successfully', 'success');
    loadStudentBooking();
  }catch(e){ toast(e.message || 'Booking failed', 'error'); console.error(e); }
}

async function cancelBooking(uid, hostelId, roomId){
  try{
    await runTransaction(db, async (tx)=>{
      const rRef = doc(db,'hostels',hostelId,'rooms', roomId);
      const sRef = doc(db,'students',uid);
      const hRef = doc(db,'hostels',hostelId);

      const rSnap = await tx.get(rRef);
      if(rSnap.exists()) tx.update(rRef, { status:'available', bookedBy: null, bookedAt: null });

      const hSnap = await tx.get(hRef);
      tx.update(hRef, { availableCount: Math.max(0, (hSnap.data().availableCount || 0) + 1) });

      tx.update(sRef, { hostelBooking: null });
    });
    toast('Booking cancelled', 'success');
    loadStudentBooking();
  }catch(e){ console.error(e); toast('Cancel failed', 'error'); }
}

/* -----------------------
   = ANNOUNCEMENTS
   announcements/{aid} { title, body, category, createdAt, author }
   ----------------------- */
async function loadAnnouncements(filter='all'){
  const out = $('#announcementList'); out.innerHTML = '';
  let q = collection(db,'announcements');
  if(filter !== 'all') q = query(q, where('category','==', filter));
  q = query(q, orderBy('createdAt','desc'));
  const snap = await getDocs(q);
  if(snap.empty){ out.innerHTML = `<div class="text-slate-500 p-3">No announcements.</div>`; return; }
  const html = [];
  snap.forEach(d=>{
    const a = d.data();
    html.push(`<div class="p-3 border rounded announcement-card"><div class="flex justify-between"><div><strong>${a.title}</strong> <span class="text-xs text-slate-500">â€¢ ${a.category||'General'}</span></div><div class="text-xs text-slate-400">${a.createdAt?.toDate ? a.createdAt.toDate().toLocaleString() : ''}</div></div><div class="mt-2 text-sm text-slate-700">${a.body}</div></div>`);
  });
  out.innerHTML = html.join('');
}

/* ---------- Helpers for binding global buttons ---------- */
function bindGlobalButtons(){
  $('#btnLoadAnns').onclick = ()=> loadAnnouncements($('#annFilter').value);
  // change password & email (settings)
  $('#btnChangePassword').onclick = ()=> {
    const pw = prompt('Enter new password (min 6 chars)');
    if(!pw) return;
    updatePassword(currentUser, pw).then(()=> toast('Password updated','success')).catch(e=> toast(getFriendlyError(e.code),'error'));
  };
  $('#btnChangeEmail').onclick = () => {
    const em = prompt('Enter new email');
    if(!em) return;
    updateEmail(currentUser, em).then(()=> toast('Email updated','success')).catch(e=> toast(getFriendlyError(e.code),'error'));
  };
}

/* ---------- Utilities ---------- */
function getFriendlyError(code){
  switch(code){
    case 'auth/requires-recent-login': return 'Please sign out and sign in again before this action.';
    default: return code || 'Error';
  }
}

</script>
</body>
</html>
