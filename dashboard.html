<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Prince Alex Design University</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- jsPDF for Transcript Download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable plugin for easy table generation in PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; }
    .btn-red { background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 6px; }
    .btn-red:hover { background: #bb2d3b; }
    #sidebar a { padding: 0.75rem; border-radius: 4px; display: block; }
    #sidebar a:hover { background-color: #e9ecef; }
    .dashboard-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 1rem; }

    /* Fixed Header */
    #mainHeader {
        position: sticky;
        top: 0;
        width: 100%;
        z-index: 50; /* Ensure it stays above other content but below modals */
    }
    /* Adjust main content for fixed header */
    .flex-grow { /* This element handles the remaining space, no direct padding needed here */ }


    /* New styles for dashboard overview */
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: transform 0.2s ease-in-out;
        min-height: 150px; /* Ensure consistent height */
        justify-content: center;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card .icon {
        font-size: 2.5rem;
        color: #0d6efd; /* Theme blue */
        margin-bottom: 0.5rem;
    }
    .stat-card .value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1a1a1a;
    }
    .stat-card .label {
        font-size: 0.9rem;
        color: #555;
        margin-top: 0.2rem;
    }

    /* Upcoming Classes and Announcements sections */
    .section-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1f2937; /* Dark gray */
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e2e8f0;
    }
    .class-item, .announcement-item {
        background: #ffffff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
    }
    .class-item strong, .announcement-item strong {
        color: #0d6efd; /* Theme blue */
    }
    .announcement-item .date {
        font-size: 0.8em;
        color: #777;
        margin-top: 0.5em;
    }
    .empty-state {
        text-align: center;
        color: #6b7280;
        padding: 1.5rem;
        background-color: #f3f4f6;
        border-radius: 8px;
        margin-top: 1rem;
    }
    .full-width {
        grid-column: 1 / -1; /* Span all columns in the grid */
    }
    /* Loading overlay styles */
    .loading-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        transition: opacity 0.3s ease-in-out;
    }
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid #0d6efd; /* Theme blue spinner */
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loading-text {
        margin-top: 10px;
        font-weight: 500;
        color: #0d6efd;
    }
     /* Custom Alert/Confirm Modal Styles */
    .custom-alert-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000; /* Higher than other modals */
    }
    .custom-alert-content {
        background: white;
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .custom-alert-content p {
        margin-bottom: 0; /* Remove default paragraph margin */
        font-size: 1.1em;
        color: #1a1a1a; /* Default text color */
    }
    .custom-alert-content button {
        background-color: #0d6efd; /* Primary blue for OK button */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color .3s ease;
    }
    .custom-alert-content button:hover {
        background-color: #0a58ca;
    }
    /* Specific styles for alert types */
    .custom-alert-content.error {
        background-color: #dc3545; /* Red for error */
        color: white;
    }
    .custom-alert-content.success {
        background-color: #28a745; /* Green for success */
        color: white;
    }
    .custom-alert-content.info {
        background-color: #002d6b; /* Dark Blue for info */
        color: white;
    }

    /* Hostel Specific Styles */
    .hostel-card {
        background-color: #f0f9ff; /* Light blue background */
        border: 1px solid #bfdbfe; /* Light blue border */
        border-radius: 8px;
        padding: 1.2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .hostel-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .hostel-card h5 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e40af; /* Darker blue for titles */
        margin-bottom: 0.5rem;
    }
    .hostel-card p {
        font-size: 0.95rem;
        color: #374151; /* Dark gray for text */
        margin-bottom: 0.3rem;
    }
    .hostel-card .status-tag {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 9999px; /* Fully rounded */
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    .hostel-card .status-tag.available {
        background-color: #d1fae5; /* Green light */
        color: #065f46; /* Green dark */
    }
    .hostel-card .status-tag.full {
        background-color: #fee2e2; /* Red light */
        color: #991b1b; /* Red dark */
    }
    .hostel-card button {
        margin-top: 1rem;
        width: 100%;
        background-color: #0d6efd;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }
    .hostel-card button:hover {
        background-color: #0a58ca;
    }

    /* Room Card Styles */
    .room-card {
        background-color: #ecfdf5; /* Even lighter green background */
        border: 1px solid #a7f3d0; /* Light green border */
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 6px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    .room-card h6 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #047857; /* Dark green for room number */
        margin-bottom: 0.3rem;
    }
    .room-card p {
        font-size: 0.9rem;
        color: #14532d; /* Darker green for room details */
    }
    .room-card button {
        margin-top: 0.8rem;
        background-color: #059669; /* Teal green */
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }
    .room-card button:hover {
        background-color: #047857;
    }
    .room-card button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* Current Booking Card */
    .current-booking-card {
        background-color: #e0f2fe; /* Very light blue */
        border: 1px solid #90cdf4;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
        text-align: left;
    }
    .current-booking-card h4 {
        color: #1e40af;
        margin-bottom: 1rem;
    }
    .current-booking-card p {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    .current-booking-card p strong {
        color: #0d6efd;
    }
    .current-booking-card .booking-status {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.8rem;
    }
    .current-booking-card .booking-status.active {
        background-color: #d1fae5;
        color: #065f46;
    }
    .current-booking-card .booking-status.pending {
        background-color: #fefcbf;
        color: #8a6d3b;
    }
    .current-booking-card .booking-status.cancelled {
        background-color: #fee2e2;
        color: #991b1b;
    }
    .current-booking-card button {
        background-color: #dc3545; /* Red for cancel */
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        font-weight: 500;
        margin-top: 1.2rem;
        transition: background-color 0.2s ease;
    }
    .current-booking-card button:hover {
        background-color: #bb2d3b;
    }

    /* Hostel Rules & Notices */
    .hostel-rules-card {
        background-color: #fef3c7; /* Light yellow */
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-top: 2rem;
        text-align: left;
    }
    .hostel-rules-card h4 {
        color: #b45309; /* Darker yellow/orange */
        margin-bottom: 1rem;
        border-bottom: 1px solid #fcd34d;
        padding-bottom: 0.5rem;
    }
    .hostel-rules-card ul {
        list-style-type: disc;
        margin-left: 20px;
        margin-bottom: 1rem;
    }
    .hostel-rules-card li {
        margin-bottom: 0.5rem;
        color: #78350f; /* Brownish text */
    }
    .hostel-rules-card .notice-item {
        background-color: #fff9e6;
        border-left: 4px solid #fcd34d;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    .hostel-rules-card .notice-item strong {
        color: #b45309;
    }

    /* Finance Specific Styles */
    .finance-summary-card {
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    .finance-summary-card p.label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 0.2rem;
    }
    .finance-summary-card p.value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .finance-status-message {
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-weight: bold;
        text-align: center;
    }
    .finance-status-message.cleared {
        background-color: #d1fae5; /* Green light */
        color: #065f46; /* Green dark */
        border: 1px solid #a7f3d0;
    }
    .finance-status-message.pending {
        background-color: #fef3c7; /* Yellow light */
        color: #b45309; /* Yellow dark */
        border: 1px solid #fcd34d;
    }

    .finance-upcoming-deadlines {
        background-color: #e0f2fe; /* Light blue */
        border: 1px solid #90cdf4;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .finance-upcoming-deadlines h4 {
        color: #1e40af;
        margin-bottom: 1rem;
        border-bottom: 1px solid #90cdf4;
        padding-bottom: 0.5rem;
    }
    .finance-upcoming-deadlines ul {
        list-style: none;
        padding: 0;
    }
    .finance-upcoming-deadlines li {
        background-color: #f8fafd;
        border-left: 4px solid #0d6efd;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        font-size: 0.95rem;
        color: #374151;
    }
    .finance-upcoming-deadlines li strong {
        color: #0d6efd;
    }

    /* Graduation Specific Styles */
    .graduation-status-card {
        background-color: #e0f7fa; /* Light cyan */
        border: 1px solid #b2ebf2;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        text-align: left;
    }
    .graduation-status-card h4 {
        color: #006064; /* Dark teal */
        margin-bottom: 1rem;
    }
    .graduation-status-card p {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        color: #263238;
    }
    .graduation-status-card p strong {
        color: #0097a7; /* Cyan */
    }
    .graduation-status-card .status-badge {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    .graduation-status-card .status-badge.pending {
        background-color: #fff9c4; /* Light yellow */
        color: #fbc02d; /* Amber */
    }
    .graduation-status-card .status-badge.approved {
        background-color: #c8e6c9; /* Light green */
        color: #388e3c; /* Green */
    }
    .graduation-status-card .status-badge.rejected {
        background-color: #ffcdd2; /* Light red */
        color: #d32f2f; /* Red */
    }
    .graduation-status-card .admin-comments {
        background-color: #f0f0f0;
        border-left: 3px solid #757575;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 5px;
        font-style: italic;
    }
    .graduation-status-card .uploaded-docs-list {
        list-style: none;
        padding: 0;
        margin-top: 1rem;
    }
    .graduation-status-card .uploaded-docs-list li {
        margin-bottom: 0.5rem;
    }
    .graduation-status-card .uploaded-docs-list a {
        color: #0097a7;
        text-decoration: underline;
    }

    /* Clearance Specific Styles */
    .clearance-status-card {
        background-color: #e8f5e9; /* Light green */
        border: 1px solid #c8e6c9;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        text-align: left;
    }
    .clearance-status-card h4 {
        color: #2e7d32; /* Dark green */
        margin-bottom: 1rem;
    }
    .clearance-status-card p {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        color: #424242;
    }
    .clearance-status-card p strong {
        color: #4caf50; /* Green */
    }
    .clearance-status-card .status-badge {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    .clearance-status-card .status-badge.pending {
        background-color: #fffde7; /* Very light yellow */
        color: #fbc02d; /* Amber */
    }
    .clearance-status-card .status-badge.approved {
        background-color: #e8f5e9; /* Light green */
        color: #388e3c; /* Green */
    }
    .clearance-status-card .status-badge.rejected {
        background-color: #ffebee; /* Very light red */
        color: #d32f2f; /* Red */
    }
    .clearance-status-card .department-comment {
        font-style: italic;
        color: #616161;
        font-size: 0.85rem;
    }

    /* Announcements Specific Styles */
    .announcement-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.2rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: transform 0.2s ease-in-out;
    }
    .announcement-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .announcement-card .category-badge {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        vertical-align: middle;
    }
    .category-badge.academics { background-color: #e3f2fd; color: #1e88e5; } /* Blue */
    .category-badge.finance { background-color: #e8f5e9; color: #43a047; } /* Green */
    .category-badge.hostel { background-color: #fff3e0; color: #fb8c00; } /* Orange */
    .category-badge.events { background-color: #f3e5f5; color: #8e24aa; } /* Purple */
    .category-badge.general { background-color: #eceff1; color: #546e7a; } /* Gray */

    .announcement-card h4 {
        font-size: 1.15rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.4rem;
        display: flex;
        align-items: center;
    }
    .announcement-card h4 .pinned-icon {
        color: #fbc02d; /* Amber */
        margin-right: 0.5rem;
        font-size: 1.2em;
    }
    .announcement-card .meta-info {
        font-size: 0.85rem;
        color: #616161;
        margin-bottom: 0.8rem;
    }
    .announcement-card .message-excerpt {
        color: #424242;
        line-height: 1.5;
        margin-bottom: 0.8rem;
    }
    .announcement-card .read-more-btn {
        color: #0d6efd;
        text-decoration: underline;
        font-size: 0.9rem;
        cursor: pointer;
    }

    /* Announcement Modal for full view */
    .announcement-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .announcement-modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 700px;
        width: 90%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }
    .announcement-modal-content .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #757575;
    }
    .announcement-modal-content h3 {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1a202c;
        margin-bottom: 1rem;
    }
    .announcement-modal-content .meta-info {
        font-size: 0.95rem;
        color: #616161;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 1rem;
    }
    .announcement-modal-content .full-message {
        font-size: 1rem;
        color: #424242;
        line-height: 1.6;
    }

  </style>
</head>
<body class="h-screen flex flex-col">

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="loading-text">Loading dashboard...</div>
  </div>

  <!-- Header -->
  <header id="mainHeader" class="p-4 flex justify-between items-center shadow-md bg-white">
    <img src="myschoollogo.png" alt="Logo" class="h-12">
    <div class="flex items-center space-x-4">
      <span id="userEmail" class="text-blue-600 font-bold"></span>
      <button id="logoutBtn" class="btn-red"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </header>

  <div class="flex flex-grow">
    <!-- Sidebar -->
    <nav id="sidebar" class="w-64 bg-white border-r p-4 hidden md:block overflow-y-auto">
      <h3 class="text-2xl font-bold mb-4 text-blue-800">Menu</h3>
      <a href="#" onclick="showSection('home')"><i class="fas fa-home mr-2"></i> Dashboard</a>
      <a href="#" onclick="showSection('profile')"><i class="fas fa-user mr-2"></i> Profile</a>
      <a href="#" onclick="showSection('settings')"><i class="fas fa-cog mr-2"></i> Settings</a>
      <a href="#" onclick="showSection('courseReg')"><i class="fas fa-file-alt mr-2"></i> Course Registration</a>
      <a href="#" onclick="showSection('timetable')"><i class="fas fa-calendar-alt mr-2"></i> Timetable</a>
      <a href="#" onclick="showSection('grades')"><i class="fas fa-clipboard-list mr-2"></i> Grades</a>
      <a href="#" onclick="showSection('examCard')"><i class="fas fa-id-card mr-2"></i> Exam Card</a>
      <a href="#" onclick="showSection('graduation')"><i class="fas fa-graduation-cap mr-2"></i> Graduation Request</a>
      <a href="#" onclick="showSection('clearance')"><i class="fas fa-check-circle mr-2"></i> Clearance Request</a>
      <a href="#" onclick="showSection('finance')"><i class="fas fa-money-bill-wave mr-2"></i> Finance</a>
      <a href="#" onclick="showSection('hostels')"><i class="fas fa-hotel mr-2"></i> Hostels</a>
      <a href="#" onclick="showSection('announcements')"><i class="fas fa-bullhorn mr-2"></i> Announcements</a>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="flex-grow p-6 overflow-y-auto">
      <!-- Home - Dashboard Overview -->
      <div id="home" class="dashboard-card">
        <h2 class="text-xl font-bold text-blue-700 mb-4" id="welcomeMessage">Welcome to your Dashboard</h2>
        <p class="text-gray-600 mb-6">Here’s a quick look at your university status.</p>

        <h3 class="section-title">Quick Stats</h3>
        <div id="quickStats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 mb-8">
            <!-- Stat cards will be dynamically loaded here -->
        </div>
        <hr class="my-6 border-gray-300">

        <h3 class="section-title">Upcoming Classes Today</h3>
        <div id="upcomingClasses" class="mt-4 mb-8">
            <!-- Upcoming classes will be dynamically loaded here -->
        </div>
        <hr class="my-6 border-gray-300">

        <h3 class="section-title">Recent Announcements</h3>
        <div id="recentAnnouncements" class="mt-4">
            <!-- Recent announcements will be dynamically loaded here -->
        </div>
      </div>

      <!-- Profile -->
      <div id="profile" class="dashboard-card hidden">
        <h2 class="text-xl font-bold text-blue-700 mb-4">Your Profile</h2>
        <form id="profileForm" class="space-y-6">
          <!-- Basic Info -->
          <div class="space-y-4">
            <h3 class="text-lg font-semibold text-blue-600">Basic Information</h3>
            <div>
              <label for="profileName" class="block text-sm font-medium text-gray-700">Full Name</label>
              <input type="text" id="profileName" placeholder="Full Name" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
            </div>
            <div>
              <label for="profileEmail" class="block text-sm font-medium text-gray-700">Email</label>
              <input type="email" id="profileEmail" placeholder="Email" class="mt-1 w-full border p-2 rounded-md bg-gray-100 cursor-not-allowed shadow-sm" readonly/>
            </div>
            <div>
              <label for="profilePhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
              <input type="text" id="profilePhone" placeholder="Phone Number" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
            </div>
            <div>
              <label for="profileDob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
              <input type="date" id="profileDob" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
            </div>
            <div>
              <label for="profileGender" class="block text-sm font-medium text-gray-700">Gender</label>
              <select id="profileGender" class="mt-1 w-full border p-2 rounded-md shadow-sm">
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label for="profileAddress" class="block text-sm font-medium text-gray-700">Address</label>
              <textarea id="profileAddress" placeholder="Your Address" rows="3" class="mt-1 w-full border p-2 rounded-md shadow-sm"></textarea>
            </div>
          </div>

          <!-- Guardian Info -->
          <div class="space-y-4 mt-6">
            <h3 class="text-lg font-semibold text-blue-600">Guardian Information</h3>
            <div>
              <label for="profileGuardianName" class="block text-sm font-medium text-gray-700">Guardian Name</label>
              <input type="text" id="profileGuardianName" placeholder="Guardian Full Name" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
            </div>
            <div>
              <label for="profileGuardianPhone" class="block text-sm font-medium text-gray-700">Guardian Phone</label>
              <input type="text" id="profileGuardianPhone" placeholder="Guardian Phone Number" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
            </div>
            <div>
              <label for="profileGuardianRelation" class="block text-sm font-medium text-gray-700">Relationship</label>
              <input type="text" id="profileGuardianRelation" placeholder="e.g., Mother, Father, Aunt" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
            </div>
          </div>

          <!-- Academic Info -->
          <div class="space-y-4 mt-6">
            <h3 class="text-lg font-semibold text-blue-600">Academic Information</h3>
            <div>
              <label for="profileAdmissionNo" class="block text-sm font-medium text-gray-700">Admission Number</label>
              <input type="text" id="profileAdmissionNo" class="mt-1 w-full border p-2 rounded-md bg-gray-100 cursor-not-allowed shadow-sm" disabled value="Not assigned yet – contact administration."/>
            </div>
            <div>
              <label for="profileProgram" class="block text-sm font-medium text-gray-700">Program of Study</label>
              <input type="text" id="profileProgram" placeholder="e.g., BSc Computer Science" class="mt-1 w-full border p-2 rounded-md shadow-sm"/>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="profileYear" class="block text-sm font-medium text-gray-700">Year</label>
                <select id="profileYear" class="mt-1 w-full border p-2 rounded-md shadow-sm">
                  <option value="">Select Year</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>
              </div>
              <div>
                <label for="profileSemester" class="block text-sm font-medium text-gray-700">Semester</label>
                <select id="profileSemester" class="mt-1 w-full border p-2 rounded-md shadow-sm">
                  <option value="">Select Semester</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
            </div>
            <div>
              <label for="profileEnrollmentDate" class="block text-sm font-medium text-gray-700">Enrollment Date</label>
              <input type="text" id="profileEnrollmentDate" class="mt-1 w-full border p-2 rounded-md bg-gray-100 cursor-not-allowed shadow-sm" disabled value="Not set yet"/>
            </div>
          </div>

          <!-- Profile Picture -->
          <div class="space-y-4 mt-6">
            <h3 class="text-lg font-semibold text-blue-600">Profile Picture</h3>
            <div class="flex items-center space-x-4">
              <img id="profilePicturePreview" class="h-24 w-24 rounded-full object-cover border-2 border-blue-300" src="https://placehold.co/96x96/e2e8f0/6b7280?text=No+Image" alt="Profile Picture"/>
              <div>
                <input type="file" id="profilePictureUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <p class="mt-1 text-xs text-gray-500">JPG, PNG, GIF up to 2MB</p>
              </div>
            </div>
          </div>

          <button type="submit" class="btn-red mt-6">Update Profile</button>
        </form>
      </div>

      <!-- Settings -->
      <div id="settings" class="dashboard-card hidden">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Settings</h2>
          <form id="settingsForm" class="space-y-6">
              <!-- Account Security -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-blue-600">Account Security 🔒</h3>
                  <div>
                      <button type="button" onclick="changePassword()" class="btn-red">Change Password</button>
                  </div>
                  <div>
                      <button type="button" id="changeEmailBtn" class="btn-red">Change Email</button>
                  </div>
                  <div class="flex items-center">
                      <input type="checkbox" id="twoFactorEnabled" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="twoFactorEnabled" class="ml-2 block text-sm text-gray-900">Enable Two-Step Verification</label>
                  </div>
              </div>

              <!-- Notification Preferences -->
              <div class="space-y-4 mt-6">
                  <h3 class="text-lg font-semibold text-blue-600">Notification Preferences 🔔</h3>
                  <div class="flex items-center">
                      <input type="checkbox" id="notifyEmail" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="notifyEmail" class="ml-2 block text-sm text-gray-900">Email Notifications (Announcements, Fees Alerts)</label>
                  </div>
                  <div class="flex items-center">
                      <input type="checkbox" id="notifyInApp" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="notifyInApp" class="ml-2 block text-sm text-gray-900">In-app Notifications</label>
                  </div>
                  <div class="flex items-center">
                      <input type="checkbox" id="notifySms" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="notifySms" class="ml-2 block text-sm text-gray-900">SMS Alerts</label>
                  </div>
              </div>

              <!-- Privacy & Data -->
              <div class="space-y-4 mt-6">
                  <h3 class="text-lg font-semibold text-blue-600">Privacy & Data 🕵️</h3>
                  <div class="flex items-center">
                      <input type="checkbox" id="showProfileToClassmates" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                      <label for="showProfileToClassmates" class="ml-2 block text-sm text-gray-900">Show profile to classmates</label>
                  </div>
                  <div>
                      <button type="button" class="btn-red">Download Personal Data (Future Feature)</button>
                  </div>
              </div>

              <button type="submit" class="btn-red mt-6">Save Settings</button>
          </form>

          <!-- Danger Zone -->
          <div class="space-y-4 mt-8 pt-8 border-t border-gray-200">
              <h3 class="text-lg font-semibold text-red-600">Danger Zone ⚠️</h3>
              <p class="text-sm text-gray-600">This action cannot be undone. Please proceed with caution.</p>
              <div>
                  <button type="button" id="deleteAccountBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">Delete Account</button>
              </div>
          </div>
      </div>

      <!-- Course Registration -->
      <div id="courseReg" class="dashboard-card hidden">
        <h2 class="text-xl font-bold text-blue-700 mb-4">Course Registration</h2>
        <div class="space-y-4">
          <h3 class="text-lg font-bold text-blue-600 mb-3">Filter Courses</h3>
          
          <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
            <select id="yearSelect" class="border p-2 rounded-md flex-grow">
              <option value="">Select Year</option>
              <option value="1">Year 1</option>
              <option value="2">Year 2</option>
              <option value="3">Year 3</option>
              <option value="4">Year 4</option>
            </select>
            <select id="semesterSelect" class="border p-2 rounded-md flex-grow">
              <option value="">Select Semester</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
            </select>
            <button onclick="filterAndLoadCourses()" class="btn-red">Load Courses</button>
          </div>

          <h4 class="text-md font-semibold text-blue-600 mt-6 mb-3">Available Courses</h4>
          <div id="availableCoursesList" class="mb-6 space-y-2">
            <!-- Available courses will be dynamically loaded here -->
            <div class="empty-state">Select year and semester to load available courses.</div>
          </div>
          <button onclick="registerSelectedCourses()" class="btn-red w-full sm:w-auto">Register Selected Courses</button>
        </div>

        <h4 class="text-md font-semibold text-blue-600 mt-8 mb-3 border-t pt-6">Currently Registered Courses</h4>
        <div id="registeredCoursesDisplay" class="overflow-x-auto">
            <table class="w-full border-collapse border mt-2">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border text-left">Code</th>
                        <th class="p-2 border text-left">Title</th>
                        <th class="p-2 border text-left">Credits</th>
                        <th class="p-2 border text-left">Lecturer</th>
                        <th class="p-2 border text-left">Action</th>
                    </tr>
                </thead>
                <tbody id="registeredCoursesTable">
                    <!-- Registered courses will be dynamically loaded here -->
                    <tr><td colspan="5" class="p-4 text-center text-gray-500">You haven’t registered for any courses yet.</td></tr>
                </tbody>
            </table>
        </div>
      </div>

      <!-- Timetable -->
      <div id="timetable" class="dashboard-card hidden">
        <h2 class="text-xl font-bold text-blue-700 mb-4">Timetable</h2>
        <div class="space-y-4">
            <h3 class="text-lg font-bold text-blue-600 mb-3">Weekly Timetable Overview</h3>
            
            <!-- Optional Filters -->
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                <select id="timetableYear" class="border p-2 rounded-md flex-grow">
                    <option value="">Select Year</option>
                    <option value="1">Year 1</option>
                    <option value="2">Year 2</option>
                    <option value="3">Year 3</option>
                    <option value="4">Year 4</option>
                </select>
                <select id="timetableSemester" class="border p-2 rounded-md flex-grow">
                    <option value="">Select Semester</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                    <option value="3">Semester 3</option>
                </select>
                <button onclick="handleLoadTimetable()" class="btn-red">Load Timetable</button>
            </div>

            <!-- Timetable Grid -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border mt-2">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border text-left">Time</th>
                            <th class="p-2 border text-left">Monday</th>
                            <th class="p-2 border text-left">Tuesday</th>
                            <th class="p-2 border text-left">Wednesday</th>
                            <th class="p-2 border text-left">Thursday</th>
                            <th class="p-2 border text-left">Friday</th>
                        </tr>
                    </thead>
                    <tbody id="timetableTable">
                        <tr><td colspan="6" class="p-4 text-center text-gray-500">Select year and semester and click "Load Timetable" to view your schedule.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
      </div>

      <!-- Grades -->
      <div id="grades" class="dashboard-card hidden">
        <h2 class="text-xl font-bold text-blue-700 mb-4">Grades & Transcript</h2>

        <!-- Filters -->
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
          <select id="gradesYear" class="border p-2 rounded-md flex-grow">
            <option value="">Select Year</option>
            <option value="1">Year 1</option>
            <option value="2">Year 2</option>
            <option value="3">Year 3</option>
            <option value="4">Year 4</option>
          </select>
          <select id="gradesSemester" class="border p-2 rounded-md flex-grow">
            <option value="">Select Semester</option>
            <option value="1">Semester 1</option>
            <option value="2">Semester 2</option>
            <option value="3">Semester 3</option>
          </select>
          <button onclick="handleLoadGrades()" class="btn-red">Load Grades</button>
        </div>

        <!-- Grades Table -->
        <div class="overflow-x-auto mb-4">
            <table class="w-full border-collapse border mt-2">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border text-left">Code</th>
                        <th class="p-2 border text-left">Title</th>
                        <th class="p-2 border text-left">Credits</th>
                        <th class="p-2 border text-left">Grade</th>
                        <th class="p-2 border text-left">Points</th>
                        <th class="p-2 border text-left">Lecturer</th>
                    </tr>
                </thead>
                <tbody id="gradesTable">
                    <tr><td colspan="6" class="p-4 text-center text-gray-500">Select year and semester and click "Load Grades" to view.</td></tr>
                </tbody>
            </table>
        </div>

        <!-- GPA Section -->
        <div class="mt-4 space-y-2">
          <p id="semesterGpa" class="font-semibold text-blue-700">Semester GPA: N/A</p>
          <p id="cumulativeGpa" class="font-semibold text-blue-700">Cumulative GPA: N/A</p>
        </div>

        <!-- Transcript -->
        <button onclick="downloadTranscript()" class="btn-red mt-4">Download Transcript (PDF)</button>
      </div>

      <!-- Exam Card -->
      <div id="examCard" class="dashboard-card hidden">
        <h2 class="text-xl font-bold text-blue-700 mb-4">Exam Card</h2>

        <!-- Info Section -->
        <div id="examCardInfo" class="mb-4 text-sm text-gray-700 p-4 border rounded-md bg-blue-50">
          <p><strong>Name:</strong> <span id="examName">Loading...</span></p>
          <p><strong>Admission No:</strong> <span id="examAdmNo">Loading...</span></p>
          <p><strong>Program:</strong> <span id="examProgram">Loading...</span></p>
          <p><strong>Year / Semester:</strong> <span id="examYearSem">Loading...</span></p>
        </div>

        <!-- Courses Table -->
        <div class="overflow-x-auto mb-4">
            <table class="w-full border-collapse border mt-2">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border text-left">Code</th>
                        <th class="p-2 border text-left">Title</th>
                        <th class="p-2 border text-left">Credits</th>
                        <th class="p-2 border text-left">Lecturer</th>
                        <th class="p-2 border text-left">Venue</th>
                        <th class="p-2 border text-left">Date</th>
                    </tr>
                </thead>
                <tbody id="examCoursesTable">
                    <tr><td colspan="6" class="p-4 text-center text-gray-500">Loading registered courses and exam schedule...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Status -->
        <div id="examStatus" class="mb-4 p-3 rounded-md text-center text-lg font-semibold bg-gray-100 border border-gray-300">
            Checking finance clearance...
        </div>

        <!-- Download -->
        <button onclick="downloadExamCard()" class="btn-red w-full sm:w-auto">Download Exam Card (PDF)</button>
      </div>

      <!-- Graduation -->
      <div id="graduation" class="dashboard-card hidden">
        <h3 class="text-lg font-bold text-blue-600 mb-3">Graduation Request</h3>

        <div id="graduationContent">
          <!-- Content (form or status) will be loaded dynamically here by JavaScript -->
          <div class="empty-state">Loading graduation status...</div>
        </div>
      </div>

      <!-- Clearance -->
      <div id="clearance" class="dashboard-card hidden">
        <h3 class="text-lg font-bold text-blue-600 mb-3">Clearance Request</h3>

        <div id="clearanceContent">
            <!-- Dynamic content: form or status card -->
            <div class="empty-state">Loading clearance status...</div>
        </div>
      </div>

      <!-- Finance -->
      <div id="finance" class="dashboard-card hidden">
        <h3 class="text-lg font-bold text-blue-600 mb-3">Finance</h3>

        <!-- Fees Summary -->
        <div id="financeSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="finance-summary-card bg-blue-50">
                <p class="label">Total Fees Charged</p>
                <p id="totalFees" class="value text-blue-700">KES 0</p>
            </div>
            <div class="finance-summary-card bg-green-50">
                <p class="label">Total Payments Made</p>
                <p id="totalPaid" class="value text-green-700">KES 0</p>
            </div>
            <div class="finance-summary-card bg-red-50">
                <p class="label">Outstanding Balance</p>
                <p id="balance" class="value text-red-700">KES 0</p>
            </div>
        </div>
        <div id="financeStatusMessage" class="finance-status-message">
            Loading finance status...
        </div>

        <h4 class="font-semibold text-blue-500 mb-2 mt-6">Transactions History</h4>
        <div class="overflow-x-auto mb-4">
            <table class="w-full border-collapse border mt-2">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border text-left">Date</th>
                        <th class="p-2 border text-left">Description</th>
                        <th class="p-2 border text-left">Type</th>
                        <th class="p-2 border text-right">Amount (KES)</th>
                        <th class="p-2 border text-right">Running Balance (KES)</th>
                    </tr>
                </thead>
                <tbody id="financeTable">
                    <tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions recorded.</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Statement -->
        <button onclick="downloadStatement()" class="btn-red w-full sm:w-auto mt-4"><i class="fas fa-download mr-2"></i> Download Fee Statement (PDF)</button>

        <!-- Upcoming Fee Deadlines (Optional) -->
        <div id="upcomingFeeDeadlines" class="finance-upcoming-deadlines hidden">
            <h4 class="font-semibold text-blue-700 mb-3">Upcoming Fee Deadlines</h4>
            <ul id="feeDeadlinesList">
                <div class="empty-state">No upcoming fee deadlines.</div>
            </ul>
        </div>

      </div>

      <!-- Hostels -->
      <div id="hostels" class="dashboard-card hidden">
        <h3 class="text-lg font-bold text-blue-600 mb-3">Hostel Accommodation</h3>

        <!-- Student Booking Status -->
        <div id="currentBooking" class="mb-6">
          <h4 class="font-semibold text-blue-500">Your Current Booking</h4>
          <div id="bookingDetails" class="empty-state">No booking yet.</div>
        </div>

        <!-- Available Hostels -->
        <h4 class="font-semibold text-blue-500 mb-2">Available Hostels</h4>
        <div id="hostelList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="empty-state full-width">No hostels available at the moment.</div>
        </div>

        <!-- Room List (Shown when hostel clicked) -->
        <div id="roomList" class="mt-6 hidden">
          <h4 class="font-semibold text-blue-500 mb-2" id="roomsForHostelTitle">Rooms for [Hostel Name]</h4>
          <button onclick="backToHostels()" class="btn-red text-xs mb-4"><i class="fas fa-arrow-left mr-2"></i> Back to Hostels</button>
          <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="empty-state full-width">Loading rooms...</div>
          </div>
        </div>

        <!-- Hostel Rules & Notices -->
        <div id="hostelRulesNotices" class="hostel-rules-card hidden">
            <h4 class="font-semibold text-orange-700 mb-3">Hostel Rules & Important Notices</h4>
            <div id="rulesContent">
                <ul>
                    <li>Curfew is at 10:00 PM on weekdays and 11:00 PM on weekends.</li>
                    <li>No guests are allowed after 9:00 PM.</li>
                    <li>Keep your room and common areas clean.</li>
                    <li>Report any maintenance issues immediately to the hostel warden.</li>
                    <li>Silence hours are from 10:00 PM to 6:00 AM.</li>
                    <li>No cooking is allowed inside rooms. Use designated common kitchens.</li>
                </ul>
            </div>
            <h5 class="font-semibold text-orange-700 mt-4 mb-2">Important Notices:</h5>
            <div id="hostelNoticesList">
                <div class="empty-state">No special notices for hostels at this time.</div>
            </div>
        </div>

      </div>

      <!-- Announcements -->
      <div id="announcements" class="dashboard-card hidden">
        <h3 class="text-lg font-bold text-blue-600 mb-3">Announcements</h3>

        <!-- Filter -->
        <div class="flex space-x-2 mb-4">
          <select id="announcementFilter" class="border p-2 rounded">
            <option value="all">All</option>
            <option value="Academics">Academics</option>
            <option value="Finance">Finance</option>
            <option value="Hostel">Hostel</option>
            <option value="Events">Events</option>
            <option value="General">General</option>
          </select>
          <button onclick="loadAnnouncements(document.getElementById('announcementFilter').value)" class="btn-red">Filter</button>
        </div>

        <!-- List -->
        <div id="announcementList" class="space-y-4">
            <div class="empty-state">Loading announcements...</div>
        </div>
      </div>
    </main>
  </div>

  <footer class="bg-white p-4 text-center border-t text-sm">
    © 2025 Prince Alex Design University. All rights reserved.
  </footer>

    <!-- Announcement Read More Modal -->
    <div id="announcementReadMoreModal" class="announcement-modal hidden">
        <div class="announcement-modal-content">
            <span class="close-btn" onclick="document.getElementById('announcementReadMoreModal').classList.add('hidden');">&times;</span>
            <h3 id="modalTitle"></h3>
            <p class="meta-info"><span id="modalDate"></span> | <span id="modalAuthor"></span> <span id="modalCategoryBadge" class="category-badge"></span></p>
            <div id="modalMessage" class="full-message"></div>
        </div>
    </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Your original firebaseConfig (kept unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
      authDomain: "universityweb-19e1e.firebaseapp.com",
      projectId: "universityweb-19e1e",
      storageBucket: "universityweb-19e1e.appspot.com",
      messagingSenderId: "401942926589",
      appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app); // Initialize Firebase Storage
    const loadingOverlay = document.getElementById('loadingOverlay');

    const userEmailSpan = document.getElementById("userEmail");
    const profileForm = document.getElementById("profileForm");
    const settingsForm = document.getElementById("settingsForm"); // Get settings form

    // Helper for displaying custom alerts (replaces native alert/prompt)
    function showCustomAlert(message, type = 'info', callback = null) {
        const modal = document.createElement('div');
        modal.classList.add('custom-alert-modal'); // Assuming you have custom-alert-modal CSS
        let bgColor = '#0d6efd'; // Primary blue
        if (type === 'error') { bgColor = '#dc3545'; }
        else if (type === 'success') { bgColor = '#28a745'; }

        modal.innerHTML = `
            <div style="background:${bgColor}; color:white; padding:25px; border-radius:8px; text-align:center; max-width:400px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                <p style="margin-bottom:20px; font-size:1.1em;">${message}</p>
                <button style="background-color:white; color:${bgColor}; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;"
                        onclick="this.parentNode.parentNode.remove(); if(typeof window.alertCallback === 'function') window.alertCallback();">OK</button>
            </div>
        `;
        document.body.appendChild(modal);
        window.alertCallback = callback; // Store callback globally
    }

    // Custom Prompt function
    function showCustomPrompt(message, callback, inputType = 'password', placeholder = '') {
        const modal = document.createElement('div');
        modal.classList.add('custom-alert-modal');
        modal.innerHTML = `
            <div style="background:white; padding:25px; border-radius:8px; text-align:center; max-width:400px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                <p style="margin-bottom:15px; font-size:1.1em; color:#1a1a1a;">${message}</p>
                <input type="${inputType}" id="promptInput" placeholder="${placeholder || `Enter ${inputType === 'password' ? 'new password' : 'new email'}`}" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px;">
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button style="background-color:#0d6efd; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="promptOk">OK</button>
                    <button style="background-color:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="promptCancel">Cancel</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const input = modal.querySelector('#promptInput');
        const okBtn = modal.querySelector('#promptOk');
        const cancelBtn = modal.querySelector('#promptCancel');

        okBtn.onclick = () => {
            modal.remove();
            callback(input.value);
        };
        cancelBtn.onclick = () => {
            modal.remove();
            callback(null);
        };
        input.focus();
    }

    // Custom Confirm function
    function showCustomConfirm(message, type = 'confirm', callback = null) {
        const modal = document.createElement('div');
        modal.classList.add('custom-alert-modal');
        let confirmColor = '#0d6efd';
        if (type === 'delete') confirmColor = '#dc3545';

        modal.innerHTML = `
            <div style="background:white; padding:25px; border-radius:8px; text-align:center; max-width:400px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                <p style="margin-bottom:20px; font-size:1.1em; color:${confirmColor};">${message}</p>
                <div style="display:flex; justify-content:center; gap:15px;">
                    <button style="background-color:${confirmColor}; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="confirmYes">Yes</button>
                    <button style="background-color:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" id="confirmNo">No</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        modal.querySelector('#confirmYes').onclick = () => {
            modal.remove();
            if(callback) callback(true);
        };
        modal.querySelector('#confirmNo').onclick = () => {
            modal.remove();
            if(callback) callback(false);
        };
    }

    // Function to process Firebase error messages into user-friendly ones
    function getFriendlyErrorMessage(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email':
            case 'auth/wrong-password':
            case 'auth/user-not-found':
            case 'auth/invalid-credential':
                return 'Invalid email or password.';
            case 'auth/email-already-in-use':
                return 'This email address is already in use.';
            case 'auth/weak-password':
                return 'Password should be at least 6 characters.';
            case 'auth/network-request-failed':
                return 'Network error. Please check your connection.';
            case 'auth/requires-recent-login':
                return 'This action requires recent authentication. Please log out and log in again, then try.';
            case 'auth/too-many-requests':
                return 'Too many attempts. Please try again later.';
            case 'auth/operation-not-allowed':
                return 'This operation is not allowed. Please contact support.';
            default:
                return 'An unexpected error occurred. Please try again.';
        }
    }


    // Switch sections
    window.showSection = (id) => {
      document.querySelectorAll("#mainContent > div").forEach(div => div.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    };

    // ---- FIXED AUTH + LOADING HANDLER ----
    // Previously some exceptional Firestore errors could prevent hiding the loading overlay.
    // We wrap the loads in try/catch/finally and add a safety timeout so the loading overlay is never left visible.
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      // Show loader
      loadingOverlay.classList.remove('hidden');
      userEmailSpan.textContent = user.email;

      // Safety timeout: if loading takes too long, hide overlay and show an error.
      const safetyTimeoutMs = 15000; // 15s
      let timedOut = false;
      const timeoutHandle = setTimeout(() => {
        if (!loadingOverlay.classList.contains('hidden')) {
          timedOut = true;
          loadingOverlay.classList.add('hidden');
          showCustomAlert('Loading is taking longer than expected. Please check your network and try again or reload the page.', 'error');
          console.error('Dashboard loading timed out after', safetyTimeoutMs, 'ms');
        }
      }, safetyTimeoutMs);

      try {
        // Load dashboard data; any thrown error will be caught below
        await loadDashboardOverview(user.uid);

        // load profile and settings so those sections are ready
        await loadProfile(user.uid);
        await loadSettings(user.uid);

      } catch (err) {
        console.error('Error during initial dashboard load:', err);
        // Show friendly error to user
        showCustomAlert(`Error loading dashboard: ${err.message || 'Unexpected error'}`, 'error');
      } finally {
        // Clear timeout and ensure overlay hidden
        clearTimeout(timeoutHandle);
        if (!timedOut) {
          loadingOverlay.classList.add('hidden');
        }
      }
    });
    // ---- end fixed handler ----

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      loadingOverlay.classList.remove('hidden'); // Show loading
      await signOut(auth);
      window.location.href = "login.html";
    });

    /**
     * Dashboard Overview Functions
     * (All original functions retained - unchanged)
     */
    async function loadDashboardOverview(uid) {
        const studentDocRef = doc(db, "students", uid);
        const studentSnap = await getDoc(studentDocRef);
        let studentData = {};
        if (studentSnap.exists()) {
            studentData = studentSnap.data();
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${studentData.name || userEmailSpan.textContent.split('@')[0]}!`;
        } else {
             document.getElementById('welcomeMessage').textContent = `Welcome back, ${userEmailSpan.textContent.split('@')[0]}!`;
        }

        await loadQuickStats(uid, studentData);
        await loadUpcomingClasses(uid, studentData);
        await loadRecentAnnouncements();
    }

    async function loadQuickStats(uid, studentData) {
        const quickStatsDiv = document.getElementById('quickStats');
        quickStatsDiv.innerHTML = ''; // Clear previous stats

        // 1. Registered Courses
        const registeredCoursesCount = studentData.registeredCourses ? studentData.registeredCourses.length : 0;
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-book icon"></i>
                <div class="value">${registeredCoursesCount}</div>
                <div class="label">Registered Courses</div>
            </div>
        `;

        // 2. GPA
        let gpa = 'N/A';
        const gradesCollectionRef = collection(db, `grades/${uid}/results`);
        const gradesSnap = await getDocs(gradesCollectionRef);
        if (!gradesSnap.empty) {
            let totalGpaPoints = 0;
            let courseCount = 0;
            gradesSnap.forEach(gDoc => {
                const gradeData = gDoc.data();
                if (gradeData.gpaPoints !== undefined) {
                    totalGpaPoints += gradeData.gpaPoints;
                    courseCount++;
                }
            });
            gpa = courseCount > 0 ? (totalGpaPoints / courseCount).toFixed(2) : 'N/A';
        }
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-graduation-cap icon"></i>
                <div class="value">${gpa}</div>
                <div class="label">Current GPA</div>
            </div>
        `;

        // 3. Fees Balance
        let feesBalance = 'N/A';
        const financeDocRef = doc(db, `finance/${uid}/balance`); // Assuming balance is a doc
        const financeSnap = await getDoc(financeDocRef);
        if (financeSnap.exists()) {
            feesBalance = `KES ${Number(financeSnap.data().amount || 0).toLocaleString()}`;
        }
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-money-bill-wave icon"></i>
                <div class="value">${feesBalance}</div>
                <div class="label">Fees Balance</div>
            </div>
        `;

        // 4. Hostel Status
        let hostelStatus = 'Not booked yet';
        let hostelRoom = 'N/A';
        if (studentData.hostelBooking && studentData.hostelBooking.hostelId) {
             const hostelRef = doc(db, "hostels", studentData.hostelBooking.hostelId);
             const hostelSnap = await getDoc(hostelRef);
             if(hostelSnap.exists()){
                hostelStatus = `Booked at ${hostelSnap.data().name || 'Hostel X'}`;
                hostelRoom = studentData.hostelBooking.roomNo ? `, Room ${studentData.hostelBooking.roomNo}` : '';
             } else {
                hostelStatus = 'Booked (details not found)';
             }
        }
        quickStatsDiv.innerHTML += `
            <div class="stat-card">
                <i class="fas fa-hotel icon"></i>
                <div class="value">${hostelStatus}${hostelRoom}</div>
                <div class="label">Hostel Status</div>
            </div>
        `;
    }

    async function loadUpcomingClasses(uid, studentData) {
        const upcomingClassesDiv = document.getElementById('upcomingClasses');
        upcomingClassesDiv.innerHTML = ''; // Clear previous classes

        if (!studentData.registeredCourses || studentData.registeredCourses.length === 0) {
            upcomingClassesDiv.innerHTML = `<div class="empty-state">You haven’t registered for courses yet.</div>`;
            return;
        }

        const today = new Date();
        const dayOfWeek = today.toLocaleDateString('en-US', { weekday: 'long' }); // e.g., "Monday"
        
        // Filter timetable by current day and courses the student is registered for
        const timetableQuery = query(
            collection(db, "timetable"),
            where("day", "==", dayOfWeek)
        );
        const timetableSnap = await getDocs(timetableQuery);

        const registeredCourseCodes = new Set(studentData.registeredCourses.map(course => course.code || course)); // handle both code strings and objects

        let classesToday = [];
        timetableSnap.forEach(docSnap => {
            const classData = docSnap.data();
            if (registeredCourseCodes.has(classData.courseCode)) {
                classesToday.push(classData);
            }
        });

        if (classesToday.length > 0) {
            classesToday.sort((a, b) => (a.time || '').localeCompare(b.time || '')); // Sort by time
            let classesHtml = '';
            classesToday.forEach(classItem => {
                classesHtml += `
                    <div class="class-item">
                        <strong>${classItem.courseCode}</strong> - ${classItem.time || 'TBA'} - ${classItem.venue || 'TBA'}
                    </div>
                `;
            });
            upcomingClassesDiv.innerHTML = classesHtml;
        } else {
            upcomingClassesDiv.innerHTML = `<div class="empty-state">Enjoy your free day! No classes scheduled today.</div>`;
        }
    }

    async function loadRecentAnnouncements() {
        const recentAnnouncementsDiv = document.getElementById('recentAnnouncements');
        recentAnnouncementsDiv.innerHTML = ''; // Clear previous announcements

        const announcementsQuery = query(
            collection(db, "announcements"),
            orderBy("date", "desc"),
            limit(3)
        );
        const announcementsSnap = await getDocs(announcementsQuery);

        if (!announcementsSnap.empty) {
            let announcementsHtml = '';
            announcementsSnap.forEach(docSnap => {
                const announcementData = docSnap.data();
                const announceDate = announcementData.date ? (announcementData.date.seconds ? new Date(announcementData.date.seconds * 1000).toLocaleDateString() : new Date(announcementData.date).toLocaleDateString()) : 'N/A';
                const messageExcerpt = (announcementData.message || '').length > 100 ? (announcementData.message || '').substring(0, 100) + "..." : (announcementData.message || '');

                announcementsHtml += `
                    <div class="announcement-item">
                        <strong>${announcementData.title || 'Announcement'}</strong>
                        <p>${messageExcerpt}</p>
                        <span class="date">Posted: ${announceDate}</span>
                    </div>
                `;
            });
            recentAnnouncementsDiv.innerHTML = announcementsHtml;
            // Add a link to the full announcements page
            recentAnnouncementsDiv.innerHTML += `
                <div class="text-right mt-4">
                    <a href="#" onclick="showSection('announcements')" class="text-blue-600 underline">View all announcements</a>
                </div>
            `;
        } else {
            recentAnnouncementsDiv.innerHTML = `<div class="empty-state">No announcements yet.</div>`;
        }
    }

    // ... rest of your original functions remain unchanged (loadProfile, loadSettings, course registration, etc.)
    // For brevity in this response I did not repeat every function body here because your original file already contains them.
    // The important change was the onAuthStateChanged wrapper above which ensures the loading overlay is always hidden
    // and displays a clear error if an initial load fails or times out.

    // Call load functions when their respective sections are shown
    const originalShowSection = window.showSection;
    window.showSection = async (id) => {
        originalShowSection(id); // Call original function to hide/show divs
        const user = auth.currentUser;
        if (!user) return; // Must be authenticated

        loadingOverlay.classList.remove('hidden');
        try {
            if (id === 'profile') {
                await loadProfile(user.uid);
            } else if (id === 'settings') {
                await loadSettings(user.uid);
            } else if (id === 'courseReg') {
                await initCourseRegistration(user.uid);
            } else if (id === 'timetable') {
                await initTimetableView(user.uid);
            } else if (id === 'grades') {
                await initGradesView(user.uid);
            } else if (id === 'examCard') {
                await initExamCardView(user.uid);
            } else if (id === 'finance') {
                await initFinanceView(user.uid);
            } else if (id === 'hostels') {
                await initHostelsView(user.uid);
            } else if (id === 'graduation') {
                await initGraduationView(user.uid);
            } else if (id === 'clearance') {
                await initClearanceView(user.uid);
            } else if (id === 'announcements') {
                await loadAnnouncements('all'); // Load all announcements by default for the full view
            }
        } catch (error) {
            console.error(`Error loading section ${id}:`, error);
            showCustomAlert(`Failed to load ${id} data. Please try again.`, 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    };

  </script>
</body>
</html>
