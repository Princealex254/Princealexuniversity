<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Graduation Request</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="p-6 bg-gray-50">

  <!-- ✅ Popup Banner -->
  <div id="popupMsg" class="hidden fixed top-4 inset-x-0 max-w-md mx-auto z-50 shadow-lg rounded p-4 flex items-start justify-between">
    <span id="popupText" class="text-sm"></span>
    <button id="popupClose" class="ml-4 px-3 py-1 rounded bg-white/20 text-sm font-medium">OK</button>
  </div>

  <section class="max-w-3xl mx-auto">
    <!-- 🔔 Notification Banner -->
    <div id="gradBanner" class="hidden mb-4 p-3 rounded font-medium"></div>

    <!-- Main Content -->
    <div id="gradContent" class="text-gray-600">Loading…</div>
  </section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
  authDomain: "universityweb-19e1e.firebaseapp.com",
  projectId: "universityweb-19e1e",
  storageBucket: "universityweb-19e1e.appspot.com",
  messagingSenderId: "401942926589",
  appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ✅ Popup
function showPopup(msg, type="success") {
  const box=document.getElementById("popupMsg");
  const text=document.getElementById("popupText");
  const closeBtn=document.getElementById("popupClose");
  text.textContent=msg;
  box.className="fixed top-4 inset-x-0 max-w-md mx-auto z-50 shadow-lg rounded p-4 flex items-start justify-between "+
    (type==="success" ? "bg-green-500 text-white":"bg-red-500 text-white");
  box.classList.remove("hidden");
  closeBtn.onclick=()=> box.classList.add("hidden");
  setTimeout(()=> box.classList.add("hidden"),5000);
}

let currentUser;

onAuthStateChanged(auth,user=>{
  if(!user){ showPopup("You must be logged in to request graduation","error"); return; }
  currentUser=user;
  loadGraduation();
});

// 📘 Load Graduation Request
async function loadGraduation(){
  const container=document.getElementById("gradContent");
  const banner=document.getElementById("gradBanner");

  try {
    const gRef=doc(db,"graduationRequests",currentUser.uid);
    const snap=await getDoc(gRef);

    // If no request yet → CTA card
    if(!snap.exists()){
      banner.classList.add("hidden");
      container.innerHTML=`
        <div class="p-6 text-center border rounded-lg bg-blue-50 shadow">
          <p class="text-slate-700 mb-3">You have not yet applied for graduation.</p>
          <button id="btnRequestGrad" class="px-6 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700">
            Request Graduation
          </button>
        </div>
      `;
      document.getElementById("btnRequestGrad").onclick=async()=>{
        try{
          await setDoc(gRef,{status:"pending",requestedAt:serverTimestamp()});
          showPopup("Graduation requested successfully","success");
          loadGraduation();
        }catch(err){ showPopup("Error requesting graduation: "+err.message,"error"); }
      };
      return;
    }

    // If request exists → display status card
    const data=snap.data();
    const status=data.status||"pending";
    const requestedAt=data.requestedAt?.toDate ? data.requestedAt.toDate().toLocaleString() : "-";
    const gradDate=data.graduationDate?.toDate ? data.graduationDate.toDate() : null;

    // 🔔 Banner
    if(status==="approved"){
      banner.textContent="🎉 Your graduation request has been approved. Please proceed to gown collection.";
      banner.className="mb-4 p-3 rounded font-medium bg-green-100 text-green-800";
      banner.classList.remove("hidden");
    } else if(status==="pending"){
      banner.textContent="⚠️ Graduation request pending. Ensure all clearance steps are completed.";
      banner.className="mb-4 p-3 rounded font-medium bg-yellow-100 text-yellow-800";
      banner.classList.remove("hidden");
    } else if(status==="rejected"){
      banner.textContent="❌ Your graduation request has been rejected. Please contact administration.";
      banner.className="mb-4 p-3 rounded font-medium bg-red-100 text-red-800";
      banner.classList.remove("hidden");
    }

    // 🎨 Status Badge
    let badge=`<span class="px-2 py-1 rounded text-sm 
      ${status==="approved" ? "bg-green-100 text-green-800":
        status==="pending" ? "bg-yellow-100 text-yellow-800":
        "bg-red-100 text-red-800"}">${status}</span>`;

    // ⏳ Timeline Steps
    const steps=`
      <ul class="mt-4 space-y-2">
        <li class="flex items-center gap-2"><span class="text-green-600">✅</span> Request Submitted</li>
        <li class="flex items-center gap-2"><span class="${status==="pending"?"text-yellow-600":"text-green-600"}">⏳</span> Admin Review</li>
        <li class="flex items-center gap-2"><span class="${status==="approved"?"text-green-600":"text-gray-400"}">🎓</span> Approved for Graduation</li>
      </ul>`;

    // 📋 Checklist (mocked, you can tie to real data)
    const checklist=`
      <div class="mt-6 p-4 border rounded bg-gray-50">
        <h4 class="font-semibold mb-2">Graduation Checklist</h4>
        <ul class="space-y-1 text-sm">
          <li>🔲 Library Clearance</li>
          <li>🔲 Finance Clearance</li>
          <li>✅ Hostels Cleared</li>
        </ul>
      </div>`;

    // 🎓 Countdown
    let countdownHtml="";
    if(status==="approved" && gradDate){
      const daysLeft=Math.ceil((gradDate-new Date())/(1000*60*60*24));
      countdownHtml=`<div class="mt-4 text-blue-600 font-semibold">🎓 ${daysLeft} days left to Graduation Ceremony</div>`;
    }

    container.innerHTML=`
      <div class="p-4 border rounded-lg shadow bg-white">
        <h3 class="font-semibold text-lg text-blue-800 flex items-center gap-2">
          <i class="fa-solid fa-graduation-cap"></i> Graduation Status
        </h3>
        <p class="mt-2 text-slate-600">Status: ${badge}</p>
        <p class="text-sm text-slate-500 mt-1">Requested: ${requestedAt}</p>
        ${steps}
        ${checklist}
        ${countdownHtml}
        <button id="btnGradSlip" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Download Graduation Slip</button>
      </div>
    `;

    // 📥 PDF Slip
    document.getElementById("btnGradSlip").onclick=()=>{
      try{
        const {jsPDF}=window.jspdf;
        const docp=new jsPDF();
        docp.text("Graduation Application Slip",14,20);
        docp.text(`Status: ${status}`,14,30);
        docp.text(`Requested At: ${requestedAt}`,14,40);
        if(gradDate){ docp.text(`Graduation Ceremony: ${gradDate.toLocaleDateString()}`,14,50); }
        docp.save("graduation_slip.pdf");
        showPopup("Graduation slip downloaded","success");
      }catch(err){ showPopup("Error generating slip: "+err.message,"error"); }
    };

  } catch(err){
    showPopup("Error loading graduation request: "+err.message,"error");
  }
}
</script>

<!-- ✅ FontAwesome for icons -->
<script src="https://kit.fontawesome.com/a2d9d6c5c2.js" crossorigin="anonymous"></script>
</body>
</html>
